---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/8/28 17:44
---

CityEntityView = BaseView:New("CityEntityView")
local this = CityEntityView
this.viewType = CanvasSortingOrderManager.LayerType.None

this.auto_bind_ui_items = {
    "btn_entry",
    "shake",
    "enter",
    "enter_suo",
    "enter_sign",
    "anima",
    "lady"
}

function CityEntityView:New(id)
    local o = {}
    setmetatable(o,{__index = this})
    o.cityId = id
    return o
end

function CityEntityView:Awake()
    self:on_init()
end

function CityEntityView:OnEnable()
    self._enable = true
    Facade.RegisterViewEnhance(self)
    Event.AddListener(EventName.Event_UpdateRoleInfo,self.OnUpdateRoleInfo,self)
    Util.SetMaterialFloat(self.lady, "_UseCanvasGroup",0)
    self:SetCityInfo()
    if self._callback then
        self:PlayExitLobby(self._callback)
    end
end

function CityEntityView:OnDisable()
    Facade.RemoveViewEnhance(self)
    Event.RemoveListener(EventName.Event_UpdateRoleInfo,self.OnUpdateRoleInfo)
    self._enable = nil
    self._callback = nil
end

function CityEntityView:OnUpdateRoleInfo()
    self:SetCityInfo()
end



--判断是否最大开放
function CityEntityView.GetCityLevelOpen2(cityid)
    local unlock = nil
    for _,v in pairs(Csv.city_play) do
        if v.city_id == cityid and v.default == 1 then
            unlock = v.unlock
            break
        end
    end

    if not unlock then
        return 0
    end



    return unlock
end

function CityEntityView:SetCityInfo()
    --[[
    local playInfo = ModelList.PlayerInfoModel:GetUserInfo()
    local cityInfo = Csv.GetData("city",self.cityId)
    local openLevel = nil
    if cityInfo then
        openLevel = cityInfo.openlevel or 100000
    end
    --]]

    local playerLevel = ModelList.PlayerInfoModel:GetLevel()
    --推荐玩法得也一定是开放得  --false 才是开启
    local mayopen = Csv.GetCityLevelOpen2(self.cityId,playerLevel)
    --- 更改逻辑 判断是不是
    if mayopen--[[playInfo and playInfo.level >= openLevel--]] then
        self.isCityOpen = true
        fun.set_active(self.enter,true)
        fun.set_active(self.enter_suo,false)
        fun.set_active(self.enter_sign,true)
    else
        self.isCityOpen = false
        fun.set_active(self.enter,false)
        fun.set_active(self.enter_suo,true)
        fun.set_active(self.enter_sign,false)
        self:OnCityLock(self.GetCityLevelOpen2(self.cityId))
    end
end

--- 显示城市解锁等级
function CityEntityView:OnCityLock(openlv)
    if self.enter_suo and fun.get_child_count(self.enter_suo) > 0 then
        local text = fun.get_child(self.enter_suo,0)
        if text then
            local text = fun.get_component(text,"Text")
            if openlv and text then
                text.text = string.format("LV %s", openlv)
            end
        end
    end
end

function CityEntityView:IsCityOpen()
    return self.isCityOpen or false
end

function CityEntityView:GetCityId()
    return self.cityId or 0
end

function CityEntityView:SetParent(paren)
    if paren and self.go then
        fun.set_parent(self.go,paren,true)
    end
end

function CityEntityView:SetActive(active)
    if self.go then
        fun.set_active(self.go,active)
    end
end

--[[
function CityEntityView:ShakePosition(duration,vibrato,x,y,z)
    --Anim.ShakePosition(self.shake,0.6,12,60,0,0)
end
--]]

function CityEntityView:Shutoff(enabled)
    if self.anima then
        self.anima.enabled = enabled or false
    end
end

function CityEntityView:on_btn_entry_click()
    local loadDefault,MachineItemData = CityHomeScene:CheckNeedDownload(self.cityId)
    
    if loadDefault ==0  then 
        local playerLevel = ModelList.PlayerInfoModel:GetLevel()
        --推荐玩法得也一定是开放得  --false 才是开启
        local mayopen = Csv.GetCityLevelOpen2(self.cityId,playerLevel)
        if mayopen then 
            CityHomeScene:EntityViewDownload(self.go,MachineItemData,loadDefault)
        end 
    elseif loadDefault ==1 then 

    else 
        if CityHomeScene:CanClickCity() then
            if self:Check_WinZone_Need_Open() then
                ModelList.BattleModel.RequireModuleLua("WinZone")
                local winzoneView = require("View/WinZone/WinZoneInPropgressView")
                Facade.SendNotification(NotifyName.ShowUI,winzoneView:New())
                return
            end
            if ModelList.WinZoneModel.CheckHasRewardAndCannotRelive() then
                return
            end
            Facade.SendNotification(NotifyName.HallCity.Click_City_Enter,false,self.cityId)
        end
    end 
end

function CityEntityView:Check_WinZone_Need_Open()
        if ModelList.WinZoneModel:IsActivityValid() and ModelList.WinZoneModel:ShouldGotoGameHall() then
            return true
        end
    return false
end



function CityEntityView:on_close()

end

function CityEntityView:OnDestroy()
    self:Close()
end

function CityEntityView:PlayEnterLobby(callback)
    AnimatorPlayHelper.Play(self.anima, string.format("efCity%sEntityenter",self.cityId),false,function()
        if callback then
            callback()
        end
        self:SetActive(false)
    end,0.3)
end

function CityEntityView:PlayExitLobby(callback)
    if self._enable then
        AnimatorPlayHelper.Play(self.anima,string.format("efCity%sEntityin",self.cityId),false,function()
            if callback then
                callback()
            end
        end,0.3)
    else
        self._callback = callback    
    end
end

function CityEntityView:PlayDragMoveLeft(startPlayTime)
    AnimatorPlayHelper.Play(self.anima,string.format("efCity%sEntyMoveLeft",self.cityId),startPlayTime or 0, false,nil)
end

function CityEntityView:PlayDragMoveRight(startPlayTime)
    AnimatorPlayHelper.Play(self.anima,string.format("efCity%sEntyMoveRight",self.cityId),startPlayTime or 0,false,nil)
end

function CityEntityView:OnUltraBetBannerClick()
    log.log("dghdgh007 CityEntityView:OnUltraBetBannerClick ", self.cityId)
    ModelList.CityModel:SetForceMaxBet()
    self:on_btn_entry_click()
end

this.NotifyEnhanceList = {
    {notifyName = NotifyName.UltraBet.ClickBanner, func = this.OnUltraBetBannerClick},
}