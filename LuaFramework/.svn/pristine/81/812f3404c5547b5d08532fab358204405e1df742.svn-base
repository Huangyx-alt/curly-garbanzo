---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/11/14 11:37
---
--- 鸡尾酒玩法酒水数据
local BaseSwitchCardLogic = require("Combat.BattleLogic.Base.BaseLogicSwitchCard")
local  HawaiiLogicSwitchCard = BaseSwitchCardLogic:New("HawaiiLogicSwitchCard")
local this = HawaiiLogicSwitchCard
this.moduleName = "HawaiiLogicSwitchCard"

function HawaiiLogicSwitchCard:InitLogic()
    self.__index:InitLogic()
    self.PageOneCardIds = {1,2}
    self.BackTwoCardIds = {3,4}
end

--- 切换卡牌
function HawaiiLogicSwitchCard:StartSwitchCard()
    if self.isSwitching then  return   end
    self.isSwitching = true
    self.curr_show_card_index = self.curr_show_card_index + 1
    if self.curr_show_card_index >= 3 then
        self.curr_show_card_index = 1
    end
    self:RemoveHideJackpotCardBackground()
    Event.Brocast(EventName.Event_Switch_Card,self.curr_show_card_index)
end

function HawaiiLogicSwitchCard:IsShowing(cardId)
    if ModelList.BattleModel:IsRocket() then
        return true
    end
    if not self.curr_show_card or #self.curr_show_card == 0 then
        return true
    end
    if self.curr_show_card[self.curr_show_card_index] then
        for i = 1, #self.curr_show_card[self.curr_show_card_index] do
            if self.curr_show_card[self.curr_show_card_index][i] == cardId then
                return true
            end
        end
    end
    return false
end


--- 切换卡牌
function HawaiiLogicSwitchCard:EnterDoubleJackpotChangeCard()
    if self.isSwitching then  log.r("正在切换卡牌，不应该触发双jackpot切卡")   end
    self.isSwitching = true
    self.doubleJackpotChange = LuaTimer:SetDelayLoopFunction(0.01,0.01,-1,function()
        BattleEffectPool.FollowTargetObj()
        BattleEffectCache.FollowTargetObj()
    end,nil, nil,LuaTimer.TimerType.Battle)
end

function HawaiiLogicSwitchCard:ExitDoubleJackpotChangeCard()
    if self.doubleJackpotChange then
        LuaTimer:Remove(self.doubleJackpotChange)
        self.doubleJackpotChange = nil
    end
    Event.Brocast(EventName.Event_Switch_Card_Check_Jokepot_Pos)
    Event.Brocast(EventName.Event_Switch_Card,self.curr_show_card_index)
    self.isSwitching = false
end

--- 有Jackpot的卡牌自动移动到后面
function HawaiiLogicSwitchCard:StartHideJackpotCardBackground(currCardId,otherJackpotId)
    self.loopMoveCard = LuaTimer:SetDelayLoopFunction(5,0.3,-1,function()
        if ModelList.HawaiiGameModel:IsGameOver() then
            self:RemoveHideJackpotCardBackground()
            return
        end
        if BattleEffectCache:CheckCardHideAllEffect(currCardId)  then
            self:RemoveHideJackpotCardBackground()
            local moveCardId = 0
            local currIndex = 0
            local moveIndex = 0
            if self.curr_show_card_index  == 1 then
                if not fun.is_include(otherJackpotId,self.BackTwoCardIds) then
                    local temp = otherJackpotId
                    otherJackpotId = currCardId
                    currCardId = temp
                end
                for i = 1, #self.BackTwoCardIds do
                    if self.BackTwoCardIds[i] ~= otherJackpotId then
                        moveCardId = self.BackTwoCardIds[i]
                        moveIndex = i
                        break
                    end
                end
                for i = 1, #self.PageOneCardIds do
                    if self.PageOneCardIds[i]  == currCardId then
                        self.PageOneCardIds[i] = moveCardId
                        currIndex = i
                    end
                end
                for i = 1, #self.BackTwoCardIds do
                    if self.BackTwoCardIds[i]  ~= otherJackpotId then
                        self.BackTwoCardIds[i] = currCardId
                    end
                end
            else
                if not fun.is_include(otherJackpotId,self.PageOneCardIds) then
                    local temp = otherJackpotId
                    otherJackpotId = currCardId
                    currCardId = temp
                end
                for i = 1, #self.PageOneCardIds do
                    if self.PageOneCardIds[i] ~= otherJackpotId then
                        moveCardId = self.PageOneCardIds[i]
                        moveIndex = i
                        break
                    end
                end
                for i = 1, #self.BackTwoCardIds do
                    if self.BackTwoCardIds[i]  == currCardId then
                        self.BackTwoCardIds[i] = moveCardId
                        currIndex = i
                    end
                end
                for i = 1, #self.PageOneCardIds do
                    if self.PageOneCardIds[i]  ~= otherJackpotId then
                        self.PageOneCardIds[i] = currCardId
                    end
                end
            end
            --self:HideJackpotCardBackground(currCardId,moveCardId,currIndex,moveIndex)
            Event.Brocast(EventName.Event_Move_Jackpot_Card_Background,currCardId,moveCardId,currIndex,moveIndex)
            Event.Brocast(EventName.Event_Switch_Card_Double_Jackpot_Sort,currCardId,moveCardId,currIndex,moveIndex)
            self:SyncPage()
        end
    end,nil, nil,LuaTimer.TimerType.Battle)
end

---
function HawaiiLogicSwitchCard:RemoveHideJackpotCardBackground()
    if self.loopMoveCard then
        LuaTimer:Remove(self.loopMoveCard)
        self.loopMoveCard = nil
    end
end

function HawaiiLogicSwitchCard:OnDisable()
    self:RemoveHideJackpotCardBackground()
end

function HawaiiLogicSwitchCard:GetsCurrCardOrder()
   local next_card_index  = self.curr_show_card_index + 1
    if next_card_index >= 3 then
        next_card_index = 1
    end

    if next_card_index == 1 then
        return 1
    else
        return self.back_card_stard_index
    end
end

return this