---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2024/12/18 15:02
---
local GotYouSmallGameCellItem = require("View.Bingo.SettleModule.UIView.SmallGame.GotYou.GotYouSmallGameCellItem")

local GotYouSmallGameView = TopBarControllerView:New('GotYouSmallGameView', 'GotYouSmallGameAtlas')
local Private = {}
local this = GotYouSmallGameView
this.viewType = CanvasSortingOrderManager.LayerType.Machine_Dialog
this.auto_bind_ui_items = {
    "GotYouSmallGameView",
    "BuildIcon",
    "btn_decreate",
    "btn_increate",
    "btn_maxbet",
    "btn_spin",
    "freeGameText",
    "totalBetText",
    "totalWinText",
    "Cell13",
    "Cell14",
    "Cell15",
    "Cell16",
    "Cell17",
    "Cell21",
    "Cell9",
    "Cell10",
    "Cell11",
    "Cell12",
    "Cell20",
    "Cell7",
    "Cell8",
    "Cell6",
    "Cell5",
    "Cell2",
    "Cell1",
    "Cell3",
    "Cell4",
    "Cell18",
    "Cell19",
    "Cell22",
    "Cell23",
    "Cell24",
    "background",
    "jinbi",
    "jinbi2",
    "bao",
    "brush",
    "freePig1",
    "freePig2",
    "freePig3",
    "doorTargetPos",
    "btn_help",
    "PigGameZhe",
    "PigGameZ010",
    "maxbetImg",
    "bingoCount",
    "PigGameCZFreeDi",
    "GuideBg",
    "GuideText",
    "Guideyindaosuo",
}

local MaxBet = 10
local MinBet = 1
local UltraBet = 5
local brushFlySpeed = 1000

function GotYouSmallGameView:Awake()
    self:on_init()

    --- 清理金币飞行池,避免战斗金币回收问题,导致一直播放金币chips声音
    this.moduleList = require("View.Bingo.BattleModuleList")
    if this.moduleList then
        this.effContainer = this.moduleList.GetModule("EffectEntry") --效果模块，较为常用，单独设置一个直接引用
        if this.effContainer then
            this.effContainer:ClearCoinPool()
        end
        this.effContainer = nil
    end
    this.moduleList = nil
end

function GotYouSmallGameView:OnEnable(params)
    --self.info = ModelList.ChristmasSynthesisModel:GetSmallGameData()
    self:BuildFsm()
    this.oriTimeScale = Time.timeScale
    Time.timeScale = 1
    if params then
        this._exit_callback = params
    end
    this:RegisterEvent()
    --ModelList.BattleModel:GetCurrBattleView():SetContainerForOtherView(self.go)
    UISound.stop_loop("chips")
    UISound.stop_loop("settlement_bgm")
    UISound.play_bgm("moneymansion")
    Event.Brocast(EventName.Event_topbar_change, true, TopBarChange.goback)
    Facade.RegisterViewEnhance(self)
end

function GotYouSmallGameView:BuildFsm()
    FsmCreator:Create("GotYouSmallGameView", self, {
        require("View.Bingo.SettleModule.State.SmallGame.GotYou.InitState"),
        require("View.Bingo.SettleModule.State.SmallGame.GotYou.IdleState"),
        require("View.Bingo.SettleModule.State.SmallGame.GotYou.ChangeBetState"),
        require("View.Bingo.SettleModule.State.SmallGame.GotYou.SpinState"),
        require("View.Bingo.SettleModule.State.SmallGame.GotYou.ShowSpinState"),
        require("View.Bingo.SettleModule.State.SmallGame.GotYou.ExitState"),
        require("View.Bingo.SettleModule.State.SmallGame.GotYou.ShowSpinRewardState"),
        require("View.Bingo.SettleModule.State.SmallGame.GotYou.ShowBingoState"),
        require("View.Bingo.SettleModule.State.SmallGame.GotYou.GuideState"),
    })
    self.state = {
        InitState = "InitState",
        IdleState = "IdleState",
        SpinState = "SpinState",
        ShowSpinState = "ShowSpinState",
        ExitState = "ExitState",
        ShowSpinRewardState = "ShowSpinRewardState",
        ShowBingoState = "ShowBingoState",
        GuideState = "GuideState",
    }
    self._fsm:StartFsm(self.state.InitState)
end

--function GotYouSmallGameView:GetNodeList()
--    return { self.Node1, self.Node2, self.Node3, self.Node4 }
--end


--- 初始化
function GotYouSmallGameView:Init()
    --self.freeTimes = 3
    --if self.freeTimes > 0 then
    --    --self:SetBg()
    --    --self:SetBuildingIcon()
    --end
    self:SetInitMansionInfo()
    self:SetInitBetData()
    self:SetBetData()
    self:SetBuildingData(false)
    --self:SaveTotalWinNum(0)
    self:SetTotalWinNum(0)
    self:SetFreeTimes(0)
    Private.CheckPopHelpView(self)
end

---设置背景,白天和黑夜
function GotYouSmallGameView:SetBg()
    if self.freeTimes == 0 then
        local bgName = "PigGameBG03"
        Cache.load_sprite(AssetList[bgName], bgName, function (sp)
            if self.background and not fun.is_null(self.background) and not fun.is_null(sp) then
                self.background.sprite = sp
            end
        end)
    else
        local bgName = "PigGameBG04"
        Cache.load_texture(AssetList[bgName], bgName, function (objs)
            if objs then
                local sprite = Util.Texture2Sprite(objs)
                if self.background and sprite then
                    self.background.sprite = sprite
                end
            end
        end)
    end
end

--设置建筑icon 白天和黑夜
function GotYouSmallGameView:SetBuildingIcon()
    if self.freeTimes == 0 then
        local bgName = "PigGameBG01"
        Cache.load_sprite(AssetList[bgName], bgName, function (sp)
            if self.buildingIcon and not fun.is_null(self.buildingIcon) and not fun.is_null(sp) then
                self.buildingIcon.sprite = sp
            end
        end)
    else
        local bgName = "PigGameBG02"
        Cache.load_texture(AssetList[bgName], bgName, function (objs)
            if objs then
                local sprite = Util.Texture2Sprite(objs)
                if self.buildingIcon and sprite then
                    self.buildingIcon.sprite = sprite
                end
            end
        end)
    end
end

-- 设置所有建筑格子的数据
function GotYouSmallGameView:SetBuildingData(isUltrabet)
    self.Cells = {}
    self.RewardInfo = {}
    self.RewardInfo.rewardNum = {}
    local cellItem = require("View.Bingo.SettleModule.UIView.SmallGame.GotYou.GotYouSmallGameCellItem")
    local position_reward = Csv.GetData("moneymansion", self.currBet, "position_mes")
    for i = 1, 24 do
        local cell = cellItem:New()
        cell:Init(self["Cell" .. i], i)
        local value = position_reward[i][3] * self.MansionInfo.totalBetList[self.currBet].totalBet
        table.insert(self.RewardInfo.rewardNum, value)
        cell:SetInfo(value)
        table.insert(self.Cells, cell)
    end
end

---设置初始bet数据
function GotYouSmallGameView:SetInitMansionInfo()
    self.MansionInfo = ModelList.GotYouModel:GetSmallGameData2()
end

---设置初始bet数据
function GotYouSmallGameView:SetInitBetData()
    self.currBet = self.MansionInfo.curRate
    self.lastBet = self.MansionInfo.curRate
    self.totalWinNum = self.MansionInfo.curRate
    self.freeTimes = self.MansionInfo.freeSpinTimes
    Private.CheckCancelGrayBet(self, self.currBet)
    Private.InitBetBtnType(self)
end

---改变Bet数据
---@param changeType number 1:减 2:加 3:max 4:刷新成指定
function GotYouSmallGameView:ChangeBet(changeType, targetBet)
    local bet = -1
    if changeType == 2 then
        bet = 1
    elseif changeType == 3 then
        if self.currBet < 5 then
            bet = 5 - self.currBet
        elseif self.currBet == 5 then
            bet = 6 - self.currBet
        elseif self.currBet >= 6 then
            bet = 1 - self.currBet
        end
    end
    if changeType == 4 then
        bet = targetBet
    else
        bet = self.currBet + bet
    end
    if bet >= 1 and bet <= 10 then
        self.lastBet = self.currBet
        self.currBet = bet
        self:SetBetData()
    end
    Private.CheckCancelGrayBet(self, bet, changeType)
    Private.CheckUltraBet(self)
end

--设置Bet数据
function GotYouSmallGameView:SetBetData()
    if self.currBet then
        self.totalBetText.text = fun.formatNum(self.MansionInfo.totalBetList[self.currBet].totalBet)
    end
end

---设置免费次数
function GotYouSmallGameView:SetFreeTimes(initFree)
    if self.freeGameText then
        self.freeGameText.text = initFree or self.freeTimes
    end
    local oriActive = fun.get_active_self(self.PigGameZhe)
    if oriActive and self.freeTimes <= 0 then
        AnimatorPlayHelper.Play(self.PigGameZhe, { "end", "PigGameZheend" }, false, function ()
            fun.set_active(self.PigGameZhe, false)
        end)
    else
        fun.set_active(self.PigGameZhe, (self.freeTimes > 0 and initFree == nil) and true or false)
    end
end

---改变免费次数
function GotYouSmallGameView:ChangeFreeTimes(num)
    self.freeTimes = num
    self:SetFreeTimes()
end

---设置总奖励数值
function GotYouSmallGameView:SetTotalWinNum(num)
    if self.totalWinText and num then
        self.totalWinText.text = num
    end
end

---记录总奖励数值
---@param rewardIndex number 命中的格子序号
function GotYouSmallGameView:SaveTotalWinNumByIndex(rewardIndex)
    if not self.TotalWinNum then self.TotalWinNum = 0 end
    self.TotalWinNum = self.TotalWinNum + self.RewardInfo.rewardNum[rewardIndex]
end

---记录总奖励数值
---@param rewardIndex number 命中的格子序号
function GotYouSmallGameView:SaveTotalWinNumByValue(value)
    if not self.TotalWinNum then self.TotalWinNum = 0 end
    self.TotalWinNum = self.TotalWinNum + value
end

function GotYouSmallGameView:Exit()
    ViewList.GameSettleView:OpenRound4()
end

--- 进入等待摇奖结束的状态
function GotYouSmallGameView:SetWaitState(isWait)
    this.isWaitingEnd = isWait
    if isWait then
        ---设定超时5s就自动放开
        this.autoEndWaitTimer = LuaTimer:SetDelayFunction(5, function ()
            this:SetWaitState(false)
        end)
    else
        if this.autoEndWaitTimer then
            LuaTimer:Remove(this.autoEndWaitTimer)
            this.autoEndWaitTimer = nil
        end
    end
    Util.SetUIImageGray(self.btn_end, isWait)
    Util.SetUIImageGray(self.btn_extraBall, isWait)
end

--- 所有球摇完，展示继续按钮
function GotYouSmallGameView:CheckOver()
    if this.info and this.info.shakerBall and not this.info.shakerBall[this.extraBallIndex] then
        fun.set_active(this.btn_continue, true)
        fun.set_active(this.btn_end, false)
        fun.set_active(this.btn_extraBall, false)
    end
end

--- 检查是否等待数据时间过长
function GotYouSmallGameView:GetSettleData()
    this.HadSettle = true
end

---游戏不存在的处理
function GotYouSmallGameView:GameNotExist()
    if this.HadSettle then
        ViewList.GameSettleView:JumpNextView()
        Facade.SendNotification(NotifyName.HideUI, ViewList.GotYouSmallGameView)
        --ViewList.GotYouSmallGameView = nil
    else
        Facade.SendNotification(NotifyName.HideUI, ViewList.GotYouSmallGameView)
        Event.Brocast(Notes.QUIT_BATTLE)

        local loadingView = ViewList.SceneLoadingGameView
        LoadScene("SceneHome", loadingView, true)
        --UnityEngine.Resources.UnloadUnusedAssets()
    end
end

---游戏不存在的处理
function GotYouSmallGameView:OnCoinChange()
    if this.isOpenShop then
        this:UpdateGoldValue(false)
    end
end

function GotYouSmallGameView:RegisterEvent()
    Event.AddListener(EventName.Event_Receive_Game_Settle_Data, this.GetSettleData)
    Event.AddListener(EventName.Game_Not_Exist_Msg, this.GameNotExist)
    Event.AddListener(EventName.Event_coin_change, this.OnCoinChange)
end

---
function GotYouSmallGameView:UnRegisterEvent()
    Event.RemoveListener(EventName.Event_Receive_Game_Settle_Data, this.GetSettleData)
    Event.RemoveListener(EventName.Game_Not_Exist_Msg, this.GameNotExist)
    Event.RemoveListener(EventName.Event_coin_change, this.OnCoinChange)
end

--玩家在该界面停留5分钟没有进行操作时，弹出弹窗询问玩家是否继续小游戏
function GotYouSmallGameView:OnTimeOut()
    if this.extraBallIndex and this.extraBallIndex > 15 then return end
    this.CheckViewOpenTimer = LuaTimer:SetDelayFunction(300, function ()
        UIUtil.show_common_error_popup(85018, false, function ()

        end)
    end)
end

---每次摇奖后，重置时间
function GotYouSmallGameView:ResetTimeOut()
    if this.CheckViewOpenTimer then
        LuaTimer:Remove(this.CheckViewOpenTimer)
        this.CheckViewOpenTimer = nil
    end
    this:OnTimeOut()
end

function GotYouSmallGameView:on_btn_decreate_click()
    if self.isMinGray or self.freeTimes > 0 then
        return
    end
    self._fsm:GetCurState():OnChangeBet(1)
    UISound.play("moneymansionbetdown")
end

function GotYouSmallGameView:on_btn_increate_click()
    if self.isMaxGray or self.freeTimes > 0 then
        return
    end
    self._fsm:GetCurState():OnChangeBet(2)
    UISound.play("moneymansionbetup")
end

function GotYouSmallGameView:on_btn_maxbet_click()
    if self.freeTimes > 0 then
        return
    end
    self._fsm:GetCurState():OnChangeBet(3)
end

function GotYouSmallGameView:on_btn_spin_click()
    self._fsm:GetCurState():OnSpin()
    self.btn_spin:Play("act")
end

--- 检查是否足够钻石触发spin
function GotYouSmallGameView:CheckSpinCost()
    if self.MansionInfo.freeSpinTimes > 0 then
        return true
    end

    local diamond = ModelList.ItemModel.get_diamond()
    local cost = self.MansionInfo.totalBetList[self.currBet].totalBet
    if diamond < cost then
        Facade.SendNotification(NotifyName.ShopView.CheckCurrencyAvailable, 8018, Resource.diamon, cost, nil, nil,
            function ()
                --暂停idle效果
                if self and self._fsm then
                    self._fsm:GetCurState():OnStopIdle()
                end
            end, SHOP_TYPE.SHOP_TYPE_DIAMONDS)
    else
        return true
    end
    return false
end

function GotYouSmallGameView:on_btn_help_click()
    local view = require("View.HallCity.GotYou.GotYouSmallGameHelperView")
    Facade.SendNotification(NotifyName.ShowUI, view)
end

function GotYouSmallGameView:PlayCellActEffect(index, isIgnoreSound)
    if this.isOpen and self["Cell" .. index] then
        self["Cell" .. index]:Play("act", -1, 0)
        if not isIgnoreSound then
            UISound.play("moneymansionspin")
        end
        --log.r("PlayCellActEffect", index)
    end
end

function GotYouSmallGameView:PlayCellActSlowEffect(index, isIgnoreSound)
    if this.isOpen and self["Cell" .. index] then
        self["Cell" .. index]:Play("actman")
        if not isIgnoreSound then
            UISound.play("moneymansionspin")
        end
    end
end

---播放命中格子效果
function GotYouSmallGameView:PlayCellHitEffect(index)
    if not self.spinReward then self.spinReward = {} end
    self.spinReward.rewardIndex = index
    Private.PlayHitEffectOver(self, index)
    Private.CheckBrushIconEffect(self, index)
    Private.PlayCoinsBoomEffect(self, index)
end

---播放完中奖效果后的回调
function GotYouSmallGameView:PlayHitEffectOver()
    if self.spinReward.rewardIndex then
        if self.spinReward.rewardIndex == 24 then --门
            --Private.PlayBrushFlyEffect(self)
            Private.PlayDoorOpenEffect(self)
        elseif self.spinReward.rewardIndex == 23 then --锤子
            Private.PlayHammerHitEffectOver(self)
        elseif self.spinReward.rewardIndex <= 21 then
            Private.PlayTotalWinRollEffect(self)
            --Private.RestoreIdleState(self)
        end
    end
end

-----播放锤子领奖效果
--function GotYouSmallGameView:PlayHammerEffect()
--end

---播放锤子领奖效果
function GotYouSmallGameView:PlayHammerHitEffect(index)
end

---播放刷子刷新奖励效果
function GotYouSmallGameView:PlayBrushEffect()
    Private.PlayBrushEffect(self)
end

---@return number 当前的spin奖励信息
function GotYouSmallGameView:GetSpinReward()
    return self.spinReward
end

function GotYouSmallGameView:RefreshMansionInfo(data)
    self.MansionInfo = data
end

function GotYouSmallGameView:CloseTopBarParent()
    --self:CloseView()
    if this.isOpen then
        this.isOpen = false
        this:CloseAnimation()
        if self.MansionInfo.freeSpinTimes > 0 then
            UIUtil.show_common_popup(191065, false, function ()
                self:CloseReward()
            end, function ()
                this.isOpen = true
            end)
        else
            self:CloseReward()
        end
    end
end

function GotYouSmallGameView:CloseReward()
    if self.MansionSpinInfo and self.MansionSpinInfo.totalWin > 0 then
        local spinRewardList = { { id = 2, value = self.MansionSpinInfo.totalWin } }
        Facade.SendNotification(NotifyName.ClaimReward.PopupClaimReward, PopupViewType.show,
            ClaimRewardViewType.CollectReward, spinRewardList, function ()
                --AddLockCountOneStep(false)
                Facade.SendNotification(NotifyName.ClaimReward.PopupClaimReward, PopupViewType.hide,
                    ClaimRewardViewType.CollectReward)
                self:CloseEffect()
            end)
    else
        self:CloseEffect()
    end
end

function GotYouSmallGameView:CloseEffect()
    ---暂时手动修改层级
    fun.set_sorting_order_relative(self.go, 20000)
    AnimatorPlayHelper.Play(self.GotYouSmallGameView, { "end", "GotYouSmallGameViewend" }, false, function ()
        Facade.SendNotification(NotifyName.CloseUI, this)
        if ModelList.BattleModel:IsGameing() then
            self:Jump2puzzle()
        else
            Facade.SendNotification(NotifyName.SceneCity.HomeScene_promotion)
        end
        Facade.SendNotification(NotifyName.CloseUI, this)
    end)
end

function GotYouSmallGameView:Jump2puzzle()
    Facade.SendNotification(NotifyName.ShowUI, ViewList.PuzzleView, function ()
        ModelList.PuzzleModel:SetViewType(1)
        fun.set_active(this.sumary, false, false)
    end, false, function ()
        ModelList.GotYouModel:Clear()
        Event.Brocast(Notes.QUIT_BATTLE)

        local gameType = ModelList.BattleModel:GetGameType()
        local loadingView = ViewList.SceneLoadingGameView
        if gameType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
            loadingView = ViewList.WinZoneLoadingGameView
        end
        LoadScene("SceneHome", loadingView, true)

        --UnityEngine.Resources.UnloadUnusedAssets()
    end)
end

---获取当前bet
function GotYouSmallGameView:GetCurrBet()
    return self.currBet
end

---收到spin奖励
function GotYouSmallGameView:OnSpinReward(data)
    self.MansionSpinInfo = data
    self.MansionInfo.curRate = self.MansionSpinInfo.rate
    self.MansionInfo.freeSpinTimes = self.MansionSpinInfo.freeSpinTimes
    self.MansionInfo.totalWin = self.MansionSpinInfo.totalWin
    self._fsm:GetCurState():OnReceiveSpin()
end

function GotYouSmallGameView:OnDisable()
    if CityHomeScene then
        CityHomeScene:SetEnterHallFromUI(true)
    end
    this.isOpen = false
    self.MansionSpinInfo = nil
    self.MansionInfo = nil
    FsmCreator:DisposeFsm(self)
    --- 结束的时候恢复原始速度
    if this.oriTimeScale then
        Time.timeScale = this.oriTimeScale
        this.oriTimeScale = nil
    end
    if self.delayRestore then
        LuaTimer:Remove(this.delayRestore)
        this.delayRestore = nil
    end
    if self.refreshFree then
        LuaTimer:Remove(this.refreshFree)
        this.refreshFree = nil
    end
    AddLockCountOneStep(false)
    Facade.RemoveViewEnhance(self)
    --if this._exit_callback then
    --    this._exit_callback()
    --    this._exit_callback = nil
    --end
end

function GotYouSmallGameView:CloseAnimation()
    --- 结束的时候恢复原始速度
    if this.oriTimeScale then
        Time.timeScale = this.oriTimeScale
        this.oriTimeScale = nil
    end

    --if this._exit_callback then
    --    this._exit_callback()
    --    this._exit_callback = nil
    --end
end

--播放界面退场动画
function GotYouSmallGameView:ForceExit()
    --if this._exit_callback then
    --    this._exit_callback()
    --    this._exit_callback = nil
    --end
    if ViewList.GotYouSmallGameView then
        Facade.SendNotification(NotifyName.CloseUI, ViewList.GotYouSmallGameView)
        ViewList.GotYouSmallGameView = nil
    end
    --- 结束的时候恢复原始速度
    if this.oriTimeScale then
        Time.timeScale = this.oriTimeScale
        this.oriTimeScale = nil
    end
end

function GotYouSmallGameView:SetBingoCount(freeTime)
    if self.bingoCount then
        self.bingoCount.text = freeTime
    end
    if self.PigGameCZFreeDi then
        AnimatorPlayHelper.Play(self.PigGameCZFreeDi, { "bingo", "PigGameCZFreeDibingo" }, false, function ()
            self:SetFreeTimes()
        end)
    end
end

function GotYouSmallGameView:ShowGuide(guideStep)
    if guideStep == 1 then
        self.GuideText.text = Csv.GetDescription(191066)
        self.GuideBg:Get("Ban").sprite = AtlasManager:GetSpriteByName("GotYouSmallGameGuideAtlas", "xKuang")
        self.GuideBg:Get("headBg").sprite = AtlasManager:GetSpriteByName("GotYouSmallGameGuideAtlas", "xYuanDi")
        self.GuideBg:Get("head").sprite = AtlasManager:GetSpriteByName("GotYouSmallGameGuideAtlas", "xJueSe")
        fun.set_active(self.Guideyindaosuo, false)
        if self.PigGameCZFreeDi then
            AnimatorPlayHelper.Play(self.PigGameCZFreeDi, { "yindao", "PigGameCZFreeDiyindao" }, false, function ()
                ---BINGOxN出现，飞到Freegame位置,锁上
                self._fsm:ChangeState("ShowBingoState")
            end)
        end
    else
        self.GuideText.text = Csv.GetDescription(191067)
        if self.PigGameCZFreeDi then
            fun.set_active(self.Guideyindaosuo, true)
            AnimatorPlayHelper.Play(self.PigGameCZFreeDi, { "yindao", "PigGameCZFreeDiyindao" }, false, function ()
                ---BINGOxN出现，飞到Freegame位置,锁上
                self._fsm:ChangeState("IdleState")
                ModelList.GuideModel.ReqFinishGuide(89, -1)
                --Done LwangZg 资源卸载
                --- 卸载引导资源
                -- resMgr:UnloadAssetBundle("GotYouSmallGameGuideAtlas", true)
                ResourcesManager:UnloadAsset("GotYouSmallGameGuideAtlas", true)
            end)
        end
    end
end

---播放全部格子凸出来效果
function GotYouSmallGameView:AllCellUpEffect()
    for i = 1, 24 do
        if self["Cell" .. i] then
            self["Cell" .. i]:Play("act", -1, 0)
            --log.r("PlayCellActEffect", i)
        end
    end
    UISound.play("moneymansionspin")
end

---判断是否spin按钮置灰
function GotYouSmallGameView:CheckSpinBtnGray(isGray)
    Util.SetUIImageGray(self.btn_spin.gameObject, isGray)
end

---判断是否spin按钮置灰
function GotYouSmallGameView:SetOpenState()
    this.isOpen = true
end

------------------------------private ------------------------------------------

---检查是否需要弹出help界面
function Private.CheckPopHelpView(self)
    if not ModelList.BattleModel:IsGameing() then
        local playerInfo = ModelList.PlayerInfoModel:GetUserInfo()
        local defaultState = fun.read_value("GotYouSmallGameHelperView" .. playerInfo.uid, 0)
        if defaultState == 0 then
            local view = require("View.HallCity.GotYou.GotYouSmallGameHelperView")
            --Facade.SendNotification(NotifyName.ShowUI,ViewList.GotYouSmallGameView,nil,nil,2)
            Facade.SendNotification(NotifyName.ShowUI, view)
        end
    end
end

---------------------bet---------------

function Private.GetFitStartId(self)
    local baseBetId = 1
    for i = 1, 5 do
        local betInfo = Csv.GetData("moneymansion", self.currBet, "bet")
        if betInfo and betInfo[1] <= self.currBet and betInfo[2] >= self.currBet then
            break
        end
        baseBetId = baseBetId + 24
    end
    return baseBetId
end

---进入Ultrabet 表现
function Private.ChangeUltraBetEffect(self, isUltrabet)
    if self.Cells then
        ---定义一个加成系数
        self.RewardInfo.rewardNum = {}
        local position_reward = Csv.GetData("moneymansion", self.currBet, "position_mes")
        for i, v in ipairs(self.Cells) do
            local value = position_reward[i][3] * self.MansionInfo.totalBetList[self.currBet].totalBet
            v:Roll(value)
            table.insert(self.RewardInfo.rewardNum, value)
        end
    end
end

function Private.CheckUltraBet(self)
    local lastUltrabet = self.isUltrabet
    self.isUltrabet = self.currBet > UltraBet and true or false
    Private.ChangeUltraBetEffect(self, true)
    --if lastUltrabet and not self.isUltrabet then     --退出Ultrabet
    --    Private.ChangeUltraBetEffect(self, false)
    --elseif not lastUltrabet and self.isUltrabet then --进入Ultrabet
    --
    --end
end

---SetBetMax
function Private.SetBetMax(self, isGray)
    if self.btn_increate then
        Util.SetUIImageGray(self.btn_increate, true)
    end
    self.isMaxGray = true
end

function Private.SetBetMin(self, isGray)
    if self.btn_decreate then
        Util.SetUIImageGray(self.btn_decreate, true)
    end
    self.isMinGray = true
end

function Private.CheckCancelGrayBet(self, bet, changeType)
    if self.isMaxGray and self.currBet ~= MaxBet and self.currBet ~= 5 then
        Util.SetUIImageGray(self.btn_increate, false)
        self.isMaxGray = false
    end
    if self.isMinGray and self.currBet ~= MinBet and self.currBet ~= 6 then
        Util.SetUIImageGray(self.btn_decreate, false)
        self.isMinGray = false
    end
    if bet == MaxBet then
        Private.SetBetMax(self, true)
    end
    if bet == MinBet then
        Private.SetBetMin(self, true)
    end
    if bet == 5 then
        Private.SetBetMax(self, false)
    elseif bet == 6 then
        Private.SetBetMin(self, false)
    end
    if changeType == 3 then
        Private.InitBetBtnType(self)
    else
        Private.InitMaxBetBtnSkin(self)
    end
end

---初始化bet按钮
function Private.InitBetBtnType(self)
    if self.currBet < 5 then
        self.maxbetImg.sprite = AtlasManager:GetSpriteByName("GotYouSmallGameAtlas", "PigGameZ04")
    elseif self.currBet == 5 then
        self.maxbetImg.sprite = AtlasManager:GetSpriteByName("GotYouSmallGameAtlas", "PigGameZ09")
    elseif self.currBet >= 6 then
        self.maxbetImg.sprite = AtlasManager:GetSpriteByName("GotYouSmallGameAtlas", "PigGameZ08")
    end
    fun.set_active(self.PigGameZ010, self.currBet >= 6)
end

function Private.InitMaxBetBtnSkin(self)
    if self.lastBet ~= self.currBet then
        if (self.currBet < 5 and self.lastBet >= 5) then
            self.maxbetImg.sprite = AtlasManager:GetSpriteByName("GotYouSmallGameAtlas", "PigGameZ04")
        elseif ((self.currBet == 5 and self.lastBet < 5)) then
            self.maxbetImg.sprite = AtlasManager:GetSpriteByName("GotYouSmallGameAtlas", "PigGameZ09")
        end
    end
end

-------------------end bet-------------------



---------------------normal---------------

---播放通用命中效果
function Private.PlayHitEffectOver(self, index)
    if self["Cell" .. index] then
        AnimatorPlayHelper.Play(self["Cell" .. index], { "zhong", "cellzhong" }, false, function ()
            self:PlayHitEffectOver()
        end)

        if index == 22 then
            UISound.play("moneymansionbonus")
        elseif index == 23 then
            UISound.play("moneymansionhammer")
        elseif index == 24 then
            UISound.play("moneymansiondoor")
        else
            UISound.play("moneymansionreward")
        end
    end
end

---触发金币爆炸效果
function Private.PlayCoinsBoomEffect(self, index)
    if index <= 21 then
        if self.jinbi then
            self.jinbi:Play("jinbi0" .. Private.GetCoinBoomAnimaIndex(index))
        end
        if self.jinbi2 then
            self.jinbi2:Play("jinbi0" .. Private.GetCoinBoomAnimaIndex(index))
        end
    end
end

---播放最高等级撒金币效果
function Private.PlayMaxCoinsBoomEfffect(self)
    if self.jinbi then
        self.jinbi:Play("jinbi03")
    end
    if self.jinbi2 then
        self.jinbi2:Play("jinbi03")
    end
end

---播放全部格子凸出来效果
function Private.PlayAllCellUpEffect(self)
    for i = 1, 21 do
        if self["Cell" .. i] then
            self["Cell" .. i]:Play("act", -1, 0)
            log.r("PlayCellActEffect", i)
        end
    end
    if self.Cell24 then
        self.Cell24:Play("act", -1, 0)
    end
end

---表现结束,恢复初始状态
function Private.RestoreIdleState(self)
    if self and self._fsm then
        self._fsm:ChangeState("IdleState")
        self:CheckSpinBtnGray(false)
    end
    if self.MansionSpinInfo and self.MansionSpinInfo.reward and #self.MansionSpinInfo.reward.positions > 0 then
        for i, v in pairs(self.MansionSpinInfo.reward.positions) do
            self.Cells[v]:SetInfo(self.RewardInfo.rewardNum[v])
        end
    end
end

---播放totolwin涨数字效果
function Private.GetCoinBoomAnimaIndex(cellIndex)
    if cellIndex <= 8 or cellIndex >= 22 then
        return 1
    elseif cellIndex <= 10 or cellIndex == 20 then
        return 2
    else
        return 3
    end
end

---播放totolwin涨数字效果
function Private.PlayTotalWinRollEffect(self, addDelayTime)
    --Event.Brocast(EventName.Event_currency_change)
    AddLockCountOneStep(false)
    Event.Brocast(EventName.Event_currency_change)
    if self.totalWinText then
        if not addDelayTime then addDelayTime = 0 end
        self.totalWinText:RollByTime(self.MansionSpinInfo.totalWin, 2, nil)
        self.delayRestore = LuaTimer:SetDelayFunction(2 + addDelayTime, function ()
            Private.RestoreIdleState(self)
        end)
    end
    if self.bao then
        fun.set_active(self.bao, false)
        fun.set_active(self.bao, true)
    end
    Private.RefreshFreeTimes(self)
    self:ChangeBet(4, self.MansionSpinInfo.rate)
end

------------------end normal----------------------



---------------------bursh 刷子-------------------
---检查是否触发刷子icon动效
function Private.CheckBrushIconEffect(self, index)
    if index == 22 then
        Private.PlayBrushIconHitEffect(self)
    end
end

---同步播放刷子icon 中奖效果
function Private.PlayBrushIconHitEffect(self)
    if self.brush then
        AnimatorPlayHelper.Play(self.brush, { "zhong", "cellbishuashuazhongenter" }, false, function ()
            Private.PlayBrushFlyEffect(self)
        end)
    end
end

---播放刷子飞行效果
function Private.PlayBrushFlyEffect(self, cellIndex)
    self.MansionSpinInfo = ModelList.GotYouModel:GetMansionSpinInfo()
    if self.MansionSpinInfo and self.MansionSpinInfo.reward then
        for i, v in pairs(self.MansionSpinInfo.reward.positions) do
            local targetPos = fun.get_localposition(self["Cell" .. v]) - fun.get_localposition(self["Cell22"])
            Anim.move_by_speed(self.brush, targetPos.x, targetPos.y, brushFlySpeed, true,
                DG.Tweening.Ease.InBack, function ()
                    Private.PlayBrushEffect(self)
                end)
        end
    end
end

--- 刷子中奖格子收回去，奖励数值还原
function Private.PlayBrushWinRewardCellBackEffect(self)
    for i, v in pairs(self.MansionSpinInfo.reward.positions) do
        self.Cells[v]:Roll(self.RewardInfo.rewardNum[v])
    end
    --Private.RestoreIdleState(self)
end

---播放刷子飞回原处效果
function Private.PlayBrushBackEffect(self)
    Anim.move_by_speed(self.brush, 0, 0, brushFlySpeed, true,
        DG.Tweening.Ease.InBack, function ()
            --Private.RestoreIdleState(self)
        end)
end

---播放刷子刷新奖励效果
function Private.PlayBrushEffect(self, cellIndex)
    UISound.play("moneymansionbrush")
    AnimatorPlayHelper.Play(self.brush, { "shua", "cellbishuazhongshua" }, false, function ()
        Private.PlayBrushBackEffect(self)
        Private.PlayTotalWinRollEffect(self, 1.5)
        if self.MansionSpinInfo and self.MansionSpinInfo.reward then
            for i, v in pairs(self.MansionSpinInfo.reward.positions) do
                self.Cells[v]:SetInfo(self.MansionSpinInfo.reward.coinReward)
                AnimatorPlayHelper.Play(self["Cell" .. v], { "zhong", "cellzhong" }, false, function ()
                    --Private.PlayBrushWinRewardCellBackEffect(self)
                end)
                Private.PlayCoinsBoomEffect(self, v)
            end
            self:SaveTotalWinNumByValue(self.MansionSpinInfo.reward.coinReward)
        end
    end)
end

---------------------end 刷子-------------------




---------------------bursh 锤子-------------------

---播放房子抖动效果
function Private.PlayMansionShakeEffect(self)
    if self.BuildIcon then
        self.BuildIcon:Play("act")
    end
end

---播放锤子击中其他格子奖励效果
function Private.PlayHammerHitOtherOver(self)
    Private.RestoreIdleState(self)
end

---播放锤子奖励效果 (全部格子都凸出来，整个房子加一个抖动的效果)
function Private.PlayHammerHitEffectOver(self)
    self.MansionSpinInfo = ModelList.GotYouModel:GetMansionSpinInfo()
    if self.MansionSpinInfo and self.MansionSpinInfo.reward then
        ---全部格子都凸出来
        Private.PlayAllCellUpEffect(self)
        ---整个房子抖动的效果
        Private.PlayMansionShakeEffect(self)
        for i, v in pairs(self.MansionSpinInfo.reward.positions) do
            if self["Cell" .. v] then
                AnimatorPlayHelper.Play(self["Cell" .. v], { "zhong", "cellzhong" }, false, function ()
                    --Private.PlayHammerHitOtherOver(self)
                end)
                self:SaveTotalWinNumByIndex(v)
            end
        end
        Private.PlayMaxCoinsBoomEfffect(self)
        Private.PlayTotalWinRollEffect(self, 1.5)
    end
end

----------------------------------end 锤子-------------------


-----------------------door 门----------------------

---播放门打开效果
function Private.PlayDoorOpenEffect(self)
    local targetPos = fun.get_localposition(self.doorTargetPos)
    local newPos = targetPos - fun.get_localposition(self.freePig1.transform.parent)
    Anim.move(self.freePig1, newPos.x, newPos.y, 0, 0.2, true, false, function ()
        if fun.is_not_null(self.freePig1) then
            fun.set_active(self.freePig1, false)
            fun.set_rect_local_pos(self.freePig1, 0, 0, 0)
        end
        Private.AddFreeTimes(self)
    end)
    newPos = targetPos - fun.get_localposition(self.freePig2.transform.parent)
    Anim.move(self.freePig2, newPos.x, newPos.y, 0, 0.4, true, false, function ()
        if fun.is_not_null(self.freePig2) then
            fun.set_active(self.freePig2, false)
            fun.set_rect_local_pos(self.freePig2, 0, 0, 0)
        end
        Private.AddFreeTimes(self)
    end)
    newPos = targetPos - fun.get_localposition(self.freePig3.transform.parent)
    Anim.move(self.freePig3, newPos.x, newPos.y, 0, 0.6, true, false, function ()
        Private.RefreshFreeTimes(self, true)
        if fun.is_not_null(self.freePig3) then
            fun.set_active(self.freePig3, false)
            fun.set_rect_local_pos(self.freePig3, 0, 0, 0)
        end
    end)
end

---增加免费次数
function Private.AddFreeTimes(self)
    self.freeTimes = tonumber(self.freeGameText.text) + 1
    self.PigGameCZFreeDi:Play("act", -1, 0)

    self:SetFreeTimes()
end

--- 刷新最新的免费字数
function Private.RefreshFreeTimes(self, isdoor)
    if not self.MansionSpinInfo then
        self.freeTimes = self.MansionInfo.freeSpinTimes
    else
        self.freeTimes = self.MansionSpinInfo.freeSpinTimes
    end
    self:SetFreeTimes()
    self.refreshFree = LuaTimer:SetDelayFunction(0.4, function ()
        if fun.is_not_null(self.freePig3) then
            fun.set_active(self.freePig3, true)
        end
        if fun.is_not_null(self.freePig2) then
            fun.set_active(self.freePig2, true)
        end
        if fun.is_not_null(self.freePig1) then
            fun.set_active(self.freePig1, true)
        end
        if isdoor then
            Private.RestoreIdleState(self)
        end
    end)
end

----------------------end 门----------------------


----------------------待机----------------------

---播放待机效果
function Private.PlayIdleEffect(self)

end

function GotYouSmallGameView:PlaySpinIdelEffect()
    for i = 1, 24 do
        self["Cell" .. i]:Play("idle")
    end
end

---------------------end 待机-------------------

function GotYouSmallGameView:OnShopViewClose()
    if self and self._fsm then
        self._fsm:GetCurState():OnResumeIdle()
    end
end

function GotYouSmallGameView:OnNotifyOpenShopView()
    Facade.SendNotification(NotifyName.ShopView.PopupShop, PopupViewType.show, nil, nil, nil)
end

this.NotifyEnhanceList = {
    { notifyName = NotifyName.ShopView.OnCloseViewFinish, func = this.OnShopViewClose },
    { notifyName = NotifyName.ShopView.OpenShopView,      func = this.OnNotifyOpenShopView },
}

return this
