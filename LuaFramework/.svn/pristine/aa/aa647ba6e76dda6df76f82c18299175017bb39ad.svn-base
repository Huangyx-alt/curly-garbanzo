---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 15610.
--- DateTime: 2022/3/18 11:25
---
local ExportBattleData = {}
local this = ExportBattleData


function ExportBattleData:Export()
    local count = 10  -- 导出的数据量
    local dataList = {}
    for i = 1, count do
        local data = this:GetData()
        if data then
            table.insert(dataList, data)
        end
    end
    --- 指定导出路径
    local path1 = string.gsub(UnityEngine.Application.dataPath, "/Assets", "") .. "/tool/moni/datalist"
    this:file_save(path1, TableToJson(dataList))
end


function ExportBattleData:GetData()
    --- playId  1 城市1 2 城市2 3 城市3 4 挂机 5 鸡尾酒 6 圣诞 7 绿头人 8 狼人 9 美食派对 10 城市4 11 城市5 12 宝石皇后 13 寻找糖果
    ---type 不同ID对应不同type
    ---cityId 1
    ---cardNum 卡牌数量  1 2 4 8
    ---rate 倍率  1-10
    local txt = "http://livepartybingo.test.51chivalry.com:8080/newGame.php?uid=90036&playId=13&type=15&cityId=1&cardNum=4&rate=10&powerUpRate=3&puLevel=4&free=1&auto=0&bingoIndex=0"
    local data = nil
    if fun.starts(txt,"http") then
        data = this:HandleUrlContent(txt)
        if data and data ~= "nil" and data ~="" then
            local text = JsonToTable((data))
            if text then
                local newText = {cardsInfo = {}, publishNumbers = text.publishNumbers}
                for i = 1, #text. cardsInfo do
                    local temp = {cardId = text.cardsInfo[i].cardId, numbers = text.cardsInfo[i].numbers,beginMarkedPos = text.cardsInfo[i].beginMarkedPos}
                    table.insert(newText.cardsInfo, temp)
                end
                return newText
            end
        end
    end
    return data
end

function ExportBattleData:file_save(filename, data)
    local file
    if filename == nil then
        file = io.stdout
    else
        local err
        file, err = io.open(filename, "wb")
        if file == nil then
            error(("Unable to write '%s': %s"):format(filename, err))
        end
    end
    file:write(data)
    if filename ~= nil then
        file:close()
    end
end


function ExportBattleData:HandleUrlContent(url)
    local http = require("socket.http")
    local resp = http.request(url)

    local resp1 = string.split(resp,"posList不存在99")[1]

    local resp2 = string.split(resp1,"loadGame 返回值")[2]
    --print(resp2)
    local data = string.split(resp2,"预结算数据")
    local resp3 = data[1]
    --print(resp3)
    --local loadData = string.split(resp3, "<br>")[1]

    local data = string.split(resp2,"预结算数据")
    local loadData = string.split(data[1], "<br>")[1]

    return loadData
end

function ExportBattleData:readAll(file)
    local f = assert(io.open(file, "rb"))
    local content = f:read("*all")
    f:close()
    return content
end


return this


