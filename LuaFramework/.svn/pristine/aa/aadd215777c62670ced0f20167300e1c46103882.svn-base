---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/10/12 11:18
---
local GameCardView = require("View.Bingo.UIView.CardView.GameCardView")
require "Logic/AnimatorPlayer"

--- 挂机卡牌界面
---@class HangUpCardView :  GameCardView
local HangUpCardView =  GameCardView:New("HangUpCardView")
local this = HangUpCardView
--this.__index = this
local loadData = nil
this.mapList = {}
this.number_offset = 12

function HangUpCardView:GetModel()
    return ModelList.HangUpModel
end

function HangUpCardView:OnEnable(hangupView, bingosiRef, is_open_search)
    --self:SetNumerOffset(self.number_offset)
    self:BaseEnable(hangupView, bingosiRef, is_open_search)
    --this.cardLoad:LoadHangUpCardData(this.parent.Bg, hangupView.MapType, this.parent.HangMap)
    LuaTimer:SetDelayFunction(2, function()
        this:SetDefaultOpenCell()
    end,nil,LuaTimer.TimerType.Battle)
    this:RegisterHangUpEvent()
    loadData = ModelList.HangUpModel:LoadGameData()
end


function HangUpCardView:RegisterHangUpEvent()
    --Event.AddListener(EventName.Event_hangup_sign_reward, self.sign_cell_handler)
    Event.AddListener(Notes.AUTO_CLICK_HANG_UP, this.AutoClickCardByNum)
    Event.AddListener(EventName.Hide_Cell_Bg, this.HideBg)
    this:RegisterEvent()
end

function HangUpCardView:UnRegisterHangUpEvent()

    --Event.RemoveListener(EventName.Event_hangup_sign_reward, self.sign_cell_handler)
    Event.RemoveListener(Notes.AUTO_CLICK_HANG_UP, this.AutoClickCardByNum)
    Event.RemoveListener(Notes.Hide_Cell_Bg, this.HideBg)
    this:UnRegisterEvent()
end

function HangUpCardView:AutoClickCardByNum( currNumber)
    --log.r("AutoClickCardByNum "..currNumber)
    if ModelList.HangUpModel:IsGameOver() then return end
    local roundData = ModelList.HangUpModel:GetRoundData()
    this.roundData = ModelList.HangUpModel:GetRoundData()
    local req_info = { gameId = ModelList.HangUpModel:GetGameId(), total = {} }
    for i = 1, #loadData.cardsInfo do
        local id = loadData.cardsInfo[i].cardId
        local id_str = tostring(id)
        for j = 1, #loadData.cardsInfo[i].numbers do
            local get_num = loadData.cardsInfo[i].numbers[j]
            local double_num = roundData[id_str].cards[j].double_num
            local sign_type = roundData[id_str].cards[j].sign
            local index = roundData[id_str].cards[j].index
            if sign_type == 0 and (get_num == currNumber or double_num == currNumber) then
                local info = { cardId = id, number = get_num, index = index }
                table.insert(req_info.total, info)
            end
        end
    end
    if req_info.total and #req_info.total > 0 then
        ModelList.HangUpModel:ReqSignCard(req_info)
        this:AutoClickCard(req_info)
        Event.Brocast(EventName.Switch_View_Refresh, req_info.total, true)
    end
end

function HangUpCardView:AutoClickCard(sign_info)
    if ModelList.HangUpModel:IsGameOver() then return end
    local has_contain_gift = false
    local has_sign = false
    local firstSignCell = nil -- 挂机第一个被盖章的棋子
    for i = 1, #sign_info.total do
        local card_id = tonumber(sign_info.total[i].cardId)
        local index = ModelList.HangUpModel:GetIndexByNum(sign_info.total[i].cardId, sign_info.total[i].number)
        local card_cell = this:GetCardCell(card_id, index)
        if not index then
            log.r("card_id      " .. sign_info.total[i].cardId .. "    type  " .. type(card_id) .. "      index  " .. sign_info.total[i].number)
        end
        local t_id = sign_info.total[i].cardId
        if not has_contain_gift and #this.roundData[tostring(t_id)].cards[index].gift > 0 then
            has_contain_gift = true
        end
        if firstSignCell == nil then
            firstSignCell = card_cell
        end
        self:SignCardEffect(card_id,index,card_cell)
        local effectType =  this.model:HasCardCellGift(card_id,index)
        --self:CardMapPickEffect(card_id, effectType and 3 or 1)
        Event.Brocast(EventName.CardEffect_MapClick_Effect, card_id, effectType and 3 or 1)
        Event.Brocast(EventName.CardSingEffect_CellTip, card_cell, false)
        has_sign = true
    end
    if has_sign then
        Event.Brocast(Notes.SYNC_SIGN)
    end    --一个叫号，不管几张卡上盖了这个号，都只算一个充能；
    if has_contain_gift then
        UISound.play("kick_reword")
    end
    if sign_info and sign_info.total and #sign_info.total >0 then
        UISound.play("kick_call")
    end
end


--隐藏背景板
function HangUpCardView.HideBg(owner, card_id, cell_index)
    local cardid = tonumber(card_id)
    local obj = this:GetCardCell(cardid, cell_index)
    local refer = fun.get_component(obj,fun.REFER)
    local bg_tip = refer:Get("bg_tip")
    --local child = fun.find_child(obj, "bg_tip")
    fun.set_active(bg_tip, false)
end

function HangUpCardView:OnDisable()
    this:UnRegisterHangUpEvent()
    self:BaseDisable()
end

function HangUpCardView:ShowAutoSignFlag(isopen)

end

function HangUpCardView:OutFrame()
    return this.parent.bottle.transform.localPosition.x > 300 and this.parent.box.transform.localPosition.x > 300
end

return this