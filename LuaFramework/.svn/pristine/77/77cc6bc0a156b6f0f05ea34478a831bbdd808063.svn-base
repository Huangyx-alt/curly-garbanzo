---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/1/5 19:12
---
local setmetatable = setmetatable

local  GameBuffView = BaseView:New();
local this = GameBuffView;
this.viewType = CanvasSortingOrderManager.LayerType.None
this.auto_bind_ui_items = {
    "Gold",
    "GoldRate",
    "Diamond",
    "DiamondRate",
    "Cherry",
    "CherryRate"
}

this.coin_add_ratio = 1
this.xp_add_ratio = 1
this.cherry_add_ratio = 1


function GameBuffView:New(viewName,atlasName, parentView,disable,bundleName)
    local o = {};
    setmetatable(o, { __index = this })
    o.viewName = viewName
    o.atlasName = atlasName
    o._parentView = parentView
    o._disable = disable
    return o
end

function GameBuffView:Awake()
    self:on_init()
    this.coin_add_ratio = 1
    this.xp_add_ratio = 1
    this.cherry_add_ratio = 1
end

function GameBuffView:OnEnable()
    this:RegisterEvent()
end

function GameBuffView:OnDisable()
    this:UnRegisterEvent()
end

function GameBuffView:OnDestroy()
    self:Destroy()
end

function GameBuffView:SetParent(parentRef,rootObj)
    this.parent = parentRef
    this.Root = rootObj
end

function GameBuffView:RefreshData(itemType , itemId)
    if self.Gold == nil  or self.Diamond or self.Cherry then
        if this.Root == nil then log.r(" GameBuffView  root  nil") end
        local ref = fun.get_component(this.Root,fun.REFER)
        self.Gold = ref:Get("Gold")
        self.GoldRate = ref:Get("GoldRate")
        self.Diamond =ref:Get("Diamond")
        self.DiamondRate=ref:Get("DiamondRate")
        self.Cherry=ref:Get("Cherry")
        self.CherryRate=ref:Get("CherryRate")
    end
    --if self.Cherry == nil then log.r("self cherry  nil") end
    local result = Csv.GetData("item",itemId,"result")
    if result and result[1]  == 5 then
        if result[2] ==  5 then  --exp
            this.xp_add_ratio = this.xp_add_ratio + result[3]*0.01
        elseif result[2] ==  2 then  --coin
            this.coin_add_ratio = this.coin_add_ratio + result[3]*0.01
        elseif result[2] ==  6 then  --cherry
            this.cherry_add_ratio = this.cherry_add_ratio + result[3]*0.01
        end
        if this.xp_add_ratio >1 then
            fun.set_active(self.Diamond,true)
            self.Diamond:Play("D",-1,0)
            --BattleEffectPool:ShowWithAutoRecycle("daoju_baodian",self.Diamond.gameObject,2)
            --BattleEffectCache:GetPrefabFromCache("DaojubaodianGet",self.Diamond.gameObject,function(obj)
            --    fun.set_gameobject_scale(obj, 0.5, 0.5, 1)
            --    Destroy(obj, 2)
            --end)
            self.DiamondRate.text = tostring(this.xp_add_ratio).."X"
        end
        if this.coin_add_ratio >1 then
            fun.set_active(self.Gold,true)
            self.GoldRate.text = tostring(this.coin_add_ratio).."X"
        end
        if this.cherry_add_ratio >1 then
            fun.set_active(self.Cherry,true)
            self.CherryRate.text = tostring(this.cherry_add_ratio).."X"
        end
        log.r("itemId    "..itemId.."    "..this.xp_add_ratio.."    "..this.coin_add_ratio.."    "..this.cherry_add_ratio)
    end
end


function GameBuffView:RegisterEvent()
    Event.AddListener(EventName.Event_Bingo_Buff,this.OnGetBuff)
end

function GameBuffView:UnRegisterEvent()
    Event.RemoveListener(EventName.Event_Bingo_Buff,this.OnGetBuff)
end

function GameBuffView:OnGetBuff(data)
    local boxType = data.boxType
    local itemId = data.itemId
    this:RefreshData(boxType,itemId)
    --BattleEffectCache:GetPrefabFromCache("DaojubaodianGet",this.Diamond.gameObject,function(obj)
    --    fun.set_gameobject_scale(obj, 0.5, 0.5, 1)
    --    Destroy(obj, 2)
    --end)
end


return this