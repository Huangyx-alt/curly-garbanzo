---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/7 10:36
---
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/7 10:36
---
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/7 10:22
---

local SettleRankView = BaseView:New('SettleRankView','SettleAtlas');
local avatarAndFrameViewCode = require "View/PlayerInfoSysView/PlayerInfoUpdateAvatarAndFrame"

local this = SettleRankView;

this.auto_bind_ui_items = {
    "btn_speedUp"
}
local SHOW_TIME = 3
this.settleData = nil

this.model = nil

function SettleRankView.Awake()
    this:on_init()
    this:SetControlModel()
    this:OpenRound3()
end

function SettleRankView.OnEnable()
    
end


function SettleRankView.OnDisable()
    --log.r("SettleRankView:on_close")
end


function SettleRankView.OnDestroy()
    this:Destroy()
end

function SettleRankView:SetControlModel()
    this.model = ModelList.BattleModel:GetCurrModel()
    if this.model == nil then
        log.r("no  game battle model")
    end
end


--结算面板 阶段3  显示Round3
function SettleRankView:OpenRound3()
    this:HandleRound3()
    this:StartCountdown3()
    UISound.play("settlement_topthree")
    this:initSpeedUp()
end

--结算面板 阶段3处理
function SettleRankView:HandleRound3()
    this.settleData = this.model:GetSettleData()
    if this.settleData.ranks[1].nickName  =="0" or this.settleData.ranks[2].nickName  =="0"
            or this.settleData.ranks[3].nickName  =="0" then
        for i = 1, 3 do
            local tempData = nil
            for j = 1, #this.settleData.ranks do
                local rank = this.settleData.ranks[j].rank
                if rank == i  then
                    tempData = this.settleData.ranks[j]
                    break
                end
            end
            local obj = fun.find_child(self.go,"SettleHead"..i)
            this:SetRound3Head(obj, tempData.rank, tempData.score, tempData.nickName,tempData.tiers )
        end
    else
        for i = 1, 3 do
            local tempData = nil
            for j = 1, #this.settleData.ranks do
                local rank = this.settleData.ranks[j].rank
                if  (i <3 and rank == i)  or   this.settleData.ranks[j].nickName  =="0" then
                    tempData = this.settleData.ranks[j]
                    break
                end
            end
            local obj = fun.find_child(self.go,"SettleHead"..i)
            this:SetRound3Head(obj, tempData.rank, tempData.score, tempData.nickName,tempData.tiers )
        end
    end
end


function SettleRankView:SetRound3Head(obj,rank,score,nickname, tiers)
    local refTemp = fun.get_component(obj,fun.REFER)
    local name = ""
    local icon = ""
    local hasOpenTournament = true
    local headObj =  refTemp:Get("headObj")
    local avatarAndFrameView= avatarAndFrameViewCode:New()
    avatarAndFrameView:SkipLoadShow(headObj.gameObject)
    if nickname == "0" then  --自己
        name = ModelList.PlayerInfoModel:GetNickName()
        icon = ModelList.PlayerInfoModel:GetHeadIcon()
        local anima = fun.get_component(obj,fun.ANIMATOR)
        anima:SetBool("self",true)
        anima.keepAnimatorStateOnDisable = true
        local rankIcon =refTemp:Get("rank")
        rankIcon.sprite = AtlasManager:GetSpriteByName("SettleAtlas","jsYou")
        if rank == 1 then
            refTemp:Get("name").text = tostring(rank).."st"
        elseif rank == 3 then
            refTemp:Get("name").text = tostring(rank).."rd"
        elseif rank == 2 then
            refTemp:Get("name").text = tostring(rank).."nd"
        else
            refTemp:Get("name").text = tostring(rank).."th"
        end
        if not ModelList.TournamentModel:CheckOpenTournament() then
            --未开启
            hasOpenTournament = false
        end
        avatarAndFrameView:SetPlayerSelf()
    else
        name =  Csv.GetData("robot_name",tonumber(nickname),'name')
        icon =  Csv.GetData("robot_name",tonumber(nickname),'icon')
        local frameName =  Csv.GetData("robot_name",tonumber(nickname),'edge')
        refTemp:Get("name").text = name
        avatarAndFrameView:SetAvatarId(icon)
        avatarAndFrameView:SetFrameIdByName(frameName)
    end
    refTemp:Get("score").text = fun.formatNum(score)
    local imageTrophy = refTemp:Get("imageTrophy")
    if tiers and tiers ~= 0 and hasOpenTournament == true  then
        LuaTimer:SetDelayFunction(0.7, function()
            fun.set_active(imageTrophy , true)
        end,false)
        local trophyName = fun.GetCurrTournamentActivityImg(tiers)
        Cache.load_sprite(AssetList["trophyName"],trophyName,function(sprite)
            if sprite then
                imageTrophy.sprite = sprite
            end
        end)
    else
        fun.set_active(imageTrophy , false)
    end
end


function SettleRankView:StartCountdown3()
    this.timerId3 = LuaTimer:SetDelayFunction(SHOW_TIME+1.5, function()
        ViewList.GameSettleView:JumpNextView()
        Facade.SendNotification(NotifyName.HideUI,ViewList.SettleRankView)
        this:StopCountdown3()
    end,false,LuaTimer.TimerType.BattleUI)

end


function SettleRankView:on_btn_speedUp_click()
    local flag =  ViewList.GameSettleView:SpeedUp(2)
    local on = fun.find_child(self.btn_speedUp,"on")
    local off =  fun.find_child(self.btn_speedUp,"off")

    if flag then 
        fun.set_active(on,false)
        fun.set_active(off,true)
    else 
        fun.set_active(on,true)
        fun.set_active(off,false)
    end 

end

function SettleRankView:initSpeedUp()
    if ModelList.GuideModel.IsFirstBattle() then 
        fun.set_active(self.btn_speedUp,false)
        return 
    end 

    local flag = ViewList.GameSettleView:GetSpeedUp()
    local on = fun.find_child(self.btn_speedUp,"on")
    local off =  fun.find_child(self.btn_speedUp,"off")
    if flag == false then --加速状态
        fun.set_active(on,true)
        fun.set_active(off,false)
        ViewList.GameSettleView:SetSpeedUp(1.5)
    end 
end


function SettleRankView:StopCountdown3()
    if this.timerId3 then
        LuaTimer:Remove(this.timerId3,LuaTimer.TimerType.BattleUI)
        this.timerId3 = nil
    end
end




return this

