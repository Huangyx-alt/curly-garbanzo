---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/18 11:27
---
local BaseBingoEffect = require("View.Bingo.EffectModule.Card.BingoEffect.BaseBingoEffect")

local HawaiiBingoEffect = BaseBingoEffect:New("HawaiiBingoEffect")
local this = HawaiiBingoEffect
setmetatable(HawaiiBingoEffect, BaseBingoEffect)

local function GetBingoCount(cardId,bingoCount)
    return this:GetCardView():GetBingoType(cardId,bingoCount)
end

function HawaiiBingoEffect:ShowBingoOrJackpot(bingoData)
    for k, v in pairs(bingoData) do
        local mIndex = k
        --log.r("ShowBingoOrJackpot  "..k)
        if v.jackpot == 0 then
            local bingoType,currType = GetBingoCount(mIndex,v.bingo)
            local bingoCount = v.bingo
            if bingoCount > 0 and bingoCount < 4 then
                LuaTimer:SetDelayFunction(1, function()
                    self:PlayBingoAudio(bingoCount)
                end)
                LuaTimer:SetDelayFunction(1.5, function()
                    local anima_name = self:GetBingoAnimaName(v.bingo)
                    Event.Brocast(EventName.Box_Bingo_Coins, v.bingo)
                    this:BingoEffect(mIndex, anima_name, v.first_num, mIndex, bingoType,currType)
                end)
            end
        else
            LuaTimer:SetDelayFunction(1, function()
                self:PlayBingoAudio(4)
            end)
            LuaTimer:SetDelayFunction(1.5, function()
                Event.Brocast(EventName.Box_Bingo_Coins, 0)
                this:JackpotEffect(mIndex, "jackpot", v.first_num, mIndex)
            end)
        end
    end
end

local function GetBingoEffectName(bingoCount)
    return "HawaiiBingo"..bingoCount
end

local function SetBingoShow(bowlTypes, obj)
    local refCom = fun.get_component(obj, fun.REFER)
    if refCom then
        for i = 1, #bowlTypes do
            local o = refCom:Get(i .. bowlTypes[i])
            fun.set_active(o, true)
        end
    end
end

function HawaiiBingoEffect:PlayBingoAudio(bingoCount)
    if bingoCount == 1 then
        UISound.play("hawaii_bingo")
    elseif bingoCount == 2 then
        UISound.play("hawaii_doubleBingo")
    elseif bingoCount == 3 then
        UISound.play("hawaii_tripleBingo")
    elseif bingoCount == 4 then
        UISound.play("hawaii_jackpot")
    end
end

---@see  显示Bingo 特效
function HawaiiBingoEffect:BingoEffect(mapindex, anima_name, cellIndex, cardid, bingoType,currType)
    local par = this.cardView:GetCardMap(mapindex)
    if fun.is_null(par) then
        return
    end
    
    local pos = par.transform.position
    --local  bingoType,currType = GetBingoCount(mapindex)
    --BattleEffectCache:GetPrefabFromCache(GetBingoEffectName(#bingoType), par, function(eff1)
    --    if eff1 then
    --        eff1.gameObject:SetActive(false)
    --        UISound.play("bingo_firework")
    --        fun.set_gameobject_pos(eff1, pos.x, pos.y, pos.z, false)
    --        eff1.gameObject:SetActive(true)
    --        SetBingoShow(bingoType, eff1)
    --        self:ChangeSignCellColor(mapindex,currType)
    --        local anima = fun.get_component(eff1,fun.ANIMATOR)
    --        anima:Play(anima_name)
    --
    --        local cell_obj_pos = this.cardView:GetCardCell(mapindex,13)
    --        if cell_obj_pos then
    --            if ModelList.TournamentModel:CheckOpenTournament() then
    --                this:GetCardView():GetParentView():ShowIconFlyEffect(mapindex, cell_obj_pos.transform.position)
    --            else
    --                this:GetCardView():GetParentView():ShowCoinFlyEffect(mapindex, cell_obj_pos.transform.position)
    --            end
    --        end
    --        Destroy(eff1,3)
    --    else
    --        log.r("hangup_bingo  null")
    --    end
    --    --Event.Brocast(EventName.Event_SwitchCard_BingoEffect,mapindex)
    --    self:ShowEffectOnSmallCard(eff1,mapindex,0)
    --end,cardid)

    BattleEffectCache:GetPrefabFromPoolOrCache(GetBingoEffectName(#bingoType), par, function(eff1)
        if eff1 then
            eff1.gameObject:SetActive(false)
            UISound.play("bingo_firework")
            fun.set_gameobject_pos(eff1, pos.x, pos.y, pos.z, false)
            eff1.gameObject:SetActive(true)
            SetBingoShow(bingoType, eff1)
            self:ChangeSignCellColor(mapindex,currType)
            local anima = fun.get_component(eff1,fun.ANIMATOR)
            if anima then anima:Play(anima_name) end
            local cell_obj_pos = this.cardView:GetCardCell(mapindex,13)
            if cell_obj_pos then
                if ModelList.TournamentModel:CheckOpenTournament() then
                    this:GetCardView():GetParentView():ShowIconFlyEffect(mapindex, cell_obj_pos.transform.position)
                else
                    this:GetCardView():GetParentView():ShowCoinFlyEffect(mapindex, cell_obj_pos.transform.position)
                end
            end
            BattleEffectPool:DelayRecycle(GetBingoEffectName(#bingoType), eff1, 3)
            --Destroy(eff1,3)
        else
            log.r("hangup_bingo  null")
        end
        --Event.Brocast(EventName.Event_SwitchCard_BingoEffect,mapindex)
        self:ShowEffectOnSmallCard(eff1,mapindex,0)
    end,cardid)
end

---@see  显示Jackpot 特效
function HawaiiBingoEffect:JackpotEffect(mapindex,anima_name,cellIndex, cardid)
    ModelList.BattleModel:GetCurrBattleView():GetCardView():GetCard(cardid):ForbidCollider()
    --if not this:GetCardView():GetParentView():IsCardShowing(tonumber(cardid) ) then return end
    local par = this.cardView:GetCardMap(mapindex)
    local pos = par.transform.position
    local  bingoType,currType = GetBingoCount(mapindex,4)
    if #bingoType == 0 then return end
    BattleEffectCache:GetPrefabFromCache("HawaiiJackpot",par,function(eff1)
        if eff1 then
            eff1.gameObject.name = "HawaiiJackpot"
            eff1.gameObject:SetActive(false)
            UISound.play("bingo_firework")
            fun.set_gameobject_pos(eff1,pos.x,pos.y,pos.z,false)
            fun.set_parent(eff1,par,true)
            eff1.gameObject:SetActive(true)
            SetBingoShow(bingoType,eff1)
            self:ChangeSignCellColor(mapindex,currType)
            local anima = fun.get_component(eff1,fun.ANIMATOR)
            anima:Play(anima_name)

            local cell_obj_pos = this.cardView:GetCardCell(mapindex,13)
            if cell_obj_pos then
                if ModelList.TournamentModel:CheckOpenTournament() then
                    this:GetCardView():GetParentView():ShowIconFlyEffect(mapindex, cell_obj_pos.transform.position)
                else
                    this:GetCardView():GetParentView():ShowCoinFlyEffect(mapindex, cell_obj_pos.transform.position)
                end
            end
        else
            log.r("hangup_bingo  null")
        end
        Event.Brocast(EventName.Event_SwitchCard_JackpotEffect,mapindex)
        self:ShowEffectOnSmallCard(eff1,mapindex,2)
    end,cardid,2)
end

--- 在卡牌缩略图上显示bingo  jackpot效果
function HawaiiBingoEffect:ShowEffectOnSmallCard(clone,cardId,effectType)
    if ModelList.BattleModel:IsRocket() then return end
    local isShowing = BattleLogic.GetLogicModule(LogicName.SwitchLogic):IsShowing(cardId)
    local obj =  self.cardView:GetParentView():GetSwitchView():GetSmallCardObj(cardId)
    local newEffect = fun.get_instance(clone,obj)
    fun.set_parent(newEffect,obj,true)
    fun.set_gameobject_scale(newEffect,0.2,0.2,1)
    if isShowing then fun.set_active(newEffect,false) end
    if effectType == 0 then
        Event.Brocast(EventName.Event_Show_SwitchView_Small_Card_Bingo,cardId,newEffect)
        --self.cardView:GetParentView():GetSwitchView():StorageSwitchEffect(0,newEffect,cardId)
    else
        Event.Brocast(EventName.Event_Show_SwitchView_Small_Card_Jackpot,cardId,newEffect)

        --self.cardView:GetParentView():GetSwitchView():StorageSwitchEffect(1,newEffect,cardId)
    end
end


--- 同道具的格子要变色
function HawaiiBingoEffect:ChangeSignCellColor(cardId,bowlType)
    local cells = BattleLogic.GetLogicModule(LogicName.Card_logic):GetCellsByMaterialType(cardId,bowlType)
    for i = 1, #cells do
        local effectList =  self.cardView:GetCellBgEffect(cardId,cells[i])
        if effectList then
            for m = 1, #effectList do
                local an = fun.get_component(effectList[m],fun.ANIMATOR)
                if an then
                    an:Play("change")
                end
            end
        end
    end
end

return this