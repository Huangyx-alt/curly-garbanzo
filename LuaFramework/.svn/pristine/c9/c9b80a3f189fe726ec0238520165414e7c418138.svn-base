---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/3/28 17:06
---  天降奇遇界面

require "View/Popup/AdventureCupView"

require "State/AdventureView/BaseAdventureState"
require "State/AdventureView/AdventureOriginalState"
require "State/AdventureView/AdventureEnterState"
require "State/AdventureView/AdventureShakeState"
require "State/AdventureView/AdventurePickState"
require "State/AdventureView/AdventurePickWaitState"
require "State/AdventureView/AdventureDrawCupState"
require "State/AdventureView/AdventureCollectState"
require "State/AdventureView/AdventureDrawCupExitState"

AdventureView = BaseView:New("AdventureView","AdventureAtlas")
local this = AdventureView
this.viewType = CanvasSortingOrderManager.LayerType.TopConsole
this.isCleanRes = true

local cup_instance_cache = nil

local curDrawCup = nil

this.auto_bind_ui_items = {
    "anima",
    "reward_item1",
    "reward_item2",
    "reward_item3",
    "btn_start",
    "tip1",
    "tip2",
    "tip3",
    "tip4",
    "background"
}
    
function AdventureView:Awake()
    self:on_init()
end

function AdventureView:OnEnable()
    Facade.RegisterView(self)
    self:InitAdventureCup() 
    self:BuildFsm()
    self._fsm:GetCurState():DoEnter(self._fsm) 

    UISound.play("rewardsky_appear")
end

function AdventureView:OnDisable()
    Facade.RemoveView(self)
    cup_instance_cache = nil
    curDrawCup = nil

    Event.Brocast(EventName.Event_popup_rofy_finish)
end

function AdventureView:BuildFsm()
    self:DisposeFsm()
    self._fsm = Fsm.CreateFsm("AdventureView",self,{
        AdventureOriginalState:New(),
        AdventureEnterState:New(),
        AdventureShakeState:New(),
        AdventurePickState:New(),
        AdventurePickWaitState:New(),
        AdventureDrawCupState:New(),
        AdventureCollectState:New(),
        AdventureDrawCupExitState:New(),
    })
    self._fsm:StartFsm("AdventureOriginalState")
end

function AdventureView:DisposeFsm()
    if self._fsm then
        self._fsm:Dispose()
        self._fsm = nil
    end
end

function AdventureView:InitAdventureCup()
    self._rofyid = ModelList.RofyModel:GetRofyId()
    local rofyData = Csv.GetData("reward_sky",self._rofyid)
    if rofyData then
        local num = 0
        for key, value in pairs(rofyData.reward_exhibit) do
            if value[1] == rofyData.reward[1]  then
                num = value[2]
            end
        end
        cup_instance_cache = {}
        local cup = AdventureCupView:New(1,rofyData.reward_exhibit[1],rofyData.reward_icon[1],rofyData.reward[1],num)
        cup:SkipLoadShow(self.reward_item1)
        table.insert(cup_instance_cache,cup)
        cup = AdventureCupView:New(2,rofyData.reward_exhibit[2],rofyData.reward_icon[2],rofyData.reward[1],num)
        cup:SkipLoadShow(self.reward_item2)
        table.insert(cup_instance_cache,cup)
        cup = AdventureCupView:New(3,rofyData.reward_exhibit[3],rofyData.reward_icon[3],rofyData.reward[1],num)
        cup:SkipLoadShow(self.reward_item3)
        table.insert(cup_instance_cache,cup)
    end
end

function AdventureView:PlayEnter()
    AnimatorPlayHelper.Play(self.anima,"Adventure_enter",false,0.8,function()
            cup_instance_cache[1]:ShowRibbon(true)
            cup_instance_cache[2]:ShowRibbon(true)
            cup_instance_cache[3]:ShowRibbon(true)
        end,function()
        self._fsm:GetCurState():DoActionEnd(self._fsm)
    end)
end

function AdventureView:PlayShake()
    cup_instance_cache[1]:ShowRibbon(false)
    cup_instance_cache[2]:ShowRibbon(false)
    cup_instance_cache[3]:ShowRibbon(false)
    AnimatorPlayHelper.SetAnimationEvent(self.anima,{"Adventure_enterunlockidle","Adventure_enterunlockidle"},function()
        UISound.play("rewardsky_standby")
    end,0.1,true)
    AnimatorPlayHelper.Play(self.anima,"Adventure_enterunlock",false,function()
        self._fsm:GetCurState():DoActionEnd(self._fsm)   
    end)
    UISound.play("rewardsky_exchange")
end

function AdventureView:PlayDraw1Cup()
    AnimatorPlayHelper.Play(self.anima,"Adventure_showLeft",false,function()
        self._fsm:GetCurState():DoActionEnd(self._fsm)
    end)
    UISound.play("rewardsky_open")
end

function AdventureView:PlayDraw2Cup()
    AnimatorPlayHelper.Play(self.anima,"Adventure_showMid",false,function()
        self._fsm:GetCurState():DoActionEnd(self._fsm) 
    end)
    UISound.play("rewardsky_open")
end

function AdventureView:PlayDraw3Cup()
    AnimatorPlayHelper.Play(self.anima,"Adventure_showRight",false,function()
        self._fsm:GetCurState():DoActionEnd(self._fsm)    
    end)
    UISound.play("rewardsky_open")
end

function AdventureView:PlayDraw1CupExit()
    AnimatorPlayHelper.Play(self.anima,"Adventure_showLeftexit",false,function()
        self._fsm:GetCurState():DoActionEnd(self._fsm) 
    end)
end

function AdventureView:PlayDraw2CupExit()
    AnimatorPlayHelper.Play(self.anima,"Adventure_showMidexit",false,function()
        self._fsm:GetCurState():DoActionEnd(self._fsm) 
    end)
end

function AdventureView:PlayDraw3CupExit()
    AnimatorPlayHelper.Play(self.anima,"Adventure_showRightexit",false,function()
        self._fsm:GetCurState():DoActionEnd(self._fsm) 
    end)
end

function AdventureView:PlayDrawCup(params)
    curDrawCup = params
    if params == 1 then
        cup_instance_cache[1]:ChangeIcon()
        self:PlayDraw1Cup()
    elseif params == 2 then
        cup_instance_cache[2]:ChangeIcon()
        self:PlayDraw2Cup()
    elseif params == 3 then
        cup_instance_cache[3]:ChangeIcon()
        self:PlayDraw3Cup()
    end
    local coupon = ModelList.CouponModel.get_theLatestCoupon()
    if coupon then
        local des = Csv.GetData("coupon", coupon.id,"description_skyreward")
        local des_text = Csv.GetData("description",des,"description")
        self.tip3.text = des_text
    end
end

function AdventureView:PlayDrawCupExit()
    if curDrawCup == 1 then
        self:PlayDraw1CupExit()
    elseif curDrawCup == 2 then
        self:PlayDraw2CupExit()
    elseif curDrawCup == 3 then
        self:PlayDraw3CupExit()
    end
end

function AdventureView:CheckPlayCardNum(callback)
    local previousPlayInfo = ModelList.CityModel:GetPreviousPlayInfo()
    ModelList.CityModel:CalculatePlayCardBaseCost()
    local cost = 0
    local resourceValue = ModelList.ItemModel.getResourceNumByType(Resource.coin)
    local playCards = nil
    if previousPlayInfo then
        playCards = previousPlayInfo.cardNum
        cost = ModelList.CityModel:CheckPlayCardRealCost(playCards,nil)
    else
        local gameMode = ModelList.CityModel:GetEnterGameMode()
        if gameMode ~= PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
            playCards = CardGenre.fourcard
            cost = ModelList.CityModel:CheckPlayCardRealCost(CardGenre.fourcard,nil)
        else
            playCards = CardGenre.fourcard
            cost = ModelList.CityModel:CheckPlayCardRealCost(CardGenre.onecard,nil)
        end
    end
    if resourceValue >= cost then
        --PowerUpView:SetEnterCallback(callback)
        this:SetPowerupCallBack(callback)
        ModelList.CityModel:SetCardNumber(playCards)
        Facade.SendNotification(NotifyName.HallCity.ShowPowerUpView,nil,nil,true,true)
    else
        callback()
        Facade.SendNotification(NotifyName.ShopView.CheckCurrencyAvailable,8008,Resource.coin,cost,function()

        end,nil,nil,SHOP_TYPE.SHOP_TYPE_CHIPS,nil)
    end
end

function AdventureView:ExitAdventure()
    local rofyData = Csv.GetData("reward_sky",self._rofyid,"reward")
    local coupon = Csv.GetData("coupon",rofyData[1],"new_coupon_type")
    --local couponCount = coupon[1] + (coupon[2] or 0)
    if coupon[1] == CouponType.discount_2gear or coupon[1] == CouponType.discount_3gear then
        ModelList.GuideModel:IgnoreUIOpen("HallMainView")
    end

    if coupon[1] == CouponType.discount_4card then
        fun.set_active(self.background.transform,false,false)

        local cup = cup_instance_cache[curDrawCup]
        local path = {}
        local start_position = cup:GetPosition()
        local endPos = GetPlayCardsPos(CardGenre.fourcard)
        path[1] = fun.calc_new_position_between(start_position, endPos, 0.2 , -1, 0)
        path[2] = endPos
        cup:HideNumText()
        Anim.scale_to_xy(cup:GetItemGameObject(),0.8,0.8,0.5)
        Anim.bezier_move(cup:GetItemGameObject(),path,0.5,0,1, 3,function()
            Facade.SendNotification(NotifyName.CloseUI, self)
            Facade.SendNotification(NotifyName.HallMainView.RefreshCouponInfo, coupon[1])

            local cardGo = GetPlayCardsGo(CardGenre.fourcard)
            HomeEffectCache:GetPrefabFromCache("DaojubaodianGet", cardGo, false, nil, 1)
        end)
        UISound.play("rewardsky_reward")
    elseif coupon[1] == CouponType.discount_2gear then
        local callback = function(flag)
            fun.set_active(self.background.transform,false,false)

            local cup = cup_instance_cache[curDrawCup]
            local path = {}
            local start_position = cup:GetPosition()
            -- local endPos = GetPowerupGearPos(BuyPowerCardGenre.twogear)

            local endPos =  nil
            flag = flag ==nil and 1 or flag;
               
            if flag == 1 then 
                endPos =  GetPowerupGearPos(BuyPowerCardGenre.twogear)
            elseif flag == 2 then 
                endPos =  GetPowerupGearPos2(BuyPowerCardGenre.twogear)
            elseif flag == 3 then 
                endPos =  GetPowerupGearPos3(BuyPowerCardGenre.twogear)
            elseif flag == 4 then 
                endPos =  GetPowerupGearPos4(BuyPowerCardGenre.twogear)
            else
                endPos =  GetPowerupGearPos(BuyPowerCardGenre.twogear)
            end 

            path[1] = fun.calc_new_position_between(start_position, endPos, 0.2 , -1, 0)
            path[2] = endPos
            cup:HideNumText()
            Anim.scale_to_xy(cup:GetItemGameObject(),0.8,0.8,0.5)
            Anim.bezier_move(cup:GetItemGameObject(),path,0.5,0,1, 3,function()
                Facade.SendNotification(NotifyName.CloseUI,self)
                Facade.SendNotification(NotifyName.HallMainView.RefreshCouponInfo,coupon[1])

               -- local cardGo = GetPowerupGearGo(BuyPowerCardGenre.twogear)
                
                local cardGo = nil 
                
                if flag == 1 then 
                    cardGo =   GetPowerupGearGo(BuyPowerCardGenre.twogear)
                elseif flag == 2 then 
                    cardGo =  GetPowerupGearGo2(BuyPowerCardGenre.twogear)
                elseif flag == 3 then 
                    cardGo =  GetPowerupGearGo3(BuyPowerCardGenre.twogear)
                elseif flag == 4 then 
                    cardGo = GetPowerupGearGo4(BuyPowerCardGenre.twogear)
                else
                    cardGo =  GetPowerupGearGo(BuyPowerCardGenre.twogear)
                end 

                HomeEffectCache:GetPrefabFromCache("DaojubaodianGet",cardGo,false,nil,1)
                --PowerUpView:on_btn_close_click()
                --PowerUpView:CheckDiscountAutoBuy()
                this:SetCheckDiscountAutoBuy()
            end)
            UISound.play("rewardsky_reward")
        end
        self:CheckPlayCardNum(callback)
    elseif coupon[1] == CouponType.discount_3gear then

        

        local callback = function(flag)
            fun.set_active(self.background.transform,false,false)
            local endPos =  nil--GetPowerupGearPos(BuyPowerCardGenre.threegear)
            flag = flag ==nil and 1 or flag;
               
            if flag == 1 then 
                endPos =  GetPowerupGearPos(BuyPowerCardGenre.threegear)
            elseif flag == 2 then 
                endPos =  GetPowerupGearPos2(BuyPowerCardGenre.threegear)
            elseif flag == 3 then 
                endPos =  GetPowerupGearPos3(BuyPowerCardGenre.threegear)
            elseif flag == 4 then 
                endPos =  GetPowerupGearPos4(BuyPowerCardGenre.threegear)
            else
                endPos =  GetPowerupGearPos(BuyPowerCardGenre.threegear)
            end 

            local cup = cup_instance_cache[curDrawCup]
            local path = {}
            local start_position = cup:GetPosition()
           
            path[1] = fun.calc_new_position_between(start_position, endPos, 0.2 , -1, 0)
            path[2] = endPos
            cup:HideNumText()
            Anim.scale_to_xy(cup:GetItemGameObject(),0.8,0.8,0.5)
            Anim.bezier_move(cup:GetItemGameObject(),path,0.5,0,1, 3,function()
                Facade.SendNotification(NotifyName.CloseUI,self)
                Facade.SendNotification(NotifyName.HallMainView.RefreshCouponInfo,coupon[1])

                local cardGo = nil 
                
                if flag == 1 then 
                    cardGo =   GetPowerupGearGo(BuyPowerCardGenre.threegear)
                elseif flag == 2 then 
                    cardGo =  GetPowerupGearGo2(BuyPowerCardGenre.threegear)
                elseif flag == 3 then 
                    cardGo =  GetPowerupGearGo3(BuyPowerCardGenre.threegear)
                elseif flag == 4 then 
                    cardGo = GetPowerupGearGo4(BuyPowerCardGenre.threegear)
                else
                    cardGo =  GetPowerupGearGo(BuyPowerCardGenre.threegear)
                end 
                
                HomeEffectCache:GetPrefabFromCache("DaojubaodianGet",cardGo,false,nil,1)
                --PowerUpView:on_btn_close_click()
                --PowerUpView:CheckDiscountAutoBuy()
                this:SetCheckDiscountAutoBuy()
            end)
            UISound.play("rewardsky_reward")
        end
        self:CheckPlayCardNum(callback)

    elseif coupon[1] == CouponType.discount_4gear then



        local callback = function(flag)
            fun.set_active(self.background.transform,false,false)
            local endPos =  nil--GetPowerupGearPos(BuyPowerCardGenre.threegear)
            flag = flag ==nil and 1 or flag;

            if flag == 1 then
                endPos =  GetPowerupGearPos(BuyPowerCardGenre.threegearplus)
            elseif flag == 2 then
                endPos =  GetPowerupGearPos2(BuyPowerCardGenre.threegearplus)
            elseif flag == 3 then
                endPos =  GetPowerupGearPos3(BuyPowerCardGenre.threegearplus)
            elseif flag == 4 then
                endPos =  GetPowerupGearPos4(BuyPowerCardGenre.threegearplus)
            else
                endPos =  GetPowerupGearPos(BuyPowerCardGenre.threegearplus)
            end

            local cup = cup_instance_cache[curDrawCup]
            local path = {}
            local start_position = cup:GetPosition()

            path[1] = fun.calc_new_position_between(start_position, endPos, 0.2 , -1, 0)
            path[2] = endPos
            cup:HideNumText()
            Anim.scale_to_xy(cup:GetItemGameObject(),0.8,0.8,0.5)
            Anim.bezier_move(cup:GetItemGameObject(),path,0.5,0,1, 3,function()
                Facade.SendNotification(NotifyName.CloseUI,self)
                Facade.SendNotification(NotifyName.HallMainView.RefreshCouponInfo,coupon[1])

                local cardGo = nil

                if flag == 1 then
                    cardGo =   GetPowerupGearGo(BuyPowerCardGenre.threegearplus)
                elseif flag == 2 then
                    cardGo =  GetPowerupGearGo2(BuyPowerCardGenre.threegearplus)
                elseif flag == 3 then
                    cardGo =  GetPowerupGearGo3(BuyPowerCardGenre.threegearplus)
                elseif flag == 4 then
                    cardGo = GetPowerupGearGo4(BuyPowerCardGenre.threegearplus)
                else
                    cardGo =  GetPowerupGearGo(BuyPowerCardGenre.threegearplus)
                end

                HomeEffectCache:GetPrefabFromCache("DaojubaodianGet",cardGo,false,nil,1)
                --PowerUpView:on_btn_close_click()
                --PowerUpView:CheckDiscountAutoBuy()
                this:SetCheckDiscountAutoBuy()
            end)
            UISound.play("rewardsky_reward")
        end
        self:CheckPlayCardNum(callback)
    elseif coupon[1] == CouponType.discount_2card and coupon[2] == CouponType.discount_4card then
        fun.set_active(self.background.transform,false,false)
    
        local cup = cup_instance_cache[curDrawCup]
        local path = {}
        local start_position = cup:GetPosition()
        local endPos = GetPlayCardsPos(CardGenre.twocard)
        local item_go = fun.get_instance(cup:GetItemGameObject().transform,cup:GetItemParent().gameObject)
        path[1] = fun.calc_new_position_between(start_position, endPos, 0.2 , -1, 0)
        path[2] = endPos
        cup:HideNumText()
        Anim.scale_to_xy(item_go,0.8,0.8,0.5)
        Anim.bezier_move(item_go,path,0.5,0,1, 3,function()
            local cardGo = GetPlayCardsGo(CardGenre.twocard)
            HomeEffectCache:GetPrefabFromCache("DaojubaodianGet",cardGo,false,nil,1)
        end)
        UISound.play("rewardsky_reward")

        endPos = GetPlayCardsPos(CardGenre.fourcard)
        path[1] = fun.calc_new_position_between(start_position, endPos, 0.2 , -1, 0)
        path[2] = endPos
        Anim.scale_to_xy(cup:GetItemGameObject(),0.8,0.8,0.5)
        Anim.bezier_move(cup:GetItemGameObject(),path,0.5,0,1, 3,function()
            Facade.SendNotification(NotifyName.CloseUI,self)
            Facade.SendNotification(NotifyName.HallMainView.RefreshCouponInfo,coupon[1] + coupon[2])

            local cardGo = GetPlayCardsGo(CardGenre.fourcard)
            HomeEffectCache:GetPrefabFromCache("DaojubaodianGet",cardGo,false,nil,1)
        end)
        UISound.play("rewardsky_reward")
    elseif coupon[1] == CouponType.discount_8card and coupon[2] == CouponType.discount_12card then
        fun.set_active(self.background.transform,false,false)
    
        local cup = cup_instance_cache[curDrawCup]
        local path = {}
        local start_position = cup:GetPosition()
        local endPos = GetAutoPlayCardsPos(CardGenre.eightcard)
        local item_go = fun.get_instance(cup:GetItemGameObject().transform,cup:GetItemParent().gameObject)
        path[1] = fun.calc_new_position_between(start_position, endPos, 0.2 , -1, 0)
        path[2] = endPos
        cup:HideNumText()
        Anim.scale_to_xy(item_go,0.8,0.8,0.5)
        Anim.bezier_move(item_go,path,0.5,0,1, 3,function()
            local cardGo = GetAutoPlayCardsGo(CardGenre.eightcard)
            HomeEffectCache:GetPrefabFromCache("DaojubaodianGet",cardGo,false,nil,1)
        end)
        UISound.play("rewardsky_reward")

        endPos = GetAutoPlayCardsPos(CardGenre.twelvecard)
        path[1] = fun.calc_new_position_between(start_position, endPos, 0.2 , -1, 0)
        path[2] = endPos
        Anim.scale_to_xy(cup:GetItemGameObject(),0.8,0.8,0.5)
        Anim.bezier_move(cup:GetItemGameObject(),path,0.5,0,1, 3,function()
            Facade.SendNotification(NotifyName.CloseUI,self)
            Facade.SendNotification(NotifyName.HallMainView.RefreshCouponInfo,coupon[1] + coupon[2])

            local cardGo = GetAutoPlayCardsGo(CardGenre.twelvecard)
            HomeEffectCache:GetPrefabFromCache("DaojubaodianGet",cardGo,false,nil,1)
        end)
        UISound.play("rewardsky_reward")

    elseif coupon[1] == CouponType.discount_jackpot then
        Facade.SendNotification(NotifyName.ShowUI,ViewList.LuckyJeckpotView,function()
            Facade.SendNotification(NotifyName.CloseUI,self)
        end)   
    end
end

--- 跳转到小丑机台
function AdventureView:JumpDiscount4gear()
    local callback = function(flag)
        fun.set_active(self.background.transform,false,false)
        local endPos =  nil--GetPowerupGearPos(BuyPowerCardGenre.threegear)
        flag = flag ==nil and 1 or flag;

        if flag == 1 then
            endPos =  GetPowerupGearPos(BuyPowerCardGenre.threegearplus)
        elseif flag == 2 then
            endPos =  GetPowerupGearPos2(BuyPowerCardGenre.threegearplus)
        elseif flag == 3 then
            endPos =  GetPowerupGearPos3(BuyPowerCardGenre.threegearplus)
        elseif flag == 4 then
            endPos =  GetPowerupGearPos4(BuyPowerCardGenre.threegearplus)
        else
            endPos =  GetPowerupGearPos(BuyPowerCardGenre.threegearplus)
        end

        local cup = cup_instance_cache[curDrawCup]
        local path = {}
        local start_position = cup:GetPosition()

        path[1] = fun.calc_new_position_between(start_position, endPos, 0.2 , -1, 0)
        path[2] = endPos
        cup:HideNumText()
        Anim.scale_to_xy(cup:GetItemGameObject(),0.8,0.8,0.5)
        Anim.bezier_move(cup:GetItemGameObject(),path,0.5,0,1, 3,function()
            Facade.SendNotification(NotifyName.CloseUI,self)
            Facade.SendNotification(NotifyName.HallMainView.RefreshCouponInfo,coupon[1])

            local cardGo = nil

            if flag == 1 then
                cardGo =   GetPowerupGearGo(BuyPowerCardGenre.threegear)
            elseif flag == 2 then
                cardGo =  GetPowerupGearGo2(BuyPowerCardGenre.threegear)
            elseif flag == 3 then
                cardGo =  GetPowerupGearGo3(BuyPowerCardGenre.threegear)
            elseif flag == 4 then
                cardGo = GetPowerupGearGo4(BuyPowerCardGenre.threegear)
            else
                cardGo =  GetPowerupGearGo(BuyPowerCardGenre.threegear)
            end

            HomeEffectCache:GetPrefabFromCache("DaojubaodianGet",cardGo,false,nil,1)
            --PowerUpView:on_btn_close_click()
            --PowerUpView:CheckDiscountAutoBuy()
            this:SetCheckDiscountAutoBuy()
        end)
        UISound.play("rewardsky_reward")
    end
    self:CheckPlayCardNum(callback)
end

function AdventureView:on_btn_start_click()
    self._fsm:GetCurState():DoBtnClick(self._fsm)
end

function AdventureView.OnPick_A_DicBox(cup)
    this._fsm:GetCurState():DoPick(this._fsm,cup)
end

function AdventureView.AskServerToPickCup()
    ModelList.RofyModel:C2S_RequestOpenRofy()
end

function AdventureView:SetPowerupCallBack(callback)
    local betRate = ModelList.CityModel:GetBetRate() or 1 -- 默认倍数1
    local data = ModelList.CityModel:GetPowerUpRange()
    local playid =  ModelList.CityModel.GetPlayIdByCity()

    --当玩家开启ultra_bet活动后，全部bet下都开放小丑PU机台
    local isUltraBetOpen = ModelList.UltraBetModel:IsActivityValid()
    local isJokerOpen = ModelList.CityModel:CheckIsJokerOpen(playid)
    if isUltraBetOpen and isJokerOpen then
        PowerUpViewMaster:SetEnterCallback(callback)
        PowerUpViewMaster:SetFromAdventureFlag()
        return
    end
    
    if data[playid][1].bet[1] <= betRate and betRate <= data[playid][1].bet[2] then
        if callback then
            PowerUpView:SetEnterCallback(callback)
        end
        PowerUpView:SetFromAdventureFlag()
    elseif data[playid][2].bet[1] <= betRate and betRate <= data[playid][2].bet[2] then
        if callback then
            PowerUpViewSilver:SetEnterCallback(callback)
        end
        PowerUpViewSilver:SetFromAdventureFlag()
    elseif data[playid][3].bet[1] <= betRate and betRate <= data[playid][3].bet[2] then
        if callback then
            PowerUpViewGoldNova:SetEnterCallback(callback)
        end
        PowerUpViewGoldNova:SetFromAdventureFlag()
    elseif data[playid][4].bet[1] <= betRate and betRate <= data[playid][4].bet[2] then
        if callback then
            PowerUpViewMaster:SetEnterCallback(callback)
        end
        PowerUpViewMaster:SetFromAdventureFlag()
    end
end

function AdventureView:SetCheckDiscountAutoBuy()

    
    local betRate = ModelList.CityModel:GetBetRate() or 1 -- 默认倍数1
    local data = ModelList.CityModel:GetPowerUpRange()
    local playid =  ModelList.CityModel.GetPlayIdByCity()
   -- local isNormalFlag = Csv.CheckisNormalOrAuto(playid)
    --if isNormalFlag then 
        if data[playid][1].bet[1] <= betRate and betRate <= data[playid][1].bet[2] then 
            PowerUpView:CheckDiscountAutoBuy()
        elseif data[playid][2].bet[1] <= betRate and betRate <= data[playid][2].bet[2] then
            PowerUpViewSilver:CheckDiscountAutoBuy()
        elseif data[playid][3].bet[1] <= betRate and betRate <= data[playid][3].bet[2] then
            PowerUpViewGoldNova:CheckDiscountAutoBuy()
        elseif data[playid][4].bet[1] <= betRate and betRate <= data[playid][4].bet[2] then
            PowerUpViewMaster:CheckDiscountAutoBuy() 
        end
    -- else 
    --     PowerUpView:CheckDiscountAutoBuy()
    -- end 
end



function AdventureView.OnPick_A_DicBox_Result()
    this._fsm:GetCurState():DoPickResult(this._fsm)
end

this.NotifyList = 
{
    {notifyName = NotifyName.AdventureView.Pick_a_dice_box,func = this.OnPick_A_DicBox},
    {notifyName = NotifyName.AdventureView.Pick_a_dice_box_result,func = this.OnPick_A_DicBox_Result}
}

return this






