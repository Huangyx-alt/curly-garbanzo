---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/11/24 11:55
---

local GiftPackModel = BaseModel:New("GiftPackModel")
local this = GiftPackModel
this.giftPackInfo = {}
this.allowGift = {}
this.shownGift = {} --已经展示过的礼包
this.showingGift = nil
this.lastTriggerType = nil
this.lastCheckType = {}
this.ad_public_cd = 0
this.isLogin = false
this.isShowing = false
this.lastGiftBuyResult = nil

function GiftPackModel:InitData()
    this.ad_public_cd = Csv.GetControlByName("ad_public_cd")[1][1]
end

function GiftPackModel:SetLoginData(data)
    this:SetGiftLoginData(data.giftPackInfo)
end

function GiftPackModel:SetGiftLoginData(data)
    this.giftPackInfo = data or {}
    this.isLogin = true
    log.y('@--------Receive 推销礼包:  data content>>: ', data);
end

function GiftPackModel:CanShowGift()
    return not ModelList.GuideModel:IsGuiding()
end

--进入主程
function GiftPackModel.EnterCity()
    this.shownGift = {}
    if this:CanShowGift() then
        if this.isLogin then
            local checkType = { GiftPackTriggerType.Login, GiftPackTriggerType.City }
            this:CollectAllowGift(checkType)
            this:CheckAllowGift()
        else
            local checkType = { GiftPackTriggerType.City }
            this:CollectAllowGift(checkType)
            this:CheckAllowGift()
        end
    else
        Event.Brocast(EventName.Event_Gift_Show_Over)
    end
end

--进入主程
function GiftPackModel.EnterMain()
    this.shownGift = {}
    log.y("giftpack shownGift clear")
    if this:CanShowGift() then
        local checkType = { GiftPackTriggerType.Main }
        this:CollectAllowGift(checkType)
        this:CheckAllowGift()
    else
        Event.Brocast(EventName.Event_Gift_Show_Over)
    end
end

--登录
function GiftPackModel.EnterLogin()
    if this:CanShowGift() then
        this.shownGift = {}
        local checkType = { GiftPackTriggerType.Login }
        this:CollectAllowGift(checkType)
        this:CheckAllowGift()
    else
        Event.Brocast(EventName.Event_Gift_Show_Over)
    end
end

--
function GiftPackModel.AddShownGift(pId)
    if this.shownGift and not fun.is_include(pId, this.shownGift) then
        fun.insert_table_item(this.shownGift, pId)
        this.PrintShownGift()
    end
end

--
function GiftPackModel.RemoveShownGift(pId)
    fun.remove_table_item(this.shownGift, pId)
    this.PrintShownGift()
end

function GiftPackModel.PrintShownGift()
    local str = ""
    for i = 1, #this.shownGift do
        str = str .. "  " .. this.shownGift[i]
    end
end

--刷新数据
function GiftPackModel:RefreshData(data)
    if not data then
        return
    end
    local currTime = ModelList.PlayerInfoModel.get_cur_server_time()
    if this.giftPackInfo then
        local tempData = {}
        for k = 1, #data.packInfo do
            local contain_id = false
            for _, v in ipairs(this.giftPackInfo) do
                if data.packInfo[k].pId == v.pId then
                    v.type = data.packInfo[k].type
                    contain_id = true
                    local needRemove = true
                    for i = 1, #v.giftInfo do
                        for m = 1, #data.packInfo[k].giftInfo do
                            if v.giftInfo[i].id == data.packInfo[k].giftInfo[m].id then
                                v.giftInfo[i].expireTime = data.packInfo[k].giftInfo[m].expireTime
                                v.giftInfo[i].canBuyCount = data.packInfo[k].giftInfo[m].canBuyCount
                                if this:CanBuy(v.giftInfo[i].canBuyCount) and v.giftInfo[i].expireTime > currTime then
                                    needRemove = false
                                end
                            end
                        end
                    end
                end
            end

            if not contain_id then
                table.insert(tempData, data.packInfo[k])
            end
        end

        for i = 1, #tempData do
            local new_pack = Csv.GetData("pop_up", tempData[i].giftInfo[1].id, "gift_open")
            local hasAdd = false
            if new_pack then
                for m = 1, #this.giftPackInfo do
                    local pack = Csv.GetData("pop_up", this.giftPackInfo[m].giftInfo[1].id, "gift_open")
                    if pack and new_pack < pack then
                        table.insert(this.giftPackInfo, m, tempData[i])
                        hasAdd = true
                        break
                    end
                end
                if not hasAdd then
                    table.insert(this.giftPackInfo, tempData[i])
                end
            end
        end
    else
        this.giftPackInfo = data
    end
    this:CheckShownGift()
    this.PrintShownGift()
    Event.Brocast(EventName.Event_Gift_Update)
    log.y('@--------Receive 更新推销礼包:  data content>>: ', data);
    log.y('@--------Receive 推销礼包:  data content>>: ', this.giftPackInfo);
end

function GiftPackModel:ShowingGiftComplete()
    local currTime = ModelList.PlayerInfoModel.get_cur_server_time()
    for i = #this.giftPackInfo, 1, -1 do
        local needRemoveGift = true
        for k = 1, #this.giftPackInfo[i].giftInfo do
            if this:CanBuy(this.giftPackInfo[i].giftInfo[k].canBuyCount) and this.giftPackInfo[i].giftInfo[k].expireTime >= currTime then
                needRemoveGift = false
                break
            end
        end
        if needRemoveGift then
            log.r("移除空礼包 " .. this.giftPackInfo[i].pId)
            table.remove(this.giftPackInfo, i)
        end
    end

    if this.showingGift then
        local needClose = true
        local newestData = this:GetGiftByPid(this.showingGift.pId)
        if not newestData then
            return true
        end
        local currTime = ModelList.PlayerInfoModel.get_cur_server_time()
        for i = 1, #newestData.giftInfo do
            if newestData.giftInfo[i].expireTime > currTime and this:CanBuy(newestData.giftInfo[i].canBuyCount) then
                needClose = false
                break
            end
        end
        return needClose
    end
    return false
end

--刷新数据
function GiftPackModel:CheckCurrShow(data)
    if this.showingGift then
        if data and data.giftId == this.showingGift.pId or data and data.pId == this.showingGift.pId then
            local needClose = true
            local newestData = this:GetGiftByPid(this.showingGift.pId)
            local currTime = ModelList.PlayerInfoModel.get_cur_server_time()
            if newestData then
                for i = 1, #newestData.giftInfo do
                    if newestData.giftInfo[i].expireTime > currTime and this:CanBuy(newestData.giftInfo[i].canBuyCount) then
                        needClose = false
                        break
                    end
                end
            end
            this.view:OnBuySuccess(needClose, data)

            --if needClose then
            --    if this.view  and fun.get_active_self(this.view.go) then
            --        this.view:on_btn_close_click()
            --    end
            --else
            --    this.view:ShowDetailGift()
            --end
        end
    end
end

--检查触发的新礼包
function GiftPackModel:CheckShownGift()
    local currTime = ModelList.PlayerInfoModel.get_cur_server_time()
    for _, v in pairs(this.giftPackInfo) do
        for i = 1, #this.shownGift do
            if this.shownGift[i] == v.pId then
                local needRemove = true
                for i = 1, #v.giftInfo do
                    if v.giftInfo[i].expireTime > currTime and this:CanBuy(v.giftInfo[i].canBuyCount) then
                        needRemove = false
                        break
                    end
                end
                if needRemove then
                    this.RemoveShownGift(v.pId)
                end
            end
        end
    end
end

--检查是否为夏日礼包
function GiftPackModel:isSummerGift(pId)
    for k, v in pairs(Csv.pop_up) do
        if v.group_id == pId then
            if v.type_id[1] == 3 then
                return true
            else
                return false
            end
        end
    end

    return false
end

--检查触发的新礼包
function GiftPackModel:CheckNewGift()
    for i = 1, #this.giftPackInfo do
        if this.giftPackInfo[i].type == 1 then
            this:CheckAllowGift()
            break
        end
    end
end

function GiftPackModel:ShowGiftById(id)
    id = tonumber(id)
    local data = nil
    for i = 1, #this.giftPackInfo do
        if this.giftPackInfo[i].pId == id then
            data = this.giftPackInfo[i]
            break
        end
    end
    if data then
        this:ShowGiftPack(data, GiftPackTriggerType.City, false)
    else
        --log.r("没有礼包信息  " .. id)
    end
end

function GiftPackModel:ShowGiftPack(data, triggerType, autoOpen)
    log.y("ShowGiftPack   " .. data.pId)
    this:AddPopUpGiftCount()
    autoOpen = autoOpen or true
    this.showingGift = data
    this.lastTriggerType = triggerType
    if data.type == 1 then
        data.type = 2
    end
    local iconName = Csv.GetData("pop_up", data.giftInfo[1].id, "icon")
    this.view = nil

    local viewData = Csv.GetGiftDataByIconName(iconName)
    log.y("lxq ShowGiftPack   ", viewData)
    if (viewData == nil) then
        log.r("not found view config", iconName)
        this:CloseView()
        return
    end

    if (viewData.viewtype == "viewName") then
        if ViewList[viewData.viewname] then
            this.view = ViewList[viewData.viewname]
        else
            this.view = require("View/GiftPack/" .. viewData.viewname)
        end
    elseif (viewData.viewtype == "viewPath") then
        local view = require(viewData.viewpath)
        if (view == nil) then
            log.r("not found view lua file", iconName)
            this:CloseView()
            return
        end
        this.view = view:New()
    else
        log.r("not found view config", iconName)
        this:CloseView()
        return
    end

    if (viewData.atlas_name and viewData.atlas_name ~= "0" and string.len(viewData.atlas_name) > 0) then
        this.view.atlasName = viewData.atlas_name --添加自定义atlas
    end

    if (viewData.downloadmodulename ~= "0") then
        ModelList.BattleModel.RequireModuleLua(viewData.downloadmodulename)
    end

    if this.view == nil then
        this:CloseView()
        return
    end
    this:AddGiftViewList(this.view)
    log.r("gift pack model" .. iconName)
    this.isShowing = true
    if this.view.go then
        Facade.SendNotification(NotifyName.SkipLoadShowUI, this.view, this.view.go, nil, function (go)
            if this.view then
                this.view:ShowDetailGift()
            end
        end)
    else
        Facade.SendNotification(NotifyName.ShowUI, this.view, function (go)
            if this.view then
                this.view:ShowDetailGift()
            end
        end)
    end
    SDK.open_pop_gift("SceneHome", data.pId, autoOpen)
end

--- 记录所有打开的礼包
function GiftPackModel:AddGiftViewList(view)
    if not this.ViewList then
        this.ViewList = {}
    end
    if not fun.is_include(view, this.ViewList) then
        table.insert(this.ViewList, this.view)
    end
end

--- 检查礼包ViewList中是否有空的
function GiftPackModel:CheckGiftViewList()
    if not this.ViewList then
        return
    end
    for i = #this.ViewList, 1, -1 do
        if this.ViewList[i] == nil or not this.ViewList[i].go or fun.is_null(this.ViewList[i].go) then
            table.remove(this.ViewList, i)
            break
        end
    end
end

--- 检查礼包ViewList中是否有正在展示的
function GiftPackModel:CheckGiftViewListIsShowing()
    if not this.ViewList then
        return
    end
    for i = #this.ViewList, 1, -1 do
        if this.ViewList[i] ~= nil and this.ViewList[i].go and not fun.is_null(this.ViewList[i].go) and fun.get_active_self(this.ViewList[i].go) then
            return true
        end
    end
    return false
end

function GiftPackModel:GetGiftById(id)
    for _, v in ipairs(this.giftPackInfo) do
        for i = 1, #v.giftInfo do
            if v.giftInfo[i].id == id then
                return v.giftInfo[i]
            end
        end
    end
    return nil
end

--获取大礼包信息
function GiftPackModel:GetGiftByPid(pId)
    for _, v in ipairs(this.giftPackInfo) do
        if v.pId == pId then
            return v
        end
    end
    return nil
end

function GiftPackModel:GetOpenedGift()
    local s_time = ModelList.PlayerInfoModel.get_cur_server_time()
    local info = {}
    for _, v in ipairs(this.giftPackInfo) do
        local isOpen = false
        for i = 1, #v.giftInfo do
            if this:CanBuy(v.giftInfo[i].canBuyCount) and v.giftInfo[i].expireTime > s_time and this:CanWinzonePopShow(v.giftInfo[i].id)
                and this:IsAllowCityPlayShow(v.giftInfo[i].id) then
                isOpen = true
                break
            end

            if v.giftInfo[i].expireTime > s_time and self:IsLimitPack(v.giftInfo[i].id) then
                isOpen = true
                break
            end
        end
        if isOpen then
            table.insert(info, v)
        end
    end
    return info
end

function GiftPackModel:CanWinzonePopShow(id)
    local xls = Csv.GetData("pop_up", id)
    if xls and xls.pop_type and xls.pop_type[1] == 18 then
        return ModelList.CityModel.GetPlayIdByCity() == 17
    end
    return true
end

function GiftPackModel:IsAllowCityPlayShow(id)
    local xls = Csv.GetData("pop_up", id)
    if xls then
        local open_city_id = Csv.GetGiftDataByIconName(xls.icon)
        if open_city_id and open_city_id.city_play ~= 0 and ModelList.CityModel.GetPlayIdByCity() ~= open_city_id.city_play then
            return false
        end
    end
    return true
end

function GiftPackModel:IsAllowCityPlayShow2(iconName)
    if iconName then
        local open_city_id = Csv.GetGiftDataByIconName(iconName)
        if open_city_id and open_city_id.city_play ~= 0 and ModelList.CityModel.GetPlayIdByCity() ~= open_city_id.city_play then
            return false
        end
    end
    return true
end

function GiftPackModel:IsPackShowCD(giftId, smallId, sceneType)
    local last_time = fun.read_value("GiftPackLastShowTime" .. giftId, 0)
    local client_pop_scenel = Csv.GetData("pop_up", smallId, "client_pop_scenel")
    local cd = 60
    for i = 1, #client_pop_scenel do
        if client_pop_scenel[i][1] == sceneType then
            cd = client_pop_scenel[i][2]
            break
        end
    end
    --    --log.r("GiftPackLastShowTime"..packId.."  last_time  "..last_time.."    cd   "..cd.."   sceneType   "..sceneType)
    if ModelList.PlayerInfoModel.get_cur_server_time() - last_time > cd then
        return false
    end

    return true
end

function GiftPackModel:CheckClearCD(checkType)
    if ModelList.WinZoneModel:GetCurRound() == 1 then
        if checkType and #checkType > 0 then
            if checkType[1] == GiftPackTriggerType.Main then
                local last_time = fun.read_value("GiftPackWinZoneLastId" .. ModelList.WinZoneModel:GetLastPlayTime(), 0)
                if last_time == 0 then
                    self:ClearWinZoneCD()
                end
            end
        end
    end
end

--- 清理所有杯赛礼包展示CD (杯赛礼包、赛车礼包)
function GiftPackModel:ClearCupCompetionCD()
    ---遍历Csv.pop_up
    for k, v in pairs(Csv.pop_up) do
        ---如果是杯赛礼包或者赛车礼包
        if v.pop_type[1] == 12 or v.pop_type[1] == 17 then
            ---清理CD
            fun.save_value("GiftPackLastShowTime" .. v.id, 0)
        end
    end
end

function GiftPackModel:SavePackShowTime(pId)
    local server_time = ModelList.PlayerInfoModel.get_cur_server_time()
    fun.save_value("GiftPackLastShowTime" .. pId, server_time)
end

function GiftPackModel:GetShowGiftPack()
    return this.showingGift
end

function GiftPackModel:GetCompetitionPack()
    if this.giftPackInfo then
        for i = 1, #this.giftPackInfo do
            local id = this.giftPackInfo[i].giftInfo[1].id
            local xls = Csv.GetData("pop_up", id)
            if xls and xls.pop_type then
                for k = 1, #xls.pop_type do
                    if xls.pop_type[k] == 12 then
                        return this.giftPackInfo[i]
                    end
                end
            end
        end
    end
    return nil
end

function GiftPackModel:ShowCompetitionPack()
    local data = nil
    for i = 1, #this.giftPackInfo do
        local xls = Csv.GetData("pop_up", this.giftPackInfo[i].giftInfo[1].id)
        for k = 1, #xls.pop_type do
            if xls.pop_type[k] == 12 then
                data = this.giftPackInfo[i]
                break
            end
        end
        if data then
            break
        end
    end
    if data then
        this:ShowGiftPack(data, GiftPackTriggerType.City, false)
    else
        --log.r("没有礼包信息  " .. id)
    end
end

function GiftPackModel:ShowEasterBuffPack()
    local data = nil
    for i = 1, #this.giftPackInfo do
        local xls = Csv.GetData("pop_up", this.giftPackInfo[i].giftInfo[1].id)
        --xls = Csv.GetData("pop_up",  490101)
        if xls.icon == "cEntEasterSaleCoin" then
            data = this.giftPackInfo[i]
            break
        end
    end
    if data then
        log.log("GiftPackModel:ShowEasterBuffPack() data is ", data)
        this:ShowGiftPack(data, GiftPackTriggerType.City, false)
    else
        log.log("GiftPackModel:ShowEasterBuffPack() 没有礼包信息", this.giftPackInfo)
        --log.r("没有礼包信息  " .. id)
    end
end

---开启杯赛后，第一次获得饼干进度后，重置日榜礼包CD
function GiftPackModel:ResetCompetitionGiftCD()
    if this.allowGift and #this.allowGift > 0 then
        local competitionGift = this:GetCompetitionPack()
        if competitionGift then
            fun.save_value("GiftPackLastShowTime" .. competitionGift.pId, 0)
        end
    end
end

--------------赛车礼包-----------------------------------------------------------------

function GiftPackModel:GetQuestPack()
    if this.giftPackInfo then
        for i = 1, #this.giftPackInfo do
            local id = this.giftPackInfo[i].giftInfo[1].id
            local xls = Csv.GetData("pop_up", id)
            if xls and xls.pop_type then
                for k = 1, #xls.pop_type do
                    if xls.pop_type[k] == 17 then
                        return this.giftPackInfo[i]
                    end
                end
            end
        end
    end
    return nil
end

function GiftPackModel:ShowQuestPack()
    local data = nil
    for i = 1, #this.giftPackInfo do
        local xls = Csv.GetData("pop_up", this.giftPackInfo[i].giftInfo[1].id)
        if xls then
            for k = 1, #xls.pop_type do
                if xls.pop_type[k] == 17 then
                    data = this.giftPackInfo[i]
                    break
                end
            end
        end
        if data then
            break
        end
    end
    if data then
        this:ShowGiftPack(data, GiftPackTriggerType.City, false)
    end
end

function GiftPackModel:RemoveQuestPack()
    for i = 1, #this.giftPackInfo do
        local xls = Csv.GetData("pop_up", this.giftPackInfo[i].giftInfo[1].id)
        if xls then
            local check
            for k = 1, #xls.pop_type do
                if xls.pop_type[k] == 17 then
                    table.remove(this.giftPackInfo, i)
                    check = true
                    break
                end
            end
            if check then
                break
            end
        end
    end

    Event.Brocast(EventName.Event_Gift_Update)
end

----------------------------------------------------------------------------------------


--------------Winzone礼包-----------------------------------------------------------------
function GiftPackModel:GetWinzonePack()
    if this.giftPackInfo then
        for i = 1, #this.giftPackInfo do
            local id = this.giftPackInfo[i].giftInfo[1].id
            local xls = Csv.GetData("pop_up", id)
            if xls and xls.pop_type then
                for k = 1, #xls.pop_type do
                    if xls.pop_type[k] == 18 and this.giftPackInfo[i] and #this.giftPackInfo[i].giftInfo == 2 then
                        return this.giftPackInfo[i]
                    end
                end
            end
        end
    end
    return nil
end

function GiftPackModel:RemoveWinzonePack()
    for i = 1, #this.giftPackInfo do
        local xls = Csv.GetData("pop_up", this.giftPackInfo[i].giftInfo[1].id)
        if xls then
            local check
            for k = 1, #xls.pop_type do
                if xls.pop_type[k] == 18 then
                    table.remove(this.giftPackInfo, i)
                    check = true
                    break
                end
            end
            if check then
                break
            end
        end
    end
    Event.Brocast(EventName.Event_Gift_Update)
end

--- 清理所有Winzone礼包展示CD
function GiftPackModel:ClearWinZoneCD()
    for k, v in pairs(Csv.pop_up) do
        ---如果是杯赛礼包或者赛车礼包
        if v.pop_type[1] == 18 then
            ---清理CD
            fun.save_value("GiftPackLastShowTime" .. v.id, 0)
        end
    end
end

----------------------------------------------------------------------------------------


--------------火山活动礼包-----------------------------------------------------------------

--是否有免费礼包可以购买
function GiftPackModel:CheckVolcanoMissionHaveFreePack()
    local ret = false

    local data = this:GetVolcanoMissionPack()
    if data and data.giftInfo then
        table.each(data.giftInfo, function (v, k)
            if v.canBuyCount > 0 then
                local popCfg = Csv.GetData("pop_up", v.id)
                if popCfg.price == "0" then
                    ret = true
                end
            end
        end)
    end

    return ret
end

function GiftPackModel:GetVolcanoMissionPack()
    if this.giftPackInfo then
        for i = 1, #this.giftPackInfo do
            local id = this.giftPackInfo[i].giftInfo[1].id
            local xls = Csv.GetData("pop_up", id)
            if xls and xls.pop_type then
                for k = 1, #xls.pop_type do
                    if xls.pop_type[k] == 19 then
                        return this.giftPackInfo[i]
                    end
                end
            end
        end
    end
    return nil
end

function GiftPackModel:ShowVolcanoMissionPack()
    local data = nil
    for i = 1, #this.giftPackInfo do
        local xls = Csv.GetData("pop_up", this.giftPackInfo[i].giftInfo[1].id)
        if xls then
            for k = 1, #xls.pop_type do
                if xls.pop_type[k] == 19 then
                    data = this.giftPackInfo[i]
                    break
                end
            end
        end
        if data then
            break
        end
    end
    if data then
        this:ShowGiftPack(data, GiftPackTriggerType.City, false)
        return true
    end
    return false
end

function GiftPackModel:RemoveVolcanoMissionPack()
    for i = 1, #this.giftPackInfo do
        local xls = Csv.GetData("pop_up", this.giftPackInfo[i].giftInfo[1].id)
        if xls then
            local check
            for k = 1, #xls.pop_type do
                if xls.pop_type[k] == 19 then
                    table.remove(this.giftPackInfo, i)
                    check = true
                    break
                end
            end
            if check then
                break
            end
        end
    end

    Event.Brocast(EventName.Event_Gift_Update)
end

----------------------------------------------------------------------------------------


--------------PU礼包-----------------------------------------------------------------

--是否有免费礼包
function GiftPackModel:CheckPUHaveFreePack()
    local ret = false
    local data = this:GetPUPack()
    if data and data.giftInfo then
        table.each(data.giftInfo, function (v, k)
            if v.canBuyCount > 0 then
                local popCfg = Csv.GetData("pop_up", v.id)
                if popCfg.price == "0" then
                    ret = true
                end
            end
        end)
    end

    return ret
end

function GiftPackModel:GetPUPack()
    if this.giftPackInfo then
        for i = 1, #this.giftPackInfo do
            local id = this.giftPackInfo[i].giftInfo[1].id
            local xls = Csv.GetData("pop_up", id)
            if xls and xls.pop_type then
                for k = 1, #xls.pop_type do
                    if xls.pop_type[k] == 1 and xls.gift_group_type == 59 then
                        return this.giftPackInfo[i]
                    end
                end
            end
        end
    end
    return nil
end

function GiftPackModel:IsUnPopUpPuPack(skyState, freeState, rechargeState)
    local puData = self:GetPUPack()
    if ModelList.GuideModel:IsGuideComplete(71) then
        if puData ~= nil then
            local istrue = this:IsPackShowCD(puData.pId, puData.giftInfo[1].id, 12)
            if self:ShowPopUpPUPack(skyState, freeState, rechargeState) and self:CheckPUHaveFreePack() and (istrue == false) then
                self:ShowPUPack()
            else
                log.log("PU IS Show State:", self:ShowPopUpPUPack(skyState, freeState, rechargeState))
                log.log("PU IS Show Free:", self:CheckPUHaveFreePack())
                log.log("PU IS Show Time:", istrue)
                log.log("不会弹出")
            end
        end
    else
        log.log("引导未完成")
    end
end

function GiftPackModel:ShowPopUpPUPack(skyState, freeState, rechargeState)
    if skyState or freeState or rechargeState then
        return false
    else
        return true
    end
end

function GiftPackModel:ShowPUPack()
    local data = nil
    for i = 1, #this.giftPackInfo do
        local xls = Csv.GetData("pop_up", this.giftPackInfo[i].giftInfo[1].id)
        if xls then
            for k = 1, #xls.pop_type do
                if xls.pop_type[k] == 1 and xls.gift_group_type == 59 then
                    data = this.giftPackInfo[i]
                    break
                end
            end
        end
        if data then
            break
        end
    end
    if data then
        this:ShowGiftPack(data, GiftPackTriggerType.City, false)
        return true
    end
    return false
end

function GiftPackModel:RemovePUPack()
    for i = 1, #this.giftPackInfo do
        local xls = Csv.GetData("pop_up", this.giftPackInfo[i].giftInfo[1].id)
        if xls then
            local check
            for k = 1, #xls.pop_type do
                if xls.pop_type[k] == 1 and xls.gift_group_type == 59 then
                    table.remove(this.giftPackInfo, i)
                    check = true
                    break
                end
            end
            if check then
                break
            end
        end
    end

    Event.Brocast(EventName.Event_Gift_Update)
end

----------------------------------------------------------------------------------------



-------------region  显示饼干进度礼包---------------------------------

function GiftPackModel:ShowCookiePack()
    local data = nil
    for i = 1, #this.giftPackInfo do
        local xls = Csv.GetData("pop_up", this.giftPackInfo[i].giftInfo[1].id)
        if xls then
            for k = 1, #xls.pop_type do
                if xls.pop_type[k] == 12 then
                    data = this.giftPackInfo[i]
                    break
                end
            end
        end
        if data then
            break
        end
    end
    if data then
        this:ShowGiftPack(data, GiftPackTriggerType.City, false)
        return true
    end
    return false
end

--------------endregion  显示饼干进度礼包---------------------------------




local lastTime = 0

function GiftPackModel:CanBuy(count, iconName)
    if iconName then
        local open_city_id = Csv.GetGiftDataByIconName(iconName)
        if open_city_id and open_city_id.city_play ~= 0 and ModelList.CityModel.GetPlayIdByCity() ~= open_city_id.city_play then
            return false
        end
    end
    return count > 0 or count == -1
end

function GiftPackModel:CollectAllowGift(checkType)
    --log.y("CollectAllowGift  " .. tostring(checkType))
    this.lastCheckType = checkType
    this.allowGift = {}
    local cTime = ModelList.PlayerInfoModel.get_cur_server_time()
    if this.giftPackInfo then
        self:CheckClearCD(checkType)

        for i = 1, #this.giftPackInfo do
            local id = this.giftPackInfo[i].giftInfo[1].id
            if id == 565 then
                log.log("屏蔽礼包 " , this.giftPackInfo[i].giftInfo[1])
                break
            end
            local xls = Csv.GetData("pop_up", id)
            local haveCount = false
            local client_pop_scenel = 0
            if this.giftPackInfo[i].giftInfo[1].expireTime <= cTime or not this:IsNeedPopUpInMain(xls, checkType) then
                haveCount = false
            else
                if xls then
                    for k = 1, #this.giftPackInfo[i].giftInfo do
                        local scene = xls.client_pop_scenel
                        local canTrigger = false
                        for m = 1, #scene do
                            for n = 1, #checkType do
                                if scene[m][1] == checkType[n] then
                                    canTrigger = true
                                    client_pop_scenel = scene[m][1]
                                    break
                                end
                            end
                            if canTrigger then
                                break
                            end
                        end
                        if this:IsAllowCityPlayShow2(xls.icon) and this:CanBuy(this.giftPackInfo[i].giftInfo[k].canBuyCount) and canTrigger then
                            haveCount = true
                            break
                        end
                    end
                end
            end

            if haveCount then
                table.insert(this.allowGift, { data = this.giftPackInfo[i], type = client_pop_scenel })
            end
        end
    end
end

--- 不需要主动弹出的弹窗
function GiftPackModel:IsNeedPopUpInMain(xls, checkType)
    if checkType and #checkType > 0 then
        if checkType[1] == GiftPackTriggerType.Main and
            ModelList.CityModel.GetPlayIdByCity() == 17 then
            return true
        else
            return self:IsNeedPopUpInMain2(xls)
        end
    end
    return true
end

function GiftPackModel:IsNeedPopUpInMain2(xls)
    if xls then
        for k = 1, #xls.pop_type do
            ---不需要在主大厅出现的弹窗
            ---18 = 进入winzone活动后弹出
            ---19 = 火山活动开启后弹出
            if xls.pop_type[k] == 19 then
                return false
            end
        end
        return true
    end
    return false
end

function GiftPackModel:CheckAllowGift()
    this:CheckGiftViewList()
    ---2024/1/23 商城内不展示任何礼包
    if ViewList.ShopView and ViewList.ShopView.go and fun.get_active_self(ViewList.ShopView.go) then
        return
    end
    if #this.allowGift > 0 then
        for i = 1, #this.allowGift do
            if this:IsPackShowCD(this.allowGift[i].data.pId, this.allowGift[i].data.giftInfo[1].id, this.allowGift[i].type) then
                this.AddShownGift(this.allowGift[i].data.pId)
            elseif not this:IsPopUpGiftCountMax() and not fun.is_include(this.allowGift[i].data.pId, this.shownGift) then
                if not this.isShowing then
                    this:ShowGiftPack(this.allowGift[i].data)
                    this.AddShownGift(this.allowGift[i].data.pId)
                    log.y("giftpack shownGift add  " .. this.allowGift[i].data.pId)
                    return
                end
            end
        end
    end

    local cTime = ModelList.PlayerInfoModel.get_cur_server_time()
    if not this.isShowing and cTime - lastTime > 1 then
        if this:CheckGiftViewListIsShowing() then
            return
        end
        Event.Brocast(EventName.Event_Gift_Show_Over)
        this.isLogin = false
    end
end

function GiftPackModel:CloseView()
    if this.showingGift then
        this:SavePackShowTime(this.showingGift.pId, this.lastTriggerType)
    end
    this.isShowing = false
    this.showingGift = nil
    this.view = nil
    this.lastTriggerType = nil
    this:CollectAllowGift(this.lastCheckType)
    this:CheckAllowGift()
    this.PrintShownGift()
end

function GiftPackModel:CloseSpecialView()
    if this.showingGift then
        this:SavePackShowTime(this.showingGift.pId, this.lastTriggerType)
    end
    this.isShowing = false
    this.showingGift = nil
    this.view = nil
    this.lastTriggerType = nil
end

function GiftPackModel.ResGiftNotify(code, data)
    if (code == RET.RET_SUCCESS) then
        if not fun.IsEditor() then
            this:CheckCurrShow(this.lastGiftBuyResult)
        end
        this:RefreshData(data)
        if this.view then
            if not fun.is_null(this.view.go) then
                this.view:ShowDetailGift()
            end
        end
        --整个order 结束之后
        if (not this.view or this.view:IsIdle(this.view)) and not ModelList.GuideModel:IsGuiding() and CmdCommonList.CmdEnterCityPopupOrder.IsFinish() then
            if ProcedureManager:IsSceneHome() and not this:WaitWinzoneEnterLobby() then
                local checkType = { GiftPackTriggerType.City }
                this:CollectAllowGift(checkType)
                this:CheckNewGift()
            elseif ProcedureManager:IsSceneHall() then
                local checkType = { GiftPackTriggerType.Main }
                this:CollectAllowGift(checkType)
                this:CheckNewGift()
            end
        end
    else
        --log.r("Gift Notify Error")
    end
end

function GiftPackModel:WaitWinzoneEnterLobby()
    if ModelList.CityModel.GetPlayIdByCity() == 17 and CityHomeScene:IsNormalLobby() then
        return false
    end
    return true
end

function GiftPackModel:ReqEditorBuySucess(gId, sid)
    self._buy_giftId = sid
    this.lastGiftBuyResult = {}
    this.lastGiftBuyResult.giftId = gId
    this.lastGiftBuyResult.id = sid
    this.SendMessage(MSG_ID.MSG_BUY_GIFT, { giftId = gId, id = sid })
end

function GiftPackModel:SendEndlessGiftClaim(gId, step)
    this.lastGiftBuyResult = {}
    this.lastGiftBuyResult.giftId = gId
    this.SendMessage(MSG_ID.MSG_CLAIM_ENDLESS_GIFT, { giftId = gId, step = step })
end

function GiftPackModel:SendEndlessGiftFetch(gId)
    this.SendMessage(MSG_ID.MSG_FETCH_ENDLESS_GIFT, { giftId = gId })
end

function GiftPackModel.ResEditorBuySucess(code, data)
    if code == RET.RET_SUCCESS and data then
        --log.r("=================>>ResEditorBuySucess " .. data.giftId)
        local giftId = this._buy_giftId
        this.lastGiftBuyResult = data
        local giftIcon = Csv.GetData("pop_up", data.id, "icon")
        if (data and data.price and data.price == 0 and giftIcon == "PuBuyRkBtn") then
            this:CheckCurrShow(this.lastGiftBuyResult)
        elseif PurchaseHelper.IsEditorPurchase() then
            this:CheckCurrShow(this.lastGiftBuyResult)
        end
        if giftId then
            if not data.step or data.step == 0 then
                -- 不为无限礼包
                local pop_up_item = Csv.GetData("pop_up", giftId)
                if pop_up_item == nil then
                    return
                end

                local productId = pop_up_item.product_id --Csv.GetData("pop_up",giftId,"product_id")
                if 0 == productId then
                    --免费商品不需要发消息
                    return
                end

                productId = Csv.GetData("appstorepurchaseconfig", productId, "product_id")
                if productId then
                    if PurchaseHelper.IsEditorPurchase() then
                        if not data.pid or tostring(data.pid) == "" then
                            if this.Purchasing_success then
                                this.Purchasing_success()
                            end
                        else
                            ModelList.MainShopModel.C2S_NotifyServerIAPSuccess(nil, productId, data.pid, nil, nil, function ()
                            end, function ()
                                if this.Purchasing_success then
                                    this.Purchasing_success()
                                end
                            end)
                        end
                    else
                        if not data.pid or (tostring(data.pid) == "") then
                            if this.Purchasing_failure then
                                this.Purchasing_failure()
                            end
                        else
                            local product_name = Csv.GetData("appstorepurchaseconfig", productId, "product_name")
                            PurchaseHelper.PurchasingType(2, product_name)
                            PurchaseHelper.DoPurchasing(deep_copy(data), pop_up_item, productId, data.pid,
                                this.Purchasing_success, this.Purchasing_failure)
                        end
                    end
                end
            else
                local tmpData = Csv.getPopInfiniteForId(data.giftId)
                local pop_up_item = nil
                for _, v in ipairs(tmpData) do
                    if v.step == data.step then
                        pop_up_item = v
                    end
                end

                if pop_up_item == nil then
                    log.r("error no pop_up_item")
                    return
                end

                local productId = pop_up_item.product_id --Csv.GetData("pop_up",giftId,"product_id")
                if 0 == productId then
                    --免费商品不需要发消息
                    log.r("error free no pop_up_item")
                    return
                end
                local product_name = Csv.GetData("appstorepurchaseconfig", productId, "product_name")
                productId = Csv.GetData("appstorepurchaseconfig", productId, "product_id")
                if productId then
                    if PurchaseHelper.IsEditorPurchase() then
                        if not data.pid or tostring(data.pid) == "" then
                            if this.Purchasing_success then
                                this.Purchasing_success()
                            end
                        else
                            ModelList.MainShopModel.C2S_NotifyServerIAPSuccess(nil, productId, data.pid, nil, nil, function ()

                            end, function ()

                            end)
                        end
                    else
                        if not data.pid or tostring(data.pid) == "" then
                            if this.Purchasing_failure then
                                this.Purchasing_failure()
                            end
                        else
                            PurchaseHelper.PurchasingType(2, product_name)
                            PurchaseHelper.DoPurchasing(deep_copy(data), pop_up_item, productId, data.pid,
                                this.Purchasing_success, this.Purchasing_failure)
                        end
                    end
                end
            end
        end
    else
        if code == RET.RET_ORDER_CREATE_FAILED then
            UIUtil.show_common_popup(9025, true, nil)
        elseif code == RET.RET_SHOP_ITEM_EXPIRED then
            UIUtil.show_common_popup(9026, true, nil)
        elseif code == RET.RET_ITEM_BUY_LIMITED then
            UIUtil.show_common_popup(9027, true, nil)
        elseif code == RET.RET_ORDER_COMPLETED then
            UIUtil.show_common_popup(9028, true, nil)
        elseif code == RET.RET_SHOP_BUY_IN_CD then
            UIUtil.show_common_popup(9029, true, nil)
        end
    end
end

function GiftPackModel.Purchasing_success()
    log.r("购买礼包成功")
end

function GiftPackModel.Purchasing_failure()
    log.r("购买礼包失败")
end

--检测一个礼包是否可以购买
function GiftPackModel:IsPackAvailableByIcon(iconName)
    local currTime = ModelList.PlayerInfoModel.get_cur_server_time()
    for i, v in pairs(this.giftPackInfo) do
        local id = this.giftPackInfo[i].giftInfo[1].id
        local icon = Csv.GetData("pop_up", id, "icon")
        if icon == iconName then
            for j = 1, #v.giftInfo do
                if v.giftInfo[j].expireTime > currTime and this:CanBuy(v.giftInfo[j].canBuyCount) then
                    return true
                end
            end
        end
    end

    return false
end

--获得一个礼包的过期时间（礼包内的多个购买项的过期时间是一样的）
function GiftPackModel:GetPackExpireTimeByIcon(iconName)
    local currTime = ModelList.PlayerInfoModel.get_cur_server_time()
    for i, v in pairs(this.giftPackInfo) do
        local id = this.giftPackInfo[i].giftInfo[1].id
        local icon = Csv.GetData("pop_up", id, "icon")
        if icon == iconName then
            return v.giftInfo[1].expireTime or 0
        end
    end

    return 0
end

---无尽礼包领取
function GiftPackModel.OnClaimEndlessGift(code, data)
    if code == RET.RET_SUCCESS and data then
        -- 领取成功
        Facade.SendNotification(NotifyName.EndlessGift.ClaimSuccess, data)
    else
        -- 领取失败
        Facade.SendNotification(NotifyName.EndlessGift.ClaimFail, nil)
    end
end

---无尽礼包查询
function GiftPackModel.OnFetchEndlessGift(code, data)
    if code == RET.RET_SUCCESS and data then
        --查询成功
        Facade.SendNotification(NotifyName.EndlessGift.FetchSuccess, data)
    else
        -- 领取成功
        Facade.SendNotification(NotifyName.EndlessGift.FetchFail, nil)
    end
end

--- 弹出礼包的数量上限清零
function GiftPackModel:ResetPopUpGiftCount()
    this.popUpGiftCount = 0
end

--- 弹出礼包的数量上限增加
function GiftPackModel:AddPopUpGiftCount()
    if not this.popUpGiftCount then
        this.popUpGiftCount = 0
    end
    this.popUpGiftCount = this.popUpGiftCount + 1
end

--- 弹出礼包的数量达到上限
function GiftPackModel:IsPopUpGiftCountMax()
    if not this.popUpGiftCount then
        this.popUpGiftCount = 0
    end
    if not this.popUpGiftCountMax then
        this.popUpGiftCountMax = Csv.GetControlByName("pop_up_limit")[1][1]
    end
    return this.popUpGiftCount >= this.popUpGiftCountMax
end

--[[
    @desc: 获取大厅入口破冰礼包数据
    author:{author}
    time:2024-01-17 12:34:49
    @return:
]]
function GiftPackModel:GetPackEnterViewBreakIcePackGiftData()
    local gift_info = self:GetOpenedGift()
    local limitCount = Csv.GetData("control", 158, "content")[1][1] or 2
    local limitIndex = nil      -- 如果后面需求有修改，确定
    local breakIcePackInfo = {} -- 放破冰礼包的
    local notDisplayPack = {}   --放不展示的礼包
    if gift_info then
        local tempWeight = 0
        for _, v in ipairs(gift_info) do
            local xls = Csv.GetData("pop_up", v.giftInfo[1].id)

            if xls and xls.type_id[1] == 2 and xls.type_id[2] == 2 then
                notDisplayPack[v.pId] = xls.gift_weight
            end

            if xls and xls.type_id[1] == 1 and xls.type_id[2] == 1 then
                --破冰礼包只能有一个
                if xls.gift_weight[1] > tempWeight then
                    tempWeight = xls.gift_weight[1]
                    limitIndex = v.pId
                end
                breakIcePackInfo[v.pId] = true
            end
        end
    end

    if limitIndex ~= nil then
        breakIcePackInfo[limitIndex] = nil
    end

    for i = 1, limitCount do
        local tmpNum = 0
        local tmpkey = 0
        for k, v in pairs(notDisplayPack) do
            if v ~= nil and v[1] > tmpNum then
                tmpkey = k;
                tmpNum = v[1];
            end
        end
        if tmpkey > 0 then
            notDisplayPack[tmpkey] = nil;
        end
    end

    return breakIcePackInfo, notDisplayPack
end

--[[
    ---限量礼包id 范围4001-5000

    @desc: 是否为限量礼包
    author:{author}
    time:2024-01-24 20:14:55
    --@giftId:
    @return:
]]
function GiftPackModel:IsLimitPack(giftId)
    local PACKAGE_LIMIT_PACK_BEGIN_ID = 4001
    local PACKAGE_LIMIT_PACK_END_ID = 5000

    if (giftId >= PACKAGE_LIMIT_PACK_BEGIN_ID and giftId <= PACKAGE_LIMIT_PACK_END_ID) then
        return true
    end
    return false
end

--[[
    @desc: 获取大厅icon显示数据
    author:{author}
    time:2024-01-17 12:47:10
    @return:
]]
function GiftPackModel:GetPackEnterViewDisplayData()
    local breakIcePackInfo, notDisplayPack = self:GetPackEnterViewBreakIcePackGiftData()
    local gift_info = self:GetOpenedGift()
    local ret = {}
    local start_time = ModelList.PlayerInfoModel.get_cur_server_time()
    if gift_info then
        for _, v in ipairs(gift_info) do
            local xls = Csv.GetData("pop_up", v.giftInfo[1].id)

            if xls and xls.display == 1 and not breakIcePackInfo[v.pId] and not notDisplayPack[v.pId] and self:IsNeedPopUpInMain2(xls) then
                local fullData = {}
                fullData.name = tostring(v.pId)
                fullData.icon = tostring(xls.icon)
                fullData.expireTime = v.giftInfo[1].expireTime
                fullData.sellNumber = xls.sell_number or 0
                fullData.canBuyCount = 0
                local canBuyCount = false
                for i = 1, #v.giftInfo do
                    if v.giftInfo[i].canBuyCount > 0 or v.giftInfo[i].canBuyCount == -1 then
                        canBuyCount = true
                        fullData.canBuyCount = v.giftInfo[i].canBuyCount
                        break
                    end
                end

                if (v.giftInfo[1].id == 4008) then
                    log.r("break ")
                end

                if v.giftInfo[1].expireTime > start_time and canBuyCount then
                    fullData.isDisplay = true
                elseif v.giftInfo[1].expireTime > start_time and canBuyCount == false and self:IsLimitPack(v.giftInfo[1].id) then
                    fullData.isDisplay = true
                else
                    fullData.isDisplay = false
                end

                table.insert(ret, fullData)
            end
        end
    end
    return ret
end

--[[
    @desc:【1.27.1】去广告付费轰炸礼包，新增破冰礼包及触发条件 https://www.tapd.cn/32691960/prong/stories/view/1132691960001000053
    author:nuts
    time: 2024-04-24 17:16
    @return:
]]

---展示pop_type为20的礼包
function GiftPackModel:ShowNoAdPack()
    local data = nil
    for i = 1, #this.giftPackInfo do
        local xls = Csv.GetData("pop_up", this.giftPackInfo[i].giftInfo[1].id)
        if xls then
            for k = 1, #xls.pop_type do
                if xls.pop_type[k] == 20 then
                    data = this.giftPackInfo[i]
                    break
                end
            end
        end
        if data then
            break
        end
    end
    if data then
        this:ShowGiftPack(data, GiftPackTriggerType.City, false)
        return true
    end
    return false
end

this.MsgIdList = {
    { msgid = MSG_ID.MSG_GIFT_NOTIFY, func = this.ResGiftNotify },
    { msgid = MSG_ID.MSG_BUY_GIFT, func = this.ResEditorBuySucess },
    { msgid = MSG_ID.MSG_CLAIM_ENDLESS_GIFT, func = this.OnClaimEndlessGift }, --领取免费礼包
    { msgid = MSG_ID.MSG_FETCH_ENDLESS_GIFT, func = this.OnFetchEndlessGift }  --查询
}

return this
