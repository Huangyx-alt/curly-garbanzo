-----
----- Generated by EmmyLua(https://github.com/EmmyLua)
----- Created by PC.
----- DateTime: 2021/8/23 18:30
-----
--
--local QuickTaskOriginalState = require "State/QuickTaskView/QuickTaskOriginalState"
--local QuickTaskAchieveState = require "State/QuickTaskView/QuickTaskAchieveState"
--local QuickTaskNoAchieveState = require "State/QuickTaskView/QuickTaskNoAchieveState"
--local QuickTaskClaimAwardsState = require "State/QuickTaskView/QuickTaskClaimAwardsState"
--local QuickTaskFlyCookyState = require "State/QuickTaskView/QuickTaskFlyCookyState"
--
--local DoubleCookiesRewards = require "View/CommonView/DoubleCookiesRewards"
--
--local extra_reward_tip = require "View/Task/TopQuickTaskExtraTipView"
--
--ParasitiferType = {mainCity = 1,lobby = 2,autoLobby = 3,other = 4}
--
--local TopQuickTaskView = BaseView:New("TopQuickTaskView")
--local this = TopQuickTaskView
--this.viewType = CanvasSortingOrderManager.LayerType.None
--
--local slidValue = -1
--
--local reward_cache_data = nil
--
--local finish_popup_process = nil
--
--this.auto_bind_ui_items = {
--    "btn_foodcollect",
--    "slid_food_progress",
--    "text_food_percent",
--    "text_food_countdown",
--    "text_food_time",
--    "img_needitem",
--    "img_rewarditem",
--    "hangpoint1",
--    "hangpoint2",
--    "Image_fly_icon1",
--    "Image_fly_icon2",
--    "Image_fly_icon3",
--    "Image_fly_icon4",
--    "Image_fly_icon5",
--    "Image_fly_icon6",
--    "anima",
--    "black_block",
--    "extra_rewarditem",
--    "extra_rewardname",
--    "text_extra_countdown",
--    "content",
--    "btn_extrareward"
--}
--
--function TopQuickTaskView:New(showDetail,parasitifer)
--    local o = {}
--    self.__index = self
--    setmetatable(o,self)
--    o._showDetail = showDetail
--    o._parasitifer = parasitifer or ParasitiferType.other
--    o.doubleCookiesRewards = DoubleCookiesRewards:New()
--    return o
--end
--
--function TopQuickTaskView:on_btn_foodcollect_click()
--    self._fsm:GetCurState():ShowDetail(self._fsm)
--end
--
--function TopQuickTaskView:on_btn_extrareward_click()
--    self._fsm:GetCurState():ShowExtraRewardTip(self._fsm)
--end
--
--function TopQuickTaskView:OnShowDetail()
--    if self._showDetail then
--        Facade.SendNotification(NotifyName.ShowUI,ViewList.QuickTaskDetailView)
--    end
--end
--
--function TopQuickTaskView:OnShowExtraRewardTip()
--    Facade.SendNotification(NotifyName.ShowUI,extra_reward_tip,nil,nil,
--    {pos = self.btn_extrareward.transform.position,
--    icon = self.img_rewarditem,time = function() return self.extra_leftTime end})
--end
--
--function TopQuickTaskView:SetDoubleRewardSkin(isDoubleReward)
--    if self.go then
--        local changeSkin = function(path,name)
--            local child = fun.find_child(self.go,path)
--            local child_img = nil
--            if child then
--                child_img = fun.get_component(child.transform,fun.IMAGE)
--            end
--            if child_img then
--                Cache.SetImageSprite("CommonAtlas",name,child_img)
--            end
--        end
--        if isDoubleReward then
--            changeSkin("content/task/slid_food_progress/Background","c_goal_jd_diDouble")
--            changeSkin("content/rewards/hangpoint1/Root/plus/cgoaljddi04","cgoaljddi04Double")
--            changeSkin("content/rewards/hangpoint1/Root/plus/cgoaljddi03","cgoaljddi03Double")
--            changeSkin("content/rewards/hangpoint1/Root/plus/CXianShiDi","cgoaljddi02Double")
--            self:GetRemainTime()
--        else
--            changeSkin("content/task/slid_food_progress/Background","c_goal_jd_di")
--            changeSkin("content/rewards/hangpoint1/Root/plus/cgoaljddi04","cgoaljddi04")
--            changeSkin("content/rewards/hangpoint1/Root/plus/cgoaljddi03","cgoaljddi03")
--            changeSkin("content/rewards/hangpoint1/Root/plus/CXianShiDi","cgoaljddi02")
--        end
--    end
--end
--
--function TopQuickTaskView:DoClaimAward()
--    ---[[
--    local quickTask,quickTaskActivity = ModelList.ActivityModel:GetQuickTaskActive()
--    if quickTask then
--        local rewardExtra = 0
--        if self.isExtraReward then
--            rewardExtra = 1
--        end
--        AddLockCountOneStep()
--        ModelList.ActivityModel.C2S_SubmitActivity_new(quickTaskActivity.id,quickTask.id,quickTask.createTime,rewardExtra)
--    end
--    --]]
--    --self:GetTaskRewardSucceed() --用于测试
--    --ModelList.TaskModel.testTask = ModelList.TaskModel.testTask + 1
--end
--
--function TopQuickTaskView:GetTaskRewardSucceed()
--    self._fsm:GetCurState():ClaimRewardResult(self.fsm)
--end
--
--function TopQuickTaskView:Awake()
--    self:on_init()
--    if -1 == slidValue then --slidValue这个变量是所有实例共用的，只需要设置一次初始化
--        slidValue = UnityEngine.PlayerPrefs.GetFloat("TopQuickTask",-1)
--    end
--end
--
--function TopQuickTaskView:OnEnable()
--    self:RegisterEvent()
--    self:BuildFsm()
--    self:OnTaskUpdate()
--    self.doubleCookiesRewards:CheckCookiesQuickTask(self.content,self)
--end
--
--function TopQuickTaskView:BuildFsm()
--    self:DisposeFsm()
--    self._fsm = Fsm.CreateFsm("TopQuickTaskView",self,{
--        QuickTaskOriginalState:New(),
--        QuickTaskAchieveState:New(),
--        QuickTaskNoAchieveState:New(),
--        QuickTaskClaimAwardsState:New(),
--        QuickTaskFlyCookyState:New()
--    })
--    self._fsm:StartFsm("QuickTaskOriginalState")
--end
--
--function TopQuickTaskView:DisposeFsm()
--    if self._fsm then
--        self._fsm:Dispose()
--        self._fsm = nil
--    end
--end
--
--function TopQuickTaskView:OnApplicationFocus(focus)
--    if focus and self.isShow then
--        self:SetTaskInfo()
--    end
--end
--
--function TopQuickTaskView:CheckActivity(quickTask_go)
--    local availab = ModelList.ActivityModel:IsActivityAvailable(ActivityTypes.quickTask)
--    fun.set_active(quickTask_go.transform.parent.parent,availab,false)
--    if availab then
--        self:SkipLoadShow(quickTask_go)
--    end
--end
--
--function TopQuickTaskView:GetRemainTime()
--    local remainTime = math.max(0,ModelList.ActivityModel:GetActivityExpireTime(ActivityTypes.doubleCookies) - os.time())
--    if remainTime <= 2 then
--        remainTime = math.max(0,ModelList.ActivityModel:GetActivityExpireTime(ActivityTypes.quickTask) - os.time())
--    end
--    self.leftTime = remainTime
--end
--
--function TopQuickTaskView:SetTaskInfo()
--    self.leftTime = nil
--    self.extra_leftTime = nil
--    local quickTask = ModelList.ActivityModel:GetQuickTaskActive()
--    local quickTaskActivity = ModelList.ActivityModel:IsActivityAvailable(ActivityTypes.quickTask)
--    if quickTaskActivity and quickTask then
--        local data = Csv.GetData("activity_round",tonumber(quickTask.id))
--        local item = nil
--        --local reward = nil
--        local rewardIcon = nil
--        if data then
--            item = Csv.GetData("item",data.finish_need[1])
--            --reward = Csv.GetData("resources",data.reward[1][1])
--            rewardIcon = {data.reward_icon,data.reward_extra_icon}
--            self:CheckExtraReward(data)
--        end
--        if item then
--            self.img_needitem.sprite = AtlasManager:GetSpriteByName("HallMainAtlas",item.icon)
--        end
--        if rewardIcon[1] then
--            Cache.load_sprite(AssetList[rewardIcon[1]],rewardIcon[1],function(tex)
--                if tex then
--                    self.img_rewarditem.texture = tex.texture
--                end
--            end)
--        end
--        if rewardIcon[2] then
--            Cache.load_sprite(AssetList[rewardIcon[2]],rewardIcon[2],function(tex)
--                if tex then
--                    self.extra_rewarditem.texture = tex.texture
--                end
--            end)
--        end
--
--        local num = tonumber(quickTask.progress)
--        local targenum = tonumber(quickTask.target)
--        num = math.min(num,targenum)
--        if slidValue < 0 then
--            slidValue = num
--            UnityEngine.PlayerPrefs.SetFloat("TopQuickTask",slidValue)
--            self:SetProgress(num,targenum)
--        else
--            self:SetProgress(math.min(slidValue, num),targenum)
--        end
--        self.text_food_time.text =  fun.NumInsertComma(data.reward_description or 0) -- tostring(data.reward_description[1][1])
--        self.extra_rewardname.text = fun.NumInsertComma(data.reward_extra_description or 0) --tostring(data.reward_extra_description or 0)
--        self:GetRemainTime() --math.max(0,ModelList.ActivityModel:GetActivityExpireTime(ActivityTypes.quickTask) - os.time())
--    end
--
--    local isFirstOpen = ModelList.ActivityModel:IsActivityFirstOpen(ActivityTypes.quickTask)
--    if quickTaskActivity and quickTask ~= nil and self.leftTime and self.leftTime > 2 then
--        self:Show(nil,self.go)
--        if isFirstOpen and self._parasitifer ~= ParasitiferType.other then
--            fun.set_active(self.content,false,false)
--        end
--    else
--        self:ForceQuickTaskFinish()
--        fun.set_active(self.go.transform.parent.parent,false,false)
--    end
--end
--
--function TopQuickTaskView:CheckExtraReward(data)
--    local quickTask = ModelList.ActivityModel:GetQuickTaskActive()
--    if not data then
--        if quickTask then
--            data = Csv.GetData("activity_round",tonumber(quickTask.id))
--        end
--    end
--    if data then
--        local reward_type = nil
--        self.extra_leftTime = math.max(0,(quickTask.createTime + ((data.reward_extra[2] or {})[1] or 0)) - os.time())
--        if data.reward_extra[1][1] and data.reward_extra[1][1] > 0 and self.extra_leftTime > 1 then
--            reward_type = true
--        else
--            reward_type = false
--        end
--        if reward_type ~= self.isExtraReward then
--            self.isExtraReward = reward_type
--            if self.isExtraReward then
--                self:PlayRewardWithExtra()
--            else
--                self:PlayRewardNoExtra()
--            end
--        end
--    end
--end
--
--function TopQuickTaskView:OnTaskUpdate(taskType)
--    if taskType == nil or taskType == ActivityTypes.quickTask then
--        self:SetTaskInfo()
--        if self.leftTime and self.leftTime > 0 then
--            if self._timer then
--                self._timer:Stop()
--                self._timer = nil
--            end
--            self._timer = Timer.New(function()
--                self:OnHeartBeat(true)
--            end,1,-1)
--            self._timer:Start()
--            self:OnHeartBeat()
--        end
--    end
--end
--
--function TopQuickTaskView:OnHeartBeat(sub)
--    if self.isExtraReward then
--        if self.extra_leftTime and self.extra_leftTime > 0 then
--            if sub then
--                self.extra_leftTime = math.max(0,self.extra_leftTime - 1)
--            end
--            self.text_extra_countdown.text = fun.format_time(self.extra_leftTime)
--
--            if extra_reward_tip then
--                extra_reward_tip:setTime(self.extra_leftTime)
--            end
--
--        else
--            self:CheckExtraReward()
--        end
--    end
--    if self.leftTime and self.leftTime > 0 then
--        if sub then
--            self.leftTime = math.max(0,self.leftTime - 1)
--        end
--        self.text_food_countdown.text = fun.format_time(self.leftTime)
--    else
--        if self._timer then
--            self._timer:Stop()
--            self._timer = nil
--        end
--        self:GetRemainTime()
--        self._fsm:GetCurState():CheckTimeOut(self._fsm)
--    end
--end
--
--function TopQuickTaskView:TimeOutHide()
--    if self.leftTime == nil or self.leftTime <= 0 then
--        self:ForceQuickTaskFinish()
--        fun.set_active(self.go.transform.parent.parent,false,false)
--    else
--        self:OnTaskUpdate()
--        self.doubleCookiesRewards:CheckDoubleCookiesActive()
--    end
--end
--
--function TopQuickTaskView:SetParent(go)
--    if go then
--        if self.revertParent == nil then
--            self.revertParent = self.go.transform.parent
--            self.contenPos = self.content.position
--            local pos = self.go.transform.position
--            self.go.transform:SetParent(go.transform)
--            self.go.transform.position = pos
--            --self.black_block.sizeDelta = Vector2.New(1080 * (UnityEngine.Screen.width / 1080),1920 * (UnityEngine.Screen.height / 1920))
--            --self.black_block.position = Vector3.New(0,0,0)
--            self.go.transform.localScale = Vector3.one
--            self.go.transform.anchorMin = Vector2.New(0,0)
--            self.go.transform.anchorMax = Vector2.New(1,1)
--            self.go.transform.pivot = Vector2.New(0.5,0.5)
--            self.go.transform.offsetMax = Vector2.New(0,0)
--            self.go.transform.offsetMin = Vector2.New(0,0)
--
--            self.content.position = self.contenPos
--        end
--    end
--end
--
--function TopQuickTaskView:RevertParent()
--    if self.revertParent then
--        local pos = self.go.transform.position
--        self.go.transform:SetParent(self.revertParent)
--        self.go.transform.position = pos
--        self.content.position = self.contenPos
--        self.revertParent = nil
--    end
--end
--
--function TopQuickTaskView:TweenSlider()
--    local quickTask = ModelList.ActivityModel:GetQuickTaskActive()
--    if quickTask then
--        local nownNum = tonumber(quickTask.progress)
--        local targenum = tonumber(quickTask.target)
--        nownNum = math.min(nownNum,targenum)
--        if nownNum > 0 then
--            UISound.play_loop("task_item_increase")
--            Anim.do_smooth_float_update(slidValue,nownNum,math.min(math.max(0.05,(nownNum - slidValue)/15),5),
--            function(num)
--                self:SetProgress(num,targenum)
--            end,
--            function(tweener)
--                if nownNum == targenum then
--                    slidValue = 0
--                else
--                    slidValue = nownNum
--                end
--                self._fsm:GetCurState():TweenSliderFinish(self._fsm)
--                UISound.stop_loop("task_item_increase")
--                UnityEngine.PlayerPrefs.SetFloat("TopQuickTask",slidValue)
--            end)
--        else
--            slidValue = 0
--            self:SetProgress(nownNum,targenum)
--            self._fsm:GetCurState():TweenSliderFinish(self._fsm)
--        end
--    end
--end
--
--function TopQuickTaskView:QuickTaskGetReward()
--    self:PlayGetRewardAnima()
--end
--
--function TopQuickTaskView:ForceQuickTaskFinish()
--    if not finish_popup_process then
--        self:QuickTaskFinish()
--    else
--        self:Hide()
--    end
--end
--
--function TopQuickTaskView:QuickTaskFinish()
--    finish_popup_process = true
--    self:RevertParent()
--    Event.Brocast(EventName.Event_topquicktask_animafinish)
--    self._fsm:GetCurState():Finish(self._fsm)
--end
--
--function TopQuickTaskView:PlayRewardNoExtra()
--    local stateInfo = self.anima:GetCurrentAnimatorStateInfo(0)
--    if stateInfo and stateInfo:IsName("idle1") then
--        AnimatorPlayHelper.Play(self.anima,{"efTopQuickTaskViewge1","efTopQuickTaskViewge1"},false,nil)
--    end
--end
--
--function TopQuickTaskView:PlayRewardWithExtra()
--    local stateInfo = self.anima:GetCurrentAnimatorStateInfo(0)
--    if stateInfo and stateInfo:IsName("idle1") then
--        AnimatorPlayHelper.Play(self.anima,{"efTopQuickTaskViewge2","efTopQuickTaskViewge2"},false,nil)
--    end
--end
--
--function TopQuickTaskView:GetRewardStartAnima()
--    if self.isExtraReward then
--        return {"start2","efTopQuickTaskViewstart2"}
--    else
--        return {"start","efTopQuickTaskViewstart"}
--    end
--end
--
--function TopQuickTaskView:PlayGetRewardAnima()
--    UISound.play("rask_reward_out")
--    AnimatorPlayHelper.Play(self.anima,self:GetRewardStartAnima(),false,function()
--        self._fsm:GetCurState():ClaimAwards(self._fsm)
--    end)
--end
--
--function TopQuickTaskView:GetRewardPickAnima()
--    if self.isExtraReward then
--        return {"pick2","efTopQuickTaskViewpick2"}
--    else
--        return {"pick","efTopQuickTaskViewpick"}
--    end
--end
--
--function TopQuickTaskView:FlyRewardItem2Head(pos)
--    Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts,self.img_rewarditem.transform.position,reward_cache_data[1],function()
--        Event.Brocast(EventName.Event_currency_change)
--    end)
--
--    if self.isExtraReward and reward_cache_data[2] > 0 then
--        Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts,self.extra_rewarditem.transform.position,reward_cache_data[2],function()
--            Event.Brocast(EventName.Event_currency_change)
--        end)
--    end
--
--    AnimatorPlayHelper.Play(self.anima,self:GetRewardPickAnima(),false,function()
--        self:FlyNextRewardItem()
--    end)
--end
--
--function TopQuickTaskView:FlyNextRewardItem()
--    self:SetTaskInfo()
--    UISound.play("task_reward_back")
--    AnimatorPlayHelper.Play(self.anima,{"new","efTopQuickTaskViewnew"},false,function()
--        if self.isExtraReward then
--            UISound.play("task_reward_back")
--            AnimatorPlayHelper.Play(self.anima,{"new2","efTopQuickTaskViewnew2"},false,function()
--                self:EnterHomeScene()
--            end)
--        else
--            self:EnterHomeScene()
--        end
--    end)
--end
--
--function TopQuickTaskView:SaveQuickTaskId()
--    --在下一个任务更新之前先保存起来
--    local quickTask = ModelList.ActivityModel:GetQuickTaskActive()
--    if quickTask then
--        local task = Csv.GetData("activity_round",tonumber(quickTask.id)) or {}
--        reward_cache_data = {task.reward[1][1] or 1,task.reward_extra[1][1] or 0}
--    end
--end
--
--function TopQuickTaskView:OnDisable()
--    self:UnRegisterEvent()
--    if self._timer then
--        self._timer:Stop()
--        self._timer = nil
--    end
--    self.leftTime = nil
--    self.extra_leftTime = nil
--    self.changeParent = nil
--    self.isExtraReward = nil
--    reward_cache_data = nil
--    self.doubleCookiesRewards:OnDisable()
--end
--
--function TopQuickTaskView:OnCheckQuickTask()
--    local first,id = ModelList.ActivityModel:IsAnyFirstOpen()
--    if first and id == ActivityTypes.quickTask then
--        AnimatorPlayHelper.Play(self.anima,{"enter","efTopQuickTaskViewienter"},false,0.1,function()
--            fun.set_active(self.content,true,false)
--        end,function()
--            ModelList.ActivityModel:CutdownFirstPopup(ActivityTypes.quickTask)
--            self:OnCheckQuickTask2()
--        end)
--    else
--        self:OnCheckQuickTask2()
--    end
--end
--
--function TopQuickTaskView:OnCheckQuickTask2()
--    local quickTask = ModelList.ActivityModel:GetQuickTaskActive()
--    if quickTask then
--        if quickTask.failed then
--            self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
--        elseif quickTask.completed then
--            self._fsm:GetCurState():QuickTaskAchieve(self._fsm)
--        else
--            self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
--        end
--    else
--        self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
--    end
--end
--
--function TopQuickTaskView:EnterHomeScene()
--    finish_popup_process = false
--    self._fsm:GetCurState():CheckQuickTask(self._fsm)
--end
--
--function TopQuickTaskView:SetProgress(num,targetNum)
--    self.text_food_percent.text = string.format("<size=42>%s</size><color=#ecff93>/%s</color>",math.floor(num),targetNum)
--    self.slid_food_progress.value = num / targetNum
--end
--
--function TopQuickTaskView:OnQuickTaskNoAchieve()
--    local quickTask = ModelList.ActivityModel:GetQuickTaskActive()
--    if quickTask then
--        local num = tonumber(quickTask.progress)
--        local targenum = tonumber(quickTask.target)
--        num = math.min(num,targenum)
--        if num > 0 and slidValue < num then
--            self:DoAnimationObtainableTaskItem()
--        else
--            self:SetProgress(num,targenum)
--            self._fsm:GetCurState():TweenSliderFinish(self._fsm)
--            slidValue = num
--        end
--    end
--end
--
--function TopQuickTaskView:OnQuickTaskAchieve()
--    self:DoAnimationObtainableTaskItem()
--end
--
--function TopQuickTaskView:DoAnimationObtainableTaskItem()
--    if not self.changeParent then
--        self.changeParent = true
--    else
--        self:FlyCooky()
--    end
--end
--
--function TopQuickTaskView:FlyCooky(parent_task_fly)
--    self._fsm:GetCurState():FlyCooky(self._fsm,parent_task_fly)
--end
--
--function TopQuickTaskView:GetCookiesAnimation()
--    if self.doubleCookiesRewards:IsDoubleReward() then
--        return {"get2","efTopQuickTaskViewget2"}
--    else
--        return {"get","efTopQuickTaskViewget"}
--    end
--end
--
--function TopQuickTaskView:OnFlyCooky(parent_task_fly)
--    if parent_task_fly then
--        self:SetParent(parent_task_fly)
--    end
--    UISound.play("task_item_out")
--    self.Image_fly_icon1.sprite = self.img_needitem.sprite
--    self.Image_fly_icon2.sprite = self.img_needitem.sprite
--    self.Image_fly_icon3.sprite = self.img_needitem.sprite
--    self.Image_fly_icon4.sprite = self.img_needitem.sprite
--    self.Image_fly_icon5.sprite = self.img_needitem.sprite
--    self.Image_fly_icon6.sprite = self.img_needitem.sprite
--    AnimatorPlayHelper.Play(self.anima,self:GetCookiesAnimation(),false,function()
--        self:TweenSlider()
--    end)
--end
--
--function TopQuickTaskView:RegisterEvent()
--    Event.AddListener(EventName.Event_show_topquick_task,self.EnterHomeScene,self)
--    Event.AddListener(EventName.Event_Activity_ReceiveReward,self.GetTaskRewardSucceed,self)
--    --Event.AddListener(EventName.Event_Check_Double_Activity,self.OnTaskUpdate,self)
--end
--
--function TopQuickTaskView:UnRegisterEvent()
--    Event.RemoveListener(EventName.Event_show_topquick_task,self.EnterHomeScene,self)
--    Event.RemoveListener(EventName.Event_Activity_ReceiveReward,self.GetTaskRewardSucceed,self)
--   -- Event.RemoveListener(EventName.Event_Check_Double_Activity,self.OnTaskUpdate,self)
--end
--
--function TopQuickTaskView:on_close()
--    self.doubleCookiesRewards:Dispose()
--end
--
--function TopQuickTaskView:OnDestroy()
--    self:Close()
--end
--
--return this