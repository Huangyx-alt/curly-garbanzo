---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/22 15:39
---

--- 计算bingo

CalculateBingoMachine = BaseMachine:New("CalculateBingoMachine")
local this = CalculateBingoMachine

require("Combat/Machine/BingoOrderMachine")

this.isInit = false
this.bingoCell = nil
this.BingoType = {BINGO = 1,JACKPOT = 2}
this.robotsRecordBingoOrder = {}   --  机器人的bingo顺序记录
this.totalBingoCount = {}       --每个卡牌的bingo总数量

this.BingoRule = nil

function CalculateBingoMachine:Start(loadData)
    this:LoadBingoRule(loadData)
end

--- bingo 判定规则，对应bingo_rule.xlsx
local BingoRuleType = {
    Normal = 1 ,   --普通
    CollectThing = 2 ,   -- 收集指定物品
    CollectDrinks = 3,     -- 收集酒杯
    CollectTreasure = 4,
    NewCollectTreasure = 5, --自定义收集物品的类型、数量，并且jackpot条件为指定盖章图形
    BreakPrison = 7,  --狼人破坏牢笼
    FoodParty = 6,  --食物合成
    NewLockTiersRule = 8,  --解锁格子 bingo规则
    RandomCollectTreasure = 9, --随机收集物品到指定总数，并且jackpot条件为指定盖章图形
    HorseRacing = 10, --赛马玩法
    ScratchWinner = 11, --ScratchWinner玩法
    ChristmasSynthesis = 12, --圣诞合成
    Monopoly = 13, --大富翁
}
 
--- 加载bingo判断规则
function CalculateBingoMachine:LoadBingoRule(loadData)
    if loadData.bingoRuleId then
        this.BingoRule = {}
        for i = 1, #loadData.bingoRuleId do
            local ruleData = Csv.GetData("new_bingo_rule",tonumber(loadData.bingoRuleId[i]))
            local ruleType = ruleData.clienttype or ruleData.type
            if ruleType == BingoRuleType.Normal then
                local playid = ModelList.CityModel.GetPlayIdByCity()
                local playType = Csv.GetData("new_city_play", playid, "play_type")
                local rule
                if playType == PLAY_TYPE.PLAY_TYPE_GOLD_TRAIN then
                    rule = require("Combat.Machine.CalculateBingo.GoldenTrainBingoRule")
                else
                    rule = require("Combat.Machine.CalculateBingo.NormalBingoRule")
                end
                table.insert(this.BingoRule, rule)
                rule:Start(loadData)
            elseif ruleType == BingoRuleType.CollectThing then
                local rule = require("Combat.Machine.CalculateBingo.CollectItemRule")
                table.insert(this.BingoRule,rule)
                rule:Start(loadData)
            elseif ruleType == BingoRuleType.CollectDrinks then
                local rule = require("Combat.Machine.CalculateBingo.CollectDrinksBingoRule")
                table.insert(this.BingoRule,rule)
                rule:Start(loadData,ruleData.wish_item)
            elseif ruleType == BingoRuleType.CollectTreasure then
                local rule = require("Combat.Machine.CalculateBingo.CollectTreasureBingoRule")
                table.insert(this.BingoRule,rule)
                rule:Start(loadData,ruleData.wish_item)            
            elseif ruleType == BingoRuleType.NewCollectTreasure then
                local playid = ModelList.CityModel.GetPlayIdByCity()
                local playType = Csv.GetData("new_city_play", playid, "play_type")
                local rule = require("Combat.Machine.CalculateBingo.NewCollectTreasureBingoRule")
                if playType == PLAY_TYPE.PLAY_TYPE_THREE_PIGS then
                    rule = require("Combat.Machine.CalculateBingo.GotYouBingoRule")
                elseif playType == PLAY_TYPE.PLAY_TYPE_LET_THEM_ROLL then
                    rule = require("Combat.Machine.CalculateBingo.LetemRollBingoRule")
                elseif playType == PLAY_TYPE.PLAY_TYPE_PIGGY_BANK then
                    rule = require("Combat.Machine.CalculateBingo.PiggyBankBingoRule")
                elseif playType == PLAY_TYPE.PLAY_TYPE_SOLITAIRE then
                    rule = require("Combat.Machine.CalculateBingo.SolitaireBingoRule")
                elseif playType == PLAY_TYPE.PLAY_TYPE_BEER then
                    rule = require("Combat.Machine.CalculateBingo.DrinkingFrenzyBingoRule")
                end
                table.insert(this.BingoRule,rule)
                rule:Start(loadData, ruleData)
            elseif ruleType == BingoRuleType.BreakPrison then
                local rule = require("Combat.Machine.CalculateBingo.SingleWolfRule")
                table.insert(this.BingoRule,rule)
                rule:Start(loadData,ruleData.wish_item)                                                 
            elseif ruleType == BingoRuleType.FoodParty then
                local rule = require("Combat.Machine.CalculateBingo.FoodPartyBingoRule")
                table.insert(this.BingoRule,rule)
                rule:Start(loadData,ruleData.wish_item)            
            elseif ruleType == BingoRuleType.NewLockTiersRule then
                local rule = require("Combat.Machine.CalculateBingo.NewLockTiersRule")
                table.insert(this.BingoRule,rule)
                rule:Start(loadData, ruleData)
            elseif ruleType == BingoRuleType.RandomCollectTreasure then
                local rule = require("Combat.Machine.CalculateBingo.BisonRule")
                table.insert(this.BingoRule,rule)
                rule:Start(loadData, ruleData)
            elseif ruleType == BingoRuleType.HorseRacing then
                local rule = require("Combat.Machine.CalculateBingo.HorseRacingBingoRule")
                table.insert(this.BingoRule, rule)
                rule:Start(loadData, ruleData)
            elseif ruleType == BingoRuleType.ScratchWinner then
                local rule = require("Combat.Machine.CalculateBingo.ScratchWinnerBingoRule")
                table.insert(this.BingoRule, rule)
                rule:Start(loadData, ruleData)
            elseif ruleType == BingoRuleType.ChristmasSynthesis then
                local rule = require("Combat.Machine.CalculateBingo.ChristmasSynthesisRule")
                table.insert(this.BingoRule, rule)
                rule:Start(loadData, ruleData)
            elseif ruleType == BingoRuleType.Monopoly then
                local rule = require("Combat.Machine.CalculateBingo.MonopolyBingoRule")
                table.insert(this.BingoRule, rule)
                rule:Start(loadData, ruleData)
            end
        end
        if #this.BingoRule == 0 then this.BingoRule = nil end
    end
end


function CalculateBingoMachine:Stop()
    if this.BingoRule then
        for i = 1, #this.BingoRule do
            this.BingoRule[i]:Stop()
        end
    end
end

function CalculateBingoMachine:Pause(isPause)
    if this.BingoRule then
        for i = 1, #this.BingoRule do
            this.BingoRule[i]:Pause(isPause)
        end
    end
end

--- 计算是否出现bingo  盖章使用
---@param index
function CalculateBingoMachine.CalcuateBingo(cardId, cellIndex,...)
    if this.BingoRule then
        for i = 1, #this.BingoRule do
            this.BingoRule[i]:CalculateBingo(cardId,cellIndex,...)
        end
    end
    
    local options = ({ ... })[1]
    LuaTimer:SetDelayFunction(1, function()
        fun.SafeCall(options and options.onBingoShowComplete)
    end)
end

function CalculateBingoMachine.CalculateJackpot2(cardId, cellIndex,...)
    local args = ...
    table.each(this.BingoRule, function(rule)
        if rule["CalculateJackpot2"] then
            rule:CalculateJackpot2(cardId, cellIndex, args)
        end
    end)
end

function CalculateBingoMachine.GetBingoType(cardId)
    local ret
    table.each(this.BingoRule, function(rule)
        if not ret and rule["GetBingoType"] then
            ret = rule:GetBingoType(cardId)
        end
    end)
    return ret
end

--- 计算是否出现bingo  盖章使用
function CalculateBingoMachine.OnDataChange(cardId, cellIndex,...)
    if this.BingoRule then
        for i = 1, #this.BingoRule do
            this.BingoRule[i]:OnDataChange(cardId,cellIndex,...)
        end
    end
end

--- 计算是否出现wish,
function CalculateBingoMachine.CalculateWishByCard(cardId)
    if this.BingoRule then
        for i = 1, #this.BingoRule do
            this.BingoRule[i]:CalculateWishByCard(cardId)
        end
    end
end


function CalculateBingoMachine.GetTotalBingoCount(cardId)
    if this.BingoRule then
        local count = 0
        for i = 1, #this.BingoRule do
            count = count +   this.BingoRule[i]:GetTotalBingoCount(cardId)
        end
        return count
    end
end

---  提前计算_叫号是否能形成bingo_叫号机使用
function CalculateBingoMachine.PreCalculateBingo(num)
    if this.BingoRule then
        for i = 1, #this.BingoRule do
            this.BingoRule[i]:PreCalculateBingo(num)
        end
    end
end

function CalculateBingoMachine:BeBingoCell(cardId,cellIndex,cardNum)
    if this.BingoRule then
        for i = 1, #this.BingoRule do
            this.BingoRule[i]:BeBingoCell(cardId,cellIndex,cardNum)
        end
    end
end


--- 查询接口
function CalculateBingoMachine.SeekInfo(seekType, ...)
    if this.BingoRule then
        for i = 1, #this.BingoRule do
            return this.BingoRule[i]:SeekInfo(seekType,...)
        end
    end
end

--- 查询接口
function CalculateBingoMachine:SetInfo(seekType, ...)
    if this.BingoRule then
        for i = 1, #this.BingoRule do
            return this.BingoRule[i]:SetInfo(seekType,...)
        end
    end
end

---
function CalculateBingoMachine:CancelAllBingoCell(...)
    if this.BingoRule then
        for i = 1, #this.BingoRule do
            return this.BingoRule[i]:CancelAllBingoCell(...)
        end
    end
end

function CalculateBingoMachine:CheckNormalLineWish(cardId, cellIndex)
    if this.BingoRule then
        for i = 1, #this.BingoRule do
            if this.BingoRule[i].CheckNormalLineWish then
                return this.BingoRule[i]:CheckNormalLineWish(cardId, cellIndex)
            end
        end
    end
end

function CalculateBingoMachine.Register()
    Event.AddListener(EventName.Cell_Become_BingoCell,this.BeBingoCell)
end

function CalculateBingoMachine.UnRegister()
    Event.RemoveListener(EventName.Cell_Become_BingoCell,this.BeBingoCell)
end

return this
