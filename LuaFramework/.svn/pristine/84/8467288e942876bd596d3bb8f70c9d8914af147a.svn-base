---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/7 10:37
---
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/7 10:36
---
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/7 10:22
---

local SettleEvaluationView = BaseView:New('SettleEvaluationView','SettleAtlas');

local this = SettleEvaluationView;
this.auto_bind_ui_items = {
    "root",
    "Image",
    "Ima_game",
    "btn_speedUp",
}

local SHOW_TIME = 3.6
this.settleData = nil
this.model = nil

function SettleEvaluationView.Awake(obj)
    this:on_init()
    this:SetControlModel()
    this:OpenRound4()
end

function SettleEvaluationView.OnEnable()
    ModelList.BattleModel:GetCurrBattleView():ProvideBgToSettleView()
    Facade.SendNotification(NotifyName.CloseUI,ModelList.BattleModel:GetCurrBattleView())
end


function SettleEvaluationView.OnDisable()
    --log.r("SettleEvaluationView:on_close")
end


function SettleEvaluationView.OnDestroy()
    this:Destroy()
end

function SettleEvaluationView:SetControlModel()
    this.model = ModelList.BattleModel:GetCurrModel()
    this.settleData = this.model:GetSettleData()
    if this.model == nil then
        log.r("no  game battle model")
    end
end

--结算面板 阶段4  显示Round4
function SettleEvaluationView:OpenRound4()
    this:HandleRound4()
    this:StartCountdown4()
    --UISound.play("over_3")
end

--结算面板 阶段3处理
function SettleEvaluationView:HandleRound4()
    local img = this.Image
    local self_nickname = "0"-- ModelList.PlayerInfoModel.my_info.nickname
    local isTopThree = false
    
    if this.settleData.ranks ~= nil then 
        for i = 1, #this.settleData.ranks do
            local rank = this.settleData.ranks[i].rank
            --local obj = fun.find_child(this.GameOverRound3,"SettleHead"..rank)
            if rank == 1 and this.settleData.ranks[i].nickName == self_nickname then
                img.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "GgFont2")
                this.Ima_game.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "GgFont2Game2")
                isTopThree = true
                break
            elseif rank == 2 and this.settleData.ranks[i].nickName == self_nickname then
                img.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "GgFont1")
                this.Ima_game.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "GgFont1Game1")
                isTopThree = true
                break
            elseif rank == 3 and this.settleData.ranks[i].nickName == self_nickname then
                img.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "GgFont3")
                this.Ima_game.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "GgFont3Game3")
                isTopThree = true
                break
            end
        end
    else 
        log.r("this.settleData.ranks is nil ")
    end

    img:SetNativeSize()
    this.Ima_game:SetNativeSize()

    if isTopThree then
        this.root:Play("goodgamewin")
    end
    UISound.play("settlement_skip")

    this:initSpeedUp()
end


function SettleEvaluationView:StartCountdown4()
    this.timerId4 = LuaTimer:SetDelayFunction(SHOW_TIME, function()
        this:StopCountdown4()
        ViewList.GameSettleView:JumpNextView()
        Facade.SendNotification(NotifyName.HideUI, ViewList.SettleEvaluationView)
    end, false,LuaTimer.TimerType.BattleUI)
    this:CoroutinePreLoad()
end

function SettleEvaluationView:CoroutinePreLoad()
   this.coroutine =   coroutine.start(function()
        WaitForFixedUpdate()
        if this.settleData and this.settleData.hasJokerMoreCoins then
            Cache.load_prefabs(AssetList["clown_doublejiesuan"],"clown_doublejiesuan",nil,true)
        end
        WaitForEndOfFrame()

       local cardMapObj = ModelList.BattleModel:GetCurrBattleView():GetCardMapsObject()
       if cardMapObj and #cardMapObj > 0 then
           for i = 1, #cardMapObj do
               if  fun.is_not_null(cardMapObj[i]) then
                   --- 遍历cardMapObj的子物体，除jackpot特效，其他都销毁
                   for j = cardMapObj[i].transform.childCount,1,-1  do
                       if fun.is_not_null(cardMapObj[i]) and fun.is_not_null(cardMapObj[i].transform) then
                           if cardMapObj[i].transform.childCount> j -1 then
                               local child = cardMapObj[i].transform:GetChild(j-1)
                               if  fun.is_not_null(child)  and not string.find(child.name,"ackpot") then
                                   Destroy(child)
                                   WaitForEndOfFrame()
                               end
                           end
                       else
                           break
                       end
                   end
               else
                   break
               end
           end
       end

        --- 清理特效池
        GoPool.destroy_go_pool_dic()
       this.coroutine = nil
    end)
end

function SettleEvaluationView:StopCountdown4()
    if this.timerId4 then
        LuaTimer:Remove(this.timerId4,LuaTimer.TimerType.BattleUI)
        this.timerId4 = nil
    end
    if this.coroutine then
        coroutine.stop(this.coroutine)
        this.coroutine = nil
    end
    GoPool.stop_destroy_go_pool_dic()
end

function SettleEvaluationView:initSpeedUp()
    if ModelList.GuideModel.IsFirstBattle() then 
        fun.set_active(self.btn_speedUp,false)
        return 
    end 

    local flag = ViewList.GameSettleView:GetSpeedUp()
    local on = fun.find_child(self.btn_speedUp,"on")
    local off =  fun.find_child(self.btn_speedUp,"off")
    if flag == false then --加速状态
        fun.set_active(on,true)
        fun.set_active(off,false)
        ViewList.GameSettleView:SetSpeedUp(1.5)
    end 
end

function SettleEvaluationView:on_btn_speedUp_click()
    local flag =  ViewList.GameSettleView:SpeedUp(1.5)
    local on = fun.find_child(self.btn_speedUp,"on")
    local off =  fun.find_child(self.btn_speedUp,"off")

    if flag then 
        fun.set_active(on,false)
        fun.set_active(off,true)
    else 
        fun.set_active(on,true)
        fun.set_active(off,false)
    end 
end

return this

