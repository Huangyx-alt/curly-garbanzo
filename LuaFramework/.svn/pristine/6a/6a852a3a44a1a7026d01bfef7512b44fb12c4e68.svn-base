---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/7/5 19:22
---
---@see 准备界面
---@class Ready : BaseDialogView
local ReadyView = BaseDialogView:New()
local this = ReadyView
this.__index = this
this.viewType = CanvasSortingOrderManager.LayerType.Machine_Dialog
this.auto_bind_ui_items = {
    "img_countdown",
    "root",
    --开局氛围
    "head1", --头像
    "item1", --头像
    "atmosphere",
    "headtiao",
    "headCount",
    "countText",
    "BingosiLeftBig",
    "myhead",--我自己 的头像
    "competition",--我自己 的头像
    "BigHead",
    "jokerPos",

    "Img_getReady",
    "light1",
    "light2",
    "full_screen1",
    "light3",
    "light4",
    "full_screen2",
    "light5",
    "light6",
    "full_screen3",
}
local headItemList  = {}
local headImageList = {}
this.can_start_num_inscrease = false
this.can_start_power_fly = false
this.power_up_card = 0
this.maxCount = 0

local IsPlayReady = false

function ReadyView.Awake()
    --Facade.RegisterView(this)
    this:on_init()
    LuaTimer:Clear(LuaTimer.TimerType.UI)
end

local InitEnableTimeContent = function()
    local countdowns = Csv.GetData("control",34,"content")
    if ModelList.GuideModel:IsFirstBattle() then
        countdowns = {{3}}
    end
    this.img_countdown.text = countdowns[1][1]
end


function ReadyView.OnEnable(self, params)
    this.params = params or {}
    this.can_start_num_inscrease = false
    this.can_start_power_fly = false
    IsPlayReady = false
    this.update_x_enabled = true
    this:start_x_update()
    InitEnableTimeContent()
    this.Register()
    this.gameTable = ModelList.GameModel:GetAllRobots()
    
    this:StartJoinFun()
    this:StartCompetitionRank()
    this:ReplaceJokerSkin()
end

local StartPlayReady = function()
    this.StartCountdown()
    UISound.play("city1loadingover")
    --Event.Brocast(Notes.CLEAR_DELAY_TIMMER)
    LuaTimer:SetDelayFunction(MCT.DelayPlayWhipse,function()
        UISound.play_loop("whisper")
    end,nil,LuaTimer.TimerType.Battle)
end


function ReadyView:on_x_update()
    if not IsPlayReady then
        local stateInfo = this.root:GetCurrentAnimatorStateInfo(0)
        if  ( stateInfo:IsName("time_start") or stateInfo:IsName("time_start2")  or  stateInfo:IsName("time_idle") )  and  stateInfo.normalizedTime>0.95 then
            IsPlayReady = true
            StartPlayReady()
        end
    end
end


function ReadyView.StartCountdown()
    local countdowns = Csv.GetData("control",34,"content")
    if ModelList.GuideModel:IsFirstBattle() then
        countdowns = {{3}}
        this.img_countdown.text = countdowns[1][1]
    end
    this.countdown = tonumber(countdowns[1][1])
    local  cards = ModelList.BattleModel:GetCurrModel():GetPowerUps()
    this.power_up_card = #cards
    this.timerId = LuaTimer:SetDelayLoopFunction(0,1,-1, function()
        if this.countdown and this.countdown > 0 then
            this.img_countdown.text = this.countdown
            local ani = fun.get_component(this.img_countdown.gameObject,fun.ANIMATOR)
            ani:Play("GetReady_Count1")
            UISound.play("countdown")
            if   this.countdown == 5 then
                --this:UnloadLobby(1)
            end
            if  this.countdown == 3 then
                --this:UnloadLobby(2)
                UISound.tween_out_music("whisper.mp3", 2, 1, 0.7, nil)
            end
            if this.countdown == 2 then
                this:StartBgm()
                if this.params and this.params.onBattleStart then
                    fun.SafeCall(this.params.onBattleStart)
                else
                    Event.Brocast(EventName.CardEffect_Enter_Effect)
                    Facade.SendNotification(NotifyName.Bingo.StartBingosleftIncrease)
                    LuaTimer:SetDelayFunction(0.7,function()
                        Event.Brocast(Notes.START_POWERUP_ENABLE)
                    end,nil,LuaTimer.TimerType.Battle)
                end
            end
            if this.countdown == 1 then
                if this.params and this.params.onBattleStart then
                else
                    Event.Brocast(EventName.CardEffect_Drop_All_Cell_Item)
                end
            end
            this.countdown = this.countdown - 1
        else
            this.StopCountdown()
            if this.countdown <= 0 then
                Event.Brocast(Notes.BINGO_TIME_COUNT_OVER)
            end
            this:Exit()
        end
    end,nil, nil,LuaTimer.TimerType.Battle)
end

function ReadyView.StopCountdown()
    if this.timerId then
        LuaTimer:Remove(this.timerId)
        this.timerId = nil
    end
end


function ReadyView:StartBgm()
    coroutine.start(function()
        local playId = ModelList.CityModel.GetPlayIdByCity()
        local city_music =  Csv.GetData("city_play",playId,"music")
        if ModelList.BattleModel.GetIsJokerMachine() or ModelList.CityModel:IsMaxBetRate() then
            city_music =  Csv.GetData("city_play",playId,"maxbet_music")
        end
        UISound.play_bgm(city_music)
        WaitForFixedUpdate()
        UISound.set_bgm_volume(0.7)
        WaitForEndOfFrame()
        UISound.max_fade_in_bgm()
    end)
end

function ReadyView:UnloadLobby(unloadType)
    local lobby = require("Logic.Bundle.UnloadLobbyBundle")
    lobby:StartUnload()
end

function ReadyView:UnloadBattleReady()
    UISound.unload_sound_data_in_need(1)
end

function ReadyView:on_close()
    this.StopCountdown()
    this.UnRegister()
    this.count = nil
    this:UnloadLobby()
    --- 3s后卸载准备界面资源
    LuaTimer:SetDelayFunction(3,function()
        local sceneName  =  fun.get_active_scene().name
        if ModelList.BattleModel:IsGameing()  and sceneName~="SceneHome"   then
            this:UnloadBattleReady()
        end
    end,nil,LuaTimer.TimerType.Battle)
end

function ReadyView:Exit()
    this.root:Play("time_end")
    if this.delay_show then
        LuaTimer:Remove(this.delay_show)
        this.delay_show = nil
    end
    LuaTimer:SetDelayFunction(0.5,function()
        Facade.SendNotification(NotifyName.CloseUI,ViewList.ReadyView)
    end,nil,LuaTimer.TimerType.Battle)
    LuaTimer:SetDelayFunction(1,function()
        ModelList.BattleModel:GetCurrBattleView():SetReadyForPreUseItem(5)
        --Facade.SendNotification(NotifyName.CloseUI,ViewList.ReadyView)
        if this.params and this.params.onBattleStart then

        else
            Event.Brocast(EventName.Event_Preload_Bingo_Effect)
        end
    end,nil,LuaTimer.TimerType.Battle)
end

function ReadyView:StartJoinFun()
    fun.set_active(self.atmosphere,true)
    local avatarAndFrameViewCode = require "View/PlayerInfoSysView/PlayerInfoUpdateAvatarAndFrame"
    local avatarAndFrameView = avatarAndFrameViewCode:New()
    avatarAndFrameView:SkipLoadShow(self.BigHead)
    avatarAndFrameView:SetPlayerSelf()
    
    this.maxCount = ModelList.GuideModel:IsFirstBattle() and 5 or #this.gameTable 
    this.maxCount = this.maxCount -1 
    headItemList = {}
    headImageList = {}
    this:StartJoinAni()
 
     LuaTimer:SetDelayFunction(1, function()
        this:StartJoinAni()
     end)
end 

--开始递归播放动画
function ReadyView:StartJoinAni() 

    if not this.count then 
        this.count = this.maxCount
        this.BingosiLeftnum = 0
        self.BingosiLeftBig.text =0 
        
        if ModelList.GuideModel:IsFirstBattle() ==false then 
            local countN = Csv.GetControlByName("gambit_number")
            if countN then 
                local tmpCount =  math.random(countN[1][1], countN[1][2])
                this.count =  this.count - tmpCount <= 0 and 0 or this.count - tmpCount
                this.BingosiLeftnum = 4
                self.BingosiLeftBig.text = this.BingosiLeftnum 
            end 
       
        end 
    
    end 

    if this.count <= 0 then 
        return 
    end     
    --fun.get_instance(self.item1,self.headtiao)--
    local HeadItem = self:GetHeadItemInstance()
    local refSmallHeadItem = fun.get_component(HeadItem, fun.REFER)
    local HeadImage = nil
    if refSmallHeadItem then
        local namtTxt =  refSmallHeadItem:Get("Name")
        local imageFrameUp =  refSmallHeadItem:Get("imageFrame")
        local headBgSp = refSmallHeadItem:Get("head")
        local data = Csv.GetData("robot_name", this.gameTable[this.count], "icon")
        local namestr =  Csv.GetData("robot_name", this.gameTable[this.count], "name")
        HeadImage = self:GetheadImageInstance() --fun.get_instance(self.head1,self.headCount)
        local refRightHeadImage = fun.get_component(HeadImage, fun.REFER)
        local headBgSp2 =  refRightHeadImage:Get("imgHead")
        local imageFrameRight =  refRightHeadImage:Get("imageFrame")



        if not headBgSp then
            return
        end
       
        if data then
            local sysModel = ModelList.PlayerInfoSysModel
            sysModel:LoadTargetHeadSprite(data, headBgSp)
            sysModel:LoadTargetHeadSprite(data, headBgSp2)

            sysModel:LoadRobotTargetFrameSprite(this.gameTable[this.count], imageFrameUp)
            sysModel:LoadRobotTargetFrameSprite(this.gameTable[this.count], imageFrameRight)
        end

        namtTxt.text = namestr
    end
    local animator = fun.get_component(HeadItem,fun.ANIMATOR)
    local tmpCount = this.count
    local FirstBattle =  ModelList.GuideModel:IsFirstBattle()

    AnimatorPlayHelper.SetAnimationEvent(animator,"item1",function()
        if tmpCount <= 0 then 
            return 
        end 

        fun.set_active(HeadItem,false)
        table.insert(headItemList,HeadItem);

        --播放另一个动画
        fun.set_active(HeadImage,true)
        local HeadImageAni = fun.get_component(HeadImage,fun.ANIMATOR)
        AnimatorPlayHelper.Play(HeadImageAni,{"head1","head1"},false,function()
            fun.set_active(HeadImage,false)
            table.insert(headImageList,HeadImage);
        end)

        tmpCount = tmpCount <= 0 and 0 or tmpCount
        self.countText.text = "x"..(this.maxCount -  tmpCount ) 
     
        local random =FirstBattle and math.random(1, 3) or math.random(4, 5)

        if this.countdown ~= nil and  this.countdown <= 4 then 
            random = FirstBattle and math.random(1, 3) or math.random(5, 7)

            this.BingosiLeftnum = this.BingosiLeftnum  +1
            self.BingosiLeftBig.text = this.BingosiLeftnum 

            LuaTimer:SetDelayFunction(0.1 * random, function()
                self:StartJoinAni() 
            end,nil,LuaTimer.TimerType.Battle)
        else 
            this.BingosiLeftnum = this.BingosiLeftnum +1
            self.BingosiLeftBig.text = this.BingosiLeftnum 

            LuaTimer:SetDelayFunction(0.1 * random *2, function()
                self:StartJoinAni() 
            end,nil,LuaTimer.TimerType.Battle)

            LuaTimer:SetDelayFunction(0.1 * random *4, function()
                self:StartJoinAni() 
            end,nil,LuaTimer.TimerType.Battle)
        end 
       
        if  tmpCount == 1 then 
            this.delay_show =   LuaTimer:SetDelayFunction(0.8, function()
                if not  fun.is_null( self.atmosphere)  then
                    this.delay_show  =nil
                    self.atmosphere:Play("out")
                    self.countText.text = "x"..(this.maxCount +1) 
                    self.BingosiLeftBig.text = tostring(ModelList.BattleModel:GetCurrModel():LoadGameData().bingoLeft) 
                end 
            end,nil,LuaTimer.TimerType.Battle)
        end 

    end)

    this.count = this.count- 1
    fun.set_active(HeadItem,true)
    AnimatorPlayHelper.Play(animator,{"in","item1"},false,function()
    end)
end

function ReadyView:GetHeadItemInstance()
    local item = nil 
    if headItemList then 
        local index = -1;
        for k,v in pairs(headItemList) do 
            if v ~= nil then 
                item = v
                index = k;
            end 
        end 

        if index ~= -1 then 
            table.remove( headItemList, index)
        end 
    end 

    if not item then 
        item = fun.get_instance(self.item1,self.headtiao)
    end 

    return item
end 

function ReadyView:GetheadImageInstance()
    local item = nil 
    if headImageList then 
        local index = -1;
        for k,v in pairs(headImageList) do 
            if v ~= nil then 
                item = v
                index = k;
            end 
        end 

        if index ~= -1 then 
            table.remove( headImageList, index)
        end 
    end 

    if not item then 
        item = fun.get_instance(self.head1,self.headCount)
    end 

    return item
end 

---开始日榜入场
function ReadyView:StartCompetitionRank()
    local dependentFile = require("View.DailyCompetition.CompetitionDependentFile")
    local info = dependentFile:GetDenpendentInfo()

    --if self.competition and info and info.readyViewName then
    --    self.root:Play("time_start2")
    --    Cache.load_prefabs(AssetList[info.readyViewName],info.readyViewName,function(obj)
    --        if obj then
    --            local go = fun.get_instance(obj,self.competition)
    --            if go then
    --                local CompetitionReadyView = require(info.readyViewPath)
    --                self.comptition_view = CompetitionReadyView:New()
    --                self.comptition_view:SkipLoadShow(go)
    --                --fun.set_gameobject_pos(go,0,0,0,true)
    --                fun.set_rect_local_pos_y(go,0)
    --            end
    --        end
    --    end)
    --end
end

--- 小丑机台换主题
function ReadyView:ReplaceJokerSkin()
    if ModelList.BattleModel.GetIsJokerMachine() then
        SetJokerSkin(self.light1,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light2,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light3,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light4,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light5,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light6,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.full_screen1,"JokerBattleAtlas","Pfullscreen")
        SetJokerSkin(self.full_screen2,"JokerBattleAtlas","Pfullscreen")
        SetJokerSkin(self.full_screen3,"JokerBattleAtlas","Pfullscreen")
        SetJokerSkin(self.Img_getReady,"JokerBattleAtlas","PfullscreenReady")
    end
end

function ReadyView.New()
    local o = {}
    setmetatable(o, ReadyView)
    o.__index = o
    return o;
end

function ReadyView.StartTimeDown()

end

function ReadyView.Register()
    Event.AddListener(EventName.Guide_Allow_Time_Down,this.StartTimeDown)
end

function ReadyView.UnRegister()
    Event.RemoveListener(EventName.Guide_Allow_Time_Down,this.StartTimeDown)
end


return this

