---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2024/4/2 11:00
---
--�����buff���?
local GiftPackBaseView = require("View.GiftPack.GiftPackBaseView")
---@class  GiftPackSeasonPowerUpView: GiftPackBaseView
local GiftPackSeasonPowerUpView = GiftPackBaseView:New('GiftPackSeasonPowerUpView')
local this = GiftPackSeasonPowerUpView
this.viewType = CanvasSortingOrderManager.LayerType.TopConsole
this.isCleanRes = true
this._cleanImmediately = true

local GiftPackEnterState = require("View.GiftPack.State.GiftPackEnterState")
local GiftPackShowState = require("View.GiftPack.State.GiftPackShowState")
local GiftPackExitState = require("View.GiftPack.State.GiftPackExitState")
local GiftPackTransState = require("View.GiftPack.State.GiftPackTransState")

local data =  nil
local product_list = {}
local canUpBuy = true
local canDownBuy = true
local click_interval = 0.5
local _DeloopTimer = nil

local remainTimeCountDown = RemainTimeCountDown:New()

this.auto_bind_ui_items = {
    "all_time",
    "firstPuItem",
    "secondPuItem",
    "thirdPuItem",
    "btn_close",
    "left_time",
    "center_time",
    "right_time",
    "btn_left_buy",
    "btn_center_buy",
    "btn_right_buy",
    "setactivePos",
    "firstIcon",
    "secondIcon",
    "thirdIcon",
}

this.isBuy = {}  -- 购买礼包成功 or 失败

function GiftPackSeasonPowerUpView:Awake()
    this:on_init()
    self._isInit = true
    this.isBuy.isBuySucc = false
    --- �޸����ֻ����״ν�����治��ʾ����?
    self.setPos = true
    self.onePosX = fun.GetGameObjectLocalX(self.firstPuItem)
    self.twoPosX = fun.GetGameObjectLocalX(self.secondPuItem)
    data =  nil
    self:ShowDetailGift()
end

function GiftPackSeasonPowerUpView:BuildFsm(owner)
    FsmCreator:Create("GiftPackSeasonPowerUpView",owner,{
        GiftPackEnterState:New(),
        GiftPackShowState:New(),
        GiftPackExitState:New(),
        GiftPackTransState:New(),
    })
    this.state = {
        GiftPackEnterState = "GiftPackEnterState",
        GiftPackShowState = "GiftPackShowState",
        GiftPackExitState = "GiftPackExitState",
        GiftPackTransState = "GiftPackTransState",
    }
    owner._fsm:StartFsm(this.state.GiftPackEnterState,owner)
end

function GiftPackSeasonPowerUpView.OnEnable()
    this:BuildFsm(this)
    this:Bi_Tracker()
end

function GiftPackSeasonPowerUpView:on_x_update()
end

function GiftPackSeasonPowerUpView:ShowDetailGift()
    if self._isInit then
        data = ModelList.GiftPackModel:GetShowGiftPack()
        local istrue = ModelList.GiftPackModel:CheckPUHaveFreePack()
        self:UpdateGiftPUCardIcon()
        if data then
            this:CollectProduct(data.pId, data.giftInfo)
            if data.giftInfo[1].canBuyCount > 0 then
                this:SetLeftProduct(product_list[1])
            else
                if self.setPos == true then
                    fun.set_rect_anchored_position_x(self.firstPuItem,fun.GetTransformLocalX(self.setactivePos))
                    fun.set_rect_anchored_position_x(self.secondPuItem,self.onePosX)
                    fun.set_rect_anchored_position_x(self.thirdPuItem,self.twoPosX)
                end      
            end
            if data.giftInfo[2].canBuyCount > 0 then
                this:SetCenterProduct(product_list[2])
            else
                if self.setPos == true then
                    fun.set_rect_anchored_position_x(self.firstPuItem,fun.GetTransformLocalX(self.setactivePos))
                    fun.set_rect_anchored_position_x(self.secondPuItem,fun.GetTransformLocalX(self.setactivePos))
                    fun.set_rect_anchored_position_x(self.thirdPuItem,self.onePosX)
                end
            end
            if data.giftInfo[3].canBuyCount > 0 then
                this:SetRightProduct(product_list[3])
            else
                Destroy(self.thirdPuItem)
            end
            self.setPos = false
            self:SetLeftTime(data.giftInfo[1].expireTime)
        end
    else
        self._reshowAfterInit = true
    end
end

function GiftPackSeasonPowerUpView:UpdateGiftPUCardIcon()
    local cardId = ModelList.CityModel:GetPuBuffCardId()
    local powerCard = Csv.GetData("new_powerup",cardId)
    log.log("PU CardId and powerCard",cardId,powerCard)
    if powerCard then
        self.firstIcon.sprite = AtlasManager:GetSpriteByName("ItemAtlas",powerCard[6])
        self.secondIcon.sprite = AtlasManager:GetSpriteByName("ItemAtlas",powerCard[6])
        self.thirdIcon.sprite = AtlasManager:GetSpriteByName("ItemAtlas",powerCard[6])
    else
        log.log("powerCard is nil")
    end
end

function GiftPackSeasonPowerUpView:SetLeftTime(endTimeStamp)
    local start_time = ModelList.PlayerInfoModel.get_cur_server_time()
    local endTime = endTimeStamp - start_time
    if not remainTimeCountDown then
        remainTimeCountDown = RemainTimeCountDown:New()
    end
    remainTimeCountDown:StartCountDown(CountDownType.cdt2,endTime,self.all_time,function()
        self:CloseFunc()
        Event.Brocast(EventName.Event_Gift_Update)
    end)
end

function GiftPackSeasonPowerUpView:ClearCountDown()
    if remainTimeCountDown then
        remainTimeCountDown:StopCountDown()
        remainTimeCountDown = nil
    end
end

function GiftPackSeasonPowerUpView:CollectProduct(pId, giftInfo)
    product_list = {}
    for _, v in pairs(Csv.pop_up) do
        if pId == v.gift_id then
            for i = 1, #giftInfo do
                if giftInfo[i].id == _ then
                    table.insert(product_list, v.id)
                    break
                end
            end
        end
    end
    table.sort(product_list)
end

function GiftPackSeasonPowerUpView.GetItemOrResource(id, param)
    return  Csv.GetData("resources", id, param), "ItemAtlas"
end

function GiftPackSeasonPowerUpView:SetLeftProduct(id)
    local xls = Csv.GetData("pop_up", id) 
    this:SetContent(xls.item_description[3][1], self.left_time, xls.item_description[3][2])

    local long = #xls.item_description

    local oneItem = fun.find_child(self.firstPuItem,"firstGift1")
    if long >= 1 then 
        local item1 = xls.item_description[1][1]
        if item1 then 
            local oneIcon = fun.get_component(fun.get_child(oneItem,0),fun.IMAGE)
            local icon1, atlasName = self.GetItemOrResource(tonumber(item1), "icon")
            oneIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
            local oneText = fun.get_component(fun.get_child(oneItem,1),fun.OLDTEXT)
            this:SetContent(item1, oneText, xls.item_description[1][2])
            
        end
    else
        fun.set_active(oneItem,false)
    end
    
    local twoItem = fun.find_child(self.firstPuItem,"firstGift2")
    if long >= 2 then
        local item2 = xls.item_description[2][1]
        if item2 then
            local twoIcon = fun.get_component(fun.get_child(twoItem,0),fun.IMAGE)
            local icon1, atlasName = self.GetItemOrResource(tonumber(item2), "icon")
            twoIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
            local oneText = fun.get_component(fun.get_child(twoItem,1),fun.OLDTEXT)
            this:SetContent(item2, oneText, xls.item_description[2][2])
        end
    else
        fun.set_active(twoItem,false)
    end
    
    local threeItem = fun.find_child(self.firstPuItem,"firstGift3")
    if long >= 4 then
        local item4 = xls.item_description[4][1]
        if item4 then
            local threeIcon = fun.get_component(fun.get_child(threeItem,0),fun.IMAGE)
            local icon1, atlasName = self.GetItemOrResource(tonumber(item4), "icon")
            threeIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
            local oneText = fun.get_component(fun.get_child(threeItem,1),fun.OLDTEXT)
            this:SetContent(item4, oneText, xls.item_description[4][2])
        end
    else
        fun.set_active(threeItem,false)
    end
    
    local fourItem = fun.find_child(self.firstPuItem,"firstGift4")
    if long >= 5 then
        local item5 = xls.item_description[5][1]
        if item5 then
            local fourIcon = fun.get_component(fun.get_child(fourItem,0),fun.IMAGE)
            local icon1, atlasName = self.GetItemOrResource(tonumber(item5), "icon")
            fourIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
            local oneText = fun.get_component(fun.get_child(fourItem,1),fun.OLDTEXT)
            this:SetContent(item5, oneText, xls.item_description[5][2])
        end
    else
        fun.set_active(fourItem,false)
    end
    
    local btn_left_text = fun.get_component(fun.get_child(self.btn_left_buy,0),fun.OLDTEXT)
    if xls.price == "0" then 
        btn_left_text.text = "Free"
    else
        btn_left_text.text = "$" .. xls.price
    end

end

function GiftPackSeasonPowerUpView:SetCenterProduct(id)
    local xls = Csv.GetData("pop_up", id) 
    this:SetContent(xls.item_description[3][1], self.center_time, xls.item_description[3][2])
    
    local long = #xls.item_description

    local item1 = xls.item_description[1][1]
    local oneItem = fun.find_child(self.secondPuItem,"secondGift1")
    if item1 then 
        local oneIcon = fun.get_component(fun.get_child(oneItem,0),fun.IMAGE)
        local icon1, atlasName = self.GetItemOrResource(tonumber(item1), "icon")
        oneIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
        local oneText = fun.get_component(fun.get_child(oneItem,1),fun.OLDTEXT)
        this:SetContent(item1, oneText, xls.item_description[1][2])
    else
        fun.set_active(oneItem,false)
    end
    
    local item2 = xls.item_description[2][1]
    local twoItem = fun.find_child(self.secondPuItem,"secondGift2")
    if item2 then
        local twoIcon = fun.get_component(fun.get_child(twoItem,0),fun.IMAGE)
        local icon1, atlasName = self.GetItemOrResource(tonumber(item2), "icon")
        twoIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
        local oneText = fun.get_component(fun.get_child(twoItem,1),fun.OLDTEXT)
        this:SetContent(item2, oneText, xls.item_description[2][2])
    else
        fun.set_active(twoItem,false)
    end

    local threeItem = fun.find_child(self.secondPuItem,"secondGift3")
    if long >= 4 then
        local item4 = xls.item_description[4][1]
        if item4 then
            local threeIcon = fun.get_component(fun.get_child(threeItem,0),fun.IMAGE)
            local icon1, atlasName = self.GetItemOrResource(tonumber(item4), "icon")
            threeIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
            local oneText = fun.get_component(fun.get_child(threeItem,1),fun.OLDTEXT)
            this:SetContent(item4, oneText, xls.item_description[4][2])
        end
    else
        fun.set_active(threeItem,false)
    end
    
    local fourItem = fun.find_child(self.secondPuItem,"secondGift4")
    if long >= 5 then
        local item5 = xls.item_description[5][1]
        if item5 then
            local fourIcon = fun.get_component(fun.get_child(fourItem,0),fun.IMAGE)
            local icon1, atlasName = self.GetItemOrResource(tonumber(item5), "icon")
            fourIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
            local oneText = fun.get_component(fun.get_child(fourItem,1),fun.OLDTEXT)
            this:SetContent(item5, oneText, xls.item_description[5][2])
        end
    else
        fun.set_active(fourItem,false)
    end

    local btn_center_text = fun.get_component(fun.get_child(self.btn_center_buy,0),fun.OLDTEXT)
    if xls.price == "0" then 
        btn_center_text.text = "Free"
    else
        btn_center_text.text = "$" .. xls.price
    end

end

function GiftPackSeasonPowerUpView:SetRightProduct(id)
    local xls = Csv.GetData("pop_up", id) 
    this:SetContent(xls.item_description[3][1], self.right_time, xls.item_description[3][2])
 
    local long = #xls.item_description

    local item1 = xls.item_description[1][1]
    local oneItem = fun.find_child(self.thirdPuItem,"thirdGift1")
    if item1 then 
        local oneIcon = fun.get_component(fun.get_child(oneItem,0),fun.IMAGE)
        local icon1, atlasName = self.GetItemOrResource(tonumber(item1), "icon")
        oneIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
        local oneText = fun.get_component(fun.get_child(oneItem,1),fun.OLDTEXT)
        this:SetContent(item1, oneText, xls.item_description[1][2])
    else
        fun.set_active(oneItem,false)
    end

    local item2 = xls.item_description[2][1]
    local twoItem = fun.find_child(self.thirdPuItem,"thirdGift2")
    if item2 then
        local twoIcon = fun.get_component(fun.get_child(twoItem,0),fun.IMAGE)
        local icon1, atlasName = self.GetItemOrResource(tonumber(item2), "icon")
        twoIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
        local oneText = fun.get_component(fun.get_child(twoItem,1),fun.OLDTEXT)
        this:SetContent(item2, oneText, xls.item_description[2][2])
    else
        fun.set_active(twoItem,false)
    end

    local threeItem = fun.find_child(self.thirdPuItem,"thirdGift3")
    if long >= 4 then 
        local item4 = xls.item_description[4][1]
        if item4 then
            local threeIcon = fun.get_component(fun.get_child(threeItem,0),fun.IMAGE)
            local icon1, atlasName = self.GetItemOrResource(tonumber(item4), "icon")
            threeIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
            local oneText = fun.get_component(fun.get_child(threeItem,1),fun.OLDTEXT)
            this:SetContent(item4, oneText, xls.item_description[4][2])
        end
    else
        fun.set_active(threeItem,false)
    end

    local fourItem = fun.find_child(self.thirdPuItem,"thirdGift4")
    if long >= 5 then
        local item5 = xls.item_description[5][1]
        if item5 then
            local fourIcon = fun.get_component(fun.get_child(fourItem,0),fun.IMAGE)
            local icon1, atlasName = self.GetItemOrResource(tonumber(item5), "icon")
            fourIcon.sprite = AtlasManager:GetSpriteByName(atlasName, icon1)
            local oneText = fun.get_component(fun.get_child(fourItem,1),fun.OLDTEXT)
            this:SetContent(item5, oneText, xls.item_description[5][2])  
        end
    else
        fun.set_active(fourItem,false)
    end
    
    local btn_right_text = fun.get_component(fun.get_child(self.btn_right_buy,0),fun.OLDTEXT)
    if xls.price == "0" then 
        btn_right_text.text = "Free"
    else
        btn_right_text.text = "$" .. xls.price
    end

end


function GiftPackSeasonPowerUpView:SetContent(id, txt, content)
    id = tonumber(id)
    if fun.is_null(txt) then
        return
    end
    if id == 35 or id == 36 or id == 902202 or id == 39 then
        txt.text = fun.FormatTextToTime(content)
    else
        txt.text = fun.format_number((content))
    end
end

function GiftPackSeasonPowerUpView.OnDisable()
    this:stop_x_update()
    --self:ClearCountDown()
end

function GiftPackSeasonPowerUpView.OnDestroy()
    this:Destroy()
end

function GiftPackSeasonPowerUpView:on_close()
    this:stop_x_update()
end

function GiftPackSeasonPowerUpView:CloseFunc()
    self:ClearCountDown()
    ModelList.GiftPackModel:CloseSpecialView()
    Facade.SendNotification(NotifyName.HideDialog, this)
end

function GiftPackSeasonPowerUpView:CutDonwTarget()
    this:CloseFunc()
    this.main_effect:Play("end")
end

function GiftPackSeasonPowerUpView:on_btn_close_click()
    ModelList.GiftPackModel:CloseSpecialView()
    if this._fsm:GetCurName() == "GiftPackShowState" then
        return
    end
    if this.loopTime then
        LuaTimer:Remove(this.loopTime)
        this.loopTime = nil
    end
    -- self:ClearCountDown()
    Facade.SendNotification(NotifyName.HideUI, self)
    Facade.SendNotification(NotifyName.PowerUps.PowerUpBuffGifttPackClose,this.isBuy)
end

this.last_click_time1 = 0
function GiftPackSeasonPowerUpView:on_btn_left_buy_click()
    if this._fsm:GetCurName() ~= "GiftPackEnterState" then return end
    if canUpBuy then
        local click_time = UnityEngine.Time.time
        if click_time - this.last_click_time1 > click_interval then
            ModelList.GiftPackModel:ReqEditorBuySucess(data.pId,product_list[1])
            this.last_click_time1 = UnityEngine.Time.time
        end
    else
        UIUtil.show_common_popup(8020,true)
    end
end

this.last_click_time2 = 0
function GiftPackSeasonPowerUpView:on_btn_center_buy_click()
    if this._fsm:GetCurName() ~= "GiftPackEnterState" then return end
    if canDownBuy then
        local click_time = UnityEngine.Time.time
        if click_time - this.last_click_time2 > click_interval then
            ModelList.GiftPackModel:ReqEditorBuySucess(data.pId,product_list[2])
            this.last_click_time2 = UnityEngine.Time.time
        end
    else
        UIUtil.show_common_popup(8020,true)
    end
end

this.last_click_time3 = 0
function GiftPackSeasonPowerUpView:on_btn_right_buy_click()
    if this._fsm:GetCurName() ~= "GiftPackEnterState" then return end
    if canDownBuy then
        local click_time = UnityEngine.Time.time
        if click_time - this.last_click_time3 > click_interval then
            ModelList.GiftPackModel:ReqEditorBuySucess(data.pId,product_list[3])
            this.last_click_time3 = UnityEngine.Time.time
        end
    else
        UIUtil.show_common_popup(8020,true)
    end
end

function GiftPackSeasonPowerUpView:CloseUIShiny(obj)
    local uishiny = fun.get_component(obj,"UIShiny")
    if uishiny then
        uishiny.enabled = false
    end
end

function GiftPackSeasonPowerUpView:OnBuySuccess(needClose,itemData)
    local data = ModelList.GiftPackModel:GetShowGiftPack()
    local PUPrice = Csv.GetData("pop_up",itemData.id,"price")
    this:ChangeState(this,"GiftPackShowState",itemData)
    this.isBuy.isBuySucc = true
    if data then
        if PUPrice == "0" then
            self:MoveItem(1)
            log.log("buy free puGift")
        else
            if data.giftInfo[2].canBuyCount <= 0 then
                self:MoveItem(2)
            elseif data.giftInfo[3].canBuyCount <= 0 then
                return
            end
        end
    end
end

function GiftPackSeasonPowerUpView:MoveItem(type)
    local flyTime = 0.5
    if type == 1 then
        Anim.move_to_x(self.firstPuItem, fun.GetTransformLocalX(self.setactivePos), flyTime,function()
            fun.set_active(self.firstPuItem,false)
        end)
        Anim.move_to_x(self.secondPuItem, self.onePosX, flyTime,function()
            
        end)
        Anim.move_to_x(self.thirdPuItem,self.twoPosX , flyTime,function()
            
        end)
    elseif type == 2 then
        Anim.move_to_x(self.secondPuItem,fun.GetTransformLocalX(self.setactivePos) , flyTime,function()
            fun.set_active(self.secondPuItem,false)
        end)
        Anim.move_to_x(self.thirdPuItem, self.onePosX , flyTime,function()
            
        end)
    end
end

function GiftPackSeasonPowerUpView:GetGiftPos(id)
    local posTable = {}
    if id == product_list[1] then
        for i = 1 , 4 do
            table.insert(posTable,fun.get_gameobject_pos(fun.find_child(self.firstPuItem,"bigFirstItem")))
        end
    elseif id == product_list[2] then
        for i = 1 , 4 do
            table.insert(posTable,fun.get_gameobject_pos(fun.find_child(self.secondPuItem,"bigSecondItem")))
        end
    else
        for i = 1 , 4 do
            table.insert(posTable,fun.get_gameobject_pos(fun.find_child(self.thirdPuItem,"bigThirdItem")))
        end
    end
    return  unpack(posTable)
end

return this