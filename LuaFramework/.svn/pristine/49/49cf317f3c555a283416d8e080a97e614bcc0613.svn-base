---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/8/31 16:55
---
require "State/PowerUpCardEntityView/DrawCardsBaseState"
require "State/PowerUpCardEntityView/DrawCardsPrimitiveState"
require "State/PowerUpCardEntityView/DrawCardsInitPositionState"
require "State/PowerUpCardEntityView/DrawCardsFlyState"
require "State/PowerUpCardEntityView/DrawCardsTurnaroundState"
require "State/PowerUpCardEntityView/DrawCardAvailableState"

PowerUpCardEntityView = BaseView:New("PowerUpCardEntityView")
local this = PowerUpCardEntityView
this.viewType = CanvasSortingOrderManager.LayerType.None
this.PowerUpQuality = {good = 1,great = 2,epic = 3,joker=4, legend = 6}

this.auto_bind_ui_items = {
"btn_card",
"lock",
"card_face",
"text_index",
"img_quality",
"img_item",
"card_group_face",
"img_lock",
"text_tip",
"anima",
"card_face_tp",
"text_index_tp",
"img_quality_tp",
"img_item_tp",
"img_lock_tp",
"text_tip_tp",
"root",
"img_corner",
"img_corner_tp",
"card_tp"
}

function PowerUpCardEntityView:New(index,quality)
    local o = {}
    self.__index = self
    setmetatable(o,self)
    o.index = index
    o.quality = quality
    return o
end

function PowerUpCardEntityView:Awake()
    self:on_init()
    --self:SetQuality(self.quality)
    self.luabehaviour:AddPress(self.btn_card,function(isPress)
        self:OnCardPress(isPress)
    end)
end

function PowerUpCardEntityView:OnEnable()
    self._fsm = Fsm.CreateFsm("PowerUpCardEntityView",self,{
        DrawCardsPrimitiveState:New(),
        DrawCardsInitPositionState:New(),
        DrawCardsFlyState:New(),
        DrawCardsTurnaroundState:New(),
        DrawCardAvailableState:New()
    })
    self._fsm:StartFsm("DrawCardsPrimitiveState")
    self._isInit = true
    self:SetFaceLock(self.powerCardId)
    self:SetPowerCardData(self.powerCardId)
end

function PowerUpCardEntityView:OnDisable()
    self:on_close()
end    

function PowerUpCardEntityView:SetParent(parent)
    if parent and self.go then
        fun.set_parent(self.go,parent,true)
    end
end

function PowerUpCardEntityView:SetActive(active)
    if self.go then
        fun.set_active(self.go,active)
    end
end

function PowerUpCardEntityView:SetPosition(x,y,z)
    if self.go then
        fun.set_gameobject_pos(self.go,x,y,z,true)
    end
end

function PowerUpCardEntityView:SetFaceLock(powerupId)
    self.powerCardId = powerupId or -1
    if not self._isInit then
        return
    end
    if powerupId and powerupId > 0 then
        self.anima:Play("front",0,0)
        fun.set_active(self.card_face_tp,false)
    else
        self.anima:Play("back",0,0)
        if self.quality == self.PowerUpQuality.good then
            fun.set_active(self.root, false)
        else
            fun.set_active(self.root, true)
            fun.set_active(self.card_face_tp,false)
        end
    end
end

function PowerUpCardEntityView:TurnPage(powerupId,animastate)
    if animastate == 1 then
        self.anima:Play("right",0,0) 
    else
        self.anima:Play("left",0,0) 
    end
    local pid = self.powerCardId
    if powerupId then
        self.anima:SetInteger("turnPage",2)
        self:SetTurnPageCardData(powerupId)
        self.turnPageTimer1 = Invoke(function()
            self:SetPowerCardData(powerupId)
        end,0.25)
    else
        self.anima:SetInteger("turnPage",1)
        self:SetTurnPageCardData(powerupId)
        self.turnPageTimer2 = Invoke(function()
            self:SetPowerCardData(powerupId)
        end,0.25)
    end
end

function PowerUpCardEntityView:SetPowerCardData(cardId)
    self.powerCardId = cardId or -1
    if not self._isInit then
        return
    end
    if self.powerCardId and self.powerCardId > 0 then
        self._fsm:GetCurState():Change2Available(self._fsm,false)
    else 
        self:SetCardFaceQuality(self.quality,self.card_face)
        self.img_lock.enabled = true
        self.text_tip.enabled = true
        self.img_item.enabled = false
        self.img_quality.enabled = false
        self.img_corner.enabled = false
        self.text_index.enabled = false
        self._fsm:GetCurState():Change2Primitive(self._fsm)
    end
end

function PowerUpCardEntityView:SetTurnPageCardData(cardId)
    self.powerCardId = cardId
    if self.powerCardId then
        self._fsm:GetCurState():Change2Available(self._fsm,true)
    else
        self:SetCardFaceQuality(self.quality,self.card_face_tp)
        self.img_lock_tp.enabled = true
        self.text_tip_tp.enabled = true
        self.img_item_tp.enabled = false
        self.img_quality_tp.enabled = false
        self.img_corner_tp.enabled = false
        self.text_index_tp.enabled = false
        self._fsm:GetCurState():Change2Primitive(self._fsm)
    end
end

function PowerUpCardEntityView:SetCardAvailable(isTurnPage,cardId)
    if isTurnPage then
        if cardId then
            self.powerCardId = cardId
        end
        local card = Csv.powerup_card[self.powerCardId]
        if card then
            self.text_index_tp.text = tostring(self.index)
            self.img_item_tp.sprite = AtlasManager:GetSpriteByName("ItemAtlas",card.icon)
            if card.level == 1 then
                self.img_quality_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_font_good")
                self.card_face_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_good_pai")
            elseif card.level == 2 then
                self.img_quality_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_font_great")
                self.card_face_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_great_pai")
            elseif card.level == 3 then
                self.img_quality_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_font_epic")
                self.card_face_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_epic_pai")
            elseif card.level == 4 then
                self.img_quality_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_font_epic")
                self.card_face_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_epic_king")
            elseif card.level == 5 then
                self.img_quality_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_font_epic")
                self.card_face_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_epic_queen")
            elseif card.level == 6 then
                self.img_quality_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas", "PfontLegend")
                self.card_face_tp.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas", "Pcard02")
            end
        end
        self.img_lock_tp.enabled = false
        self.text_tip_tp.enabled = false
        self.img_item_tp.enabled = true
        self.img_quality_tp.enabled = true
        self.img_corner_tp.enabled = true
        self.text_index_tp.enabled = true
    else
        local card = Csv.powerup_card[self.powerCardId]
        if card then
            fun.set_active(self.root, true)
            self.text_index.text = tostring(self.index)
            self.img_item.sprite = AtlasManager:GetSpriteByName("ItemAtlas",card.icon)
            if card.level == 1 then
                self.img_quality.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_font_good")
                self.card_face.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_good_pai")
            elseif card.level == 2 then
                self.img_quality.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_font_great")
                self.card_face.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_great_pai")
            elseif card.level == 3 then
                self.img_quality.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_font_epic")
                self.card_face.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_epic_pai")
            elseif card.level == 4 then
                self.img_quality.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_font_epic")
                self.card_face.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_epic_king")
            elseif card.level == 5 then
                self.img_quality.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_font_epic")
                self.card_face.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas","p_epic_queen")
            elseif card.level == 6 then
                self.img_quality.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas", "PfontLegend")
                self.card_face.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas", "Pcard02")
            end
        end
        self.img_lock.enabled = false
        self.text_tip.enabled = false
        self.img_item.enabled = true
        self.img_quality.enabled = true
        self.img_corner.enabled = true
        self.text_index.enabled = true
    end
end

function PowerUpCardEntityView:SetCardFaceQuality(quality,cardFace)
    local spriteName = "p_hui_pai"
    local tip = "Gold Only!"
    if quality == self.PowerUpQuality.good then
        spriteName = "p_hui_pai"
    end
    if quality == self.PowerUpQuality.great then
        spriteName = "p_gold_pai"
    end
    if quality == self.PowerUpQuality.epic then
        spriteName = "p_diamond_pai"
        tip = "Gems Only!"
    end

    if quality == self.PowerUpQuality.joker then
        spriteName = "pClownpai"
        tip = "Gems Only!"
    end

    if quality == self.PowerUpQuality.legend then
        spriteName = "Pcard01"
    end

    cardFace.sprite = AtlasManager:GetSpriteByName("PowerUpAtlas",spriteName)
    self.text_tip.text = tip
    self.text_tip_tp.text = tip
end

function PowerUpCardEntityView:SetFaceDrawCard(quality)
    self.img_item_tp.enabled = false
    fun.set_active(self.img_lock_tp,false)

    self:SetCardFaceQuality(quality,self.card_face_tp)
end

function PowerUpCardEntityView:DoDrawCardsAction(delay,pos,quality,index,lenth)
    quality = self:RebuildQuality(quality)
    if quality >= self.quality then
        self:SetCardFaceQuality(quality,self.card_face_tp)
        self._fsm:GetCurState():DoDrawCardsAction(self._fsm,delay,pos,quality,index,lenth)
    else
        self:SetCardFaceQuality(self.quality,self.card_face)
        self:SetFaceLock()
    end
end

function PowerUpCardEntityView:RebuildQuality(quality)
    local info = Csv.GetData("powerup_card", self.powerCardId)
    if info and info.level == 6 then
        return self.PowerUpQuality.legend
    end

    return quality
end

function PowerUpCardEntityView:SetSortingOrder(value)
    if self.canvas == nil then
        self.canvas = fun.get_component(self.go,fun.CANVAS)
    end
    if self.canvas~= nil then
        self.canvas.overrideSorting = true
        local orderValue = self.canvas.sortingOrder
        self.canvas.sortingOrder = orderValue + value
    end
end

function PowerUpCardEntityView:InitDrawCardPosition(pos,quality)
    fun.set_gameobject_pos(self.go,pos.x,pos.y,0,false)
    self.anima:Play("init_fly",0,0)
    self:SetFaceDrawCard(quality)
end

function PowerUpCardEntityView:DrawCardMovePosition()
    self:SetSortingOrder(100)
    self.anima:Play("fly",0,0)
    Anim.move_ease(self.go,0 ,0,0,0.35,true,DG.Tweening.Ease.OutSine,function()
        self:SetSortingOrder(-100)
        self._fsm:GetCurState():OnFlyComplete(self._fsm)
    end)
end

function PowerUpCardEntityView:DrawCardTurnRound(index,lenth)
    if self.powerCardId then
        --[[
        self.anima:Play("show",0,0)
        self.turnRoundTimer = Invoke(function()
            --self:SetTurnPageCardData(self.powerCardId)
            self:SetCardAvailable(true,self.powerCardId)
        end,0.15)
        --]]
        ---[[
        AnimatorPlayHelper.Play(self.anima,"show",false,function()
            self:SetCardAvailable(true,self.powerCardId)
        end,0.15)
        --]]
    end
end

function PowerUpCardEntityView:DrawCardTurnRoundIndecator(index,lenth)
    if self.powerCardId then
        Facade.SendNotification(NotifyName.PowerUps.DoTweenPowerIndecator,self.powerCardId,index,lenth)
    end
end

function PowerUpCardEntityView:GetPowerUpCardId()
    return self.powerCardId
end

function PowerUpCardEntityView:on_close()
    if self.turnRoundTimer then
        self.turnRoundTimer:Stop()
        self.turnRoundTimer = nil
    end
    if self.turnPageTimer1 then
        self.turnPageTimer1:Stop()
        self.turnPageTimer1 = nil
    end
    if self.turnPageTimer2 then
        self.turnPageTimer2:Stop()
        self.turnPageTimer2 = nil
    end
    if self._fsm then
        self._fsm:Dispose()
        self._fsm = nil
    end
    self._isInit = nil
    self.powerCardId = nil
    self.canvas = nil
    self.anima:StopPlayback()
end

function PowerUpCardEntityView:on_btn_card_click()
    self._fsm:GetCurState():ClickCard(self._fsm)
end

function PowerUpCardEntityView:OnClickCard()
    --Facade.SendNotification(NotifyName.PowerUps.PowerupCardShowTip,self.powerCardId,self.btn_card.transform.position)
    Facade.SendNotification(NotifyName.ShowUI,ViewList.PowerupCardShowTipView,nil,nil,{cardId = self.powerCardId,pos = self.btn_card.transform.position })
end

function PowerUpCardEntityView:OnClickHideTips()
    --Facade.SendNotification(NotifyName.PowerUps.PowerupCardShowTip,nil,nil)
    Facade.SendNotification(NotifyName.CloseUI,ViewList.PowerupCardShowTipView)
end

function PowerUpCardEntityView:OnCardPress(isDown)
    --[[
    if isDown then
        Facade.SendNotification(NotifyName.PowerUps.PowerupCardShowTip,self.powerCardId,self.btn_card.transform.position)
    else
        Facade.SendNotification(NotifyName.PowerUps.PowerupCardShowTip,nil,nil)
    end
    --]]
end

function PowerUpCardEntityView:Dispose()
    self:Close()
end

function PowerUpCardEntityView:OnDestroy()
    self:Close()
end