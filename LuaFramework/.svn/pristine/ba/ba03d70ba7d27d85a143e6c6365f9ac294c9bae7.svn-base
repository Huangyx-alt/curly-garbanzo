---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/4/1 12:18
---


require("M1.MachineArtConfig")
local GameBuffView = require("View.Bingo.UIView.PartView.GameBuffView")
require("View/Bingo/EffectPool/BattleEffectPool")

---@field CardCell
local CardCell = require("View.Bingo.UIView.PartView.CardCell")

local BaseBingoView = BaseView:New('BaseBingoView');
local this = BaseBingoView;

this.auto_bind_ui_items = {
    "BingoMap1",
    "BingoMap2",
    "BingoMap3",
    "BingoMap4",
    "SwitchCard",
    "RollBall",
    "Bingosi",
    "ItemContainer",
    "Bingo",
    "powerup",
    "btn_main",
    "magnifier",
    "bottle",
    "btn_power",
    "Right",
    "BingoSpawn",
    "EffectContainer",
    "PowerUpContainer",
    "pot",
    "NormalBingosiNode",
    "Bg",
    "CardNumberSpritesContainer",
    "CellBgContainer",
    "MirrorNumberContainer",
    "RewardCollect",
    "CellDoubleNumBgContainer",
    "SafeArea",
    "MapRootPos",
}

this.data = {}

this.cardView =nil  --卡牌功能界面
this.switchView =nil  --卡牌切换功能界面
--this.jackpotView =nil  --jackpot功能界面
this.bingoEffect = nil   --其他人bingo提示
this.callNumView = nil --叫号界面

this.fireTime={}
this.fireTime2={}
this.eff_table = {}
this.bingo_time = {}
this.jackpot_time = {}
this.coin_time = {}
this.fire_time = {}
local last_click_time = 0   -- 退出按钮点击间隔时间

this.ViewName = "BaseBingoView"

local bg_animator = nil

--local _buffView = GameBuffView:New(nil,nil,"GameBuffView")


function BaseBingoView:Awake()
    self:BaseAwake()
end

function BaseBingoView:BaseAwake()
    self:ResetInitData()
    self.update_x_enabled = true
    self:on_init()
    self:RegisterEvent()
    self.model = ModelList.BattleModel:GetCurrModel()
    
    LuaTimer:SetDelayFunction(0.5, function()
        self:InitCityBg()
    end)

    --if ModelList.BattleModel.GetBattleSuperMatch() then
    --    self:ReplaceBingosiNew()
    --    self:ShowSuperMatchCardView()
    --end
end

function BaseBingoView:OnEnable()
    self:BaseEnable()
end

function BaseBingoView:BaseEnable()
    --Facade.RegisterView(self)
    self.model:SetModelView(self)
    self.data  =  ModelList.BattleModel:GetCurrModel():LoadGameData()
    last_click_time = 0
    local isGuide = ModelList.GuideModel:IsFirstBattle()
    self:LoadBingoViewRequire(isGuide)
    local gameType = ModelList.BattleModel:GetGameType()
    if gameType == PLAY_TYPE.PLAY_TYPE_NORMAL then
        self:LoadCellBg()
    end
    self.update_x_enabled = true
    self:start_x_update()
    for i = 1, #self.data.cardsInfo do
        self.eff_table[i] = {fire= {  },bingo ={},coin ={}}
    end

    --_buffView:SkipLoadShow(self["Buff"])
    --_buffView:SetParent(self,self["Buff"])
    --self:InitSuperMatchView()
end

function BaseBingoView:LoadBingoViewRequire(isGuide)
    local gameType = ModelList.BattleModel:GetGameCityPlayID()
    local data = Csv.GetData("new_game_bingo_view",gameType)
    
    local count = ModelList.BattleModel:GetCurrModel():GetCardCount()
    local onlyShow2Card = fun.read_value(BingoBangEntry.selectGameCardNumString, BingoBangEntry.selectGameCardNum.FourCard)
    onlyShow2Card = onlyShow2Card == BingoBangEntry.selectGameCardNum.TwoCard
    if count == 4 and onlyShow2Card then
        --奖励收集
        self.rewardCollectView = require("View.Bingo.UIView.PartView.RewardCollectView2")
        self.rewardCollectView:SkipLoadShow(self.RewardCollect)

        --切换卡牌界面
        --self.switchView = require("View.Bingo.UIView.PartView.SwitchView."..data["switch_view"])
        self.switchView = require("View.Bingo.UIView.PartView.SwitchView.GameBingoSwitchView")
        self.switchView:Init(self.SwitchCard, self)
    else
        --奖励收集
        fun.set_active(self.SwitchCard, false)
        self.rewardCollectView = require("View.Bingo.UIView.PartView.RewardCollectView")
        self.rewardCollectView:SkipLoadShow(self.RewardCollect)
    end
    
    if isGuide then
        self.cardView = require("View/Guide/GuideGameCardView")
        local guideBattleType = ModelList.GuideModel:GetGuideBattleType()
        if guideBattleType == 2 or guideBattleType == 22 or guideBattleType == 23 or guideBattleType == 24
                or guideBattleType == 3 or guideBattleType == 4 or guideBattleType == 103 or guideBattleType == 104
                or guideBattleType == 102 then    last_click_time = 99999999999999 end
    else
        self.cardView = require("View.Bingo.UIView.CardView."..data["card_view"])
        local guideBattleType = ModelList.GuideModel:GetGuideBattleType()
        if  guideBattleType == 23 or guideBattleType == 24 or guideBattleType == 3 or guideBattleType == 4
                or guideBattleType == 103 or guideBattleType == 104  then    last_click_time = 99999999999999 end
    end
    --if ModelList.BattleModel.GetBattleSuperMatch() then
    --    self.cardView:OnEnable(self, self.SuperMatchBingosi, self.data.systemTime <= self.data.hintTime)
    --else
    self.is_open_magnifier = self.data.systemTime <= self.data.hintTime
    self.cardView:OnEnable(self, self.Bingosi, self.is_open_magnifier)
    --end
    
    if isGuide then
        self.cardView:GuideBattleReady()
        self.cardView:SetGuideBattleType(ModelList.GuideModel:GetGuideBattleType())
    end

    --jackpot显示       
    --self.jackpotView = require("View.Bingo.UIView.PartView.JackpotView."..data["jackpot_view"])
    --self.jackpotView:Init(self.Jackpot, self.data.jackpotRuleId, self)

    --bingo 效果以及自己计算头像icon
    --if ModelList.BattleModel.GetBattleSuperMatch() then
    --    self.bingoEffect = require("View.Bingo.UIView.PartView.JumpBingoView.SuperMatchBingoEffectView")
    --    self.bingoEffect:Init(self.Bingo,self)
    --if data["jump_bingo_view"] ~= "0" then
    --    self.bingoEffect = require("View.Bingo.UIView.PartView.JumpBingoView."..data["jump_bingo_view"])
    --    self.bingoEffect:Init(self.Bingo,self)
    --end

    --powerup 卡牌
    self.powerView =  require("View.Bingo.UIView.PowerUpView."..data["power_view"])
    self.powerView:Init(self.powerup,self)

    --self.effectObjContainer = require("View.Bingo.UIView.EffectContainerView."..data["effect_container"])
    --self.effectObjContainer:Init(self.EffectContainer)
    self.callNumView = require("View.Bingo.UIView.PartView.CallNumberView."..data["call_number_view"])
    self.callNumView:Init(self, self.BingoSpawn, self.OnDropBall)
    fun.set_active(self.callNumView.magnifier,false)

    --self.boxView = require("View.Bingo.UIView.PartView.BoxView."..data["box_view"])
    --self.boxView:SkipLoadShow(self.box.gameObject)

    --if ModelList.BattleModel.GetBattleSuperMatch() then
    --    self.bingosleftView = require("View.Bingo.UIView.PartView.BingosleftView.SuperMatchBingosleftView")
    --    self.bingosleftView:SkipLoadShow(self.SuperMatchBingosi, false)
    --else
        self.bingosleftView = require("View.Bingo.UIView.PartView.BingosleftView." .. data["bingosleft_view"])
        self.bingosleftView:SkipLoadShow(self.Bingosi,false)
    --end

    --self.bingosleftView:CoroutineEnable()

    self.effectObjContainer = require("View.Bingo.UIView.EffectContainerView.EffectObjContainer")
    self.effectObjContainer:Init(self.EffectContainer)
end


function BaseBingoView.OnDropBall(currNumber)
    Event.Brocast(EventName.Test_Normal_Auto_Click, currNumber)
    --Event.Brocast(EventName.Normal_Auto_Background_Click, currNumber)
end

-- bingosleft 显示
function BaseBingoView:LoadBingoleftView()
    if self.bingosleftView then
        self.bingosleftView:Show()
    end
end

function BaseBingoView:LoadCellBg()
    local playId = ModelList.CityModel.GetPlayIdByCity()
    --local packageId = Csv.GetData("new_city_play", playId, "card_resources")
    --local resource1 = "bcard0" .. packageId
    --log.g("LoadCellBg")
    local playId = ModelList.BattleModel:GetGameCityPlayID()
    local cell_theme = Csv.GetData("new_city_play",playId,"card_resources")
    if cell_theme and #cell_theme > 0 then
        --Cache.Load_Atlas(AssetList[cell_theme[1]], cell_theme[2], function(sprite)
        --    if self and self:GetCardView() then
        --        local allCell = self:GetCardView():GetCardCell()
        --        if allCell then
        --            for k, v in pairs(allCell) do
        --                for i = 1, #v do
        --                    if v[i] and not Util.IsNull(v[i]) then
        --                        CardCell:SetCellCitySkin(v[i], cell_theme[2],cell_theme[3])
        --                    end
        --                end
        --            end
        --        end
        --    end
        --end)
    end

    --Cache.load_sprite(AssetList[resource1], resource1, function(sprite)
    --    if sprite then
    --        log.g("LoadCellBg sprite ")
    --        LuaTimer:SetDelayFunction(0.2,function()
    --            local playId = ModelList.CityModel.GetPlayIdByCity()
    --            local packageId = Csv.GetData("new_city_play",playId,"card_resources")
    --            local allCell = self:GetCardView():GetCardCell()
    --            for k, v in pairs(allCell) do
    --                for i = 1, #v do
    --                    if v[i] and not Util.IsNull(v[i]) then
    --                        CardCell:SetCellCitySkin(v[i], packageId)
    --                    end
    --                end
    --            end
    --        end)
    --    end
    --end)

end

function BaseBingoView:on_x_update()
    if self.cardView then
        self.cardView:on_x_update()
    end
    --if self.powerView then
    --    self.powerView:on_x_update()
    --end
    if self.bingosleftView then
        self.bingosleftView:on_x_update()
    end
end

function BaseBingoView:OnDisable()
    --Facade.RemoveView(this)
    self:BaseDisable()
end

function BaseBingoView:BaseDisable()
    if self.cardView then self.cardView:OnDisable() end
    if self.powerView then self.powerView:OnDisable() end
    --if self.jackpotView then self.jackpotView:OnDisable() end
    if self.switchView then self.switchView:OnDisable() end
    if self.bingosleftView then self.bingosleftView:OnDisable() end
    if self.callNumView then self.callNumView:OnDisable() end
    if self.superMatchBingoView then self.superMatchBingoView:OnDisable() end


    self:UnRegisterEvent()
    self:ResetInitData()
end

function BaseBingoView:ResetInitData()
    self.data = {}
    self.cardView = nil  --卡牌功能界面
    if self.bingosleftView then
        self.bingosleftView.OnDestroy()
    end
    self.bingosleftView = nil   --其他人bingo提示
    if self.effectObjContainer then
        self.effectObjContainer:OnDisable()
    end
    self.fireTime = {}
    self.fireTime2 = {}
end

function BaseBingoView:OnDestroy()
    self:BaseOnDestroy()
end

function BaseBingoView:BaseOnDestroy()
    if self.cardView then
        self.cardView:OnDestroy()
    end
    if self.switchView then
        self.switchView:OnDestroy()
    end
    --if self.jackpotView then
    --    self.jackpotView:OnDestroy()
    --end
    if self.bingosleftView then
        self.bingosleftView.OnDestroy()
    end
    if self.callNumView then
        self.callNumView.OnDestroy()
    end
    if self.superMatchBingoView then
        self.superMatchBingoView:OnDestroy()
    end
    self.cardView = nil
    self.switchView = nil
    --self.jackpotView = nil
    self.bingosleftView = nil
    self.effectObjContainer = nil
    self.superMatchBingoView = nil
    self:Destroy()
end

--- 加载战斗背景
function BaseBingoView:InitCityBg(cb)
    log.r("[BaseBingoView] InitCityBg start")
    local playId = ModelList.CityModel.GetPlayIdByCity()
    local sceneId = ModelList.CityModel.GetCity()
    --子玩法
    if playId > 1 then sceneId = 0 end
    local key = string.format("%s%s", sceneId, playId)
    local bgPrefabName = string.format("CityPlayBg%s", key)
    log.r("[BaseBingoView] InitCityBg bgPrefabName:", bgPrefabName)
    self:LoadCityBackgrounnd(bgPrefabName,self.Bg, cb)
end

function BaseBingoView:LoadCityBackgrounnd(bg_name,rawimage, cb)
    if bg_name then
        log.r("[BaseBingoView] LoadCityBackgrounnd 1")
        local bg = AssetList[bg_name] --string.format("luaprefab_textures_battleground",bg_name)
        bg = bg or AssetList["CityPlayBg11"]
        if bg then
            log.r("[BaseBingoView] LoadCityBackgrounnd 2")
            Cache.load_prefabs(bg, bg_name, function(objs)
                log.r("[BaseBingoView] LoadCityBackgrounnd 3")
                if rawimage and not Util.IsNull(rawimage) then
                    log.r("[BaseBingoView] InitCityBg success")
                    local clone = fun.get_instance(objs, rawimage.transform)
                    fun.set_gameobject_scale(clone, 1, 1, 1)
                    bg_animator = fun.get_component(clone,fun.ANIMATOR)
                    if cb then
                        cb(bg_animator)
                    end
                end
            end)
        end
    end
end

function BaseBingoView:PlayBackgroundAction(actionName, force)
    if bg_animator and actionName then
        if force then
            fun.play_animator(bg_animator, actionName, true)
        else
            local stateInfo = bg_animator:GetCurrentAnimatorStateInfo(0)
            if not stateInfo:IsName(actionName) then
                bg_animator:Play(actionName,0,0)
            end
        end
    end
end

--初始化Jackpot类型
function BaseBingoView :InitJackpot ()

end

--显示金币飞特效
function BaseBingoView:ShowCoinFlyEffect(mapindex,pos)
    --local time_index = mapindex..UnityEngine.Time.time..#self.coin_time
    --self.coin_time[time_index] = LuaTimer:SetDelayFunction(0.2,function()
    --    if self.cardView then
    --        self.cardView:CoinsFlyEffect(mapindex,pos)
    --        if self.coin_time[time_index]  then
    --            LuaTimer:Remove(self.coin_time[time_index] )
    --        end
    --    end
    --end,nil,LuaTimer.TimerType.Battle)
end

--显示金币和周榜奖杯飞特效
function BaseBingoView:ShowIconFlyEffect(mapindex, pos)
    --local time_index = mapindex..UnityEngine.Time.time..#self.coin_time
    --self.coin_time[time_index] = LuaTimer:SetDelayFunction(0.2,function()
    --    if self.cardView then
    --        self.cardView:IconFlyEffect(mapindex,pos)
    --        if self.coin_time[time_index]  then
    --            LuaTimer:Remove(self.coin_time[time_index] )
    --        end
    --    end
    --end,nil,LuaTimer.TimerType.Battle)
end

local function SetCardLetterOffset(obj ,offset)
    local ref_temp = fun.get_component(obj,fun.REFER)
    if ref_temp then
        local  b_letter = ref_temp:Get("b_letter")
        if b_letter then
            local rect = fun.get_component(b_letter.gameObject, fun.RECT)
            rect.pivot = Vector2.New(0.5,0.5)
        end
    end
end

function BaseBingoView:ReadyForClimbRankView(NodeList)
    local count = self.model:GetCardCount()
    local card_list = self:GetCardMapsObject()
    local normalMap =  require("View.Bingo.Base.NormalMap")
    for i = 1, #card_list do
        if not Util.IsNull(card_list[i]) and i<= count  then
            fun.set_parent(card_list[i],NodeList[i],false)
            card_list[i].transform.localPosition = Vector3.New(0, 0, 0)
            card_list[i].transform.localScale = Vector3.New(1, 1, 1)
            SetCardLetterOffset(card_list[i].transform)
        end
        normalMap:HideNum(card_list[i])
    end
end

function BaseBingoView:GetEffectObjContainerGO()
    if self.effectObjContainer then
        return self.effectObjContainer.go
    else
        return self.EffectContainer.gameObject    
    end
end

function BaseBingoView:GetEffectObjContainer()
    if self.effectObjContainer then
        return self.effectObjContainer
    end
end

--获取所有的卡牌Object
function BaseBingoView:GetCardMapsObject()
    if not self or not self:GetCardView() then return nil,nil,nil,nil end
    local cardView = self:GetCardView()
    if fun.is_not_null(cardView) then
        return cardView:GetAllCardMapObj()
    end
    
    return self.BingoMap1, self.BingoMap2, self.BingoMap3, self.BingoMap4
end

function BaseBingoView:IsCardShowing(cardid)
    return true
    --if not self.switchView then
    --    return true
    --end
    --cardid = tonumber(cardid)
    --return BattleLogic.GetLogicModule(LogicName.SwitchLogic):IsShowing(cardid)
end

function BaseBingoView:on_btn_main_click()
    self:ShowQuitView()
end

function BaseBingoView:StopBingoHandle()
    self:stop_x_update()
    self.update_x_enabled = false
end

---初始加载的流程
---倒计时结束1  powerup卡牌落位2 放大镜落位3 卡牌上的初始物品落位4  页签5 开局使用的POWERUP牌6 播放牌面溜光效果，然后0.5S开始叫号
---7周榜表现
---8小丑卡表现,最优先出现
---9 首个小丑入场
---10 supermatch活动
---@param step : number
function BaseBingoView:SetReadyForPreUseItem(step)

end

--倒计时结束
function BaseBingoView:TimeCountOver(jokerPos)

end

function BaseBingoView:SetGameOver()
    self:stop_x_update()
end

---恢复卡牌的透明度
function BaseBingoView:RevertCardsCanvasAlpha()
    for i = 1, 4 do
        if self["BingoMap"..i] then
            local canvas = fun.get_component(self["BingoMap"..i],fun.CANVAS_GROUP)
            if canvas then
                canvas.alpha = 1
            end
        end
    end
end

---恢复卡牌的透明度
function BaseBingoView:OnCallNumberViewActive()
    if self.superMatchBingoView then
        self.superMatchBingoView:ShowAll()
    end
end

function BaseBingoView:OnCardExitEffect()
    if self.superMatchBingoView then
        fun.set_active(self.SuperMatchObj, false)
    end

    if self.SuperMatchBingosi then
        fun.set_active(self.SuperMatchBingosi, false)
    end
end

function BaseBingoView:RegisterEvent()
    Event.AddListener( EventName.Event_stop_bingo_game,self.StopBingoHandle,self)
    Event.AddListener( Notes.BINGO_TIME_COUNT_OVER,self.TimeCountOver,self)

    Event.AddListener( Notes.CLEAR_DELAY_TIMMER,self.RemoveDelayTime,self)
    Event.AddListener( EventName.ShowBingoleftView,self.LoadBingoleftView,self)
    Event.AddListener( EventName.Revert_Cards_Canvas_Alpha,self.RevertCardsCanvasAlpha,self)

    Event.AddListener(EventName.CallNumber_View_Active, self.OnCallNumberViewActive, self)
    Event.AddListener(EventName.CardEffect_Exit_Effect, self.OnCardExitEffect, self)
end


function BaseBingoView:UnRegisterEvent()
    Event.RemoveListener( EventName.Event_stop_bingo_game,self.StopBingoHandle,self)
    Event.RemoveListener( Notes.BINGO_TIME_COUNT_OVER,self.TimeCountOver,self)
    Event.RemoveListener( Notes.CLEAR_DELAY_TIMMER,self.RemoveDelayTime,self)
    Event.RemoveListener( EventName.ShowBingoleftView,self.LoadBingoleftView,self)

    Event.RemoveListener(EventName.CallNumber_View_Active, self.OnCallNumberViewActive, self)
    Event.RemoveListener(EventName.CardEffect_Exit_Effect, self.OnCardExitEffect, self)
end

function BaseBingoView:on_btn_power_click()
    self.powerView:ClickPowerUp()
end


function BaseBingoView:RemoveDelayTime()
    if self.cardView then
        self.cardView:ClearDelayTime()
    end
end

function BaseBingoView:GetFirstPageCardObj( parent_obj)

end

function BaseBingoView:HideTopLayer()
    --别删除
end

function BaseBingoView:IsAuto()
    return false
end

---@see  设置卡牌面板,提供给结算面板使用
function BaseBingoView:HandleForSettle( parent_obj)
    if self:IsCardShowing(1) then
        local ids = BattleLogic.GetLogicModule(LogicName.SwitchLogic):GetPageTwoCardIds()
        local smallMapIndex =3
        for i = 1, #ids do
            local card3_pos = fun.get_gameobject_pos(self["SwitchCard"..smallMapIndex], false)
            fun.set_gameobject_pos(self["BingoMap"..ids[i]], card3_pos.x, card3_pos.y, card3_pos.z, false)
            fun.set_gameobject_scale(self["BingoMap"..ids[i]], 0.2, 0.2, 1)
            smallMapIndex = smallMapIndex + 1
        end
    else
        local ids2 = BattleLogic.GetLogicModule(LogicName.SwitchLogic):GetPageOneCardIds()
        local ids1 = BattleLogic.GetLogicModule(LogicName.SwitchLogic):GetPageTwoCardIds()
        local smallMapIndex = 3
        for i = 1, #ids1 do
            local card3_pos = fun.get_gameobject_pos(self["SwitchCard"..smallMapIndex], false)
            fun.set_gameobject_pos(self["BingoMap"..ids1[i]], card3_pos.x, card3_pos.y, card3_pos.z, false)
            fun.set_gameobject_scale(self["BingoMap"..ids1[i]], 0.2, 0.2, 1)
        end
    end

    fun.set_parent(self.Right,parent_obj)
    --local buff_obj = fun.find_child(self.Right,"Buff")
    --fun.set_active(buff_obj,false)
    fun.set_active(self.powerup,false)
    fun.set_active(self.SwitchCard,false)
    fun.set_active(self.callNumView.magnifier,false)
    fun.set_active(self.BingoSpawn,false)
    fun.set_active(self.Bingosi,false)
    --fun.set_active(self.SuperMatchBingosi,false)
    --fun.set_active(self.Jackpot,false)
    self:ProvideBgToSettleView()
    self:HideMagnifierMirrorBeforeSettle()
end

function BaseBingoView:ProvideBgToSettleView( )
    if fun.is_not_null(self.Bg) then
        fun.set_parent(self.Bg.gameObject,ViewList.GameSettleView.go,false)
        if fun.get_child_count(ViewList.GameSettleView.go)<= 2 then
            self.Bg.transform:SetSiblingIndex(0)
        else
            self.Bg.transform:SetSiblingIndex(1)
        end
    end
end

---结算面板展示前,隐藏卡牌的放大镜提示
function BaseBingoView:HideMagnifierMirrorBeforeSettle()
    local data = self.model:GetRoundData()
    for k, v in pairs(data) do
        for i = 1, #v.cards do
            if  v.cards[i].sign == 0 then
                local ref = fun.get_component(self.cardView:GetCardMap(k), fun.REFER)
                local cell = ref:GetByIndex(i)
                Event.Brocast(EventName.Magnifier_Close_Single_Cell,cell,false)
            end
        end
    end
end

function BaseBingoView:GetModel()
    return self.model
end

---@see 获取卡牌
---@return GameCardView
function BaseBingoView:GetCardView()
    return self.cardView
end

--- 获取切换卡牌界面
---@return GameBingoSwitchView
function BaseBingoView:GetSwitchView()
    return self.switchView
end

-------------------Guide-------------------------------
---
function BaseBingoView:ReplacGuideCardView(isReplace)
    if isReplace then
        self.cardView = require("View/Guide/GuideGameCardView")
        self.cardView:FirstBattleReady()
    else
        self.cardView =  require("View.Bingo.UIView.CardView.GameCardView")
        self.cardView:FirstBattleReady()
    end
end
---------------------------------------------------------

function BaseBingoView:GetCallNumberView()
    return self.callNumView
end

function BaseBingoView:GetMagnifier()
    return self.callNumView.magnifier
end

function BaseBingoView:ShowQuitView()
    if BingoBangEntry.IsInBattle and UnityEngine.Time.time - last_click_time > 0.5 then
        local game_ui = fun.GameObject_find("Canvas/GameUI/NormalNode")
        local quitView = fun.find_child(game_ui, "CommonPopupView")
        Facade.SendNotification(NotifyName.SkipLoadShowUI, ViewList.GameQuitView, quitView)
        last_click_time = UnityEngine.Time.time
    end
end

function BaseBingoView:SetContainerForRocketView(parentObj)
    self.effectObjContainer:ReadyForRocketView(parentObj)
    self:PlayBackgroundAction("move_reverse")
end

function BaseBingoView:SetContainerForOtherView(parentObj)
    self.effectObjContainer:ReadyForOtherView(parentObj)
    --self:PlayBackgroundAction("move_reverse")
end

function BaseBingoView:New(viewName,atlasName)
    local o = {viewName = viewName, atlasName = atlasName, isShow = false, isLoaded = false, changeSceneClear = true}
    self.__index = self
    setmetatable(o, self)
    return o
end

function SetJokerSkin(img,atlasName,spriteName)
    if img and not fun.is_null(img) then
        if ModelList.BattleModel.GetIsJokerMachine() then
            img = fun.get_component(img.gameObject, fun.IMAGE)
            local sprite = AtlasManager:GetSpriteByName(atlasName,spriteName)
            if img and sprite then
                img.sprite = sprite
            else
                log.r("SetJokerSkin error : atlasName  "..atlasName.."   spriteName  "..spriteName)
            end
        end
    end
end

function SetJokerSkin2(img,atlasName,spriteName)
    if img then
        local sprite = AtlasManager:GetSpriteByName(atlasName,spriteName)
        if sprite then
            img.sprite = sprite
        else
            log.r("SetJokerSkin error : atlasName  "..atlasName.."   spriteName  "..spriteName)
        end
    end
end

function SetJokerSkin3(img,atlasName,spriteName)
    if img and not fun.is_null(img) then
        img = fun.get_component(img.gameObject, fun.IMAGE)
        if img  then
            local sprite = AtlasManager:GetSpriteByName(atlasName,spriteName)
            if sprite then
                img.sprite = sprite
            end
        else
            log.r("SetJokerSkin error : atlasName  "..atlasName.."   spriteName  "..spriteName)
        end
    end
end

function BaseBingoView:ShowMask()
    if self.mask then
        fun.set_active(self.mask,true)
    else
        if self.go then
            local child = fun.find_child(self.go,"SafeArea/Mask")
            if child then
                fun.set_active(child,true)
            end
        end
    end
end

function BaseBingoView:GetPowerUpView()
    return self.powerView
end

------------------------------region supermatch--------------------------------
--- supermatch活动中，替换当前bingosi
function BaseBingoView:ReplaceBingosi()
    if ModelList.BattleModel.GetBattleSuperMatch() then
        Cache.load_prefabs(AssetList["SuperMatchBingosi"], "SuperMatchBingosi", function(objs)
            if objs then
                local clone = fun.get_instance(objs, self.Bingosi.transform.parent)
                --fun.set_parent(clone, self.Bingosi.transform, true)
                --fun.set_same_position_with(clone,self.Bingosi)
                local rect = fun.get_localposition(self.Bingosi)
                fun.set_rect_local_pos(clone,rect.x,rect.y+379,rect.z)
                fun.set_active(clone, false)
                fun.SetAsFirstSibling(clone)
                Destroy(self.Bingosi)
                self.Bingosi = clone
                self.SuperMatchBingosi = clone
            end
        end)
    end

end

function BaseBingoView:ReplaceBingosiNew()
    if ModelList.BattleModel.GetBattleSuperMatch() then
        --Cache.load_prefabs(AssetList["SuperMatchBingosi"], "SuperMatchBingosi", function(objs)
            if fun.is_not_null(self.SuperMatchBingosi) and fun.is_not_null(self.NormalBingosiNode) then
                Destroy(self.NormalBingosiNode)
                --local clone = fun.get_instance(objs, self.Bingosi.transform)
                --fun.set_parent(clone, self.Bingosi.transform, true)
                --fun.set_same_position_with(clone,self.Bingosi)
                --clone.gameObject.name = "Bingosi"
                --local rect = fun.get_localposition(self.Bingosi)
                --fun.set_rect_local_pos(self.SuperMatchBingosi, 0, 379, 0)

                local rect = fun.get_localposition(self.Bingosi)
                fun.set_rect_local_pos(self.SuperMatchBingosi, rect.x, rect.y + 379, rect.z)
                --fun.set_active(clone, false)
                --fun.SetAsFirstSibling(clone)
                self.originalBingosi = self.Bingosi
                self.Bingosi = self.SuperMatchBingosi
            end
        --end)
    end
end

--- supermatch活动中，增加supermatch的卡牌展示界面
function BaseBingoView:ShowSuperMatchCardView()
    if ModelList.BattleModel.GetBattleSuperMatch() then
        Cache.load_prefabs(AssetList["SuperMatchBingoView"], "SuperMatchBingoView", function(objs)
            if objs then
                local clone = fun.get_instance(objs, self.SwitchCard.transform.parent)
                fun.set_parent(clone, self.SwitchCard.transform.parent, true)
                --fun.set_active(self.SwitchCard, true)
                self.SuperMatchObj = clone
                self.superMatchBingoView = require("View.Bingo.UIView.MainView.SuperMatchBingoView")
                self.superMatchBingoView:SkipLoadShow(clone)
                self.superMatchBingoView:HideAll()
                fun.SetAsFirstSibling(clone)
                if fun.is_not_null(self.originalBingosi) then
                    fun.SetAsFirstSibling(self.originalBingosi)
                end

                if fun.is_not_null(self.SuperMatchBingosi) then
                    fun.SetAsFirstSibling(self.SuperMatchBingosi)
                end

                self:InitSuperMatchView()
            end
        end)
    end
end

--- supermatch活动中，初始化supermatch界面
function BaseBingoView:InitSuperMatchView()
    if not ModelList.BattleModel.GetBattleSuperMatch() then
        return
    end

    if fun.is_null(self.SuperMatchObj) then
        return
    end

    fun.set_rect_anchored_position_y(self.SuperMatchObj, -150)
    fun.set_rect_anchored_position_y(self.jackpotRoot, -396)
    fun.set_rect_anchored_position_y(self.powerup, -144)
    --fun.set_rect_anchored_position_y(self.Buff, 30)
    --fun.set_active(self.miniGame, false)
end

function BaseBingoView:GetSuperMatch()
    return self.superMatchBingoView
end
----------------------------- endregion supermatch--------------------------------
return this
