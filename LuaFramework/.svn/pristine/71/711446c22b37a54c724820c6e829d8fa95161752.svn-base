---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/8/31 10:42
---
require "View/HallCity/PowerUpCardEntityView"
require "View/HallCity/PowerUpGearView"

local PowerUpPrimitiveState = require "State/PowerUpView/PowerUpPrimitiveState"
local PowerUpEnterState = require "State/PowerUpView/PowerUpEnterState"
local PowerUpDrawCardState = require "State/PowerUpView/PowerUpDrawCardState"
local PowerUpClickState = require "State/PowerUpView/PowerUpClickState"
local PowerUpShowHandState = require "State/PowerUpView/PowerUpShowHandState"

PowerUpViewGoldNova = BaseView:New("PowerUpViewGoldNova","PowerUpAtlas")
local this = PowerUpViewGoldNova
this.viewType = CanvasSortingOrderManager.LayerType.Machine_Dialog

local card_entity_cache = nil

local buy_powerupcard_type = 1

local enterFinishCallback = nil
local selfPuLevel  = 3

local power1gear = PowerUpGearView:New(BuyPowerCardGenre.onegear,selfPuLevel)
local power2gear = PowerUpGearView:New(BuyPowerCardGenre.twogear,selfPuLevel)
local power3gear = PowerUpGearView:New(BuyPowerCardGenre.threegear,selfPuLevel)

local isShowHint = nil

POWERUP_SHUFFLE_SPEED = 0.25

this.PowerUpCardNum = {
    [1] ="PPowerupsF1Card",
    [2] ="PPowerupsF2Card",
    [3] ="PPowerupsF2Card",
    [4] ="PPowerupsF4Card",
    [5] ="PPowerupsF4Card",
    [6] ="PPowerupsF6Card",
    [7] ="PPowerupsF6Card",
    [8] ="PPowerupsF8Card",
}


this.auto_bind_ui_items = {
    "btn_help",
    "btn_close",
    "btn_right",
    "btn_left",
    "btn_play",
    "slider_power",
    "img_star",
    "img_quality",
    "text_page",
    "card1",
    "card2",
    "card3",
    "card4",
    "card5",
    "card6",
    "card7",
    "card8",
    "card9",
    "powerupcard_entity",
    "anima",
    "Image_page",
    "ef_maxFill",
    "anima_showHand",
    "anima_handStar",
    "ef_play",
    "anim_title_shine",
    "anima_cards",
    "power1gear",
    "power2gear",
    "power3gear",
    "MagnifyingAd", --放大镜广告
    "lightAnim",
    "CardNumImg", -- 现在是几卡的 图像

    "Img_drawCards",
    "PuBuffPanel",
    "btn_buy_buff",
    "img_point",
    "text_buff",
    "img_icon",
    "img_add",
    "Effect_out",
    "effect_out1",
    "effect_enter1",
    "effect_out2",
    "effect_enter2",
    "effect_out3",
    "effect_enter3",
    "Img_play1",
    "Img_play2",
    "Img_cooperation",
    "text_ticket",
    "Img_play3",
    "Img_extraRewardIcon",
    "Img_smallGameIcon",
}
this.puad_instance =nil

function GetPowerupGearPos3(gear)
    if gear == BuyPowerCardGenre.onegear then
        return power1gear:GetGearCardPos()
    elseif gear == BuyPowerCardGenre.twogear then
        return power2gear:GetGearCardPos()
    elseif gear == BuyPowerCardGenre.threegear then
        return power3gear:GetGearCardPos()
    else
        return Vector3.New(0,0,0)    
    end
end

function GetPowerupGearGo3(gear)
    if gear == BuyPowerCardGenre.onegear then
        return power1gear:GetGearCardGo()
    elseif gear == BuyPowerCardGenre.twogear then
        return  power2gear:GetGearCardGo()
    elseif gear == BuyPowerCardGenre.threegear then
        return  power3gear:GetGearCardGo()
    else
        return nil
    end
end


function PowerUpViewGoldNova:New(viewName,atlasName)
    local o = {viewName = viewName,atlasName = atlasName,isShow = false,isLoaded = false,changeSceneClear = true}
    self.__index = self
    setmetatable(o,self)
    return o
end

function PowerUpViewGoldNova:SetEnterCallback(callback)
    enterFinishCallback = callback
end

function PowerUpViewGoldNova:OpenView(callback,active)
    Facade.SendNotification(NotifyName.HallCity.ShowPowerUpView,self,function()
        if callback then
            callback()
        end
    end,active)
end

function PowerUpViewGoldNova:CloseView(callback)
    Facade.SendNotification(NotifyName.CloseUI,self)
end

function PowerUpViewGoldNova:Awake(obj)
    self:on_init()
end

function PowerUpViewGoldNova:OnEnable(params)
    ---[[不要在OnEnable里处理其他功能了，请在入场动画播完的回调里处理，要不在低端机会卡入场动画显示不出来完整ui
    Facade.RegisterView(this)
    --引导powerUpView 
    --ModelList.GuideModel:OpenUI("PowerUpView")
    power1gear:SkipLoadShow(self.power1gear,true,nil,params)
    power2gear:SkipLoadShow(self.power2gear,true,nil,params)
    power3gear:SkipLoadShow(self.power3gear,true,nil,params)
    fun.set_active(self.btn_play,false)
    fun.set_active(self.MagnifyingAd,false)
    fun.set_active(self.PuBuffPanel, false)
    fun.set_active(self.Img_play2, false)
    fun.set_active(self.Img_play3, false)

    self:BuildFsm()
  --  self._fsm:GetCurState():EnterPowerUp(self._fsm)
    
    self:InitPowerUpEntity()
    self:SetCostInfo()
    self:RequestServer()
    
    Event.Brocast(EventName.Event_topbar_change,false,TopBarChange.goback)
    ---]]不要在OnEnable里处理其他功能了，请在入场动画播完的回调里处理，要不在低端机会卡入场动画显示不出来完整ui
end

function PowerUpViewGoldNova:BuildFsm()
    self:DisposeFsm()
    self._fsm = Fsm.CreateFsm("PowerUpViewGoldNova",self,{
        PowerUpPrimitiveState:New(),
        PowerUpEnterState:New(),
        PowerUpDrawCardState:New(),
        PowerUpClickState:New(),
        PowerUpShowHandState:New()
    })
    self._fsm:StartFsm("PowerUpPrimitiveState")
end

function PowerUpViewGoldNova:DisposeFsm()
    if self._fsm then
        self._fsm:Dispose()
        self._fsm = nil
    end
end

function PowerUpViewGoldNova:OnEnterPowerUp()
    AnimatorPlayHelper.Play(self.anima,"PowerUpView_in",true,0.35,function()
        power1gear:PlayCardFlip()
        power2gear:PlayCardFlip()
        power3gear:PlayCardFlip()
        UISound.play("powerup_appear")
        fun.set_active(self.btn_play,true)
        self:InitPuadData()
    end,function()
      
        if self._fsm and self._fsm:GetCurState().EnterFinish then 
            self._fsm:GetCurState():EnterFinish(self._fsm)
        end 

        self:Play_PlayEffect()
        ModelList.GuideModel:OpenUI("PowerUpView")
        if enterFinishCallback then
            enterFinishCallback(selfPuLevel)
            enterFinishCallback = nil
        end

        --检测是否多个优惠得 有多个优惠得情况下不能购买
        self:register_timer(1, function()
            self:CheckDiscountAutoBuy(true)
        end) 
    end)
end

function PowerUpViewGoldNova:CheckDiscountAutoBuy(flag)

    if ModelList.CityModel:GetMaxPage() == 0 and
    ModelList.CouponModel.get_couponCountPowerupFree() == 1  then
        if power1gear:IsDiscountFree() then
            power1gear:PlayFreeTip()
        elseif power2gear:IsDiscountFree() then
            power2gear:PlayFreeTip()
        elseif power3gear:IsDiscountFree() then
            power3gear:PlayFreeTip()    
        else
            log.r("not IsDiscountFree ")
            if (flag == true) then
                self:register_timer(1, function()
                    self:CheckDiscountAutoBuy(false)
                end) 
            end 
        end
    else
        self:TryPopupPuBuffPackView()
    end
end

function PowerUpViewGoldNova:Play_PlayEffect()
    local cards = ModelList.CityModel:GetCardsCurrentPage(selfPuLevel)
    if #cards > 1 then
        local duration = Util.PlayParticle(self.ef_play)
        if duration > 0 then
            if self.efPlayTimer == nil then
                self.efPlayTimer = Invoke(function()
                    self.efPlayTimer = nil
                    if not Util.IsNull(self.ef_play) and self.ef_play.transform then
                        fun.set_active(self.ef_play.transform,false)
                    end
                end,duration)
            end
        end
    end
end

function PowerUpViewGoldNova:InitPowerUpEntity()
    if card_entity_cache == nil then
        card_entity_cache = {}
        local cards = {this.card1,this.card2,this.card3,this.card4,this.card5,this.card6,this.card7,this.card8,this.card9}
        for i = 1, #cards do
            local go = self:GetPowerUpEntity(cards[i]) --fun.get_instance(this.powerupcard_entity,cards[i])
            local cardEntity = PowerUpCardEntityView:New(i,math.floor((i - 0.5) / 3) + 1)
            table.insert(card_entity_cache,cardEntity)
            cardEntity:SkipLoadShow(go)
        end
    else
        local cards = {this.card1,this.card2,this.card3,this.card4,this.card5,this.card6,this.card7,this.card8,this.card9}
        for i = 1, #cards do
            if fun.is_null(card_entity_cache[i].go) then
                local go = self:GetPowerUpEntity(cards[i])
                card_entity_cache[i]:SkipLoadShow(go)
            end
        end   
    end
end

function PowerUpViewGoldNova:GetPowerUpEntity(parent)
    local chatItem = fun.get_child(parent,0)
    if chatItem == nil then
        chatItem = fun.get_instance(self.powerupcard_entity,parent)
    else
        chatItem = chatItem.gameObject
    end
    return chatItem
end

function PowerUpViewGoldNova:SetCostInfo()
	local cost1 = 0;
	local cost2 = 0;
	local cost3 = 0;

	local playId = ModelList.CityModel.GetPlayIdByCity()
    local data = ModelList.CityModel:GetPowerUpRange()
    local betrate = ModelList.CityModel:GetBetRate() or 1
	local cost =data[playId][selfPuLevel].range_pay_cutting;
	local cardNum = ModelList.CityModel:GetCardNumber()
    local flag = ModelList.PlayerInfoModel:CheckAbTest("powerup_range") -- ab测试

    Cache.SetImageSprite("PowerUpAtlas",this.PowerUpCardNum[tonumber(cardNum)], self.CardNumImg)
    
    if ModelList.UltraBetModel:IsActivityValidForCurPlay() then
        local UltraLevel =  ModelList.UltraBetModel:GetActivityLevel()
		cost = Csv.GetCityUtlaCost(playId,UltraLevel,cardNum)
		cost1 = not flag and cost[1] or cost[1] ; --1档
		cost2 = not flag and cost[2] or cost[2] ;  --2档
		cost3 = not flag and cost[3] or cost[3] ;  --3档
	else

        local cardCost = cost[1]
        for i = 1, #cost do
            if fun.starts(cost[i][1],tostring(cardNum)) then
                cardCost = cost[i]
                break
            end
        end

        cost1 =  tonumber(string.sub( cardCost[1],3) ); --1档
        cost2 = tonumber(cardCost[2]) ;  --2档
        cost3 = tonumber(cardCost[3]) ;  --3档

    end 
    
	ModelList.CityModel:SetPowerupCost(BuyPowerCardGenre.onegear,cost1)
	ModelList.CityModel:SetPowerupCost(BuyPowerCardGenre.twogear,cost2)
	ModelList.CityModel:SetPowerupCost(BuyPowerCardGenre.threegear,cost3)

    power1gear:SetPowerCost()
    power2gear:SetPowerCost()
    power3gear:SetPowerCost()
end

function PowerUpViewGoldNova:RequestServer()
    ModelList.CityModel.C2S_FetchPowerUp(0,selfPuLevel)
end

function PowerUpViewGoldNova:InitPuadData() 
    local level = ModelList.PlayerInfoModel:GetLevel()
    local taLevel = Csv.GetData("grocery",1,"level")
    local value =  ModelList.ItemModel.get_hintTime()
    
    local powerGearFal = power1gear:GetPuAdState() -- todo 后面还要加其他的pu
    local mode = ModelList.CityModel:GetEnterGameMode()
  
    if taLevel and  level>=taLevel and value <=0 and powerGearFal == false and mode ~= PLAY_TYPE.PLAY_TYPE_AUTO_TICKET  then 
        local view = require "View/Popup/MagnifyingAdView"

        if not this.puad_instance then 
            this.puad_instance = view:New()
       
            this.puad_instance:SkipLoadShow(self.MagnifyingAd)
        end 
        fun.set_active(self.MagnifyingAd,true )
    else 
        fun.set_active(self.MagnifyingAd,false)
    end 
end

function PowerUpViewGoldNova.OnFetchPowerUp_Result()
    this:SetCurrentPageCards(false)
    this:UpdatePuBuffState()
    this:UpdateSmallGameState()
    this:UpdateExtraRewardState()
end

function PowerUpViewGoldNova:SetCurrentPageCards(firstInit)
    local cards = {}
    if not firstInit then
        ModelList.CityModel:ResetPage(3)
        cards = ModelList.CityModel:GetCardsCurrentPage(selfPuLevel)
    end
    for i = 1, #card_entity_cache do
        card_entity_cache[i]:SetActive(true)
        --card_entity_cache[i]:SetPosition(0,0,0)
        card_entity_cache[i]:SetFaceLock(cards[i])
        card_entity_cache[i]:SetPowerCardData(cards[i])
    end
    self:DoTweenPowerIndecator(cards)
    self.text_page.text = string.format("%s/%s",ModelList.CityModel:GetPage(selfPuLevel),ModelList.CityModel:GetMaxPage())
    self:ShowPage()

    if self._fsm then 
        self._fsm:GetCurState():EnterPowerUp(self._fsm)
    end 

end

function PowerUpViewGoldNova:SetPreviousPageCards()
    self._fsm:GetCurState():TurnPage(self._fsm,1,3)
end

function PowerUpViewGoldNova:ShowPage()
    if ModelList.CityModel:IsPowerCardEmpty(3) then
        fun.set_active(self.Image_page,false)
    else
        fun.set_active(self.Image_page,true)
    end
    self:SetPageBtn()
end

function PowerUpViewGoldNova:SetPageBtn()
    fun.set_active(self.btn_left.transform,ModelList.CityModel:GetPage(selfPuLevel) > 1)
    fun.set_active(self.btn_right.transform,ModelList.CityModel:GetPage(selfPuLevel) < ModelList.CityModel:GetMaxPage())
end

function PowerUpViewGoldNova:OnTurnPage(dir)
    if dir == 1 then
        if ModelList.CityModel:GetPage(selfPuLevel) > 1 then
            local cards = ModelList.CityModel:GetCardsPreviousPage(3)
            for i = 1, #card_entity_cache do
                card_entity_cache[i]:TurnPage(cards[i],1)
            end
            self:DoTweenPowerIndecator(cards)
            self.text_page.text = string.format("%s/%s",ModelList.CityModel:GetPage(selfPuLevel),ModelList.CityModel:GetMaxPage())
        end
    elseif dir == 2 then
        if ModelList.CityModel:GetPage(selfPuLevel) < ModelList.CityModel:GetMaxPage() then
            local cards = ModelList.CityModel:GetCardsNextPage(selfPuLevel)
            for i = 1, #card_entity_cache do
                card_entity_cache[i]:TurnPage(cards[i],2)
            end
            self:DoTweenPowerIndecator(cards)
            self.text_page.text = string.format("%s/%s",ModelList.CityModel:GetPage(selfPuLevel),ModelList.CityModel:GetMaxPage())
        end
    end
    self:SetPageBtn()
    UISound.play("powerup_flip")
end

function PowerUpViewGoldNova:SetNextPageCards()
    self._fsm:GetCurState():TurnPage(self._fsm,2,3)
end

function PowerUpViewGoldNova:OnDrawCard()
    if self._drawCard then
        self._drawCard()
        self._drawCard = nil
        self.text_page.text = string.format("%s/%s",ModelList.CityModel:GetPage(selfPuLevel),ModelList.CityModel:GetMaxPage())
        self:ShowPage()
    end
end

function PowerUpViewGoldNova:DrawCardDisableBtn(disable)
    Util.SetImageColorGray(self.btn_play, disable)
    Util.SetImageColorGray(self.btn_close, disable)
    
    if disable == true then 
        power1gear:DrawCardDisableBtn(disable)
        power2gear:DrawCardDisableBtn(disable)
        power3gear:DrawCardDisableBtn(disable)
      
    else 
        self:register_timer(1.3, function()
            power1gear:DrawCardDisableBtn(disable)
            power2gear:DrawCardDisableBtn(disable)
            power3gear:DrawCardDisableBtn(disable)
        end) 
    end 

end

function PowerUpViewGoldNova:ResetPowerIndecator()
    self.slider_power.value = 0
    --fun.set_active(self.img_star,false)
    this.anima_showHand:Play("powerup_showhand_hide",0,0)
    this.anima_handStar:Play("powerup_handstar_hide",0,0)
end

function PowerUpViewGoldNova:DoTweenPowerIndecator(cards)
    if cards then
        this.OnDoTweenPowerIndecator(cards)
    end
end

function PowerUpViewGoldNova.OnDoTweenPowerIndecator(powerupcard,index,lenth)
    local groupId = ModelList.CityModel:GetCardsGroupId(nil,3)
    if groupId then
        if index and index == 1 then
            --this.anim_title_shine:Play("powerup_title_shine01",0,1)
            AnimatorPlayHelper.Play(this.anim_title_shine,"powerup_title_shine01",true,nil)
        elseif index and groupId then
            return --电力值给了总值，不需要分开计算了    
        end
        if this._power == nil then
            this._power = Csv.GetControlByName("powerup_score")
        end
        if powerupcard then
            local card = nil
            local sourceValue = this.slider_power.value * this._power[4][1]
            local targetValue = 0
            local showStar = false
            local turnPage = index == nil
            local isCardList = false
            if type(powerupcard) == "table" then
                local power = 0
                isCardList = true
                for i, v in pairs(powerupcard) do
                    if v then
                        local pcard = Csv.powerup_card[v]
                        if pcard then
                            power = power + pcard.power
                        end
                    end
                end
                targetValue =  power
                showStar = true
                lenth = 1
            else
                card = Csv.powerup_card[powerupcard]
                if card then
                    targetValue = sourceValue + card.power
                else
                    log.r("Error:card is nil. id: " .. powerupcard)    
                end
                if index and index == lenth then
                    showStar = true
                end
            end
            if this._tweenIndecator then
                this._tweenIndecator:Complete()
            end
            if groupId then
                targetValue = ModelList.CityModel:GetCardsPower(nil,3) or Csv.GetData("powerup_group",groupId,"power")
            end
            targetValue = targetValue or 1 
            this._tweenIndecator = Anim.do_smooth_float_update(sourceValue,targetValue,POWERUP_SHUFFLE_SPEED * lenth,
            function(num)
                this.slider_power.value = num / this._power[4][1]
            end,
            function(num)
                if groupId or showStar then
                    local callback = function()
                        --在某些机型上动画是可能提前去完成了 提前转换状态
                        local statename =this._fsm:GetCurState().name
                        if statename ~= "PowerUpShowHandState" and statename ~= "PowerUpClickState" then 
                            this._fsm:ChangeState("PowerUpShowHandState")
                        end 
                        this._fsm:GetCurState():FinishShowHand(this._fsm)
                        if not turnPage then
                            this:Play_PlayEffect()
                            --_currency:SetDisable(true)
                        end
                    end
                    local quality = ModelList.CityModel:GetCardsLevel(nil,3) or Csv.GetData("powerup_group",groupId,"level")
                    if turnPage then
                        if quality == 4 then
                            this.anima_handStar:Play("powerup_handstar_jackpot",0,1)
                        elseif quality == 3 then
                            this.anima_handStar:Play("powerup_handstar_epic",0,1)
                        elseif quality == 2 then
                            this.anima_handStar:Play("powerup_handstar_great",0,1)
                        elseif quality == 1 then
                            this.anima_handStar:Play("powerup_handstar_good",0,1)
                        else
                            this.anima_handStar:Play("powerup_handstar_hide",0,1)
                        end
                        callback()
                    else
                        if quality == 4 then
                            this.anima_handStar:Play("powerup_handstar_jackpot",0,0)
                            this.anima_showHand:Play("powerup_showhand_jackpot",0,0)
                           -- AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_jackpot",false,nil)
                        elseif quality == 3 then
                            this.anima_handStar:Play("powerup_handstar_epic",0,0)
                            this.anima_showHand:Play("powerup_showhand_epic",0,0)
                           -- AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_epic",false,nil)
                        elseif quality == 2 then
                            this.anima_handStar:Play("powerup_handstar_great",0,0)
                            this.anima_showHand:Play("powerup_showhand_great",0,0)
                           -- AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_great",false,nil)
                        elseif quality == 1 then
                            this.anima_handStar:Play("powerup_handstar_good",0,0)
                            this.anima_showHand:Play("powerup_showhand_good",0,0)
                          --  AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_good",false,nil)
                        end
                        callback()
                    end
                    if not isCardList then
                        if buy_powerupcard_type == BuyPowerCardGenre.onegear then
                            UISound.play("powerup_energy_1")
                        elseif buy_powerupcard_type == BuyPowerCardGenre.twogear then
                            UISound.play("powerup_energy_2")    
                        elseif buy_powerupcard_type == BuyPowerCardGenre.threegear then
                            UISound.play("powerup_energy_3")    
                        end
                    else
                        local cardNum = #powerupcard
                        if cardNum == 3 then
                            UISound.play("powerup_energy_1")
                        elseif cardNum == 6 then
                            UISound.play("powerup_energy_2")   
                        elseif cardNum == 9 then
                            UISound.play("powerup_energy_3")       
                        end
                    end
                end
            end)
            this._tweenIndecator:SetEase(DG.Tweening.Ease.OutSine)
        end 
    else
        if index and index == 1 then
            --this.anim_title_shine:Play("powerup_title_shine01",0,1)
            AnimatorPlayHelper.Play(this.anim_title_shine,"powerup_title_shine01",true,nil)
        end
        if this._power == nil then
            this._power = Csv.GetControlByName("powerup_score")
        end
        if powerupcard then
            local card = nil
            local sourceValue = this.slider_power.value * this._power[4][1]
            local targetValue = 0
            local showStar = false
            local turnPage = index == nil
            local isCardList = false
            if type(powerupcard) == "table" then
                local power = 0
                isCardList = true
                for i, v in pairs(powerupcard) do
                    if v then
                        local pcard = Csv.powerup_card[v]
                        if pcard then
                            power = power + pcard.power
                        end
                    end
                end
                targetValue =  power
                showStar = true
            else
                card = Csv.powerup_card[powerupcard]
                if card then
                    targetValue = sourceValue + card.power
                else
                    log.r("Error:card is nil. id: " .. powerupcard)    
                end
                if index and index == lenth then
                    showStar = true
                end
            end
            if this._tweenIndecator then
                this._tweenIndecator:Complete()
            end
            this._tweenIndecator = Anim.do_smooth_float_update(sourceValue,targetValue,POWERUP_SHUFFLE_SPEED,
            function(num)
                this.slider_power.value = num / this._power[4][1]
            end,
            function(num)
                if showStar then
                    local callback = function()
                        this._fsm:GetCurState():FinishShowHand(this._fsm)
                        if not turnPage then
                            this:Play_PlayEffect()
                            --_currency:SetDisable(true)
                        end
                    end
                    if turnPage then
                        if num >= this._power[3][1] then
                            --this.anima_showHand:Play("powerup_showhand_epic",0,1)
                            this.anima_handStar:Play("powerup_handstar_epic",0,1)
                        elseif num >= this._power[2][1] then
                            --this.anima_showHand:Play("powerup_showhand_great",0,1)
                            this.anima_handStar:Play("powerup_handstar_great",0,1)
                        elseif num >= this._power[1][1] then
                            --this.anima_showHand:Play("powerup_showhand_good",0,1)
                            this.anima_handStar:Play("powerup_handstar_good",0,1)
                        else
                            --this.anima_showHand:Play("powerup_showhand_hide",0,1)
                            this.anima_handStar:Play("powerup_handstar_hide",0,1)
                        end
                        callback()
                    else
                        if num >= this._power[3][1] then
                            this.anima_handStar:Play("powerup_handstar_epic",0,0)
                            this.anima_showHand:Play("powerup_showhand_epic",0,0)
                          --  AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_epic",false,nil)
                        elseif num >= this._power[2][1] then
                            this.anima_handStar:Play("powerup_handstar_great",0,0)
                            this.anima_showHand:Play("powerup_showhand_great",0,0)
                           -- AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_great",false,nil)
                        elseif num >= this._power[1][1] then
                            this.anima_handStar:Play("powerup_handstar_good",0,0)
                            this.anima_handStar:Play("powerup_showhand_good",0,0)
                          --  AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_good",false,nil)
                        --else
                            --callback()
                        end
                        callback()
                    end
                    if not isCardList then
                        if buy_powerupcard_type == BuyPowerCardGenre.onegear then
                            UISound.play("powerup_energy_1")
                        elseif buy_powerupcard_type == BuyPowerCardGenre.twogear then
                            UISound.play("powerup_energy_2")    
                        elseif buy_powerupcard_type == BuyPowerCardGenre.threegear then
                            UISound.play("powerup_energy_3")    
                        end
                    else
                        local cardNum = #powerupcard
                        if cardNum == 3 then
                            UISound.play("powerup_energy_1")
                        elseif cardNum == 6 then
                            UISound.play("powerup_energy_2")   
                        elseif cardNum == 9 then
                            UISound.play("powerup_energy_3")       
                        end
                    end
                end
            end)
        end
    end
end

function PowerUpViewGoldNova:ShowHandPlayClick()
    self.anima_showHand.speed = 2 --加速播放showhand动画
end

function PowerUpViewGoldNova:DrawCardPlayClick()
    
end

function PowerUpViewGoldNova:OnClickDrawCard(gear)
    buy_powerupcard_type = gear
    local cardNum = ModelList.CityModel:GetCardNumber();
    if gear == BuyPowerCardGenre.onegear then
        local discount_id = power1gear:GetDiscountId()
        local discount_useId = power1gear:GetDiscountUseId()
        local powerup_cost = power1gear:GetPowerupCost()
        self:CheckGemCost(powerup_cost,function()
            ModelList.CityModel.C2S_BuyPowerUpCards(gear,discount_id,discount_useId,3,cardNum) 
        end)
    elseif gear == BuyPowerCardGenre.twogear then
        local discount_id = power2gear:GetDiscountId()
        local discount_useId = power2gear:GetDiscountUseId()
        local powerup_cost = power2gear:GetPowerupCost()
        self:CheckGemCost(powerup_cost,function()
            ModelList.CityModel.C2S_BuyPowerUpCards(gear,discount_id,discount_useId,3,cardNum)
        end)
    elseif gear == BuyPowerCardGenre.threegear then
        local discount_id = power3gear:GetDiscountId()
        local discount_useId = power3gear:GetDiscountUseId()
        local powerup_cost = power3gear:GetPowerupCost()
        self:CheckGemCost(powerup_cost,function()
           ModelList.CityModel.C2S_BuyPowerUpCards(gear,discount_id,discount_useId,3,cardNum)
        end)
    end
end

function PowerUpViewGoldNova:OnDisable()
    Facade.RemoveView(this)
   
    self:DisposeFsm()
    if self.efPlayTimer then
        self.efPlayTimer:Stop()
        self.efPlayTimer = nil
    end
    Event.Brocast(EventName.Event_topbar_change,true,TopBarChange.goback)
    enterFinishCallback = nil
    self:ResetGear()

    self:ClearBuffCountDown()
    self:ClearFromAdventureFlag()
    self:ClearBuffSeasonCountDown()
    self:ClearSmallGameCountDown()
    self.buffRemainTime = 0
    self.buffReaminTimeSnapshoot = nil
    self.smallGameRemainTime = 0
    self.isExtraRewardTipInit = nil
end

function PowerUpViewGoldNova:ResetGear()
    if power1gear then
        power1gear:ResetOnDisable()
    end
    if power2gear then
        power2gear:ResetOnDisable()
    end
    if power3gear then
        power3gear:ResetOnDisable()
    end
end

function PowerUpViewGoldNova:on_close()

end

function PowerUpViewGoldNova:OnDestroy()
     if this.puad_instance then 
        this.puad_instance:Close()
        this.puad_instance = nil 
    end 
    self:Close()
    self:DisposeFsm()
end

function PowerUpViewGoldNova:on_btn_help_click()
    self._fsm:GetCurState():ShowPowerupHelper(self._fsm)
end

function PowerUpViewGoldNova:OnShowPowerupHelper()
    Facade.SendNotification(NotifyName.ShowUI,ViewList.PowerupHelperView,nil,nil,true)
end

function PowerUpViewGoldNova:on_btn_close_click()
    self._fsm:GetCurState():CloseView(self._fsm,1)
end

function PowerUpViewGoldNova:OnClosePu()
    Facade.SendNotification(NotifyName.CloseUI,this)
end

function PowerUpViewGoldNova:OnCloseView()
    AnimatorPlayHelper.Play(self.anima,"PowerUpView_out",true,function()
        self._fsm:GetCurState():FinishClick(self._fsm)
        Facade.SendNotification(NotifyName.CloseUI,this)
    end)
end

function PowerUpViewGoldNova:on_btn_right_click()
    self:SetNextPageCards()
end

function PowerUpViewGoldNova:on_btn_left_click()
    self:SetPreviousPageCards()
end

---flag 是否发消息
function PowerUpViewGoldNova.OnPowerUpGearClick(gear)
   
    this._fsm:GetCurState():ClickDrawCard(this._fsm,gear,4)
end

function PowerUpViewGoldNova:CheckGemCost(cost,callback)
    Facade.SendNotification(NotifyName.ShopView.CheckCurrencyAvailable,8018,Resource.diamon,cost,function()
        if callback then
            callback()
        end
    end,function()
        self._fsm:GetCurState():FinishClick(self._fsm)
    end,nil,SHOP_TYPE.SHOP_TYPE_DIAMONDS,self)
end

function PowerUpViewGoldNova:on_btn_play_click()
    local falg,cost = ModelList.CityModel:CheckHaveNoEnoughCoin()
    if falg then
        Facade.SendNotification(NotifyName.ShopView.CheckCurrencyAvailable,8008,Resource.coin,cost,function()

        end,function()
            self._fsm:GetCurState():FinishClick(self._fsm)
         end,nil,SHOP_TYPE.SHOP_TYPE_CHIPS,nil)
        return 
    end 
    self._fsm:GetCurState():Play(self._fsm,2)
end

function PowerUpViewGoldNova:SendMsg2Server2EnterGame()
    local mode = ModelList.CityModel:GetEnterGameMode()
    if mode == PLAY_TYPE.PLAY_TYPE_NORMAL then
        local CmdEnterBattle = require "Logic.Command.Battle.Enter.CmdEnterBattle"
        local cmd = CmdEnterBattle.New()
        cmd:Execute()
    else
        ModelList.BattleModel:ReqEnterGame()
    end
    
        ---[[
    --fun.set_active(self.ef_play,false)
    --local mode = ModelList.CityModel:GetEnterGameMode()
    --ModelList.BattleModel:ReqEnterGame()
    --if mode ~= PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
    --    ModelList.GameModel:ReqEnterGame()
    --elseif mode == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
    --    ModelList.HangUpModel:ReqEnterHangUp()
    --end
    --]]
    --LoadSceneAsync("Test",nil)
end

function PowerUpViewGoldNova:OnPlay()
    local callBack = function()
        self:SendMsg2Server2EnterGame()
        Facade.SendNotification(NotifyName.CloseUI,self)
    end
    local cards = ModelList.CityModel:GetCardsCurrentPage(3)
    cards = #cards
    local animName = nil
    for i = 1, cards do
        card_entity_cache[i]:SetSortingOrder(100)
    end
    if 0 == cards and not isShowHint then
        --callBack()
        isShowHint = true
        Facade.SendNotification(NotifyName.ShowUI,ViewList.PowerUpHintView,nil)
        return
    elseif 3 == cards then
        animName = "powerup_cards_gather3"
    elseif 6 == cards then
        animName = "powerup_cards_gather6"
    elseif 9 == cards then
        animName = "powerup_cards_gather9"
    end
    if animName then
        AnimatorPlayHelper.Play(self.anima_cards,animName,false,function()
            callBack()
        end)
    else
        callBack()
    end
end

function PowerUpViewGoldNova.BuyPowerUpCards_result()
    --_currency:SetDisable(false)
    this:ResetPowerIndecator()
    local cards = ModelList.CityModel:GetCardsMaxPage(3)
    local card_num = #cards
    local card_gear = nil
    if card_num == BuyPowerCardGenre.onegear * 3 then
        this._drawCard = function()
            local time = 0
            for i = 1, #card_entity_cache do
                card_entity_cache[i]:SetPowerCardData(cards[i])
                card_entity_cache[i]:DoDrawCardsAction(time,power1gear:GetGearCardPos(),PowerUpCardEntityView.PowerUpQuality.good,i,card_num)
                time = time + POWERUP_SHUFFLE_SPEED - 0.01 * (i - 1)
            end
        end
        this._fsm:GetCurState():DrawCard(this._fsm,3)
        power1gear:SetVisible(false)
        card_gear = BuyPowerCardGenre.onegear
    elseif card_num == BuyPowerCardGenre.twogear * 3 then
        this._drawCard = function()
            local time = 0
            for i = 1, #card_entity_cache do
                card_entity_cache[i]:SetPowerCardData(cards[i])
                card_entity_cache[i]:DoDrawCardsAction(time,power2gear:GetGearCardPos(),PowerUpCardEntityView.PowerUpQuality.great,i,card_num)
                time = time + POWERUP_SHUFFLE_SPEED - 0.01 * (i - 1)
            end
        end
        this._fsm:GetCurState():DrawCard(this._fsm,6)
        power2gear:SetVisible(false)
        card_gear = BuyPowerCardGenre.twogear
    elseif card_num == BuyPowerCardGenre.threegear * 3 then
        this._drawCard = function()
            local time = 0
            for i = 1, #card_entity_cache do
                card_entity_cache[i]:SetPowerCardData(cards[i])
                card_entity_cache[i]:DoDrawCardsAction(time,power3gear:GetGearCardPos(),PowerUpCardEntityView.PowerUpQuality.epic,i,card_num)
                time = time + POWERUP_SHUFFLE_SPEED - 0.01 * (i - 1)
            end
        end
        this._fsm:GetCurState():DrawCard(this._fsm,9)
        power3gear:SetVisible(false)
        card_gear = BuyPowerCardGenre.threegear
    end
    --this.anim_title_shine:Play("powerup_title_shine02",0,1)
    AnimatorPlayHelper.Play(this.anim_title_shine,"powerup_title_shine02",true,nil)
    this.lightAnim:Play("act")
    power1gear:PlayCouponIdle()
    power2gear:PlayCouponIdle()
    power3gear:PlayCouponIdle()

    if buy_powerupcard_type ~= card_gear then
        log.r(string.format("=============================>>出错：powerup卡数和购买的档位不匹配,购买%s档获得%s档卡数！",buy_powerupcard_type,card_gear))
    end
end

function PowerUpViewGoldNova.OnDrawCardComplete()
    if this._fsm then
        this._fsm:GetCurState():OnDrawCardFinish(this._fsm)
    end
    if buy_powerupcard_type == BuyPowerCardGenre.onegear then
        power1gear:SetVisible(true)
    elseif buy_powerupcard_type == BuyPowerCardGenre.twogear then
        power2gear:SetVisible(true)
    elseif buy_powerupcard_type == BuyPowerCardGenre.threegear then
        power3gear:SetVisible(true)
    end
end

function PowerUpViewGoldNova:PlayEpicShake()
    --self.btn_epic_anim:Play("show",0,0)
    power3gear:PlayShake()
end

function PowerUpViewGoldNova.OnHintGoback(flag)
    this._fsm:GetCurState():GoBackPowerUp(this._fsm)

    if flag then 
       local PuAdflag =  power1gear:GetPuAdState()
       if PuAdflag then 
        power1gear:on_btn_PuAd_click()
       end 
    end 
end

function PowerUpViewGoldNova.OnNoThansk()
    this._fsm:GetCurState():SendMsg2Server2EnterGame(this._fsm)
end

function PowerUpViewGoldNova.OnSuccessBuy(id)
    if this.puad_instance then 
        this.puad_instance:OnSuccessBuy(id)
    end 
end

function PowerUpViewGoldNova.OnRefreshCouponInfo(coupon)
    power1gear:CheckCoupon(true)
    power2gear:CheckCoupon(true)
    power3gear:CheckCoupon(true)
end

function PowerUpViewGoldNova.OnGroupPrefixRefresh()
    this:SetCostInfo()
end 

function PowerUpViewGoldNova:on_btn_buy_buff_click()
    log.log("PowerUpViewGoldNova:on_btn_buy_buff_click")
    if ModelList.CityModel:IsPuBuffSeasonValid() then
        log.log("PowerUpViewGoldNova:on_btn_buy_buff_click ShowPUPack")
        ModelList.GiftPackModel:ShowPUPack()
        self:RecordBuffReaminTimeSnapshoot()
    end
end

function PowerUpViewGoldNova:UpdatePuBuffState()
    if ModelList.CityModel:CanCurPlayUsePuBuff() and (ModelList.CityModel:IsPuBuffSeasonValid() or ModelList.CityModel:GetPuBuffRemainTime() > 0) then
        fun.set_active(self.PuBuffPanel, true)
        fun.set_active(self.Img_drawCards, false)
        if ModelList.CityModel:GetPuBuffRemainTime() > 0 then
            power1gear:ShowCardSpriteByIndex(1)
            power2gear:ShowCardSpriteByIndex(1)
            power3gear:ShowCardSpriteByIndex(1)
            self:SetBuffLeftTime(ModelList.CityModel:GetPuBuffRemainTime())
        else
            power1gear:ShowCardSpriteByIndex(0)
            power2gear:ShowCardSpriteByIndex(0)
            power3gear:ShowCardSpriteByIndex(0)
            self:ClearBuffLeftTime()
        end

        if ModelList.CityModel:IsPuBuffSeasonValid() then
            --fun.set_color_grey(self.img_add, false)
            Util.SetUIImageGray(self.img_add.gameObject, false)
            if ModelList.CityModel:GetPuBuffRemainTime() <= 0 then
                --undo 动画突出+号
            end
        else
            --fun.set_color_grey(self.img_add, true)
            Util.SetUIImageGray(self.img_add.gameObject, true)
        end

        self:SetBuffSeasonLeftTime(ModelList.CityModel:GetPuBuffSeasonRemainTime())
        self:UpdatePuBuffCardIcon()
    else
        fun.set_active(self.PuBuffPanel, false)
        fun.set_active(self.Img_drawCards, true)
        power1gear:ShowCardSpriteByIndex(0)
        power2gear:ShowCardSpriteByIndex(0)
        power3gear:ShowCardSpriteByIndex(0)
        self:ClearBuffLeftTime()
    end

    fun.set_active(self.img_point, ModelList.GiftPackModel:CheckPUHaveFreePack())
end

function PowerUpViewGoldNova:ClearBuffLeftTime()
    self.buffRemainTime = 0
    self.text_buff.text = "00:00"
    self:PlayAddBtnAnim()
end

function PowerUpViewGoldNova:SetBuffLeftTime(remainTime)
    self.buffRemainTime = remainTime
    if self.buffRemainTime > 0 then
        if not self.buffRemainTimeCountDown then
            self.buffRemainTimeCountDown = RemainTimeCountDown:New()
        end
        self.buffRemainTimeCountDown:StartCountDown(CountDownType.cdt2, self.buffRemainTime, self.text_buff, 
        function()
            --时间到
            self:OnBuffTimeOver()
        end,
        function()
            self.buffRemainTime = self.buffRemainTime - 1
        end)
        self:StopAddBtnAnim()
    end
end

function PowerUpViewGoldNova:ClearBuffCountDown()
    if self.buffRemainTimeCountDown then
        self.buffRemainTimeCountDown:StopCountDown()
        self.buffRemainTimeCountDown = nil
    end
end

function PowerUpViewGoldNova:OnBuffTimeOver()
    self:UpdatePuBuffState()
    self:PlayGearDownAnima()
end

function PowerUpViewGoldNova:OnBuffTimeAdd()
    self:UpdatePuBuffState()
    if self.buffReaminTimeSnapshoot and self.buffReaminTimeSnapshoot <= 0 then
        if self.buffRemainTime and self.buffRemainTime > 0 then
            self:PlayGearUpAnima()
        else
        end
    end
end

function PowerUpViewGoldNova:SetBuffSeasonLeftTime(remainTime)
    self.buffSeasonRemainTime = remainTime
    if self.buffSeasonRemainTime > 0 then
        self:ClearBuffSeasonCountDown()
        self.buffSeasonRemainTimeCountDown = LuaTimer:SetDelayLoopFunction(0, 1, -1, function()
            self.buffSeasonRemainTime = self.buffSeasonRemainTime - 1
            if self.buffSeasonRemainTime <= 0 then
                self:OnBuffSeasonTimeOver()
            end
        end, nil, nil, LuaTimer.TimerType.UI)
    end
end

function PowerUpViewGoldNova:ClearBuffSeasonCountDown()
    if self.buffSeasonRemainTimeCountDown then
        LuaTimer:Remove(self.buffSeasonRemainTimeCountDown)
        self.buffSeasonRemainTimeCountDown = nil
    end
end

function PowerUpViewGoldNova:OnBuffSeasonTimeOver()
    self:ClearBuffSeasonCountDown()
    self:UpdatePuBuffState()
end

function PowerUpViewGoldNova:PlayGearDownAnima()
    fun.set_active(self.effect_out1, false)
    fun.set_active(self.effect_out2, false)
    fun.set_active(self.effect_out3, false)
    fun.set_active(self.effect_out1, true)
    fun.set_active(self.effect_out2, true)
    fun.set_active(self.effect_out3, true)
    fun.set_active(self.Effect_out, false)
    fun.set_active(self.Effect_out, true)
end

function PowerUpViewGoldNova:PlayGearUpAnima()
    fun.set_active(self.effect_enter1, false)
    fun.set_active(self.effect_enter2, false)
    fun.set_active(self.effect_enter3, false)
    fun.set_active(self.effect_enter1, true)
    fun.set_active(self.effect_enter2, true)
    fun.set_active(self.effect_enter3, true)
end

function PowerUpViewGoldNova:PlayAddBtnAnim()
    fun.play_animator(self.img_add, "act", true)
end

function PowerUpViewGoldNova:StopAddBtnAnim()
    fun.play_animator(self.img_add, "idle", true)
end

function PowerUpViewGoldNova.OnPowerUpBuffGifttPackClose(params)
    log.log("PowerUpViewGoldNova.OnPowerUpBuffGifttPackClose(params)", params)
    if params and params.isBuySucc then
        this:UpdatePuBuffState()
    end
    this.buffReaminTimeSnapshoot = nil
end

function PowerUpViewGoldNova:RecordBuffReaminTimeSnapshoot()
    log.log("PowerUpViewGoldNova:RecordBuffReaminTimeSnapshoot", self.buffRemainTime)
    self.buffReaminTimeSnapshoot = self.buffRemainTime
end

function PowerUpViewGoldNova:SetFromAdventureFlag()
    self.fromAdventureFlag = true
end

function PowerUpViewGoldNova:ClearFromAdventureFlag()
    self.fromAdventureFlag = nil
end

function PowerUpViewGoldNova:TryPopupPuBuffPackView()
    if not ModelList.CityModel:CanCurPlayUsePuBuff() then
        log.log("PowerUpViewGoldNova:TryPopupPuBuffPackView fail (此玩法不可使用此buff)")
        return false
    end

    if not ModelList.CityModel:IsPuBuffSeasonValid() then
        log.log("PowerUpViewGoldNova:TryPopupPuBuffPackView fail (赛季不可用)")
        return false
    end

    if self.fromAdventureFlag then
        log.log("PowerUpViewGoldNova:TryPopupPuBuffPackView fail (from adventrue)")
        return false
    end

    if ModelList.CityModel:GetPuBuffRemainTime() <= 0 then
        ModelList.CityModel:SetPuBuffStateRecord(false)
        if ModelList.CityModel:GetIsNeepPopupBuffPurchaseTipState() then
            log.log("PowerUpViewGoldNova:TryPopupPuBuffPackView succ 打开提示")
            Facade.SendNotification(NotifyName.ShowUI, ViewList.SeasonPowerUpChargeTipView)
            self:RecordBuffReaminTimeSnapshoot()
            ModelList.CityModel:RecordIsNeepPopupBuffPurchaseTipState(false)
            return true
        else
            log.log("PowerUpViewGoldNova:TryPopupPuBuffPackView 已经弹过Tip, 尝试直接打开礼包")
            ModelList.GiftPackModel:IsUnPopUpPuPack(false, false, false)
            self:RecordBuffReaminTimeSnapshoot()
            return false
        end
    else
        log.log("PowerUpViewGoldNova:TryPopupPuBuffPackView succ 直接打开")
        ModelList.GiftPackModel:IsUnPopUpPuPack(false, false, false)
        self:RecordBuffReaminTimeSnapshoot()
        return true
    end
end

function PowerUpViewGoldNova:UpdatePuBuffCardIcon()
    local cardId = ModelList.CityModel:GetPuBuffCardId()
    local powerCard = Csv.GetData("powerup_card", cardId)
    log.log("PowerUpViewGoldNova:UpdatePuBuffCardIcon cardId ", cardId)
    if powerCard and fun.is_not_null(self.img_icon)then
        self.img_icon.sprite = AtlasManager:GetSpriteByName("ItemAtlas", powerCard.icon)
    end
end

function PowerUpViewGoldNova:UpdateSmallGameState()
    if ModelList.SmallGameModel:CanOpenGameForBet() then
        fun.set_active(self.Img_play1, false)
        fun.set_active(self.Img_play2, true)
        self:UpdateSmallGameIcon(self.Img_smallGameIcon)
        self:StartSmallGameCountDown()
        local anima = fun.get_component(self.Img_play2, fun.ANIMATOR)
        if fun.is_not_null(anima) then
            AnimatorPlayHelper.Play(anima, {"Img_play2", "Img_play2"}, false, function()
                ModelList.GuideModel:TriggerSuperMatchPuGuide()
                UISound.play("supermatchpuactivate")
            end)
        end
    else
        fun.set_active(self.Img_play1, true)
        fun.set_active(self.Img_play2, false)
    end
end

function PowerUpViewGoldNova:UpdateExtraRewardState()
    local playId = ModelList.CityModel.GetPlayIdByCity()
    local curModel = ModelList.BattleModel.GetModelByPlayID(playId)
    if curModel.IsTriggerExtraReward then
        if curModel:IsTriggerExtraReward() then
            fun.set_active(self.Img_play1, false)
            fun.set_active(self.Img_play3, true)
            self:UpdateSmallGameIcon(self.Img_extraRewardIcon)
        else
            fun.set_active(self.Img_play1, true)
            fun.set_active(self.Img_play3, false)
        end
        if not self.isExtraRewardTipInit then
            self.Img_extraRewardIcon.sprite = curModel:GetExtraRewardTipIconSprite()
            self.isExtraRewardTipInit = true
        end
    else
        --fun.set_active(self.Img_play1, true)
        fun.set_active(self.Img_play3, false)
    end
end

function PowerUpViewGoldNova:StartSmallGameCountDown()
    self.smallGameRemainTime = ModelList.SmallGameModel:GetActivityRemainTime()
    if self.smallGameRemainTime > 0 then
        self:ClearSmallGameCountDown()
        self.smallGameRemainTimeCountDown = LuaTimer:SetDelayLoopFunction(0, 1, -1, function()
            self.smallGameRemainTime = self.smallGameRemainTime - 1
            if self.smallGameRemainTime <= 0 then
                self:OnSuperMatchTimeOver()
            end
        end, nil, nil, LuaTimer.TimerType.UI)
    end
end

function PowerUpViewGoldNova:OnSuperMatchTimeOver()
    self:ClearSmallGameCountDown()
    self:UpdateSmallGameState()
end

function PowerUpViewGoldNova:ClearSmallGameCountDown()
    if self.smallGameRemainTimeCountDown then
        LuaTimer:Remove(self.smallGameRemainTimeCountDown)
        self.smallGameRemainTimeCountDown = nil
    end
end


---根据当前小游戏类型更新icon
function PowerUpViewGoldNova:UpdateSmallGameIcon(img)
    local iconInfo = ModelList.SmallGameModel.GetCurrentGameIconInfo()
    if img and img.sprite then
        if not fun.starts(img.sprite.name ,iconInfo) then
            Cache.load_texture_to_sprite(iconInfo, img)
        end
    end
end

this.NotifyList = {
    {notifyName = NotifyName.Grocery.GroceryBuySuccess,func = this.OnSuccessBuy},
    {notifyName = NotifyName.PowerUps.PowerUpGearClick,func = this.OnPowerUpGearClick},
    {notifyName = NotifyName.PowerUps.FetchPowerUp_Result,func = this.OnFetchPowerUp_Result},
    {notifyName = NotifyName.PowerUps.Buy_PowerUp_Result,func = this.BuyPowerUpCards_result},
    {notifyName = NotifyName.PowerUps.DoTweenPowerIndecator,func = this.OnDoTweenPowerIndecator},
    {notifyName = NotifyName.PowerUps.DrawCardComplete, func = this.OnDrawCardComplete},
    {notifyName = NotifyName.PowerUps.Powerup_hint_goback, func = this.OnHintGoback},
    {notifyName = NotifyName.PowerUps.Powerup_hint_nothansk, func = this.OnNoThansk},
    {notifyName = NotifyName.HallMainView.RefreshCouponInfo, func = this.OnRefreshCouponInfo},
    {notifyName = NotifyName.PlayerInfo.RefreshGroupPrefix, func = this.OnGroupPrefixRefresh},
    {notifyName = NotifyName.PowerUps.Powerup_close, func = this.OnClosePu},
    {notifyName = NotifyName.PowerUps.PowerUpBuffGifttPackClose, func = this.OnPowerUpBuffGifttPackClose},
}

return this
