---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/7 10:38
---

local SettleDetailView  = BaseView:New('SettleDetailView', 'SettleAtlas');

local this              = SettleDetailView;
this.auto_bind_ui_items = {
    "bingo_awards_clone",
    "single_card_clone",
    "text_coin_summary",
    "Content",
    "btn_continue",
    --"TopCurrencyView",
    "SafeArea",
    "sumary",
    "effContainer",
    "btn_goback",
    "Items_Bg", --items 后面得bg
    "icon_Double",
    "img_DoubleTitle",
    "img_DoubleBg",
    "icon_Double1",
    "icon_Double2",
    "icon_Double3",
    "btn_speedUp",
    "reward_type_icon",

    "JokerBg",
    "img_coin_summary",
    "img_items_summary",
    "img_bingo_summary",
    "img_card_summary",
    "superMatchSmash",
    "smashIcon",
    "ticketPanel",
    "ticketNum",
    "ticketItem",
}
local CardsSummaryItems = require "View.Bingo.UIView.ChildView.CardsSummaryItems"
--require "View/CommonView/TopCurrencyView"
--local _currency = TopCurrencyView:New()

this.settleData         = nil
this.played_round1_exit = false
this.is_isclick         = false
this.round              = 1
this.model              = nil
Rocket_State            = { None = 0, Rocket = 1, Diamond = 2, Ad = 3, Skip = 4, Ad_Complete = 5 }
this.rocket_state       = Rocket_State.None
--结算之前周榜段位
this.lastWeekTier       = 0;
--结算前周榜积分
this.lastWeekScore      = 0;
--结算前排名信息
this.lastWeekRankInfo   = nil;
--周榜积分请求是否有回包
this.hasWeekRankInfoRes = false;

local TimeOutList       = {}

function SettleDetailView.Awake(obj)
    this:on_init()
    this:SetControlModel()
    this:OpenRound5()
end

function SettleDetailView.OnEnable()
    Facade.RegisterView(this)
    this:SetJokerSkin()
    ModelList.BattleModel:GetCurrBattleView():ProvideBgToSettleView()
    ModelList.BattleModel:SetShowDetail(true)
    --Facade.SendNotification(NotifyName.CloseUI,ModelList.BattleModel:GetCurrBattleView())
end

function SettleDetailView.OnDisable()
    this:ClearTimeList()
    Facade.RemoveView(this)
    --log.r("SettleDetailView:on_close")
    this.update_x_enabled = false
    this:stop_x_update()
    this.isWaitingTrounamentData = false
end

function SettleDetailView.OnDestroy()
    this:Destroy()
    ModelList.BattleModel:SetShowDetail(false)
end

function SettleDetailView:SetControlModel()
    this.model = ModelList.BattleModel:GetCurrModel()
    if this.model == nil then
        log.r("no  game battle model")
    end
end

--结算面板 阶段4  显示Round5
function SettleDetailView:OpenRound5()
    this.round = 5

    if ModelList.CarQuestModel:IsActivityAvailable() then
        UISound.play("racinglist")
    else
        UISound.play("settlement_open")
    end


    this:HandleRound5()
    local tmpLuaTimer = LuaTimer:SetDelayFunction(3, function ()
        Event.Brocast(EventName.Test_SettleDetailView)
    end)
    table.insert(TimeOutList, tmpLuaTimer)
    this:initSpeedUp()
    coroutine.start(function ()
        WaitForFixedUpdate()
        Cache.Load_Atlas(AssetList["PuzzleAtlas"], "PuzzleAtlas")
    end)
end

--结算面板 阶段5处理
function SettleDetailView:HandleRound5()
    coroutine.start(function ()
        WaitForEndOfFrame()
        this.settleData = this.model:GetSettleData()
        local firstChips = this.settleData.chips
        --this.settleData.hasJokerMoreCoins = true
        if this.settleData.hasJokerMoreCoins then
            firstChips = firstChips / 2
        end
        if fun.is_null(this.text_coin_summary) then
            return
        end
        this.text_coin_summary:RollByTime(firstChips, 1, function ()
            if this.settleData.hasJokerMoreCoins then
                this:PlayJokerDoublePayout()
            end
            fun.ForceRebuildLayoutImmediate(this.text_coin_summary.transform.parent)
        end)
        WaitForEndOfFrame()
        UISound.play("settlement_statistics")
        WaitForEndOfFrame()
        this:CreatSummaryItem()
        WaitForFixedUpdate()
        this:SettleBingoAwards()
        WaitForFixedUpdate()
        --等动画完成再出来
        local tmpLuaTimer = LuaTimer:SetDelayFunction(1.8, function ()
            this:SettleItemsAwards()
        end)
        table.insert(TimeOutList, tmpLuaTimer)
        this.hasWeekRankInfoRes = false;
        WaitForFixedUpdate()
        this:CheckSmash()
        WaitForFixedUpdate()
        this:DestoryBingoView()
    end)
end

function SettleDetailView:DestoryBingoView()
    GoPool.destroy_go_pool_dic()
    --local bingoView = ModelList.BattleModel:GetCurrBattleView():GetBingoView()
    --Destroy(bingoView)
end

function SettleDetailView:PlayJokerDoublePayout()
    Cache.load_prefabs(AssetList["clown_doublejiesuan"], "clown_doublejiesuan", function (prefab)
        if prefab then
            local obj = fun.get_instance(prefab)
            if obj then
                local parent = this.reward_type_icon.transform or this.text_coin_summary.transform.parent.parent.parent
                obj.transform:SetParent(parent)
                obj.transform.localScale = Vector3.one
                --if not fun.is_null(this.reward_type_icon ) then
                --    fun.set_same_position_with(obj,this.text_coin_summary.gameObject)
                --end
                --fun.set_rect_local_pos(obj,0,0,0)
                obj.transform.localPosition = Vector3.New(0, 0, 0)
                fun.set_active(obj, true)
                if this.settleData.hasJokerMoreCoins then
                    this.text_coin_summary.text = fun.NumInsertComma(this.settleData.chips)
                    fun.ForceRebuildLayoutImmediate(this.text_coin_summary.transform.parent)
                end
            end
        end
    end)
end

function SettleDetailView:SelectCardSummaryBg()
    coroutine.start(function ()
        local switchView = ModelList.BattleModel:GetCurrBattleView():GetSwitchView()
        local gameType = ModelList.BattleModel:GetGameCityPlayID()
        local summaryData = Csv.GetData("new_game_settle", gameType, "settle_card_summary")
        --- settle_card_summary 0:默认初始红色筹码 1:跟随游戏内switch界面
        if summaryData and summaryData == 1 and switchView then
            switchView:DestorySwitchEffect(1)
            WaitForEndOfFrame()
            for i = 1, ModelList.BattleModel:GetCurrModel():GetCardCount() do
                local img = fun.get_component(this.single_card_clone, fun.IMAGE)
                if img then
                    img.enabled = false
                end
                local obj1 = switchView:GetSmallCardObj(i)
                local newCard = fun.get_instance(obj1, this.single_card_clone.transform.parent, true)
                fun.set_gameobject_scale(newCard, 1, 1, 1)
                WaitForFixedUpdate()
                switchView:RefrshAllSwitchItems(newCard, i)
                WaitForFixedUpdate()
                switchView:ShowBingoFont(newCard, i)
                WaitForFixedUpdate()
            end
        else
            local roundata = this.model:GetRoundData()
            if roundata then
                self.cardsItems = {}
                local len = 0
                for k, v in pairs(roundata) do
                    len = len + 1
                end
                for i = 1, len do
                    local v = roundata[tostring(i)]
                    local reapData = { isBingo = v.isBingo, isJackpot = v.isJackpot, cards = {} }
                    for j = 1, #v.cards do
                        if v.cards[j].sign and v.cards[j].sign > 0 then
                            table.insert(reapData.cards, v.cards[j])
                        end
                    end
                    local go = fun.get_instance(this.single_card_clone, self.Content)
                    reapData.go = go
                    self.cardsItems[i] = reapData
                    WaitForEndOfFrame()
                    fun.set_active(go, true, 0)
                    CardsSummaryItems:New(go, reapData)
                    WaitForEndOfFrame()
                end

                self:CheckSoltSpin()
            end
        end
    end)
end

-- 结算面板 Card SUmmary 信息
function SettleDetailView:CreatSummaryItem()
    self:SelectCardSummaryBg()
    if ModelList.BattleModel:GetCurrModel():GetCardCount() > 4 then
        local refTemp = fun.get_component(self.go, fun.REFER)
        local Content = refTemp:Get("Content")
        local rect = fun.get_component(Content.gameObject, fun.RECT)
        rect.pivot = Vector2.New(1, 0.5)
    else
        local refTemp = fun.get_component(self.go, fun.REFER)
        local Content = refTemp:Get("Content")
        local rect = fun.get_component(Content.gameObject, fun.RECT)
        rect.pivot = Vector2.New(0.5, 0.5)
    end
end

function SettleDetailView:GetSpecialFlagImgName()
    local playType = ModelList.BattleModel:GetGameType()
    if playType == PLAY_TYPE.PLAY_TYPE_SOLITAIRE then
        return "FlatJSicon2"
    end
    return "FlatJSicon"
end

--结算面板 bingo Awards 展示
function SettleDetailView:SettleBingoAwards()
    local refTemp = fun.get_component(self.go, fun.REFER)
    local count = 0
    if #this.settleData.tips == 0 then
        local no_bingo_tip = refTemp:Get("no_bingo_tip")
        local tip_content = Csv.GetData("description", 90001, "description")
        no_bingo_tip.text = tip_content
        fun.set_active(no_bingo_tip.gameObject, true)
        return
    end
    local clone = refTemp:Get("bingo_awards_clone")

    --- 同时创建太多，会卡顿，所以协程分帧创建
    coroutine.start(function ()
        --1.16版本之后，前端计算bingo显示文字
        table.each(this.settleData and this.settleData.tips, function (data)
            local go = fun.get_instance(clone, clone.gameObject.transform.parent)
            WaitForEndOfFrame()
            fun.set_active(go, true, 0)
            local chile = fun.find_child(go, "text_coin_awards")
            local content = fun.get_component(chile, "Text")
            content.text = fun.formatNum(tonumber(data.content))

            --达成bingo数的文字
            local chile2 = fun.find_child(go, "text_bingo_awards")
            local tip = fun.get_component(chile2, "Text")
            local desID, color = self:GetBingoAwardDesID(data)
            desID = desID or data.tip
            local cc = Csv.GetData("description", desID, "description")

            if color then
                tip.color = color
                local img_coin = fun.find_child(go, "img_coin")
                if img_coin then
                    local superBingoFlag = fun.get_instance(img_coin, img_coin.gameObject.transform.parent)
                    fun.set_active(superBingoFlag, true)
                    local flagIconName = self:GetSpecialFlagImgName()
                    Cache.load_texture(AssetList[flagIconName], flagIconName, function (objs)
                        if objs then
                            local sprite = Util.Texture2Sprite(objs)
                            local sp = fun.get_component(superBingoFlag, fun.IMAGE)
                            if sp and sprite then
                                sp.sprite = sprite
                                sp:SetNativeSize()
                            end
                        end
                    end)

                    fun.set_rect_local_pos(superBingoFlag, -394, 0, 0)
                end
                tip.text = "    " .. cc
            else
                tip.text = cc
            end

            --bingo tacular  和 jackpot 需要橙色显示
            if desID >= 9 and desID <= 22 then
                tip.color = Color.New(1, 0.832, 0.1836, 1)
                local out_line = fun.get_component(chile2, "Outline")
                out_line.effectColor = Color.New(0.1797, 0.01172, 0.3672, 1)
            end

            local child3 = fun.find_child(go, "imgMatch")
            if fun.is_not_null(child3) then
                if data.bingoNum == -2 then
                    fun.set_active(child3, true)
                else
                    fun.set_active(child3, false)
                end
            end
            count = count + 1
            WaitForEndOfFrame()
        end)

        if count > 5 then
            local BingoContent = refTemp:Get("BingoContent")
            local rect = fun.get_component(BingoContent.gameObject, fun.RECT)
            rect.pivot = Vector2.New(0.5, 0)
        end
    end)
end

function SettleDetailView:GetBingoAwardDesID(data)
    local playID, desID = ModelList.BattleModel:GetGameCityPlayID()
    if data.bingoNum then
        if data.bingoNum > 0 then
            local cfg = table.find(Csv["bingo_reward"], function (key, value)
                if value.city_play_id ~= playID then return end
                return value.bingo == data.bingoNum
            end)
            if cfg then
                desID = cfg.description
            end
        elseif data.bingoNum == -2 then
            desID = 85006
        else
            local playType = ModelList.BattleModel:GetGameType()
            if playType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
                desID = 33
            else
                desID = 10
            end
        end
    end
    local color = nil
    --data.layerNum = 1
    if data.layerNum and data.layerNum > 0 then
        color = Color(1, 1, 0.184, 1)
    end
    if data.bingoOrder and data.bingoOrder > 0 then
        local cfg = table.find(Csv["bingo_rank"], function (key, value)
            if value.city ~= playID then return end
            return value.rank == data.bingoOrder
        end)
        if cfg then
            desID = cfg.description
        end
    end

    local playType = ModelList.BattleModel:GetGameType()
    if playType == PLAY_TYPE.PLAY_TYPE_SCRATCH_WINNER then
        color = nil
        if data.layerNum and data.layerNum > 0 then
            local desList = { 85009, 85010, 85011, 85012, 85013 }
            desID = desList[data.layerNum] or 85009
        end
    elseif playType == PLAY_TYPE.PLAY_TYPE_CHRISTMAS_SYNTHESIS then
        if data.layerNum and data.layerNum > 0 then
            local desList = { 191031, 191032, 191033, 191034, 191035,191036 }
            desID = desList[data.layerNum] or 191031
        end
    elseif playType == PLAY_TYPE.PLAY_TYPE_LET_THEM_ROLL then
        if data.bingoNum and data.bingoNum >= 3 then
            desID = 191078
        end
    elseif playType == PLAY_TYPE.PLAY_TYPE_PIGGY_BANK then
        if data.layerNum and data.layerNum > 0 then
            local desList = {191099, 191100, 191101}
            desID = desList[data.bingoNum] or 191099
        end
    end

    return desID, color
end

local ShowRewardEffect = function (startPos, itemId, icon)
    --if itemId < 1000 then
    Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts, startPos, itemId, function ()
        Event.Brocast(EventName.Event_currency_change)
    end, icon)
    --end
end

--结算面板显示完美金币
function SettleDetailView:ShowPerfectCoin(clone, count, delay, interval)
    if #this.settleData.perfectMarkReward > 0 and this.settleData.perfectMarkReward[1].value > 0 then
        local go = fun.get_instance(clone, clone.transform.parent)
        fun.set_active(go, true, 0)
        local text = fun.find_child(go, "text")
        local tip = fun.get_component(text, "Text")
        tip.text = fun.formatNum(this.settleData.perfectMarkReward[1].value)
        local chile = fun.find_child(go, "icon")
        local mIcon = fun.get_component(chile, fun.IMAGE)
        mIcon.sprite = AtlasManager:GetSpriteByName("GameItemAtlas", "iconPerfectCoins")
        count = count + 1
        local tmpLuaTimer = LuaTimer:SetDelayFunction(delay, function ()
            ShowRewardEffect(fun.get_gameobject_pos(mIcon.gameObject, false), 2, mIcon)
        end)
        table.insert(TimeOutList, tmpLuaTimer)
        delay = delay + interval
    end
    return count, delay
end

local function IsIngredirnts(itemId, need_item_type)
    if Csv.GetData("item", itemId, "item_type") == 1 then
        return true
    end
    return false
end

local function IsCookie(itemId)
    if Csv.GetData("item", itemId, "item_type") == 3 then
        return true
    end
    return false
end

local function IsWinZoneItem(itemId)
    if Csv.GetData("item", itemId, "item_type") == 24 then
        return true
    end
    return false
end

function SettleDetailView:CheckJokerResourceItemCount(data)
    local count = data.value
    local puCfg = table.find(Csv["new_powerup"], function (k, v)
        return v.itemid == data.id
    end)
    local checkJokerResource = puCfg and puCfg.result[1] == 18
    if checkJokerResource then
        local result = Csv.GetItemOrResource(data.id, "result")
        if result[1] == 29 then
            --周榜奖杯
            local temp = (result[3] or 2) * 0.0001
            --单卡价格
            local singleCardCost = ModelList.CityModel:GetCostCoin(1)
            --获得数量x单卡价格x百分比系数后最终的数量
            count = count * singleCardCost * temp
            count = math.floor(count)
            return count
        else
            local temp = result[3] or 1
            return count * temp
        end
    end
    return count
end

function SettleDetailView:CheckItemAwardDouble(itemId, go)
    if this.model:GetSettleData().showDouble then
        for i = 1, #this.model:GetSettleData().showDouble do
            if this.model:GetSettleData().showDouble[i].id == itemId and this.model:GetSettleData().showDouble[i].double == 1 then
                local chile = fun.find_child(go, "double")
                -- local mIcon = fun.get_component(chile, fun.IMAGE)
                -- mIcon.sprite = AtlasManager:GetSpriteByName("CommonAtlas", "IconDoubleDay")
                fun.set_active(chile, true)
            end
        end
    end
end

--结算面板道具 Awards 展示
function SettleDetailView:SettleItemsAwards()
    coroutine.start(function ()
        local refTemp = fun.get_component(self.go, fun.REFER)
        local clone = refTemp:Get("item_award_clone")
        local count = 0
        local delay = 0.5
        local interval = 0.2

        local PuzzleOpen = ModelList.BattleModel.GetBattlePuzzleDouble() --拼图活动开启
        local FoodOpen = ModelList.BattleModel.GetBattleFoodDouble()     --双倍食物
        local CookiesOpen = ModelList.BattleModel.GetBattleCookeDouble() --双倍饼干

        ---显示快速点击金币
        if #this.settleData.fastMarkReward > 0 then
            local go = fun.get_instance(clone, clone.transform.parent)
            WaitForEndOfFrame()
            fun.set_active(go, true, 0)
            local text = fun.find_child(go, "text")
            local tip = fun.get_component(text, "Text")
            tip.text = fun.formatNum(this.settleData.fastMarkReward[1].value)
            local chile = fun.find_child(go, "icon")
            local mIcon = fun.get_component(chile, fun.IMAGE)
            mIcon.sprite = AtlasManager:GetSpriteByName("GameItemAtlas", "iconFastCoins")
            count = count + 1
            local tmpLuaTimer = LuaTimer:SetDelayFunction(delay, function ()
                ShowRewardEffect(fun.get_gameobject_pos(mIcon.gameObject, false), 2, mIcon)
            end)
            table.insert(TimeOutList, tmpLuaTimer)
            delay = delay + interval
            WaitForEndOfFrame()
        end

        ---显示完美点击金币
        count, delay = this:ShowPerfectCoin(clone, count, delay, interval)
        WaitForEndOfFrame()
        --如果是双倍得话要显示双倍不同得奖励
        if PuzzleOpen or FoodOpen or CookiesOpen then
            fun.set_active(this.Items_Bg, false)
            fun.set_active(this.img_DoubleBg, true)
            fun.set_active(this.img_DoubleTitle, true)
            fun.set_active(this.icon_Double, true)
            --增加不同类得icon显示
            fun.set_active(this.icon_Double1, false)
            fun.set_active(this.icon_Double2, false)
            fun.set_active(this.icon_Double3, false)

            if PuzzleOpen == true and FoodOpen == false and CookiesOpen == false then
                this.icon_Double.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon03")
            elseif PuzzleOpen == false and FoodOpen == true and CookiesOpen == false then
                this.icon_Double.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon01")
            elseif PuzzleOpen == false and FoodOpen == false and CookiesOpen == true then
                this.icon_Double.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon02")
            elseif PuzzleOpen == true and FoodOpen == true and CookiesOpen == false then
                fun.set_active(this.icon_Double, false)
                fun.set_active(this.icon_Double1, true)
                fun.set_active(this.icon_Double2, true)
                this.icon_Double1.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon03")
                this.icon_Double2.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon01")
            elseif PuzzleOpen == true and FoodOpen == false and CookiesOpen == true then
                fun.set_active(this.icon_Double, false)
                fun.set_active(this.icon_Double1, true)
                fun.set_active(this.icon_Double2, true)
                this.icon_Double1.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon03")
                this.icon_Double2.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon02")
            elseif PuzzleOpen == false and FoodOpen == true and CookiesOpen == true then
                fun.set_active(this.icon_Double, false)
                fun.set_active(this.icon_Double1, true)
                fun.set_active(this.icon_Double2, true)
                this.icon_Double1.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon01")
                this.icon_Double2.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon02")
            elseif PuzzleOpen == true and FoodOpen == true and CookiesOpen == true then
                fun.set_active(this.icon_Double, false)
                fun.set_active(this.icon_Double1, true)
                fun.set_active(this.icon_Double2, true)
                fun.set_active(this.icon_Double3, true)
                this.icon_Double1.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon03")
                this.icon_Double2.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon01")
                this.icon_Double3.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "DoubleDayJsIcon02")
            end
            WaitForEndOfFrame()
        else
            fun.set_active(this.Items_Bg, true)
            fun.set_active(this.img_DoubleBg, false)
            fun.set_active(this.img_DoubleTitle, false)
            fun.set_active(this.icon_Double, false)
            fun.set_active(this.icon_Double1, false)
            fun.set_active(this.icon_Double2, false)
            fun.set_active(this.icon_Double3, false)
        end
        WaitForEndOfFrame()
        --- 显示小丑卡bonuses区域奖励
        if #this.settleData.bonusesReward > 0 then
            local go = fun.get_instance(clone, clone.transform.parent)
            WaitForEndOfFrame()
            fun.set_active(go, true, 0)
            local text = fun.find_child(go, "text")
            local tip = fun.get_component(text, "Text")
            tip.text = fun.formatNum(this.settleData.bonusesReward[1].value)
            local chile = fun.find_child(go, "icon")
            local mIcon = fun.get_component(chile, fun.IMAGE)
            mIcon.sprite = AtlasManager:GetSpriteByName("GameItemAtlas", "iconJokerCoins")
            count = count + 1
            local tmpLuaTimer = LuaTimer:SetDelayFunction(delay, function ()
                ShowRewardEffect(fun.get_gameobject_pos(mIcon.gameObject, false), 2, mIcon)
            end)
            table.insert(TimeOutList, tmpLuaTimer)
            delay = delay + interval
            WaitForEndOfFrame()
        end

        this:CalculateActivityItem()

        for j = 1, #this.settleData.reward do
            if not this:IsSmashItem(this.settleData.reward[j].id) then
                local go = fun.get_instance(clone, clone.transform.parent)
                WaitForEndOfFrame()
                fun.set_active(go, true, 0)
                local text = fun.find_child(go, "text")
                local tip = fun.get_component(text, "Text")
                --local itemCount = this:CheckJokerResourceItemCount(this.settleData.reward[j])
                tip.text = fun.formatNum(this.settleData.reward[j].value)
                local chile = fun.find_child(go, "icon")
                local mIcon = fun.get_component(chile, fun.IMAGE)
                --this:GetItemIcon(this.settleData.reward[j].id, mIcon)
                this:CheckItemAwardDouble(this.settleData.reward[j].id, go)
                count = count + 1
                local tmpLuaTimer = LuaTimer:SetDelayFunction(delay, function ()
                    ShowRewardEffect(fun.get_gameobject_pos(mIcon.gameObject, false), this.settleData.reward[j].id, mIcon)
                end)
                table.insert(TimeOutList, tmpLuaTimer)
                delay = delay + interval
                WaitForEndOfFrame()
            end
        end

        local item_rect = fun.get_component(clone.transform.parent, fun.RECT)
        local ori_size = item_rect.sizeDelta
        local len = #this.settleData.reward -- + #this.settleData.rewardItemResource
        item_rect.sizeDelta = Vector2.New(173.6 * len + 20, ori_size.y)
        if count > 5 then
            local item_Content = refTemp:Get("item_Content")
            local rect = fun.get_component(item_Content.gameObject, fun.RECT)
            rect.pivot = Vector2.New(1, 0.5)
        else
            local item_Content = refTemp:Get("item_Content")
            local rect = fun.get_component(item_Content.gameObject, fun.RECT)
            rect.pivot = Vector2.New(0.5, 0.5)
        end
    end)
end

function SettleDetailView:CalculateActivityItem()
    --赛车玩法收集到的油桶
    local oilDrumCollect = {}
    table.each(this.settleData.reward, function (v, k)
        local cfg = Csv.GetData("item", v.id)
        if cfg and cfg["item_type"] and cfg["item_type"] == 20 then
            table.insert(oilDrumCollect, v)
        end
    end)
    ModelList.CarQuestModel:RecordOilDrumCollect(oilDrumCollect)

    --火山玩法收集到的道具
    local volcanoMissionItemType
    table.each(this.settleData.reward, function (v, k)
        local cfg = Csv.GetData("item", v.id)
        if cfg and cfg["item_type"] and cfg["item_type"] == 33 then
            volcanoMissionItemType = cfg["level"]
        end
    end)
    ModelList.VolcanoMissionModel:RecordBattleCollectItemType(volcanoMissionItemType)
end

function SettleDetailView:GetItemIcon(itemid, img)
    if ModelList.SeasonCardModel:IsCardPackage(itemid) then
        local cardCfg = ModelList.SeasonCardModel:GetCardPackageInfo(itemid)
        local item_info = cardCfg and cardCfg.icon or ""
        --local item_info = Csv.GetData("season_card_box", itemid,"icon")
        ViewTool:LoadBattleGiftSprite(nil, img, item_info)
    elseif IsWinZoneItem(itemid) then --WinZone道具
        local itemIcon = Csv.GetData("item", itemid, "icon")
        if not string.is_empty(itemIcon) then
            img.sprite = AtlasManager:GetSpriteByName("ItemAtlas", itemIcon)
            fun.set_recttransform_native_size(img, 125, 125)
        end
    elseif itemid > 1000 then
        log.r(" Item  " .. itemid)
        local item_info = Csv.GetData("item", itemid)
        local item_type = item_info["item_type"]
        ViewTool:LoadBattleGiftSprite(item_type, img, item_info["icon"])
    elseif itemid == 25 then --杯赛图标,需要定期切换
        Cache.Load_Atlas(AssetList["CompetitionCookieAtlas"], "CompetitionCookieAtlas", function ()
            img.sprite = AtlasManager:GetSpriteByName("CompetitionCookieAtlas", "BsCookieTtb")
        end)
    elseif itemid == RESOURCE_TYPE.RESOURCE_TYPE_RACING_CAR_OIL then --杯赛图标,需要定期切换
        Cache.Load_Atlas(AssetList["GameItemAtlas"], "GameItemAtlas", function ()
            img.sprite = AtlasManager:GetSpriteByName("GameItemAtlas", "CarYT")
        end)
    else
        local item_info = Csv.GetData("resources", itemid, "icon")
        log.y("结算  " .. itemid .. "    " .. item_info)
        img.sprite = AtlasManager:GetSpriteByName("ItemAtlas", item_info)
    end
end

function SettleDetailView:HasSettleData()
    return this.model:IsGameSettling()
end

local last_click_time = 0
--如果4秒内没回，无需再次点击，可进入到下个环节

function SettleDetailView:on_btn_continue_click()
    if UnityEngine.Time.time - last_click_time > 2 then --点击那么多下没啥作用的
        local playType = ModelList.BattleModel:GetGameType()
        if playType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
            --在Winzone游戏中,如果名人堂活动结束，不展示爬升界面
            if not ModelList.HallofFameModel:IsActivityAvailable() then
                this:Jump2puzzle()
                last_click_time = UnityEngine.Time.time
                return
            end
        end

        if ModelList.TournamentModel:IsActivityAvailable() then
            if ModelList.TournamentModel:IsTrouamentClimbRank() and ModelList.TournamentModel:IsClimbToUp() then
                self:ShowTrounament()
            else
                this:Jump2SuperMatchSmash()
            end
        elseif ModelList.HallofFameModel:IsActivityAvailable() then
            if ModelList.HallofFameModel:IsFameClimbRank() and ModelList.HallofFameModel:IsClimbToUp() then
                self:ShowHallOfFame()
            else
                this:Jump2SuperMatchSmash()
            end
        else
            this:Jump2SuperMatchSmash()
        end

        last_click_time = UnityEngine.Time.time
    end
end

function SettleDetailView:ShowTrounament()
    --请求周榜积分信息
    this.lastWeekScore = ModelList.TournamentModel:GetMayRankScore();
    this.lastWeekRankInfo = ModelList.TournamentModel:GetMyRankInfo();
    this.lastWeekTier = ModelList.TournamentModel:GetTierByScore(this.lastWeekScore);
    this.isWaitingTrounamentData = true

    ModelList.TournamentModel:C2S_RequestTournamentRankInfo(true)
    local tmpLuaTimer = LuaTimer:SetDelayFunction(4, function () --原来时间是2秒，如果数据太多，网络差的情况会出现重叠情况
        if not this.hasWeekRankInfoRes then
            this.hasWeekRankInfoRes = true;
            log.g("on_btn_continue_click to Jump2TrounamentSettle")
            this:Jump2TrounamentSettle()
        end
    end, nil, LuaTimer.TimerType.UI);
    table.insert(TimeOutList, tmpLuaTimer)
end

function SettleDetailView:ShowHallOfFame()
    this.lastWeekScore = ModelList.HallofFameModel:GetMayRankScore()
    this.lastWeekRankInfo = ModelList.HallofFameModel:GetMyRankInfo()
    this.lastWeekTier = ModelList.HallofFameModel:GetTierByScore(this.lastWeekScore)
    this.isWaitingTrounamentData = true

    ModelList.HallofFameModel:C2S_RequestRankInfo(true)
    --原来时间是2秒，如果数据太多，网络差的情况会出现重叠情况
    local tmpLuaTimer = LuaTimer:SetDelayFunction(4, function ()
        if not this.hasWeekRankInfoRes then
            this.hasWeekRankInfoRes = true
            log.g("on_btn_continue_click to Jump2FameRank")
            this:Jump2FameRank()
        end
    end, nil, LuaTimer.TimerType.UI)
    table.insert(TimeOutList, tmpLuaTimer)
end

function SettleDetailView:Jump2TrounamentSettle()
    local viewName = ""
    if ModelList.TournamentModel:CheckIsBlackGoldUser() then
        viewName = "TournamentBlackGoldSettleView"
    else
        viewName = "TournamentSettleView"
    end
    Facade.SendNotification(NotifyName.ShowUI, ViewList[viewName], function ()
        fun.set_active(this.sumary, false, false)
    end, false, function ()
        this.Jump2SuperMatchSmash();
    end)
end

function SettleDetailView:Jump2FameRank()
    local viewName = ""
    if ModelList.HallofFameModel:CheckIsTrueGoldUser() then
        viewName = "HallofFameGoldRank2View"
    else
        viewName = "HallofFameRank2View"
    end
    Facade.SendNotification(NotifyName.ShowUI, ViewList[viewName], function ()
        fun.set_active(this.sumary, false, false)
    end, false, function ()
        this.Jump2SuperMatchSmash()
    end)
end

--周榜排名数据
function SettleDetailView.OnResphoneTournamentInfo()
    if this.hasWeekRankInfoRes == true then
        return
    end
    local model = ModelList.TournamentModel
    if this.isWaitingTrounamentData then
        this.isWaitingTrounamentData = false
    else
        return
    end

    this.hasWeekRankInfoRes = true;
    local tier = ModelList.TournamentModel:GetTiers();
    local isUpTier = this.lastWeekTier < tier;
    local oldScore = this.lastWeekScore;
    if isUpTier or ModelList.TournamentModel:CheckHasStateAward() then
        log.g("recive data OnResphoneTournamentInfo 2 TournamentScoreView")
        Facade.SendNotification(NotifyName.ShowUI, ViewList.TournamentScoreView, function ()
            fun.set_active(this.sumary, false, false)
        end, false, {
            callBack = function ()
                this:Jump2SuperMatchSmash();
            end,
            isUpTier = isUpTier,
            oldScore = oldScore,
            lastWeekTier = this.lastWeekTier,
            isSettle = true,
            lastWeekRankInfo = this.lastWeekRankInfo
        })
    else
        log.g("recive data OnResphoneTournamentInfo Jump2TrounamentSettle")
        this:Jump2TrounamentSettle();
    end
end

--名人堂
function SettleDetailView.OnResphoneFameInfo()
    if this.hasWeekRankInfoRes == true then
        return
    end
    if this.isWaitingTrounamentData then
        this.isWaitingTrounamentData = false
    else
        return
    end

    this.hasWeekRankInfoRes = true;
    local tier = ModelList.HallofFameModel:GetTiers()
    local isUpTier = this.lastWeekTier < tier
    local oldScore = this.lastWeekScore
    if isUpTier or ModelList.HallofFameModel:CheckHasStateAward() then
        log.g("recive data OnResphoneFameInfo 2 HallofFameScoreView")
        ViewList.HallofFameScoreView:DisablebVictoryShopBtn()
        Facade.SendNotification(NotifyName.ShowUI, ViewList.HallofFameScoreView, function ()
            fun.set_active(this.sumary, false, false)
        end, false, {
            callBack = function ()
                this:Jump2SuperMatchSmash()
            end,
            isUpTier = isUpTier,
            oldScore = oldScore,
            lastWeekTier = this.lastWeekTier,
            isSettle = true,
            lastWeekRankInfo = this.lastWeekRankInfo
        })
    else
        log.g("recive data OnResphoneFameInfo Jump2FameRank")
        this:Jump2FameRank()
    end
end

function SettleDetailView:Jump2puzzle()
    Facade.SendNotification(NotifyName.ShowUI, ViewList.PuzzleView, function ()
        ModelList.PuzzleModel:SetViewType(1)
        fun.set_active(this.sumary, false, false)
    end, false, function ()
        this.model:Clear()
        Event.Brocast(Notes.QUIT_BATTLE)

        local gameType = ModelList.BattleModel:GetGameType()
        local loadingView = ViewList.SceneLoadingGameView
        if gameType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
            loadingView = ViewList.WinZoneLoadingGameView
        end
        LoadScene("SceneHome", loadingView, true)

        -- --UnityEngine.Resources.UnloadUnusedAssets()
    end)
end

function SettleDetailView.OpenShopView()
    Facade.SendNotification(NotifyName.ShopView.PopupShop, PopupViewType.show, nil, nil, nil)
end

function SettleDetailView:initSpeedUp()
    if ModelList.GuideModel.IsFirstBattle() then
        fun.set_active(self.btn_speedUp, false)
        return
    end

    local flag = ViewList.GameSettleView:GetSpeedUp()
    local on = fun.find_child(self.btn_speedUp, "on")
    local off = fun.find_child(self.btn_speedUp, "off")
    if flag == false then --加速状态
        fun.set_active(on, true)
        fun.set_active(off, false)
        ViewList.GameSettleView:SetSpeedUp(1.5)
    end
end

function SettleDetailView:on_btn_speedUp_click()
    local flag = ViewList.GameSettleView:SpeedUp(1.5)
    local on = fun.find_child(self.btn_speedUp, "on")
    local off = fun.find_child(self.btn_speedUp, "off")

    if flag then
        fun.set_active(on, false)
        fun.set_active(off, true)
    else
        fun.set_active(on, true)
        fun.set_active(off, false)
    end
end

function SettleDetailView:SetJokerSkin()
    if ModelList.BattleModel.GetIsJokerMachine() then
        if self.JokerBg then
            --self.JokerBg = AtlasManager:GetSpriteByName("JokerBattleAtlas","lBonusDi4PUSbjb")
            SetJokerSkin2(self.JokerBg, "JokerBattleAtlas", "lBonusDi4PUSbjb")
        end
        if self.img_coin_summary then
            SetJokerSkin2(self.img_coin_summary, "JokerBattleAtlas", "lBonusDi4PU")
        end
        if self.img_items_summary then
            SetJokerSkin2(self.img_items_summary, "JokerBattleAtlas", "JsDi4PU")
        end
        if self.img_bingo_summary then
            SetJokerSkin2(self.img_bingo_summary, "JokerBattleAtlas", "JsDi4PU")
        end
        if self.img_card_summary then
            SetJokerSkin2(self.img_card_summary, "JokerBattleAtlas", "JsDi4PU")
        end
    end
end

function SettleDetailView:ClearTimeList()
    for i, v in pairs(TimeOutList) do
        LuaTimer:Remove(v)
    end
    TimeOutList = {}
end

------------------region 锤力器版本--------------
--最终结算→周榜、名人堂→锤力器→拼图→火山、赛车
--- 增加跳转到锤力器界面
function SettleDetailView:Jump2SuperMatchSmash()
    if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_NORMAL then
        if ModelList.SmallGameModel:IsSettleSmallGame() then
            local view = ModelList.GameModel:ShowSGMainView()
            Facade.SendNotification(NotifyName.ShowUI, view, function ()
                fun.set_active(this.sumary, false, false)
            end, false, function ()
                this:Jump2puzzle()
            end)
        else
            this:Jump2puzzle()
        end
    elseif ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_THREE_PIGS and
        ModelList.GotYouModel:GetSmallGameData2() ~= nil then
        if not ViewList.GotYouSmallGameView then
            ViewList.GotYouSmallGameView = require("View.Bingo.SettleModule.UIView.SmallGame.GotYou.GotYouSmallGameView")
        end
        Facade.SendNotification(NotifyName.ShowUI, ViewList.GotYouSmallGameView, function ()
            --fun.set_active(this.sumary, false, false)
        end, false, function ()
            this:Jump2puzzle()
        end)

    else
        this:Jump2puzzle()
    end
end

--- 是否是锤力器道具
function SettleDetailView:IsSmashItem(itemId)
    if itemId == 37032 or itemId == 37033 or itemId == 37034 then
        return true
    end
    return false
end

--- 结算数据检查有没有锤力器道具
function SettleDetailView:CheckSmash()
    if this.settleData then
        this.smashId = nil
        for j = 1, #this.settleData.reward do
            if this.settleData.reward[j].id == 37032 or this.settleData.reward[j].id == 37033 or this.settleData.reward[j].id == 37034 then
                this.smashId = this.settleData.reward[j].id
                break
            end
        end
        if this.smashId then
            local index = tostring(this.smashId):sub(-1)
            this.smashIcon.sprite = AtlasManager:GetSpriteByName("GameItemAtlas", "ClqJs0" .. index)
            fun.set_active(this.superMatchSmash, true)
        end
    end
end

---
function SettleDetailView:CheckSoltSpin()
    ---[[
    fun.set_active(self.ticketPanel, false)
    fun.set_active(self.ticketItem, false)
    if not ModelList.PiggySloltsGameModel.CheckPiggySlotsGameExist() then
        return
    end

    local ticketNum = ModelList.PiggySloltsGameModel.GetBreakNum()
    if not ticketNum or ticketNum < 1 then
        return
    end

    if not self.cardsItems then
        return
    end

    local cardNumHasBingo = 0
    for i, v in ipairs(self.cardsItems) do
        if v.isBingo then
            cardNumHasBingo = cardNumHasBingo + 1
            --v.go
            local obj = fun.get_instance(self.ticketItem)
            if obj then
                local parent = self.effContainer.transform
                obj.transform:SetParent(parent)
                obj.transform.localScale = Vector3.one
                --obj.transform.localPosition = Vector3.New(0, 0, 0)
                local tmpLuaTimer = LuaTimer:SetDelayFunction(3 + 0.5, function ()
                    if fun.is_not_null(obj) then
                        fun.set_same_position_with(obj, v.go)
                        fun.set_active(obj, true)
                        local targetPos = self.ticketPanel.transform.position
                        Anim.move(obj, targetPos.x, targetPos.y, 0, 1, false, false, function()
                            if fun.is_not_null(obj) then
                                Destroy(obj)
                            end
                        end)
                    end

                    fun.set_active(self.ticketPanel, true)
                end, nil, LuaTimer.TimerType.UI)
                table.insert(TimeOutList, tmpLuaTimer)
            end
        end
    end
    self.cardsItems = nil
    self.ticketNum.text = "x" .. tostring(ticketNum or 0)
    --]]
end
------------------endregion ------------------


this.NotifyList = {
    { notifyName = NotifyName.ShopView.OpenShopView,           func = this.OpenShopView },
    { notifyName = NotifyName.Tournament.ResphoneRankInfo,     func = this.OnResphoneTournamentInfo },
    { notifyName = NotifyName.HallofFame.FameResphoneRankInfo, func = this.OnResphoneFameInfo }
}

return this
