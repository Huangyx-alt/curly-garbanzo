---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/13 14:19
---

local CellData = {}
local this = CellData
CellData.__index = CellData

function CellData:New(number, orderIndex, cardId)
    local temp = {
        num = number,            --格子数字
        sign = 0,                --盖章状态 0 默认  1 普通盖章  2 Bingo盖章  3 Jackpot盖章
        index = orderIndex,      -- 格子索引  （1-25）
        cardId = cardId,
        is_mirror = false,       -- 是否在放大镜效果
        double_num = 0,          -- 双数字
        gift = {},               -- 格子道具
        resourceHammerGift = {}, -- 资源锤移过来的道具
        skill_id = {},           -- 格子技能
        self_bingo = false,      -- 是否单bingo
        mark = 0,                -- 盖章类型  1 普通盖章   powerup卡盖章就是powerupId
        powerId = {},            -- 格子上的PowerId
        wishState = 0,           -- wish 状态
        basket = {},             -- 美食篮子信息
        usedBasket = {},         -- 开启过的美食篮子id
        obj = nil,
        hide_gift = {},          -- 隐藏在格子内的道具
        --hide_gift = { {id = 31001,value = 1},{id = 31002,value=1},{id = 31003,value = 1},{id = 31004,value=1},
        --              {id = 31001,value = 1},{id = 31002,value=1},{id = 31003,value = 1},{id = 31004,value=1},}, -- 隐藏在格子内的道具
        flashId = 0,           -- 是否有闪电
        competitionItemID = 0, -- 是否有杯赛道具
        puExtraPos = nil,
        ext = nil,             --数据格式不固定，各个玩法自己管理
        goldCoinType = 0,
        calledTime = 0,     --被叫到号时的时间戳
        signTime = 0,       --手动盖章时间戳
        isUsedForSelfBingoData = false,
    }
    setmetatable(temp, { __index = CellData })
    return temp
end

--从叫号到手动盖章用时(毫秒)
function CellData:GetDaubTime()
    local diff = self.signTime - self.calledTime
    if diff <= 0 or self.calledTime == 0 then
        return 0
    end
    diff = diff / 1000
    return diff
end

--格子是否包含技能、道具等
function CellData:IsEmpty()
    return #self.hide_gift == 0 and #self.skill_id == 0 and not self.self_bingo
end

function CellData:GetExtInfo()
    return self.ext
end

function CellData:SetExtInfo(extInfo)
    self.ext = extInfo
end

--设置放大镜显示状态
function CellData:BindObj(obj)
    self.obj = obj
    self.referScript = fun.get_component(obj, fun.REFER)
end

--设置关联的格子
function CellData:GetCellObj()
    return self.obj
end

--设置关联的格子
function CellData:GetCellReferScript(params)
    if params then
        return self.referScript:Get(params)
    else
        return self.referScript
    end
end

--设置放大镜显示状态
function CellData:SetMirror2()
    self.is_mirror = true
end

function CellData:IsMirror2()
    return self.is_mirror
end

function CellData:AddBaseket(basketInfo, itemId)
    table.insert(self.basket, basketInfo)
    for i = 1, #self.gift do
        if self.gift[i] == itemId then
            table.remove(self.gift, i)
            table.insert(self.usedBasket, itemId)
            break
        end
    end
end

---获取格子美食篮子奖励信息
function CellData:GetCellBasketReward(itemId)
    for i = 1, #self.basket do
        if self.basket[i].itemId == itemId then
            return self.basket[i].reward
        end
    end
end

---获取格子美食篮子奖励信息
function CellData:SetDouble(double_num)
    self.double_num = double_num
end

---获取格子美食篮子奖励信息
function CellData:SetMark(mark)
    self.mark = mark
    if mark == 1 then
        self.signTime = Util.NowMillisecond()
    end
end

---获取格子美食篮子奖励信息
---isResourceHammer bool 是否是资源锤移动来的道具
function CellData:AddGift(new_gift, isResourceHammer)
    local giftData = Csv.GetData("new_item", new_gift, "result")
    if giftData then
        if giftData[1] == 3 and giftData[2] == 12 then
            self.flashId = new_gift
        end
        if giftData[1] == 3 and giftData[2] == 28 then
            self.competitionItemID = new_gift
        end
    end
    table.insert(self.gift, new_gift)

    if isResourceHammer then
        table.insert(self.resourceHammerGift, new_gift)
    end
end

--删除道具
function CellData:RemoveGift(itemID)
    local item, index = table.find(self.gift, function(k, v)
        return v == itemID
    end)
    if item then
        table.remove(self.gift, index)
        return true
    end
end

function CellData:GetGift()
    return self.gift
end

function CellData:GetGiftCount()
    return #self.gift
end

---
function CellData:AddHideGift(hideGift, count)
    table.insert(self.hide_gift, hideGift)
    if count and count > 1 then
        for i = 1, count - 1 do
            table.insert(self.hide_gift, hideGift)
        end
    end
end

---获取格子美食篮子奖励信息
function CellData:AddSkill(skill_id)
    table.insert(self.skill_id, skill_id)
end

---获取格子美食篮子奖励信息
function CellData:ResetSkill()
    self.skill_id = {}
end

---获取格子美食篮子奖励信息
function CellData:ResetJoker()
    if self and self.jokerData then
        for i = #self.jokerData, 1, -1 do
            if self.jokerData[i].state == 3 and self.jokerData[i].state == 5 then
                table.remove(self.jokerData, i)
            end
        end
    end
end

function CellData:HaveSkill(skill_id)
    if self.skill_id then
        for i = 1, #self.skill_id do
            if self.skill_id[i] == skill_id then
                return true
            end
        end
    end
    return false
end

---
function CellData:SelfBingo()
    self.self_bingo = true
end

---
function CellData:AddPowerupId(powerId, extraPos)
    table.insert(self.powerId, powerId)
    if extraPos then
        self.puExtraPos = deep_copy(extraPos)
    end
end

function CellData:GetPowerupId(index)
    index = index or 1
    local ret = self.powerId and self.powerId[index]
    return ret
end

function CellData:SetPuExtraPos(extraPos)
    self.puExtraPos = extraPos
end

function CellData:GetPuExtraPos()
    return self.puExtraPos
end

---获取格子美食篮子奖励信息
function CellData:ChangeWishState(state)
    if not state then state = 1 end
    self.wishState = state
end

---获取格子美食篮子奖励信息
function CellData:IsSignedByNum(num)
    if num == self.num or self.double_num == num then
        return self.sign == 0
    end
    return false
end

---@param signType  0-默认 1-普通盖章 2-bingo盖章 3-jackpot盖章
---  设置格子盖章状态
function CellData:SetSignType(signType)
    self.sign = signType
    self.isLogicSign = false
end

---@param signType  0-默认 1-普通盖章 2-bingo盖章 3-jackpot盖章
---  设置格子盖章状态
function CellData:SetLogicSign(signType)
    self:SetSignType(signType)
    self.isLogicSign = true
end

---  格子盖章状态
function CellData:GetSignType()
    return self.sign
end

---  格子盖章状态
function CellData:IsNotSign()
    return self.sign == 0
end

---  格子盖章状态
function CellData:GetNumber()
    return self.num
end

---  格子逻辑上盖章，实际还未做表现
function CellData:IsLogicSign()
    return self.isLogicSign
end

---  格子闪电状态
function CellData:IsFlash()
    return self.flashId > 0
end

---  格子闪电状态
function CellData:GetFlashItem()
    return self.flashId
end

---  格子杯赛道具
function CellData:GetCompetitionItemID()
    return self.competitionItemID
end

local function IsItem(itemId)
    if itemId < 1000 then
        return false
    else
        return true
    end
end

local function IsDrinkItem(itemId)
    return Csv.GetData("item", itemId, "put_type") == 3
end

function CellData:GetDrinks()
    local returnDrinks = {}
    for i = 1, #self.hide_gift do
        if IsItem(self.hide_gift[i].id) and IsDrinkItem(self.hide_gift[i].id) then
            table.insert(returnDrinks, self.hide_gift[i])
        end
    end
    return returnDrinks
end

function CellData:Treasure2Item()
    if self.hide_gift and self.hide_gift[1] then
        if 4 == math.floor(self.hide_gift[1].id / 10000000) then
            local data = Csv.GetData("new_item_synthetic", self.hide_gift[1].id)
            if data then
                return {
                    id = data.itemid
                    ,
                    groupid = data.groupid
                    ,
                    value = self.hide_gift[1].value
                    ,
                    part = data.part[1]
                    ,
                    isPivot = (1 == data.part[2] and { true } or { false })[1]
                    ,
                    synthetic = self.hide_gift[1].id
                }
            end
        else
            return {
                id = self.hide_gift[1].id
                ,
                groupid = -1
                ,
                value = self.hide_gift[1].value
                ,
                part = -1
                ,
                isPivot = false
                ,
                synthetic = -1
            }
        end
    end
end

function CellData:HasItem(itemIds)
    if self.sign > 0 then return false end
    for m = 1, #itemIds do
        if fun.is_include(itemIds[m], self.gift) then
            return true
        end
    end
    return false
end

function CellData:HasHiddenItem(itemId)
    if self.sign == 0 then return false end
    for m = 1, #self.hide_gift do
        if self.hide_gift[m].id == itemId then
            return true
        end
    end
    return false
end

--格子上是否有任意道具,不包括赛季战令经验
function CellData:HaveItemExcludeFlash()
    local giftCount, isFlash = self:GetGiftCount(), self:IsFlash()
    local checkGift = giftCount == 0 or (giftCount == 1 and isFlash)
    return checkGift
end

--格子是被小丑卡使用,不包括JokerBonus区域使用的格子
function CellData:IsUsedBuJokerExcludeBonus()
    local jokerCount = fun.table_len(self:GetJokerChange())
    local haveJoker, isJokerArea = jokerCount > 0, self:IsJokerArea()
    local checkJoker = not haveJoker or isJokerArea
    return checkJoker
end

--格子是被能被用于投放道具
function CellData:CheckCanThrowItem()
    local isSigned = self.sign ~= 0
    if isSigned then return false end
    local checkGift = self:HaveItemExcludeFlash()
    if not checkGift then return false end
    local checkJoker = self:IsUsedBuJokerExcludeBonus()
    if not checkJoker then return false end
    local checkSkill = GetTableLength(self.skill_id) > 0
    if checkSkill then return false end
    local checkPu = GetTableLength(self.powerId) > 0
    return not checkPu
end

---设置卡牌格子小丑的数据变化
---@param changeType number @变化类型   1.变资源 2.变小丑区域 3.变吹吹卷 4.变双倍金币
function CellData:SetJokerChange(changeType, ...)
    if not self.jokerChange then self.jokerChange = {} end
    local jokerData = nil
    if changeType == 2 then
        self.jokerArea = true
    end
    if changeType == 3 then
        local firstPos, direction, params = select(1, ...)
        jokerData = { state = changeType, params = params, firstPos = firstPos, cellIndex = self.index, cardId = self
        .cardId, direction = direction }
    else
        jokerData = { state = changeType, params = select(1, ...), cellIndex = self.index, cardId = self.cardId }
    end

    table.insert(self.jokerChange, jokerData)
end

---@param changeType number @变化类型   1.变资源 2.变小丑区域 3.变吹吹卷 4.变双倍金币
function CellData:GetJokerChange()
    return self.jokerChange
end

function CellData:ClearJokerChange()
    if self then
        self.jokerChange = {}
    end
end

function CellData:IsJokerArea()
    return self.jokerArea and true or false
end

--- 缓存播放过格子盖章效果
function CellData:SaveSignEffect()
    self.signEffect = true
end

--- 检查格子是否播放过盖章效果
function CellData:IsPlayedSignEffect()
    return self.signEffect or false
end

--0:普通;  1:2X;  2:mini
function CellData:SetGoldCoinType(coinType)
    self.goldCoinType = coinType
end

function CellData:GetGoldCoinType()
    return self.goldCoinType or 0
end

---进入小游戏,清除多余数据
function CellData:ReadySGame()
    self.jokerChange = {}
    ---清除pu数据
    self.gift = {}
    ---清除技能数据
    self.skill_id = {}
    self:ClearSpecialWish()
    self.self_bingo = false
    if fun.is_not_null(self.obj) then
        local ref_temp = fun.get_component(self.obj, fun.REFER)
        local gift_par = ref_temp:Get("gift_parent")
        if gift_par then
            Destroy(gift_par.transform.parent)
        end
    end
end

function CellData:ClearSpecialWish()
    if self.wishState ~= 0 then
        local hasNormalWish = CalculateBingoMachine:CheckNormalLineWish(self.cardId, self.index)
        log.log("CellData:ClearSpecialWish ", hasNormalWish, self.wishState, self.cardId, self.index, self.num)
        if not hasNormalWish then
            Event.Brocast(EventName.CardBingoEffect_CancelShowWish, self.cardId, self.index)
            self.wishState = 0
        end
    end
end

return this