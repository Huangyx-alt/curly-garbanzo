---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/8/23 19:25
---
local Toolkit = require "View/SeasonCard/Toolkit"
require "State/PlayCardNumberView/BasePlayCardNumberState"
require "State/PlayCardNumberView/PlayCardNumberAvailableState"
require "State/PlayCardNumberView/PlayCardNumberDisableState"
require "State/PlayCardNumberView/PlayCardNumberOriginalState"

require "View/HallCity/DiscountUtility"
require "View/DiscountAllView/CoinDiscountView"

PlayCardsNumberView = BaseView:New("PlayCardsNumberView")
local this = PlayCardsNumberView
this.viewType = CanvasSortingOrderManager.LayerType.None

this.auto_bind_ui_items = {
    "btn_card",
    "btn_play",
    "text_cost",
    "text_cardNum",
    "Img_cost",
    "anim",
    "card1_gift_fram",
    "card1_gift_tail",
    "card2_gift_fram",
    "card2_gift_tail",
    "card3_gift_fram",
    "card3_gift_tail",
    "card4_gift_fram",
    "card4_gift_tail",
    "coupon",
    "btn_AutoSign", -- 自动盖章得
    "ultra_icon",
    "cardBox",
    "img_supermatch",
    "img_extra_reward",
}

function PlayCardsNumberView:New(genre)
    local o = {}
    self.__index = self
    setmetatable(o,self)
    o._genre = genre or 1
    return o
end

function PlayCardsNumberView:BuildFsm()
    self:DisposeFsm()
    self._fsm = Fsm.CreateFsm("PlayCardsNumberView",self,{
        PlayCardNumberAvailableState:New(),
        PlayCardNumberDisableState:New(),
        PlayCardNumberOriginalState:New()
    })
    self._fsm:StartFsm("PlayCardNumberOriginalState")
end

function PlayCardsNumberView:DisposeFsm()
    if self._fsm then
        self._fsm:Dispose()
        self._fsm = nil
    end
end

function PlayCardsNumberView:Awake()
    self:on_init()
    self:SetResourceIcon()
    self._DiscountUtility = DiscountUtility:New()
end

function PlayCardsNumberView:SetResourceIcon()
    local res_id = nil
    local icon = nil
    res_id = Csv.GetData("admission_pay",PLAY_TYPE.PLAY_TYPE_NORMAL,"resources_id")
    if res_id then
        icon = Csv.GetData("resources",res_id,"icon")
    end
    if icon then
        self.Img_cost.sprite = AtlasManager:GetSpriteByName("ItemAtlas",icon)
    end
    self._res_id = res_id
end

function PlayCardsNumberView:OnEnable()
    Facade.RegisterViewEnhance(self)
    
    if self.text_cardNum then
        self.text_cardNum.text = self._genre ==1 and string.format("%s card",self._genre) or string.format("%s cards",self._genre)
        --fun.set_active(self.text_cardNum.transform.parent, false)
    end
    
    self:AddEventListener()
    self._init = true
    self:SetInfo(self._betRate)
    self:OnCouponChange()
    self:BuildFsm()
end

function PlayCardsNumberView:OnDisable()
    Facade.RemoveViewEnhance(self)
    self:DisposeFsm()
    self._DiscountUtility:OnDisable()
    self:RemoveEventListener()
    self._isFall = nil
    self._init = nil
    self._betRate = nil
    self:ClearSmallGameCountDown()
    self.isExtraRewardTipInit = nil
end    

function PlayCardsNumberView:OnApplicationPause(focus)
    if not focus and self then
        self:OnCouponChange()
    end
end

function PlayCardsNumberView:AddEventListener()
    Event.AddListener(EventName.Event_coupon_change,self.OnCouponChange,self)
    Event.AddListener(EventName.Event_UpdateItems,self.OnCouponChange,self)
    Event.AddListener(EventName.Event_WinZone_Item_Buff, self.OnResourceChange, self)
end

function PlayCardsNumberView:RemoveEventListener()
    Event.RemoveListener(EventName.Event_coupon_change,self.OnCouponChange,self)
    Event.RemoveListener(EventName.Event_UpdateItems,self.OnCouponChange,self)
    Event.AddListener(EventName.Event_WinZone_Item_Buff, self.OnResourceChange, self)
end

function PlayCardsNumberView:OnCouponChange()
    if  self.discount_view ~= nil then 
        self.discount_view:CloseView()
        self.discount_view = nil
    end 

    local data = ModelList.ItemModel:GetItemByType(ItemType.coin_DisCount)
    local have_DisCount = false 
    local tmpData = nil 
    local time = 999999999
    if fun.table_len(data) >0 then
        for _ ,v in ipairs(data) do 
            local tmpTime = v.value - os.time()
            if ((tmpTime) >0) and (tmpTime <time )then 
                time = tmpTime
                tmpData = v
                have_DisCount = true 
            end 
        end
    end 

    if have_DisCount ==false and  self._DiscountUtility:IsHaveCoupon() then
        self:CheckCoupon()
    end

    if have_DisCount == true then 
        Cache.load_prefabs(AssetList["CoinDiscountView"],"CoinDiscountView",function(obj)
            if obj then
                local go = fun.get_instance(obj,self.coupon)
                if go then
                    fun.set_gameobject_pos(go,28,-39,0,true)
                    local view = require "View/DiscountAllView/CoinDiscountView"
                    self.discount_view = view:New()
                    self.discount_view:SkipLoadShow(go)
                    if tmpData ~= nil then 
                        local result = Csv.GetData("item",tmpData.id, "result")
                        local disCount =  result[2] or 0
                        self.discount_view:UpdateData(disCount,math.max(0, tmpData.value - os.time()))
                    end 
                end
            end
        end)
    end 

    self:SetCostShowText()
end

function PlayCardsNumberView:CheckCoupon(isFall)
    if isFall then
        self._isFall = isFall
    end
    if self._isFall then
        if self._genre == CardGenre.fourcard then
            self:SetCoupon(CouponType.discount_4card)
        elseif self._genre == CardGenre.twocard then
            self:SetCoupon(CouponType.discount_2card)  
        elseif self._genre == CardGenre.onecard then
            self:SetCoupon(CouponType.discount_1card)  
        end 
    end
end

function PlayCardsNumberView:SetCoupon(discount)
    self._DiscountUtility:SetCoupon(discount,self.coupon,true)
    self:SetCostShowText()
end

function PlayCardsNumberView:GetDiscountId()
    return self._DiscountUtility:GetDiscountId()
end

function PlayCardsNumberView:GetDiscountUseId()
    return self._DiscountUtility:GetDiscountUseId()
end

function PlayCardsNumberView:SetInfo(betRate)
    self._betRate = betRate
    if self._init and betRate then
        local cityId = ModelList.CityModel:GetCity()
        local cardData = Csv.GetData("city",cityId,"reward_number2")
        local giftType = 0
        for index, value in ipairs(cardData) do
            if value and value[1] == betRate and value[2] == self._genre then
                giftType = value[3]
            end
        end
        local cardFrameList = {{self.card1_gift_fram,self.card1_gift_tail},{self.card2_gift_fram,self.card2_gift_tail},
        {self.card3_gift_fram,self.card3_gift_tail},{self.card4_gift_fram,self.card4_gift_tail}}
        for i = 1, 4 do
            fun.set_active(cardFrameList[i][1],i <= giftType)
            fun.set_active(cardFrameList[i][2],i <= giftType)
        end
        --self.img_cards.sprite = AtlasManager:GetSpriteByName("HallMainAtlas",string.format("card_gift_%s_%s",self._genre,giftType))

        --fun.set_gameobject_scale(self.img_cards.gameObject,0.8,0.8,1)
        --Anim.scale_to_xy_ease(self.img_cards.gameObject,1,1,0.3,DG.Tweening.Ease.InOutBack)

        self:SetCostShowText()
        self.anim:Play("Playcard_cards",0,0)
    end

    if self.btn_AutoSign then
        ---- 开关自动 盖章
        if self._genre == CardGenre.fourcard  then
            fun.set_active(self.btn_AutoSign.gameObject.transform.parent.parent, true)
            fun.set_active(self.btn_AutoSign.gameObject.transform.parent, true)
        end 
    
        --1126版本暂时关闭
        if self.btn_AutoSign.gameObject.transform.parent.gameObject.activeSelf == true then 
            self:InitBtn_AutoSign()
        end
    else
        self:InitBtn_AutoSign2()
    end

    fun.set_active(self.ultra_icon, ModelList.UltraBetModel:IsActivityValid())

    self:ShowActivityItem()
    self:UpdateSmallGameState()
    self:UpdateExtraRewardState()
end

function PlayCardsNumberView:SetCostShowText()
    local cost = ModelList.CityModel:CheckPlayCardRealCost(self._genre,self:GetDiscountId())
    if cost then
        self._play_cost =  cost
        self.text_cost:RollByTime(cost,0.5,function()
            UISound.stop("coin_fly")
        end)
        local cost1 = 0

        if self.btn_AutoSign and self.btn_AutoSign.gameObject.transform.parent.gameObject.activeSelf == true then 
            cost1 = ModelList.CityModel:CheckPlayCardRealCost(1,self:GetDiscountId())
        end 
      
        --检测是否需要显示卡包
        if self.cardBox ~= nil then 
            self:SetCardBoxShow(cost1 == 0 and cost/self._genre or cost1)
        end 
    end
end

function PlayCardsNumberView:SetCardBoxShow(cost)
    if not cost then
        fun.set_active(self.cardBox, false)
        return 
    end 
    local cityId = ModelList.CityModel.GetPlayIdByCity()
    local data = Csv.GetData("city_play_seasoncard",cityId)
    local index = -1
    if not data then 
        fun.set_active(self.cardBox, false)
        return 
    end 

    for k,v in pairs(data.interval) do 
        if v[2] and v[3] and cost >= v[2] and  cost <= v[3] then 
            index = k
            break;
        end 
    end 

    if index <= 0 then 
        fun.set_active(self.cardBox, false)
        return 
    end 
    local refItem = fun.get_component(self.cardBox,fun.REFER)
    local cardbox = data.card_box_description[index]
    local cardCountData = data.card_box_sum
    --local iconName =  Csv.GetData("season_card_box",cardbox[2],"icon")
    local cardCfg = ModelList.SeasonCardModel:GetCardPackageInfo(cardbox[2])
    local iconName =  cardCfg and cardCfg.icon
    local cardNum = nil 
    local UltraLevel =  ModelList.UltraBetModel:GetActivityLevel()
    local cardIcon = refItem:Get("cardIcon")
    local cardIcon2 = refItem:Get("cardIcon2")
    local cardAnim = refItem:Get("card_bet")
    local text = refItem:Get("Text")

  
    for _,v in pairs(cardCountData) do 
        if v[1] and tonumber(v[1]) == UltraLevel then 
            for _,vv in pairs(v) do 
                local str1 = string.split(vv,"-") 
                if #str1 == 2 and tonumber(str1[1]) == self._genre then 
                    cardNum = tonumber(str1[2])
                    break;
                end 
            end 
            break;
        end 
    end 
    
 
    fun.set_active(self.cardBox, true)
    fun.set_active(cardIcon2,cardNum >1)
    
    AnimatorPlayHelper.Play(cardAnim,{"pick","card_bet_idle"},false,function() end)
    cardIcon.sprite = AtlasManager:GetSpriteByName("ItemAtlas", iconName)
    cardIcon2.sprite = AtlasManager:GetSpriteByName("ItemAtlas", iconName)
    text.text = "x".. tostring(cardNum)
    
end 

function PlayCardsNumberView:on_close()

end

function PlayCardsNumberView:OnDestroy()
    self:Close()
end

function PlayCardsNumberView:on_btn_card_click()
    if not ModelList.WinZoneModel:CheckReadyEndTime() then
        return
    end
    self._fsm:GetCurState():PlayCardsClick(self._fsm)
end

function PlayCardsNumberView:OnPlayCardsClick()
    Facade.SendNotification(NotifyName.HallMainView.PlayCardsClick,self._genre)
end

function PlayCardsNumberView:DoCardClick(ignoreCheckRes, cb)
    local cost = self._play_cost
    if not ignoreCheckRes then
        Facade.SendNotification(NotifyName.ShopView.CheckCurrencyAvailable,8008,self._res_id,self._play_cost,function()
            ModelList.CityModel:SetCardNumber(self._genre)
            ModelList.BattleModel:SaveLastBuyCardCost(cost)
            Facade.SendNotification(NotifyName.HallCity.ShowPowerUpView, self, cb)
        end,nil,nil,SHOP_TYPE.SHOP_TYPE_CHIPS,GetCurHallView())
    else
        ModelList.CityModel:SetCardNumber(self._genre)
        ModelList.BattleModel:SaveLastBuyCardCost(cost)
        Facade.SendNotification(NotifyName.HallCity.ShowPowerUpView, self, cb)
    end
end

function PlayCardsNumberView:on_btn_play_click()
    self:on_btn_card_click()
end

function PlayCardsNumberView:on_btn_guide_click()
    self.on_btn_card_click = this.ori_on_btn_card_click
    ModelList.GameModel:ReqEnterGame()
end


this.ori_on_btn_card_click = nil
function PlayCardsNumberView:ReplaceBtnPlayEvent(isReplace)
    if isReplace then
        local img = fun.get_component(self.btn_play,fun.IMAGE)
        img.raycastTarget = false
        this.ori_on_btn_card_click = self.on_btn_card_click
        self.on_btn_card_click = self.on_btn_guide_click
    end
end

function PlayCardsNumberView:RealReplaceBtnPlayEvent()
    LuaTimer:SetDelayFunction(0.1,function()
        self.on_btn_card_click = this.ori_on_btn_card_click
        ModelList.GameModel:ReqEnterGame()
    end)
end


function PlayCardsNumberView:Set2CardRayCast()
    local img = fun.get_component(self.btn_play,fun.IMAGE)
    if img then
        img.raycastTarget = false
    end
end

function PlayCardsNumberView:GetPosition()
    if self.go then
        return self.go.transform.position
    end
    return Vector3.New(0,0,0)
end

function PlayCardsNumberView:SetImageColorGray(gray)
    --[[
    if self.go then
        --Util.SetImageColorGray(self.go, gray) 不需要了，用动画控制了
    end
    --]]
end


function PlayCardsNumberView:InitBtn_AutoSign()
    local sp = fun.get_component(self.btn_AutoSign,fun.IMAGE)
    if ModelList.BattleModel.GetIsAutoSign()  then 
        sp.sprite = AtlasManager:GetSpriteByName("HallMainAtlas","CardAutoNo")
        ModelList.CityModel:SetAutoSignCost(self._genre,true)
    else 
        sp.sprite = AtlasManager:GetSpriteByName("HallMainAtlas","CardAutoOff")
        ModelList.CityModel:SetAutoSignCost(self._genre,false)
    
    end 
    self:SetCostShowText()
end

function PlayCardsNumberView:InitBtn_AutoSign2()
    if ModelList.BattleModel.GetIsAutoSign()  then
        ModelList.CityModel:SetAutoSignCost(self._genre,true)
    else
        ModelList.CityModel:SetAutoSignCost(self._genre,false)
    end
end

function PlayCardsNumberView:on_btn_AutoSign_click()
    local sp = fun.get_component(self.btn_AutoSign,fun.IMAGE)

    if ModelList.BattleModel.GetIsAutoSign()  then 
        sp.sprite = AtlasManager:GetSpriteByName("HallMainAtlas","CardAutoOff")
        ModelList.BattleModel.SetIsAutoSign(false)
        ModelList.CityModel:SetAutoSignCost(self._genre,false)
    else 
        sp.sprite = AtlasManager:GetSpriteByName("HallMainAtlas","CardAutoNo")
        ModelList.BattleModel.SetIsAutoSign(true)
        ModelList.CityModel:SetAutoSignCost(self._genre,true)
    end 
    self:SetCostShowText()
end

function PlayCardsNumberView:SetPlayCardsNumberAvailable(callback)
    self._fsm:GetCurState():SetAvailable(self._fsm,callback)
end

function PlayCardsNumberView:SetPlayCardsNumberDisable(callback)
    self._fsm:GetCurState():SetDisable(self._fsm,callback)
end

---展示活动道具
function PlayCardsNumberView:ShowActivityItem()
    local isActivityAvailable = ModelList.HallofFameModel:IsActivityAvailable()
    local checkLvOpen = ModelList.HallofFameModel:CheckLvOpen()
    if isActivityAvailable and checkLvOpen then
        if fun.is_not_null(self.hallofFameItem) then
            fun.set_active(self.hallofFameItem, true)
            self:UpdateActivityItem()
        else
            Cache.load_prefabs(AssetList["HallofFameHallCollectItem"], "HallofFameHallCollectItem",function(obj)
                local instance = fun.get_instance(obj, self.go.transform)
                self.hallofFameItem = instance
                fun.set_rect_anchored_position(instance, -125, 205)
                self:UpdateActivityItem()
            end)
        end
    else
        if fun.is_not_null(self.hallofFameItem) then
            fun.set_active(self.hallofFameItem, false)
        end
    end
    
    self:UpdateOtherPos()
end

function PlayCardsNumberView:UpdateActivityItem()
    local singleCardCost = self:GetSingleCardCost()
    local cfg = table.find(Csv["victorybeats_putin"], function(k, v)
        local range = v.coin_range
        if #range > 1 then
            return range[1] <= singleCardCost and singleCardCost <= range[2]
        end
    end)
    if not cfg then
        log.r("单卡价值没有对应的音符配置！！！！！！！")
        fun.set_active(self.hallofFameItem, false)
        return
    end
    
    local refer = fun.get_component(self.hallofFameItem, fun.REFER)
    local icon, count = refer:Get("Icon"), refer:Get("count")

    local spriteName = Csv.GetItemOrResource(cfg.prop_type, "icon")
    Cache.GetSpriteByName("ItemAtlas", spriteName, function(sprite)
        if not fun.is_null(sprite) then
            icon.sprite = sprite
        end
    end)

    local remainTime = ModelList.WinZoneModel:GetDoubleBuffRemainTime()
    local rate = remainTime > 0 and 2 or 1
    local color = remainTime > 0 and "#ECFF23" or "#ffffff"
    local number = cfg.number * self._genre * rate
    count.text = string.format("<color=%s>%s</color>", color, number)
end

function PlayCardsNumberView:GetSingleCardCost()
    local singleCardCost = ModelList.CityModel:GetCostCoin(1)
    return singleCardCost
end

function PlayCardsNumberView:UpdateOtherPos()
    local isCouponVisible = fun.get_child_count(self.coupon) > 0
    
    if fun.is_not_null(self.hallofFameItem) then
        if fun.get_active_self(self.hallofFameItem) then
            if isCouponVisible then
                fun.set_rect_local_pos_x(self.coupon, -30)
                if self.text_cardNum then
                    fun.set_rect_local_pos_y(self.text_cardNum.transform.parent, 160)
                end
            end
        else
            if self.text_cardNum then
                fun.set_rect_local_pos_y(self.text_cardNum.transform.parent, 128)
            end
            fun.set_rect_local_pos_x(self.coupon, -136)
        end
    else
        if self.text_cardNum then
            fun.set_rect_local_pos_y(self.text_cardNum.transform.parent, 128)
        end
        fun.set_rect_local_pos_x(self.coupon, -136)
    end
end

function PlayCardsNumberView:RefreshUltraBetUI()
    self:SetInfo(self._betRate)
end

function PlayCardsNumberView:OnUltraBetStart()
    self:RefreshUltraBetUI()
end

function PlayCardsNumberView:OnUltraBetEnd()
    self:RefreshUltraBetUI()
end

function PlayCardsNumberView:OnRewardReceiveFinish()
    self:OnCouponChange()
    self:CheckCoupon()
    self:RefreshUltraBetUI()
end

function PlayCardsNumberView:OnResourceChange()
    self:ShowActivityItem()
end

function PlayCardsNumberView:StartSmallGameCountDown()
    self.smallGameRemainTime = ModelList.SmallGameModel:GetActivityRemainTime()
    if self.smallGameRemainTime > 0 then
        self:ClearSmallGameCountDown()
        self.smallGameRemainTimeCountDown = LuaTimer:SetDelayLoopFunction(0, 1, -1, function()
            self.smallGameRemainTime = self.smallGameRemainTime - 1
            if self.smallGameRemainTime <= 0 then
                self:OnSuperMatchTimeOver()
            end
        end, nil, nil, LuaTimer.TimerType.UI)
    end
end

function PlayCardsNumberView:OnSuperMatchTimeOver()
    self:ClearSmallGameCountDown()
    self:UpdateSmallGameState()
end

function PlayCardsNumberView:UpdateSmallGameState()
    if ModelList.SmallGameModel:CanOpenGameForBet() then
        self:UpdateSmallGameIcon()
        fun.set_active(self.img_supermatch, true)
    else
        fun.set_active(self.img_supermatch, false)
    end
end

---根据当前小游戏类型更新icon
function PlayCardsNumberView:UpdateSmallGameIcon()
    local iconInfo = ModelList.SmallGameModel.GetCurrentGameIconInfo()
    if self.img_supermatch and self.img_supermatch.sprite then
        if not fun.starts(self.img_supermatch.sprite.name ,iconInfo) then
            Cache.load_texture_to_sprite(iconInfo, self.img_supermatch)
        end
    end
end


function PlayCardsNumberView:UpdateExtraRewardState()
    local playId = ModelList.CityModel.GetPlayIdByCity()
    local curModel = ModelList.BattleModel.GetModelByPlayID(playId)
    if curModel.IsTriggerExtraReward then
        if curModel:IsTriggerExtraReward() then
            fun.set_active(self.img_extra_reward, true)
        else
            fun.set_active(self.img_extra_reward, false)
        end
        if not self.isExtraRewardTipInit and self.img_extra_reward then
            self.img_extra_reward.sprite = curModel:GetExtraRewardTipIconSprite()
            self.isExtraRewardTipInit = true
        end
    else
        fun.set_active(self.img_extra_reward, false)
    end
end

function PlayCardsNumberView:ClearSmallGameCountDown()
    if self.smallGameRemainTimeCountDown then
        LuaTimer:Remove(self.smallGameRemainTimeCountDown)
        self.smallGameRemainTimeCountDown = nil
    end
end

--设置消息通知
this.NotifyEnhanceList =
{
    {notifyName = NotifyName.UltraBet.ActivityStart, func = this.OnUltraBetStart},
    {notifyName = NotifyName.UltraBet.ActivityEnd, func = this.OnUltraBetEnd},
    {notifyName = NotifyName.UltraBet.RewardReceiveFinish, func = this.OnRewardReceiveFinish},
}
