---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/7/1 20:30
---
local GuideModel = BaseModel:New("GuideModel")
local this = GuideModel
this.OPEN_GUIDE_SAVE = true
this.currGuideInfo = nil
this.guideInfo = {}
this.forceBattleType = 0
this.removeCityDray = false
this.JumpMainView = false
this.JumpPowerup = false
this.ignoreUiName = nil
this.isSkipGuideTimer = nil

this.lastCreateCallBack = nil

---@type GuideAction
local guideAction = require("View/Guide/GuideAction")

function GuideModel:InitData(...)
    self.guide_record = {}
    if Csv.new_guide_step ~= nil then
        this.guideStep = Csv.new_guide_step
    end
    if Csv.new_guide_trigger ~= nil then
        this.trigger = Csv.new_guide_trigger
    end
    log.g(" GuideModel InitData ============== ")
    this.instance = GuideMgr and GuideMgr.GetIns() or nil
    this.removeCityDray = false
    this.ignoreUiName = nil
end

---@see 初始跳入大厅界面
local SetJumpMainView = function(data)
    ---@diagnostic disable-next-line
    if this.OPEN_GUIDE_SAVE == 0 then
        this:SetGuideMainView(false)
        this.JumpPowerup = false
    end
    local jumpMain = true
    for i = 1, #data.guide do
        if data.guide[i].guideId == 2 and data.guide[i].step ~= 0 then
            jumpMain = false
        elseif data.guide[i].guideId == 3 and data.guide[i].step ~= 0 then
            jumpMain = false
        elseif data.guide[i].guideId == 6 and data.guide[i].step ~= 0 then
            jumpMain = false
        elseif data.guide[i].guideId == 22 and data.guide[i].step ~= 0 then
            jumpMain = false
        elseif data.guide[i].guideId == 102 and data.guide[i].step ~= 0 then
            jumpMain = false
        end
    end
    if jumpMain and this.OPEN_GUIDE_SAVE == 0 then
        this:SetGuideMainView(jumpMain)
        this.JumpPowerup = jumpMain
    end
end

function GuideModel:SetLoginData(data)
    log.log("设置登陆数据  SetLoginData: ", data)
    --data.guide = {{guideId = 22,step = 0}}
    --this.OPEN_GUIDE_SAVE = fun.read_value("openGuide", 1)
    ---@diagnostic disable-next-line
    this.OPEN_GUIDE_SAVE = 0
    --暂时屏蔽 by LwangZg
    SetJumpMainView(data)
    --暂时屏蔽 by LwangZg
    this:SetLoginGuide(data)
end

function GuideModel:GetIns()
    if this.instance == nil then
        this.instance = GuideMgr.GetIns()
    end
    return this.instance
end

function GuideModel:GetGuideCfg()
    local guideC = {}
    local index = 1
    for _, v in pairs(this.guideStep) do
        guideC[index] = this:ConvertToGuideConfig(v)
        index         = index + 1
    end
    return guideC
end

function GuideModel:GetGuideTriggerConfig(group)
    local steps = {}
    local index = 1
    for _, v in pairs(this.trigger) do
        if v.client == group then
            steps[index] = this:ConvertToTriggerConfig(v)
            index        = index + 1
        end
    end
    --table.sort(steps,function(a, b)
    --    return a.triggerId < b.triggerId
    --end)
    return steps
end

local GetBeginnerParamValue = function(data, abParma)
    if data then
        for key, value in pairs(data) do
            if value.name == abParma then
                return value.value
            end
        end
    end
    return 1
end


function GuideModel:SetLoginGuide(data)
    ---@diagnostic disable-next-line: unnecessary-if
    if this.OPEN_GUIDE_SAVE == 0 then
        local guideGroup = GetBeginnerParamValue(data.roleInfo.abParams, "beginner")
        guideGroup = tonumber(guideGroup)
        if guideGroup == 0 then guideGroup = 1 end
        if this:GetIns() and not Util.IsNull(this:GetIns()) and this:GetIns() ~= nil then
            if fun.is_null(this:GetIns()) then
                this:GetIns():ClearData()
            end
            ViewList.GuideView:HideAllPanel()
            ViewList.GuideView:Close()
        end
        this:GetIns():SetGuideTriggerTable(this:GetGuideTriggerConfig(guideGroup))
        local guideCfg = this:GetGuideCfg()
        this:GetIns():SetGuideTable(guideCfg)
        this.guideInfo = {}
        if data.guide then
            local index = 1
            for i = 1, #data.guide do
                if Csv.isTraceID(data.guide[index].step, data.guide[index].guideId) then
                    local info   = GuideInfoMsg.New()
                    info.id      = data.guide[index].step
                    info.guideId = data.guide[index].guideId
                    table.insert(this.guideInfo, info)
                end
                index = index + 1
            end
        end
        if not IsNull(this.instance) then
            --将lua方法放到csharp侧持有
            this.instance:LoadGuideView(this.LoadGuideUI)
            this.instance:HideGuideView(this.HideGuideUI)
            this.instance:CreateGuideStepLua2C(this.CreateGuideStep)
            this.instance:GuideActionLua2c(this.C2LuaAction)
            this.instance:GuideConditionLua2c(this.GuideConditionTrigger)
            this.instance:GuideConditionLuaNew2c(this.GuideConditionTrigger2)
            this:UpdateRoleLevel()
            this.instance:SetCurrentGuideConfig(this.guideInfo, true)
        end
        local uid = ModelList.PlayerInfoModel:GetUid() or 0
        this:GetIns().uId = tonumber(uid)
    end
end

function GuideModel:GetGuideConfig(step)
    for _, v in ipairs(this.guideStep) do
        if v.id == step then
            return this:ConvertToGuideConfig(v)
        end
    end
end

function GuideModel:IsGuideMainView()
    return this.JumpMainView
end

function GuideModel:SetGuideMainView(isJumpMain)
    this.JumpMainView = isJumpMain
end

function GuideModel:IsJumpPower()
    if this.JumpPowerup then
        this.JumpPowerup = false
        return true
    end
    return false
end

function GuideModel:ConvertToGuideConfig(data)
    local guideCfg = t_base_guideConfig.New()
    guideCfg.id = data.id
    guideCfg.guideID = data.guideid
    guideCfg.nextID = data.nextid
    guideCfg.needSync = data.needsync
    --guideCfg.guideType = data.guidetype
    guideCfg.controlType = data.controltype
    guideCfg.param = data.param
    guideCfg.cmd = data.cmd
    guideCfg.path = data.path
    guideCfg.contentParam = data.contentparam
    guideCfg.content = data.content
    guideCfg.skipParam = data.skipparam
    guideCfg.satisfyParam = data.satisfyparam
    guideCfg.award = data.award
    guideCfg.before_setGuidePanel = data.before_setguidepanel
    guideCfg.after_setGuidePanel = data.after_setguidepanel
    guideCfg.startHere = data.starthere
    guideCfg.finishParam = data.finishparam
    guideCfg.finish_action = data.finish_action
    guideCfg.report = data.report
    guideCfg.skipTrigger = data.skiptrigger
    return guideCfg
end

function GuideModel:ConvertToTriggerConfig(data)
    local guideCfg = t_base_guide_triggerConfig.New()
    guideCfg.triggerId = data.triggerid
    guideCfg.view = data.view
    guideCfg.descripe = data.descripe
    guideCfg.startCondition = data.startcondition
    guideCfg.endCondition = data.endcondition
    guideCfg.isForce = data.isforce
    guideCfg.behaviorStep = data.behaviorstep
    guideCfg.follwStep = data.follwstep
    guideCfg.type = data.type
    guideCfg.path = data.path
    guideCfg.content = data.content
    guideCfg.contentParam = data.contentparam
    guideCfg.isPause = data.ispause
    guideCfg.param = data.param
    guideCfg.controlType = data.controltype
    guideCfg.client = data.client
    return guideCfg
end

function GuideModel:LoginCheckGuide()
    GuideMgr:CheckGuide()
end

local IsFirstGuide = function()

end


function GuideModel:BackToActiveUI(uiName)
    --log.g("openu ui   " .. uiName)
    if not this:GetIns() then
        log.r("OpenUI  null")
    end
    if this.ignoreUiName and uiName == this.ignoreUiName then
        this.ignoreUiName = nil
        return
    end
    --this:GetIns():RefreshUI(uiName,true)
end

function GuideModel:OpenUI(uiName)
    if not this:GetIns() then
        log.r("OpenUI  null")
    end
    if this.ignoreUiName and uiName == this.ignoreUiName then
        this.ignoreUiName = nil
        return
    end
    this:GetIns():RefreshUI(uiName, true)
end

---忽略下一次的某个UI界面打开
function GuideModel:IgnoreUIOpen(uiName)
    this.ignoreUiName = uiName
end

function GuideModel:SetCurrentGuide(guideInfo, isLogin)
    GuideMgr:LoadGuideView(this.LoadGuideUI)
    GuideMgr:HideGuideView(this.HideGuideUI)
    GuideMgr:SetCurrentGuideConfig(guideInfo, isLogin)
end

function GuideModel.LoadGuideUI()
    Facade.SendNotification(NotifyName.ShowUI, ViewList.GuideView)
end

function GuideModel.HideGuideUI()
    if ViewList.GuideView.go then
        Facade.SendNotification(NotifyName.HideUI, ViewList.GuideView)
    end
end

function GuideModel:Close()
    if this.instance then
        this.instance:ClearData()
    end
end

local CheckCitySkip = function(skipParam)
    if fun.starts(skipParam, "32#") then
        --LuaTimer:SetDelayFunction(0.3,function()
        --    if #this.currGuideInfo.skipParam > 0 then
        --        local city = ModelList.CityModel:GetCity()
        --        if fun.ends(skipParam, tostring(city)) then
        --            this:GetIns():GuideHandle(1, "")
        --        end
        --    end
        --end)
        if #this.currGuideInfo.skipParam > 0 then
            local city = ModelList.CityModel:GetCity()
            if fun.ends(skipParam, tostring(city)) then
                --this:GetIns():GuideHandle(1, "")
                --this.ReqFinishGuide(this.currGuideInfo.guideID,-1)
                log.e( "lua 请求引导 ReqSyncGuide")
                this.instance:ReqSyncGuide(true)
            end
        end
    end
end

---@为引导刷新城市ID数据_因为切换城市id的更新比较慢_需要循环刷新
local RefreshGuideCityId = function()
    this:GetIns().cityId = ModelList.CityModel:GetCity()
    LuaTimer:SetDelayLoopFunction(0, 0.1, 10, function()
        this:GetIns().cityId = ModelList.CityModel:GetCity()
    end)
end

--- 上一个引导结束的回调
function GuideModel:CheckLastGuideCallBack()
    if this.lastCreateCallBack then
        this.lastCreateCallBack()
        this.lastCreateCallBack = nil
    end
end

---根据配置创建引导步骤
---@param info t_base_guideConfig 引导步骤表
function GuideModel.CreateGuideStep(info)
    this.currGuideInfo = info
    RefreshGuideCityId()
    this:CheckLastGuideCallBack()
    if info.guideID == 5 or info.guideID == 6 then
        LuaTimer:SetDelayFunction(0.5, function()
            this:GetIns().powerUpCount = #ModelList.CityModel:GetCardsCurrentPage()
        end)
    end
    if #this.currGuideInfo.skipParam > 0 then
        CheckCitySkip(this.currGuideInfo.skipParam)
    end
    this.removeCityDray = guideAction:CheckCityDrag(info, this.removeCityDray)
    if info.id == 5 then
    elseif info.id == 1 then
        guideAction:ResetEasyTouch()
    elseif info.id == 20 or info.id == 320 or info.id == 1020 then
        guideAction:FirstBattleReady();
    elseif info.id == 21 or info.id == 321 or info.id == 1021 then
        guideAction:OpenFirstBattleMusic();
        --UISound.play("begin_1")
        --UISound.play("kick")
    elseif info.id == 22 or info.id == 322 or info.id == 1022 then
        guideAction:CloseFirstBattleMusic();
        ---由于城市入口不固定，所有引导额外处理路径问题把，唉
    elseif info.id == 40 or info.id == 61 or info.id == 340 or info.id == 361 then
        guideAction:ResetCityEntry(info)
    elseif (info.id == 200) or (info.id == 222) or info.id == 201 or info.id == 210 or info.id == 211 or
        (info.id == 226) or (info.id == 227) or (info.id == 229) or (info.id == 230) or (info.id == 231) or (info.id == 233)
        or (info.id == 234) or (info.id == 235) or (info.id == 236) or (info.id == 240) or (info.id == 241) or (info.id == 242)
        or (info.id == 246) or (info.id == 247) or (info.id == 248) or (info.id == 249) then
        guideAction:ResetDirToTargetCity(info)
    elseif info.id == 82 or info.id == 74 or info.id == 51 then
        GetCurHallView():SetCardRayCast()
    elseif info.id == 162 or info.id == 144 then
        GetCurHallView():SetCardRayCast()
    elseif info.id == 43 or info.id == 53 or info.id == 343 or info.id == 352 or info.id == 1043 or info.id == 1053 then --此处写死powerup 第二局引导显示free
        ModelList.CouponModel.set_FakeCouponData(1)
    elseif info.id == 49 or info.id == 59 or info.id == 347 or info.id == 356 or info.id == 1049 or info.id == 1059 then --此处写死powerup 第二局引导显示free
        ModelList.CouponModel.set_FakeCouponData(0)
        fun.save_value(ModelList.PlayerInfoModel:GetUid() .. MCT.HangUpAutoPowerConfig, 0)
    elseif info.id == 65 or info.id == 73 or info.id == 373 or info.id == 377 or info.id == 1065 or info.id == 1073 then
        ModelList.CouponModel.set_FakeCouponData(2)
        guideAction:ShowThreePuEffect(info.path, false)
    elseif info.id == 77 or info.id == 79 or info.id == 376 or info.id == 396 or info.id == 1077 or info.id == 1079 then
        ModelList.CouponModel.set_FakeCouponData(0)
        fun.save_value(ModelList.PlayerInfoModel:GetUid() .. MCT.HangUpAutoPowerConfig, 0)
    elseif info.id == 47 or info.id == 57 then --第二局战斗，如果在大厅场景，则返回登录
        guideAction:CheckIfEnterBattle()
    elseif info.id == 64 or info.id == 72 then
        guideAction:ShowThreePuEffect(info.path, true)
        --elseif info.id == 275 or info.id == 287  then
        --    guideAction:ShowCityTip(info.path,true)
        --end
    elseif info.id == 315 then
        guideAction:ShowModuleCityTip("winzone", true)
    elseif info.id == 316 or info.id == 317 or info.id == 319 then
        guideAction:ShowModuleCityTip("winzone", false)
    elseif info.id == 308 then
        guideAction:ShowNewCityTip(7, true)
        this.lastCreateCallBack = function()
            guideAction:ShowNewCityTip(7, false)
        end
    elseif info.id == 540 then
        local puType, viewName = guideAction:GetCurrPowerUpViewType()
        info.path = viewName
    elseif info.id == 541 then
        local puType, viewName = guideAction:GetCurrPowerUpViewType()
        info.contentParam = string.gsub(info.contentParam, "PowerUpView", viewName)
        info.path = string.gsub(info.path, "PowerUpView", viewName)
    elseif info.id == 568 then
        guideAction:ShowThreePuEffect(info.path, true, Vector3.New(-338.4891, 174.7827, 0))
    elseif info.id == 569 then
        guideAction:ShowThreePuEffect(info.path, false)
    elseif info.id == 570 then
        local puType, viewName = guideAction:GetCurrPowerUpViewType()
        if puType ~= 4 then
            info.param = string.gsub(info.param, "PowerUpViewMaster", viewName)
            info.contentParam = string.gsub(info.contentParam, "PowerUpViewMaster", viewName)
        end
    end

    if info.report and #info.report > 0 then
        SDK.bi_tracker:guide_step(info.report,{step = info.id})
    end

    log.g("创建引导步骤 info.id  " .. info.id)

    if this.isSkipGuideTimer ~= nil then
        log.g("引导定时器 销毁")
        LuaTimer:Remove(this.isSkipGuideTimer)
        this.isSkipGuideTimer = nil
    end

    if this.isSkipGuideTimer == nil then
        log.g("引导定时器 需要开启 =》》" .. tonumber(info.skipTrigger))
        if info.skipTrigger ~= nil and tonumber(info.skipTrigger) > 0 then
            local time = tonumber(info.skipTrigger) + 5
            log.g("引导定时器 已开启 =》》" .. time)
            --开启定时器
            this.isSkipGuideTimer = LuaTimer:SetDelayFunction(time, function()
                --超过正常时间，显示
                --跳过当前得步骤

                this.isSkipGuideTimer = nil
                if this.instance ~= nil then
                    this.instance:BreakGuideStep()
                    this.ReqFinishGuide(info.guideID, -1)
                    this.instance:ReqSyncGuide(true)
                end
            end)
        end
    end
end

local cityTipTiem = nil
local ShowCityTip = function()
    if this:IsForceBattle() then
        LuaTimer:SetDelayFunction(0.5, function()
            local Arrow = GameObject.Find("GameManager/GlobalUI/Parent/GuideView/Panel/CityTip")
            if not Util.IsNull(Arrow) then ---已经没有city tip 这段代码貌似没啥用了
                fun.set_same_position_with(Arrow, ViewList.GameBingoView.powerView.cd_img)
                fun.set_active(Arrow, true)
                cityTipTiem = LuaTimer:SetDelayFunction(5, function()
                    fun.set_active(Arrow, false)
                    cityTipTiem = nil
                end)
            end
        end)
    end
end

function GuideModel:BreakGuideStep()
    if this.instance ~= nil then
        this.instance:BreakGuideStep()
        this.instance:ReqSyncGuide(true)
    end
end

function GuideModel.GuideAction(type, str, cellNum)
    if this.currGuideInfo == nil then return end
    log.r("currGuideInfo.guideID    " ..
        this.currGuideInfo.guideID .. "   " .. str .. "    " .. tostring(type) .. "      " .. this.currGuideInfo.id)
    if type == 0 then --等待的号码出来了，放开点击
        guideAction:OpenCardClick()
    end
    if this.currGuideInfo.controlType ~= 3 then
        this:GetIns():GuideHandle(type, str)
    elseif type == 4 then
        this:GetIns():GuideHandle(type, str)
    end
    if cellNum == 18 and this:IsFirstBattle() then
        ShowCityTip()
    end
end

function GuideModel.C2LuaAction(type)
    if this.isSkipGuideTimer ~= nil then
        log.g("引导定时器 销毁")
        LuaTimer:Remove(this.isSkipGuideTimer)
        this.isSkipGuideTimer = nil
    end

    if this.currGuideInfo == nil then
        return
    end

    log.r(" 完成引导 C2LuaAction  type: " .. type .. "  this.currGuideInfo.guideID: " .. this.currGuideInfo.guideID)
    log.r(" this.currGuideInfo.id: " .. this.currGuideInfo.id)
    if type == 3 then      --完成引导
        --this.ReqFinishGuide(this.currGuideInfo.guideID, this.currGuideInfo.id)
        this.ReqFinishGuide(this.currGuideInfo.guideID, -1)
    elseif type == 47 then -- 进入战斗
        -- guideAction:StartFirstBattle()
        guideAction:FirstTimeBattle()
        UISound.play("begin_1")
    elseif type == 45 then -- 等待叫号
        --guideAction:OpenCardClick()
        --BattleMachineList.PauseBattleMachine(false)
    elseif type == 46 then --可以放开power点击
        guideAction:OpenPowerUpClick()
        guideAction:CloseCardClick()
    elseif type == 121 then -- 暂停小火箭倒计时
        Event.Brocast(EventName.Event_Open_Shop_View, true)
    elseif type == 123 then -- 恢复小火箭倒计时
        Event.Brocast(EventName.Event_Open_Shop_View, false)
    elseif type == -1 then
        this.ReqFinishGuide(this.currGuideInfo.guideID,-1)
    end

    --------完成引导
end

function GuideModel.GuideConditionTrigger(type)
    log.r("GuideConditionTrigger   " .. type)
    ---@检查材料集齐
    if type == "FunctionIconCuisinesView" then
        return ModelList.ItemModel:IsCuisinesAvailable()
        ---@检查任务奖励
    elseif type == "FunctionIconTaskView" then
        return this:IsViewRedPoint(type)
        ---@检查没有放大镜
    elseif type == "NoMirror" then
        local hintTime = ModelList.ItemModel:get_hintTime()
        return not (hintTime and hintTime > 1)
    elseif type == "noadventrue" then
        if ViewList.AdventureView and ViewList.AdventureView.go and ViewList.AdventureView.go.activeInHierarchy then
            return false
        end
        if ModelList.CityModel.GetPlayIdByCity() == 17 then
            return false
        end
        return true
    elseif type == "InShopItem" then
        --附加判断是否有免费得放大镜
        local isBigR = ModelList.regularlyAwardModel:CheckUserTypes() --判断是否是大R用户
        if not isBigR and ViewList.ShopView and ViewList.ShopView.go and ViewList.ShopView:CheckShopTabIndex(4) then
            return true
        end
        return false
    elseif type == "FreeShopReward" then
        return ModelList.MainShopModel:CheckFreeRewardAvailable()
    elseif type == "FunctionIconBingopass" then
        return ModelList.BingopassModel:CheckRedDot()
    elseif type == "winzone" then
        return ModelList.WinZoneModel:IsEverFinishedMatch()
    elseif type == "DownloadFinishWinZone" then
        -- TODO by LwangZg 运行时热更部分
        local DownloadState = {
            downloading = 1, --下载中
            finish = 2,      --下载完成
            empty = 0        --没有模块
        }
        local winzonId = 14
        local DownloadUtility = require "View/CommonView/DownloadUtility"
        local state, downloadData = DownloadUtility:CheckDownload(winzonId)

        if (state == DownloadState.finish) then
            return true
        else
            Facade.SendNotification(NotifyName.StartDownloadMachine, winzonId)
        end
        return false
    elseif type == "ShowPuBanner" then
        local userInfo = ModelList.PlayerInfoModel:GetUserInfo()
        local userID = userInfo.uid
        local endTime = ModelList.CityModel:GetPuBuffSeasonEndTime()
        local popKey = "SeasonPowerUpPosterView_FlyPower" .. endTime .. userID
        if fun.read_value(popKey, 0) == 1 then
            return true
        end
    elseif type == "SuperMatch" then           ---supermatch
        return ModelList.SuperMatchModel:CanEnterSuperMatch()
    elseif type == "SuperMatchSmashUltra" then ---supermatch
        if ModelList.SuperMatchModel:CanEnterSuperMatchIgnoreBet() and ModelList.UltraBetModel:IsActivityValidForCurPlay() then
            return true
        end
        return false
    elseif type == "SuperMatchSmashUnlock" then ---supermatch
        if ModelList.SuperMatchModel:CanEnterSuperMatchIgnoreBet() and not ModelList.UltraBetModel:IsActivityValidForCurPlay() then
            return true
        end
        return false
    elseif type == "SuperMatchSmashLock" then ---supermatch
        if ModelList.SuperMatchModel:CanEnterSuperMatchIgnoreBet() and not ModelList.SuperMatchModel:CanEnterSuperMatch() and not ModelList.UltraBetModel:IsActivityValidForCurPlay() then
            return true
        end
        return false
    end
    return false
end

function GuideModel.GuideConditionTrigger2(type)
    log.r("GuideConditionTrigger2   " .. type)
    ---@检查材料集齐
    local playid = tonumber(type)
    local curPlayid = ModelList.CityModel.GetPlayIdByCity()
    if playid == curPlayid then --检查是否在哪里
        return true
    end
    return false
end

function GuideModel:IsViewRedPoint(view)
    local view = GetFunctionViewRef(view)
    if view and view.img_reddot and fun.get_active_self(view.img_reddot) then
        return true
    end
    return false
end

function GuideModel:IsGuiding()
    if this.instance ~= nil then
        return this.GetIns().m_CurGuide ~= nil
    end
    return false
end

function GuideModel:UpdateRoleLevel()
    if this:GetIns() then
        this:GetIns().Level = ModelList.PlayerInfoModel:GetLevel()
    end
end

function GuideModel:RestoreFirstBattle()
    --log.r("GuideModel:RestoreFirstBattle")
    --guideAction:RestoreFirstBattle()
    --guideAction:OpenPowerUpClick()
    local Arrow = GameObject.Find("GameManager/GlobalUI/Parent/GuideView/Panel/Arrow")
    if Arrow and not Util.IsNull(Arrow) then
        fun.set_active(Arrow.gameObject, false)
    end
end

function GuideModel:Reset()
    this:SetGuideBattle(0)
end

function GuideModel:SetGuideBattle(battleType)
    this.forceBattleType = battleType
    guideAction.Reset()
    if this:IsFirstBattle() then
        this:SetGuideMainView(false)
    end
end

function GuideModel:GetGuideBattleType()
    return this.forceBattleType
end

function GuideModel:IsForceBattle()
    if this.forceBattleType > 0 and this.forceBattleType <= 3 then return true end
    if this.forceBattleType == 22 then return true end
    if this.forceBattleType == 102 then return true end
    if this.guideInfo then
        for i = 1, #this.guideInfo do
            if this.guideInfo[i].guideId == 2 and this.guideInfo[i].id == 0 then
                return true
            end
        end
        return false
    else
        return true
    end
end

function GuideModel:IsFirstBattle()
    if this.forceBattleType == 2 then
        return true
    end
    if this.forceBattleType == 22 then
        return true
    end
    if this.forceBattleType == 102 then
        return true
    end

    return false
end

function GuideModel:IsSecondBattle()
    if this.forceBattleType == 3 then
        return true
    end
    if this.forceBattleType == 23 then
        return true
    end
    if this.forceBattleType == 103 then
        return true
    end
    return false
end

function GuideModel:CallNumber(currNumber)
    if this:IsSecondBattle() then
        guideAction:PlaySecondBattleAutoPowerFinger()
    elseif this:IsForceBattle() then
        this:GetIns().CallNumber = currNumber
        local data = ModelList.GameModel:GetRoundData()
        if this.currGuideInfo and this.currGuideInfo.controlType == 111 and fun.ends(this.currGuideInfo.param, tostring(currNumber)) then
            BattleModuleList.GetModule("CardMagnifier"):SetMirrorDelayTipTIme(true)
        else
            BattleModuleList.GetModule("CardMagnifier"):SetMirrorDelayTipTIme(false)
        end
        for k, v in pairs(data) do
            for i = 1, #v.cards do
                if (v.cards[i].num == currNumber or v.cards[i].double_num == currNumber) and v.cards[i].sign == 0 then
                    local ref = fun.get_component(ModelList.BattleModel:GetCurrBattleView():GetCardView():GetCardMap(k),
                        fun.REFER)
                    local cell = ref:GetByIndex(i)
                    Event.Brocast(EventName.Guide_Click_Card_Cell, cell, currNumber)
                    break
                end
            end
        end
    end
end

---@充能结束
function GuideModel.RechargeOver(IsRecharge)
    if this:IsFirstBattle() then
        if IsRecharge then
            guideAction:PlayFirstBattlePowerFinger()
        else
            guideAction:HideFirstBattlePowerFinger()
        end
    else
        Event.Brocast(EventName.ApplicationGuide_PowerUp, IsRecharge)
    end
end

function GuideModel.ReqFinishGuide(guide, stepId)
    log.e("新手引导 c2s ==> ReqFinishGuide stepId: " .. stepId)
    local temp = { guideId = guide, step = stepId }
    this.SendMessage(MSG_ID.MSG_GUIDE, temp, true);
end

function GuideModel.ResGuide(code, data)
    if (code == RET.RET_SUCCESS) then
        --log.r("收到 Guide  Res  "..code.."     ")
        if data then
            for i = 1, #data.guide do
                local info       = GuideInfoMsg.New()
                info.id          = data.guide[i].step
                info.guideId     = data.guide[i].guideId
                --log.r("收到 Guide  Res22     "..info.guideId)
                local hasContain = false
                for k = 1, #this.guideInfo do
                    if info.guideId == this.guideInfo[k].guideId then
                        if info.id > this.guideInfo[k].id or info.id == -1 then
                            this.guideInfo[k].id = info.id
                            hasContain = true
                            break
                        end
                    end
                end
                if not hasContain then
                    table.insert(this.guideInfo, info)
                end
                --log.r("OnResSyncGuideMsg "..info.id.."      "..info.guideId)
                this:GetIns():OnResSyncGuideMsg(info.id, info.guideId, "", "")
                --- 清掉当前引导信息
                if this.currGuideInfo and this.currGuideInfo.guideID == info.guideId then
                    if info.id == -1 or this.currGuideInfo.nextID == 0 then
                        this.currGuideInfo = nil
                    end
                end
            end
        end
    else
        log.r("引导错误" .. code)
    end
end

function GuideModel:GetGuideAction()
    return guideAction
end

function GuideModel:DisposeGuideStep(cmd)
    if not this.currGuideInfo then
        return
    end

    if this.currGuideInfo.cmd == cmd then
        log.log("this.currGuideInfo.cmd " .. this.currGuideInfo.cmd .. " cmd " .. cmd .. " DisposeGuideStep")
        GuideModel:GetIns():DisposeGuideStep()
    end
end

--- 引导是否完成的接口
function GuideModel:IsGuideComplete(guidId)
    if this.guideInfo then
        for i = 1, #this.guideInfo do
            if this.guideInfo[i].guideId == guidId and (this.guideInfo[i].id == -1 or this.guideInfo[i].id > 0) then
                return true
            end
        end
    end
    return false
end

--- 此方法只需触发一次,不要重复调用
function GuideModel:TriggerWinZoneBattleGuide(stepId)
    ModelList.GuideModel:GetIns().Wait = true;
    ModelList.GuideModel:GetIns():SetNextGuideStep(stepId)
end

--- 此方法只需触发一次,不要重复调用
function GuideModel:TriggerFireVolcanoEngerGuide(stepId)
    ModelList.GuideModel:GetIns().Wait = true;
    ModelList.GuideModel:GetIns():SetNextGuideStep(stepId)
end

--- 此方法只需触发一次,不要重复调用
function GuideModel:TriggerPassTaskView(stepId)
    ModelList.GuideModel:GetIns().Wait = true;
    ModelList.GuideModel:GetIns():SetNextGuideStep(stepId)
end

--- 此方法只需触发一次,不要重复调用
function GuideModel:TriggerSuperMatchGuide(stepId)
    ModelList.GuideModel:GetIns().Wait = true;
    ModelList.GuideModel:GetIns():SetNextGuideStep(stepId)
end

--- 此方法只需触发一次,不要重复调用
function GuideModel:TriggerSuperMatchBangGuide(stepId)
    ModelList.GuideModel:GetIns().Wait = true;
    ModelList.GuideModel:GetIns():SetNextGuideStep(stepId)
end

--- 此方法只需触发一次,不要重复调用
function GuideModel:TriggerSuperMatchPuGuide()
    --if not self:IsGuideComplete(78) then
    --    ModelList.GuideModel:GetIns().Wait = true;
    --    ModelList.GuideModel:GetIns():SetNextGuideStep(570)
    --end
end

--- 此方法只需触发一次,不要重复调用
function GuideModel:TriggerGoldenTrainPuGuide()
    if not self:IsGuideComplete(85) then
        ModelList.GuideModel:GetIns().Wait = true;
        ModelList.GuideModel:GetIns():SetNextGuideStep(586)
    end
end

--- 作用同上
function GuideModel:TriggerChristmasSynthesisPuGuide()
    if not self:IsGuideComplete(87) then
        ModelList.GuideModel:GetIns().Wait = true;
        ModelList.GuideModel:GetIns():SetNextGuideStep(592)
    end
end

--- 玩家没有选择已解锁的最高bet的时候触发引导
function GuideModel:CheckSuperMatchMaxbetGuide()
    if self:IsGuideComplete(77) then
        return false
    end
    if ModelList.ItemModel.getResourceNumByType(Resource.supermatch_ticket) <= 0 then
        return false
    end
    if ModelList.CityModel:IsMaxBetRate() then
        return false
    end
    if ModelList.CityModel:GetEnterGameMode() ~= 1 then
        return false
    end
    self:TriggerSuperMatchGuide(566)
end

this.MsgIdList =
{
    { msgid = MSG_ID.MSG_GUIDE, func = this.ResGuide },
}


return this
