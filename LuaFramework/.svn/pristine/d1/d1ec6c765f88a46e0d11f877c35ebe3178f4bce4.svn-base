---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/4/3 18:02
---

local CompetitionModel = BaseModel:New("CompetitionModel")
local this = CompetitionModel

local activity_list = nil

local firstOpen_list = nil

local gift_double_time = 0
---日榜排行
local competition_rankInfo = nil

this.waitingShowIconBeDoubleIdList = {}

function CompetitionModel.GetPrefsKey(id)
    return string.format("Competition_prefs%s",id)
end

function CompetitionModel.GetPrefsInt(id)
    return UnityEngine.PlayerPrefs.GetInt(this.GetPrefsKey(id),-1)
end

function CompetitionModel.SetPrefsInt(id,value)
    UnityEngine.PlayerPrefs.SetInt(this.GetPrefsKey(id),value)
end


function CompetitionModel.GetPrefsString(strName)
    return UnityEngine.PlayerPrefs.GetString(strName,"")
end

function CompetitionModel.SetPrefsString(strName)
    if activity_list and activity_list.id then
        local id = activity_list.id
        UnityEngine.PlayerPrefs.SetString(strName,tostring(id) )
    end
end

--function CompetitionModel:SetLoginData(data)
--    if data and data.competitionInfo then
--        self:SetActivityData(data.competitionInfo)
--    end
--end

function CompetitionModel:GetRemainTime()
    if activity_list and activity_list and   activity_list.roundData and #activity_list.roundData > 0 then
        return 9999999999
    end
    return 0
end


function CompetitionModel:SetActivityData(data,isUpdate)
    log.log("设置活动数据 SetActivityData " , data)
    if data then
        if not activity_list then
            activity_list = {}
            firstOpen_list = {}
        end
        --activity_list[data.id]  = deep_copy(data)
        activity_list  = deep_copy(data)
        local prefabs = this.GetPrefsString("competitionId")
        if prefabs == "" or prefabs == nil then
            this.SetPrefsString("competitionId")
            firstOpen_list = true
        end
        competition_rankInfo = {}
        --competition_rankInfo.showRankList = data.showRankList
        --for key, value in pairs(data) do
        --    activity_list[value.id] = deep_copy(value)
        --    ---活动过期，是双倍就要关闭icon双倍效果
        --    if isUpdate then
        --        --Event.Brocast(EventName.Event_Check_Double_Activity,value.id, not self:IsActivityExpire(value.endTime) )
        --    end
        --    local prefabs = this.GetPrefsInt(value.id)
        --    if prefabs ~= value.createTime then
        --        this.SetPrefsInt(value.id,value.createTime)
        --        firstOpen_list[value.id] = true
        --    end
        --end
    end
end

function CompetitionModel.S2C_ReceiptActivityInfo(code,data)
    if code == RET.RET_SUCCESS then
        this:SetActivityData(data.activityInfo)
        Facade.SendNotification(NotifyName.HallCity.EnterCityPopupOrder,PopupOrderOccasion.forcePopup)
    end
end

function CompetitionModel.S2C_UpdateActiveInfo(code,data)
    if code == RET.RET_SUCCESS then
        this:SetActivityData(data.state,true)
    end
end

function CompetitionModel.C2S_SubmitActivity_old(activityId)
    if activityId then
        this.SendMessage(MSG_ID.MSG_ACTIVITY_HISTORY_RECEIVE_REWARD,{activityId = activityId})
    end
end

function CompetitionModel.C2S_SubmitActivity_new(activityId,roundId,createTime,rewardExtra)
    if activityId then
        this.SendMessage(MSG_ID.MSG_ACTIVITY_ROUND_RECEIVE_REWARD,{activityId = activityId,roundId = roundId,createTime = createTime,rewardExtra = rewardExtra})
    end
end

function CompetitionModel.ResCupRoundReward(code,data)
    if code == RET.RET_SUCCESS then
        -- body
        Event.Brocast(EventName.Event_competition_receive_reward2,code)
    end
    --if activity_list and activity_list.roundData then
    --
    --end
    Event.Brocast(EventName.Event_competition_receive_reward,code)
end

function CompetitionModel.ResCupRankReward(code,data)
    if activity_list then
        activity_list.competitionRankReward ={}
        activity_list.showRankList ={}
    end
    ModelList.CompetitionModel:ClearShownedExtraAnima()
    Event.Brocast(EventName.Event_competition_receive_rank_reward,code)
end

function CompetitionModel:GetActivityInfo()
    if activity_list then
        return activity_list
    end
    return nil
end


function CompetitionModel:IsNewAvailable()
    if activity_list and activity_list and activity_list.hasRoundData == 1 then
        return true
    end
    return false
end

function CompetitionModel:IsActivityAvailable()
    if self:IsUnAvailableAndHasReward() then
        return true
    end
    if self:IsNewAvailable() then
        return true
    end
    return false
end

--- 活动是否过期
function CompetitionModel:IsActivityExpire()
    --if activity_list and activity_list.expireTime then
    --    if activity_list.systemOsTime and activity_list.systemOsTime >= tonumber(activity_list.expireTime)   then
    --        return true
    --    end
    --    return activity_list.expireTime - os.time() < 0
    --end
    return not self:IsNewAvailable()
end

function CompetitionModel:IsUnAvailableAndHasReward()
    if activity_list and activity_list.competitionRoundReward and #activity_list.competitionRoundReward > 0 then
       return true
    end
    return false
end

function CompetitionModel:IsUnAvailableAndHasRank()
    --if activity_list and activity_list.showRankList and #activity_list.showRankList > 0 and fun.read_value("lastCompetition",0) ~= activity_list.id then
    if activity_list and activity_list.showRankList and #activity_list.showRankList > 0 and self:GetRemainTime() <= 0   then
        return true
    end
    return false
end

function CompetitionModel:IsUnAvailableAndHasRoundData()
    if activity_list and activity_list.roundData and #activity_list.roundData > 0 and activity_list.roundData[1].progress > 0 then
        return true
    end
    return false
end

function CompetitionModel:SaveLastCompetition()
    fun.save_value("lastCompetition",activity_list.id)
end

function CompetitionModel:HasHistoryReward()
    if activity_list and activity_list.hasHistoryReward and activity_list.hasHistoryReward == 1 then
        return true
    end
    return false
end


function CompetitionModel:IsActivityFirstOpen()
    return this:IsFirstOpen()
end

function CompetitionModel:IsAnyFirstOpen()
    return this:IsFirstOpen()
end

function CompetitionModel:IsFirstOpen()
    if firstOpen_list then
        firstOpen_list = (this.GetPrefsString("competition_last_open")~= tostring(activity_list.id) )
    end
    return firstOpen_list
end

function CompetitionModel:CutdownFirstPopup(id)
    if firstOpen_list then
        firstOpen_list = false
    end
end

function CompetitionModel:GetQuickTaskActive()
    local quickTask = nil
    local quickTaskActive = this:GetActivityInfo()
    if quickTaskActive then
        for i = 1, #quickTaskActive.roundData do
            if  not  quickTaskActive.roundData[i].rewarded    and (quickTask == nil or (quickTaskActive.roundData[i].id <= quickTask.id  and quickTaskActive.roundData[i].completed ) ) then
                quickTask = quickTaskActive.roundData[i]
            end
        end
        --if quickTask == nil then
        --    quickTask = quickTaskActive.roundData[ #quickTaskActive.roundData ]
        --end
        --for key, value in pairs(quickTaskActive.roundData) do
        --    if  not  value.rewarded    and (quickTask == nil or (value.id <= quickTask.id  and value.completed ) ) then
        --        quickTask = value
        --    end
        --end
    end
    return quickTask,quickTaskActive
end

function CompetitionModel:HasMultipleRoundsCookie()
    local quickTaskActive = this:GetActivityInfo()
    if quickTaskActive then
        if   #quickTaskActive.roundData > 2 then
            return true
        end
    end
    return false
end

function CompetitionModel:HasCookie()
    local quickTaskActive = this:GetActivityInfo()
    if quickTaskActive then
        if   #quickTaskActive.roundData > 1 then
            return true
        elseif quickTaskActive.roundData[1].oldProgress < quickTaskActive.roundData[1].progress   then
            quickTaskActive.roundData[1].oldProgress = quickTaskActive.roundData[1].progress
            return true
        else
            return false
        end
    end
    return false
end

function CompetitionModel:SaveOldProgress()
    local quickTaskActive = this:GetActivityInfo()
    if quickTaskActive then
        if quickTaskActive.roundData and  #quickTaskActive.roundData > 0 then
            quickTaskActive.roundData[1].oldProgress = quickTaskActive.roundData[1].progress
        end
    end
end

function CompetitionModel:GetNextQuickTaskActive(currOrderId)
    local quickTask = nil
    local quickTaskActive = this:GetActivityInfo()
    if quickTaskActive then
        for key, value in pairs(quickTaskActive.roundData) do
            if  not  value.rewarded  and value.id ~= currOrderId   and (quickTask == nil or (value.id <= quickTask.id  and value.completed ) ) then
                quickTask = value
            end
        end
    end
    return quickTask,quickTaskActive
end

function CompetitionModel:GetCompetitionStartId()
    if activity_list and activity_list.competitionStartId then
        return activity_list.competitionStartId
    end
    return 0
end

function CompetitionModel:GetCompetitionGroupId()
    if activity_list and activity_list.groupId then
        return activity_list.groupId
    end
    return 0
end


---移除登录弹窗列表
function CompetitionModel:RemoveLoginOpenActivity(id)
    this:CutdownFirstPopup(id)
    if this.needShowOpenList  and #this.needShowOpenList>0 then
        fun.remove_table_item(this.needShowOpenList,id)
    end
end

function CompetitionModel:IsActivityLoginOpen(id)
    return this.needShowOpenList and fun.is_include(id, this.needShowOpenList) and this:IsActivityAvailable(id)
end

---激活过的双倍
function CompetitionModel:IsActiveAndDuringDouble(id)
    local activityId = Csv.GetData("function_icon",id,"activity_type")
    if not this.waitingShowIconBeDoubleIdList[activityId] and this:IsActivityAvailable(activityId) then
        return true
    end
    return false
end

--
--function CompetitionModel:IsActivityExpire(endTime)
--    return endTime -os.time() <= 0
--end


function CompetitionModel:CheckDoubleOpen()
    for i = 1, #this.needShowOpenList do
        if self:IsActivityLoginOpen(this.needShowOpenList[i])  and self:IsActivityAvailable(this.needShowOpenList[i]) then
            this.waitingShowIconBeDoubleIdList[this.needShowOpenList[i]] = true
        end
    end
end

function CompetitionModel:IsWaitingShowChangeDouble(id)
    return this.waitingShowIconBeDoubleIdList[id]
end

function CompetitionModel:HadShowChangeDouble(id)
    this.waitingShowIconBeDoubleIdList[id] = false
    this:CutdownFirstPopup(id)
end

function CompetitionModel:CanGetReward()
    --if activity_list then
    --    return #activity_list.competitionRankReward > 0
    --end
    return false
end

--
--function CompetitionModel.ResCupFetch(code,data)
--    if code == RET.RET_SUCCESS and data then
--        competition_rankInfo = deep_copy(data.competitionInfo.showRankList)
--        activity_list  = deep_copy(data.competitionInfo)
--        ModelList.SuperMatchModel:SetSuperMatchData(data.superMatchInfo)
--    end
--end

function CompetitionModel.ResCupNotify(code,data)
    log.log("饼干数据接收 a " ,code , data)
    if code == RET.RET_SUCCESS then
        this:SetCompetitionActivityData(data)
        if this:CanGetReward() then
            Facade.SendNotification(NotifyName.HallCity.EnterCityPopupOrder,PopupOrderOccasion.forcePopup)
        end
        Facade.SendNotification(NotifyName.Competition.ResphoneNotify)

    end    
end

function CompetitionModel:SetCompetitionActivityData(data,isUpdate)
    if data then
        if   activity_list and activity_list.id == data.id and  self.GetPrefsString("repopgift"..activity_list.id) == "" and activity_list.roundData and #activity_list.roundData> 0 and
                activity_list.roundData[1].progress == 0 and not activity_list.roundData[1].rewarded and data.roundData and #data.roundData > 0 and
                data.roundData[1].progress > 0  then
            self.SetPrefsString("repopgift"..activity_list.id)
            ModelList.GiftPackModel:ResetCompetitionGiftCD()       
        end
        if not activity_list then
            activity_list = {}
            firstOpen_list = {}
        end
        activity_list = deep_copy(data)
        local prefabs = this.GetPrefsInt(data.id)
        if prefabs == "" or prefabs == nil then
            this.SetPrefsInt(data.id,data.createTime)
            firstOpen_list = true
        end
    end
end

function CompetitionModel:SaveShownedExtraAnima(order)
    if activity_list and activity_list.id then
        if not self.ExtraOrderList then  self.ExtraOrderList= {} end
        self.ExtraOrderList[activity_list.id..order] = true
    end
end

function CompetitionModel:ClearShownedExtraAnima()
    self.ExtraOrderList= {}
end

function CompetitionModel:IsShownedExtraAnima(order)
    if activity_list and activity_list.id then
        if self.ExtraOrderList  and self.ExtraOrderList[activity_list.id..order] then
            return true
        end
    end
    return false
end

function CompetitionModel:IsShowedCompetitionTip()
    ---检查次数上限
    local uid =ModelList.PlayerInfoModel:GetUid() or ""
    if fun.read_value("competition_show_times_helper"..uid,0) > Csv.GetControlByName("competition_show_times")[1][1] then
        return true
    end
    if activity_list and activity_list.id then
        local prefabs = this.GetPrefsString("competition_last_show")
        if prefabs ~= tostring(activity_list.id)  then
            return false
        end
    end
    return true
end

function CompetitionModel:IsShowedCompetitionOpenTip()
    if activity_list and activity_list.id then
        local prefabs = this.GetPrefsString("competition_open_show")
        if prefabs ~= tostring(activity_list.id)  then
            return false
        end
    end
    return true
end

function CompetitionModel.S2C_UpdateCompetitionActiveInfo(code,data)
    if code == RET.RET_SUCCESS then
        this:SetActivityData(data.state,true)
    end
end

function CompetitionModel.Login_C2S_CompetitionRankInfo()
    --if not type then type = 1 end
    this.SendMessage(MsgIDDefine.PB_CookieFetch,{type = 1})
end

function CompetitionModel.ReqCompetitionRankInfo(type)
    if not type then type = 1 end
    this.SendMessage(MsgIDDefine.PB_CookieFetch,{type = type})
end


function CompetitionModel:GetRankInfoPlayerList()
    if competition_rankInfo and competition_rankInfo.showRankList then
        return competition_rankInfo.showRankList
    end
    if activity_list and activity_list.showRankList then
        return activity_list.showRankList
    end
    return nil
end

--- 战斗入场时的排名
function CompetitionModel:GetReadyRankInfoList()
    if competition_rankInfo and competition_rankInfo.showRankList then
        return competition_rankInfo.showRankList
    end
    if activity_list and activity_list.showRankList then
        return activity_list.showRankList
    end
    return nil
end

function CompetitionModel:HasDoubleRewards()
    return (activity_list and activity_list.hasDoubleReward) and activity_list.hasDoubleReward  or false
end

function CompetitionModel:HasDoubleUnclaimedRewards()
    return (activity_list ) and ( activity_list.hasDoubleReward ) or false
end


function CompetitionModel:GetDoubleCollectBuffTime()
    return ModelList.ItemModel:get_competitionDoubleCollect()
end

function CompetitionModel:GetDoubleRewardBuffTime()
    return ModelList.ItemModel:get_competitionDoubleReward()
end

function CompetitionModel:InitDoubleTimer()
    if self._timer then
        self._timer:Stop()
    end
    self._timer = Timer.New(function()
        self:OnTimerCall()
    end,1,-1,true)
    self._timer:Start()
end


function CompetitionModel:OnTimerCall()
    if gift_double_time and gift_double_time > 0 then
        gift_double_time = math.max(0,gift_double_time - 1)
        if gift_double_time <= 0 then
            gift_double_time = nil
        end
    end
end

function CompetitionModel:GetRoundReward()
    log.log("获取饼干奖励数据 " , activity_list)
    return (activity_list and activity_list.roundReward) and activity_list.roundReward  or nil
end

function CompetitionModel:GetRewardIcon(data)
    return Csv.GetData("competition_start",data.id,"icon")
end


function CompetitionModel:RemoveNearRound(orderId)
    if activity_list and activity_list.roundData then
        for k,v in pairs(activity_list.roundData) do
            if v.order == orderId then
                v.rewarded = true
            end
        end
        --table.remove(activity_list.roundData,1)
    end
end


function CompetitionModel.ShowCompetitionHistoryRankInfo()
    if not competition_rankInfo then  competition_rankInfo = {} end
    competition_rankInfo.showRankList = activity_list.rankInfo
    --competition_rankInfo = deep_copy(activity_list.rankInfo)
    --Facade.SendNotification(NotifyName.Competition.ResphoneRankInfo)
    --Facade.SendNotification(NotifyName.ShowUI,ViewList.CompetitionCookieRank,nil,false,true)
end

function CompetitionModel.HasRankReward()
    --if activity_list and activity_list.competitionRankReward then
    --    return #activity_list.competitionRankReward >0
    --end
    return false
end

function CompetitionModel.GetRankRewardInfo()
    if activity_list and activity_list.competitionRankReward then
        return activity_list.competitionRankReward
    end
end

function CompetitionModel.GetSelfRank()
    local uid = ModelList.PlayerInfoModel:GetUid()
    if activity_list and activity_list.showRankList then
        for i = 1, #activity_list.showRankList do
            if activity_list.showRankList[i].uid == uid then
                return activity_list.showRankList[i]
            end
        end
    end
    return nil
end

function CompetitionModel.HasRankReward()
    --if activity_list.competitionRankReward then
    --    return #activity_list.competitionRankReward > 0
    --end
    return false
end

--返回现在用户的id状态
function CompetitionModel:GetPlayerChooseId()
    return this.playerChooseId and this.playerChooseId or 0 
end 

function CompetitionModel:GetPlayerOptions()
    return this.chooseOptions and this.chooseOptions or {}
end 

function CompetitionModel.ReqCompetitionInfo()
    this.SendMessage(MsgIDDefine.PB_CookieFetch,{})
end

function CompetitionModel.ReqGetCompetitionReward()
    AddLockCountOneStep(true)
    this.SendMessage(MsgIDDefine.PB_CookieRoundReward,{ competitionId = activity_list.id})
end

function CompetitionModel.ReqGetCompetitionRankReward()
    AddLockCountOneStep(true)
    this.SendMessage(MSG_ID.MSG_COMPETITION_CUP_RANK_REWARD,{ competitionId = activity_list.id})
end


function CompetitionModel.GetCurrConfig()
    local dependentFile = require("View.DailyCompetition.CompetitionDependentFile")
    local info = dependentFile:GetDenpendentInfo()
    return info
end


function CompetitionModel:HasDoubleRankBuff(data)
    if data.gameProps and #data.gameProps>0 then
        for i = 1, #data.gameProps do
            if data.gameProps[i] == RESOURCE_TYPE.RESOURCE_TYPE_DOUBLE_COMPETITION_REWARD then
                return true
            end
        end
    end
    return false
end


function CompetitionModel:HasDoubleCollectRankBuff(data)
    if data.gameProps and #data.gameProps>0 then
        for i = 1, #data.gameProps do
            if data.gameProps[i] == RESOURCE_TYPE.RESOURCE_TYPE_DOUBLE_COMPETITION then
                return true
            end
        end
    end
    return false
end

function CompetitionModel:ResetSelfInfo()
    local uid = ModelList.PlayerInfoModel:GetUid()
    if activity_list and activity_list.showRankList then
        for i = 1, #activity_list.showRankList do
            if activity_list.showRankList[i].uid == uid then
                local buffTime = self:GetDoubleRewardBuffTime()
                if buffTime > 0 and not self:HasDoubleRankBuff(activity_list.showRankList[i])  then
                    table.insert(activity_list.showRankList[i].gameProps,RESOURCE_TYPE.RESOURCE_TYPE_DOUBLE_COMPETITION_REWARD)
                end
                local buffTime = self:GetDoubleCollectBuffTime()
                if buffTime > 0 and not self:HasDoubleCollectRankBuff(activity_list.showRankList[i])  then
                    table.insert(activity_list.showRankList[i].gameProps,RESOURCE_TYPE.RESOURCE_TYPE_DOUBLE_COMPETITION)
                end
            end
        end
    end
end


function CompetitionModel:OnLevelChange()
    --- 符合开放等级，查询一次饼干活动
    if ModelList.PlayerInfoModel:GetLevel() == Csv.GetLevelOpenByType(24,0) then
        this.ReqCompetitionRankInfo()
    end
end


--------------------------------杯赛调整后----2023年11月21日--------------------------------------------------

---请求杯赛列表
function CompetitionModel.ReqCompetitionOptions()
    this.SendMessage(MSG_ID.MSG_COMPETITION_OPTIONS, {})
end

--登录请求杯赛列表
function CompetitionModel.Login_ReqCompetitionOptions()
    return MSG_ID.MSG_COMPETITION_OPTIONS,Base64.encode(Proto.encode(MSG_ID.MSG_COMPETITION_OPTIONS,{}))
    --this.SendMessage(MSG_ID.MSG_COMPETITION_OPTIONS, {})
end

---选择开启的杯赛类型
function CompetitionModel.ReqCompetitionChoose(chooseID)
    chooseID = chooseID or COMPETITION_TYPE.COMPETITION_CUP
    this.SendMessage(MSG_ID.MSG_COMPETITION_CHOOSE, {
        chooseId = chooseID
    })
end

---杯赛列表
function CompetitionModel.ResCompetitionOptions(code, data)
    if code == RET.RET_SUCCESS then
        this.playerChooseId = data and data.chooseId or 0 --依靠这个id去判断活动状态 0 无选择弹出活动选择，1 ，2 选择杯赛或者开车

        this.chooseOptions = data and data.options or {}
        
        --附带其它-推送协议
        table.each(data and data.nextMessages, function(v)
            local body = Base64.decode(v.msgBase64)
            local ret = Proto.decode(v.msgId, body)
            Message.DispatchMessage(v.msgId, v.code, ret)
        end)

        --赛车结束了，后端数据不会删除，要前端自己删除
        if this.playerChooseId ~= COMPETITION_TYPE.COMPETITION_RACING then
            ModelList.GiftPackModel:RemoveQuestPack()
        end
    end
end

---开启杯赛
function CompetitionModel.ResCompetitionChoose(code, data)
    if code == RET.RET_SUCCESS then
        this.playerChooseId = data and data.chooseId or 0
        --附带其它-推送协议
        table.each(data and data.nextMessages, function(v)
            local body = Base64.decode(v.msgBase64)
            local ret = Proto.decode(v.msgId, body)
            ret.noResponeNotify = true
            Message.DispatchMessage(v.msgId, v.code, ret)
        end)
        Event.Brocast(EventName.Event_competition_show_popup)
        Facade.SendNotification(NotifyName.CarQuest.ChoiceActiveResult)

        --赛车结束了，后端数据不会删除，要前端自己删除
        if this.playerChooseId ~= COMPETITION_TYPE.COMPETITION_RACING then
            ModelList.GiftPackModel:RemoveQuestPack()
        end
    else
        ModelList.CompetitionModel.ReqCompetitionOptions()
        Event.Brocast(EventName.Event_competition_show_popup)
        Facade.SendNotification(NotifyName.CarQuest.ChoiceActiveResult)
    end
end

----------------------------------------------------------------------------------------


function CompetitionModel.GetResetTime()
    return (activity_list and activity_list.resetTime) or 0
end



this.MsgIdList =
{
    --杯赛活动选择
    {msgid = MSG_ID.MSG_COMPETITION_OPTIONS, func = this.ResCompetitionOptions},
    {msgid = MSG_ID.MSG_COMPETITION_CHOOSE, func = this.ResCompetitionChoose},
    
    --cup类型杯赛
    {msgid = MsgIDDefine.PB_CookieFetch, func = this.ResCupNotify},
    --{msgid = MSG_ID.MSG_COMPETITION_CUP_FETCH,func = this.ResCupFetch},
    {msgid = MsgIDDefine.PB_CookieRoundReward,func = this.ResCupRoundReward},
    {msgid = MSG_ID.MSG_COMPETITION_CUP_RANK_REWARD,func = this.ResCupRankReward}
}

return this
