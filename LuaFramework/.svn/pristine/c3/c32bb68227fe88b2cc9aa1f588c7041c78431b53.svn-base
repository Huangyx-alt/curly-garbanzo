---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/7/8 16:52
---


local TaskTipItemView = BaseView:New("TaskTipItemView")
local this = TaskTipItemView
this.viewType = CanvasSortingOrderManager.LayerType.None

--local _taskToggle = nil

this.auto_bind_ui_items = {
    "Slider",
    "num",
    "icon",
    "anim",
    "describe"
}

function TaskTipItemView:New()
    local o = {}
    self.__index = self
    setmetatable(o,self)
    return o
end

function TaskTipItemView:Awake()
    self:on_init()
end

function TaskTipItemView:OnEnable()
    --self._isinit = true
    self:SetTaskData(self._taskData,self._showOld)
end

function TaskTipItemView:OnDisable()
    --self._isinit = nil
end

function TaskTipItemView:GetTransform()
    if self.go and fun.is_not_null(self.go) then
        return self.go.transform
    end
    return nil
end

function TaskTipItemView:GetTaskData()
    return self._taskData
end

function TaskTipItemView:SetTaskData(data,showOld)
    if data then
        self._showOld = showOld
        self._taskData = data
        --_taskToggle = taskType
        --if self._isinit then
            assert(data.city ~= nil,"data.city异常")
            local task = Csv.GetData("task",data.taskId)
            assert(task ~= nil,"task is nil task id = " .. data.taskId)
            local res_icon = Csv.GetData("resources",data.reward[1].id,"icon")
            Cache.SetImageSprite("ItemAtlas",res_icon,self.icon)

            local city_name = nil
            if data.city > 0 then
                local city = Csv.GetData("city",data.city,"name_description")
                assert(city ~= nil,"city is nil")
                city_name = Csv.GetData("description",city,"description")
                assert(city_name ~= nil,"city_name is nil")
            end
            
            local des = Csv.GetData("description",task.description)
            assert(des ~= nil,"des is nil")
            local oldProcess = data.oldProcess
            if oldProcess == "" then
                oldProcess = "0"
            end
        if fun.is_null(self.Slider) or fun.is_null(self.num)  then
            return
        end
        if showOld then
            self.Slider.value = tonumber(oldProcess) / tonumber(data.target)
            self.num.text = string.format("%s/%s", oldProcess, data.target)
        elseif data.target == data.process then
            self.Slider.value = 1
            self.num.text = "100%"
        else
            self.Slider.value = tonumber(data.process) / tonumber(data.target)
            self.num.text = string.format("%s/%s", data.process, data.target)
        end
        self.describe.text = string.format(des.description,data.target,city_name)
    end
end
local function ResetSlider()
    self.Slider.value = 0
end

function TaskTipItemView:PlayFillEffect(old,curr,max)
    --log.r(curr.."    "..target)
    local oldSlider = tonumber(old)
    local currSlider = tonumber(curr)
    local targetSlider = tonumber(max)
    if fun.is_null(self.Slider)  then
        return
    end
    
    self.num.text = string.format("%s/%s", old, max)
    local startV, endV = oldSlider / targetSlider, currSlider / targetSlider
    self.Slider.value = startV
    Anim.do_smooth_float_update(startV, endV, 0.5, function(v)
        self.Slider.value = v
    end, function()
        self.Slider.value = endV
        self.num.text = string.format("%s/%s", curr, max)
    end)

    if curr ~= max then
        self.anim:Play("jindu")
    else
        self.anim:Play("TaskViewtipfull")
    end
end

function TaskTipItemView:ReqGetRewards()

end

function TaskTipItemView:PlayFullEffect()
    self.anim:Play("TaskViewtipfull")
    --ResetSlider()
    self.Slider.value = 1
    LuaTimer:SetDelayFunction(0.3,function()
        self.Slider.value = 0
        local startPos = fun.get_gameobject_pos(self.icon)
        local itemId = self._taskData.reward[1].id
        Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts, startPos, itemId, function()
            Event.Brocast(EventName.Event_currency_change)
        end)
    end,nil,LuaTimer.TimerType.UI)
end

return this