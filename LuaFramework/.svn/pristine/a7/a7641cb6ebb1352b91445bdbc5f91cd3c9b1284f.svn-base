---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/10/19 17:36
---
local GiftPackBaseView = require("View.GiftPack.GiftPackBaseView")
local GiftPackFourView = GiftPackBaseView:New('GiftPackFourView', "GiftPackAtlas")
local this = GiftPackFourView
this.viewType = CanvasSortingOrderManager.LayerType.TopConsole
this.second_atlas_name = "GiftPackAtlas"
local data = nil
local click_interval = 0.5

this.auto_bind_ui_items = {
    "btn_close",
    "left_time_txt",
    "btn_buy",
    "text_time",
    "text_coin",
    "reward_type_icon1",
    "reward_type_icon2",
    "GiftPackFourView",
    "price",
    "BonusOrMore",
    "reward_type_icon3",
    "text_diamond",
    "oriPrice",
    "vipexp"
}

function GiftPackFourView:Awake()
    this:on_init()
    self._isInit = true
    --- 修复部分机型首次进入界面不显示问题
    if self._reshowAfterInit then
        self._reshowAfterInit = nil
        self:ShowDetailGift()
    end
end

function GiftPackFourView.OnEnable()
    Facade.RegisterView(this)
    --this.update_x_enabled = true
    --this:start_x_update()
    this:BuildFsm(this)
    this:Bi_Tracker()
end

function GiftPackFourView:on_x_update()
end

function GiftPackFourView:ShowDetailGift()
    if self._isInit then
        data = ModelList.GiftPackModel:GetShowGiftPack()
        if data then
            this:SetProduct(data.pId,data.giftInfo)
            this:SetLeftTime(data.giftInfo[1].expireTime)
        else
            log.r("data  nil")
            if not ModelList.GiftPackModel then
                log.r("GiftPackModel  nil")
            end
        end
    else
        self._reshowAfterInit = true
    end
end

local SetBuyBtnDescripe = function( btnObj ,des)
    if #des >0 and des ~="0" then
        local content = fun.find_child(btnObj,"Image/des")
        local txt = fun.get_component(content,"Text")
        if txt then
            txt.text = "$".. des
        end
        fun.set_active(content.transform.parent,true)
    else
        local content = fun.find_child(btnObj,"Image")
        fun.set_active(content,false)
    end
end

function GiftPackFourView:SetProduct(pId,giftInfo)
    local xls = nil
    for _, v in pairs(Csv.pop_up) do
        if v.gift_id == pId then
            for i = 1, #giftInfo do
                if giftInfo[i].id == _ then
                    xls = v
                    break
                end
            end
        end
    end

    this:SetIcon(xls.item_description[1][1], self.reward_type_icon1, self.text_coin, xls.item_description[1][2])
    this:SetIcon(xls.item_description[2][1], self.reward_type_icon2, self.text_time, xls.item_description[2][2])
    this:SetIcon(xls.item_description[3][1], self.reward_type_icon3, self.text_diamond, xls.item_description[3][2])

    this:SetPrice(xls.price, xls.original_price)
    this:SetBounsAndMore(xls.bonus, xls.more)
    if #xls.item_description > 3 then
        this:SetVipExp(xls.item_description[4][2])
    else
        fun.set_active(self.vipexp.transform.parent.gameObject, false)
    end
    SetBuyBtnDescripe(self.btn_buy,xls.limit_description)

    local data = ModelList.GiftPackModel:GetGiftById(xls.id)
    if not data or data.canBuyCount <= 0 then
        this:CloseUIShiny(self.btn_buy)
        Util.SetUIImageGray(self.btn_buy, true)
    elseif(this:OpenUIShiny(self.btn_buy)) then
        Util.SetUIImageGray(self.btn_buy, false)
    end
end


function GiftPackFourView:SetIcon(item1, reward_type_icon1 ,text_coin , item_description)
    if tonumber(item1) == 3 then
        reward_type_icon1.sprite = AtlasManager:GetSpriteByName("GiftPackAtlas", "lZoom")
    elseif tonumber(item1) == 2 then
            reward_type_icon1.sprite = AtlasManager:GetSpriteByName("GiftPackAtlas", "lcoins")
    elseif  tonumber(item1) == 1 then
        reward_type_icon1.sprite = AtlasManager:GetSpriteByName("GiftPackAtlas", "lGem")
    else
        --local icon1 = Csv.GetData("resources", tonumber(item1), 'icon')
        local icon1 = Csv.GetItemOrResource( tonumber(item1),"icon")
        reward_type_icon1.sprite = AtlasManager:GetSpriteByName("ItemAtlas", icon1)
    end
    this:SetContent(item1, text_coin, item_description)
end


function GiftPackFourView:SetLeftTime(endTimeStamp)
    local start_time = ModelList.PlayerInfoModel.get_cur_server_time()
    this.endTime = endTimeStamp - start_time
    if this.loopTime  then
        LuaTimer:Remove(this.loopTime)
        this.loopTime = nil
    end
    this.loopTime = LuaTimer:SetDelayLoopFunction(0, 1, -1, function()
        if self.left_time_txt then
            self.left_time_txt.text = fun.SecondToStrFormat(this.endTime)
            this.endTime = this.endTime - 1
            if this.endTime  <= 0 then
                this.on_btn_close_click()
                Event.Brocast(EventName.Event_Gift_Update)
            end
        end
    end,nil,nil,LuaTimer.TimerType.UI)
end

function GiftPackFourView:SetPrice(price, original_price)
    self.price.text = "$" .. price
    self.oriPrice.text = "$" .. original_price
end

function GiftPackFourView:SetVipExp(exp)
    self.vipexp.text = fun.formatNum(exp)
end

function GiftPackFourView:SetBounsAndMore(bonus, more)
    if this.bonusAndMore == nil then
        this.bonusAndMore = require("View/GiftPack/GiftPackBonusAndMore")
    end
    this.bonusAndMore:SetData(self.BonusOrMore, bonus, more)
end

function GiftPackFourView:SetContent(id, txt, content)
    id = tonumber(id)
    if id == 3 then
        --放大镜，不需要数字加逗号
        txt.text = content
    else
        --local des =
        txt.text = fun.formatNum(content)
    end
end


function GiftPackFourView.OnDisable()
    --Facade.RemoveView(this)
    this:stop_x_update()
    --Event.Brocast(Notes.CARD_COLLIDER_OPEN, true)
end

function GiftPackFourView.OnDestroy()
    this:Destroy()
end

function GiftPackFourView:on_close()
    this:stop_x_update()
    --Event.Brocast(Notes.CARD_COLLIDER_OPEN, true)
end

function GiftPackFourView:CloseFunc()
    --this.main_effect:Play("end")
    Facade.SendNotification(NotifyName.HideDialog, this)

end

function GiftPackFourView:ShowTip(tipName)

end

function GiftPackFourView:InitTip()

end

function GiftPackFourView:CutDonwTarget()
    this:CloseFunc()
    this.main_effect:Play("end")
end

function GiftPackFourView:on_btn_sure_click()
    if this.sure_cb then
        this.sure_cb()
    end
    Facade.SendNotification(NotifyName.HideDialog, this)
    GameObject.Destroy(self.go)
    last_click_time = UnityEngine.Time.time
    --end
end

function GiftPackFourView:on_btn_cancle_click()
    if this.cancel_cb then
        this.cancel_cb()
    end
    Facade.SendNotification(NotifyName.HideDialog, this)
    GameObject.Destroy(self.go)
    last_click_time = UnityEngine.Time.time
    --end
end

function GiftPackFourView:on_btn_close_click()
    if this._fsm:GetCurName() == "GiftPackShowState" then return end
    if this.loopTime then
        LuaTimer:Remove(this.loopTime)
        this.loopTime = nil
    end
    Facade.SendNotification(NotifyName.CloseUI, ViewList.GiftPackFourView)
    --fun.set_active(self.go,false)
    --GameObject.Destroy(self.go)
    ModelList.GiftPackModel:CloseView()

end

this.last_click_time1 = 0
function GiftPackFourView:on_btn_buy_click()
    if this._fsm:GetCurName() ~= "GiftPackEnterState" then return end
    local click_time = UnityEngine.Time.time
    if click_time - this.last_click_time1 > click_interval then
        this.last_click_time1 = UnityEngine.Time.time
        ModelList.GiftPackModel:ReqEditorBuySucess(data.pId, data.giftInfo[1].id)
    end
end


function  GiftPackFourView:OnBuySuccess(needClose,itemData)
    this:ChangeState(this,"GiftPackShowState",itemData)
end

function  GiftPackFourView:GetGiftPos(id)
    return this.reward_type_icon1.transform.position, this.reward_type_icon2.transform.position,
    this.reward_type_icon3.transform.position, this.vipexp.transform.position
end

return this

