---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/7/6 15:08
---


local DailyRewardInfoBaseState = require "State/DailyReward/DailyRewardInfoBaseState"
local DailyRewardInfoOriginalState = require "State/DailyReward/DailyRewardInfoOriginalState"
local DailyRewardInfoEnterState = require "State/DailyReward/DailyRewardInfoEnterState"
local DailyRewardInfoExitState = require "State/DailyReward/DailyRewardInfoExitState"
local DailyRewardRewardState = require "State/DailyReward/DailyRewardRewardState"
local DailyRewardWatchVideoState = require "State/DailyReward/DailyRewardWatchVideoState"

local DailyRewardView = BaseView:New("DailyRewardView", "DailyRewardAtlas")
local this = DailyRewardView
this.viewType = CanvasSortingOrderManager.LayerType.TopConsole
this.isCleanRes = true

local click_num = nil

this.auto_bind_ui_items = {
    "btn_claim",
    "btn_watchVideo",
    "icon_coin",
    "icon_coin2",
    "text_curBonus",
    "text_nextBonus",
    "text_emetald",
    "text_viplevel",
    "text_extra_gold",
    "text_extra_diamon",
    "anima",
    "img_vip_cion",
    "icon_watch",
    "icon_gems",
    "text_gems",
    "text_append",
    "video_effect",
    "text_video",
    "text_diamond",
    "next_text_diamond",
    "text_vipExp",
    "img_vip_null_tip",
    "icon_reward2",
    "icon_reward3",
    "icon_reward4",
    "next_text_vipExp",
    "next_icon_exp",
    "btn_claimSingle",
    "imageTrophy",
    "textTrophy",
}

function DailyRewardView:OpenView(callback)
    Facade.SendNotification(NotifyName.ShowUI, this, function()
        if callback then
            callback()
        end
    end)
end

function DailyRewardView:CloseView(callback)
    Facade.SendNotification(NotifyName.CloseUI, this)
end

function DailyRewardView:Awake(obj)
    self:on_init()
end

function DailyRewardView:OnEnable()
    Facade.RegisterView(self)
    self:UpDataInfo()
    self:BuildFsm()
    self._fsm:GetCurState():PlayEnter(self._fsm)
    SDK.ADShow(AD_EVENTS.AD_EVENTS_HALL_DAILY)
    UISound.play("common_popup")
end

function DailyRewardView:PlayEnter()
    self:ShowEnterAnim()
    self:ShowTournament()
    --AnimatorPlayHelper.Play(this.anima,"DailyRewardViewenter",false,function()
    --    self._fsm:GetCurState():FinishEnter(self._fsm)
    --    Event.AddListener(EventName.Event_UpdateItems,self.OnCityInfoChange,self)
    --end)
    --Event.AddListener(EventName.Event_UpdateItems,self.OnCityInfoChange,self)

    --原来就有
    -- self._fsm:GetCurState():FinishEnter(self._fsm)
end

--function DailyRewardView:OnCityInfoChange()
--    self:UpDataInfo()
--end

function DailyRewardView:IsAbleWatchAd()
    self:SetEventType()
    local ad_num = ModelList.AdModel.GetAdCount(AD_EVENTS.AD_EVENTS_HALL_DAILY) --ModelList.ItemModel:get_rocketCount()
    local ad_ready = SDK.IsRewardedAdReady()
    --log.r("============================>>DailyRewardView:IsAbleWatchAd " .. ad_num .. "  " .. tostring(ad_ready))
    if ad_num > 0 and ad_ready then
        return true
    end
    return false
end

function DailyRewardView:GetDailyReward(id)
    if id ~= nil then
        if not this.daily_reward then
            this.daily_reward = ModelList.FixedActivityModel:GetDailyRewardType()
        end
        if not this.daily_reward then
            this.daily_reward = 1
        end
        if this.daily_reward and this.daily_reward == 2 then
            return Csv.GetData("level", id, "pay_daily_reward")
        else
            return Csv.GetData("level", id, "daily_reward")
        end
    end
end

function DailyRewardView:UpDataInfo()
    local information = ModelList.PlayerInfoModel:GetUserInfo()
    local avatar = "xxl_head04"
    if not string.is_empty(information.avatar) then
        --avatar =  Csv.GetData("robot_name",tonumber(information.avatar),'icon')
    end
    local daily_reward = self:GetDailyReward(information.level)
    -- self.text_curBonus.text = (fun.formatNum(daily_reward[2][2]))
    self.text_curBonus:SetValue(daily_reward[2][2])
    self.text_diamond.text = fun.formatNum(daily_reward[1][2])
    self.text_vipExp.text = fun.formatNum(daily_reward[3][2])
    local daily_reward_next = self:GetDailyReward(information.level + 1) or daily_reward
    self.text_nextBonus.text = fun.formatNum(daily_reward_next[2][2])
    self.next_text_diamond.text = fun.formatNum(daily_reward_next[1][2])
    self.next_text_vipExp.text = fun.formatNum(daily_reward_next[3][2])

    local rewatdIcon = Csv.GetItemOrResource(daily_reward[1][1], "icon")
    Cache.SetImageSprite("ItemAtlas", rewatdIcon, self.icon_reward2)

    rewatdIcon = Csv.GetItemOrResource(daily_reward[3][1], "icon")
    Cache.SetImageSprite("ItemAtlas", rewatdIcon, self.icon_reward3)

    rewatdIcon = Csv.GetItemOrResource(daily_reward_next[1][1], "icon")
    Cache.SetImageSprite("ItemAtlas", rewatdIcon, self.icon_reward4)

    rewatdIcon = Csv.GetItemOrResource(daily_reward_next[3][1], "icon")
    Cache.SetImageSprite("ItemAtlas", rewatdIcon, self.next_icon_exp)

    local vip = Csv.GetData("vip", information.vip)

    if not vip then
        vip = 1
        log.r("error vip   =>>" .. tostring(information.vip))
    end

    Cache.SetImageSprite("VipAtlas", vip.icon, self.img_vip_cion)
    self.text_viplevel.text = Csv.GetDescription(tonumber(vip.name))
    self.text_extra_gold.text = string.format("+%s%s", (vip.daily_reward), "%")

    if information.vip == 0 then
        fun.set_active(this.img_vip_null_tip, true)
        fun.set_active(this.text_extra_gold, false)
    else
        fun.set_active(this.img_vip_null_tip, false)
        fun.set_active(this.text_extra_gold, true)
    end

    local isBigR = ModelList.regularlyAwardModel:CheckUserTypes()
    local LevelNoAd = self:CheckNoAd()
    if isBigR or LevelNoAd then
        fun.set_active(self.btn_watchVideo.transform, false, false)
        local pos = fun.get_gameobject_pos(this.btn_claim, true)
        fun.set_transform_pos(this.btn_claim.transform, 0, pos.y, pos.z, true)
        fun.set_active(self.btn_claim, false)
        fun.set_active(self.btn_claimSingle, true)
    else
        local cost = Csv.GetData("advertise", 9, "text")
        self.text_append.text = cost -- string.format("%s<size=32>%s</size>",cost_info[1][1],"%")
        fun.set_active(this.icon_gems, true)
        self.text_video.text = cost  -- string.format("%s%s",cost_info[1][1],"%")
        if not this:IsAbleWatchAd() then
            this:SetNoAds()
        end
    end
end

function DailyRewardView:SetNoAds()
    fun.set_active(self.btn_claim, true)
    fun.set_active(self.btn_claimSingle, false)

    local bg1 = fun.find_child(this.btn_watchVideo, "lButtonPurple")
    local img = fun.get_component(bg1, fun.IMAGE)
    Cache.SetImageSprite("CommonAtlas", "lButtonPurpleH", img)
    --todo 生成代码枚举无法识别 by LwangZg
    img.type = UnityEngine.UI.Image.Type.Sliced
    local bg2 = fun.find_child(this.btn_watchVideo, "icon_watch_font")
    local img = fun.get_component(bg2, fun.IMAGE)
    img.enabled = false
    --fun.set_active(bg2, false)

    local bg3 = fun.find_child(this.btn_watchVideo, "icon_watch_font/icon_watch")
    local img3 = fun.get_component(bg3, fun.IMAGE)
    fun.set_img_color(img3, Color.New(0.47, 0.47, 0.47, 1))

    local bg3 = fun.find_child(this.btn_watchVideo, "icon_watch_font/text_video")
    fun.set_active(bg3, false)

    local img3 = fun.find_child(this.btn_watchVideo, "icon_gems/icon_append")
    if img3 then
        fun.set_active(img3, false)
    end

    local img3 = fun.find_child(this.btn_watchVideo, "icon_gems/text_append")
    if img3 then
        fun.set_active(img3, false)
    end

    local img3 = fun.find_child(this.btn_watchVideo, "Noads")
    if img3 then
        fun.set_active(img3, true)
    end

    img3 = fun.find_child(this.btn_watchVideo, "root")
    if img3 then
        fun.set_active(img3, false)
    end
    if not self.loopCheckAd then
        self.loopCheckAd = LuaTimer:SetDelayLoopFunction(1, 0.5, 600, function()
            if this:IsAbleWatchAd() then
                LuaTimer:Remove(self.loopCheckAd)
                self.loopCheckAd = nil
            end
        end, function()
            if this:IsAbleWatchAd() then
                this:ShowAds()
            end
        end, nil, LuaTimer.TimerType.UI)
    end
end

--如果那个等级配了要有就增加相应得广告 -- true 没有广告，false 有广告
function DailyRewardView:CheckNoAd()
    local playerLevel = ModelList.PlayerInfoModel:GetLevel()
    local data        = Csv.GetData("level", playerLevel, "level_ad")
    for _, v in pairs(data) do
        if v[1] and v[1] == 1 then
            if v[2] and v[2] == 0 then
                return true
            else
                return false
            end
        end
    end

    return false
end

function DailyRewardView:ShowAds()
    if not this.btn_watchVideo then
        return
    end
    local bg1 = fun.find_child(this.btn_watchVideo, "lButtonPurple")
    local img = fun.get_component(bg1, fun.IMAGE)
    Cache.SetImageSprite("DailyRewardAtlas", "lButtonPurple", img)
    --todo 生成代码枚举无法识别 by LwangZg
    img.type = UnityEngine.UI.Image.Type.Sliced
    local bg2 = fun.find_child(this.btn_watchVideo, "icon_watch_font")
    local img = fun.get_component(bg2, fun.IMAGE)
    img.enabled = true
    local bg3 = fun.find_child(this.btn_watchVideo, "icon_watch_font/icon_watch")
    local img3 = fun.get_component(bg3, fun.IMAGE)
    fun.set_img_color(img3, Color.New(1, 1, 1, 1))
    local bg3 = fun.find_child(this.btn_watchVideo, "icon_watch_font/text_video")
    fun.set_active(bg3, true)
    local img3 = fun.find_child(this.btn_watchVideo, "icon_gems/icon_append")
    if img3 then
        fun.set_active(img3, true)
    end
    local img3 = fun.find_child(this.btn_watchVideo, "icon_gems/text_append")
    if img3 then
        fun.set_active(img3, true)
    end
    local img3 = fun.find_child(this.btn_watchVideo, "Noads")
    if img3 then
        fun.set_active(img3, false)
    end
    img3 = fun.find_child(this.btn_watchVideo, "root")
    if img3 then
        fun.set_active(img3, false)
    end
end

function DailyRewardView:BuildFsm()
    self:DisposeFsm()
    self._fsm = Fsm.CreateFsm("DailyRewardView", self, {
        DailyRewardInfoOriginalState:New(),
        DailyRewardInfoEnterState:New(),
        DailyRewardInfoExitState:New(),
        DailyRewardRewardState:New(),
        DailyRewardWatchVideoState:New()
    })
    self._fsm:StartFsm("DailyRewardInfoOriginalState")
end

function DailyRewardView:DisposeFsm()
    if self._fsm then
        self._fsm:Dispose()
        self._fsm = nil
    end
end

function DailyRewardView:OnDisable()
    Facade.RemoveView(self)
    self:RemoveAdEvent()
    click_num = nil
    self:DisposeFsm()
    if self.loopCheckAd then
        LuaTimer:Remove(self.loopCheckAd)
        self.loopCheckAd = nil
    end
    --Event.RemoveListener(EventName.Event_UpdateItems,self.OnCityInfoChange,self)
end

function DailyRewardView:on_close()

end

function DailyRewardView:OnDestroy()

end

function DailyRewardView:on_btn_close_click()
    self._fsm:GetCurState():GobackClick(self._fsm)
end

function DailyRewardView:GobackClick()
    AnimatorPlayHelper.Play(this.anima, "DailyRewardViewexit", false, function()
        self:CloseView()
        --Facade.SendNotification(NotifyName.SceneCity.HomeScene_promotion)
        Event.Brocast(EventName.Event_popup_daily_reward_finish)
    end)
end

function DailyRewardView:on_btn_watchVideo_click()
    SDK.ADClick(AD_EVENTS.AD_EVENTS_HALL_DAILY)
    local watch_video = function()
        --by LwangZg SDK相关 TODO
        -- if self:IsAbleWatchAd() and self._fsm then
        --     self._fsm:GetCurState():WatchVideo(self._fsm, 1)
        -- else
        --     --Ad has not prepared yet
        --     UIUtil.show_common_popup(9024, true)
        -- end
        UIUtil.show_common_popup(9024, true)
    end
    local isBigR = ModelList.regularlyAwardModel:CheckUserTypes()
    if not isBigR then
        watch_video()
    end
end

function DailyRewardView:WatchVideo()
    self:RegisterAdEvent()
    --by LwangZg SDK相关 TODO
    SDK.ShowRewardedAd("DailyReward", AD_EVENTS.AD_EVENTS_HALL_DAILY)
end

function DailyRewardView:RegisterAdEvent()
    Event.AddListener(Notes.RECEIVE_MAX_REWARD, self.AdCallBack, self)
    Event.AddListener(Notes.RECEIVE_MAX_REWARD_ADMISS, self.AdMissCallBack, self)
end

function DailyRewardView:RemoveAdEvent()
    Event.RemoveListener(Notes.RECEIVE_MAX_REWARD, self.AdCallBack)
    Event.RemoveListener(Notes.RECEIVE_MAX_REWARD_ADMISS, self.AdMissCallBack)
end

function DailyRewardView:AdCallBack(adInfo)
    self:RemoveAdEvent()
    if adInfo then
        local ad_id = adInfo.AdUnitIdentifier
        local ad_sp = adInfo.CreativeIdentifier
        ModelList.AdModel:C2S_WathchAdResult(ad_id, ad_sp, ad_id, AD_EVENTS.AD_EVENTS_HALL_DAILY)
    end
end

function DailyRewardView:AdMissCallBack(adInfo)
    self._fsm:ChangeState("DailyRewardInfoOriginalState")
    --if adInfo then
    --    local ad_id = adInfo.AdUnitIdentifier
    --    local ad_sp = adInfo.CreativeIdentifier
    --    ModelList.AdModel:C2S_WathchAdResult(ad_id,ad_sp,ad_id,AD_EVENTS.AD_EVENTS_HALL_DAILY)
    --end
end

function DailyRewardView:SetEventType()
    --local ismature = ModelList.regularlyAwardModel:IsRegularlyAwardMature()
    local eventType = AD_EVENT.AD_EVENTS_HALL_DAILY
    --if ismature then
    --    eventType = AD_EVENT.AD_EVENTS_HALL_DAILY
    --end
    self.eventType = eventType
end

function DailyRewardView:on_btn_claim_click()
    --if ModelList.regularlyAwardModel:IsRegularlyAwardMature() then
    --self._fsm:GetCurState():ClaimRewar(self._fsm,1)
    --else
    --    --Gold coins can be collected after the countdown is over
    --    UIUtil.show_common_popup(7001, true)
    --end
    if self._fsm ~= nil then
        self._fsm:GetCurState():ClaimRewar(self._fsm, 1)
    end
end

function DailyRewardView:on_btn_claimSingle_click()
    --if ModelList.regularlyAwardModel:IsRegularlyAwardMature() then
    --self._fsm:GetCurState():ClaimRewar(self._fsm,1)
    --else
    --    --Gold coins can be collected after the countdown is over
    --    UIUtil.show_common_popup(7001, true)
    --end
    if self._fsm ~= nil then
        self._fsm:GetCurState():ClaimRewar(self._fsm, 1)
    end
end

function DailyRewardView:ClaimAwards()
    ModelList.PlayerInfoModel:ReqDailyReward(this.daily_reward or 1)
end

function DailyRewardView:ClaimMoreRwards()
    if SDK.IsRewardedAdReady() then
        SDK.ShowRewardedAd("DailyReward",AD_EVENTS.AD_EVENTS_HALL_DAILY)
    end
    --ModelList.regularlyAwardModel.C2S_GetMoreReward()
end

function DailyRewardView.OnDailyRewardRespone()
    if this._fsm ~= nil then
        this._fsm:GetCurState():CliamRewardRespone(this._fsm, true)
    end
end

function DailyRewardView.OnUpdataRegularlyAward()
    if this._fsm ~= nil then
        this._fsm:GetCurState():CliamRewardRespone(this._fsm, true)
    end
end

function DailyRewardView:OnClaimReward(params)
    local reward = ModelList.PlayerInfoModel:GetRewardItemId()
    local pos = nil
    if fun.get_active_self(this.btn_claim) then
        pos = this.btn_claim.transform.position
    else
        pos = this.btn_claimSingle.transform.position
    end
    if params == 2 then
        pos = this.btn_watchVideo.transform.position
    end
    for i = 1, #reward do
        if i == #reward then
            Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts, pos, reward[i].id, function()
                Event.Brocast(EventName.Event_currency_change)
            end, nil)
        else
            Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts, pos, reward[i].id, function()
            end, nil)
        end
    end
    --
    --Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts,pos,reward[1].id,function()
    --    --Event.Brocast(EventName.Event_currency_change)
    --end,nil)
    --Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts,pos,reward[2].id,function()
    --    Event.Brocast(EventName.Event_currency_change)
    --end,nil)
    this:GobackClick()
end

function DailyRewardView:ShowEnterAnim()
    local tiers, difficulty = ModelList.TournamentModel:GetTiers()
    local addCoinValue = ModelList.TournamentModel:GetTrophyAddCoinValue(tiers, difficulty)
    if addCoinValue > 0 then
        self:PlayBuffEnter(addCoinValue)
    else
        self:PlayNoBuffEnter()
    end
end

function DailyRewardView:PlayBuffEnter(addCoinValue)
    LuaTimer:SetDelayFunction(0.5, function()
        UISound.play("list_buff")
    end)
    LuaTimer:SetDelayFunction(1.2, function()
        self:ShowRollCoin(addCoinValue)
    end)
    AnimatorPlayHelper.Play(this.anima, "DailyRewardViewaddenter", false, function()
        self._fsm:GetCurState():FinishEnter(self._fsm)
    end)
end

function DailyRewardView:PlayNoBuffEnter()
    AnimatorPlayHelper.Play(this.anima, "DailyRewardViewenter", false, function()
        self._fsm:GetCurState():FinishEnter(self._fsm)
    end)
end

function DailyRewardView:ShowRollCoin(addCoinValue)
    if addCoinValue <= 0 then
        return
    end
    local information   = ModelList.PlayerInfoModel:GetUserInfo()
    local daily_reward  = self:GetDailyReward(information.level)
    local noAddCoinNum  = daily_reward[2][2]
    local rollCoinNum   = daily_reward[2][2] * (1 + addCoinValue * 0.01)

    local bigScaleValue = 1.2
    local bigScaleTime  = 0.2

    local animObj       = self.text_curBonus.gameObject
    Anim.scale_to_xy(animObj, bigScaleValue, bigScaleValue, bigScaleTime, nil)

    LuaTimer:SetDelayFunction(0.5, function()
        Anim.scale_to_xy(animObj, 1, 1, 0.2)
    end)

    self.text_curBonus:RollByTime(rollCoinNum, 0.7, nil)
end

function DailyRewardView:ShowTournament()
    local tiers, difficulty = ModelList.TournamentModel:GetTiers()
    local addCoinValue = ModelList.TournamentModel:GetTrophyAddCoinValue(tiers, difficulty)
    if addCoinValue > 0 then
        fun.set_active(self.imageTrophy, true)
        local trophyName = fun.GetCurrTournamentActivityImg(tiers)
        Cache.load_sprite(AssetList["trophyName"], trophyName, function(sprite)
            if sprite then
                this.imageTrophy.sprite = sprite
            end
        end)
        self.textTrophy.text = string.format("%s%s%s", "+", addCoinValue, "%")
    else
        fun.set_active(self.imageTrophy, false)
    end
end

this.NotifyList =
{
    { notifyName = NotifyName.DailyRewardView.DailyRewardespone, func = this.OnDailyRewardRespone }
}

return this
