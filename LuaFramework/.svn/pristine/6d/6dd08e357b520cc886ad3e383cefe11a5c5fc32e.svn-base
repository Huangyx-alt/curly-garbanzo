---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/9/7 17:32
---
local ItemModel = BaseModel:New("ItemModel")
local this = ItemModel

local itemList = {}
local resourceLit= {}

local itemTypeList = {}

local curMakeFoodCuisinesId = {}

local cityCuisinesInfo = {}
---
---登录返回物品列表
---
function ItemModel:SetLoginData(data)
       this:SetItemsInfo(data.itemInfo)
    this:SetResourceInfo(data.resourceInfo)
end

function ItemModel:SetItemsInfo(data)
    if data then
        --local itemData = deep_copy(data)
      
        if #data >0 then 
            if itemList == nil then
                itemList = {}
            end
            if itemTypeList == nil then
                itemList = {}
            end
          
        end 
        local changeTypeList = {}
        for key, value in pairs(data) do
            if value then
                local itemtype = Csv.GetData("item",value.id,"item_type")
                --assert(itemtype ~= nil, string.format("item表错误：没有的id %s", value.id)) 注释掉，因为有错误的id的话程序的执行就会被中断掉了
                if itemtype then
                    local oldValue = itemList[value.id]
                    if oldValue ~= value.value then
                        itemList[value.id] = value --都是更新总量过来，不是变化量
                        if changeTypeList[itemtype] == nil then
                            changeTypeList[itemtype] = {}
                        end
                        table.insert(changeTypeList[itemtype],value.id)
                    end
                    if itemTypeList[itemtype] == nil then
                        itemTypeList[itemtype] = {}
                    end

                    local isFresh = true 
                    for _,value2 in pairs( itemTypeList[itemtype]) do 
                        if value2.id == value.id then 
                            value2.value = value.value
                            isFresh = false
                        end   
                    end 

                    if isFresh == true then 
                        table.insert(itemTypeList[itemtype],value)
                    end 
                 
                end
            end
        end 

        self:SetCuisinesInfo()
        self:CalDisCoutInfo()

        for key, value in pairs(changeTypeList) do
            if value then
                Event.Brocast(EventName.Event_items_change,{items = value, type = key})
            end
        end
    end
end

---------------计算菜品收集信息-----------------
function ItemModel:SetCuisinesInfo()
    cityCuisinesInfo = {}
    for key, value in pairs(Csv.city) do
        cityCuisinesInfo[value.id] = {available = false,cuisines = {}}
        for key1, value1 in pairs(value.city_recipe) do
            local recipe = Csv.GetData("city_recipe",value1,"item")
            local count = 0
            local total = 0
            for key2, value2 in pairs(recipe) do
                total = total + 1
                local num = self:GetItemNumById(value2[1])
                if num >= value2[2] then
                    count = count + 1
                end
            end
            if count >= total then
                cityCuisinesInfo[value.id].available = true
                cityCuisinesInfo[value.id].cuisines[value1] = true
            end
        end
    end
    --[[
    for key, value in pairs(Csv.auto_city) do
        cityCuisinesInfo[PLAY_TYPE.PLAY_TYPE_AUTO_TICKET][value.id] = {available = false,cuisines = {}}
        for key1, value1 in pairs(value.city_recipe) do
            local recipe = Csv.GetData("city_recipe",value1,"item")
            local count = 0
            local total = 0
            for key2, value2 in pairs(recipe) do
                total = total + 1
                local num = self:GetItemNumById(value2[1])
                if num >= value2[2] then
                    count = count + 1
                end
            end
            if count >= total then
                cityCuisinesInfo[PLAY_TYPE.PLAY_TYPE_AUTO_TICKET][value.id].available = true
                cityCuisinesInfo[PLAY_TYPE.PLAY_TYPE_AUTO_TICKET][value.id].cuisines[value1] = true
            end
        end
    end
    --]]
end

--
function ItemModel:CalDisCoutInfo()
    --如果有任何折扣券的变动
    local tb = {ItemType.rocket_DisCount,ItemType.rofy,ItemType.coin_DisCoun,ItemType.pu_DisCount,ItemType.Tournament_DisCount}
    local flag = false 
    for _,v in pairs(tb) do 
        local TypeTb = ModelList.ItemModel:GetItemByType(v)
        if #TypeTb > 0 then 
            flag= true
            break;
        end 
    end 

    if flag  then 
        local bundle = {}
        bundle.componentName = "FunctionIconDiscountAllView"
        bundle.callback = function(iconView) 
      
        end
        Event.Brocast(EventName.Event_Add_Function_Icon, bundle)
    end 
end 

function ItemModel:IsCuisinesAvailable(city,cuisinesId,gameMode)
    --- 2024/3/8 17:00 屏蔽美食
    return false
    --if city == nil then
    --    city = ModelList.CityModel:GetCity()
    --end
    --local cityCuisines = cityCuisinesInfo[city]
    --if cuisinesId then
    --    return cityCuisines and cityCuisines.available and cityCuisines.cuisines[cuisinesId]
    --end
    --return cityCuisines and cityCuisines.available
end
---------------计算菜品收集信息-----------------end


function ItemModel:SetResourceInfo(data,raise)
    if data then
        local redourceData = deep_copy(data)
        if resourceLit == nil then
            resourceLit = {}
        end
        for key, value in pairs(redourceData) do
            if value then
                local oldValue = resourceLit[value.id]
                resourceLit[value.id] = value --都是更新总量过来，不是变化量
                if not oldValue  or ( oldValue and oldValue ~= value.value )then --这里条件有问题（永真了），但没引起表现上的问题，暂时不管
                    if raise and value.id == Resource.coin then
                        Event.Brocast(EventName.Event_coin_change)
                    elseif raise and value.id == Resource.diamon then
                        Event.Brocast(EventName.Event_diamond_change) 
                    elseif raise and value.id == Resource.cherry then
                        Event.Brocast(EventName.Event_cherry_change)
                    elseif raise and value.id == Resource.auto_tickets then
                        Event.Brocast(EventName.Event_autoTickets_change)
                    elseif raise and value.id == Resource.hintTime then
                        --log.r("=================================>>Event_hintTime_change " .. value.value .. " now: " .. os.time() .. " sub: " .. (value.value - os.time()))
                        Event.Brocast(EventName.Event_hintTime_change)
                    elseif raise and value.id == Resource.rocket then
                        Event.Brocast(EventName.Event_rocket_change)
                    elseif raise and value.id == Resource.double_hat then
                        Event.Brocast(EventName.Event_doublehat_change)   
                    elseif raise and value.id == Resource.doublehat_reward then
                        Event.Brocast(EventName.Event_doublehatreward_change)
                    elseif raise and value.id == Resource.double_competition then
                        Event.Brocast(EventName.Event_double_competition_change)
                    elseif raise and value.id == Resource.double_competition_reward then
                        Event.Brocast(EventName.Event_double_competition_reward_change)
                        Event.Brocast(EventName.Event_double_competition_reward_change2) 
                    elseif raise and value.id == RESOURCE_TYPE.RESOURCE_TYPE_RACING_CAR_MORE_OIL_BUFF then
                        Event.Brocast(EventName.Event_competition_quest_item_buff)
                    elseif raise and value.id == RESOURCE_TYPE.RESOURCE_TYPE_RACING_CAR_REWARD_BUFF then
                        Event.Brocast(EventName.Event_competition_quest_reward_buff)
                    elseif raise and value.id == Resource.season_card_star then
                        ModelList.SeasonCardModel:StarCountChange(oldValue and oldValue.value, value.value)  
                    elseif raise and value.id == RESOURCE_TYPE.RESOURCE_TYPE_VICTORY_BEATS_DOUBLE_NOTE_BUFF then
                        Event.Brocast(EventName.Event_WinZone_Item_Buff)
                    elseif raise and value.id == RESOURCE_TYPE.RESOURCE_VOLCANO_DOUBLE_BUFF then
                        Event.Brocast(EventName.Event_VolcanoMission_Item_Buff)
                    elseif raise and value.id == RESOURCE_TYPE.RESOURCE_VOLCANO_REWARD_BUFF then
                        Event.Brocast(EventName.Event_VolcanoMission_Reward_Buff)
                    elseif raise and value.id == Resource.musicalnote then
                        local bundle = {oldValue = oldValue, newValue = value}
                        Facade.SendNotification(NotifyName.ShopView.MusicNoteNumChange, bundle)
                    elseif value.id == Resource.puBuff then
                        ModelList.CityModel:SavePuBuffStateRecord(value.value)
                    end
                end
            end
        end

        if resourceLit[Resource.coin]  and resourceLit[Resource.coin] ==0 and resourceLit[Resource.diamon] and resourceLit[Resource.diamon] ==0 then
            SDK.send_error_log_to_server(string.format("coin and diamond is 0, now: %s  uid:%s", os.time(), ModelList.PlayerInfoModel:GetUid()))
        end
    end
end

function ItemModel.getResourceNumByType(resourceType)
    if resourceType and resourceLit[resourceType] then
        return tonumber(resourceLit[resourceType].value)
    end
    return 0
end

--获取钻石数量
function ItemModel.get_diamond()
    return this.getResourceNumByType(Resource.diamon)
end

--获取金币数量
function ItemModel.get_coin()
    return this.getResourceNumByType(Resource.coin)
end

--获取樱桃数量
function ItemModel.get_cherry()
    return this.getResourceNumByType(Resource.cherry)
end

--获取挂机玩法门票数量
function ItemModel.get_autoTickets()
    return this.getResourceNumByType(Resource.auto_tickets)
end

--获取玩家经验
function ItemModel.get_RoleExp()
    return this.getResourceNumByType(Resource.roleExp)
end

--获取放大镜
function ItemModel.get_hintTime()
    return math.max(0,this.getResourceNumByType(Resource.hintTime) - os.time())
end

--获取小火箭数量
function ItemModel.get_rocketCount()
    return this.getResourceNumByType(Resource.rocket)
end

--获取音符数量
function ItemModel.get_musicalnoteCount()
    return this.getResourceNumByType(Resource.musicalnote)
end

--minigame双倍帽子buff时间
function ItemModel.get_doublehat()
    return math.max(0,this.getResourceNumByType(Resource.double_hat) - os.time())
end

--minigame双倍奖励buff时间
function ItemModel.get_doublehatReward()
    return math.max(0,this.getResourceNumByType(Resource.doublehat_reward) - os.time())
end

--杯赛奖励buff时间
function ItemModel.get_competitionDoubleCollect()
    return math.max(0,this.getResourceNumByType(Resource.double_competition) - os.time())
end

--杯赛双倍奖励buff时间
function ItemModel.get_competitionDoubleReward()
    return math.max(0,this.getResourceNumByType(Resource.double_competition_reward) - os.time())
end

---
---获取背包物品数量
---
function ItemModel:GetItemNumById(id)
    if itemList and itemList[id] then
        return itemList[id].value
    end
    return 0
end

---
---获取某一类型的item列表
---
function ItemModel:GetItemByType(type)
    local itemList = {}
    if itemTypeList and itemTypeList[type] then
        for _, value in ipairs(itemTypeList[type]) do
            table.insert(itemList,value)
        end
    end
    return itemList
end

function ItemModel:SetMakeFoodCurrentCuisines(cuisinesId)
    curMakeFoodCuisinesId = cuisinesId
end

function ItemModel:GetMakeFoodCurrentCuisines()
    return curMakeFoodCuisinesId
end

function ItemModel.S2C_UpdateItems(code,data)
    if code == RET.RET_SUCCESS then
        if data then
            ModelList.SetDataUpdate(data,nil,"cityInfo")
            Event.Brocast(EventName.Event_UpdateItems)
        else
            log.r("S2C_UpdateItems数据为nil")
        end
    end
end

function ItemModel:SetDataUpdate(data,params)
    this:SetItemsInfo(data.itemInfo)
    this:SetResourceInfo(data.resourceInfo,true)
end

function ItemModel.C2S_ExchangeIngredient(itemId,type,city,playType)
    --Http.req_exchange_ingredient(itemId,type,city)
    this.SendMessage(MSG_ID.MSG_EXCHANGE,{itemId = itemId, type = type, city = city,playType = playType})
end

function ItemModel.S2C_ExchangeIngredient(code,data)
    --log.r("=============================================================>>S2C_ExchangeIngredient1 " .. code)
    Facade.SendNotification(NotifyName.FoodIngredientView.ExchangeSucceed,code)
    if code == RET.RET_SUCCESS and data then
        if data then
            --log.r("===============================================>>S2C_ExchangeIngredient2 " .. data.itemId)
            
        else
            log.r("S2C_ExchangeIngredient数据为nil")
        end
    elseif code == RET.RET_EXCHNAGE_CITY_RECIPE_NOT_IN then

    elseif code == RET.RET_EXCHNAGE_NOT_ENOUGH then

    elseif code == RET.RET_EXCHNAGE_CITY_RECIPE_NOT_CURRENT then

    elseif code == RET.RET_EXCHNAGE_CITY_RECIPE_OWNED then
        
    end
end


this.MsgIdList = {
    {msgid = MSG_ID.MSG_UPDATE_MATERIAL_NOTIFY, func = this.S2C_UpdateItems},
    {msgid = MSG_ID.MSG_EXCHANGE, func = this.S2C_ExchangeIngredient}
}

return this