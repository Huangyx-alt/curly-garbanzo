---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/8/17 17:58
---

HangUpSwitchView = BaseChildView:New();
local this = HangUpSwitchView;

this.parentView = nil
this.data = {}
this.switchItems = nil
this.can_switch = false

this.curr_show_card = {}
this.curr_showing_page = 1
this.cardCount = 0               --卡牌总数量

this.auto_bind_ui_items = {
    "Content",
    "CardMap",
    "btn_switch",
}

function HangUpSwitchView.Init(cardRef, dataRef, bingoView)
    this:on_init(cardRef)
    this.data = dataRef
    this.card = cardRef
    this.parentView = bingoView
    this:InitCardSwitch()
    this:InitShowingCard()
    this.RegisterEvent()
end


--初始化小型卡牌
function HangUpSwitchView:InitCardSwitch ()
    this.cardCount = #this.data.cardsInfo
    local ret = (this.cardCount > 8) and true or false
    this.can_switch = ret
    if ret then
        this:CreateCardSwitchItems(#this.data.cardsInfo)
    end
end

--初始化所有小型卡牌小界面
function HangUpSwitchView:CreateCardSwitchItems(count)
    local CardSwitchItem = require "View.Bingo.UIView.ChildView.CardSwitchItem"
    local item3 = CardSwitchItem:New(this.CardMap)
    this.switchItems = item3
    local PageFront ,PageBack = 0 ,1
    this.switchItems:InitMap(this.CardMap, PageFront)
    for i = 2, count do
        local clone = fun.get_instance(this.CardMap,this.CardMap.transform.parent)
        fun.set_gameobject_scale(clone,0.72,0.72)
        if i > 8 then
            this.switchItems:InitMap(clone, PageBack)
        else
            this.switchItems:InitMap(clone, PageFront)
        end
    end
end

function HangUpSwitchView:InitShowingCard()
    this.curr_showing_page = 1
end

function HangUpSwitchView:IsShowing(cardid)
    cardid = tonumber(cardid)
    return (this.curr_showing_page == 1 and cardid<=8) or  (this.curr_showing_page == 2 and cardid > 8)
end

function HangUpSwitchView:ChangePage()
    this.curr_showing_page = this.curr_showing_page + 1
    if this.curr_showing_page >= 3 then
        this.curr_showing_page = 1
    end
end

--切换卡牌
function HangUpSwitchView:SwitchCard()
    UISound.play("card_switch")
    this:CardMoveEffect()
    this.StopShowShine()
    this:ChangePage()
end

local RefreshEffectPosBindedCard = function()
    BattleEffectPool:FollowTargetObj()
    BattleEffectCache:FollowTargetObj()
end

function HangUpSwitchView:CardMoveEffect()
    local yChange = 100
    local changeTime = 0.1
    if this.curr_showing_page == 1 then
        local mapList1 = this.parentView:GetCardView():GetCardMapList(9,this.cardCount)
        for i = 1, #mapList1 do
            fun.set_active(mapList1[i], true)
        end
        local mapList2 = this.parentView:GetCardView():GetCardMapList(1,8)
        for i = 1, #mapList2 do
            fun.set_rect_local_pos_y(mapList2[i], 5000)
        end
        local mPos = this.parentView.map_pos_1.localPosition
        fun.set_rect_local_pos_y(this.parentView.BingoMap3, mPos.y - yChange)
        Anim.move_to_xy_local_ease(this.parentView.BingoMap3, mPos.x, mPos.y, changeTime)
        mPos = this.parentView.map_pos_2.localPosition
        fun.set_rect_local_pos_y(this.parentView.BingoMap4, mPos.y - yChange)
        Anim.move_to_xy_local_ease(this.parentView.BingoMap4, mPos.x, mPos.y, changeTime, function()
            RefreshEffectPosBindedCard()
        end)
        this:ChangePage()
        this:RefreshCardSwitchItems(1)
    else
        fun.set_active(this.parentView.BingoMap1, true)
        fun.set_active(this.parentView.BingoMap2, true)
        fun.set_rect_local_pos_y(this.parentView.BingoMap3, 5000)
        fun.set_rect_local_pos_y(this.parentView.BingoMap4, 5000)
        local mPos = this.parentView.map_pos_1.localPosition
        fun.set_rect_local_pos_y(this.parentView.BingoMap1, mPos.y + yChange)
        Anim.move_to_xy_local_ease(this.parentView.BingoMap1, mPos.x, mPos.y, changeTime)
        mPos = this.parentView.map_pos_2.localPosition
        fun.set_rect_local_pos_y(this.parentView.BingoMap2, mPos.y + yChange)
        Anim.move_to_xy_local_ease(this.parentView.BingoMap2, mPos.x, mPos.y, changeTime, function()
            RefreshEffectPosBindedCard()
        end)
        this:ChangePage()
        this:RefreshCardSwitchItems(9)
    end

    local anima = fun.get_component(this.card, fun.ANIMATOR)
    anima:Play("click")
end




function HangUpSwitchView:RefreshCardSwitchItems(startIndex)
    if not this.can_switch then
        return
    end
    local roundata = ModelList.BattleModel:GetCurrModel():GetRoundData()
    local LoadData = ModelList.BattleModel:GetCurrModel():LoadGameData()
    local itemIndex = 0

    for i = startIndex, startIndex + 1 do
        local mIndex = tostring(LoadData.cardsInfo[i].cardId)
        local newCard = {}
        if roundata[mIndex] then
            for j = 1, #roundata[mIndex].cards do
                if roundata[mIndex].cards[j].sign > 0 then
                    local temp = { sign = roundata[mIndex].cards[j].sign, index = j, self_bingo = roundata[mIndex].cards[j].self_bingo }
                    table.insert(newCard, temp)
                end
            end
        end
        if itemIndex == 0 then
            this.switchItems:Refresh(newCard)
        else
            this.switchItems:Refresh2(newCard)
        end
        newCard = nil
        itemIndex = itemIndex + 1
    end
end

function HangUpSwitchView:RefreshCurrSwitch()
    if this.curr_showing_page == 1 then
        this:RefreshCardSwitchItems(1)
    else
        this:RefreshCardSwitchItems(9)
    end
end


-- 结算面板 Card SUmmary 信息
function HangUpSwitchView:CreatSummaryItem()
    local roundata = ModelList.BattleModel:GetCurrModel():GetRoundData()

    if roundata then
        self.cardsItems = {}
        for k, v in pairs(roundata) do
            local reapData = { isBingo = v.isBingo, isJackpot = v.isJackpot, cards = {} }
            for j = 1, #v.cards do
                if v.cards[j].sign and v.cards[j].sign > 0 then
                    table.insert(reapData.cards, v.cards[j])
                end
            end
            local go = fun.get_instance(this.single_card_clone, self.Content)
            fun.set_active(go, true, 0)
            CardsSummaryItems:New(go, reapData)
        end
    end
end

function HangUpSwitchView:IsShowFront()
    return this.curr_showing_page == 1
end

function HangUpSwitchView.OnDisable()
    this.parentView = nil
    this.data = {}
    this.card = nil

    if this.switchItems then
        this.switchItems.OnDispose()
    end
    this.switchItems = nil
    this.UnRegisterEvent()
    this:Close()
end

function HangUpSwitchView.OnDestroy()
    this.curr_show_card = {}
    this.curr_showing_page = 1
end

function HangUpSwitchView.ShowShine()
    this.delay_shine = LuaTimer:SetDelayFunction(MCT.switch_btn_delay_shine_time, function()
        local anim = fun.get_component(this.card, fun.ANIMATOR)
        if anim then
            anim:Play("shine")
        end
        LuaTimer:Remove(this.delay_shine)
        this.delay_shine = nil
    end)
end

function HangUpSwitchView.StopShowShine()
    if this.delay_shine then
        LuaTimer:Remove(this.delay_shine)
        this.delay_shine = nil
    end
    local anim = fun.get_component(this.card, fun.ANIMATOR)
    anim:Play("idle")
end

function HangUpSwitchView.RegisterEvent()
    Event.AddListener(EventName.Event_Switch_Btn_Shine_Effect, this.ShowShine)
    Event.AddListener(EventName.Switch_View_Refresh, this.RefreshCurrSwitch)
end

function HangUpSwitchView.UnRegisterEvent()
    Event.RemoveListener(EventName.Event_Switch_Btn_Shine_Effect, this.ShowShine)
    Event.RemoveListener(EventName.Switch_View_Refresh, this.RefreshCurrSwitch)
end

return this