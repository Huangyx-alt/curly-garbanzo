---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/2/3 12:08
---  评价引导界面


local EvaluateAward = require "State/EvaluateUsView/EvaluateAward"
local EvaluateEnter =require "State/EvaluateUsView/EvaluateEnter"
local EvaluateExit =require "State/EvaluateUsView/EvaluateExit"
local EvaluateRate =require "State/EvaluateUsView/EvaluateRate"
local EvaluateSuggest =require "State/EvaluateUsView/EvaluateSuggest"

local CollectRewardsEvaluateUsView = require("View.CollectRewardsView.CollectRewardsEvaluateUsView")

local EvaluateUsView = BaseView:New("EvaluateUsView","EvaluateUsAtlas")
local this = EvaluateUsView
this.viewType = CanvasSortingOrderManager.LayerType.Machine_Dialog
this.isCleanRes = true

this.auto_bind_ui_items = {
    "Main",
    "Suggests",
    "Awards",
    "btn_star1",
    "btn_star2",
    "btn_star3",
    "btn_star4",
    "btn_star5",
    "btn_submit",
    "btn_maybe",
    "btn_suggest",
    "btn_suggest_close",
    "btn_collect_award",
    "Reward_item",
    "StarEffect",
    "lButtonGreen",
    "SuggestlButtonGreen",
    "InputField",
    "main_text",
    "MaybeText",
    "suggestContent",
    "suggestTitle",
    "awardTxt"
}


function EvaluateUsView:Awake(obj)
    self:on_init()
end

local currSelectStar = nil
local suggestBtnGray = nil

function EvaluateUsView:OnEnable()
    FsmCreator:Create("EvaluateUsView",self,{
        EvaluateAward:New(),
        EvaluateEnter:New(),
        EvaluateExit:New(),
        EvaluateRate:New(),
        EvaluateSuggest:New()
    })
    self._fsm:StartFsm("EvaluateEnter")
    this:RegisterUIEvent()
    this:SetContent()
end

function EvaluateUsView:SetContent()
    if this.main_text then
        this.main_text.text = Csv.GetDescription(979)
    end
    if this.MaybeText then
        this.MaybeText.text = Csv.GetDescription(980)
    end
    if this.suggestTitle then
        this.suggestTitle.text = Csv.GetDescription(981)
    end
    if this.suggestContent then
        this.suggestContent.text = Csv.GetDescription(983)
    end
    if this.awardTxt then
        this.awardTxt.text = Csv.GetDescription(982)
    end
end

function EvaluateUsView:OpenMainView()
    this:OpenView(1)
    currSelectStar = nil
    Util.SetImageColorGray(this.lButtonGreen, true)
end
function EvaluateUsView:OpenSuggestView()
    this:OpenView(2)
    this.update_x_enabled = true
    suggestBtnGray = true
    this:start_x_update()
    Util.SetImageColorGray(this.SuggestlButtonGreen, true)
end

function EvaluateUsView:OpenAwardView()
    this:OpenView(3)
    local rewards = Csv.GetControlByName("score_guide_reward")
    CollectRewardsEvaluateUsView:SetRewards(rewards)
    CollectRewardsEvaluateUsView:set_close(this.close_reward)
    Facade.SendNotification(NotifyName.SkipLoadShowUI,CollectRewardsEvaluateUsView,this.Awards)

end

function EvaluateUsView:LeaveSuggestView()
    log.r("LeaveSuggestView")
    this.update_x_enabled = false
    this:stop_x_update()
end

function    EvaluateUsView:on_x_update()
    if this.InputField and this.InputField.text then
        if #this.InputField.text > 0 and suggestBtnGray  then
            suggestBtnGray = false
            Util.SetImageColorGray(this.SuggestlButtonGreen, false)
        elseif  #this.InputField.text == 0 and not suggestBtnGray then
            suggestBtnGray = true
            Util.SetImageColorGray(this.SuggestlButtonGreen, true)
        end
    end
end



function EvaluateUsView:OpenView(viewType)
    fun.set_active(this.Main,viewType==1 or false)
    fun.set_active(this.Suggests,viewType == 2 or false)
    fun.set_active(this.Awards,viewType ==3 or false)
end


local function HideStar()
    if  fun.get_active_self(this.StarEffect) then
        Util.SetImageColorGray(this.lButtonGreen, false)
    end
    fun.set_active(this.StarEffect,false)
end

local function LightStar( )
    for i = 1, 5 do
        local img = fun.get_component(this["btn_star"..i],fun.IMAGE)
        if img then
            fun.set_alpha(img,currSelectStar >= i and 1 or 0)
            fun.set_active(fun.get_child(this["btn_star"..i],0),currSelectStar >= i and true or false)
        end
    end
end

function EvaluateUsView:select_star()
    HideStar()
    LightStar( )
    self._fsm:ChangeState("EvaluateRate")
end

function EvaluateUsView:on_btn_star1_click()
    currSelectStar = 1
    this:select_star()
end
function EvaluateUsView:on_btn_star2_click()
    currSelectStar = 2
    this:select_star()
end
function EvaluateUsView:on_btn_star3_click()
    currSelectStar = 3
    this:select_star()
end
function EvaluateUsView:on_btn_star4_click()
    currSelectStar = 4
    this:select_star()
end
function EvaluateUsView:on_btn_star5_click()
    currSelectStar = 5
    this:select_star()
end

function EvaluateUsView:on_btn_submit_click()
    if currSelectStar then
        if currSelectStar <= 3 then
            self._fsm:ChangeState("EvaluateSuggest")
        else
            ModelList.PlayerInfoModel.ReqSubmitScore(currSelectStar,"")
            local data = ModelList.PlayerInfoModel:GetShowScore()
            fun.OpenURL(data.packageUrl)
            this:close_ui()
        end
    end
end
function EvaluateUsView:on_btn_maybe_click()
    this:close_ui()
    ModelList.PlayerInfoModel.ResetShowScore()
end
function EvaluateUsView:on_btn_suggest_click()
    if currSelectStar and this.InputField.text and #this.InputField.text >0 then
        ModelList.PlayerInfoModel.ReqSubmitScore(currSelectStar,this.InputField.text)
    end
end
function EvaluateUsView:on_btn_suggest_close_click()
    this:close_ui()
    ModelList.PlayerInfoModel.ResetShowScore()
end
function EvaluateUsView:on_btn_collect_award_click()
end

function EvaluateUsView:close_ui()
    Facade.SendNotification(NotifyName.CloseUI, this)
    Event.Brocast(EventName.Event_popup_EvaluateUs_finish)
end

function EvaluateUsView:close_reward()
    CollectRewardsEvaluateUsView:CloseView(this.close_ui)

end

function EvaluateUsView:RegisterUIEvent()
    Event.AddListener(EventName.Event_EvaluateUs_Award,this.OpenAwardView)
end

function EvaluateUsView:UnRegisterUIEvent()
    Event.RemoveListener(EventName.Event_EvaluateUs_Award,this.OpenAwardView)
end

function EvaluateUsView:OnDestroy()
    this:UnRegisterUIEvent()
end

return this












