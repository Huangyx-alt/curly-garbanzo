---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/9 15:09
---  夏威夷玩法

require 'Model/ModelPart/BaseGameModel'

--- 普通玩法 Model
---@class ChristmasGameModel : BaseGameModel
local ChristmasGameModel = BaseGameModel:New()
local this = ChristmasGameModel
this.rocketSettleData = nil

function ChristmasGameModel:InitData()
    self:SetSelfGameType(PLAY_TYPE.PLAY_TYPE_CHRISTMAS)
end

function ChristmasGameModel:GetQuestItemOffsetPos()
    return 27, -21
end

--请求进入游戏   ratio_str = “2,3” :卡片数量,倍率
function ChristmasGameModel:ReqEnterGame( )
    if not this:CheckCityIsOpen() then
        return
    end
    
    ModelList.BattleModel:DirectSetGameType(PLAY_TYPE.PLAY_TYPE_CHRISTMAS,6)
    ModelList.CityModel.SetPlayId(6)
    this:SetReadyState(0)
    Facade.SendNotification(NotifyName.ShowUI, ViewList.SceneLoadingGameView,nil,nil,ProcedureChristmasGame:New())
    local cardNum = ModelList.CityModel:GetCardNumber()
    local betRate = ModelList.CityModel:GetBetRate()
    local powerupGear,powerupId = ModelList.CityModel:GetPowerupGear()
    local city = ModelList.CityModel:GetCity()
    local coupon = ModelList.CouponModel.get_currentCouponIdByCardNum(cardNum)
    local useId = ModelList.CouponModel.get_currentCouponUseIdByCardNum(cardNum)
    ModelList.CityModel:SavePreviousPlayInfo()
    this:ResetSettleCode()
     local hideCardAuto = ModelList.BattleModel.GetIsAutoSign() and 1 or 0
    this.SendMessage(MSG_ID.MSG_GAME_LOAD_CHRISTMAS, {cardNum = cardNum,rate = betRate,powerUpId = tonumber(powerupId),
                                                     cityId = city,couponId = coupon,useCouponId = useId,playId = ModelList.CityModel.GetPlayIdByCity(city),
                                                      hideCardAuto=hideCardAuto});

    --- 以下是测试代码
    --   ModelList.CityModel.C2S_ChangeCity(2)
    --   local city = ModelList.CityModel:GetCity()
    --   local limit = Csv.GetData("city",city,"openlevel")
    --   if ModelList.PlayerInfoModel:GetLevel() < limit then
    --       UIUtil.show_common_error_popup(8023,true,nil)
    --       return
    --   end
    --
    --   ModelList.BattleModel:DirectSetGameType(PLAY_TYPE.PLAY_TYPE_COCKTAIL,5)
    --   ModelList.CityModel.SetPlayId(5)
    --   this:SetReadyState(0)
    --   Facade.SendNotification(NotifyName.ShowUI, ViewList.SceneLoadingGameView)
    --   local cardNum = ModelList.CityModel:GetCardNumber()
    --   local betRate = ModelList.CityModel:GetBetRate()
    --   local powerupGear,powerupId = ModelList.CityModel:GetPowerupGear()
    --   local city = ModelList.CityModel:GetCity()
    --   local coupon = ModelList.CouponModel.get_currentCouponIdByCardNum(cardNum)
    --   local useId = ModelList.CouponModel.get_currentCouponUseIdByCardNum(cardNum)
    --   ModelList.CityModel:SavePreviousPlayInfo()
    --   this:ResetSettleCode()
    --   local hideCardAuto = ModelList.BattleModel.GetIsAutoSign() and 1 or 0
    --   this.SendMessage(MSG_ID.MSG_GAME_LOAD_COCKTAIL, {cardNum = 4,rate = betRate,powerUpId = tonumber(powerupId),
    --                                                    cityId = city,couponId = coupon,useCouponId = useId,playId = ModelList.CityModel.GetPlayIdByCity(city),hideCardAuto=hideCardAuto});
end

--请求卡片签章
function ChristmasGameModel:ReqSignCard(info)
    local cardIds = {}
    for i = 1, #info.total do
        if this:RefreshRoundDataByIndex(info.total[i].cardId, info.total[i].index, 1) then
            if not fun.is_include(info.total[i].cardId,cardIds) then
                table.insert(cardIds,info.total[i].cardId)
            end
            this:CalcuateBingo(info.total[i].cardId,info.total[i].index,info.total[i].number)
        end
    end
    for i = 1, #cardIds do
        --this:CalcuateBingo(cardIds[i])
    end
end


--@param mark  --盖章方式 0=叫号 powerUpId=powerUp盖章的powerUpId  9=小火箭
function ChristmasGameModel:RefreshRoundDataByIndex(cardid, cellIndex, signType, need_fly_item, mark)
    --父类处理
    self.__index:RefreshRoundDataByIndex(cardid, cellIndex, signType, need_fly_item, mark)
    --如果有jackpot,要禁止卡牌盖章和pu使用
    --Event.Brocast(EventName.)
end

--收到进入游戏返回，允许进入Game场景
function ChristmasGameModel.ResEnterGame(code,data)
    if(code == RET.RET_SUCCESS)then
        this:SaveGameLoadData(data)
        this:SetReadyState(1)
        this:InitRoundData()
        this:InitExtraData(data.ext)
        ModelList.BattleModel.SetBattleDouble(data.activityStatus)
        ModelList.BattleModel:BackupLoadData(data)
        this:SetGameState(GameState.Ready)
        Event.Brocast(EventName.Recorder_Data,5001,data)
    else
        log.r("发送进入游戏失败"..code)
        Event.Brocast(EventName.Event_Cancel_Loading_Game)
        UIUtil.return_to_scenehome()
        UIUtil.show_common_global_popup(8004,true)
    end
end


--后端Bingo同步
function ChristmasGameModel:ResBingoInfo(code,data)
    if(code == RET.RET_SUCCESS)then
        this:SaveBingoLeftInfo(data)
        if this.onlySaveBingoInfo then return end
        this:RefreshBingoInfo()
        Facade.SendNotification(NotifyName.Bingo.Sync_Bingos)
        if data.bingoLeft <= 10 then
            UISound.set_bgm_volume(0.7)
        end
        if data.bingoLeft <= 0 and this:GetReadyState() == 1 then
            this:SetReadyState(2)
            LuaTimer:SetDelayFunction(MCT.delay_to_show_settle ,function()
                this.loop_delay_settle = LuaTimer:SetDelayLoopFunction(0.1,0.1,100,function()
                    --if this:IsGameSettling() then
                    this:ShowSettle()
                    LuaTimer:Remove(this.loop_delay_settle)
                    --end
                end,nil, nil,LuaTimer.TimerType.Battle)
            end)
        end
    else
        log.w("同步Bingo错误")
    end
end



function ChristmasGameModel:Clear()
    this.rocketSettleData = nil
    this.__index:Clear()
end

function ChristmasGameModel:OnReceiveSettle()
    if self:GetGameState() < GameState.ShowSettle then
        self:ShowSettle()
    end
end

this.MsgIdList =
{
    { msgid = MSG_ID.MSG_GAME_LOAD_CHRISTMAS, func = this.ResEnterGame },
}

return this