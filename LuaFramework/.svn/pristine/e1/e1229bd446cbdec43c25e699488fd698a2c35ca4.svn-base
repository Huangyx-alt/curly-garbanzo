---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 26/11/2024 下午 3:10
---


local BoxAllExitState = Clazz(BaseFsmState, "BoxAllExitState")
local this = BoxAllExitState

function BoxAllExitState:New()
    local o = {}
    setmetatable(o, { __index = BoxAllExitState })
    return o
end

function BoxAllExitState:InitState()
end

function BoxAllExitState:OnEnter(fsm, previous)
    log.EditorLog(tostring(fsm:GetOwner():GetCardId()) .. " enterstate  " .. "BoxAllExitState:OnEnter")
    self._fsm = fsm
    self._owner = fsm:GetOwner()
    local newData = self._owner:GetNewBingoData()
    if newData and newData.data.width then
        log.r("newData ", newData.data.firstCellIndex, newData.data.width, newData.data.height)
    end
    local oldData = self._owner:GetOldBingoData()
    if oldData and oldData.data and oldData.data.width then
        log.r("oldData ", oldData.data.firstCellIndex, oldData.data.width, oldData.data.height)
    end
    ---构成新礼物的盒子同时播退场
    local oldCells = self:GetCellIndex(oldData)
    local newCells = self:GetCellIndex(newData)
    local addCells = {}
    -- 将数字表中的所有值转换为字符串并连接在一起
    local result = table.concat(oldCells, ", ")
    log.r("oldCells ", result)
    local result = table.concat(newCells, ", ")
    log.r("newCells ", result)
    local includeCount = 0
    for i = 1, #newCells do
        if not fun.is_include(newCells[i], oldCells) then
            table.insert(addCells, newCells[i])
        else
            includeCount = includeCount + 1
        end
    end
    self._owner:CellsPlayExitAnima(addCells)

    ---旧礼物同时播退场
    self._owner:PlayOldGiftPlayExitEffect()

    --- 外框逐渐消失


    --local isChristmasMan = false
    ----- 如果是重合的格子,额外增加一套大的圣诞老人表现
    --if includeCount > 0 and oldData and includeCount == #oldCells then
    --    self._owner:ShowExtraChristmasManEffect(oldData.data)
    --    ---新增的格子，同时播放小圣诞老人表现
    --    for i = 1, #oldCells do
    --        fun.remove_table_item(newCells, oldCells[i])
    --    end
    --    self._owner:ShowExtraSmallChristmasManEffect(newCells, newData.data.cardId)
    --    isChristmasMan = true
    --end
    --if isChristmasMan then
    --    LuaTimer:SetDelayFunction(2, function ()
    --        if self._owner then
    --            self._owner:ChangeState("CheckChangeState")
    --        end
    --    end)
    --else
    --    self._owner:ChangeState("CheckChangeState")
    --end

    self._owner:ChangeState("CheckChangeState")

    --self._owner:ChangeState("CheckChangeState")
    --LuaTimer:SetDelayFunction(2, function ()
    --    self._owner:ChangeState("CheckChangeState")
    --end)
end

---通过数据获取格子索引
---@data : ChristmasSynthesisData
function BoxAllExitState:GetCellIndex(data)
    local cells = {}
    if data and data.data then
        for i = 0, data.data.width - 1 do
            for j = 0, data.data.height - 1 do
                table.insert(cells, data.data.firstCellIndex + j * 5 + i)
            end
        end
    end
    return cells
end

function BoxAllExitState:Finish()

end

function BoxAllExitState:OnLeave(fsm)
    self._fsm = nil
    self._owner = nil
    self._posX = nil
end

function BoxAllExitState:Dispose()
    self:OnLeave(nil)
end

return this
