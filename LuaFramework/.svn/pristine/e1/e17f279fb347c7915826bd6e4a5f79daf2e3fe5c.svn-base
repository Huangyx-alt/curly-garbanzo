---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/6/19 11:02
---


---- 小丑区域入场效果

local BaseCardJokerEffect  =  require("View.Bingo.EffectModule.CardJoker.BaseCardJokerEffect")

local JokerAreaEnterEffect = BaseCardJokerEffect:New()
local this = JokerAreaEnterEffect
local private = {}

function JokerAreaEnterEffect:New()
    local o = { isLoaded = false, changeSceneClear = true,objTable = {}}
    self.__index = self
    setmetatable(o, self)
    return o
end

---基类继承
function JokerAreaEnterEffect:SetInfo(info, parentObj, parentRef)
    self.data = info
    self._parentRef = parentRef
    local obj = parentRef:GetPreloadPrefab("clowndaoju_JokerBonuses")
    if obj then
        fun.set_parent(obj, parentObj, true)
        table.insert(self.objTable, obj)
        for i = 2, #self.data.cardPowerUpEffect do
            local obj2 = self:GetLoadedResource("clowndaoju_JokerBonuses",parentRef,"clowndaoju_JokerBonuses")
            if not obj2 then
                obj2 = fun.get_instance(obj)
            end
            if obj2 then
                fun.set_parent(obj2, parentObj, true)
                table.insert(self.objTable, obj2)
            end
        end
    else
        Cache.load_prefabs(AssetList["clowndaoju_JokerBonuses"], "clowndaoju_JokerBonuses", function(prefab)
            if prefab then
                for i = 1, #self.data.cardPowerUpEffect do
                    local obj = fun.get_instance(prefab)
                    if obj then
                        fun.set_parent(obj, parentObj, true)
                        table.insert(self.objTable, obj)
                    end
                end
            end
        end)
    end
end

--- 播放小丑区域入场效果
function JokerAreaEnterEffect:Play()
    if self.objTable and #self.objTable > 0 then
        for i = 1, #self.objTable do
            fun.set_active(self.objTable[i],true)
        end
    end
    LuaTimer:SetDelayFunction(1,function ()
        self:Fly()
    end)
end

function JokerAreaEnterEffect:Fly()
    if self.objTable and #self.objTable > 0 then
        for m = 1, #self.objTable do
            local firstPos = self.data.cardPowerUpEffect[m].posList[1]
            local clientPos = ConvertServerPos(firstPos)
            for i = 1, #self.data.cardPowerUpEffect[m].posList do
                local localPos = ConvertServerPos(self.data.cardPowerUpEffect[m].posList[i])
                self:SetCellChange(self.data.cardPowerUpEffect[m].cardId,localPos,2,self.data.cardPowerUpEffect[m].posList)
            end
            local targetCell = self:GetJokerCellObj(self.data.cardPowerUpEffect[m].cardId, clientPos)
            if targetCell then
                fun.set_parent(self.objTable[m],targetCell.transform)
                Anim.move(self.objTable[m],0,0,0,1,true,1,function ()
                    self:CellChangeToJokerSkin(m)
                    self:PlayEffect(targetCell)
                    Destroy(self.objTable[m])
                end)
            end
        end
    end
end

function JokerAreaEnterEffect:PlayEffect(targetCell)
    local obj = self:GetLoadedResource("clowndaoju_getJokerBonuses",self._parentRef,"clowndaoju_getJokerBonuses")
    if obj and targetCell then
        fun.set_parent(obj,targetCell.transform,true)
        Destroy(obj,2)
    end
    --Cache.load_prefabs(AssetList["clowndaoju_getJokerBonuses"],"clowndaoju_getJokerBonuses",function (prefab)
    --    if prefab then
    --        local obj = fun.get_instance(prefab)
    --        if obj and targetCell then
    --            fun.set_parent(obj,targetCell.transform,true)
    --            Destroy(obj,2)
    --        end
    --    end
    --end)
end

function JokerAreaEnterEffect:CellChangeToJokerSkin(index)
    --[[
        @desc: WIN ZONE里小丑区域的格子，把特殊的彩色格子去掉
        author:nuts
        time: 2024-05-31 12:13
        @return:
    ]]
    local playType = ModelList.BattleModel:GetGameType()
    if playType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
        return
    end

    local atlas, sprite = private.GetJokerBgName()
    local spriteRes = AtlasManager:GetSpriteByName(atlas, sprite)
    for i = 1, #self.data.cardPowerUpEffect[index].posList do
        local clientPos = ConvertServerPos(self.data.cardPowerUpEffect[index].posList[i]    )
        local JokerBg = self:GetJokerCellObj(self.data.cardPowerUpEffect[index].cardId, clientPos,"JokerBg")
        if JokerBg then
            if JokerBg then
                --JokerBg.sprite = AtlasManager:GetSpriteByName(atlas, sprite)
                JokerBg.sprite = spriteRes
                --JokerBg:SetNativeSize()
                fun.set_active(JokerBg.gameObject,true)
            end
        end

        --特殊情况，普通玩法中间的默认盖章有小丑区域，则需要替换一下章
        if clientPos == 13 and (ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_NORMAL
          or ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET )then
            local effect = BattleModuleList.GetModule("EffectEntry"):GetCellChip(self.data.cardPowerUpEffect[index].cardId,clientPos,nil)
            if effect then
                BattleModuleList.GetModule("EffectEntry"):SetBingoJokerSkin(effect,self.data.cardPowerUpEffect[index].cardId,clientPos)
            end
        end
    end
    self:PlayOver()
end

function JokerAreaEnterEffect:PlayOver()
    log.r("JokerBallSprayerEnterEffect:PlayOver")
end

---预加载依赖的资源
function JokerAreaEnterEffect:PreloadDependResource(callBack,callback2,index,data)
    this:CoroutineLoadResource(function()
        --coroutine.wait(index)
        Cache.load_prefabs(AssetList["clowndaoju_JokerBonuses"], "clowndaoju_JokerBonuses", function(prefab)
            if prefab then
                if data and data.cardPowerUpEffect then
                    for i = 1, #data.cardPowerUpEffect do
                        local instance = fun.get_instance(prefab)
                        fun.set_active(instance,false)
                        if callback2 then
                            callback2(instance,"clowndaoju_JokerBonuses")
                        end
                        --WaitForEndOfFrame()
                    end
                end
                log.r("instance clowndaoju_JokerBonuses")
            end
        end)
        --coroutine.wait(0.5)
        --WaitForFixedUpdate()
        Cache.load_prefabs(AssetList["clowndaoju_getJokerBonuses"], "clowndaoju_getJokerBonuses", function(prefab)
            if prefab then
                if data and data.cardPowerUpEffect then
                    for i = 1, #data.cardPowerUpEffect do
                        local instance = fun.get_instance(prefab)
                        fun.set_active(instance,false)
                        if callback2 then
                            callback2(instance,"clowndaoju_getJokerBonuses")
                        end
                        --coroutine.wait(0.2)
                        --WaitForEndOfFrame()
                    end
                end
                --local instance = fun.get_instance(prefab)
                log.r("instance clowndaoju_getJokerBonuses")
                --if callback2 then
                --    callback2(instance,"clowndaoju_getJokerBonuses")
                --end
            end
        end)
        if callBack then
            callBack()
        end
    end)

end


-----------------私有方法----------------------------------------------

function private.GetJokerBgName()
    local playId = ModelList.BattleModel:GetGameCityPlayID()
    local cfg = Csv.GetData("new_game_cell", playId)
    if cfg.joker_bg_un_signed ~= "0" then
        return cfg.atlas_name, cfg.joker_bg_un_signed
    else
        return "JokerBattleAtlas", "bcardRainbow"
    end
end

return this