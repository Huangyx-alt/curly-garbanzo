---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2024/12/18 16:32
---

local IdleState = Clazz(BaseFsmState, "IdleState")
local this = IdleState

function IdleState:New()
    local o = {}
    setmetatable(o, { __index = IdleState })
    return o
end

function IdleState:IdleState()
end

function IdleState:OnEnter(fsm, previous)
    log.r("IdleState:OnEnter")
    self._fsm = fsm
    self._owner = fsm:GetOwner()
    self:IdleSpinAnima()
end

function IdleState:IdleSpinAnima()
    self.orderList = {}
    table.each(Csv["moneymansion_show"], function (v, k)
        if fun.is_include(0, v.win_range) then
            table.insert(self.orderList, k)
        end
    end)
    self:PlaySpinIdleEffect()
end

function IdleState:PlaySpinIdleEffect()
    self.openLoop = true
    self.loopCoroutine = coroutine.start(function ()
        for i = 1, 1000 do
            local randomIndex = math.random(1, #self.orderList)
            local playOrderData = Csv.GetData("moneymansion_show", randomIndex)
            local progress1 = playOrderData.progress_1_list
            local progress1Data = playOrderData.progress_1
            for i = 1, #progress1 do
                for j = 1, #progress1[i] do
                    if self._owner then
                        self._owner:PlayCellActEffect(progress1[i][j], true)
                        --log.r("IdleState:PlaySpinIdleEffect", progress1[i][j])
                    end
                end
                if not self.openLoop then coroutine.yield() end
                coroutine.wait(progress1Data[2] * 0.001)
            end
            --阶段二的表现
            local progress2 = playOrderData.progress_2_list
            local progress2Data = playOrderData.progress_2
            for i = 1, #progress2 do
                for j = 1, #progress2[i] do
                    if self._owner then
                        self._owner:PlayCellActEffect(progress2[i][j], true)
                        --log.r("IdleState:PlaySpinIdleEffect", progress2[i][j])
                    else
                        break
                    end
                end
                if not self.openLoop then coroutine.yield() end
                coroutine.wait(progress2Data[2] * 0.001)
            end
            --阶段三的表现
            local progress3 = playOrderData.progress_3_list
            local progress3Data = playOrderData.progress_3
            for i = 1, #progress3 do
                for j = 1, #progress3[i] do
                    if self._owner then
                        self._owner:PlayCellActEffect(progress3[i][j], true)
                        --log.r("IdleState:PlaySpinIdleEffect", progress3[i][j])
                    end
                end
                if not self.openLoop then coroutine.yield() end
                coroutine.wait(progress3Data[2] * 0.001)
            end
        end
    end)
end

function IdleState:OnSpin()
    if self._owner:CheckSpinCost() then
        self._fsm:ChangeState("SpinState")
    end
end

function IdleState:OnReceiveSpin()
    if self.loopCoroutine then
        --coroutine.stop(self.loopCoroutine)
        StopCoroutine(self.loopCoroutine)
        self.loopCoroutine = nil
        self.openLoop = false
    end
    self._owner:PlaySpinIdelEffect()
    self._fsm:ChangeState("ShowSpinState")
end

function IdleState:OnChangeBet(changeType)
    self._owner:ChangeBet(changeType)
    --self._fsm:ChangeState("ChangeBetState")
end

function IdleState:OnStopIdle()
    if self.loopCoroutine then
        --coroutine.stop(self.loopCoroutine)
        StopCoroutine(self.loopCoroutine)
        self.loopCoroutine = nil
        self.openLoop = false
    end
end

function IdleState:OnResumeIdle()
    self:PlaySpinIdleEffect()
end

function IdleState:OnLeave(fsm)
    self._fsm = nil
    self._owner = nil
    self.openLoop = false
end

function IdleState:Dispose()
    self:OnLeave(nil)
end

return this
