---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/2/9 10:32
---

local BaseBingoEffect = require("View.Bingo.EffectModule.Card.BingoEffect.BaseBingoEffect")

local SingleWolfBingoEffect = BaseBingoEffect:New("SingleWolfBingoEffect")
local this = SingleWolfBingoEffect
setmetatable(SingleWolfBingoEffect,BaseBingoEffect)
local private = {}
this.loop_delay_checks = {}

function SingleWolfBingoEffect:ShowBingoOrJackpot(bingoData)
    for k, v in pairs(bingoData) do
        local mIndex = k
        local bingoType, currType = private.GetBingoCount(mIndex,v.bingo)
        local bingoCount = v.bingo
        local wolfPos = v.data.wolfPos
        if bingoCount > 0 and bingoCount < 4 then
            Event.Brocast(EventName.Box_Bingo_Coins, v.bingo)
            this:BingoEffect(mIndex, "bingo", v.first_num, mIndex, bingoType, currType, wolfPos)
        end
        if v.jackpot ~= 0 then
            private.StartSkillEmptyCheck(mIndex, function()
                this.cardView:OnShowJackpot()
                Event.Brocast(EventName.Box_Bingo_Coins, 0)
                BattleLogic.GetLogicModule(LogicName.Card_logic):ReduceRocketBingo()
                this:JackpotEffect(mIndex, "jackpot", v.first_num, mIndex)
            end)
        end
    end
end

---@see  显示Bingo 特效
function SingleWolfBingoEffect:BingoEffect(mapindex, anima_name, cellIndex, cardid, bingoType,currType, wolfPos)
    local par = this.cardView:GetCardMap(mapindex)
    local bingoCount = #bingoType
    BattleEffectCache:GetPrefabFromCache("SingleWolfBingo"..bingoCount, par, function(eff1)
        if eff1 then
            --UISound.play("bingo_firework")
            private.PlayBingoAudio(bingoCount)
            
            fun.set_active(eff1,false)
            fun.set_parent(eff1,par,false)
            if ModelList.BattleModel:IsRocket() then
                fun.set_gameobject_scale(eff1,1,1,1)
            end
            fun.set_rect_anchored_position(eff1, 0, 0)
            eff1.gameObject:SetActive(true)
            
            local cell_obj_pos = this.cardView:GetCardCell(mapindex,13)
            LuaTimer:SetDelayFunction(1.5,function()
                if cell_obj_pos then
                    if ModelList.TournamentModel:CheckOpenTournament() then
                        this:GetCardView():GetParentView():ShowIconFlyEffect(mapindex, cell_obj_pos.transform.position)
                    else
                        this:GetCardView():GetParentView():ShowCoinFlyEffect(mapindex, cell_obj_pos.transform.position)
                    end
                end
            end)
            
            LuaTimer:SetDelayFunction(2.3, function()
                private.PutSignOnSell(eff1, cardid, wolfPos)
            end)
        else
            log.r("wolf_bingo  null")
        end
        self:ShowEffectOnSmallCard(eff1, mapindex,0)
    end, cardid, 1)
end

---@see  显示Jackpot 特效
function SingleWolfBingoEffect:JackpotEffect(mapindex,anima_name,cellIndex, cardid)
    ModelList.BattleModel:GetCurrBattleView():GetCardView():GetCard(cardid):ForbidCollider()

    local par = this.cardView:GetCardMap(mapindex)
    local bingoType,currType = private.GetBingoCount(mapindex,4)
    if #bingoType == 0 then return end
    BattleEffectCache:GetPrefabFromCache("SingleWolfJackpot", par,function(eff1)
        if eff1 then
            private.PlayBingoAudio(4)
            
            eff1.gameObject.name = "SingleWolfJackpot"
            eff1.gameObject:SetActive(false)
            fun.set_parent(eff1, par,true)
            fun.set_rect_anchored_position(eff1,0,0)
            eff1.gameObject:SetActive(true)
            
            local cell_obj_pos = this.cardView:GetCardCell(mapindex,13)
            if cell_obj_pos then
                if ModelList.TournamentModel:CheckOpenTournament() then
                    this:GetCardView():GetParentView():ShowIconFlyEffect(mapindex, cell_obj_pos.transform.position)
                else
                    this:GetCardView():GetParentView():ShowCoinFlyEffect(mapindex, cell_obj_pos.transform.position)
                end
            end
        else
            log.r("wolf_jackpot  null")
        end
        Event.Brocast(EventName.Event_SwitchCard_JackpotEffect,mapindex)
        self:ShowEffectOnSmallCard(eff1, mapindex, 2)
    end, cardid, 2)
end

--- 在卡牌缩略图上显示bingo  jackpot效果
function SingleWolfBingoEffect:ShowEffectOnSmallCard(clone,cardId,effectType)
    if ModelList.BattleModel:IsRocket() then return end
    local isShowing = BattleLogic.GetLogicModule(LogicName.SwitchLogic):IsShowing(cardId)
    local obj =  self.cardView:GetParentView():GetSwitchView():GetSmallCardObj(cardId)
    local newEffect = fun.get_instance(clone,obj)
    fun.set_parent(newEffect,obj,true)
    fun.set_gameobject_scale(newEffect,0.2,0.2,1)
    if isShowing then fun.set_active(newEffect,false) end
    if effectType == 0 then
        Event.Brocast(EventName.Event_Show_SwitchView_Small_Card_Bingo,cardId,newEffect)
        LuaTimer:SetDelayFunction(2.3, function()
            Destroy(newEffect)
        end)
    else
        Event.Brocast(EventName.Event_Show_SwitchView_Small_Card_Jackpot,cardId,newEffect)
    end
end

-----------------私有方法----------------------------------------------

function private.GetBingoCount(cardId,bingoCount)
    return this:GetCardView():GetBingoType(cardId,bingoCount)
end

function private.PlayBingoAudio(bingoCount)
    if bingoCount == 1 then
        UISound.play("werewolf_bingo")
    elseif bingoCount == 2 then
        UISound.play("werewolf_doubleBingo")
    elseif bingoCount == 3 then
        UISound.play("werewolf_tripleBingo")
    elseif bingoCount == 4 then
        UISound.play("werewolf_jackpot")
    end
end

---放狼族印记到格子上
function private.PutSignOnSell(bingoEffectObj, cardId, wolfPos)
    local logicModule = BattleLogic.GetLogicModule(LogicName.Card_logic)
    if logicModule:IsJackpot(cardId) then
        return Destroy(bingoEffectObj)
    end
    
    local curModel, signPos = ModelList.BattleModel:GetCurrModel()
    if ModelList.BattleModel:IsRocket() then
        --在小火箭界面使用5036里的数据
        local data = curModel:GetSettleExtraInfo("wolfSign")
        data = table.find(data, function(k, v)
            local cellID = ConvertServerPos(v.wolfPos)
            return v.cardId == cardId and cellID == wolfPos
        end)
        if data then
            signPos = ConvertServerPos(data.signPos)
        else
            signPos = curModel:GetValidPosForSign(cardId, wolfPos)
        end
    else
        signPos = curModel:GetValidPosForSign(cardId, wolfPos)
    end
    
    --添加ExtraData，结算时通知服务器
    curModel:GetRoundData(cardId):AddExtraUpLoadData("wolfSign", {
        cardId = tonumber(cardId),
        signPos = ConvertCellIndexToServerPos(signPos),
        wolfPos = ConvertCellIndexToServerPos(wolfPos),
    }, "wolfPos")
    
    --狼人印记
    local cellData = ModelList.BattleModel:GetCurrModel():GetRoundData(cardId, signPos)
    if cellData:IsNotSign() then
        cellData.haveWolfSign = true
    end

    local cardView = ModelList.BattleModel:GetCurrBattleView():GetCardView()
    local cellObj = cardView:GetCardCell(cardId, signPos)
    
    --印记Obj
    local ref = fun.get_component(bingoEffectObj, fun.REFER)
    local brandObj = ref:Get("brand")
    local animator = ref:Get("animator")
    fun.enable_component(animator, false)
    
    local moveTime = 0.5
    --印记飞到格子上
    fun.set_parent(brandObj, cellObj)
    Anim.move(brandObj,0,0,0,moveTime - 0.2,true,1,function ()
        Destroy(bingoEffectObj)
    end)
    local timerID, delay, tempTime = nil, UnityEngine.Time.deltaTime, 0
    timerID = LuaTimer:SetDelayLoopFunction(0.01, delay, -1, function()
        tempTime = tempTime + delay
        local factor = 1 - tempTime / moveTime
        if factor > 0 then
            local scaleTemp = (factor + 1) * 1.5
            fun.set_gameobject_scale(brandObj, scaleTemp, scaleTemp, 1)
        else
            fun.set_gameobject_scale(brandObj, 1.5, 1.5, 1)
            LuaTimer:Remove(timerID)

            if not cellData:IsNotSign() then
                Destroy(brandObj)
            else
                local ref2 = fun.get_component(cardView:GetCardMap(cardId), fun.REFER)
                local root = ref2:Get("sign")
                local parent = UnityEngine.GameObject.New(cellObj.name)
                fun.set_parent(parent, root, false)
                fun.set_same_position_with(parent, cellObj)
                fun.set_gameobject_scale(parent, 1, 1, 1)
                
                brandObj.name = "brand"
                fun.set_parent(brandObj, parent, true)
            end
        end
    end,nil, nil,LuaTimer.TimerType.Battle)
end

function private.StartSkillEmptyCheck(cardID, cb)
    local loop_delay_check
    loop_delay_check = LuaTimer:SetDelayLoopFunction(0.2,0.1,-1,function()
        local effectCacheEmpty = BattleEffectCache:CheckCardHideAllEffect(cardID)
        local effectPoolEmpty = BattleEffectPool:IsCardHideAllBindEffect(cardID)
        if effectPoolEmpty and effectCacheEmpty then
            LuaTimer:Remove(loop_delay_check)
            cb()
        end
    end,nil, nil,LuaTimer.TimerType.Battle)
    table.insert(this.loop_delay_checks, loop_delay_check)
end

return this