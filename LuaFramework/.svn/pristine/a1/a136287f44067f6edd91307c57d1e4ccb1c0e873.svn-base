---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/21 18:34
---

---  从Cache加载预设，可以动态跟随UI
--- 分离特效和UI，并且特效挂在不同的节点下，方便调整 UI 与特效， 特效与特效之间层级

HomeEffectCache = Clazz(ClazzBase,"HomeEffectCache")
local this = HomeEffectCache
local bindEffectes ={}  --绑定特效和对应UI, 可以调用接口，特效跟随UI位置做变化
local container = nil


---@param needBindTarget   --是否需要绑定目标物体，方便跟随目标UI
---@param recycleTime   -- 回收时间
---@param targetObj   -- 和目标物同位置
function HomeEffectCache:GetPrefabFromCache(prefabName,targetObj, needBindTarget,  func,recycleTime)
    if container == nil  or container:Equals(nil)  then
        container = GameObject.Find("Canvas/EffectContainer/Normal")
    end
    Cache.load_prefabs(AssetList[prefabName],prefabName,function(obj)
        local go = fun.get_instance(obj)
        fun.set_parent(go,container,true)
        fun.set_same_position_with(go,targetObj)
        if not needBindTarget then needBindTarget = false end
        if targetObj  and needBindTarget then
            table.insert(bindEffectes,{target = targetObj,go = go})
        end
        if func then   func(go) end
        if recycleTime then  Destroy(go,recycleTime)     end
    end)
end

function HomeEffectCache:Release()
    bindEffectes= {}
end

function HomeEffectCache:FollowTargetObj()
    for i = 1, #bindEffectes do
        if not Util.IsNull(bindEffectes[i].target)  and not Util.IsNull(bindEffectes[i].go) then
            fun.set_same_position_with(bindEffectes[i].go,bindEffectes[i].target)
        end
    end

    for i = #bindEffectes, 1, -1 do
        if Util.IsNull(bindEffectes[i].target)  or Util.IsNull(bindEffectes[i].go) then
            table.remove(bindEffectes,i)
        end
    end
end


