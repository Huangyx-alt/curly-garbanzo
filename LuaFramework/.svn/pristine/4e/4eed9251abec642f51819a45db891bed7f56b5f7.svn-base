---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/4/3 17:26
---

--- 杯赛顶部进度条

local QuickTaskBaseState = require "State/QuickTaskView/QuickTaskBaseState"
local QuickTaskOriginalState = require "State/QuickTaskView/QuickTaskOriginalState"
local QuickTaskAchieveState = require "State/QuickTaskView/QuickTaskAchieveState"
local QuickTaskNoAchieveState = require "State/QuickTaskView/QuickTaskNoAchieveState"
local QuickTaskClaimAwardsState = require "State/QuickTaskView/QuickTaskClaimAwardsState"
local QuickTaskFlyCookyState = require "State/QuickTaskView/QuickTaskFlyCookyState"
local CompetitionExtraRewardState = require "State/QuickTaskView/CompetitionExtraRewardState"
local CompetitionFlyCookieState = require "State/QuickTaskView/CompetitionFlyCookieState"
local CompetitionDoubleEnterState = require "State/QuickTaskView/CompetitionDoubleEnterState"
local CompetitionEnterState = require "State/QuickTaskView/CompetitionEnterState"
local CompetitionSkipState = require "State/QuickTaskView/CompetitionSkipState"

local DoubleCookiesRewards = require "View/CommonView/DoubleCookiesRewards"

local extra_reward_tip = require "View/Task/TopQuickTaskExtraTipView"
ParasitiferType = {mainCity = 1,lobby = 2,autoLobby = 3,other = 4}
local TopCompetitionView = BaseView:New("TopCompetitionView")
local this = TopCompetitionView
this.viewType = CanvasSortingOrderManager.LayerType.None

local slidValue = -1

local reward_cache_data,quickTask,finish_popup_process,quickTaskActivity
local isGetReward = false
local isDoubleCollect = false
local isDoubleReward = false
require "View/CommonView/RemainTimeCountDown"

this.auto_bind_ui_items = {
    "btn_foodcollect",
    "slid_food_progress",
    "text_food_percent",
    "text_food_time",
    "img_needitem",
    "img_rewarditem",
    "hangpoint1",
    "hangpoint2",
    "Image_fly_icon1",
    "Image_fly_icon2",
    "Image_fly_icon3",
    "Image_fly_icon4",
    "Image_fly_icon5",
    "Image_fly_icon6",
    "anima",
    "extra_rewarditem",
    "content",
    "btn_extrareward",
    "Rank",
    "doubleFlag",
    "RankAnima",
    "RankNumTxt",
    "RankOrderTxt",
    "Doubletubiao",
    "Doubletubiao2",
    "background",
    "btn_skip",
    "btn_background",
    "left_time_tip",
    "text_food_countdown",
    "BackgroundNormal",
    "BackgroundDouble",
    "textDoubleTime",
}

function TopCompetitionView:New(showDetail,parasitifer)
    local o = {}
    self.__index = self
    setmetatable(o,self)
    o._showDetail = showDetail
    o._parasitifer = parasitifer or ParasitiferType.other
    o.doubleCookiesRewards = DoubleCookiesRewards:New()
    return o
end

function TopCompetitionView:on_btn_foodcollect_click()
    --if self and self._fsm then
    --    self._fsm:GetCurState():ShowDetail(self._fsm)
    --end
    --- 2024/3/27 12:10:29 1.25改成促销界面
    ModelList.GiftPackModel:ShowCookiePack()
    --Facade.SendNotification(NotifyName.ShowUI,ViewList.GiftPackCompetitionCookieView)
end

function TopCompetitionView:on_btn_skip_click()
    self.isSkip = true
end

function TopCompetitionView:on_btn_background_click()
    self.isSkip = true
end

--function TopCompetitionView:on_btn_extrareward_click()
--    --if self and self._fsm then
--    --    self._fsm:GetCurState():ShowExtraRewardTip(self._fsm)
--    --end
--    Facade.SendNotification(NotifyName.HallCity.Function_icon_click, "SuperMatchPosterView", false)
--end

local showDetailTime = 0
function TopCompetitionView:OnShowDetail()
    if self._showDetail and os.time() - showDetailTime > 0.5 then
        showDetailTime = os.time()
        --Facade.SendNotification(NotifyName.ShowUI,ViewList.QuickTaskDetailView)
        ModelList.CompetitionModel.ReqCompetitionRankInfo()
    end
end

function TopCompetitionView:OnShowExtraRewardTip()
    Facade.SendNotification(NotifyName.ShowUI,extra_reward_tip,nil,nil,
            {pos = self.btn_extrareward.transform.position,
             icon = self.img_rewarditem,time = function() return self.extra_leftTime end})
end

function TopCompetitionView:SetDoubleRewardSkin(isDoubleReward)
   fun.set_active(self.Doubletubiao,isDoubleReward)
   fun.set_active(self.Doubletubiao2,isDoubleReward)
end

function TopCompetitionView:DoClaimAward()
    ---[[
    quickTask,quickTaskActivity = ModelList.CompetitionModel:GetQuickTaskActive()
    if quickTask then
        local rewardExtra = 0
        if self.isExtraReward then
            rewardExtra = 1
        end
        AddLockCountOneStep()
        ModelList.ActivityModel.C2S_SubmitActivity_new(quickTaskActivity.id,quickTask.id,quickTask.createTime,rewardExtra)
    end
    --]]
    --self:GetTaskRewardSucceed() --用于测试
    --ModelList.TaskModel.testTask = ModelList.TaskModel.testTask + 1
end

function TopCompetitionView:GetTaskRewardSucceed()
    self._fsm:GetCurState():ClaimRewardResult(self.fsm)
end

function TopCompetitionView:Awake()
    self:on_init()
    if -1 == slidValue then --slidValue这个变量是所有实例共用的，只需要设置一次初始化
        slidValue = UnityEngine.PlayerPrefs.SetFloat("TopQuickTask",0)
        slidValue = UnityEngine.PlayerPrefs.GetFloat("TopQuickTask",-1)
    end
end

function TopCompetitionView:OnEnable()
    self:RegisterEvent()

    isGetReward = false
    self.doubleCookiesRewards:CheckCookiesQuickTask(self.content,self)
    --self:SetDoubleRewardSkin(isDoubleReward)
    isDoubleReward = ModelList.CompetitionModel:GetDoubleRewardBuffTime() > 0
    self:SetDoubleRewardSkin(isDoubleReward)
    self:BuildFsm()
    --self:RefreshRemainTime()
    self:OnTaskUpdate()
    self:ShowDoubleTime()
end

function TopCompetitionView:BuildFsm()
    self:DisposeFsm()
    self._fsm = Fsm.CreateFsm("TopCompetitionView",self,{
        QuickTaskOriginalState:New(),
        QuickTaskAchieveState:New(),
        QuickTaskNoAchieveState:New(),
        QuickTaskClaimAwardsState:New(),
        QuickTaskFlyCookyState:New(),
        CompetitionExtraRewardState:New(),
        CompetitionFlyCookieState:New(),
        CompetitionDoubleEnterState:New(),
        CompetitionEnterState:New(),
        CompetitionSkipState:New(),
    })
    self._fsm:StartFsm("QuickTaskOriginalState")
end

function TopCompetitionView:DisposeFsm()
    if self._fsm then
        self._fsm:Dispose()
        self._fsm = nil
    end
end

function TopCompetitionView:OnApplicationFocus(focus)
    if focus and self.isShow then
        self:SetTaskInfo()
    end
end

function TopCompetitionView:CheckActivity(quickTask_go)
    local availab = ModelList.CompetitionModel:IsActivityAvailable(ActivityTypes.quickTask)
    if fun.is_not_null(quickTask_go) then
        fun.set_active(quickTask_go.transform.parent.parent,availab,false)
        fun.set_active(quickTask_go.transform, availab, false)
        if availab then
            self:SkipLoadShow(quickTask_go)
        end
    end
end

function TopCompetitionView:GetRemainTime()
    quickTask,quickTaskActivity = ModelList.CompetitionModel:GetQuickTaskActive()
    --local remainTime = math.max(0,  quickTask.expireTime  -os.time()  )
    log.log("时间倒计时 " , quickTask)
    if quickTask then
        self.leftTime = 999999
        self.resetTime = ModelList.CompetitionModel.GetResetTime() - os.time()
        if self.resetTime < 0 then
            self.resetTime = 0
        end
        fun.set_active(self.left_time_tip,self.resetTime>0)
    end
    if quickTask.extraRewardContinue > 0 then
        local extra_leftTime = math.max(0,  quickTask.extraRewardContinue- (os.time() - quickTask.createTime)  )
        self.extra_leftTime = extra_leftTime
    end
end

function TopCompetitionView:RefreshRemainTime()
    self:GetRemainTime()
    if self.text_food_countdown then
        self.text_food_countdown.text = fun.format_time(self.resetTime)
    end
end

function TopCompetitionView:RefreshRank()
    local selfRank = ModelList.CompetitionModel.GetSelfRank()
    if selfRank then
        self.RankNumTxt.text = selfRank.order
        if selfRank.order == 1 then
            self.RankOrderTxt.text = "st"
        elseif selfRank.order == 2 then
            self.RankOrderTxt.text = "nd"
        elseif selfRank.order == 3 then
            self.RankOrderTxt.text = "rd"
        else
            self.RankOrderTxt.text = "th"
        end
    end
end

function TopCompetitionView:ConverIdToIcon(id)
    local isDoubleCollectItem = ModelList.CompetitionModel:GetDoubleRewardBuffTime() > 0 
    local searchString = "reward_icon"
    if isDoubleCollectItem then
        searchString = "reward_double_icon"
    end
    for k ,v in pairs(Csv.new_cookie_round) do
        if v.reward and v.reward[1][1] == id then
            return v[searchString]
        end
    end
    return nil
end


function TopCompetitionView:SetTaskInfo()
    self.leftTime = nil
    self.extra_leftTime = nil
    if not self or  fun.is_null(self.go) then
        return
    end
    quickTask,quickTaskActivity = ModelList.CompetitionModel:GetQuickTaskActive()
    if  quickTask then
        local reward_extra_icon = nil
        if quickTask.extraReward and #quickTask.extraReward > 0 then
            reward_extra_icon = self:ConverIdToIcon(quickTask.extraReward[1].id)
        end
      local  rewardIcon = {self:ConverIdToIcon(quickTask.reward[1].id),reward_extra_icon}

        if rewardIcon[1] then
            Cache.load_sprite(AssetList[rewardIcon[1]], rewardIcon[1], function(tex)
                if self and fun.is_not_null(self.img_rewarditem) and fun.is_not_null(tex) then
                    self.img_rewarditem.texture = tex.texture
                end
            end)
        end

        local num = tonumber(quickTask.progress)
        local targenum = tonumber(quickTask.target)
        num = math.min(num,targenum)
        if slidValue < 0 then
            slidValue = num
            UnityEngine.PlayerPrefs.SetFloat("TopQuickTask",slidValue)
            self:SetProgress(num,targenum)
        else
            self:SetProgress(math.min(slidValue, num),targenum)
        end
        self:SetRightItem(quickTask)
        self:GetRemainTime() --math.max(0,ModelList.CompetitionModel:GetActivityExpireTime(ActivityTypes.quickTask) - os.time())
    end

    local isFirstOpen = ModelList.CompetitionModel:IsActivityFirstOpen(ActivityTypes.quickTask)
    --if  (quickTask ~= nil and self.leftTime and self.leftTime > 2 )  or ModelList.CompetitionModel:IsUnAvailableAndHasReward() then
    if  (quickTask ~= nil )  or ModelList.CompetitionModel:IsUnAvailableAndHasReward() then
        self:Show(nil,self.go)
        if isFirstOpen and self._parasitifer ~= ParasitiferType.other then
            fun.set_active(self.content,false,false)
        end
    else
        self:ForceQuickTaskFinish()
        if fun.is_not_null(self.go) then
            fun.set_active(self.go.transform.parent.parent,false,false)
        end
    end
end


function TopCompetitionView:SetTaskInfo2()
    self.leftTime = nil
    self.extra_leftTime = nil
        quickTask,quickTaskActivity = ModelList.CompetitionModel:GetQuickTaskActive()
    if  quickTask then
        local reward_extra_icon = nil
        if quickTask.extraReward and #quickTask.extraReward > 0 then
            reward_extra_icon = self:ConverIdToIcon(quickTask.extraReward[1].id)
        end
        local rewardIcon = {self:ConverIdToIcon(quickTask.reward[1].id),reward_extra_icon}
        if rewardIcon[1] then
            Cache.load_sprite(AssetList[rewardIcon[1]],rewardIcon[1],function(tex)
                if self and fun.is_not_null(self.img_rewarditem) and fun.is_not_null(tex) then
                    self.img_rewarditem.texture = tex.texture
                end
            end)
        end
        if rewardIcon[2] then
            Cache.load_sprite(AssetList[rewardIcon[2]],rewardIcon[2],function(tex)
                if self and fun.is_not_null(self.extra_rewarditem) and fun.is_not_null(tex) then
                    self.extra_rewarditem.texture = tex.texture
                end
            end)
        end

        local num = tonumber(quickTask.progress)
        local targenum = tonumber(quickTask.target)
        num = math.min(num,targenum)
        if slidValue < 0 then
            slidValue = num
            UnityEngine.PlayerPrefs.SetFloat("TopQuickTask",slidValue)
            self:SetProgress(num,targenum)
        else
            self:SetProgress(math.min(slidValue, num),targenum)
        end
        self:SetRightItem(quickTask)
        self:GetRemainTime() --math.max(0,ModelList.CompetitionModel:GetActivityExpireTime(ActivityTypes.quickTask) - os.time())
    end

    --local isFirstOpen = ModelList.CompetitionModel:IsActivityFirstOpen(ActivityTypes.quickTask)
    --if  (quickTask ~= nil and self.leftTime and self.leftTime > 2 )  or ModelList.CompetitionModel:IsUnAvailableAndHasReward()  then
    if  (quickTask ~= nil  )  or ModelList.CompetitionModel:IsUnAvailableAndHasReward()  then
        self:Show(nil,self.go)
    else
        self:ForceQuickTaskFinish()
        if fun.is_not_null(self.go) and fun.is_not_null(self.go.transform.parent) then
            fun.set_active(self.go.transform.parent.parent,false,false)
        end
    end
end


---简单复制SetTaskInfo2 ，进度条显示为最新而不是0
function TopCompetitionView:SetTaskInfo3()
    self.leftTime = nil
    self.extra_leftTime = nil
    quickTask,quickTaskActivity = ModelList.CompetitionModel:GetQuickTaskActive()
    if  quickTask then
        local reward_extra_icon = nil
        if quickTask.extraReward and #quickTask.extraReward > 0 then
            reward_extra_icon = self:ConverIdToIcon(quickTask.extraReward[1].id)
        end
        local rewardIcon = {self:ConverIdToIcon(quickTask.reward[1].id),reward_extra_icon}
        if rewardIcon[1] then
            Cache.load_sprite(AssetList[rewardIcon[1]],rewardIcon[1],function(tex)
                if self and fun.is_not_null(self.img_rewarditem) and fun.is_not_null(tex) then
                    self.img_rewarditem.texture = tex.texture
                end
            end)
        end
        if rewardIcon[2] then
            Cache.load_sprite(AssetList[rewardIcon[2]],rewardIcon[2],function(tex)
                if self and fun.is_not_null(self.extra_rewarditem) and fun.is_not_null(tex) then
                    self.extra_rewarditem.texture = tex.texture
                end
            end)
        end

        local num = tonumber(quickTask.progress)
        local targenum = tonumber(quickTask.target)
        num = math.min(num,targenum)
        slidValue = num
        UnityEngine.PlayerPrefs.SetFloat("TopQuickTask",slidValue)
        self:SetProgress( num,targenum)
        self:SetRightItem(quickTask)
        self:GetRemainTime() --math.max(0,ModelList.CompetitionModel:GetActivityExpireTime(ActivityTypes.quickTask) - os.time())
    end

    if  (quickTask ~= nil )  or ModelList.CompetitionModel:IsUnAvailableAndHasReward()  then
        self:Show(nil,self.go)
    else
        self:ForceQuickTaskFinish()
        if fun.is_not_null(self.go) and fun.is_not_null(self.go.transform.parent) then
            fun.set_active(self.go.transform.parent.parent,false,false)
        end
    end
end

function TopCompetitionView:SetRightItem(data)
    if (data.reward[1].id  == BingoBangEntry.itemType.MagnifyingGlass ) or  (data.reward[1].id == BingoBangEntry.itemType.CookieDoubleTime) then
        local ti = data.reward[1].value
        local hrs = math.floor(ti / 3600)
        if hrs > 0 then
            self.text_food_time.text = fun.NumInsertComma(hrs) .. " HRS" --tostring(data.value)
        else
            local min = math.floor(ti / 60)
            self.text_food_time.text = fun.NumInsertComma(min) .. " Min" --tostring(data.value)
        end
    else
        self.text_food_time.text =  fun.NumInsertComma(data.reward[1].value or 0) -- tostring(data.reward_description[1][1])
    end
end

function TopCompetitionView:CheckExtraReward()
    --local quickTask = ModelList.CompetitionModel:GetQuickTaskActive()
    if quickTask then
        local reward_type = (quickTask.extraRewardContinue > 0 and os.time() - quickTask.createTime <= quickTask.extraRewardContinue ) and true or false
        --reward_type = true
        if reward_type ~= self.isExtraReward then
            self.isExtraReward = reward_type
            if self.isExtraReward then
                self:PlayRewardWithExtra()
            else
                self:PlayRewardNoExtra()
            end
        end
    end
end

function TopCompetitionView:CheckExtraReward2(isCheckNext)
    if quickTask then
        --local quickTask2 = ModelList.CompetitionModel:GetNextQuickTaskActive(quickTask.id)
        --if isCheckNext and quickTask2 then
        if false then
            local reward_type = (quickTask2.extraRewardContinue > 0 and os.time() - quickTask2.createTime <= quickTask2.extraRewardContinue ) and true or false
            return reward_type,self.isExtraReward
        else
            --self.isExtraReward = quickTask.extraReward and #quickTask.extraReward > 0 and true or false
            local reward_type = (quickTask and #quickTask.extraReward > 0 ) and true or false
            return reward_type,self.isExtraReward
        end
    end
end

function TopCompetitionView:OnTaskUpdate(taskType)
    if taskType == nil or taskType == ActivityTypes.quickTask then
        if self.resetTime and self.resetTime > 0 then
            if self._timer then
                self._timer:Stop()
                self._timer = nil
            end
            self._timer = Timer.New(function()
                self:OnHeartBeat(true)
            end,1,-1)
            self._timer:Start()
            self:OnHeartBeat()
        end
    end
end

function TopCompetitionView:RefreshExtraRewardTime()
    if extra_reward_tip then
        extra_reward_tip:setTime(self.extra_leftTime)
    end
end

function TopCompetitionView:OnHeartBeat(sub)
    if self.resetTime and self.resetTime > 0 then
        if sub then
            self.resetTime = math.max(0,self.resetTime - 1)
        end
        if fun.is_not_null(self.text_food_countdown) then
            self.text_food_countdown.text = fun.format_time(self.resetTime)
        end
    elseif not ModelList.CompetitionModel:IsUnAvailableAndHasReward() then
        if self._timer then
            self._timer:Stop()
            self._timer = nil
        end
        self:GetRemainTime()
        self._fsm:GetCurState():CheckTimeOut(self._fsm)
    end
    --if self.doubleCollectTime and self.doubleCollectTime >0 then
    --    self.doubleCollectTime = math.max(0,self.doubleCollectTime - 1)
    --    if self.doubleCollectTime<= 0 then
    --        self.doubleCollectTime = nil
    --        self.doubleCookiesRewards:CheckDoubleCookiesActive(self.anima)
    --    end
    --end
end

function TopCompetitionView:TimeOutHide()
    if self and not fun.is_null(self.go) then
        if ( self.resetTime == nil or self.resetTime <= 0 ) and ModelList.CompetitionModel.GetResetTime() > 0 then
            ModelList.CompetitionModel.ReqCompetitionRankInfo(2)
            self:ForceQuickTaskFinish()
            fun.set_active(self.go.transform.parent.parent,false,false)
        else
            self:OnTaskUpdate()
            self.doubleCookiesRewards:CheckDoubleCookiesActive(self.anima)
        end
    end
end

function TopCompetitionView:SetParent(go)
    if go then
        if self.revertParent == nil then
            self.revertParent = self.go.transform.parent
            self.contenPos = self.content.position
            local pos = self.go.transform.position
            self.go.transform:SetParent(go.transform)
            self.go.transform.position = pos
            --self.black_block.sizeDelta = Vector2.New(1080 * (UnityEngine.Screen.width / 1080),1920 * (UnityEngine.Screen.height / 1920))
            --self.black_block.position = Vector3.New(0,0,0)
            self.go.transform.localScale = Vector3.one
            self.go.transform.anchorMin = Vector2.New(0,0)
            self.go.transform.anchorMax = Vector2.New(1,1)
            self.go.transform.pivot = Vector2.New(0.5,0.5)
            self.go.transform.offsetMax = Vector2.New(0,0)
            self.go.transform.offsetMin = Vector2.New(0,0)

            self.content.position = self.contenPos
        end
    end
end

function TopCompetitionView:RevertParent()
    if self.revertParent then
        local pos = self.go.transform.position
        self.go.transform:SetParent(self.revertParent)
        self.go.transform.position = pos
        self.content.position = self.contenPos
        self.revertParent = nil
    end
end

function TopCompetitionView:TweenSlider()
    if self:IsSkip() then
        self:SetSkip()
        return
    end
    if quickTask then
        local nownNum = tonumber(quickTask.progress)
        local targenum = tonumber(quickTask.target)
        nownNum = math.min(nownNum,targenum)
        if nownNum > 0 then
            UISound.play_loop("task_item_increase")
            Anim.do_smooth_float_update(slidValue,nownNum,math.min(math.max(0.05,(nownNum - slidValue)/25),0.3),
                    function(num)
                        self:SetProgress(num,targenum)
                    end,
                    function(tweener)
                        if nownNum == targenum then
                            slidValue = 0
                        else
                            slidValue = nownNum
                        end
                        self._fsm:GetCurState():TweenSliderFinish(self._fsm)
                        UISound.stop_loop("task_item_increase")
                        UnityEngine.PlayerPrefs.SetFloat("TopQuickTask",slidValue)
                    end)
        else
            slidValue = 0
            self:SetProgress(nownNum,targenum)
            self._fsm:GetCurState():TweenSliderFinish(self._fsm)
        end
    end
end

function TopCompetitionView:QuickTaskGetReward()
    self:SetNextLoop()
end

---回合结束，下一轮是否是完成状态
function TopCompetitionView:IsCompetitionGetReward()
    if quickTask and quickTask.completed then
        isGetReward = true
        log.log("isGetReward true")
        ModelList.CompetitionModel:RemoveNearRound(quickTask.order)
    end
    quickTask,quickTaskActivity = ModelList.CompetitionModel:GetQuickTaskActive()
    return quickTask.completed
end

---回合结束，下一轮是否是完成状态
function TopCompetitionView:IsCompetitionNoChange()
    if quickTask and not quickTask.completed and quickTask.progress == 0 then
        return true
    end
    return false
end


function TopCompetitionView:SetNextLoop(ignoreRemove)
    if not ignoreRemove and quickTask and quickTask.completed then
        isGetReward = true
        log.log("isGetReward true")
        ModelList.CompetitionModel:RemoveNearRound(quickTask.order)
         quickTask,quickTaskActivity = ModelList.CompetitionModel:GetQuickTaskActive()
        local reward_type = (quickTask and #quickTask.extraReward > 0  ) and true or false
        self.anima:SetBool("IsExtra",reward_type)
       -- log.log("set next loop "..tostring(reward_type))
        self:OnCheckQuickTask2(true)
        --self:PlayProcessMaxAnima(function()
        --    self:OnCheckQuickTask2()
        --end)
    else
        quickTask,quickTaskActivity = ModelList.CompetitionModel:GetQuickTaskActive()
        self:OnCheckQuickTask2(true)
    end
end

function TopCompetitionView:ForceQuickTaskFinish()
    if not finish_popup_process then
        self:QuickTaskFinish()
    else
        self:Hide()
    end
end

function TopCompetitionView:QuickTaskFinish()
    finish_popup_process = true
    self:RevertParent()
    self:SetSkipMaskShow(false)
    if isGetReward  then
        Facade.SendNotification(NotifyName.ShowUI,ViewList.CompetitionRewardView)
        if self and self._fsm then
            self._fsm:GetCurState():Finish(self._fsm)
            self._fsm:GetCurState():ClaimAwards(self._fsm)
        end
    else
        Event.Brocast(EventName.Event_popup_competition_finish)
        if self and self._fsm then
            self._fsm:GetCurState():Finish(self._fsm)
        end
    end
    self:PlayOrderAnima()
end

--- 最后才播放拍动
function TopCompetitionView:PlayOrderAnima()
    local selfRank = ModelList.CompetitionModel.GetSelfRank()
    if selfRank then
        self.RankNumTxt.text = selfRank.order
        if selfRank.order == 1 then
            self.RankOrderTxt.text = "st"
        elseif selfRank.order == 2 then
            self.RankOrderTxt.text = "nd"
        elseif selfRank.order == 3 then
            self.RankOrderTxt.text = "rd"
        else
            self.RankOrderTxt.text = "th"
        end
        fun.set_active(self.RankAnima,true)
    end
end

function TopCompetitionView:PlayRewardNoExtra()
    --local stateInfo = self.anima:GetCurrentAnimatorStateInfo(0)
    --if stateInfo and stateInfo:IsName("idle1") then
        log.log("AnimatorPlayHelper  play   efTopQuickTaskViewge1 ")
        AnimatorPlayHelper.Play(self.anima,{"efTopQuickTaskViewge1","efTopQuickTaskViewge1"},false,function()
            --self:CheckDouble()
        end)
    --end
end

function TopCompetitionView:PlayRewardWithExtra()
    --local stateInfo = self.anima:GetCurrentAnimatorStateInfo(0)
    --if stateInfo and stateInfo:IsName("idle1") then
    if quickTask and  ModelList.CompetitionModel:IsShownedExtraAnima(quickTask.order) then
        log.log("AnimatorPlayHelper  play   efTopQuickTaskViewge2 ")
        AnimatorPlayHelper.Play(self.anima,{"efTopQuickTaskViewge2","efTopQuickTaskViewge2"},false,function()
            self:CheckDouble()
        end)
    else
        self._fsm:ChangeState("CompetitionExtraRewardState",1)
    end
    --end
end

function TopCompetitionView:PlayRewardWithExtra1(isCheckNext)
    self.anima:SetBool("IsExtra",self.isExtraReward and true or false)
    log.log("AnimatorPlayHelper set IsExtra"..tostring(self.isExtraReward))
    AnimatorPlayHelper.Play(self.anima,{"efTopQuickTaskViewge2","efTopQuickTaskViewge2"},false,function()
        --log.log("set WaitOver  ")
        if isCheckNext then
            self:OnCheckQuickTask2()
        else
            self._fsm:GetCurState():WaitOver()
        end
        --self._fsm:GetCurState():WaitOver()
    end)
end

function TopCompetitionView:PlayRewardWithExtra2(isCheckNext)
    self.anima:SetBool("IsExtra",self.isExtraReward)
    if not quickTask then
        quickTask,quickTaskActivity = ModelList.CompetitionModel:GetQuickTaskActive()
    end
    --if(quickTask and quickTask.order == 1) then
    --    ModelList.CompetitionModel:ClearShownedExtraAnima()
    --end
    if quickTask and not ModelList.CompetitionModel:IsShownedExtraAnima(quickTask.order) then
        log.log("AnimatorPlayHelper set PlayRewardWithExtra1  ")
        AnimatorPlayHelper.Play(self.anima,{"TaskViewge2enter","efTopQuickTaskViewnew2enter"},false,function()
            --log.log("set PlayRewardWithExtra2  ")
            if quickTask then
                ModelList.CompetitionModel:SaveShownedExtraAnima(quickTask.order)
            end
            if isCheckNext then
                self:OnCheckQuickTask2()
            else
                self._fsm:GetCurState():WaitOver()
            end
        end)
    else
        --log.log("quickTask  bool "..tostring(quickTask == nil))
        self:PlayRewardWithExtra1(isCheckNext)
    end

end

function TopCompetitionView:CheckDouble()
    isDoubleCollect = ModelList.CompetitionModel:GetDoubleCollectBuffTime() > 0
    isDoubleReward = ModelList.CompetitionModel:GetDoubleRewardBuffTime() > 0
    self:SetDoubleRewardSkin(isDoubleReward)
    local animName = {"enter","efTopQuickTaskViewienter"}
    if isDoubleCollect then
        animName = {"doubleenter","efTopQuickTaskViewidoubleenter"}
        log.log("AnimatorPlayHelper  play   doubleenter ")
        AnimatorPlayHelper.Play(self.anima,{animName[1],animName[2]},false,nil)
    end
    return isDoubleCollect
end


function TopCompetitionView:PlayDouble()
    isDoubleCollect = ModelList.CompetitionModel:GetDoubleCollectBuffTime() > 0
    local animName = {"enter","efTopQuickTaskViewienter"}
    if isDoubleCollect then
        animName = {"doubleenter","efTopQuickTaskViewidoubleenter"}
        log.log("AnimatorPlayHelper  play   doubleenter ")
        AnimatorPlayHelper.Play(self.anima,{animName[1],animName[2]},false,nil)
    end
    return isDoubleCollect
end


function TopCompetitionView:GetRewardStartAnima()
    --if self.isExtraReward then
    --    return {"start2","efTopQuickTaskViewstart2"}
    --else
    --
    --end
    --log.log("GetRewardStartAnima  new ")
    return {"new","efTopQuickTaskViewnew"}
end

function TopCompetitionView:PlayGetRewardAnima()
    --UISound.play("rask_reward_out")
    self.anima:SetBool("IsExtra",self.isExtraReward and true or false)
    --log.log("set IsExtra"..tostring(self.isExtraReward))
    --self.anima:SetBool("IsDouble",false)
    log.log("AnimatorPlayHelper  play   new ")
    UISound.play("task_reward_back")
    AnimatorPlayHelper.Play(self.anima,self:GetRewardStartAnima(),false,function()
        Facade.SendNotification(NotifyName.ShowUI,ViewList.CompetitionRewardView)
        self._fsm:GetCurState():Finish(self._fsm)
        --Facade.SendNotification(NotifyName.CloseUI,ViewList.TopQuickTaskFlyRewardView)
        self._fsm:GetCurState():ClaimAwards(self._fsm)
    end)
end

function TopCompetitionView:PlayProcessMaxAnima(callBack)
    self.anima:SetBool("IsExtra",self.isExtraReward and true or false)
   -- log.log("set IsExtra"..tostring(self.isExtraReward))
    log.log("AnimatorPlayHelper  play   new ")
    AnimatorPlayHelper.Play(self.anima,self:GetRewardStartAnima(),false,callBack)
end

function TopCompetitionView:GetRewardPickAnima()
    if self.isExtraReward then
        return {"pick2","efTopQuickTaskViewpick2"}
    else
        return {"pick","efTopQuickTaskViewpick"}
    end
end

function TopCompetitionView:FlyRewardItem2Head(pos)
    Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts,self.img_rewarditem.transform.position,reward_cache_data[1],function()
        Event.Brocast(EventName.Event_currency_change)
    end)

    if self.isExtraReward and reward_cache_data[2] > 0 then
        Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts,self.extra_rewarditem.transform.position,reward_cache_data[2],function()
            Event.Brocast(EventName.Event_currency_change)
        end)
    end
    log.log("AnimatorPlayHelper  play   pick2 pick ")
    AnimatorPlayHelper.Play(self.anima,self:GetRewardPickAnima(),false,function()
        self:FlyNextRewardItem()
    end)
end

function TopCompetitionView:FlyNextRewardItem()
    self:SetTaskInfo()
    UISound.play("task_reward_back")
    log.log("AnimatorPlayHelper  play   new ")
    AnimatorPlayHelper.Play(self.anima,{"new","efTopQuickTaskViewnew"},false,function()
        if self.isExtraReward then
            UISound.play("task_reward_back")
            log.log("AnimatorPlayHelper  play   new2 ")
            AnimatorPlayHelper.Play(self.anima,{"new2","efTopQuickTaskViewnew2"},false,function()
                self:EnterHomeScene()
            end)
        else
            self:EnterHomeScene()
        end
    end)
end

function TopCompetitionView:SaveQuickTaskId()
    --在下一个任务更新之前先保存起来
    --local quickTask = ModelList.CompetitionModel:GetQuickTaskActive()
    if quickTask and quickTask.roundData then
        reward_cache_data = {quickTask.roundData[1].reward[1].id or 1,quickTask.extraReward[1].reward[1].id or 0}
    end
end

function TopCompetitionView:OnDisable()
    self:UnRegisterEvent()
    if self._timer then
        self._timer:Stop()
        self._timer = nil
    end
    self.leftTime = nil
    self.extra_leftTime = nil
    self.changeParent = nil
    self.isExtraReward = nil
    reward_cache_data = nil
    self.doubleCookiesRewards:OnDisable()
    UISound.stop_loop("task_item_increase")
    --self:DisposeFsm()
    fun.set_active(self.left_time_tip,false)
    if self.doubleTimeCountDown then
        self.doubleTimeCountDown:StopCountDown()
        self.doubleTimeCountDown = nil
    end
end

function TopCompetitionView:OnCheckQuickTask()
    local first = ModelList.CompetitionModel:IsAnyFirstOpen()
    if first  then
        isDoubleCollect = ModelList.CompetitionModel:GetDoubleCollectBuffTime() > 0
        local animName = {"enter","efTopQuickTaskViewienter"}
        if isDoubleCollect then
            animName = {"doubleenter","efTopQuickTaskViewidoubleenter"}
        end
        ModelList.CompetitionModel.SetPrefsString("competition_last_open")
        log.log("AnimatorPlayHelper  play    "..animName[1])
        AnimatorPlayHelper.Play(self.anima,{animName[1],animName[2]},false,0.1,function()
            fun.set_active(self.content,true,false)
            UISound.play("task_reward_appear")
        end,function()
            ModelList.CompetitionModel:CutdownFirstPopup()
            if quickTask and not quickTask.completed   then
                self:DoAnimationObtainableTaskItem()
            else
                self:OnCheckQuickTask2()
            end
            --self:OnCheckQuickTask2()
        end)
    else
        self:OnCheckQuickTask2()
    end
end

function TopCompetitionView:PlayDoubleCollectBuffChange()
    local animName = nil
    if isDoubleCollect and  ModelList.CompetitionModel:GetDoubleCollectBuffTime() <= 0 then
        animName = {"doubleexit","efTopQuickTaskViewidoubleexit"}
    elseif not isDoubleCollect and  ModelList.CompetitionModel:GetDoubleCollectBuffTime() > 0 then
        animName = {"doubleenter","efTopQuickTaskViewidoubleenter"}
    end
    self:ShowDoubleTime()
    self:SetTaskInfo2()
    if not animName then return end
    isDoubleCollect = ModelList.CompetitionModel:GetDoubleCollectBuffTime() > 0
    log.log("AnimatorPlayHelper  play    "..animName[1])
    AnimatorPlayHelper.Play(self.anima,{animName[1],animName[2]},false,nil)

end

function TopCompetitionView:ShowDoubleTime()
    self.doubleCollectTime = ModelList.CompetitionModel:GetDoubleCollectBuffTime()
    log.log("双倍收集时间 " ,self.doubleCollectTime )
    if self.doubleCollectTime <= 0 then
        return
    end
    self.doubleTimeCountDown = self.doubleTimeCountDown or RemainTimeCountDown:New()
    self.doubleTimeCountDown:StopCountDown()
    self.doubleTimeCountDown:StartCountDown(CountDownType.cdt2, self.doubleCollectTime, self.textDoubleTime,
            function()
                self.textDoubleTime.text = ""
                animName = {"doubleexit","efTopQuickTaskViewidoubleexit"}
                log.log("AnimatorPlayHelper  play   doubleenter ")
                AnimatorPlayHelper.Play(self.anima,{animName[1],animName[2]},false,nil)
            end
    )
end

function TopCompetitionView:PlayDoubleRewardBuffChange()
    if isDoubleReward and  ModelList.CompetitionModel:GetDoubleRewardBuffTime() <= 0 then
        fun.set_active(self.Doubletubiao,false)
        fun.set_active(self.Doubletubiao2,false)
        isDoubleReward = false
    elseif not isDoubleReward and  ModelList.CompetitionModel:GetDoubleRewardBuffTime() > 0 then
        fun.set_active(self.Doubletubiao,true)
        fun.set_active(self.Doubletubiao2,true)
        isDoubleReward = true
        --fun.set_active(self.Doubletubiao2,true)
    end
    self:ShowDoubleTime()
    self:SetTaskInfo()
end


function TopCompetitionView:OnCheckQuickTask2(isCheckNext)
    --local quickTask = ModelList.CompetitionModel:GetQuickTaskActive()
    if isCheckNext then
        local reward_type,isExtraReward  =  self:CheckExtraReward2(isCheckNext)
        if reward_type then
            self.isExtraReward = reward_type
            self:PlayRewardWithExtra2(isCheckNext)
            self:SetTaskInfo()
            return
        end
    end
    self:SetSkipMaskShow(ModelList.CompetitionModel:HasMultipleRoundsCookie() )
    if quickTask then
        if quickTask.failed then
            self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
        elseif quickTask.completed then
            self._fsm:GetCurState():QuickTaskAchieve(self._fsm)
        else
            self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
        end
    else
        self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
    end
    self:SetTaskInfo()
    --self:CheckExtraReward()
end

function TopCompetitionView:OnCheckQuickTask3()
    if quickTask then
        if quickTask.failed then
            self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
        elseif quickTask.completed then
            self._fsm:GetCurState():QuickTaskAchieve(self._fsm)
        else
            self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
        end
    else
        self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
    end
end

function TopCompetitionView:OnCheckCompetitionNextLoop()
    --local quickTask = ModelList.CompetitionModel:GetQuickTaskActive()
    if quickTask then
        local reward_type,isExtraReward  =  self:CheckExtraReward2()
        if reward_type ~= isExtraReward then
            self._fsm:ChangeState("CompetitionExtraRewardState",2)
        else
            if quickTask.failed then
                self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
            elseif quickTask.completed then
                self._fsm:GetCurState():QuickTaskAchieve(self._fsm)
            else
                self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
            end
        end
    else
        self._fsm:GetCurState():QuickTaskNoAchieve(self._fsm)
    end
    self:SetTaskInfo()
    --self:CheckExtraReward()
end

function TopCompetitionView:EnterHomeScene()
    finish_popup_process = false
    --log.log("EnterHomeScene")
    self._fsm:ChangeState("CompetitionEnterState")
    --self._fsm:GetCurState():CheckQuickTask(self._fsm)
end

function TopCompetitionView:SetProgress(num,targetNum)
    log.log("延迟设置进度条 " , num , "   "  ,targetNum)
    --self.text_food_percent.text = string.format("<size=42>%s</size><color=#ecff93>/%s</color>",math.floor(num),targetNum)
    self.text_food_percent.text = string.format("%s/%s",math.floor(num),targetNum)
    self.slid_food_progress.value = num / targetNum
end

function TopCompetitionView:OnQuickTaskNoAchieve()
    --local quickTask = ModelList.CompetitionModel:GetQuickTaskActive()
    --log.log("OnQuickTaskNoAchieve")



    if quickTask then
        local num = tonumber(quickTask.progress)
        local targenum = tonumber(quickTask.target)
        num = math.min(num,targenum)
        if num > 0 and slidValue < num then
            --self:DoAnimationObtainableTaskItem()
            self:TweenSlider()
            --self:OnQuickTaskNoAchieve()
        else
            self:SetProgress(num,targenum)
            self._fsm:GetCurState():TweenSliderFinish(self._fsm)
            slidValue = num
        end
    end
end


function TopCompetitionView:GetAchieveAnimation()
    --log.log("GetAchieveAnimation")
    return {"new","efTopQuickTaskViewnew"}
end

function TopCompetitionView:OnQuickTaskAchieve()
    --log.log("OnQuickTaskAchieve")
    if not self.isExtraReward then self.isExtraReward =false end
    self.anima:SetBool("IsExtra",self.isExtraReward and true or false)
    --log.log("set IsExtra"..tostring(self.isExtraReward))
    --self.anima:SetBool("IsDouble",self.is)
    if isGetReward then
        log.log("AnimatorPlayHelper  play   new ")
        AnimatorPlayHelper.Play(self.anima,self:GetAchieveAnimation(),false,function()
            self:TweenSlider()
        end)
    else
        self:TweenSlider()
    end
end

function TopCompetitionView:OnQuickTaskAchieve2()
    --log.log("OnQuickTaskAchieve2")
    if not self.isExtraReward then self.isExtraReward =false end
    local reward_type = (quickTask.extraRewardContinue > 0 and os.time() - quickTask.createTime <= quickTask.extraRewardContinue ) and true or false
    self.anima:SetBool("IsExtra",( self.isExtraReward and self.isExtraReward == reward_type )and true or false)
   -- log.log("set IsExtra"..tostring(self.isExtraReward))
    --self.anima:SetBool("IsDouble",self.is)
    log.log("AnimatorPlayHelper  play   new ")
    UISound.play("task_reward_back")
    AnimatorPlayHelper.Play(self.anima,self:GetAchieveAnimation(),false,function()
        self:QuickTaskGetReward()
    end)
end

function TopCompetitionView:DoAnimationObtainableTaskItem()
    --if not self.changeParent then
    --    self.changeParent = true
    --else
    --    self:FlyCooky()
    --end
    self:FlyCooky()
end

function TopCompetitionView:FlyCooky(parent_task_fly)
    self._fsm:GetCurState():FlyCooky(self._fsm,parent_task_fly)
end

function TopCompetitionView:GetCookiesAnimation()
    --log.log("GetCookiesAnimation")
    if self.doubleCookiesRewards:IsDoubleReward() then
        return {"get2","efTopQuickTaskViewget2"}
    else
        return {"get","efTopQuickTaskViewget"}
    end
end


function TopCompetitionView:IsHasCookie()
    if quickTask and #quickTask.roundData > 0 and (quickTask.roundData > 1  ) then
        return true
    end
    return false
end

function TopCompetitionView:OnFlyCooky(parent_task_fly)
    if parent_task_fly then
        self:SetParent(parent_task_fly)
    end
    self:SetSkipMaskShow(ModelList.CompetitionModel:HasMultipleRoundsCookie() )
    UISound.play("task_item_out")
    self.Image_fly_icon1.sprite = self.img_needitem.sprite
    self.Image_fly_icon2.sprite = self.img_needitem.sprite
    self.Image_fly_icon3.sprite = self.img_needitem.sprite
    self.Image_fly_icon4.sprite = self.img_needitem.sprite
    self.Image_fly_icon5.sprite = self.img_needitem.sprite
    self.Image_fly_icon6.sprite = self.img_needitem.sprite
    log.log("AnimatorPlayHelper  play   GetCookiesAnimation ")
    AnimatorPlayHelper.Play(self.anima,self:GetCookiesAnimation(),false,function()
        --self:TweenSlider()
        self._fsm:GetCurState():TweenSliderFinish(self._fsm)
    end)
end

function TopCompetitionView:OnFlyCooky2(parent_task_fly)
    if parent_task_fly then
        self:SetParent(parent_task_fly)
    end
    UISound.play("task_item_out")
    self.Image_fly_icon1.sprite = self.img_needitem.sprite
    self.Image_fly_icon2.sprite = self.img_needitem.sprite
    self.Image_fly_icon3.sprite = self.img_needitem.sprite
    self.Image_fly_icon4.sprite = self.img_needitem.sprite
    self.Image_fly_icon5.sprite = self.img_needitem.sprite
    self.Image_fly_icon6.sprite = self.img_needitem.sprite
    log.log("AnimatorPlayHelper  play   GetCookiesAnimation ")
    AnimatorPlayHelper.Play(self.anima,self:GetCookiesAnimation(),false,function()
        --self:TweenSlider()
        self._fsm:GetCurState():TweenSliderFinish()
    end)
end

function TopCompetitionView:CollectBuffChange()

end

function TopCompetitionView:OnReceiveReward()
    isGetReward  = false
end

function TopCompetitionView:RegisterEvent()
    Event.AddListener(EventName.Event_show_competition_task,self.EnterHomeScene,self)
    Event.AddListener(EventName.Event_Activity_ReceiveReward,self.GetTaskRewardSucceed,self)
    Event.AddListener(EventName.Event_double_competition_change,self.PlayDoubleCollectBuffChange,self)
    Event.AddListener(EventName.Event_double_competition_reward_change2,self.PlayDoubleRewardBuffChange,self)
    --Event.AddListener(EventName.Event_Check_Double_Activity,self.OnTaskUpdate,self)
    Event.AddListener(EventName.Event_Refresh_topCompetition_view,self.RefreshRank,self)
    Event.AddListener(EventName.Event_competition_receive_reward2,self.OnReceiveReward,self)
end

function TopCompetitionView:UnRegisterEvent()
    Event.RemoveListener(EventName.Event_show_competition_task,self.EnterHomeScene,self)
    Event.RemoveListener(EventName.Event_Activity_ReceiveReward,self.GetTaskRewardSucceed,self)
    Event.RemoveListener(EventName.Event_double_competition_change,self.PlayDoubleCollectBuffChange,self)
    Event.RemoveListener(EventName.Event_double_competition_reward_change2,self.PlayDoubleRewardBuffChange,self)
    -- Event.RemoveListener(EventName.Event_Check_Double_Activity,self.OnTaskUpdate,self)
    Event.RemoveListener(EventName.Event_Refresh_topCompetition_view,self.RefreshRank,self)
    Event.RemoveListener(EventName.Event_competition_receive_reward2,self.OnReceiveReward,self)
end

function TopCompetitionView:on_close()
    self.doubleCookiesRewards:Dispose()
end

function TopCompetitionView:OnDestroy()
    --self:OnDisable()
    self:DisposeFsm()
    self:Close()
end



function TopCompetitionView:SetSkip()
    self._fsm:ChangeState("CompetitionSkipState")
end

function TopCompetitionView:IsSkip()
    return self and self.isSkip or false
end

function TopCompetitionView:SkipCheckReward()
    if  quickTask and quickTask.completed then
        isGetReward = true
        ModelList.CompetitionModel:RemoveNearRound(quickTask.order)
        quickTask,quickTaskActivity = ModelList.CompetitionModel:GetQuickTaskActive()

        while quickTask and quickTask.completed do
            ModelList.CompetitionModel:RemoveNearRound(quickTask.order)
            quickTask,quickTaskActivity = ModelList.CompetitionModel:GetQuickTaskActive()
        end
    end
    self:SetSkipMaskShow(false)
end

function TopCompetitionView:SetSkipMaskShow(isShow)
    fun.set_active(self.btn_background,isShow)
    fun.set_active(self.btn_skip,isShow)
end

function TopCompetitionView:ShowDoubleSign(isDouble)
    if isDouble then
        fun.set_active(self.BackgroundNormal, false)
        fun.set_active(self.BackgroundDouble, true)    
    else
        fun.set_active(self.BackgroundNormal, true)
        fun.set_active(self.BackgroundDouble, false)
    end
end

return this
