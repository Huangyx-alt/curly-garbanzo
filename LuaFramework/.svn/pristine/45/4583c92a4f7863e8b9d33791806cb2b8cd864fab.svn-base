---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/8 17:08
---
local CardSignEffect = Clazz(ClazzBase, "CardSignEffect")
local this = CardSignEffect
require("View/Bingo/EffectPool/GoPool")
this.StarTrailsList = {}
local rewardXp =0
local rewardCoin =0
--- 是否需要隐藏格子背景bg_tip
local isNeedHideBg = 0


function CardSignEffect:SetCardView(cardView, effect)
    this.cardView = cardView
    this.effectEntry = effect
    local parent = ModelList.BattleModel:GetCurrBattleView()
    Cache.load_prefabs(AssetList["StarTrails"], "StarTrails", function(obj)
        GoPool.CreatePool("StarTrails", 2, 30, obj, parent:GetEffectObjContainerGO())
    end)
    this.StarTrailsList = {}
    local playId = ModelList.CityModel.GetPlayIdByCity()
    local curr_city = Csv.GetData("new_city_play", playId, "callreward")
    local curr_bet = ModelList.CityModel:GetBetRate()
    isNeedHideBg =  Csv.GetData("new_game_cell", playId, "hide_bg") == 1 and true or false
    rewardXp = curr_city[curr_bet][2]
    rewardCoin = curr_city[curr_bet][3]
    this.supplement = require("View.Bingo.EffectModule.Card.CardEffectSupplement.CardSignSupplement")
    this.supplement:Init()

end

function CardSignEffect:GetSignEffectObj(cardId, index, cardCell)
    if IsNull(cardCell) then
        cardCell = this.cardView:GetCardCell(cardId, index)
    end
    local ref_temp = fun.get_component(cardCell, fun.REFER)
    local effectObj = ref_temp:Get("ef_Bingo_click")
    return effectObj
end

--格子盖章效果
function CardSignEffect:SignCardEffect(cardId,index, cardCell, signType, delay, self_bingo, giftLen)
    signType = signType or 0
    delay = delay or 0
    Event.Brocast(EventName.Magnifier_Close_Single_Cell,cardCell,false)
   self:HideCellChild(cardCell, cardId)

    local effect =this.effectEntry:GetCellChip(cardId,index,cardCell)
    local play_name = this:GetBingoEffectName(signType, self_bingo)
    
    if signType == 1 then
        this.effectEntry:AddDelayAnima(effect, play_name, delay, 0.5, 2)
    elseif signType == 2 then
        this.effectEntry:AddDelayAnima(effect, play_name, delay, 0.5, 3)
    else
        --local effect = ref_temp:Get("ef_Bingo_click")
        --fun.set_active(effect,true )
        effect:Play(play_name)
    end

    if giftLen then
        local anima = fun.get_component(cardCell, fun.ANIMATOR)
        if anima  then
            if giftLen > 0 and signType == 0 then
                local giftEffect = BattleEffectPool:Get("cell_get_gift")
                this.supplement:SetEffectScale(giftEffect)
                fun.set_same_position_with(giftEffect,cardCell)
                BattleEffectPool:DelayRecycle("cell_get_gift",giftEffect,1)
            end
        end
    end
end


function CardSignEffect:HideCellChild(cardCell, cardId)
    local ref_temp = fun.get_component(cardCell, fun.REFER)
    local number1 = ref_temp:Get("number1")
    fun.set_active(number1, false)
    local number2 = ref_temp:Get("number2")
    fun.set_active(number2, false)
    local number3 = ref_temp:Get("number3")
    fun.set_active(number3, false)
    local number4 = ref_temp:Get("number4")
    fun.set_active(number4, false)
    local doublebg = ref_temp:Get("doublebg")
    fun.set_active(doublebg, false)    
    
    local Number1 = ref_temp:Get("Number1")
    fun.set_active(Number1, false)    
    local Number2 = ref_temp:Get("Number2")
    fun.set_active(Number2, false)
    
    if isNeedHideBg then
        local bg_tip = ref_temp:Get("bg_tip")
        fun.set_active(bg_tip, false)
    end
end

function CardSignEffect:GetBingoEffectName(sign, self_bingo)
    local play_name = ""
    if self_bingo then
        if sign == 2 then
            play_name = "ef_Bingopcard_click_bingo_show"
        elseif sign == 3 then
            play_name = "ef_Bingopcard_click_jackpot_show_blue"
        end
    else
        if sign == 1 then
            play_name = "bingo_show_red"
        elseif sign == 2 then
            play_name = "bingo_show"
        elseif sign == 3 then
            play_name = "jackpot_show"
        end
    end
    return play_name
end

function CardSignEffect:GetStarTrailsObj()
    local obj = BattleEffectPool:Get("StarTrails")
    table.insert(this.StarTrailsList, obj)
    return obj
end
function CardSignEffect:RecycleStarTrailsObj()
    if this.StarTrailsList  and #this.StarTrailsList>0 then
        if this.StarCount >0  and this.StarCount%MCT.RechargeStarCount == 0 then
            Event.Brocast(EventName.Sign_Star_End_To_PowerUp)
        end
        this.StarCount =  this.StarCount - 1
        local o = this.StarTrailsList[1]
        BattleEffectPool:Recycle("StarTrails", o)
        table.remove(this.StarTrailsList, 1)
    end
end


function CardSignEffect:ShowClickCellTip(cell, kick_error,num,doubleNum)
    if kick_error then
        --local nocall = tip.transform:Find("nocall")
        --fun.set_active(nocall, true)
        local obj = BattleEffectPool:Get("ClickNoCall",cell)
        BattleEffectPool:DelayRecycle("ClickNoCall",obj,2)
    else
        if not num  then num = 0 end
        if not doubleNum  then doubleNum = 0 end
        local isFastClick = BattleMachineList.GetMchine("CallNumberMachine"):IsFastClick(num,doubleNum)
        --local anima = fun.get_component(cell,fun.ANIMATOR)
        if isFastClick then
            --anima:Play("get_fast")
            local obj = BattleEffectPool:Get("CellGetFast",cell)
            fun.set_active(obj,false)
            fun.set_active(obj,true)
            BattleEffectPool:DelayRecycle("CellGetFast",obj,2)
        else
            local obj = BattleEffectPool:Get("CellGet",cell)
            fun.set_active(obj,false)
            fun.set_active(obj,true)
            this.supplement:SetEffectScale(obj)
            local xx = fun.find_child(obj,"xx")
            local txt = fun.get_component(xx,fun.OLDTEXT)
            if txt then
                txt.text = rewardXp
            end
            --local imgContainer = fun.get_component(xx,fun.IMAGESPRITESCONTAINER)
            --imgContainer:ShowSpriteByIndex(rewardXp)
            BattleEffectPool:DelayRecycle("CellGet",obj,2)
            --anima:Play("get")
        end
        if ModelList.BattleModel:GetBattleCompetition() then
            self:ShowCompetitionTip(cell)
        end
    end
    if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
        Event.Brocast(EventName.HangUpCell_RefreshWinningsXpAndCoinWithClick,rewardCoin, rewardXp)
    end
end

local competitionReward = 0
function CardSignEffect:ShowCompetitionTip(cell)
    BattleEffectCache:GetFreePrefabFromCache3("CompetitionCookieGet","CellChipContainer",2,cell,function(obj)
        if obj then
            local xx = fun.find_child(obj,"xx")
            if xx then
                local xxText = fun.get_component(xx,fun.TEXT)
                if xxText then
                    if not competitionReward then  competitionReward = ModelList.BattleModel:GetCurrModel():GetBattleCompetitionGameInfo("mark") end
                    xxText.text = competitionReward
                end
            end
        end
    end)
end

return this