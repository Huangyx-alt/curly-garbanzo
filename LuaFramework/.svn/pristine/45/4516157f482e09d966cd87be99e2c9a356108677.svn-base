---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 15610.
--- DateTime: 2022/3/18 11:25
---
local BattleDataTestView = BaseDialogView:New('BattleDataTestView')
local this = BattleDataTestView

this.Replay = require("Combat.Replay.ReplayMachine")

this.viewType = CanvasSortingOrderManager.LayerType.Tips
this.auto_bind_ui_items = {
    "btn_close_self",
    "btn_gm",
    "Placeholder",
    "cmd",
    "InputField",
    "textClone",
    "Scroll View",
    "btn_loadFile",
    "Content",
    "btn_auto"
}

function BattleDataTestView.Awake(obj)
    --this.update_x_enabled = true
    this:on_init()
end

function BattleDataTestView.OnEnable()
    Facade.RegisterView(this)
end

function BattleDataTestView:GetRootView()
    if SceneViewManager.gobal_layer == nil then
        SceneViewManager.gobal_layer = UnityEngine.GameObject.FindWithTag("GlobalUiRoot")
    end
    local parent = SceneViewManager.gobal_layer
    return parent
end

function BattleDataTestView:on_x_update()


end

function BattleDataTestView.OnDisable()

end

function BattleDataTestView.OnDestroy()
    this:Destroy()
end

function BattleDataTestView:on_close()


end

function BattleDataTestView:CloseFunc()
    Facade.SendNotification(NotifyName.CloseUI, ViewList.BattleDataTestView)
end

function BattleDataTestView:ShowTip(tipName)

end

function BattleDataTestView:InitTip()

end

function BattleDataTestView:on_btn_close_click()
    ModelList.GMModel:Reset()
    Facade.SendNotification(NotifyName.CloseUI, ViewList.BattleDataTestView)
end

function BattleDataTestView:getRandom(n)
    local t = {
        "0", "1", "2", "3", "4", "5", "6", "7", "8", "9",
        "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z",
        "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z",
    }
    local s = ""
    for i = 1, n do
        s = s .. t[math.random(#t)]
    end ;
    return s
end

function BattleDataTestView:on_btn_close_self_click()

    Facade.SendNotification(NotifyName.CloseUI, ViewList.BattleDataTestView)

end

function BattleDataTestView:EnterGame(code, msg, data)
    log.log("自动登录返回", code, data)
    --Facade.SendNotification(NotifyName.CommonTip, "Facebook_fail")
    local t = {}
    local func = function(openid, token, device_id, platform)
        if not openid or not token or openid == "" or token == "" then
            log.log("请登录数据失败")
            return
        end
        t.openid = tostring(openid)
        t.token = tostring(token)
        t.platform = tonumber(platform)
        t.idfa = device_id

        t.deviceToken = "editor" --FirebaseHelper.LocalDeviceToken or "editor"

        t.appsflyerId = "editor" --SDK.GetAppFlyerId() or "editor"
        log.log(
                "请求登录\nopenid =", t.openid,
                "\ntoken =", t.token,
                "\nplatform =", t.platform,
                "\ndevideId =", t.deviceId
        )
        local score = fun.get_int("mobile_score", 0)--性能评分
        t.score = score
        t.version = tostring(UIUtil.get_client_version())
        Http.session_id = data.sessionId
        --Facade.SendNotification(NotifyName.CommonTip, "Facebook_fail")
    end

    func("1234", "1234", "1234", "1234")

end

function BattleDataTestView.PrintTable(t, name)
    local spaceAdd = 4
    local function getTableStr(t, name, space)
        local str = string.format("%s%s = {\n", string.rep(" ", space - spaceAdd), (name or "table"))
        local init = false
        for k, v in pairs(t) do
            if type(v) == "table" then
                str = str .. getTableStr(v, k, space + spaceAdd)
            else
                if type(v) == "string" and string.len(v) > 2 and string.sub(v, 1, 3) == "cs." then
                    init = true
                end
                str = str .. string.format("%s%s = %s\n", string.rep(" ", space), k, v)
            end
        end
        str = str .. string.rep(" ", space - spaceAdd) .. "}\n"
        return str
    end
    if (type(t) == "table") then
        print("\n" .. getTableStr(t, name, spaceAdd))
    else
        print(t)
    end
end

function BattleDataTestView:StrToTable(str)
    if str == nil or type(str) ~= "string" then
        return
    end

    return loadstring("return " .. str)()
end

function BattleDataTestView:on_btn_gm_click()
    local txt = this.InputField.text
    if txt == "5001" then
        return
    end
    if #txt < 50 then
        log.r("数据过短,检查一下")
        return
    end
    if fun.starts(txt,"http") then
        txt = this:HandleUrlContent(txt)
    end
    local text = JsonToTable((txt))
    table.each(text and text.jackpotRuleId, function(k, v)
        text.jackpotRuleId[k] = tonumber(v)
    end)
    
    --local playid = text.playId  -- ModelList.CityModel.GetPlayIdByCity(1)
    local playid = 1
    local gameType = Csv.GetData('new_city_play',playid,"play_type")
    local cityId = Csv.GetData('new_city_play',playid,"city_id")
    ModelList.BattleModel:SetGameType(playid)
    ModelList.CityModel.SetPlayId(playid)

    --编辑器模式下load asset
    if GameUtil.is_windows_editor() then
        local modularData = table.find(Csv["modular"], function(k, v)
            return v.city_play_id == playid
        end)
        if modularData and modularData.modular_name then
            ModelList.BattleModel.RequireModuleLua(modularData.modular_name)
        end
    end
    
    --if gameType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
    --    Facade.SendNotification(NotifyName.ShowUI, ViewList.WinZoneLoadingGameView,nil,nil,procedure)
    --else
    --    Facade.SendNotification(NotifyName.ShowUI, ViewList.SceneLoadingGameView,nil,nil,procedure) 
    --end
    
    BingoBangEntry.IsReplayBattle = true
    
    local CmdEnterBattle = require "Logic.Command.Battle.Enter.CmdEnterBattle"
    local cmd = CmdEnterBattle.New()
    cmd:Execute()

    local procedure = nil
    if gameType == PLAY_TYPE.PLAY_TYPE_NORMAL then
        Message.DispatchMessage(MsgIDDefine.PB_BingoGameLoad, 0, text)
        procedure = ProcedureNormalGame:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_COCKTAIL then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_COCKTAIL, 0, text)
        procedure = ProcedureHawaiiGame:New()
    end


    Facade.SendNotification(NotifyName.CloseUI, ViewList.BattleDataTestView)
end

-- 分割字符串
function split(str,reps)
    local resultStrList = {}
    string.gsub(str,'[^'..reps..']+',function (w)
        table.insert(resultStrList,w)
    end)
    return resultStrList
end

function BattleDataTestView:HandleUrlContent(url)
    local http = require("socket.http")
    local resp = http.request(url)

     local resp1 = string.split(resp,"posList不存在99")[1]

    local resp2 = string.split(resp1,"loadGame 返回值")[2]
    --print(resp2)
    local data = string.split(resp2,"预结算数据")
    local resp3 = data[1]
    --print(resp3)
    local loadData = string.split(resp3, "<br>")[1]

    local data = string.split(resp2,"预结算数据")
    local loadData = string.split(data[1], "<br>")[1]
    --print("loadData")
    --print(loadData)
    local settleData2 = nil
    local settleData1 = nil
    if #data == 1 then
        settleData2 = string.split(data[1],"结算数据")[2]
        if settleData2 then
            settleData2 = string.gsub(settleData2,"<br>","")
            print("settleData2")
            print(settleData2)
        end
    else
        local settle = string.split(data[2], "<br>")
        --print(settle[1])
        --print(settle[2])
          settleData1 = string.gsub(settle[1],"结算数据","")
        print("settleData1")
        print(settleData1)
        settleData2 = string.gsub(settle[2],"结算数据","")
        print("settleData2")
        print(settleData2)
    end
    local path1 = string.gsub(UnityEngine.Application.dataPath, "/Assets", "") .. "/tool/moni/settle1"
    if settleData1 then
        settleData1 = string.gsub(settleData1,"nickName\":0","nickName\":\"0\"")
        file_save(path1,settleData1)
    else
        local rm_file = os.remove(path1);
    end
    local path2 = string.gsub(UnityEngine.Application.dataPath, "/Assets", "") .. "/tool/moni/settle2"
    if settleData2 then
        settleData2 = string.gsub(settleData2,"nickName\":0","nickName\":\"0\"")
        file_save(path2,settleData2)
    else
        local rm_file = os.remove(path2);
    end
    return loadData
end

function BattleDataTestView:readAll(file)
    local f = assert(io.open(file, "rb"))
    local content = f:read("*all")
    f:close()
    return content
end

function BattleDataTestView:on_btn_select_click()
    this.Replay:Start()
end

function BattleDataTestView:on_btn_loadFile_click()
    local path = string.gsub(UnityEngine.Application.dataPath, "/Assets", "") .. "/tool/recorder/"
    local files = Util.GetAllFiles(path)
    for i = 0, files.Length - 1 do
        local file_path = files[i]
        print(file_path)
        local obj = fun.get_instance(this.textClone, this.Content)
        local text = fun.get_component(obj, "Text")
        fun.set_active(obj, true)
        local button = fun.get_component(obj, fun.LUABEHAVIOUR)
        button:AddClick(obj, function(o)
            local text = fun.get_component(o, "Text")
            this.Replay:Start(text.text)
        end)
        text.text = file_path
        --print(strippath(file_path))
    end
end
function BattleDataTestView:on_btn_auto_click()
    local path = string.gsub(UnityEngine.Application.dataPath, "/Assets", "") .. "/tool/moni/data"
    local txt = this:readAll(path)


    if txt == "5001" then
        return
    end
    if #txt < 50 then
        log.r("数据过短,检查一下")
        return
    end
    local playid = ModelList.CityModel.GetPlayIdByCity(1)
    ModelList.BattleModel:SetGameType(playid)
    local gameType = Csv.GetData('new_city_play',playid,"play_type")
    --Cache.Load_Atlas(AssetList["SceneLoadingGameAtlas"], "SceneLoadingGameAtlas", function()
    --    LoadScene("SceneLoadingGame", ViewList.SceneLoadingGameView,nil,ProcedureLeeToleMan:New())
    --end)
    local text = JsonToTable((txt))

    local playid = text.playId  -- ModelList.CityModel.GetPlayIdByCity(1)
    local gameType = Csv.GetData('new_city_play',playid,"play_type")
    ModelList.BattleModel:SetGameType(playid)
    ModelList.CityModel.SetPlayId(playid)

    --编辑器模式下load asset
    if GameUtil.is_windows_editor() then
        local modularData = table.find(Csv["modular"], function(k, v)
            return v.city_play_id == playid
        end)
        ModelList.BattleModel.RequireModuleLua(modularData.modular_name)
    end
    ModelList.BattleModel:GetCurrModel():SetReadyState(1)
    local procedure = nil
    if gameType == PLAY_TYPE.PLAY_TYPE_NORMAL then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_DEFAULT, 0, text)
        procedure = ProcedureNormalGame:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_COCKTAIL then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_COCKTAIL, 0, text)
        procedure = ProcedureHawaiiGame:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_CHRISTMAS then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_CHRISTMAS, 0, text)
        procedure = ProcedureChristmasGame:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_GREEN_HEAD then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_GREEN_HEAD, 0, text)
        local ProcedureLeeToleMan = require "Procedure/ProcedureLeeToleMan"
        procedure = ProcedureLeeToleMan:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_WOLF then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_WOLF, 0, text)
        local ProcedureLeeToleMan = require "Procedure/ProcedureSingleWolf"
        procedure = ProcedureLeeToleMan:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_AUTO, 0, text)
        procedure = ProcedureHangUp:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_JEWEL_QUEEN then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_JEWEL_QUEEN, 0, text)
        procedure = ProcedureGemQueen:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_LOOK_FOR_CANDY then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_LOOK_FOR_CANDY, 0, text)
        procedure = ProcedureCandy:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_NEW_CHRISTMAS then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_NEW_CHRISTMAS, 0, text)
        procedure = ProcedureNewChristmas:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_VICTORY_BEATS, 0, text)
        procedure = ProcedureWinZone:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_GOLDEN_PIGGY then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_GOLDEN_PIGGY, 0, text)
        procedure = ProcedureGoldenPig:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_GOLDEN_DRAGON then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_GOLDEN_DRAGON, 0, text)
        procedure = ProcedureDragonFortune:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_NEW_GREEN_HEAD then
        Message.DispatchMessage(MSG_ID.MSG_GAME_NEW_GREEN_HEAD, 0, text)
        procedure = ProcedureNewLeetoleMan:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_EASTER_DAY then
        Message.DispatchMessage(MSG_ID.MSG_GAME_EASTER_DAY, 0, text)
        procedure = ProcedureEaster:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_VOLCANO_PATH then
        Message.DispatchMessage(MSG_ID.MSG_GAME_VOLCANO_PATH, 0, text)
        procedure = ProcedureVolcano:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_CAT_THIEF then
        Message.DispatchMessage(MSG_ID.MSG_GAME_CAT_THIEF, 0, text)
        procedure = ProcedureThieves:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_MINING then
        Message.DispatchMessage(MSG_ID.MSG_GAME_MINING, 0, text)
        procedure = ProcedureMoleMiner:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_BISON then
        Message.DispatchMessage(MSG_ID.MSG_GAME_BISON, 0, text)
        procedure = ProcedureBison:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_HORSE_RACE then
        Message.DispatchMessage(MSG_ID.MSG_GAME_HORSE_RACE, 0, text)
        procedure = ProcedureHorseRacing:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_SCRATCH_WINNER then
        Message.DispatchMessage(MSG_ID.MSG_GAME_SCRATCH_WINNER, 0, text)
        procedure = ProcedureScratchWinner:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_GOLD_TRAIN then
        Message.DispatchMessage(MSG_ID.MSG_GAME_GOLD_TRAIN, 0, text)
        procedure = ProcedureGoldenTrain:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_CHRISTMAS_SYNTHESIS then
        Message.DispatchMessage(MSG_ID.MSG_GAME_CHRISTMAS_SYNTHESIS, 0, text)
        local christmasSyn = require("Procedure/ProcedureChristmasSynthesis")
        procedure = christmasSyn:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_THREE_PIGS then
        Message.DispatchMessage(MSG_ID.MSG_GAME_THREE_PIGS, 0, text)
        local pd = require("Procedure/ProcedureGotYou")
        procedure = pd:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_LET_THEM_ROLL then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_LET_THEM_ROLL, 0, text)
        local pd = require("Procedure/ProcedureLetemRoll")
        procedure = pd:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_PIGGY_BANK then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_PIGGY_BANK, 0, text)
        local pd = require("Procedure/ProcedurePiggyBank")
        procedure = pd:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_SOLITAIRE then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_SOLITAIRE, 0, text)
        local pd = require("Procedure/ProcedureSolitaire")
        procedure = pd:New()
    elseif gameType == PLAY_TYPE.PLAY_TYPE_MONOPOLY then
        Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_MONOPOLY, 0, text)
        local pd = require("Procedure/ProcedureMonopoly")
        procedure = pd:New()
    end
    if gameType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
        Facade.SendNotification(NotifyName.ShowUI, ViewList.WinZoneLoadingGameView,nil,nil,procedure)
    else
        Facade.SendNotification(NotifyName.ShowUI, ViewList.SceneLoadingGameView,nil,nil,procedure)
    end
    Facade.SendNotification(NotifyName.CloseUI, ViewList.BattleDataTestView)
    BingoBangEntry.IsReplayBattle = true
end



function BattleDataTestView:ReadFromUrl()
    local url  = "http://livepartybingo.test.51chivalry.com:8080/t.php?gameId=445591254630801408"
    local wr = UnityEngine.Networking.UnityWebRequest(url);
    --print()
end

return this


