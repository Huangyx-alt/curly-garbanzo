---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/6/27 10:24
---
--- 应用类引导,常驻游戏事件中

local ApplicationGuideModel = BaseModel:New("ApplicationGuideModel")
local this = ApplicationGuideModel
local Input = UnityEngine.Input
local LastInputTime = 0
local currViewName = nil

local function CreatGuideInfo()
    this.viewList ={}
    for _,v in  ipairs(Csv.new_guide_app) do
        --log.r("view   "..v.view)
        local o = nil
        if pcall(function()require("Guide.ApplicationGuide."..v.view.."Guide")  end) then
            o  = require("Guide.ApplicationGuide."..v.view.."Guide")
        end
        if o and type(o)~= "function" then
            o.AddData(o,v)
            if not fun.is_key_include(v.view,this.viewList) then
                this.viewList[v.view] = o
            end
        end
    end
end


function ApplicationGuideModel:InitData(...)
    CreatGuideInfo()
end

---@return ApplicationGuideInfo
function ApplicationGuideModel:LoadGuide(viewName)
    if ModelList.GuideModel:IsGuiding() then
        return
    end
    if fun.is_key_include(viewName, this.viewList) then
        local li = this.viewList[viewName]
        if this.viewList[viewName].GetEndLevel(this.viewList[viewName]) >= ModelList.PlayerInfoModel:GetLevel() then
            currViewName = viewName
            li:Init()
        end
    end
end


function ApplicationGuideModel:UnloadGuide(viewName)
    if fun.is_key_include(viewName,this.viewList) then
        this.viewList[viewName]:Remove()
        currViewName = nil
    end
end

local function ResetInputTime()
    LastInputTime = UnityEngine.Time.time
end

function ApplicationGuideModel.CheckAnyInput()
    if UnityEngine.Application.platform == UnityEngine.RuntimePlatform.Android then
        if Input.touches.Length  >0 then
            ResetInputTime()
        end
    else
        if Input.anyKeyDown  then
            ResetInputTime()
        end
    end
end

function ApplicationGuideModel.IsInputSilence(timeInterval)
    return UnityEngine.Time.time  - LastInputTime >= timeInterval
end

--- 界面层级刷新，检查应用引导是否需要隐藏
function ApplicationGuideModel.ChangeViewSortLayer()
    if currViewName ~= nil then
        local str_view = this.viewList[currViewName].data and  this.viewList[currViewName].data[1].string_view  or "0"
        this.viewList[currViewName].CheckHide(currViewName,str_view)
        LuaTimer:SetDelayFunction(0.5,function()
            if currViewName ~= nil then
                local str_view = this.viewList[currViewName].data and  this.viewList[currViewName].data[1].string_view  or "0"
                this.viewList[currViewName].CheckHide(currViewName,str_view)
            end
        end)
    end
end

--- 有界面关闭，检查应用引导是否需要展示
function ApplicationGuideModel.ChangeViewSortLayer2()
    if currViewName ~= nil then
        local str_view =  this.viewList[currViewName].data and  this.viewList[currViewName].data[1].string_view  or "0"
        this.viewList[currViewName]:CheckShow(currViewName,str_view)
    end
end

function ApplicationGuideModel.ClearAllGuide()
    if currViewName then
        local str_view =  this.viewList[currViewName].data and  this.viewList[currViewName].data[1].string_view  or "0"
        this.viewList[currViewName].CheckHide(currViewName,str_view)
        this:UnloadGuide(currViewName)
    end
end

--this.MsgIdList =
--{
--
--}

return this