---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/7/18 18:55
---

local SettleTransitionHideEffectState = Clazz(BaseFsmState, "SettleTransitionHideEffectState")

function SettleTransitionHideEffectState:OnEnter(fsm, previous, ...)
    self._fsm = fsm
    self:HandleRound()
    self:HandleGuide()
end

function SettleTransitionHideEffectState:OnLeave(fsm)

end

function SettleTransitionHideEffectState:HandleGuide(fsm)
    if ModelList.GuideModel:IsSecondBattle() then
        ModelList.GuideModel:GetGuideAction().ClearShowEffect()
    end
    if ModelList.GuideModel:IsFirstBattle() then
        ModelList.GuideModel:GetGuideAction():HideFirstBattlePowerFinger()
    end
end

--- 重复检测三次以上没有特效了，就表示特效已经全部播放完毕了
local skilEmptySureCount = 0

function SettleTransitionHideEffectState:HandleRound()
    self.ReqDelayLoop = nil
    self.can_round1_exit = false
    skilEmptySureCount = 0
    if ModelList.BattleModel:GetCurrBattleView().effectObjContainer then
        local isSkillEmpty = ModelList.BattleModel:GetCurrBattleView().effectObjContainer:IsSkillContainerEmpty()
        if isSkillEmpty then
            skilEmptySureCount = skilEmptySureCount + 1
        else
            skilEmptySureCount = 0
        end
        if isSkillEmpty and skilEmptySureCount >= 3 then
            self.can_round1_exit = true
            self:ChangeNext()
        else
            if self.ReqDelayLoop then
                LuaTimer:Remove(self.ReqDelayLoop)
                self.ReqDelayLoop = nil
            end
            self.ReqDelayLoop = LuaTimer:SetDelayLoopFunction(0.2, 0.2, 500, function ()
                if fun.is_null(ModelList.BattleModel:GetCurrBattleView() or fun.is_null(ModelList.BattleModel:GetCurrBattleView().effectObjContainer)) then
                    LuaTimer:Remove(self.ReqDelayLoop)
                    self.ReqDelayLoop = nil
                    return
                end
                local isSkillEmpty = ModelList.BattleModel:GetCurrBattleView().effectObjContainer:IsSkillContainerEmpty()
                if isSkillEmpty then
                    skilEmptySureCount = skilEmptySureCount + 1
                else
                    skilEmptySureCount = 0
                end
                if isSkillEmpty and skilEmptySureCount >= 3 then
                    LuaTimer:Remove(self.ReqDelayLoop)
                    self.ReqDelayLoop = nil
                end
            end, function ()
                if not self.can_round1_exit then
                    self:ChangeNext()
                end
                self.can_round1_exit = true
            end, nil, LuaTimer.TimerType.BattleUI)
        end
    else
        self:ChangeNext()
        self.can_round1_exit = true
    end
end

function SettleTransitionHideEffectState:ChangeNext()
    if not ModelList.BattleModel:GetCurrModel():IsGameSettling() then
        local IsQuitBattle = ModelList.BattleModel.IsQuitBattle()
        ModelList.BattleModel:GetCurrModel():ReqQuitBingoGame(IsQuitBattle)
    end
    self:ChangeState(self._fsm, "SettleTransitionEnterState")
end

return SettleTransitionHideEffectState
