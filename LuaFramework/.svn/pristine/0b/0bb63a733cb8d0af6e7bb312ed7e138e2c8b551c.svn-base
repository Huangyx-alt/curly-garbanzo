---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/4/18 9:37
---


local TournamentHelperItem = require "View/Tournament/TournamentHelperItem"

require "State/Common/CommonState"

local CompetitionHelperView = BaseView:New("DailyCompetitionCookieHelperView")
local this = CompetitionHelperView
this.viewType = CanvasSortingOrderManager.LayerType.TopConsole

this.auto_bind_ui_items = {
    "btn_close",
    "content",
    "item",
    "anima",
    "btn_continue",
}
local isPopup = false
function CompetitionHelperView:Awake(obj)
    self:on_init()
end

function CompetitionHelperView:OnEnable(params)
    Facade.RegisterView(self)
    CommonState.BuildFsm(self,"CompetitionHelperView")
    isPopup = params
    --self:SetTrounamentReward()
    ModelList.CompetitionModel.SetPrefsString("competition_last_show")
    self._fsm:GetCurState():DoOriginalAction(self._fsm,"CommonState1State",function()
        AnimatorPlayHelper.Play(self.anima,{"start","BingoPassHelperView_start"},false,function()
            self._fsm:GetCurState():DoCommonState1Action(self._fsm,"CommonOriginalState")
        end)
    end)
end

function CompetitionHelperView:OnDisable()
    Facade.RemoveView(self)
    CommonState.DisposeFsm(self)
end

function CompetitionHelperView:on_btn_close_click()
    self._fsm:GetCurState():DoOriginalAction(self._fsm,"CommonState1State",function()
        if isPopup then
            Event.Brocast(EventName.Event_popup_activity_double_cookie_finish)
        end
        AnimatorPlayHelper.Play(self.anima,{"end","BingoPassHelperView_end"},false,function()
            Facade.SendNotification(NotifyName.CloseUI,this)
        end)
    end)
end

function CompetitionHelperView:on_btn_continue_click()
    self._fsm:GetCurState():DoOriginalAction(self._fsm,"CommonState1State",function()
        if isPopup then
            Event.Brocast(EventName.Event_popup_activity_double_cookie_finish)
        end
        AnimatorPlayHelper.Play(self.anima,{"end","BingoPassHelperView_end"},false,function()
            Facade.SendNotification(NotifyName.CloseUI,this)
        end)
    end)
end

function CompetitionHelperView:SetTrounamentReward()
    local rewardItemList = {}
    local tiers,difficulty = ModelList.TournamentModel:GetTiers()
    local csvData = ModelList.TournamentModel.GetTournamentCsvData()
    for index, value in ipairs(csvData) do
        if value.difficulty == difficulty and value.ranking_section == 2  then
            if value.daily_reward then
                table.insert(value.reward ,
                        {
                            [1] = Resource.dailycoins_bonus,
                            [2] = value.daily_reward
                        }
                )
            end
            table.insert(rewardItemList,value)
        end
    end
    for i = #rewardItemList, 1,-1 do
        local go = fun.get_instance(self.item,self.content)
        local item = TournamentHelperItem:New(rewardItemList[i])
        item:SkipLoadShow(go)
        fun.set_active(go.transform,true)
    end
    --[[
    for index, value in ipairs(rewardItemList) do
        local go = fun.get_instance(self.item,self.content)
        local item = TournamentHelperItem:New(value)
        item:SkipLoadShow(go)
        fun.set_active(go.transform,true)
    end
    --]]
end


return this