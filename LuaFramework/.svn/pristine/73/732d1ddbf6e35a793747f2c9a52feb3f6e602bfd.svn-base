---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/12/14 17:08
---
local CallNumberBaseState = require("View/Bingo/CallNumberState/CallNumberBaseState")
local CallNumberDropState = Clazz(CallNumberBaseState, "CallNumberDropState")
local this = CallNumberDropState
local NormalOffset = 155    --横条栏内的球，移动距离  掉落球的横移距离  （因为UI设计，掉落球的移动距离不一样） (新版本又一样了)
local dropPos = { x = -214, y = 75, z = 0 }
local callData = nil
local dropBallAnima = nil
local maxShowBallCount = 5

function CallNumberDropState:New()
    local o = {}
    setmetatable(o, { __index = CallNumberDropState })
    return o
end

function CallNumberDropState:InitState()
    this.rollList = {}  --用来查找最后一个球
    this.totalCallIndex = 0 --一共叫了几个号
end

function CallNumberDropState:OnEnter(fsm, previous,data)
    callData = data
    self._fsm = fsm
    self._owner = fsm:GetOwner()
    this.totalCallIndex = this.totalCallIndex or 0
    this.totalCallIndex = this.totalCallIndex + 1
    self:DropBallEffect()
end

function CallNumberDropState:DropBallEffect()
    --self._owner:PlayNumberDropEffect(0)
    --if #self.rollList == 0 then
        --当前叫号的球在第一个位置出现
        local newBall = self:ShowDropBall()
    --    return 
    --end
    
    --最后一个球消失
    if #self.rollList == maxShowBallCount then
        local lastBall = self.rollList[maxShowBallCount]
        self.rollList[maxShowBallCount] = nil
        --消失动画
        fun.play_animator(lastBall, "end")
        LuaTimer:SetDelayFunction(0.25, function()
            --回收球
            fun.set_active(lastBall, false)
        end)
    end
    
    --第一个球至倒数第一个球向右移动
    for i = 1, #self.rollList do
        --最后一个球不移动
        if i < maxShowBallCount then
            local ball = self.rollList[i]
            local mPos, offset = ball.transform.localPosition, NormalOffset

            if i == 1 then
                --变小
                fun.play_animator(ball, "move")
                offset = offset + 14
            else
                fun.play_animator(ball, "idle")
            end
            Anim.move_to_xy_local_ease(ball.gameObject, mPos.x + offset, mPos.y, MCT:Get("bingo_call_ball_horizion_move_time"))
        end
    end

    table.insert(this.rollList, 1, newBall)
end

--显示新叫号
function CallNumberDropState:ShowDropBall()
    --local currNumber = self._owner.model:GetCurrCallNumber()
    local currNumber = callData
    
    local ball = self:GetNextBall()
    
    --设当前叫号数字
    self:SetBallNumber(currNumber.currNumber, ball, currNumber.bingo)
    
    --当前叫号球位置
    fun.set_gameobject_pos(ball.gameObject, dropPos.x, dropPos.y, dropPos.z, true)
    fun.set_gameobject_scale(ball.gameObject, 1.3, 1.3, 1)
    fun.set_active(ball, true)
    
    --出现动画
    fun.play_animator(ball, "enter", true)
    
    --self._owner:PlayNumberDropEffect(currNumber.bingo and 2 or 1)
    --self._owner:PlayCallSuperMatch(ball,currNumber.isSuperMatch)
    
    --音效
    self:PlayCallAudio()
    
    LuaTimer:SetDelayFunction(0.3, function()
        --号球掉落后的回调
        self._owner:CallDropBallcb(currNumber.currNumber)
        -- 掉落球不播放星光特效到Powerup卡
        --self._owner:CallNumberBallStarTrailsToSuperMatchCard(ball)
        self:Finish()
    end)
    
    --self._owner.dropBallTemp = self._owner.ballList[self.dropBallIndex]
    --table.insert(self.rollList, self._owner.ballList[self.dropBallIndex])
    
    return ball
end

-----B  I  N  G  O 字母的颜色值
--local Bingo_Color ={ Color(0.5703125, 0, 0.02734375, 1),
--                     Color(0.46875, 0.22265625, 0.00390625, 1),
--                     Color(0.03125, 0.4609375, 0.0390625, 1),
--                     Color(0.0234375, 0.21484375, 0.64453125, 1),
--                     Color(0.49609375, 0.0390625, 0.5546875, 1)}
local Bingo_Num_Txt = {"B","I","N","G","O"}

-- 设置掉落球的号码
function CallNumberDropState:SetBallNumber(ballNumber, ball)
    local ref_temp = fun.get_component(ball, fun.REFER)
    local ballImage = ref_temp:Get("ball")
    local ballType = ref_temp:Get("ballType")
    ballType.sprite = nil
    ballImage.sprite = nil
    local spriteName = 0
    local text= "B"
    if ballNumber >= 61 then
        spriteName = 5
        ballType.sprite =self._owner:GetBallLetter(5)
        text= Bingo_Num_Txt[5]
        --ballType.text = Bingo_Num_Txt[5]
        --ballType.color = Bingo_Color[5]
    elseif ballNumber >= 46 then
        spriteName = 4
        ballType.sprite =self._owner:GetBallLetter(4)
        text= Bingo_Num_Txt[4]
        --ballType.text = Bingo_Num_Txt[4]
        --ballType.color = Bingo_Color[4]
    elseif ballNumber >= 31 then
        spriteName = 3
        ballType.sprite =self._owner:GetBallLetter(3)
        text= Bingo_Num_Txt[3]
        --ballType.text = Bingo_Num_Txt[3]
        --ballType.color = Bingo_Color[3]
    elseif ballNumber >= 16 then
        spriteName = 2
        ballType.sprite =self._owner:GetBallLetter(2)
        text= Bingo_Num_Txt[2]
        --ballType.text = Bingo_Num_Txt[2]
        --ballType.color = Bingo_Color[2]
    else
        spriteName = 1
        ballType.sprite =self._owner:GetBallLetter(1)
        text= Bingo_Num_Txt[1]
        --ballType.text = Bingo_Num_Txt[1]
        --ballType.color = Bingo_Color[1]
    end
    --Event.Brocast(EventName.CardEffect_Letter_Effect,text)
    ballImage.sprite = self._owner.ball_sprite_list[spriteName]
    
    ballType:SetNativeSize()
    
    --大于9号要双位显示
    local Number = fun.find_child(ball, "Number")
    local NumberText = fun.get_component(Number, fun.TEXT)
    NumberText.text = ballNumber
    
    --if ballNumber > 9 then
    --    local first_num = math.modf(ballNumber / 10)
    --    local second_num = math.modf(ballNumber % 10)
    --    if second_num == 0 then
    --        second_num = 10
    --    end
    --    local child2 = fun.find_child(ball, "number1")
    --    local number1 = fun.get_component(child2, fun.IMAGE)
    --    number1.gameObject:SetActive(true)
    --    --number1.sprite = self._owner.number_sprite_list[first_num]
    --    self:GetCallNumber(number1,first_num,self._owner,ballNumber)
    --    fun.set_rect_local_pos_x(number1, -18)
    --    local child3 = fun.find_child(ball, "number2")
    --    local number2 = fun.get_component(child3, fun.IMAGE)
    --    number2.gameObject:SetActive(true)
    --    --number2.sprite = self._owner.number_sprite_list[second_num]
    --    self:GetCallNumber(number2,second_num,self._owner,ballNumber)
    --    fun.set_rect_local_pos_x(number2, 18)
    --else
    --    local first_num = math.modf(ballNumber % 10)
    --    local child2 = fun.find_child(ball, "number1")
    --    local number1 = fun.get_component(child2, fun.IMAGE)
    --    number1.gameObject:SetActive(true)
    --    --number1.sprite = self._owner.number_sprite_list[first_num]
    --    self:GetCallNumber(number1,first_num,self._owner,ballNumber)
    --    fun.set_rect_local_pos_x(number1, 0)
    --    local child3 = fun.find_child(ball, "number2")
    --    child3.gameObject:SetActive(false)
    --end
    --fun.set_gameobject_scale(ball.gameObject, 1.12, 1.12, 1)
end

function CallNumberDropState:PlayCallAudio()
    Event.Brocast(EventName.SoundMachine_Call_Number_Audio,callData.currNumber,callData.bingo)
end

function CallNumberDropState:GetCallNumber(sprite,index,owner,ballNumber)
    if ModelList.BattleModel.GetIsJokerMachine() then
        local str = "Red"
        if ballNumber > 60 then str = "Purple"
        elseif ballNumber > 45 then str = "Blue"
        elseif ballNumber > 30 then str = "Green"
        elseif ballNumber > 15 then str = "Yellow"   end
        if index == 10 then index = 0 end
        sprite.sprite = AtlasManager:GetSpriteByName("JokerBattleAtlas",str..index)
    else
        sprite.sprite = owner.number_sprite_list[index]
    end
end

--取一个用来叫号的球
function CallNumberDropState:GetNextBall()
    for i = 1, #self._owner.ballList do
        local ball = self._owner.ballList[i]
        if not fun.get_active_self(ball) then
            return ball
        end
    end
end

function CallNumberDropState:Finish()
   --self._owner.CompleteDropBall()
    self._fsm :ChangeState("CallNumberCompleteState",callData.currNumber)
end

function CallNumberDropState:OnLeave(fsm)
    self._fsm = nil
    self._owner = nil
    self._posX = nil
     callData = nil
     dropBallAnima = nil
end

function CallNumberDropState:Dispose()
    self:OnLeave(nil)
end

--没用到
function CallNumberDropState:WaitAnimatorComplete(fsm)
    local  dropBall = fsm:GetOwner():GetDropBall()
    if dropBall then
        dropBallAnima  = fun.get_component(dropBall,fun.ANIMATOR)
    end
    self:start_x_update()
end

--没用到
function CallNumberDropState:on_x_update()
    if dropBallAnima then
        if dropBallAnima:GetCurrentAnimatorStateInfo(0) .normalizedTime >0.95  then
            self:stop_x_update()
            self:Finish()
        end
    end
end

return this