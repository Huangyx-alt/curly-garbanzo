---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/4/17 14:30
---

require "State/Common/CommonState"
require "View/CommonView/RemainTimeCountDown"

local CompetitionRewardEnter = require("State.Competition.RewardView.CompetitionRewardEnter")
local CompetitionRewardIdle = require("State.Competition.RewardView.CompetitionRewardIdle")
local CompetitionRewardReq = require("State.Competition.RewardView.CompetitionRewardReq")
local CompetitionRewardReward = require("State.Competition.RewardView.CompetitionRewardReward")

local CompetitionRankRewardView = BaseView:New("DailyCompetitionCookieSettleView","CompetitionCookieAtlas")
local this = CompetitionRankRewardView
this.viewType = CanvasSortingOrderManager.LayerType.TopConsole
--this.isCleanRes = true
local canClick = true

this.auto_bind_ui_items = {
    "btn_continue",
    "SmallRewardContent",
    "SmallRewardItem",
    "anima",
    "SmallDoubleFlag",
    "BigPrize",
    "SmallPrize",
    "BigRewardContent",
    "BigDoubleFlag",
    "BigRewardItem",
    "top",
    "normal",
    "rankTxt",
}

local rewardItemsCache = nil
local myRankOrder = 1

function CompetitionRankRewardView:Awake(obj)
    self:on_init()
end

function CompetitionRankRewardView:OnEnable(params)
    self:BuildFsm()
    self:RegisterEvent()
    canClick = true
end

function CompetitionRankRewardView:BuildFsm()
    FsmCreator:Create("CompetitionRankRewardView",self,{
        CompetitionRewardEnter:New(),
        CompetitionRewardIdle:New(),
        CompetitionRewardReq:New(),
        CompetitionRewardReward:New(),
    })
    self._fsm:StartFsm("CompetitionRewardEnter")
end


function CompetitionRankRewardView:on_close()
    rewardItemsCache = nil
end

function CompetitionRankRewardView:SetInfo()
    local data = (ModelList.CompetitionModel.GetRankRewardInfo())
    local isDouble = ModelList.CompetitionModel.HasDoubleUnclaimedRewards()
    myRankOrder = ModelList.CompetitionModel.GetSelfRank()
    fun.set_active(self.SmallPrize,#data <=3 and true or false)
    fun.set_active(self.BigPrize,#data >3 and true or false)
    if rewardItemsCache == nil then
        rewardItemsCache = {}
    end
    if #data >3 then
        self:SetBigPrize(data,isDouble)
    else
        self:SetSmallPrize(data,isDouble)
    end
    self:PlayEnter()
end

function CompetitionRankRewardView:SetBigPrize(data,isDouble)
    fun.set_active(self.BigDoubleFlag,isDouble)
    local CompetitionRewardItem = require("View.DailyCompetition.CompetitionRankRewardItem")
    for i = 1, #data do
        local prize =  fun.get_instance(self.BigRewardItem,self.BigRewardContent)
        local rewardItem = CompetitionRewardItem:New()
        rewardItem:SetReward(data[i])
        rewardItem:SkipLoadShow(prize,true,nil,isDouble)
        fun.set_active(prize,true)
        if rewardItemsCache[i] == nil then
            table.insert(rewardItemsCache,rewardItem)
        end
    end
end

function CompetitionRankRewardView:SetSmallPrize(data,isDouble)
    fun.set_active(self.SmallDoubleFlag,isDouble)
    local CompetitionRewardItem = require("View.DailyCompetition.CompetitionRankRewardItem")
    for i = 1, #data do
        local prize =  fun.get_instance(self.SmallRewardItem,self.SmallRewardContent)
        local rewardItem = CompetitionRewardItem:New()
        rewardItem:SetReward(data[i])
        rewardItem:SkipLoadShow(prize,true,nil,isDouble)
        fun.set_active(prize,true)
        if rewardItemsCache[i] == nil then
            table.insert(rewardItemsCache,rewardItem)
        end
    end
end


function CompetitionRankRewardView:OnDisable()
    --Facade.RemoveView(self)
    self:UnRegisterEvent()
    --log.r("EventName.Event_popup_competition_finish")
    --Event.Brocast(EventName.Event_popup_competition_finish)
    if self._timer then
        LuaTimer:Remove(self._timer)
        canClick = true
    end
    CommonState.DisposeFsm(self)
    --rankItemList = nil
    --remainTimeCountDown:StopCountDown()
end


function CompetitionRankRewardView:PlayEnter()
    if myRankOrder and myRankOrder.order <=3  then
        --playAnim = {"topstart","CookieSettleView_topstart"}
        self.rankTxt.text = myRankOrder.order
        AnimatorPlayHelper.Play(self.anima,{"topstart","CookieSettleView_topstart"},false,nil)
    end
    UISound.play("task_reward_pop")
end



function CompetitionRankRewardView:ShowReward()
    local delay = 0
    local coroutine_fun = nil
    AddLockCountOneStep(true)
    for key, value in pairs(rewardItemsCache) do
        coroutine_fun = function()
            delay = delay + 0.2
            coroutine.wait(delay)
            Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts,value:GetPosition(),value:GetRewardItemId(),function()
                Event.Brocast(EventName.Event_currency_change)
                AddLockCountOneStep(false)
            end)
        end
        coroutine.resume(coroutine.create(coroutine_fun))
    end
    coroutine_fun = function()
        delay = delay + 0.2
        coroutine.wait(delay)
        local playAnim = {"normalend","CookieSettleView_normalend"}
        if myRankOrder then
            playAnim = {"topend","CookieSettleView_topend"}
        end
        AnimatorPlayHelper.Play(self.anima,{"normalend","CookieSettleView_normalend"},false,function()
            Facade.SendNotification(NotifyName.CloseUI,self)
            --Facade.SendNotification(NotifyName.ShowUI,ViewList.ActivitesChoiceView)
            Event.Brocast(EventName.Event_popup_competition_finish)
        end)

    end
    coroutine.resume(coroutine.create(coroutine_fun))

end



function CompetitionRankRewardView:GetReward(data)
    if data == RET.RET_SUCCESS then
        self._fsm:ChangeState("CompetitionRewardReward")
    else
        --Facade.SendNotification(NotifyName.HideUI,self)
    end
    --Facade.SendNotification(NotifyName.HideUI,ViewList.CompetitionRewardView)
end

function CompetitionRankRewardView:RegisterEvent()
    Event.AddListener(EventName.Event_competition_receive_rank_reward,self.GetReward,self)
end

function CompetitionRankRewardView:UnRegisterEvent()
    Event.RemoveListener(EventName.Event_competition_receive_rank_reward,self.GetReward,self)
end


function CompetitionRankRewardView:on_btn_continue_click()
    if canClick then
        canClick = false
        ModelList.CompetitionModel:ReqGetCompetitionRankReward()
        self._timer = LuaTimer:SetDelayFunction(3,function()
            canClick = true
        end)
    end
    --Facade.SendNotification(NotifyName.CloseUI,this)
    --self._fsm:GetCurState():DoOriginalAction(self._fsm,"CommonState1State",function()
    --    AnimatorPlayHelper.Play(self.anima,{"out","TournamentRewardViewexit"},false,function()
    --        Facade.SendNotification(NotifyName.CloseUI,this)
    --    end)
    --end)
end


return this