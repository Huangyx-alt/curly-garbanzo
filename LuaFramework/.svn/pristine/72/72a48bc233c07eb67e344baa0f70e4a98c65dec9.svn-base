---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/2/9 11:21
---


local SingleWolfCardSwitchItem = BaseChildView:New() --Clazz(BaseChildView,"SingleWolfCardSwitchItem")
local this = SingleWolfCardSwitchItem
this.cardPage = {}     --switch 分页1
local WolfPos = {7, 9, 17, 19}

function SingleWolfCardSwitchItem:New(go)
    self = {}
    setmetatable(self,{__index = SingleWolfCardSwitchItem})
    --self._data = cellData
    return self
end

local MaxBowlCount = 4

--- 给普通格子设置icon
local function SetNormalCellIcon(cellIndex,img)
    if img then
        local x = math.floor(cellIndex/5)+1
        local y = math.floor(cellIndex%5)
        if x== 3 and  y == 3 then
            --Cache.load_sprite(AssetList[resource1], resource1, function(sprite)
            --    img.sprite = sprite
            --end)
            Cache.SetImageSprite("SingleWolfBingoAtlas","LRQhCardGz03",img)
        elseif (x == 3 or y == 3) then
            Cache.SetImageSprite("SingleWolfBingoAtlas","LRQhCardGz02",img)
        else
            Cache.SetImageSprite("SingleWolfBingoAtlas","LRQhCardGz01",img)
        end
    end
end

---初始化switch 分页卡牌
function SingleWolfCardSwitchItem:InitMap(go,type)
    local ref = fun.get_component(go.transform,fun.REFER)
    if ref then
        self.content = ref:Get("content")
        self.img_reap = ref:Get("img_reap")
        self.wolf = ref:Get("wolf")
    end
    local page = {}
    for i = 1, 25 do
        local go = nil
        local img = nil
        if i == 7 or i== 9 or i == 17 or i ==19 then
            go = fun.get_instance(self.wolf,self.content)
        else
            go = fun.get_instance(self.img_reap,self.content)
            img = go:GetComponent(fun.IMAGE)
            SetNormalCellIcon(i,img)
        end
        fun.set_active(go,false,0)
        local cell = {obj = go,image = img}
        table.insert(page,cell)
        local x = math.modf((i-1)/5)
        local y = math.modf((i-1)%5)
        fun.set_gameobject_pos(go,25*x,-25*y,0,true)
        fun.set_active(go,true)
    end
    table.insert(this.cardPage,page)
end

---结算界面，设置所有的小卡牌显示
function SingleWolfCardSwitchItem:ShowAll(go,orderIndex)
    local ref = fun.get_component(go.transform,fun.REFER)
    if ref then
        self.content = ref:Get("content")
        self.img_reap = ref:Get("img_reap")
        self.wolf = ref:Get("wolf")
    end
    local childCount = fun.get_child_count(self.content)
    for i = childCount,1,-1 do
        if fun.get_child(self.content,i-1).gameObject.activeSelf then
            Destroy( fun.get_child(self.content,i-1).gameObject)
        end
    end
    local wolfCount = BattleLogic.GetLogicModule(LogicName.Card_logic):GetWolfCount(orderIndex)
    local isWolf =false
    local go =nil
    for i = 1, 25 do
        if i == 7 or i== 9 or i == 17 or i ==19 then
            go = fun.get_instance(self.wolf,self.content)
            isWolf = true
            this.SetWolfShow(go,wolfCount[i])
        else
             go = fun.get_instance(self.img_reap,self.content)
            isWolf =false
        end
        fun.set_active(go,false,0)
        local x = math.modf((i-1)/5)
        local y = math.modf((i-1)%5)
        fun.set_gameobject_pos(go,25*x,-25*y,0,true)
        local isNotSign  = ModelList.BattleModel:GetCurrModel():GetRoundData(orderIndex,i):IsNotSign()
        fun.set_active(go, isWolf or (not isWolf and isNotSign)  )

    end


end


local function IsAutoClick(currCardId,currIndex,cardId,signInfo)
    if not signInfo then return false end
    if currCardId == cardId then
        for i = 1, #signInfo do
            if signInfo[i].index == currIndex then
                return true
            end
        end
    end
    return false
end


function SingleWolfCardSwitchItem:Refresh(pageIndex, newCard,cardId,signInfo,cardObj)
    local items =  this.cardPage[pageIndex]
    if items then
        local isshowing = false
        for i = 1, #items do
            isshowing = false
            for k,v in pairs(newCard) do
                if i == v.index and not fun.is_include(i, WolfPos) then
                    isshowing = true
                    items[i].obj.gameObject:SetActive(true)
                    if IsAutoClick(v.cardId,v.index,cardId,signInfo) then
                        BattleEffectCache:GetFreePrefabFromCache("SingleWolfgetxiaoka",items[i].obj,1,function(effObj)
                            fun.set_active(effObj,true)
                            fun.set_parent(effObj,effObj.transform.parent.parent)
                        end)
                    end
                    break
                end
            end
            items[i].obj.gameObject:SetActive(not isshowing)
        end
    end

    local wolfCount = BattleLogic.GetLogicModule(LogicName.Card_logic):GetWolfCount(cardId)
    this.SetWolfShow(this.cardPage[pageIndex][7].obj,wolfCount[7])
    this.SetWolfShow(this.cardPage[pageIndex][9].obj,wolfCount[9])
    this.SetWolfShow(this.cardPage[pageIndex][17].obj,wolfCount[17])
    this.SetWolfShow(this.cardPage[pageIndex][19].obj,wolfCount[19])

end

function SingleWolfCardSwitchItem.SetWolfShow(obj,count)
    if count< 4 then
        local child1 = fun.find_child(obj,"lockWolf")
        local child2 = fun.find_child(obj,"Wolf")
        if child1 then fun.set_active(child1,true) end
        if child2 then fun.set_active(child2,false) end
    else
        local child1 = fun.find_child(obj,"lockWolf")
        local child2 = fun.find_child(obj,"Wolf")
        if child1 then fun.set_active(child1,false) end
        if child2 then fun.set_active(child2,true) end
    end
end

function SingleWolfCardSwitchItem.OnDispose()
    --self._gameObject = nil
    this.cardPage = {}
    this:Close()
end



return SingleWolfCardSwitchItem