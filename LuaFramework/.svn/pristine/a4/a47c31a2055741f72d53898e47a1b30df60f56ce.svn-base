---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/8/22 16:06
---

require("State.TopVipSlider.TopVipSliderEnterState")
require("State.TopVipSlider.TopVipSliderGrowMaxState")
require("State.TopVipSlider.TopVipSliderExitState")
require("State.TopVipSlider.TopVipSliderChangeVipState")

VipSliderView = BaseView:New("VipSliderView")
local this = VipSliderView
this.viewType = CanvasSortingOrderManager.LayerType.None

local CurrVipLv =0
local MaxVipLv =0

local waitUpdateTime = 0
local NextStateType = {None = 0, Quit = 1,Grow = 2,LevelUp = 3,Close = 4}
local nextState = NextStateType.None

this.auto_bind_ui_items = {
    "Slider",
    "currVipIcon",
    "nextVipIcon",
    "currVipLevel",
    "nextVipLevel",
    "sliderText",
    "Anima",
}

function VipSliderView:New(parasitifer)
    local o = {}
    this.__index = this
    setmetatable(o,this)
    o._parasitifer = parasitifer or ParasitiferType.other
    return o
end


function VipSliderView:Init(obj)
    this:on_init(obj)
end

--
--function VipSliderView:Reset()
--    log.r("reset 1")
--    this:SetNextStateUpdate(NextStateType.None,0)
--    if this.update_x_enabled  then
--        log.r("reset 2")
--        this.OnDisable()
--         this:Destroy()
--    end
--end
--
--
--
----- vip介绍面板使用
--function VipSliderView:SetVipInfo(call_back)
--    --this:Reset()
--    CurrVipLv = ModelList.PlayerInfoModel:GetVIP()
--    MaxVipLv = #Csv.vip
--    local vipPts = ModelList.PlayerInfoModel:GetVipPts()
--
--    local vipInfo = Csv.GetData("vip",CurrVipLv)
--    this:SetVipIcon(CurrVipLv,this.currVipIcon,this.currVipLevel)
--    if CurrVipLv < MaxVipLv then
--        this:SetVipIcon(CurrVipLv+1,this.nextVipIcon,this.nextVipLevel)
--        local progress = vipPts/vipInfo.exp
--        this.Slider.value = math.floor(progress * 100) * 0.01
--        this.sliderText.text = tostring(math.floor(progress * 100)) .. "%"
--    else
--        this.Slider.value = 1
--        this.sliderText.text = "MAX"
--        this:SetVipMaxIcon(this.nextVipIcon,this.nextVipLevel)
--        call_back()
--    end
--end
--
function VipSliderView:SetVipIcon(vipLv,vipIcon,vipText)
    local vipInfo = Csv.GetData("vip", vipLv)
    vipIcon.sprite = AtlasManager:GetSpriteByName("VipAtlas", vipInfo.icon)
    vipText.sprite = AtlasManager:GetSpriteByName("VipAtlas", "VipNub" .. vipLv)
end
--
function VipSliderView:SetVipMaxIcon(vipIcon,vipText)
    vipIcon.sprite = AtlasManager:GetSpriteByName("VipAtlas", "vipMax1")
    fun.set_active(vipText,false)
    fun.set_active(this.vipMax,true)
end







--- vip 进度滑动条效果 面板使用


local oldVipPts = 0
local oldVipLv  = 0



function VipSliderView:ShowTopVip()
    this:SetOldVipInfo()
    this:BuildFsm()
    this.update_x_enabled = true
    this:start_x_update()
    this._isOver = false
    
end

function VipSliderView:BuildFsm()
    FsmCreator:Create("VipSliderView",this,{
        TopVipSliderEnterState:New(),
        TopVipSliderGrowMaxState:New(),
        TopVipSliderExitState:New(),
        TopVipSliderChangeVipState:New(),
    })
    this._fsm:StartFsm("TopVipSliderEnterState")
end

function VipSliderView:on_x_update()
    if nextState ~= NextStateType.None then
        waitUpdateTime = waitUpdateTime - UnityEngine.Time.deltaTime
        if waitUpdateTime <= 0 then
            local tempNextState = nextState
            nextState = NextStateType.None
            if tempNextState == NextStateType.Quit then
                this._fsm:ChangeState("TopVipSliderExitState")
            elseif tempNextState == NextStateType.Grow then
                this._fsm:ChangeState("TopVipSliderGrowMaxState")
            elseif tempNextState == NextStateType.LevelUp then
                this._fsm:ChangeState("TopVipSliderChangeVipState")
            elseif tempNextState == NextStateType.Close then
                Facade.SendNotification(NotifyName.CloseUI,ViewList.TopVipSliderView)
            end
        end
    end
end


function VipSliderView:HideView()

end


function VipSliderView:SetOldVipInfo()
    oldVipPts,oldVipLv = ModelList.PlayerInfoModel:GetOldVipPts()
    CurrVipLv = ModelList.PlayerInfoModel:GetVIP()
    MaxVipLv = #Csv.vip
    local vipInfo = Csv.GetData("vip",oldVipLv)
    this:SetVipIcon(oldVipLv,this.currVipIcon,this.currVipLevel)
    if oldVipLv < MaxVipLv then
        this:SetVipIcon(oldVipLv+1,this.nextVipIcon,this.nextVipLevel)
        local progress = oldVipPts/vipInfo.exp
        this.Slider.value = math.floor(progress * 100) * 0.01
        this.sliderText.text = tostring(math.floor(progress * 100)) .. "%"
    else
        this.Slider.value = 1
        this.sliderText.text = "MAX"
        this:SetVipIcon(MaxVipLv,this.nextVipIcon,this.nextVipLevel)
    end
end

function VipSliderView:PlayEnterEffect()
    this.Anima:Play("in")
    this:SetNextStateUpdate(NextStateType.Grow,1)
end


---经验进度条增长效果
function VipSliderView:GrowSlider()
    CurrVipLv = ModelList.PlayerInfoModel:GetVIP()
    local vipPts = ModelList.PlayerInfoModel:GetVipPts()
    local vipInfo = Csv.GetData("vip",CurrVipLv)
    local OvipInfo = Csv.GetData("vip",oldVipLv)
    this.Anima:Play("go")
    if oldVipLv < CurrVipLv then
        Anim.slide_to(this.Slider,this.sliderText,100,0.5,function()
            this:SetNextStateUpdate(NextStateType.LevelUp,0)
            UISound.stop_loop("vip_progress")
        end)
    else
        Anim.slide_to(this.Slider, this.sliderText, math.floor(vipPts / vipInfo.exp * 100), 0.5, function()
            this:SetNextStateUpdate(NextStateType.Quit, 0.8)
            UISound.stop_loop("vip_progress")
        end)
    end

    if math.floor(oldVipPts/OvipInfo.exp * 100) ~= math.floor(vipPts / vipInfo.exp * 100) then 
        UISound.play_loop("vip_progress")
    end 
end

---经验进度条退场
function VipSliderView:IsOver()
    return this._isOver  or false
end

---经验进度条退场
function VipSliderView:Exit()
    this._isOver = true
    this.Anima:Play("out")
    this:SetNextStateUpdate(NextStateType.Close,0.8)
    UISound.stop_loop("vip_progress")
end

--- 新VIP等级图标飞到上方
function VipSliderView:FlyNewVipIcon()
    local obj = fun.get_instance(this.nextVipIcon,this.nextVipIcon.transform.parent)
    local targetPos = GetTopVipIconPos()
    UISound.play("vip_sign")
    Anim.move(obj, targetPos.x, targetPos.y, targetPos.z, 0.5, false, true, function()
        Destroy(obj)
        Event.Brocast(EventName.Event_Refresh_Vip_Icon, oldVipLv)
        Cache.load_prefabs(AssetList.FlyRewardhit, "FlyRewardhit", function(obj)
            local go = fun.get_instance(obj, self.go)
            local pos = GetTopVipIconPos()
            fun.set_gameobject_pos(go, pos.x, pos.y, 0, false)
            Destroy(go, 1)
        end)
    end)
end

---经验进度条增长到顶效果
function VipSliderView:SetNextStateUpdate(state,waitTime)
    waitUpdateTime = waitTime
    nextState = state
end

---经验进度条增长到顶效果
function VipSliderView:GrowSliderMaxEffect()
    oldVipLv = oldVipLv + 1
    ModelList.PlayerInfoModel:SaveOldVipPts(nil,oldVipLv)
    this:FlyNewVipIcon()
    this.Anima:Play("full")
    this:SetVipIcon(oldVipLv,this.currVipIcon,this.currVipLevel)
    if oldVipLv == MaxVipLv then
        fun.set_active(this.nextVipIcon,false)
        fun.set_active(this.nextVipLevel, false)
        this:SetNextStateUpdate(NextStateType.Quit, 1.5)
    else
        this.Slider.value = 0
        this.sliderText.text = "0%"
        this:SetVipIcon(oldVipLv + 1, this.nextVipIcon, this.nextVipLevel)
        this:SetNextStateUpdate(NextStateType.Grow, 1.5)
    end
end

function VipSliderView:RegisterEvent()
    Event.AddListener(EventName.Event_popup_top_vip_exp,this.ShowTopVip)
end

function VipSliderView:UnRegisterEvent()
    Event.RemoveListener(EventName.Event_popup_top_vip_exp,this.ShowTopVip)
end

function VipSliderView:OnEnable()
    this.update_x_enabled = true
    this:start_x_update()
end



function VipSliderView.OnDisable()
    --Facade.RemoveView(this)
    FsmCreator:DisposeFsm(this)
    this:stop_x_update()
    this.update_x_enabled = false
   
end


function VipSliderView:on_close()
    this:stop_x_update()
end


return this

