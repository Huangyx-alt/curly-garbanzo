---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/12/24 17:33
---
---@class GuideAction
local GuideAction = Clazz({}, "GuideAction")
local this = GuideAction

function GuideAction:ResetEasyTouch()
    -- log.r("ResetEasyTouch")
    Util.SetLuaDrag(nil)
end

function GuideAction:FirstBattleReady()
    fun.save_value(ModelList.PlayerInfoModel:GetUid()..MCT.HangUpAutoPowerConfig, 1)
    --fun.set_active(ViewList.GameBingoView.powerView.btn_auto, false)
    --Event.AddListener(EventName.PowerUpAutoStateChange,this.OnPowerupAutoChange)
end

function GuideAction:OpenFirstBattleMusic()
    --UISound.play_bgm("city")
    UISound.play("begin")
end

function GuideAction:CloseFirstBattleMusic()
    UISound.stop_bgm()
    UISound.stop("begin")
end

--等待叫号，在号码出来前不允许点击
function GuideAction:CloseCardClick()
    ModelList.BattleModel:GetCurrBattleView():GetCardView().is_open_collider = false
end

--等待叫号，号码出来了，允许点击
function GuideAction:OpenCardClick()
    log.r("[引导] GuideAction =>等待叫号，号码出来了，允许点击 ")
    --- View/Guide/GuideAction:37: attempt to index field 'cardView' (a nil value) currUId
    if ViewList.GameBingoView.cardView and ViewList.GameBingoView.cardView.FirstBattlePowerReady then  
        ViewList.GameBingoView.cardView:FirstBattlePowerReady(true) 
    end
end

--powerup，允许点击
function GuideAction:OpenPowerUpClick()
    --ViewList.GameBingoView.powerView:SetPowerUse(true)
end

--powerup，不允许点击
function GuideAction:ClosePowerUpClick()
    --ViewList.GameBingoView.powerView:SetPowerUse(false)
end

function GuideAction:FirstBattleFocusNum50(str)
    ViewList.GameBingoView.cardView.FirstBattlePowerReady()
end


function GuideAction:FirstBattleGuidePower()
    --ViewList.GameBingoView.powerView.max_power = 4
    --ViewList.GameBingoView.powerView.common_cd = 4
end

function GuideAction:FirstBattlePowerCloseClick()
    --powercd == 1
    --ViewList.GameBingoView.powerView:SetPUCanUse(false)
end

function GuideAction:FirstBattlePowerOpenClick()
    --powercd == 1
    --ViewList.GameBingoView.powerView:SetPUCanUse(true)
end

function GuideAction:FirstBattleOver()
    Event.Brocast(EventName.Event_stop_bingo_game)
    ModelList.GameModel:ShowSettle()
end

function GuideAction:FirstBattleSettleData()
    this.waitData = LuaTimer:SetDelayLoopFunction(0,0.1,50,function()
        if ModelList.GameModel:GetSettleData() then
            ModelList.GameModel:GetSettleData().totalBingoCount = 100
            LuaTimer:Remove(this.waitData)
        end
    end)

end


function GuideAction:RestoreFirstBattle()
    ViewList.GameBingoView:ReplacGuideCardView(false)
end

--部分引导要关闭城市拖动功能，过完引导再恢复
function GuideAction:CheckCityDrag(info,dragRef)
    if dragRef then
        ViewList.HallCityView:RestoreLuaDray()
    end
    if info.controlType == 3 and string.find(info.path, "MainCityScene") ~= nil and string.find(info.path, "btn_entry") ~= nil then
        this:ResetEasyTouch()
        return true
    end
    return false
end

function  GuideAction:CheckFirstEnter()
    if viewName == "HallCityView" then

    end
end

function  GuideAction:EnterFirstBattle()
    ModelList.GameModel:ReqEnterGame()
end

---lpb的新手引导
function  GuideAction:StartFirstBattle()
    --local game_ui = fun.GameObject_find("Canvas/GameUI/NormalNode")
    --local getReadyView =  fun.find_child(game_ui,"ReadyView")
    --Facade.SendNotification(NotifyName.SkipLoadShowUI,ViewList.ReadyView,getReadyView )
    --if ViewList.SceneLoadingGameView and ViewList.SceneLoadingGameView.go then
    --    ViewList.SceneLoadingGameView:FadeOut()
    --end
end

---bang进入战斗
function GuideAction:FirstTimeBattle()
    log.r("[引导] GuideAction =>bang进入战斗 ")
    local CmdStartGuideBattle = require "Logic.Command.Guide.CmdStartGuideBattle"
    local cmd = CmdStartGuideBattle.New()
    cmd:Execute()
end


local tempHideArror = nil
local tempHideFinger = nil
local tempHideFingerInstance = nil
local tempArrowInstance = nil
local ArrorShowCount = 0
local DelayShowEffect = {}

function GuideAction.Reset()
     tempHideArror = nil
     tempHideFinger = nil
     tempHideFingerInstance = nil
     tempArrowInstance = nil
     ArrorShowCount = 0
     this.ClearShowEffect()
end

function GuideAction.ClearShowEffect()
    if DelayShowEffect then
        for i = 1, #DelayShowEffect do
            LuaTimer:Remove(DelayShowEffect[i])
        end
        DelayShowEffect = {}
    end
end

function GuideAction:RemoveDelay(delayId)
    if DelayShowEffect then
        for i = 1, #DelayShowEffect do
            if DelayShowEffect[i] == delayId then
                LuaTimer:Remove(DelayShowEffect[i])
                table.remove(DelayShowEffect, i)
                break
            end
        end
    end
end

local function IsNeedGuidePower()
    return ViewList.GameBingoView.powerView: IsEnoughCharge()
end

local function IsNeedGuideAutoPowerSecondBattle()
    local view = ModelList.BattleModel:GetCurrBattleView()
    if not view then return true end
    return not view.powerView:IsAuto() and ModelList.BattleModel:GetCurrModel():GetReadyState() <= 1
end

---@ Hide power up finger effect
local function HidePowerUpArrow()
    if not Util.IsNull(tempArrowInstance) then
        local arrowAnima = fun.get_component(tempArrowInstance.gameObject,fun.ANIMATOR)
        arrowAnima:Play("exit")
        tempArrowInstance = nil
    end
    this.ClearShowEffect()
end

---@ show power up finger effect
local function ShowPowerUpArrow()
    --if not IsNeedGuideAutoPowerSecondBattle() then return end
    tempArrowInstance =  GameObject.Find("GameManager/GlobalUI/Parent/GuideView/Panel/Arrow")
    if not Util.IsNull(tempArrowInstance) then
        fun.set_same_position_with(tempArrowInstance,ViewList.GameBingoView.powerView.PuImage)
        fun.set_active(tempArrowInstance.gameObject,false)
        fun.set_active(tempArrowInstance.gameObject,true)
        tempHideArror = LuaTimer:SetDelayLoopFunction(0,0.1,50,function()
            if BattleMachineList.GetMachieState()== 3 then
                LuaTimer:Remove(tempHideArror)
            end
        end,function()
            HidePowerUpArrow()
        end)
    end
end

---@  显示二场战斗的powerup 手指提示
local function PlayPowerupAutoUseFinger()
    if not IsNeedGuideAutoPowerSecondBattle() then return end

    fun.set_active(ViewList.GameBingoView.powerView.btn_auto, true)
    local FingerPrefab = GameObject.Find("GameManager/GlobalUI/Parent/GuideView/Panel/PowerUpAutoFinger")
    if not Util.IsNull(FingerPrefab) then
        tempHideFingerInstance = fun.get_instance(FingerPrefab, FingerPrefab.transform.parent.parent.parent)
        fun.set_same_position_with(tempHideFingerInstance, ViewList.GameBingoView.powerView.btn_auto)
        fun.set_active(tempHideFingerInstance.gameObject, true)
        this:OpenPowerUpClick()
        tempHideFinger = LuaTimer:SetDelayLoopFunction(0, 0.2, 25, function()
            if ViewList.GameBingoView.powerView:IsAuto() then
                this:RemoveDelay(tempHideFinger)
            end
        end, function()
            local child = fun.find_child(tempArrowInstance,"City2Tip")
            local anim = fun.get_component(child,fun.ANIMATOR)
            if anim then
                anim:Play("exit")
            end
            GameObject.Destroy(tempHideFingerInstance,0.5)
            tempHideFingerInstance = nil
            tempHideFinger = nil
            end)
        table.insert(DelayShowEffect,tempHideFinger)
    end
end


---  显示第一场战斗的powerup 手指提示
function GuideAction:PlayFirstBattlePowerFinger()
        --if not IsNeedGuidePower() then  return end
        local temp = LuaTimer:SetDelayFunction(0.5,function()
            if ViewList.GameBingoView.powerView:IsEnoughCharge() then
                ShowPowerUpArrow()

            end
        end)
        table.insert(DelayShowEffect,temp)
end

---  显示二场战斗的powerup 手指提示
function GuideAction:PlaySecondBattleAutoPowerFinger()
    ArrorShowCount = ArrorShowCount + 1
    if ArrorShowCount == 1 then
        local temp =  LuaTimer:SetDelayFunction(0.5,function()
            PlayPowerupAutoUseFinger()
        end)
        table.insert(DelayShowEffect,temp)
    end
end


---  隐藏第一场战斗的powerup 手指提示
function GuideAction:HideFirstBattlePowerFinger()
    local Arrow =  GameObject.Find("GameManager/GlobalUI/Parent/GuideView/Panel/Arrow")
    if not Util.IsNull(Arrow) then
        local arrowAnima = fun.get_component(Arrow.gameObject, fun.ANIMATOR)
        arrowAnima:Play("exit")
        LuaTimer:SetDelayFunction(0.5, function()
            fun.set_active(Arrow, false)
        end)
        if tempHideArror ~= nil then
            LuaTimer:Remove(tempHideArror)
            tempHideArror = nil
        end
    end
end

---@ on power up auto state change
function GuideAction:OnPowerupAutoChange(state)
    if  not  ModelList.GuideModel:IsFirstBattle() then
        return
    end
    if state   then
        if tempHideFingerInstance then
            GameObject.Destroy(tempHideFingerInstance)
        end
        if tempArrowInstance then
            HidePowerUpArrow()
        end
        if tempHideFinger then
            LuaTimer:Remove(tempHideFinger)
            tempHideFinger = nil
        end
    else
        if  ViewList.GameBingoView.powerView: IsEnoughCharge() then
            ShowPowerUpArrow()
        end
    end
end


function GuideAction:ResetCityEntry(info)
    local ab = UnityEngine.GameObject.Find("CanvasScene/GameScene/MainCityScene/city_anchor/hang_point/citypoint/city01/City1Entity(Clone)/")
    if ab then
        info.path    = "MainCityScene/city_anchor/hang_point/citypoint/city01/City1Entity(Clone)/Total/btn_entry"
    else
        info.path    = "MainCityScene/city_anchor/hang_point/citypoint/city02/City1Entity(Clone)/Total/btn_entry"
    end
end

function GuideAction:ResetDirToTargetCity(info)
    if  not info.skipParam or  #info.skipParam < 4 then 
        return 
    end 

    local targetCity = string.sub(info.skipParam,4)
    if targetCity  then
        -- log.g("info.skipParam"..info.skipParam.."info.GUIDE"..info.id)
        if ModelList.CityModel:GetCity() > tonumber(targetCity) then
            info.path    = "HallCityView/SafeArea/TurnPage/Left/btn_turnleft"
        end
    end
end

function GuideAction:ShowThreePuEffect(path,isActive,offset)
    if ViewList.GuideView then
        ViewList.GuideView:OpenThreePu(path,isActive,offset)
    end
end

local startScenename = "SceneHome"
local guideLoop = nil
function GuideAction:CheckIfEnterBattle()
    if  fun.get_active_scene().name  == "SceneGame" then
        return
    end
    --230303 先去掉
    -- guideLoop =  LuaTimer:SetDelayLoopFunction(3,0.3,90,function()
    --     if  fun.get_active_scene().name  == startScenename and SceneViewManager.prev_scene_name == "SceneLoading" then
    --         UIUtil.return_to_login()
    --         if guideLoop then
    --             LuaTimer:Remove(guideLoop)
    --             guideLoop = nil
    --         end
    --     else
    --         if fun.get_active_scene().name  == "SceneGame" then
    --             if guideLoop then
    --                 LuaTimer:Remove(guideLoop)
    --                 guideLoop = nil
    --             end
    --         end
    --     end
    -- end)
end

function GuideAction:ShowCityTip()
    local IntroducePanel =  GameObject.Find("GameManager/GlobalUI/Parent/GuideView/Panel/BubbleTips/City6Tip")
    if not Util.IsNull(IntroducePanel) then
        fun.set_active(IntroducePanel,true)
    end
end

function GuideAction:ShowModuleCityTip(moduleName,isshow)
    local IntroducePanel =  GameObject.Find(string.format("GameManager/GlobalUI/Parent/GuideView/Panel/BubbleTips/%sTip",moduleName))
    if not Util.IsNull(IntroducePanel) then
        fun.set_active(IntroducePanel,isshow)
    end
     IntroducePanel =  GameObject.Find("GameManager/GlobalUI/Parent/GuideView/Panel/IntroducePanel")
    if not Util.IsNull(IntroducePanel) then
        fun.set_active(IntroducePanel,isshow)
        IntroducePanel =  GameObject.Find(string.format("GameManager/GlobalUI/Parent/GuideView/Panel/IntroducePanel/%s",moduleName))
        if not Util.IsNull(IntroducePanel) then
            fun.set_active(IntroducePanel,isshow)
        end
    end
end

function GuideAction:ShowNewCityTip(cityId,isshow)
    local IntroducePanel =  GameObject.Find(string.format("GameManager/GlobalUI/Parent/GuideView/Panel/BubbleTips/City%sTip",cityId))
    if not Util.IsNull(IntroducePanel) then
        fun.set_active(IntroducePanel,isshow)
    end
    IntroducePanel =  GameObject.Find("GameManager/GlobalUI/Parent/GuideView/Panel/IntroducePanel")
    if not Util.IsNull(IntroducePanel) then
        fun.set_active(IntroducePanel,isshow)
        IntroducePanel =  GameObject.Find(string.format("GameManager/GlobalUI/Parent/GuideView/Panel/IntroducePanel/city%s",cityId))
        if not Util.IsNull(IntroducePanel) then
            fun.set_active(IntroducePanel,isshow)
        end
    end
end

function GuideAction:GetCurrPowerUpViewType()
    local betRate = ModelList.CityModel:GetBetRate() or 1 -- 默认倍数1
    local data = ModelList.CityModel:GetPowerUpRange()
    local playid =  ModelList.CityModel.GetPlayIdByCity()
    --当玩家开启ultra_bet活动后，全部bet下都开放小丑PU机台
    local isUltraBetOpen = ModelList.UltraBetModel:IsActivityValidForCurPlay()
    local isJokerOpen = ModelList.CityModel:CheckIsJokerOpen(playid)
    local checkForceUseMaster = isUltraBetOpen and isJokerOpen
    if checkForceUseMaster then
        return 4,"PowerUpViewMaster"
    end

    if data[playid][1].bet[1] <= betRate and betRate <= data[playid][1].bet[2] then
        return 1,"PowerUpView";
    elseif data[playid][2].bet[1] <= betRate and betRate <= data[playid][2].bet[2] then
        return 2,"PowerUpViewSilver";
    elseif data[playid][3].bet[1] <= betRate and betRate <= data[playid][3].bet[2] then
        return 3,"PowerUpViewGoldNova";
    elseif data[playid][4].bet[1] <= betRate and betRate <= data[playid][4].bet[2] then
        return 4,"PowerUpViewMaster";
    end
    return 1,"PowerUpView";
end

return this
