---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/7/8 15:31
---

require("State.TaskTipView.TaskTipEnterState")
require("State.TaskTipView.TaskTipExitState")
require("State.TaskTipView.TaskTipGrowState")
require("State.TaskTipView.TaskTipCheckFullState")
--require("State.TaskTipView.TaskTipEnterState")

local TaskTipView = BaseChildView:New("TaskTipView")
local this = TaskTipView
this.viewType = CanvasSortingOrderManager.LayerType.None

local _taskToggle = nil

this.auto_bind_ui_items = {
    "tip1",
    "tip2",
    "tip3",
    "tip4",
    "card_bg",
    "view",
}

function TaskTipView:New()
    local o = {}
    self.__index = self
    setmetatable(o,self)
    return o
end

local taskItemEntityCache = {}


function TaskTipView:GetItemViewInstance(index)
    local view = require "View.Task.TaskTipItemView"
    local view_instance = nil
    if taskItemEntityCache[index] == nil then
        local item = self["tip"..index]
        view_instance = view:New()
        view_instance:SkipLoadShow(item)
        taskItemEntityCache[index] = view_instance
    else
        view_instance = taskItemEntityCache[index]
    end
    fun.set_active(view_instance:GetTransform(),true,false)
    return view_instance
end


function TaskTipView:Open(obj,parentView)
    this:on_init(obj,parentView)
    taskItemEntityCache = {}
    --fun.set_active(obj,true)
    FsmCreator:Create("TaskTipView",this,{
        TaskTipEnterState:New(),
        TaskTipGrowState:New(),
        TaskTipExitState:New(),
        TaskTipCheckFullState:New(),
    })
    self._fsm:StartFsm("TaskTipEnterState")
    --fun.set_active(obj,false)
    fun.set_active(obj,true)
end

function TaskTipView:SetTaskItems(taskDataList,showOld)
    if taskDataList then
        local count = 0
        for key, value in pairs(taskDataList) do
            if not value.rewarded then
                count = count + 1
                local view = this:GetItemViewInstance(count)
                if view then
                    view:SetTaskData( value,showOld)
                end
            end
        end
        if count < 4 then
            for i = count + 1, 4 do
                fun.set_active(this["tip"..i],false,false)
            end
        end
        local height = count < 4 and 336.6 or 441
        fun.set_recttransform_native_height(self.card_bg, height)
    end
end

function TaskTipView:PlayEnter()

    --this.view:Play("enter")
end

function TaskTipView:PlayExit()
    self.view:Play("out")
    LuaTimer:SetDelayFunction(0.5,function()
        if self.go then
            fun.set_active(self.go ,false)
        end
        Event.Brocast(EventName.Event_popup_task_tip_finish)
    end,nil,LuaTimer.TimerType.UI)
end

function TaskTipView:GetTaskItem()
    return taskItemEntityCache
end

function TaskTipView:Awake()

end

function TaskTipView:OnEnable()
    self._isinit = true
end

function TaskTipView:OnDisable()
    if self.go then
        fun.set_active(self.go ,false)
    end
    self:Close()
    FsmCreator:DisposeFsm(this)
end

function TaskTipView:on_btn_card_bg_click()
end
return this


