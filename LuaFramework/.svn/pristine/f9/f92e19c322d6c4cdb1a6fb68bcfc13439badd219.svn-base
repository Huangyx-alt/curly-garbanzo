---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/6/25 15:37
---
---- 小丑结算双倍金币效果

local BaseCardJokerEffect  =  require("View.Bingo.EffectModule.CardJoker.BaseCardJokerEffect")

local JokerDoubleCoinEffect = BaseCardJokerEffect:New()
local this = JokerDoubleCoinEffect

function JokerDoubleCoinEffect:New()
    local o = { isLoaded = false, changeSceneClear = true}
    self.__index = self
    setmetatable(o, self)
    return o
end

---基类继承
function JokerDoubleCoinEffect:SetInfo(info,parentObj,parentRef)
    self.data = info
    local obj = parentRef:GetPreloadPrefab("clowndaoju_doublejinbi")
    if obj then
        fun.set_parent(obj,parentObj,true)
        self.go = obj
        fun.set_active( obj,true)
        local anima =  fun.get_component(obj,fun.ANIMATOR)
        if anima then
            local cardCount = self.model:GetCardCount()
            if cardCount == 2 then  anima:Play("enter2")
            elseif cardCount == 4 then anima:Play("enter4") end
        end
    else
        Cache.load_prefabs(AssetList["clowndaoju_doublejinbi"],"clowndaoju_doublejinbi",function (prefab)
            if prefab then
                local obj = fun.get_instance(prefab)
                if obj then
                    fun.set_parent(obj,parentObj,true)
                    self.go = obj
                    fun.set_active( obj,true)
                    local anima =  fun.get_component(obj,fun.ANIMATOR)
                    if anima then
                        local cardCount = self.model:GetCardCount()
                        if cardCount == 2 then  anima:Play("enter2")
                        elseif cardCount == 4 then anima:Play("enter4") end
                    end
                end
            end
        end)
    end
end

--- 播放小丑区域入场效果
function JokerDoubleCoinEffect:Play()
    fun.set_active(self.go,true)
    LuaTimer:SetDelayFunction(1,function ()
        self:Fly()
    end,nil,LuaTimer.TimerType.Battle)
end

function JokerDoubleCoinEffect:Fly()
    if fun.is_null(self.go) then return end
    for k = 1, #self.data.itemIds do
        local obj =  fun.get_instance(self.go,self.go.transform.parent)
        local child =  fun.find_child(obj,"fei")
        local flyImg = fun.get_component(child,fun.IMAGE)
        if flyImg then
            local iconName = Csv.GetData("item",self.data.itemIds[k],"icon")
            local item_type = Csv.GetData("item",self.data.itemIds[k],"item_type")
            local clientPos = ConvertServerPos(self.data.cardPowerUpEffect[k].posList[1])
            local targetCell = self:GetCellObj(self.data.cardPowerUpEffect[k].cardId, clientPos)
            Cache.SetImageSprite("GameItemAtlas",iconName,flyImg )
            self.model:SetRoundGiftData(self.data.cardPowerUpEffect[k].cardId, clientPos, self.data.itemIds[k], 0, 0, 0)
            self:SetCellChange(self.data.cardPowerUpEffect[k].cardId,clientPos,4,clientPos)
            self:AddGiftToCell(targetCell,iconName,flyImg.gameObject,item_type,
                    self.data.cardPowerUpEffect[k].cardId,clientPos)
        end
    end
    fun.set_active(self.go,false)
    self:PlayOver()
end

function JokerDoubleCoinEffect:PlayEffect(targetCell)
    Cache.load_prefabs(AssetList["clowndaoju_getxiao"],"clowndaoju_getxiao",function (prefab)
        if prefab then
            local obj = fun.get_instance(prefab)
            if obj and targetCell then
                fun.set_parent(obj,targetCell.transform,true)
                fun.set_active(obj,true)
                Destroy(obj,2)
            end
        end
    end)
end

function JokerDoubleCoinEffect:AddGiftToCell(target,iconName,flyObj,item_type,cardId,cellIndex)


    Event.Brocast(EventName.CardItem_Cell_Add_Item, target, iconName, flyObj, item_type, cardId, function()
        self:PlayEffect(target)
    end,true,0.3,2)
end


function JokerDoubleCoinEffect:PlayOver()
    Destroy(self.go,5)
    --log.r("JokerDoubleCoinEffect:PlayOver")
end

---预加载依赖的资源
function JokerDoubleCoinEffect:PreloadDependResource(callBack,callback2,index)
    --Cache.load_prefabs(AssetList["clowndaoju_doublejinbi"], "clowndaoju_doublejinbi", function(prefab)
    --    if callBack then
    --        callBack()
    --    end
    --end)

    this:CoroutineLoadResource(function()
        --coroutine.wait(index)
        Cache.load_prefabs(AssetList["clowndaoju_doublejinbi"], "clowndaoju_doublejinbi", function(prefab)
            if prefab then
                local instance = fun.get_instance(prefab)
                log.r("instance clowndaoju_doublejinbi")
                if callback2 then
                    callback2(instance,"clowndaoju_doublejinbi")
                end
            end
        end)
        if callBack then
            callBack()
        end
    end)

end

return this