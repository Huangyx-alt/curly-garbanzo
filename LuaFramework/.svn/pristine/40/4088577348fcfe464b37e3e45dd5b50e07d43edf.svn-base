---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 8/11/2024 上午 11:04
---
local CoinsTurnState = Clazz(BaseFsmState, "CoinsTurnState")
local this = CoinsTurnState

function CoinsTurnState:New()
    local o = {}
    setmetatable(o, { __index = CoinsTurnState })
    return o
end

function CoinsTurnState:InitState()
end

function CoinsTurnState:OnEnter(fsm, previous)
    log.EditorLog("enter  CoinsTurnState")
    self._fsm = fsm
    self._owner = fsm:GetOwner()
    self.cardId, self.bingoOrder, self.pathReward = fsm:GetOwner():GetCardBingoCellsInfo()
    self.pathReward = ModelList.GoldenTrainModel:GetSettleData().pathReward
    log.r("golden train start play card  " .. self.cardId)
    self.cardMap = self:GetBingoCellsIndex()
    self:PlayCoinsTurn()
end

function CoinsTurnState:PlayCoinsTurn()
    local timeInterval = 0.3
    self.EffectEntry = BattleModuleList.GetModule("EffectEntry")
    coroutine.start(function ()
        for i = 1, #self.cardMap do
            log.r("PlayCoinsTurn  " .. self.cardId .. "  " .. self.cardMap[i])
            self:PlayCoinsTurnAnima(self.cardMap[i])
            --coroutine.wait(timeInterval)
        end
        local curModel = ModelList.BattleModel:GetCurrModel()
        fun.DelayPlaySound(curModel.Const.soundDelayTime1, "goldentraincoinsdown")
        coroutine.wait(1)
        self._fsm:GetOwner():PlayShake()
        coroutine.wait(1)
        self._fsm:GetOwner():SetCardProgress(true)
        self._fsm:ChangeState("ExtraRewardState")
    end)
end

function CoinsTurnState:GetBingoCellsIndex()
    local data = Csv.GetData("client_bingo_rule", 1, "content")
    local cellIndex = {}
    for i = 1, #self.bingoOrder do
        for m = 1, #data[self.bingoOrder[i]] do
            if not fun.is_include(data[self.bingoOrder[i]][m], cellIndex) then
                table.insert(cellIndex, data[self.bingoOrder[i]][m])
            end
        end
    end
    table.sort(cellIndex)
    return cellIndex
end

function CoinsTurnState:PlayCoinsTurnAnima(cellIndex)
    if ViewList.GoldenTrainBingoView then
        local effect = ViewList.GoldenTrainBingoView:GetCardView():GetCellBgEffect(self.cardId, cellIndex)
        --local effect = self.EffectEntry:GetCellChip(self.cardId, cellIndex)
        if effect then
            local cellType = self._owner:CheckCellType(self.cardId, cellIndex)
            log.r("PlayCoinsTurnAnima  cardId " .. self.cardId .. "  cell " .. cellIndex .. " type " .. cellType)
            local anima = fun.get_component(effect, fun.ANIMATOR)
            if anima then
                anima:Play(cellType == 1 and "fan" or (cellType == 2 and "fanmini" or "fanDouble"))
            end
        end
    end
end

function CoinsTurnState:Finish()

end

function CoinsTurnState:OnLeave(fsm)
    self._fsm = nil
    self._owner = nil
    self._posX = nil
end

function CoinsTurnState:Dispose()
    self:OnLeave(nil)
end

return this
