---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/6/26 11:03
---


---  卡牌战斗中的小丑触发特效
local BaseCardJokerEffect  =  require("View.Bingo.EffectModule.CardJoker.BaseCardJokerEffect")

local CardJokerEffect = BaseCardJokerEffect:New()
local this = CardJokerEffect

local jokerBallSprayer = nil
local jokerBallSprayerCallBack = nil

function CardJokerEffect:Init(cardView,cotainer)
    this.cardView = cardView
    this.cotainer = cotainer
end


function CardJokerEffect:PlayJokerDoubleCoin()
    BattleEffectCache:GetJokerPrefabFromCache("clown_doubleplayout",nil,3,nil,0,false)
    Cache.load_prefabs(AssetList["clown_doublebg"],"clown_doublebg",function (prefab)
        if prefab then
            local obj = fun.get_instance(prefab)
            if obj then
                local bg = ModelList.BattleModel:GetCurrBattleView().Bg
                obj.transform:SetParent(bg.transform)
                obj.transform.localScale = Vector3.one
                local size = fun.get_rect_delta_size(bg)
                fun.set_recttransform_native_size(obj,size.x,size.y)
                fun.set_active(obj,true)
            end
        end
    end)
    UISound.play("joker_doublecoins")
end

function CardJokerEffect:PlayHideJokerDoubleCoin()
    local jokerDta = ModelList.BattleModel:GetCurrModel():GetJokerCardData()
    if jokerDta then
        for i = 1, #jokerDta do
            local result = Csv.GetData("new_powerup",jokerDta[i].powerUpId,"result")
            if  result[1] == 15 then
                for k = 1, #jokerDta[i]. cardPowerUpEffect do
                    local clientPos = ConvertServerPos(jokerDta[i]. cardPowerUpEffect[k].posList[1])
                    local jokerBg = ModelList.BattleModel:GetCurrModel():GetRoundData(jokerDta[i].cardPowerUpEffect[k].cardId, clientPos):GetCellReferScript("Joker")
                    if jokerBg then
                        if fun.get_child_count(jokerBg) >0 then
                            Destroy(fun.get_child(jokerBg,0))
                        end
                    end
                end
            end
        end
    end
end


--- 获取小丑区域卡
function CardJokerEffect:PlayGetJokerBonuses(cardId,cellIndex)
    BattleEffectCache:GetJokerPrefabFromCache("clown_JokerBonuses",function(prefab)
        if prefab then
            local targetCell = self:GetJokerCellObj(cardId, cellIndex)
            if targetCell then
                fun.set_same_position_with(prefab,targetCell)
            end
            fun.set_active(prefab,true,1)
        end
    end,3,cardId,0,false)
    UISound.play("joker_bonues")
end

--- 获取小丑区域卡
function CardJokerEffect:PlayGetJokerBonuses1(cardId,cellIndex)
    BattleEffectCache:GetJokerPrefabFromCache("clown_JokerBonuses01",function(prefab)
        if prefab then
            local targetCell = self:GetJokerCellObj(cardId, cellIndex)
            if targetCell then
                fun.set_same_position_with(prefab,targetCell)
            end
        end
    end,1,cardId,0,false)
end


function CardJokerEffect:PlayGetJokerBlowRoll(cardId,cellIndex,jokerData)
    local prefabName = "clown_ChuiCJ1left"

    if jokerData and jokerData.params and #jokerData.params > 2 then
        prefabName = "clown_ChuiCJ2left"
        UISound.play("jocker_whistle2")
    else
        UISound.play("jocker_whistle1")
    end
    BattleEffectCache:GetJokerPrefabFromCache(prefabName,function(prefab)
        if prefab then
            local targetCell = self:GetJokerCellObj(cardId, jokerData.firstPos)
            if targetCell then
                fun.set_same_position_with(prefab,targetCell)
                if jokerData.direction.direction == 1 then
                    fun.set_gameobject_rot(prefab,0,0,90,true)
                elseif jokerData.direction.direction == 2 then
                    fun.set_gameobject_rot(prefab,0,0,-90,true)
                elseif jokerData.direction.direction == 4 then
                    fun.set_gameobject_rot(prefab,180,0,180,true)
                end
            end
        end
        LuaTimer:SetDelayFunction(1.2,function()
            local view = ModelList.BattleModel:GetCurrBattleView().cardView
            ---其余位置要盖章
            if jokerData then
                for k = 1, #jokerData.params do
                    local clientPos = ConvertServerPos(jokerData.params[k])
                    view:OnClickCardIgnoreJudgeByIndex(jokerData.cardId, clientPos, 0)
                end
            end
        end,nil,LuaTimer.TimerType.Battle)
    end,3,cardId,0,false)
end

local function GetCallNumbers()
    local ballData = ModelList.BattleModel:GetCurrModel():GetJokerCardData()
    for i = 1, #ballData do
        if ballData[i].callNumbers and #ballData[i].callNumbers > 0 then
            return ballData[i].callNumbers
        end
    end
end

local function HideCallNumberJokerPrefab()
    local jokerParent = ModelList.BattleModel:GetCurrBattleView():GetCallNumberView():GetJokerParent()
    if jokerParent then
        fun.set_active(jokerParent, false)
    end
end

--- 结束，播放彩球叫号器
function CardJokerEffect:PlayGetJokerBallSprayer(callBack)
    jokerBallSprayerCallBack = callBack
    BattleEffectCache:GetJokerPrefabFromCache("clown_penqiuqi", function(prefab)
        if prefab then
            jokerBallSprayer = {}
            HideCallNumberJokerPrefab()
            fun.set_rect_local_pos(prefab, 0, 0, 0)
            local refTemp = fun.get_component(prefab, fun.REFER)
            if refTemp then
                local numbers = GetCallNumbers()
                if numbers then
                    for i = 1, #numbers do
                        this:SetJokerBallSprayer(refTemp:Get("CqClownQiu0" .. i), numbers[i])
                    end
                end
            end
        end
        LuaTimer:SetDelayFunction(4.5, function()
            local  BingoJokerMachine = require("Combat.Machine.BingoJokerMachine")
            BingoJokerMachine:CheckJokerBallSprayerNumSign()
        end)
    end, 7.5, 1, 0, false)
    UISound.play("jocker_ballcaller")
end



function CardJokerEffect:SetJokerBallSprayer(ballObj,ballNum)
    local ballNum = ballNum or 1
    local refTemp = fun.get_component(ballObj,fun.REFER)
    local numberType = 5
    if refTemp then
        refTemp:Get("Text").text = ballNum
        if ballNum <= 15 then numberType = 1
        elseif ballNum <= 30 then numberType = 2
        elseif ballNum <= 45 then numberType = 3
        elseif ballNum <= 60 then numberType = 4  end
        refTemp:Get("ballType").sprite =  AtlasManager:GetSpriteByName("JokerBattleAtlas", "CqClownQiu"..numberType)
        table.insert(jokerBallSprayer,{number = ballNum,ballObj = ballObj})
    end
end

--- 彩球飞往卡牌
function CardJokerEffect:PlayGetJokerBallSprayerFly(signCellData)
    if signCellData and #signCellData > 0 then
        local model = ModelList.BattleModel:GetCurrModel()
        local data = nil
        local isFly = false
        local delayTime = 0.2
        for i = 1, #jokerBallSprayer do
            local isFly2 = false
            for k = 1, #signCellData do
                if signCellData[k].number == jokerBallSprayer[i].number then
                    --log.r("PlayGetJokerBallSprayerFly"..jokerBallSprayer[i].number)
                    for m = 1, #signCellData[k].flyData do
                        data = model:GetRoundData(signCellData[k].flyData[m].cardId, signCellData[k].flyData[m].cellIndex)
                        if data and data:IsNotSign() then
                            this:BallSprayerFlyToCard(jokerBallSprayer[i].ballObj, data:GetCellObj(), signCellData[k].flyData[m].cardId, signCellData[k].flyData[m].cellIndex,delayTime)
                            isFly = true
                            isFly2 = true
                        end
                    end
                end
            end
            delayTime = delayTime + 0.2
        end
        delayTime = 0.2
        for i = 1, #jokerBallSprayer do
            if jokerBallSprayer[i].ballObj then
                fun.set_active(jokerBallSprayer[i].ballObj,false,delayTime)
                if jokerBallSprayer[i].ballObj.transform.parent.parent then
                    local refTemp = fun.get_component(jokerBallSprayer[i].ballObj.transform.parent.parent,fun.REFER)
                    if refTemp then
                        fun.set_active(refTemp:Get("bao"..i),true,delayTime)
                    end
                end
            end
            delayTime = delayTime + 0.2
        end
        if isFly then
            LuaTimer:SetDelayFunction(1,function()
                Event.Brocast(EventName.Event_Play_Joker_BallSprayer_Over)
            end)
        end
    else
        Event.Brocast(EventName.Event_Play_Joker_BallSprayer_Over)
    end
end

--- 彩球飞往卡牌
function CardJokerEffect:PlayGetJokerBallSprayerFlyOver()
    if jokerBallSprayerCallBack then
        ModelList.BattleModel.SetHasJokerBallSprayer(false)
        jokerBallSprayerCallBack()
        jokerBallSprayerCallBack = nil
    end
end

function CardJokerEffect:BallSprayerFlyToCard(ballObj,targetCell,cardId,cellIndex,delayTime)
    local isShowing = BattleLogic.GetLogicModule(LogicName.SwitchLogic):IsShowing(cardId)
    if isShowing then
        local ItemObj =  fun.get_instance(ballObj,ballObj.transform.parent)
        fun.set_gameobject_scale(ItemObj, 1, 1, 1)
        local startPos = fun.get_gameobject_pos(ItemObj, false)
        local endPos = fun.get_gameobject_pos(targetCell, false)
        local path = {}
        path[1] = fun.calc_new_position_between(startPos, endPos, 0.65, 1, 0)
        path[2] = endPos
        fun.set_active(ItemObj, true)
        local flyTime  = 0.5
        LuaTimer:SetDelayFunction(delayTime,function()
            Anim.scale_to_xy(ItemObj,0.4,0.4,flyTime, nil)
        end)
        --log.r("delaytime == "..delayTime)
        Anim.bezier_move(ItemObj, path, flyTime, delayTime, 1, 2, function()
            local view = ModelList.BattleModel:GetCurrBattleView().cardView
            view:OnClickCardIgnoreJudgeByIndex(cardId, cellIndex, 0)
            DestroyImmediate (ItemObj)
        end)
    else
        local obj =  ModelList.BattleModel:GetCurrBattleView():GetSwitchView():GetSmallCardObj(cardId)
        this:BallSprayerFlyToSmallCard(ballObj,obj,cardId,cellIndex,delayTime)
    end

end

--- 号球飞到小卡牌（切换界面）
function CardJokerEffect:BallSprayerFlyToSmallCard(ballObj,targetCell,cardId,cellIndex,delayTime)
    local ItemObj =  fun.get_instance(ballObj,ballObj.transform.parent)
    fun.set_gameobject_scale(ItemObj, 1, 1, 1)
    local startPos = fun.get_gameobject_pos(ItemObj, false)
    local endPos = fun.get_gameobject_pos(targetCell, false)
    local flyTime  = 0.5
    LuaTimer:SetDelayFunction(delayTime,function()
        Anim.scale_to_xy(ItemObj,0.4,0.4,flyTime, nil)
    end)
    --Anim.scale_to_xy(ItemObj,0.4,0.4,0.5, nil)
    local path = {}
    path[1] = fun.calc_new_position_between(startPos, endPos, 0.65, 1, 0)
    path[2] = endPos
    fun.set_active(ItemObj, true)

    Anim.bezier_move(ItemObj, path, flyTime, delayTime, 1, 2, function()
        local view = ModelList.BattleModel:GetCurrBattleView().cardView
        view:OnClickCardIgnoreJudgeByIndex(cardId, cellIndex, 0)
        DestroyImmediate(ItemObj)
    end)
end

--- 彩球区域盖章效果
function CardJokerEffect:PlayJokerAreaGetEffect(cardId,cellIndex)
    BattleEffectCache:GetJokerPrefabFromCache("clown_JokerBonusesget",function(prefab)
        if prefab then
            local targetCell = self:GetJokerCellObj(cardId, cellIndex)
            if targetCell then
                fun.set_same_position_with(prefab,targetCell)
            end
        end
    end,2,nil,0,false)
end

--- 彩球区域盖章效果
function CardJokerEffect:PlayJokerFlyItems(cardId,cellIndex,itemId)
    local puCfg = table.find(Csv["new_powerup"], function(k, v)
        return v.itemid == itemId
    end)
    local checkJokerResource = puCfg and puCfg.result[1] == 18
    if checkJokerResource then
        local result = Csv.GetItemOrResource(itemId, "result")
        if ModelList.SeasonCardModel:IsCardPackage(result[2]) then
            --卡包不展示
            return
        end
        itemId = result[2]

        --周榜还是名人堂
        if result[1] == 29 then
            if ModelList.HallofFameModel:IsActivityAvailable() then
                itemId = 31
            elseif ModelList.TournamentModel:IsActivityAvailable() then
                itemId = 19
            end
        end
    end
    
    local targetCell = self:GetJokerCellObj(cardId, cellIndex)
    local startPos = fun.get_gameobject_pos(targetCell.gameObject, false)
    local flyItemContainer = require("View/Bingo/CardModule/BaseModules/CardFlyItemContainer")
    local targetPos = flyItemContainer:GetTargetPos("b_bingo_xz",nil,false)
    Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts, startPos, itemId, function()

    end, nil,nil,targetPos)
end

--- 彩球区域盖章效果
function CardJokerEffect:PlayHideJokerCellBg(cardId,data)
    local cell = ModelList.BattleModel:GetCurrModel():GetRoundData(cardId, data.firstPos):GetCellReferScript("Joker")
    if cell then
        local count = fun.get_child_count(cell)
        for i = count, 1,-1 do
            fun.set_active(fun.get_child(cell,i-1),false)
        end
    end
end

--- 引爆炸弹
function CardJokerEffect:PlayDetonateBomb(cardId, cellIndex, jokerData)
    --控制器动画
    BattleEffectCache:GetJokerPrefabFromCache("clown_Dileistart",function(controlObj)
        local view = ModelList.BattleModel:GetCurrBattleView().cardView
        local targetCellObj = view:GetCardCell(cardId, cellIndex)
        fun.set_same_position_with(controlObj, targetCellObj)

        LuaTimer:SetDelayFunction(0.8, function()
            ---盖章
            table.each(jokerData.params, function(serverPos)
                local clientPos = ConvertServerPos(serverPos)
                local cellData = ModelList.BattleModel:GetCurrModel():GetRoundData(cardId, clientPos)
                if not cellData or not cellData:IsNotSign() then
                    return
                end

                --炸弹特效
                BattleEffectCache:GetJokerPrefabFromCache("clown_Dileiget",function(prefab)
                    local targetCell = self:GetJokerCellObj(cardId, clientPos)
                    if targetCell then
                        fun.set_same_position_with(prefab, targetCell)
                    end
                    
                    --0.7后才爆炸
                    LuaTimer:SetDelayFunction(0.7, function()
                        UISound.play("jocker_landmine")
                        view:OnClickCardIgnoreJudgeByIndex(jokerData.cardId, clientPos, -3)
                    end, false, LuaTimer.TimerType.Battle)
                end, 3, cardId, 0, false)
            end)
        end, false, LuaTimer.TimerType.Battle)
    end, 3, cardId, 0, false)
end

--标记在移动中的格子，当短时间内使用两个锤子的时候，会导致格子出问题
local MovingTemp = {}
--- 资源锤子
function CardJokerEffect:PlayResourceHammer(cardId, cellIndex, jokerData)
    local view = ModelList.BattleModel:GetCurrBattleView().cardView

    local moveObj = function(tempObj)
        tempObj = tempObj.gameObject
        local instanceID = tempObj:GetInstanceID()
        if not MovingTemp[instanceID] then
            MovingTemp[instanceID] = true
            local y = fun.get_localposition(tempObj).y
            Anim.move_to_y(tempObj, y + 25, 0.12, function()
                local time = math.random(30, 50) * 0.01
                LuaTimer:SetDelayFunction(time, function()
                    Anim.move_to_y(tempObj, y, 0.15, function()
                        MovingTemp[instanceID] = false
                    end)
                end, nil, LuaTimer.TimerType.Battle)
            end)
        end
    end

    BattleEffectCache:GetJokerPrefabFromCache("clown_Chuizi",function(obj)
        local targetCellObj = view:GetCardCell(cardId, cellIndex)
        fun.set_same_position_with(obj, targetCellObj)

        --0.8秒后。。抬高格子跟爆开资源
        LuaTimer:SetDelayFunction(0.8, function()
            UISound.play("jocker_hummer")
            local model = ModelList.BattleModel:GetCurrModel()
            local puCfg = Csv.GetData("new_powerup", 623, "result")
            -- 飞资源
            local allGifts = {}
            table.each(jokerData.params, function(serverPos)
                local clientPos = ConvertServerPos(serverPos)
                if cellIndex == clientPos then
                    return
                end
                
                local cellObj = view:GetCardCell(cardId, clientPos)

                local cellData = model:GetRoundData(cardId, clientPos)
                if cellData and cellData:IsNotSign() then
                    --抬高格子
                    local refer = fun.get_component(cellObj, fun.REFER)
                    moveObj(refer:Get("bg_tip"))
                    moveObj(refer:Get("gift"))
                    moveObj(refer:Get("Joker"))
                    moveObj(refer:Get("JokerBg"))
                    moveObj(refer:Get("doublebg"))
                    moveObj(refer:Get("number1").transform.parent)

                    --格子资源飞出
                    local gifts, other = {}, {}
                    table.each(cellData.gift, function(itemID)
                        if not fun.is_include(itemID, puCfg) then
                            table.insert(gifts, itemID)
                            table.insert(allGifts, itemID)
                            
                            local puCfg = table.find(Csv["new_powerup"], function(k, v)
                                return v.itemid == itemID
                            end)
                            local checkJokerResource = puCfg and puCfg.result[1] == 18
                            if checkJokerResource then
                                self:PlayJokerFlyItems(cardId, cellIndex, itemID)
                            end
                        else
                            table.insert(other, itemID)
                        end
                    end)
                    cellData.gift = other
                    --Event.Brocast(EventName.Cell_Item_FlyTo_Box, cardId, clientPos, true, gifts)
                end
            end)

            --资源合并到锤子的格子
            local cellData = model:GetRoundData(cardId, cellIndex)
            table.each(allGifts, function(itemID)
                cellData:AddGift(itemID, true)
            end)
        end, nil, LuaTimer.TimerType.Battle)

    end, 3, cardId, 0, false)
end

return this