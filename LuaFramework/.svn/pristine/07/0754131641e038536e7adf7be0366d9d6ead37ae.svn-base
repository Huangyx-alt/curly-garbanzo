---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/5/19 14:21
---

local CardJokerEffect = { firstClownObj = nil, clownObj = nil ,playIndex = 1}

local this = CardJokerEffect
local jokerTable = {}
local private = {}
local loadCount = 0
local loadTargetCount = 0
local preLoadRes ={}

local prefabPre_clown = nil
local prefabPre_clown01 = nil

function CardJokerEffect:SetCardView(cardView)
    this.cardView = cardView
    this.delayPlayCardEffect = {}
    this.model =  ModelList.BattleModel:GetCurrModel()
    
    jokerTable = {}
    preLoadRes ={}
    prefabPre_clown01 = nil
    prefabPre_clown = nil
end

function CardJokerEffect:HasJokerCard()
    local jokerDta = ModelList.BattleModel:GetCurrModel():GetJokerCardData()
    return jokerDta and true or false
end

--- 第一个小丑入场效果
function CardJokerEffect:PlayFirstJokerCardEnterEffect(cb)
    if fun.is_not_null(prefabPre_clown01) then
        local view = ModelList.BattleModel:GetCurrBattleView()
        fun.set_parent(prefabPre_clown01, view.go, true)
        this.firstClownObj = prefabPre_clown01
        ModelList.BattleModel:GetCurrBattleView():SetReadyForPreUseItem(9)
        fun.SafeCall(cb)
    else
        Cache.load_prefabs(AssetList["clown01"],"clown01",function(obj)
            if obj and not fun.is_null(obj) then
                local view = ModelList.BattleModel:GetCurrBattleView()
                local clown = fun.get_instance(obj, view.go)
                if clown then
                    this.firstClownObj = clown
                end
            end
            ModelList.BattleModel:GetCurrBattleView():SetReadyForPreUseItem(9)
            fun.SafeCall(cb)
        end)
    end
end

--- 第一个小丑入场效果
function CardJokerEffect:PlayFirstJokerCardExitEffect()
    if this.firstClownObj then
        Destroy(this.firstClownObj)
        this.firstClownObj = nil
        prefabPre_clown01 = nil
    end
end


function CardJokerEffect:PlayJokerCardEnterEffect(cb)
    --local pos = fun.get_gameobject_pos(jokerPos,false)
    if this.firstClownObj then
        fun.set_active(this.firstClownObj,true)
        local anima =  fun.get_component(this.firstClownObj,fun.ANIMATOR)
        if anima then
            anima:Play("end")
        end 
        Destroy(this.firstClownObj,1)
        this.firstClownObj = nil
        prefabPre_clown01 = nil
    end
    if fun.is_not_null(prefabPre_clown) then
        this:CoroutinePlayEnter(cb)
    else
        Cache.load_prefabs(AssetList["clown"],"clown",function(obj)
            if obj and not fun.is_null(obj) then
                local view = ModelList.BattleModel:GetCurrBattleView()
                local clown =  fun.get_instance(obj,view.go)
                if clown then
                    --clown.transform.position = pos
                    this.clownObj = clown
                    this.playIndex = 1
                    this:LoadCardDetail()
                    this:PlayCardDetail(cb)
                end

                local count = GetTableLength(jokerTable)
                local soundName = string.format("jokerready%s", count > 3 and count or "")
                UISound.play(soundName)
            end
        end)
    end
end

---由协程控制小丑入场效果,缓解性能高峰
function    CardJokerEffect:CoroutinePlayEnter(cb)
    coroutine.start(function()
        log.r("CoroutinePlayEnter")
        this.clownObj = prefabPre_clown
        fun.set_parent(prefabPre_clown, ModelList.BattleModel:GetCurrBattleView().go, true)
        fun.set_active(this.clownObj,true)
        this.playIndex = 1
        WaitForEndOfFrame()
        this:LoadCardDetail()
        WaitForEndOfFrame()
        this:PlayCardDetail(cb)
        WaitForEndOfFrame()
        local count = GetTableLength(jokerTable)
        local soundName = string.format("jokerready%s", count > 3 and count or "")
        UISound.play(soundName)
    end)
end


function CardJokerEffect:GetCardParent(posIndex)
    if this.clownObj then
        local refScript = fun.get_component(this.clownObj,fun.REFER )
        if refScript then
            local pos = refScript:Get('card'..posIndex)
            return pos
        end
    end
end

function CardJokerEffect:PlayCardDetail(cb)
    local count = GetTableLength(jokerTable)
    --播动画
    local refScript = fun.get_component(this.clownObj,fun.REFER )
    if fun.is_not_null(refScript) then
        local animator = refScript:Get("animator")
        if fun.is_not_null(animator) then
            local showKey = private.GetJokerCardShowKey(count)
            local animationName = string.format("clown%s", showKey)
            animator:Play(animationName)
        end
    end
    
    local triggerEnd = false
    LuaTimer:SetDelayLoopFunction(2.4, 0.5, count, function()
        local jokerEffect = table.remove(jokerTable, 1)
        if jokerEffect then
            fun.set_active(jokerEffect:GetPrefab(), true)
            jokerEffect:Play()
        end
    end, function()
        if not triggerEnd then
            triggerEnd = true
            fun.SafeCall(cb)
        end
    end, false, LuaTimer.TimerType.Battle)

    --- 为了保证小丑卡的动画播放不会卡死流程
    LuaTimer:SetDelayFunction(6 + (count - 3) * 0.5, function()
        Destroy(this.clownObj)
        this.clownObj = nil
        private.ClearPoolPrefab()
        ModelList.BattleModel:GetCurrBattleView():SetReadyForPreUseItem(8)

        if not triggerEnd then
            triggerEnd = true
            fun.SafeCall(cb)
        end
    end)
end

function CardJokerEffect:LoadCardDetail()
    local jokerData = ModelList.BattleModel:GetCurrModel():GetJokerCardData()
    jokerTable = {}
    if jokerData then
        for i = 1, #jokerData do
            local data = jokerData[i]
            local result = Csv.GetData("new_powerup",data.powerUpId,"result")
            if result then
                local jokerRequire = nil
                if result[1] == 11 then  --joker bonues ，配置形状，关联到skill表
                    local jokerBall = require("View.Bingo.EffectModule.CardJoker.JokerAreaEnterEffect")
                    local effect = jokerBall:New()
                    effect:Init(self.cardView)
                    effect:SetInfo(data,this:GetCardParent(i),self)
                    jokerRequire = effect
                elseif result[1] == 12 then --吹吹卷，占n个格子
                    local jokerBall = require("View.Bingo.EffectModule.CardJoker.JokerBlowRollEnterEffect")
                    local effect = jokerBall:New()
                    effect:Init(self.cardView)
                    effect:SetInfo(data,this:GetCardParent(i),self)
                    jokerRequire = effect
                elseif result[1] == 13 or result[1] == 18 then --小丑卡丢itemID 到卡牌的格子上
                    local jokerBall = require("View.Bingo.EffectModule.CardJoker.JokerThrowItemEffect")
                    local effect = jokerBall:New()
                    effect:Init(self.cardView)
                    effect:SetInfo(data,this:GetCardParent(i),self)
                    jokerRequire = effect
                elseif result[1] == 14 then --彩球喷射器，结算时额外叫n个号码
                    local jokerBall = require("View.Bingo.EffectModule.CardJoker.JokerBallSprayerEnterEffect")
                    local effect = jokerBall:New()
                    effect:Init(self.cardView)
                    effect:SetInfo(data,this:GetCardParent(i),self)
                    jokerRequire = effect
                elseif result[1] == 15 then
                    --金币结算双倍
                    local jokerBall = require("View.Bingo.EffectModule.CardJoker.JokerDoubleCoinEffect")
                    local effect = jokerBall:New()
                    effect:Init(self.cardView)
                    effect:SetInfo(data, this:GetCardParent(i),self)
                    jokerRequire = effect
                elseif result[1] == 16 then
                    --遥控炸弹
                    local temp = require("View.Bingo.EffectModule.CardJoker.JokerRemoteBombEnterEffect")
                    local effect = temp:New()
                    effect:Init(self.cardView)
                    effect:SetInfo(data, this:GetCardParent(i),self)
                    jokerRequire = effect
                elseif result[1] == 17 then
                    --资源锤
                    local temp = require("View.Bingo.EffectModule.CardJoker.JokerResourceHammerEnterEffect")
                    local effect = temp:New()
                    effect:Init(self.cardView)
                    effect:SetInfo(data,this:GetCardParent(i),self)
                    jokerRequire = effect
                end
                table.insert(jokerTable,jokerRequire)
            end
        end
    end
end

function CardJokerEffect:PreloadJokerResource()
    loadCount = 0
    loadTargetCount = 0
    preLoadRes = {}
    self:CoroutineLoadResource()
    --Cache.Load_Atlas(AssetList["JokerBattleAtlas"],"JokerBattleAtlas",function()
    --    log.r("JokerBattleAtlas  load")
    --    self:CoroutineLoadResource()
    --end)
end

function CardJokerEffect:CoroutineLoadResource()
    --coroutine.start(function()
    --end)
    local jokerData = nil
    if ModelList.BattleModel:GetCurrModel() then
        jokerData =  ModelList.BattleModel:GetCurrModel():GetJokerCardData()
    end
    Cache.Load_Atlas(AssetList["JokerBattleAtlas"],"JokerBattleAtlas")
    if jokerData then
        Cache.load_prefabs(AssetList["clown"], "clown",function(prefab)
            if prefab then
                prefabPre_clown = fun.get_instance(prefab)
                fun.set_active(prefabPre_clown, false)
                fun.SetNotDestroyParent(prefabPre_clown)
            end
        end)
        --WaitForFixedUpdate()
        Cache.load_prefabs(AssetList["clown01"], "clown01",function(prefab)
            prefabPre_clown01 = fun.get_instance(prefab)
            fun.set_active(prefabPre_clown01, false)
            fun.SetNotDestroyParent(prefabPre_clown)
            --WaitForFixedUpdate()
        end)

    end
    log.r("load_joker_res")
    UISound.load_joker_res()

    private.PreloadPrefab()
end

function CardJokerEffect:GetPreloadPrefab(prefabName)
    if preLoadRes and preLoadRes[prefabName] and #preLoadRes[prefabName] > 0 then
        local obj = preLoadRes[prefabName][1]
        table.remove(preLoadRes[prefabName],1)
        --log.r("pool remove   "..obj.name.."  "..prefabName.."   length "..#preLoadRes[prefabName])
        return obj
    end
    return nil
end

function private.CheckLoadOver()
    if loadCount then loadCount = loadCount + 1 end
    log.g("loadCount = "..loadCount.." loadTargetCount = "..loadTargetCount)
    if loadCount >= loadTargetCount then
        loadCount = 0
        loadTargetCount = 0
        AssetManager.CheckLoadBattleOverCallBack()
    end
end

function private.PreloadPrefab()
    local jokerData = ModelList.BattleModel:GetCurrModel():GetJokerCardData()
    if not jokerData then
        private.CheckLoadOver()
        return
    end
    local delayTime = 4
    if jokerData then
        for i = 1, #jokerData do
            local data = jokerData[i]
            local result =  Csv.GetData("new_powerup",data.powerUpId,"result")
            if result then
                delayTime = delayTime + 1
                if result[1] >= 11 and result[1] <= 18  then  --joker bonues ，配置形状，关联到skill表
                    loadTargetCount = loadTargetCount + 1
                end
            end
        end
        for i = 1, #jokerData do
            local data = jokerData[i]
            local result =  Csv.GetData("new_powerup",data.powerUpId,"result")
            if result then
                delayTime = delayTime + 1
                if result[1] == 11 then  --joker bonues ，配置形状，关联到skill表
                    local jokerBall = require("View.Bingo.EffectModule.CardJoker.JokerAreaEnterEffect")
                    jokerBall:PreloadDependResource(private.CheckLoadOver,private.JokerPrefabPool,delayTime,data)
                elseif result[1] == 12 then --吹吹卷，占n个格子
                    local jokerBall = require("View.Bingo.EffectModule.CardJoker.JokerBlowRollEnterEffect")
                    jokerBall:PreloadDependResource(private.CheckLoadOver,private.JokerPrefabPool,delayTime,data)
                elseif result[1] == 13 or result[1] == 18 then --小丑卡丢itemID 到卡牌的格子上
                    local jokerBall = require("View.Bingo.EffectModule.CardJoker.JokerThrowItemEffect")
                    jokerBall:PreloadDependResource(private.CheckLoadOver,private.JokerPrefabPool,delayTime,data)
                elseif result[1] == 14 then --彩球喷射器，结算时额外叫n个号码
                    local jokerBall = require("View.Bingo.EffectModule.CardJoker.JokerBallSprayerEnterEffect")
                    jokerBall:PreloadDependResource(private.CheckLoadOver,private.JokerPrefabPool,delayTime,data)
                elseif result[1] == 15 then
                    --金币结算双倍
                    local jokerBall = require("View.Bingo.EffectModule.CardJoker.JokerDoubleCoinEffect")
                    jokerBall:PreloadDependResource(private.CheckLoadOver,private.JokerPrefabPool,delayTime,data)
                elseif result[1] == 16 then --遥控炸弹
                    local temp = require("View.Bingo.EffectModule.CardJoker.JokerRemoteBombEnterEffect")
                    temp:PreloadDependResource(private.CheckLoadOver,private.JokerPrefabPool,delayTime,data)
                elseif result[1] == 17 then  --资源锤
                    local temp = require("View.Bingo.EffectModule.CardJoker.JokerResourceHammerEnterEffect")
                    temp:PreloadDependResource(private.CheckLoadOver,private.JokerPrefabPool,delayTime,data)
                end
            end
        end
    end
end

function private.JokerPrefabPool(obj,objName)
    if obj then
        if not preLoadRes[objName] then
            preLoadRes[objName] = {}            
        end
        local mana = fun.GameObject_find("GameManager")
        local jokerRoot = fun.find_child(mana,"Joker")
        if not jokerRoot then
            jokerRoot = CreateEmptyGameobject(0,0,mana.transform)
            jokerRoot.name = "Joker"
        end
        if jokerRoot then
            fun.set_parent(obj,jokerRoot)
        end
        fun.set_active(obj, false)
        table.insert(preLoadRes[objName],obj)
        --log.r("pool remove   "..obj.name..  "  add  length "..#preLoadRes[objName])
    end
end

function private.ClearPoolPrefab()
    if preLoadRes then
        for k,v in pairs(preLoadRes) do
            for i = 1, #v do
                Destroy(v[i])
            end
        end
        preLoadRes = {}
        local mana = fun.GameObject_find("GameManager")
        local jokerRoot = fun.find_child(mana,"Joker")
        Destroy(jokerRoot)
    end
end

---计算应该要展示的JokerCard动画和卡片的Key
function private.GetJokerCardShowKey(jokerCardCount)
    local showKey
    local highLevelJokerCount, totalCount = Csv.GetPlayJokerCardsInfo()
    if highLevelJokerCount then
        --正常流程应该走到这里
        local normalJokerCardCount = totalCount - highLevelJokerCount
        showKey = string.format("%s%s", normalJokerCardCount, highLevelJokerCount)
    else
        if jokerCardCount < 7 then
            showKey = 30
            if jokerCardCount == 4 then showKey = 40
            elseif jokerCardCount == 5 then showKey = 41
            elseif jokerCardCount == 6 then showKey = 42 end
        else
            showKey = 43
            local playType = ModelList.BattleModel:GetGameType()
            if playType ~= PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
                if jokerCardCount >= 7 then
                    local curCityId = ModelList.CityModel.GetHomeCity()
                    if curCityId == 6 then showKey = 34
                    elseif curCityId == 7 then showKey = 25 end
                end
            end
        end
        showKey = tostring(showKey)
    end
    return showKey
end

return CardJokerEffect