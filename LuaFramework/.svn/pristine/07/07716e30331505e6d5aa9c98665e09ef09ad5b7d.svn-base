---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/7/7 18:52
---

local AdModel = BaseModel:New("AdModel")
local this = AdModel
this.CurrRewardAdCsvId = 0

this.delayAdid = nil
--this.delayPlayAd = false

this.AdTime = {}
this.stackAdFinish = {}
local adCount = nil
local userGroups

---插屏广告队列
local interstitialAdQueue = {}

function AdModel:InitData()
    Event.AddListener(EventName.Event_enter_hallView,self.EnterHomeScene,self)
    Event.AddListener(EventName.Event_enter_homescene,self.EnterHomeScene,self)
    Event.AddListener(EventName.Event_enter_hall_auto_View,self.EnterHomeScene,self)
end

function AdModel:CancelInitData()
    Event.RemoveListener(EventName.Event_enter_hallView,self.EnterHomeScene,self)
    Event.RemoveListener(EventName.Event_enter_homescene,self.EnterHomeScene,self)
    Event.RemoveListener(EventName.Event_enter_hall_auto_View,self.EnterHomeScene,self)
    interstitialAdQueue = {}
end

function AdModel:SetLoginData(data)
    interstitialAdQueue = {}
    adCount = deep_copy(data.adCount)
    this:SaveInterstitialAdQueue(data.interstitialAdPushedButNoView,data.groupIds)

    --检查超时状态下，有下发奖励没有提供

end

---获取可看广告次数
function AdModel.GetAdCount(eventType)
    if adCount then
        for key, value in pairs(adCount) do
            if eventType == value.event then
                return value.count,value.id
            end
        end
    end
    return 0,0
end

function AdModel.GeSingletAdByEventType(eventType)
    if adCount then
        for key, value in pairs(adCount) do
            if eventType == value.event then
                return value
            end
        end
    end
    return nil
end

function AdModel.GetAdByEventType(eventType1,eventType2)
    if adCount then
        for key, value in pairs(adCount) do
            if eventType1 == value.event or eventType2 == value.event then
                return value
            end
        end
    end
    return nil
end

function AdModel:EnterHomeScene()
    --if this:IsInterstitialAdCDOver() and SDK.IsInterstitialAdReady() then
    --    Facade.SendNotification(NotifyName.ShowUI, ViewList.AdBreakView, nil)
    --end
end

function AdModel:SetMagnifyingTime(key,Time)
    Time = Time or 0

    if not this.AdTime then 
        this.AdTime ={}
    end 
    this.AdTime[key] = Time
end

function AdModel:GetMagnifyingTime(key)
    if not this.AdTime then 
        this.AdTime ={}
    end 

    if not this.AdTime[key] then 
        return 0
    end 

    return this.AdTime[key] or 0
end

function AdModel.ReqMSG_AD_START(id,adEvent,adType,params)
    this.SendMessage(MSG_ID.MSG_AD_START, {adEvent =adEvent,adType = adType,params=params, id=id},true)
end

function AdModel:SaveCurrId(adEvent)
    log.y("当前广告类型  " .. adEvent)
    this.count, this.CurrRewardAdCsvId = this.GetAdCount(adEvent)
    this.DisPlayAd = true
    log.y("保存当前广告ID  " .. this.CurrRewardAdCsvId)
end

function AdModel:GetAdState()
    return this.DisPlayAd
end

function AdModel:SetAdState(state)
     this.DisPlayAd = state
end


function AdModel:GetCurrRewardId(adEvent)
    if adEvent == AD_EVENTS.AD_EVENTS_PLAY_GAME then
        --log.y("发送当前广告ID  " .. this.CurrRewardAdCsvId)
        if this.interstitialData then
            return this.interstitialData.id
        else
            return 0
        end
    end
    log.y("发送当前广告ID  " .. this.CurrRewardAdCsvId)
    return this.CurrRewardAdCsvId
end

function AdModel.ReqMSG_AD_FINISH_REWARD(adId,adSp,idfa,adEvent,params,adType)
    Util.RequestIDFA(function (device_id)
        this.SendMessage(MSG_ID.MSG_AD_FINISH_REWARD,{deviceId = device_id,adId = adId,
                                                      adSp = adSp,adEvent = adEvent,platform = 1,idfa = idfa,version = "1.0.1",
                                                      params = params,adType = adType,id = this.CurrRewardAdCsvId},true)
    end)
end

function AdModel.ReqRefreshAdCount()
    this.SendMessage(MSG_ID.MSG_AD_COUNT_NOTIFY,{},true)
end

---插屏广告的CD是否结束
function AdModel:IsInterstitialAdCDOver()
    this:CheckInterstitialQueue()
    if ModelList.PlayerInfoModel:GetUserType() and UserTypeBigR ==  ModelList.PlayerInfoModel:GetUserType() then
        return false
    end
    if  interstitialAdQueue and #interstitialAdQueue >0 then
        local lastIntertitialPlayTime = fun.read_value("last_intertitial_play_time",0)
        local lastRewardPlayTime = fun.read_value("last_reward_play_time",0)
        local rewardControlTime  = Csv.GetData("control", 92, "content")[1][1]
        local cd = Csv.GetData("advertise",interstitialAdQueue[1].id,"frequency_cd")
        if os.time() >= lastIntertitialPlayTime + cd  and os.time() >= lastRewardPlayTime + rewardControlTime then
            this.interstitialData = interstitialAdQueue[1]
            this.delayAdid = interstitialAdQueue[1].id
            return true
        end
    end
    return false
end


function AdModel.ResMSG_AD_START(code,data)

end

function AdModel:ShowInterstitialAd(data)
    if data.count == 0 then
        if interstitialAdQueue and #interstitialAdQueue >0 then
            for i = #interstitialAdQueue,1,-1  do
                if interstitialAdQueue[i].id == data.id then
                    table.remove(interstitialAdQueue,i)
                    log.r("remove inter  ")
                end
            end
        end
        --interstitialAdQueue = {}
    elseif data.count > 0 then
        local gruopIds = ModelList.PlayerInfoModel:GetMyGroupIds()
        this:SaveInterstitialAdQueue({{id = data.id,value = data.count}},gruopIds)
        this.CurrIntertiticalAdCsvId = data.id
        this.interstitialData = data
        --if data.count and data.count > 0 then
        --    this.delayPlayAd = true
        --end
    end
end

local AddInterstitialAdQueue = function (id,count)
    local ad = {}
    ad.id = id
    if count > 0 then
        for i = 1, count do
            --log.r("add inter  ")
            table.insert(interstitialAdQueue,ad)
        end
    end
end

function AdModel:IsCurrGroup(interstitialAdId)
    local groupIds = ModelList.PlayerInfoModel:GetMyGroupIds()
    if groupIds then
        for i = 1, #groupIds do
            if fun.is_include(tostring(groupIds[i]) ,Csv.GetData("advertise",interstitialAdId,"user_type_bi")) then
                return true
            end
        end
    end
    return false
end

---检查插屏广告队列是否过期
function AdModel:CheckInterstitialQueue()
    if interstitialAdQueue and #interstitialAdQueue >0 then
        for i = #interstitialAdQueue,1,-1  do
            if not  this:IsCurrGroup(interstitialAdQueue[i].id) then
                table.remove(interstitialAdQueue,i)
                --log.r("remove inter  ")
            end
        end
    end
end

function AdModel:SaveInterstitialAdQueue(data,groupIds)
    if groupIds then
        for i = 1, #groupIds do
            for k = #data, 1,-1 do
                if fun.is_include(tostring(groupIds[i]) ,Csv.GetData("advertise",data[k].id,"user_type_bi")) then
                    AddInterstitialAdQueue(data[k].id,data[k].value)
                    table.remove(data,k)
                end
            end
        end
    end

end

--服务器发过来更新广告次数
function AdModel.S2C_Updata_Ad_Count(code,data)
    --log.r("=================================>>S2C_Updata_Ad_Count "  .. code)
    if code == RET.RET_SUCCESS and data then
        if adCount then
            for key, value in pairs(data.adCount) do
                --log.r("=================================>>value.event "  .. tostring(value.event))
                local isExist = false
                for key2, value2 in pairs(adCount) do
                    if value.event == value2.event then
                        value2.count = value.count
                        value2.id = value.id
                        value2.type = value.type
                        value2.params = value.params
                        value.adType = value.adType
                        isExist = true
                        --log.r("=================================>>S2C_Updata_Ad_Count "  .. value.count)
                    end
                end
                if not isExist then
                    table.insert(adCount,value)
                end
                --弹出插屏广告
                if value.adType == AD_TYPE.AD_TYPE_ADVERTISE then
                    --local tab = JsonToTable(value.params)
                    this:ShowInterstitialAd(value)
                end
            end

            --todo 需要考虑更新界面，判断次数是否满足，显示还是关闭
            Event.Brocast(EventName.WatchLobbyAdViewRefresh)
            if ModelList.AppEventTimerModel then
                ModelList.AppEventTimerModel:OnGetNotify(MSG_ID.MSG_AD_COUNT_NOTIFY)
            end
        end
    end
end

function AdModel:C2S_WathchAdResult(adId,adSp,idfa,adEvent,adType,params)
    Util.RequestIDFA(function (device_id)
        --[[
        log.r("===========================>>RegularlyAwardModel:C2S_WathchAdResult1 " .. device_id)
        log.r("===========================>>RegularlyAwardModel:C2S_WathchAdResult2 " .. adId)
        log.r("===========================>>RegularlyAwardModel:C2S_WathchAdResult3 " .. adSp)
        log.r("===========================>>RegularlyAwardModel:C2S_WathchAdResult4 " .. idfa)
        log.r("===========================>>RegularlyAwardModel:C2S_WathchAdResult5 " .. adEvent)
        log.r("===========================>>RegularlyAwardModel:C2S_WathchAdResult6 " .. params)
        --]]

        if adEvent == AD_EVENTS.AD_EVENTS_HALL_DIAMOND  or  adEvent == AD_EVENTS.AD_EVENTS_HALL_COIN then
            AddLockCountOneStep()
        end
        local tb = {deviceId = device_id,adId = tostring( adId),adSp = adSp,adEvent = adEvent,platform = 1,
        idfa = idfa,version = "1.0.1",adType = adType, params = params, id = this:GetCurrRewardId(adEvent)}
        this.SendMessage(MSG_ID.MSG_AD_FINISH_REWARD,tb,true)
       
        this.stackAdFinish[tostring(adId)] = tb
        fun.save_value("stackAdFinish",this.stackAdFinish)
    end)
end

function AdModel.S2C_WathchAdResult(code,data)
    --log.r("========================>>RegularlyAwardModel:S2C_WathchAdResult " .. code)
    if code == RET.RET_SUCCESS and data then
        if data.adEvent == AD_EVENTS.AD_EVENTS_OFFLINE_IN_CD or data.adEvent == AD_EVENTS.AD_EVENTS_OFFLINE_NOT_IN_CD  then
            Facade.SendNotification(NotifyName.RegularlyAwardInfoView.UpDataRegularlyAwardInfo)
        elseif data.adEvent == AD_EVENTS.AD_EVENTS_SHOP_ITEM then
            Event.Brocast(EventName.Event_ShopDataUpdata)
        elseif data.adEvent == AD_EVENTS.AD_EVENTS_HALL_DAILY then
            --Event.Brocast(EventName.Event_ShopDataUpdata)
            ModelList.PlayerInfoModel.ReceiveDailyAward(RET.RET_SUCCESS ,{reward = data.reward})
        elseif data.adEvent == AD_EVENTS.AD_EVENTS_HALL_COIN  or data.adEvent == AD_EVENTS.AD_EVENTS_HALL_DIAMOND then
            Event.Brocast(EventName.WatchLobbyAdPosReward,data.reward)
        elseif data.adEvent == AD_EVENTS.AD_EVENTS_ACTIVITY_CD then
            Facade.SendNotification(NotifyName.Roulette.WatchVideoCallback)   
        elseif data.adEvent == AD_EVENTS.AD_EVENTS_SEASON_UP then
            Facade.SendNotification(NotifyName.BingoPass.WatchAdResult)
        elseif data.adEvent == AD_EVENTS.AD_EVENTS_TASK_PASS_UP then
            -- Facade.SendNotification(NotifyName.GamePlayShortPassView.WatchAd)
        end
      
        if this.stackAdFinish[tostring(data.adId)] ~= nil then 
            this.stackAdFinish[tostring(data.adId)] = nil
            fun.save_value("stackAdFinish",this.stackAdFinish)
        end 
    end
end

function AdModel.Login_Check_WathchAdResult()
    local tb = fun.read_value("stackAdFinish",nil)
    local count =  fun.table_len(tb) 
    if tb ~= nil and count >0 then  

        this.stackAdFinish = tb;
        log.g("重登的时候，发8002"..tostring(count))
        for _,v in pairs(this.stackAdFinish) do

            if v~= nil then 
                this.SendMessage(MSG_ID.MSG_AD_FINISH_REWARD,v,true)
                log.r(" 支付等待中的十秒轮询 adid"..tostring(v.adId))
                
            end 
           
         end
    end 

    return nil,nil
end 

this.MsgIdList =
{
    {msgid = MSG_ID.MSG_AD_START,func = this.ResMSG_AD_START},
    {msgid = MSG_ID.MSG_AD_FINISH_REWARD,func = this.S2C_WathchAdResult},
    {msgid = MSG_ID.MSG_AD_COUNT_NOTIFY, func = this.S2C_Updata_Ad_Count}
}

return this