---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/11/25 20:42
---
local CallNumberReadyState = require "View/Bingo/CallNumberState/CallNumberReadyState"
local CallNumberIdleState = require "View/Bingo/CallNumberState/CallNumberIdleState"
local CallNumberDropState = require "View/Bingo/CallNumberState/CallNumberDropState"
local CallNumberSortState = require "View/Bingo/CallNumberState/CallNumberSortState"
local CallNumberCompleteState = require "View/Bingo/CallNumberState/CallNumberCompleteState"

local GameCallNumberView = BaseView:New()
local this = GameCallNumberView

this.auto_bind_ui_items = {
    "Joker",
    "Bg",
    "ImgSpriteContainer",
    "rollBall",
    "magnifier",
    "CountDownTip",
}

function GameCallNumberView:New()
    local o = {}
    setmetatable(o, { __index = GameCallNumberView });
    return o
end

this.number_img_num = 10     --数字的图片数量
this.number_sprite_list = {} --数字sprite列表
this.reward_sprite_list = {} --卡牌基础奖励sprite列表
this.ball_sprite_list = {}   --号球sprite列表
this.ball_img_num = 5        --号球图片数量
this.parent = {}
this.lastNumbers = {}
this.loadData = {}

this.rollBallParent = nil --号球根节点
this.ballList = nil       --所有号球列表
this.model = nil
this.dropBallTemp = nil
local isSuperMatch = false


function GameCallNumberView:Init(bingoView, go, dropBallCallback)
    self.go = go
    self:on_init()
    this:SetCurrParent(bingoView)
    this:InitCallNumber(self.rollBall)
    this:SetDrop_ball_cb(function (currNumber)
        dropBallCallback(currNumber)
    end)
    this:RegisterEvent()
    this.SetNumberSpriteList()
    this:InitParams()
    this:CollectNumberBall()
    this:CollectNumberDropEffect()
    this:BuildFsm()
    --this:CoroutineLoad()
    fun.set_active(this.CountDownTip, false)
end

function GameCallNumberView:InitParams()
    this.model = ModelList.BattleModel:GetCurrModel()
    this.loadData = this.model:LoadGameData()
    isSuperMatch = ModelList.BattleModel.GetBattleSuperMatch()
end

function GameCallNumberView:SetCurrParent(my_parent)
    this.parent = my_parent
end

function GameCallNumberView:InitCallNumber(rollBallRef)
    this.rollBallParent = rollBallRef
    this:SetBallSpriteList()
    this:SetBallLetterSpriteList()
end

function GameCallNumberView.ReplaceCallNumberSpriteListForJoker(sp_container)
    if ModelList.BattleModel.GetIsJokerMachine() then
        if sp_container then
            for i = 1, 5 do
                local sprite = AtlasManager:GetSpriteByName("JokerBattleAtlas", "ClownBball" .. i)
                if sp_container.sprites and sp_container.sprites[i - 1] then
                    if sprite then
                        sp_container.sprites[i - 1] = sprite
                    end
                else
                    sp_container.sprites[i - 1] = sprite
                end
            end
        end
    end
end

function GameCallNumberView.ReplaceCallNumberTypeSpriteListForJoker(sp_container)
    if ModelList.BattleModel.GetIsJokerMachine() then
        if sp_container then
            for i = 1, 5 do
                sp_container.sprites[i - 1] = AtlasManager:GetSpriteByName("JokerBattleAtlas", "CqClownQiu" .. i)
            end
        end
    end
end

--储存数字sprite container
function GameCallNumberView.SetNumberSpriteList()
    this.number_sprite_list = {}
    if this.parent["ItemContainer"] then
        local isc = fun.get_component(this.parent["ItemContainer"], fun.IMAGESPRITESCONTAINER)
        if isc and isc.sprites and isc.sprites.Length > 0 and not Util.IsNull(isc:GetAsIndex(0)) then
            for i = 1, this.number_img_num do
                local sp = isc:GetAsIndex(i - 1)
                this.number_sprite_list[i] = sp
            end
        end
    end
    if #this.number_sprite_list == 0 then
        local sp_container = fun.get_component(this.parent.Bg, fun.IMAGESPRITESCONTAINER)
        for i = 1, this.number_img_num do
            local sp = sp_container:GetAsIndex(i - 1)
            this.number_sprite_list[i] = sp
        end
    end
end

--储存叫号的号球外框的sprite container
function GameCallNumberView:SetBallSpriteList()
    local sp_container = fun.get_component(self.rollBallParent, fun.IMAGESPRITESCONTAINER)
    --this.ReplaceCallNumberSpriteListForJoker(sp_container)
    for i = 1, this.ball_img_num do
        local sp = sp_container:GetAsIndex(i - 1)
        this.ball_sprite_list[i] = sp
    end
end

--储存叫号的 "B"  "I"  "N"  "G"  "O" 字母图片的sprite container
function GameCallNumberView:SetBallLetterSpriteList()
    local letterContainer = fun.find_child(self.rollBallParent.transform.parent, "ImgSpriteContainer")
    local sp_container = fun.get_component(letterContainer, fun.IMAGESPRITESCONTAINER)
    this.ball_letter_container = {}
    if sp_container == nil then
        return
    end
    --this.ReplaceCallNumberTypeSpriteListForJoker(sp_container)
    for i = 1, 5 do
        local sp = sp_container:GetAsIndex(i - 1)
        this.ball_letter_container[i] = sp
    end
end

function GameCallNumberView:GetBallLetter(index)
    if this.ball_letter_container then
        return this.ball_letter_container[index]
    end
end

function GameCallNumberView:CollectNumberBall()
    this.rollBallParent.gameObject:SetActive(true)
    this.ballList = {}
    
    local childCount = fun.get_child_count(this.rollBallParent)
    for i = 1, childCount do
        local ball = fun.get_child(this.rollBallParent, i - 1)
        table.insert(this.ballList, ball)
    end
end

--- normal 和 兴奋叫号特效
function GameCallNumberView:CollectNumberDropEffect()
    --this.rollBallParent.gameObject:SetActive(true)
    --local ball = fun.find_child(this.rollBallParent, "BallEffect")
    --if ball then
    --    this.BallEffect = fun.get_component(ball, fun.ANIMATOR)
    --end
end

--- 单独播放normal 和 兴奋叫号特效
function GameCallNumberView:PlayNumberDropEffect(effectType)
    if this.BallEffect then
        if effectType == 0 then
            fun.set_active(this.BallEffect, false)
        elseif effectType == 1 then
            fun.set_active(this.BallEffect, true)
            this.BallEffect:Play("normal")
        elseif effectType == 2 then
            fun.set_active(this.BallEffect, false)
            this.BallEffect:Play("exciting")
        end
    end
end

function GameCallNumberView:RegisterEvent()
    Event.AddListener(Notes.SYNC_NUMBER, this.DropBallEffect)
    Event.AddListener(EventName.CallNumber_View_Active, this.ActiveView)
    Event.AddListener(EventName.CallNumber_Update_Count_Down, this.UpdateCountDown)
end

function GameCallNumberView:UnRegisterEvent()
    Event.RemoveListener(Notes.SYNC_NUMBER, this.DropBallEffect)
    Event.RemoveListener(EventName.CallNumber_View_Active, this.ActiveView)
    Event.RemoveListener(EventName.CallNumber_Update_Count_Down, this.UpdateCountDown)
end

--显示新叫号效果
--阶段1：横向滚动
function GameCallNumberView:DropBallEffect(data)
    this._fsm:ChangeState("CallNumberDropState", data)
end

function GameCallNumberView:UpdateCountDown(num)
    fun.set_active(this.CountDownTip, num > 0)
    local color = "#ECFF23"
    num = string.format("<color=%s>%s</color>", color, num)
    this.CountDownTip.text = string.format("Round start in %s seconds", num)
end

function GameCallNumberView:ActiveView()
    if this and this.go then
        fun.set_active(this.go, true)
    end
end

function GameCallNumberView.CompleteDropBall()
    this._fsm:ChangeState("CallNumberCompleteState")
end

function GameCallNumberView:SetDrop_ball_cb(cb)
    this.drop_ball_callback = cb
end

function GameCallNumberView:CallDropBallcb(num)
    this.drop_ball_callback(num)
end

-- 播放星光到powerup
function GameCallNumberView:CallNumberStarTrailsToPowerup(ball)
    --if ModelList.BattleModel.GetBattleSuperMatch() then
    --    if this.parent.cardView and this.parent.powerView:CanRechargePowerUp() then
    --        this.parent.cardView.effContainer:CallNumberStarTrailsToPowerup(ball)
    --    end
    --end
end

--- 播放星光到super match
function GameCallNumberView:CallNumberBallStarTrailsToSuperMatchCard(ball)
    --if this.parent.cardView and this.parent.powerView:CanRechargePowerUp() then
    --    this.parent.cardView.effContainer:CallNumberStarTrailsToPowerup(ball)
    --end
end

-- 遍历数组
function GameCallNumberView:IsInTable(value, tbl)
    for k, v in pairs(tbl) do
        if v == value then
            return true;
        end
    end
    return false;
end

function GameCallNumberView:on_x_update()
end

function GameCallNumberView.OnDestroy()
    this:UnRegisterEvent()
    this:DisableAction()
    this:Close()
end

function GameCallNumberView:DisableAction()
    this.number_img_num = 10     --数字的图片数量
    this.number_sprite_list = {} --数字sprite列表
    this.reward_sprite_list = {} --卡牌基础奖励sprite列表
    this.ball_sprite_list = {}   --号球sprite列表
    this.ball_img_num = 5        --号球图片数量
    this.parent = {}
    this.lastNumbers = {}
    this.loadData = {}
    this.rollBallParent = nil --号球根节点
    this.ballList = nil       --所有号球列表
    this.model = nil
    this.dropBallTemp = nil
end

function GameCallNumberView:BuildFsm()
    this:DisposeFsm()
    this._fsm = Fsm.CreateFsm("GameCallNumberView", this, {
        CallNumberReadyState:New(),
        CallNumberIdleState:New(),
        CallNumberDropState:New(),
        CallNumberSortState:New(),
        CallNumberCompleteState:New()
    })
    this._fsm:StartFsm("CallNumberReadyState")
end

function GameCallNumberView:DisposeFsm()
    if this._fsm then
        this._fsm:Dispose()
        this._fsm = nil
    end
end

--没用到
function GameCallNumberView:GetDropBall()
    --this.dropBallIndex = this.dropBallIndex + 1
    --return this.ballList[this.dropBallIndex]
end

function GameCallNumberView:GetJokerParent()
    return self.Joker
end

function GameCallNumberView:CoroutineLoad()
    coroutine.start(function ()
        if self then
            coroutine.wait(0.5)
            if self then
                SetJokerSkin(self.Bg, "JokerBattleAtlas", "ClownBcallballDiup")
            end
            coroutine.wait(2.5)
            if self and fun.is_not_null(self.go) then
                this.originPos = fun.get_localposition(self.go)
                fun.set_rect_local_pos(self.go, 10000, 10000, 0)
                fun.set_active(self.go, true)
            end
            WaitForEndOfFrame()
            if self and fun.is_not_null(self.go) and this.originPos then
                fun.set_rect_local_pos(self.go, this.originPos.x, this.originPos.y, this.originPos.z)
                --fun.set_active(self.go, false)
            end
        end
    end)
end

--- 叫号球上增加super match效果,SuperMatchShouQiu
function GameCallNumberView:PlayCallSuperMatch(ball, isSuperMatchCall)
    if isSuperMatch then
        local child = fun.find_child(ball, "SuperMatchShouQiu")
        if child then
            fun.set_active(child, false)
        end
        if isSuperMatchCall then
            if child then
                fun.set_active(child, true)
            else
                Cache.load_prefabs(AssetList["SuperMatchShouQiu"], "SuperMatchShouQiu", function (obj)
                    if obj then
                        local qiu = fun.get_instance(obj, ball)
                        qiu.name = "SuperMatchShouQiu"
                    end
                end)
            end
            LuaTimer:SetDelayFunction(0.3, function ()
                if self then
                    self:FlyStarToRobot(ball)
                end
            end)
        end
    end
end

function GameCallNumberView:FlyStarToRobot(ball)
    if fun.is_not_null(ball) then
        local cards = this.parent:GetSuperMatch():GetView():GetSignCard()
        if cards and #cards > 0 then
            for i = 1, #cards do
                BattleEffectCache:GetPrefabFromPoolOrCache("SuperMatchTrail", ball, function (eff1)
                    if eff1 then
                        eff1.gameObject:SetActive(false)
                        eff1.gameObject:SetActive(true)
                        local start_position = ball.transform.position
                        local target = cards[i]  or ball
                        local end_pos = fun.get_gameobject_pos(target, false)
                        local path = {}
                        path[1] = fun.calc_new_position_between(start_position, end_pos, 0.45, 1, 0)
                        path[2] = end_pos
                        Anim.bezier_move(eff1, path, 0.6, 0, 1, 2, function ()
                            BattleEffectPool:DelayRecycle("SuperMatchTrail", eff1,0.4)
                            this.parent:GetSuperMatch():GetView():RealTriggerSuperMatch()
                        end)
                    end
                end)
            end
        else
            BattleEffectCache:GetPrefabFromPoolOrCache("SuperMatchTrail", ball, function (eff1)
                if eff1 then
                    eff1.gameObject:SetActive(false)
                    eff1.gameObject:SetActive(true)
                    local start_position = ball.transform.position
                    local spView = this.parent:GetSuperMatch()
                    local target = spView and spView:GetFlyPoint() or ball
                    local end_pos = fun.get_gameobject_pos(target, false)
                    local path = {}
                    path[1] = fun.calc_new_position_between(start_position, end_pos, 0.45, 1, 0)
                    path[2] = end_pos
                    Anim.bezier_move(eff1, path, 0.6, 0, 1, 2, function ()
                        BattleEffectPool:DelayRecycle("SuperMatchTrail", eff1,0.4)
                        this.parent:GetSuperMatch():GetView():RealTriggerSuperMatch()
                    end)
                end
            end)
        end
    end
end

return this
