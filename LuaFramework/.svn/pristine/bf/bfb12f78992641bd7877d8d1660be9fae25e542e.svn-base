---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 18/11/2024 下午 2:41
---

require "Model/ModelPart/BaseGameModel"
local bingoJokerMachine = require("Combat.Machine.BingoJokerMachine")

---鼹鼠矿工玩法
local ChristmasSynthesisModel = BaseGameModel:New()
local this = ChristmasSynthesisModel
local private = {}

------需要子类重写，设置参数------------------------------------------------------------------------------
function ChristmasSynthesisModel:InitModeOptions()
    self.gameType_ = PLAY_TYPE.PLAY_TYPE_CHRISTMAS_SYNTHESIS
    self.cityPlayID_ = 31
end

function ChristmasSynthesisModel:GetQuestItemOffsetPos()
    return 26.5, -32
end

------------------------------------------------------------------------------------------------------

function ChristmasSynthesisModel:InitData()
    self:InitModeOptions()
    self:SetSelfGameType(self.gameType_)
    self.bingoInfoRecord = { {}, {}, {}, {} }
    self.settleGameData = nil
end

function ChristmasSynthesisModel:ReqEnterGame()
    if not self:CheckCityIsOpen() then
        return
    end

    ModelList.BattleModel:DirectSetGameType(self.gameType_, self.cityPlayID_)
    ModelList.CityModel.SetPlayId(self.cityPlayID_)
    self:SetReadyState(0)

    local procedure = require "Procedure/ProcedureChristmasSynthesis"
    Facade.SendNotification(NotifyName.ShowUI, ViewList.SceneLoadingGameView, nil, nil, procedure:New())

    ModelList.CityModel:SavePreviousPlayInfo()
    self:ResetSettleCode()

    local cardNum = ModelList.CityModel:GetCardNumber()
    local city = ModelList.CityModel:GetCity()
    local powerupGear, powerupId = ModelList.CityModel:GetPowerupGear()
    local data = {
        cardNum = cardNum,
        rate = ModelList.CityModel:GetBetRate(),
        powerUpId = tonumber(powerupId),
        cityId = city,
        couponId = ModelList.CouponModel.get_currentCouponIdByCardNum(cardNum),
        useCouponId = ModelList.CouponModel.get_currentCouponUseIdByCardNum(cardNum),
        playId = ModelList.CityModel.GetPlayIdByCity(city),
        hideCardAuto = ModelList.BattleModel.GetIsAutoSign() and 1 or 0
    }
    self.SendMessage(MSG_ID.MSG_GAME_CHRISTMAS_SYNTHESIS, data)

    private.ClearExtraBallShakerData(self)
end

function ChristmasSynthesisModel:ReqSignCard(info)
    local cardIds = {}
    for i = 1, #info.total do
        if this:RefreshRoundDataByIndex(info.total[i].cardId, info.total[i].index, 1) then
            if not fun.is_include(info.total[i].cardId, cardIds) then
                table.insert(cardIds, info.total[i].cardId)
            end
            --this:CalcuateBingo(info.total[i].cardId, info.total[i].index, info.total[i].number)
        end
    end
    for i = 1, #cardIds do
        --this:CalcuateBingo(cardIds[i])
    end
end

function ChristmasSynthesisModel:RefreshRoundDataByIndex(cardid, cellIndex, signType, need_fly_item, mark)
    --父类处理
    local ret1, ret2 = this.__index:RefreshRoundDataByIndex(cardid, cellIndex, signType, need_fly_item, mark)

    --如果盖章触发技能/获得道具，添加sign计时，保证技能、道具动效播完
    local cell = self.roundData:GetCell(tostring(cardid), cellIndex)
    if cell then
        if cellIndex ~= 13 then
            cell.forbiddenSignType = true
        end
        if not cell:IsEmpty() then
            self.cardSignLogicDelayTime = os.time()
        end
    end

    return ret1, ret2
end

function ChristmasSynthesisModel.ResponeEnterGame(code, data)
    private.OnResEnterGame(this)
    if (code == RET.RET_SUCCESS) then
        log.log("ChristmasSynthesisModel.ResponeEnterGame bingoRuleId ", data.bingoRuleId)
        this:SaveGameLoadData(data)
        this:SetReadyState(1)
        this:InitRoundData()
        this:InitExtraData(data.ext)
        ModelList.BattleModel.SetBattleDouble(data.activityStatus)
        ModelList.BattleModel.SetIsJokerMachine(((data.jokerData and #data.jokerData > 0) or ModelList.CityModel:IsMaxBetRate()) and
            true or false)
        ModelList.BattleModel:BackupLoadData(data)
        this:SetGameState(GameState.Ready)
        Event.Brocast(EventName.Recorder_Data, 5001, data)
    else
        log.r("发送进入游戏失败" .. code)
        Event.Brocast(EventName.Event_Cancel_Loading_Game)
        UIUtil.return_to_scenehome()
        UIUtil.show_common_global_popup(8004, true)
    end
end

function ChristmasSynthesisModel.ResSettleGame(code, data)
    if (code == RET.RET_SUCCESS) then
        log.log("ChristmasSynthesisModel.ResSettleGame succ ")
        this.settleGameData = data
        local settleInfo = data.settleInfo
        for i1, v1 in ipairs(settleInfo) do
            for i2 = 1, #v1.bingoPath do
                v1.bingoPath[i2] = this:TransformBingoPathIdS2C(v1.bingoPath[i2])
            end

            for i3, v3 in ipairs(v1.pathReward) do
                v3.bingoPath = this:TransformBingoPathIdS2C(v3.bingoPath)
                for i5, v5 in ipairs(v3.markedPos) do
                    v5.pos = ConvertServerPos(v5.pos)
                    if #v5.itemReward > 0 then
                        v5.hasMini = v5.itemReward[1].id == 191003 and true or false
                        v5.hasDouble = v5.itemReward[1].id == 191002 and true or false
                    else
                        v5.hasMini = false
                        v5.hasDouble = false
                    end
                end
            end

            for i4, v4 in ipairs(v1.markedPos) do
                v4.pos = ConvertServerPos(v4.pos)
                if #v4.itemReward > 0 then
                    v4.hasMini = v4.itemReward[1].id == 191003 and true or false
                    v4.hasDouble = v4.itemReward[1].id == 191002 and true or false
                else
                    v4.hasMini = false
                    v4.hasDouble = false
                end
            end
        end
        this.settleInfo = settleInfo
    else
        log.log("ChristmasSynthesisModel.ResSettleGame fail ")
    end
end

function ChristmasSynthesisModel:ResBingoInfo(code, data)
    if (code == RET.RET_SUCCESS) then
        this:SaveBingoLeftInfo(data)
        if this.onlySaveBingoInfo then
            return
        end
        this:RefreshBingoInfo()
        Facade.SendNotification(NotifyName.Bingo.Sync_Bingos)
        if data.bingoLeft <= 10 then
            UISound.set_bgm_volume(0.7)
        end
        if data.bingoLeft <= 0 and this:GetReadyState() == 1 then
            this:SetReadyState(2)
            LuaTimer:SetDelayFunction(MCT.delay_to_show_settle, function ()
                this.loop_delay_settle = LuaTimer:SetDelayLoopFunction(0.1, 0.1, 100, function ()
                    --if this:IsGameSettling() then
                    this:ShowSettle()
                    LuaTimer:Remove(this.loop_delay_settle)
                    --end
                end, nil, nil, LuaTimer.TimerType.Battle)
            end)
        end
    else
        log.w("同步Bingo错误")
    end
end

function ChristmasSynthesisModel:OnReceiveSettle()
    if self:GetGameState() < GameState.ShowSettle then
        self:ShowSettle()
    end
end

function ChristmasSynthesisModel:Clear()
    table.each(self.loop_delay_checks, function (v)
        LuaTimer:Remove(v)
    end)

    this.__index:Clear()
    this.settleInfo = nil
    this.settleGameData = nil

    self.bingoInfoRecord = { {}, {}, {}, {} }
end

--- 卡面上的bingo表现有延迟，确保最新一个bingo效果能满足最低存活时间
function ChristmasSynthesisModel:IsBingoShowComplete()
    local check = this.__index:IsBingoShowComplete()

    --- 所有卡都是处于idle状态
    local allCardIdle = ViewList.ChristmasSynthesisBingoView:GetCardView():CheckAllCardIdle()

    --cell被盖章后飞出道具及做动画的时间
    local checkTime = os.time() - self.cardSignLogicDelayTime > 1.5
    return check and checkTime and allCardIdle
end

--- 需要等特效还有bingo画面啥的都得等播放完再弹出结算界面
--- 战斗结算前，检查彩球叫号器
function ChristmasSynthesisModel:CheckJokerBallSprayer(callBack)
    local haveJokerBall = ModelList.BattleModel.HasJokerBallSprayer()
    private.StartSkillEmptyCheck(self, function ()
        local cb = function ()
            if haveJokerBall then
                --有彩球喷射器，等技能、盖章效果播完再继续彩球喷射器
                --这里等4秒是因为彩球喷射器动画太长，要等动画播完才走盖章逻辑
                LuaTimer:SetDelayFunction(4, function ()
                    private.StartSkillEmptyCheck(self, function ()
                        callBack()
                    end)
                end)
            else
                --没有彩球喷射器，等技能、盖章效果播完直接打开结算界面
                callBack()
            end
        end
        bingoJokerMachine:CheckJokerBallSprayer(cb)
    end)
end

function ChristmasSynthesisModel:PlayBattleOverSound()
    UISound.play("minerbattleover")
end

function ChristmasSynthesisModel:GetCurrentCollectLevel()
    local level = self:GetBattleExtraInfo("longStage")
    log.log("ChristmasSynthesisModel:GetCurrentCollectLevel the level is ", level)
    level = level and tonumber(level) or 1
    return level
end

function ChristmasSynthesisModel:GetDefaultReward()
    local reward = self:GetBattleExtraInfo("trainBingoReward") or 0
    log.log("ChristmasSynthesisModel:GetDefaultReward the reward is ", reward)
    return reward
end

--- 保存当前战斗bingo数据
function ChristmasSynthesisModel:RecordBingoInfo(cardId, info)
    table.insert(self.bingoInfoRecord[cardId], info)
end

function ChristmasSynthesisModel:GetBingoCount(cardId)
    if not self.bingoInfoRecord then
        return 0
    end

    if not self.bingoInfoRecord[cardId] then
        return 0
    end

    return #self.bingoInfoRecord[cardId]
end

function ChristmasSynthesisModel:RefreshRoundDataByIndex(cardid, cellIndex, signType, need_fly_item, mark, extraPos)
    --父类处理
    self.__index:RefreshRoundDataByIndex(cardid, cellIndex, signType, need_fly_item, mark, nil)
    ---盖章完成后,不需要即时检查是否形成bingo,统一返回false
    return false
end

function ChristmasSynthesisModel:GetWishCellInfoList(cardId)
    --- 具体数据参见ChristmasSynthesisData2
    return CalculateBingoMachine.SeekInfo(4, cardId)

    --undo 格式如下
    --[[
    local info1 = {}
    info1.wishCellIndex = x --(1 <= x <= 25) 所缺格子的索引
    info1.wishBingoType = y --(1 <= y <= 9), 3x3, 3x4, 4x3, 3x5, 5x3, 4x4, 4x5, 5x4, 5x5，类型的枚举
    info1.cellIdxList = {idx1,idx2, ... idxn} --区域内所有格子索引（包括wishIdx),从小到大的有序数组
    table.insert(infoList, info1)
    --]]
    --return infoList --包含些卡面所有合理的wishInfo
end

function ChristmasSynthesisModel:GetCurrentBingoType(cardId)
    --undo 格式如下
    --[[
    local curBingoType = x --(0 <= x <= 9), no, 3x3, 3x4, 4x3, 3x5, 5x3, 4x4, 4x5, 5x4, 5x5，类型的枚举
    --]]
    local data = CalculateBingoMachine.SeekInfo(3, cardId)
    ---data.weight  = width*height
    ---data.width
    ---data.height
    return data
end

--undo wait data
function ChristmasSynthesisModel:GetBingoReward(idx, useThousandSeparator)
    local bingoRewardList = self:GetBattleExtraInfo("bingoReward")
    if not bingoRewardList then
        log.log("ChristmasSynthesisModel:GetBingoReward no bingoReward data")
        bingoRewardList = { 0, 0, 0, 0, 0, 0, 0 }
    end

    if idx >= 1 and idx <= 6 then
        local curReward = bingoRewardList[tostring(idx)] or 0
        if curReward >= 100000 and useThousandSeparator then
            local newValue = fun.formatNum(curReward / 1000) .. "K"
            return newValue, curReward
        else
            local newValue = fun.formatNum(curReward)
            return newValue, curReward
        end
    end

    return 0
end

--- 返回数字格子的奖励数值
function ChristmasSynthesisModel:GetBingoReward2(idx)
    local bingoRewardList = self:GetBattleExtraInfo("bingoReward")
    if not bingoRewardList then
        log.log("ChristmasSynthesisModel:GetBingoReward no bingoReward data")
        bingoRewardList = { 0, 0, 0, 0, 0, 0, 0 }
    end
    if idx >= 1 and idx <= 6 then
        return bingoRewardList[tostring(idx)] or 0
    end
    return 0
end

function ChristmasSynthesisModel:Area2BingoIdx(area)
    if area == 25 then
        return 6
    elseif area == 20 then
        return 5
    elseif area == 16 then
        return 4
    elseif area == 15 then
        return 3
    elseif area == 12 then
        return 2
    elseif area == 9 then
        return 1
    end

    return 0
end

-----------------私有方法----------------------------------------------

---开始一场新的对局，初始化本地数据
function private.OnResEnterGame(self)
    self.cardSignLogicDelayTime = 0
    self.cachedSkillDataCache = {}
    self.loop_delay_checks = {}
end

function private.StartSkillEmptyCheck(self, cb)
    local loop_delay_check
    loop_delay_check = LuaTimer:SetDelayLoopFunction(0.2, 0.1, -1, function ()
        local effectObjContainer = ModelList.BattleModel:GetCurrBattleView().effectObjContainer
        if effectObjContainer then
            local isSkillEmpty = effectObjContainer:IsSkillContainerEmpty()
            if isSkillEmpty then
                LuaTimer:Remove(loop_delay_check)
                cb()
            end
        else
            LuaTimer:Remove(loop_delay_check)
            cb()
        end
    end, nil, nil, LuaTimer.TimerType.Battle)
    table.insert(self.loop_delay_checks, loop_delay_check)
end

function private.GetCellItemType(cellData)
    local type

    table.each(cellData.hide_gift, function (v2)
        if 4 == math.floor(v2.id / 10000000) then
            type = 1
        else
            local cfg = Csv.GetData("item", v2.id, "result")
            if cfg[1] == 44 then
                type = cfg[2]
            end
        end
    end)

    return type
end

function private.FindNewTypeForPtgSkill(cardId, excludeTypes)
    local ret = {}
    local cells, newType = BattleLogic.GetLogicModule(LogicName.Card_logic):GetSkillNeedCells(cardId, excludeTypes)
    if not cells or not newType then
        return {}
    end

    table.each(cells, function (cellData)
        if cellData:IsNotSign() then
            table.insert(ret, cellData.index)
        end
    end)

    if #ret == 0 then
        if #excludeTypes == 4 then
            return {}
        else
            table.insert(excludeTypes, newType)
            return private.FindNewTypeForPtgSkill(cardId, excludeTypes)
        end
    else
        return ret, newType
    end
end

-------------------------------------------------------region 卡摇奖-------------------------------------------------------
function private.ClearExtraBallShakerData(self)
    self.ShakerData = nil
end

function private.SaveExtraBallShakerData(self, data)
    self.ShakerData = data
end

function private.GetExtraBallShakerData(self)
    return self.ShakerData
end

--收到摇球机数据
function ChristmasSynthesisModel:GetSmallGameData()
    return private.GetExtraBallShakerData(this)
end

--收到摇球机数据
function ChristmasSynthesisModel.ResponeBallShaker(code, data)
    log.log("ChristmasSynthesisModel.ResponeExtraBallShaker ", code, data)
    if (code == RET.RET_SUCCESS) then
        --data = this.GetShakerData()
        private.SaveExtraBallShakerData(this,data)
        Event.Brocast(EventName.Event_Receive_SmallGame_Data,true)
    else
        Event.Brocast(EventName.Event_Receive_SmallGame_Data, false)
    end
end

--返回摇奖结果
function ChristmasSynthesisModel.ResponeBallShakerResult(code, data)
    --附带其它-推送协议
    table.each(data and data.nextMessages, function (v)
        local body = Base64.decode(v.msgBase64)
        local ret = Proto.decode(v.msgId, body)
        ret.noResponeNotify = true
        Message.DispatchMessage(v.msgId, v.code, ret)
    end)

    if (code == RET.RET_SUCCESS) then
        if ViewList.ChristmasSynthesisExtraBallView then
            ViewList.ChristmasSynthesisExtraBallView:ShowExtraBall(data.index)
        end
    elseif code == RET.RET_GAME_NOT_EXIST then
        if BingoBangEntry.IsReplayBattle then
            if ViewList.ChristmasSynthesisExtraBallView then
                ViewList.ChristmasSynthesisExtraBallView:ReplayShowExtraBall()
            end
        else
            ---游戏不存在,主动拉取一次游戏结算数据
            this:ReqFetchSettle()
        end
    end
end

---摇球机使用球
function ChristmasSynthesisModel:ReqExtraBall(index)
    local gameId = ModelList.ChristmasSynthesisModel:GetGameId()
    self.SendMessage(MSG_ID.MSG_GAME_BALL_SHAKER_USE, { gameId = gameId, index = index })
end

function ChristmasSynthesisModel:SignCardWithExtraBall(cardId, cellIndex)
    ---特殊处理,清理掉技能
    local cell = self.roundData:GetCell(tostring(cardId), cellIndex)
    cell:ResetSkill()
    cell:ResetJoker()
    ModelList.ChristmasSynthesisModel:SignCardWithPowerUpByIndex(cardId, cellIndex, false)
end

-------------------------------------------------------endregion 卡摇奖-------------------------------------------------------



-----------------------------------------------------region 大厅气泡提示相关--------------

function ChristmasSynthesisModel:IsTriggerExtraReward()
    local curRate = ModelList.CityModel:GetBetRate()
    -- local playid = ModelList.CityModel.GetPlayIdByCity()
    -- local minBet = Csv.GetData("city_play", playid, "supermatch_bet")
    -- if minBet == 0 then return false end
    if ModelList.UltraBetModel:IsActivityValid() then
        return true
    end

    return curRate >= 8
end

function ChristmasSynthesisModel:GetExtraRewardTipIconSprite()
    local curSprite = AtlasManager:GetSpriteByName("ChristmasSynthesisHallAtlas", "BlessingTitleSdm")
    return curSprite
end

-----------------------------------------------------endregion 大厅气泡提示相关--------------



this.BaseMsgIdList = {
    { msgid = MSG_ID.MSG_GAME_CHRISTMAS_SYNTHESIS, func = this.ResponeEnterGame },
    --{ msgid = MSG_ID.MSG_GAME_BALL_SHAKER_INFO,    func = this.ResponeExtraBallShaker },
    --{ msgid = MSG_ID.MSG_GAME_BALL_SHAKER_USE,     func = this.ResponeExtraBallShakerResult },
}

return this
