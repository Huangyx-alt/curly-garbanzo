---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/10/19 17:36
---

require("View/Bingo/FsmCreator")
local GiftPackEnterState = require("View.GiftPack.State.GiftPackEnterState")
local GiftPackShowState = require("View.GiftPack.State.GiftPackShowState")
local GiftPackExitState = require("View.GiftPack.State.GiftPackExitState")
local GiftPackTransState = require("View.GiftPack.State.GiftPackTransState")

---@class   GiftPackBaseView
local GiftPackBaseView = BaseDialogView:New('GiftPackBaseView', "GiftPackAtlas")
local this = GiftPackBaseView

this.viewType = CanvasSortingOrderManager.LayerType.PackageDialog
--this._cleanImmediately = true
this.isCleanRes = true

this.isClickSale = 2 --点击购买状态 1：点击购买 2：手动点击关闭
this.isPurchaseSuccess = false --是否购买成功


function  GiftPackBaseView:SetDetailInfo()

end

function  GiftPackBaseView:OnBuySuccess(needClose)

end

function GiftPackBaseView:BuildFsm(owner)
    FsmCreator:Create("GiftPackBaseView",owner,{
        GiftPackEnterState:New(),
        GiftPackShowState:New(),
        GiftPackExitState:New(),
        GiftPackTransState:New(),
    })
    this.state = {
        GiftPackEnterState = "GiftPackEnterState",
        GiftPackShowState = "GiftPackShowState",
        GiftPackExitState = "GiftPackExitState",
        GiftPackTransState = "GiftPackTransState",
    }
    owner._fsm:StartFsm(this.state.GiftPackEnterState,owner)
end

function GiftPackBaseView:ChangeState(owner,nextState,...)
    owner._fsm:ChangeState(nextState,...)
end


function  GiftPackBaseView:New(viewName,atlasName)
    local o = {}
    o.viewName = viewName
    o.atlasName = atlasName
    setmetatable(o,{__index = GiftPackBaseView})
    return o
end

function  GiftPackBaseView:IsIdle(owner)
    if owner._fsm and owner._fsm:GetCurName() == "GiftPackEnterState" then
        return true
    end
    return false
end

function GiftPackBaseView:CloseUIShiny(obj)
    local uishiny = fun.get_component(obj,"UIShiny")
    if uishiny then
        uishiny.enabled = false
    end
end


function GiftPackBaseView:Bi_Tracker()
   --local  data = ModelList.GiftPackModel:GetShowGiftPack()
   -- if data then
   --     local product_list = {}
   --     local priceStr = ""
   --     for _, v in pairs(Csv.pop_up) do
   --         if data.pId == v.gift_id then
   --             table.insert(product_list,v.id)
   --             local xls = Csv.GetData("pop_up", v.id)
   --             if #priceStr == 0 then
   --                 priceStr = xls.price
   --             else
   --                 priceStr = priceStr.."_".. xls.price
   --             end
   --         end
   --     end
   --     local data = {gift_name = self.viewName, price = priceStr}
   --     SDK.giftpack_open  (data)
   -- end
end


function GiftPackBaseView:ReportGiftPackCloseEvent()
    local  data = ModelList.GiftPackModel:GetShowGiftPack()
    if data then
        local product_list = {}
        local priceStr = ""
        for _, v in pairs(Csv.pop_up) do
            if data.pId == v.gift_id then
                table.insert(product_list,v.id)
                local xls = Csv.GetData("pop_up", v.id)
                if #priceStr == 0 then
                    priceStr = xls.price
                else
                    priceStr = priceStr.."_".. xls.price
                end
            end
        end
        local level = ModelList.PlayerInfoModel:GetLv()
        local vip = ModelList.PlayerInfoModel:GetVIP()
        if this.isClickSale == 2 then
            this.isPurchaseSuccess = ""
        end
        local data = {issuccess = this.isPurchaseSuccess ,isclick = this.isClickSale ,itempos = self.viewName or  data.pId , level = level , viplevel = vip}
        SDK.giftpack_open(data)
    end
end

function GiftPackBaseView:OpenUIShiny(obj)
    local uishiny = fun.get_component(obj,"UIShiny")
    if uishiny and not  uishiny.enabled then
        uishiny.enabled = true
        return true
    end
    return false
end

--给数字串插入逗号（产生好多内存碎片）
function GiftPackBaseView:formatNumByLength(num,maxLenth)
    if maxLenth and  #tostring(num) >maxLenth then
        return fun.format_number(num)
    else
        return fun.formatNum(num)
    end
end


function GiftPackBaseView:SetContent(id,txt,content,maxLength)
    id = tonumber(id)
    if id == 3  then  --放大镜，不需要数字加逗号
        txt.text = content
    else
        txt.text = GiftPackBaseView:formatNumByLength(content,maxLength)
    end
end

function GiftPackBaseView:SetGray(id,txt,content,maxLength)
    id = tonumber(id)
    if id == 3  then  --放大镜，不需要数字加逗号
        txt.text = content
    else
        txt.text = GiftPackBaseView:formatNumByLength(content,maxLength)
    end
end

function GiftPackBaseView:SetClickPurchase()
    this.isClickSale = 1
end

function GiftPackBaseView:SetPurchaseState(state)
    this.isPurchaseSuccess = state
end

function GiftPackBaseView:InitReportData()
    this.isClickSale = 2 --点击购买状态 1：点击购买 2：手动点击关闭
    this.isPurchaseSuccess = "" --是否购买成功（成功：1；购买失败：2；取消：3；isClick值为2返回空值）
end

return this