---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/9/2 17:47
---

HallRobotMsgView = BaseView:New("HallRobotMsgView")
local this = HallRobotMsgView
this.viewType = CanvasSortingOrderManager.LayerType.None

this.auto_bind_ui_items = {
    "text_msg",
    "img_head",
    "text_level",
    "text_name",
    "img_name_frame",
    "chat_fitter"
}

function HallRobotMsgView:New()
    local o = {}
    self.__index = self
    setmetatable(o,self)
    return o
end

function HallRobotMsgView:Awake()
    self:on_init()
end

function HallRobotMsgView:OnEnable()
    self._init = true
    self:ResetChat()
end

function HallRobotMsgView:OnDisable()
    self._init = nil
end

function HallRobotMsgView:SetParent(parent,active)
    if parent then
        fun.set_parent(self.go,parent)
        fun.set_active(self.go,active)
    end
end

function HallRobotMsgView:SetPosition(pos)
    if self.go then
        self.go.transform.anchoredPosition = pos
    end
end

function HallRobotMsgView:GetSizeDelta()
    --[[
    if self.go then
        return self.go.transform.sizeDelta
    end
    return nil
    --]]
    return self.chat_fitter.Size
end

function HallRobotMsgView:ResetChat()
    if self._init then
        if self._desc and self._robot then
            self:SetTextInfo(self._desc,self._robot)
        else
            self:SetChat()
        end
    end
end

function HallRobotMsgView:SetChat()
    if not self._init then
        self._desc = nil
        self._robot = nil
        return
    end
    local msg = Csv.GetControlByName("city_message_send")
    local index = math.random(1,100)
    if index <= msg[1][2] then
        index = msg[1][1]
    elseif index <= msg[1][2] + msg[2][2] then
        index = msg[2][1]
    else
        index = msg[3][1] 
    end
    local msgId = Csv.GetData("city_message",index,"description")
    local robot_index = math.random(1,#Csv.robot_name)
    local robot = Csv.robot_name[robot_index]
    local desc = Csv.GetData("description",msgId,"description")
    desc = string.format(desc,robot.name)

    self:SetTextInfo(desc,robot)

    self._desc = desc
    self._robot = robot

    local message_type = Csv.GetData("city_message",index,"message_type")
    if message_type == 2 then
        UISound.play("salute")
    end

    --[[
    --测试
    local num = math.random(1,5)
    for i = 1, num do
        self.text_msg.text = self.text_msg.text .. desc
    end
    ------测试end
    --]]
end

function HallRobotMsgView:SetTextInfo(desc,robot)
    self.text_msg.text = desc
    self.text_name.text = string.format("%s:",robot.name)
    self.text_level.text = tostring(robot.level)

    self.img_head.sprite = AtlasManager:GetSpriteByName("HeadAtlas",robot.icon)
end

function HallRobotMsgView:CalculateSizeDelta()
    if self.go then
        local con_sizeDelta = self.go.transform.sizeDelta
        local msg_sizeDelta = self.text_msg.transform.sizeDelta

        local name_sizeDelta = self.text_name.transform.sizeDelta
        local  nameframe_sizeDelta = self.img_name_frame.transform.sizeDelta
        self.go.transform.sizeDelta = Vector2.New(con_sizeDelta.x,msg_sizeDelta.y + 40)
        self.img_name_frame.transform.sizeDelta = Vector2.New(name_sizeDelta.x + 65,nameframe_sizeDelta.y)
    end
end

function HallRobotMsgView:on_close()

end

function HallRobotMsgView:OnDestroy()
    self:Close()
end