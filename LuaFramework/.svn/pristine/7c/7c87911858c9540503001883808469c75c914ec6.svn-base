---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/8/20 15:13
---

TopCurrencyView = BaseView:New("TopCurrencyView")
local this = TopCurrencyView
this.viewType = CanvasSortingOrderManager.LayerType.None

local coinValue = 0
local diamondValue = 0
local rocketValue = 0

local lock_coinValue = nil
local lock_diamondValue = nil
local lock_rocketValue = nil

local lock_change = false
local lock_counter = {}

this.auto_bind_ui_items = {

    "text_coin_value",
    "text_dimond_value",
    "left_icon",
    "right_icon",
    "buy_bg_img",
    "buy_letter_img",
    "img_reddot",
    "btn_goback",
--------------------------头像-----------------    
    "btn_head",
    "img_head_frame",
    "img_head_icon",
    "slid_exp",
    "text_exp",
    "text_level",
    "text_leaf",
--------------------------头像-----------------
    "rocket",
    "btn_vip",
    "text_rocket_value",
    "ShowHead",
    "btn_diamond",
    "btn_rocket",
    "btn_coin", 
--------------------------动画-----------------
    "anima",
    "coin_anim",
    "diamond_anim",
    "settingRed",
}


local Stack = require "Common/Stack" 
local topcurrency_stack = Stack:New()

function GetTopCurrencyInstance()
    return topcurrency_stack:Current()
end

function GetTopCurrencyLeftIconPos()
    local _curInstance = GetTopCurrencyInstance()
    if _curInstance then
        return _curInstance:GetLeftIconPos()
    end
    return Vector3.New(0,0,0)
end

function GetTopCurrencyRightIconPos()
    local _curInstance = GetTopCurrencyInstance()
    if _curInstance then
        return _curInstance:GetRightIconPos()
    end
    return Vector3.New(0,0,0)
end

function GetTopVipIconPos()
    local _curInstance = GetTopCurrencyInstance()
    if _curInstance then
        return _curInstance:GetVipIconPos()
    end
    return Vector3.New(0,0,0)
end

function GetPlayerEXPIconPos()
    local _curInstance = GetTopCurrencyInstance()
    if _curInstance then
        return _curInstance:GetPlayerEXPIconPos()
    end
    return Vector3.New(0,0,0)
end

function GetTopRocketIconPos()
    local _curInstance = GetTopCurrencyInstance()
    if _curInstance then
        return _curInstance:GetRocketIconPos()
    end
    return Vector3.New(0,0,0)
end

local function CheckLockCounter(resource)
    return lock_counter[resource] == nil or lock_counter[resource] == 0
end

local function SetLockCounter(resource,isLock)
    local lock = (isLock and {1} or {nil})[1]
    if resource then
        lock_counter[resource] = lock
    else
        lock_counter[Resource.diamon] = lock
        lock_counter[Resource.coin] = lock
        lock_counter[Resource.rocket] = lock
    end
end

local function SetCurrencyLock(isLock)
    lock_change = (isLock == nil and {true} or {isLock})[1]
    SetLockCounter(nil,lock_change)
end

function AddLockCountOneStep(isLock)
    lock_coinValue = coinValue
    lock_diamondValue = diamondValue
    lock_rocketValue = rocketValue
    SetCurrencyLock(isLock)
end

function TopCurrencyView:New(viewName, atlasName, parentView,disable,owner,reddot,bundleName)
    local o = {}
    self.__index = self
    setmetatable(o, self)
    o.viewName = viewName
    o.atlasName = atlasName
    o._parentView = parentView
    o._disable = disable
    o._owner = owner
    o._reddot = reddot or RedDotParam.city_top_shop
    return o
end

function TopCurrencyView:Awake()
    self:on_init()
    self:ChangeCurrencyShowType()
    self._showHead = ShowHeadView:New(self)
    self._showHead:Awake()
end

function TopCurrencyView:GetLeftIconPos()
    if  fun.is_not_null( self.left_icon ) then
        return self.left_icon.transform.position
    end
    return Vector3.New(0,0,0)
end

function TopCurrencyView:GetRightIconPos()
    if fun.is_not_null( self.right_icon) then
        return self.right_icon.transform.position
    end
    return Vector3.New(0,0,0)
end

function TopCurrencyView:GetVipIconPos()
    if fun.is_not_null( self.ShowHead) then
        --return self.btn_vip.transform.position
        return self.ShowHead.transform.position
    end
    return Vector3.New(0,0,0)
end

function TopCurrencyView:GetPlayerEXPIconPos()
    if fun.is_not_null( self.btn_head) then
        return self.btn_head.transform.position
    end
    return Vector3.New(0,0,0)
end

function TopCurrencyView:GetRocketIconPos()
    if fun.is_not_null( self.rocket) then
        return self.rocket.transform.position
    end
    return Vector3.New(0,0,0)
end

---
-----子类重写
---
function TopCurrencyView:ChangeCurrencyShowType()
    self:SetDefaultLeftResource()
    self:SetDefaultRightResource()
end

function TopCurrencyView:SetDefaultLeftResource()
    local icon = Csv.GetData("resources",Resource.coin,"icon")
    Cache.SetImageSprite("ItemAtlas","ZIconCoins",self.left_icon)
end

function TopCurrencyView:SetDefaultRightResource()
    local icon = Csv.GetData("resources",Resource.diamon,"icon")
    Cache.SetImageSprite("ItemAtlas","ZIconGems",self.right_icon)
end

function TopCurrencyView:OnEnable()
    self._isEnable_enter = true

-------------------神奇的enable夹层------------------------------------------
    SetCurrencyLock(false)
    self.stack_index = topcurrency_stack:push(self)
    self:SetKMBMode()
    self:RegisterEvent()
    self:RefreshCurrency(lock_diamondValue,lock_coinValue,lock_rocketValue)
    self:RefreshVip()
    self:DisableBuyBtn()
    self:RegisterRedDotNode()
    self._showHead:OnEnable(self)
    self:override_OnEnable()
-------------------神奇的enable夹层------------------------------------------

    self._isEnable_enter = false
    self:UpDateMailRed()
end

function TopCurrencyView:SetKMBMode()
    self.text_coin_value:SetKMB(true)
    self.text_dimond_value:SetKMB(true)
    self.text_rocket_value:SetKMB(true)
end

function TopCurrencyView:SetActive(active)
    if self.go then
        fun.set_active(self.go,active,false)
    end
end

function TopCurrencyView:override_OnEnable()
    --子类重写
end

function TopCurrencyView:DisableBuyBtn()
    --if self._disable then
    --    local btn = fun.get_component(self.btn_buy,fun.BUTTON)
    --    btn.interactable = false
    --    Cache.SetImageSprite("CommonAtlas","c_btn03",self.buy_bg_img)
    --    Cache.SetImageSprite("CommonAtlas","c_btn03_font",self.buy_letter_img)
    --    Util.SetUIImageGray(self.img_reddot.gameObject, true)
    --end
end

function TopCurrencyView:SetDisable(disable)
    --local btn = fun.get_component(self.btn_buy,fun.BUTTON)
    --if disable then
    --    btn.interactable = true
    --    Cache.SetImageSprite("CommonAtlas","c_btn01",self.buy_bg_img)
    --    Cache.SetImageSprite("CommonAtlas","c_btn01_font",self.buy_letter_img)
    --    Util.SetUIImageGray(self.img_reddot.gameObject, false)
    --else
    --    btn.interactable = false
    --    Cache.SetImageSprite("CommonAtlas","c_btn03",self.buy_bg_img)
    --    Cache.SetImageSprite("CommonAtlas","c_btn03_font",self.buy_letter_img)
    --    Util.SetUIImageGray(self.img_reddot.gameObject, true)
    --end
end

function TopCurrencyView:SetHeadDisable(disable)
    local btn = fun.get_component(self.btn_head,fun.BUTTON)
    if disable then
        btn.interactable = true
        --Util.SetUIImageGray(self.btn_head, false)
    else
        btn.interactable = false
        --Util.SetUIImageGray(self.btn_head, true)
    end
end

function TopCurrencyView:SetGoback(disable)
    --fun.set_active(self.btn_goback,disable,false)

end

function TopCurrencyView:OnDisable()
    topcurrency_stack:pop(self.stack_index)
    self:RemoveEvent()
    self:UnRegisterRedDotNode()
    self._showHead:OnDisable()
    self:Override_OnDisable()

    self._isEnable_enter = nil

    lock_coinValue = nil
    lock_diamondValue = nil
    lock_rocketValue = nil
end

function TopCurrencyView:Override_OnDisable()
    --子类重写
end

function TopCurrencyView:RegisterRedDotNode()
    --log.r("RegisterNode RegisterNode RegisterNode RegisterNode top_currency"..self.viewName)
    --RedDotManager:RegisterNode(RedDotEvent.shop_coinfree_event,"top_currency"..self.viewName, self.img_reddot)
    --RedDotManager:Refresh(RedDotEvent.shop_coinfree_event)
end

function TopCurrencyView:UnRegisterRedDotNode()
    --log.r("UnRegisterNode UnRegisterNode UnRegisterNode UnRegisterNode top_currency"..self.viewName)
    --RedDotManager:UnRegisterNode(RedDotEvent.shop_coinfree_event,"top_currency"..self.viewName)
end

function TopCurrencyView:RegisterEvent()
    Event.AddListener(EventName.Event_coin_change,self.OnCoinChange,self)
    Event.AddListener(EventName.Event_diamond_change,self.OnDiamondChange,self)
    Event.AddListener(EventName.Event_rocket_change,self.OnRocketChange,self)
    Event.AddListener(EventName.Event_currency_change,self.OnCurrencyChange,self)
    Event.AddListener(EventName.Event_VipExp_Slider_Pop,self.OnVipExpSliderChange,self)
    Event.AddListener(EventName.Event_Refresh_Vip_Icon,self.OnVipLevelChange,self)
    Event.AddListener(EventName.Event_FaceBookLogin_Update_Icon,self.OnFbLoginUpdateIcon,self)
    Event.AddListener(EventName.Event_FaceBookLogout_Update_Icon,self.OnFbLogoutUpdateIcon,self)
    Event.AddListener(EventName.Event_Refresh_Rocket_Icon,self.OnRocketUpdateIcon,self)
    Event.AddListener(EventName.Event_Refresh_Mail_Red,self.UpDateMailRed,self)

    self:RegisterEvent_Override()
end

function TopCurrencyView:RegisterEvent_Override()
    --子类重写
end

function TopCurrencyView:RemoveEvent()
    Event.RemoveListener(EventName.Event_coin_change,self.OnCoinChange,self)
    Event.RemoveListener(EventName.Event_diamond_change,self.OnDiamondChange,self)
    Event.RemoveListener(EventName.Event_rocket_change,self.OnRocketChange,self)
    Event.RemoveListener(EventName.Event_currency_change,self.OnCurrencyChange,self)
    Event.RemoveListener(EventName.Event_VipExp_Slider_Pop,self.OnVipExpSliderChange,self)
    Event.RemoveListener(EventName.Event_Refresh_Vip_Icon,self.OnVipLevelChange,self)
    Event.RemoveListener(EventName.Event_FaceBookLogin_Update_Icon,self.OnFbLoginUpdateIcon,self)
    Event.RemoveListener(EventName.Event_FaceBookLogout_Update_Icon,self.OnFbLogoutUpdateIcon,self)
    Event.RemoveListener(EventName.Event_Refresh_Rocket_Icon,self.OnRocketUpdateIcon,self)
    Event.RemoveListener(EventName.Event_Refresh_Mail_Red,self.UpDateMailRed,self)
    self:RemoveEvent_Override()
end

function TopCurrencyView:RemoveEvent_Override()
    --子类重写
end

function TopCurrencyView:on_close()

end

function TopCurrencyView:OnDestroy()
    self:Close()
    self._showHead:OnDestroy()
    self._showHead = nil
    self.stack_index = nil
    self:Override_OnDestroy()
end

function TopCurrencyView:Override_OnDestroy()
    --子类重写
end

function TopCurrencyView:OnCoinChange()
    local oldValue = coinValue
    self:RefresCoin()
end

function TopCurrencyView:OnDiamondChange()
    self:RefreshDiamond()
end

function TopCurrencyView:OnCurrencyChange()
    SetCurrencyLock(false)
    self:RefreshCurrency()
end

function TopCurrencyView:OnRocketChange()
    self:RefreshRocket()
end
---
-----子类重写
---
function TopCurrencyView:RefreshCurrency(lock_diamond,lock_coin,lock_rocket)
    if not lock_change then
        self:RefresCoin(lock_coin)
        self:RefreshDiamond(lock_diamond)
        self:RefreshRocket(lock_rocket)
    end
end

function TopCurrencyView:RefreshVip()
    local vip_exp,vip_level = ModelList.PlayerInfoModel:GetOldVipPts()
    if vip_level then
        local vip = Csv.GetData("new_vip",vip_level,nil)
        Cache.SetImageSprite("VipAtlas", vip.icon, self.btn_vip)
    end    
end

function TopCurrencyView:RefresCoin(lock_coin)
    if not lock_change or CheckLockCounter(Resource.coin) then
        local coins = lock_coin or ModelList.ItemModel.get_coin()
        coinValue = coins
        if not self._isEnable_enter and coins > 10 then
            self.text_coin_value:RollByTime(coins,1,function()
                UISound.stop("coin_fly")
            end)
        else
            self.text_coin_value:SetValue(coins)
        end
        lock_coinValue = nil
    else
        SetLockCounter(Resource.coin,false)    
    end
end

function TopCurrencyView:RefreshDiamond(lock_diamond)
    if not lock_change or CheckLockCounter(Resource.diamon) then
        local diamond = lock_diamond or ModelList.ItemModel.get_diamond()
        diamondValue = diamond
        if not self._isEnable_enter and diamond > 10 then
            self.text_dimond_value:RollByTime(diamond,1,function()
                UISound.stop("diamond_get")
            end)
        else
            self.text_dimond_value:SetValue(diamond)
        end
        lock_diamondValue = nil
    else
        SetLockCounter(Resource.diamon,false)     
    end
end

function TopCurrencyView:RefreshRocket(lock_rocket)
    if not lock_change or CheckLockCounter(Resource.rocket) then
        local rocket = ModelList.MainShopModel.GetPUNum()
        rocketValue = rocket
        if not self._isEnable_enter and rocket > 1 then
            self.text_rocket_value:RollByTime(rocket,1,function()

            end)
        else
            self.text_rocket_value:SetValue(rocket)
        end
        --self.text_rocket_value.text = tostring(rocket)
        lock_rocketValue  = nil
    else
        SetLockCounter(Resource.rocket,false)     
    end
end

function TopCurrencyView:on_btn_head_click()
    if self._showHead then
        self._showHead:on_btn_head_click()
    end
end

function TopCurrencyView:on_btn_diamond_click()
    Http.report_event("purchase_click_client",{itemposclient = 0 ,itempos = "shopView" , viplevel = ModelList.PlayerInfoModel:GetVIP()})
    --Facade.SendNotification(NotifyName.ShopView.PopupShop, PopupViewType.show, nil, SHOP_TYPE.SHOP_TYPE_DIAMONDS)
    Facade.SendNotification(NotifyName.ShopView.PopupShop, PopupViewType.show, nil, BingoBangEntry.mainShopToggleType.Gems)
end

function TopCurrencyView:on_btn_rocket_click()
    Http.report_event("purchase_click_client",{itemposclient = 0 ,itempos = "shopView" , viplevel = ModelList.PlayerInfoModel:GetVIP()})
    Facade.SendNotification(NotifyName.ShopView.PopupShop, PopupViewType.show, nil, BingoBangEntry.mainShopToggleType.PowerUp)
end

function TopCurrencyView:on_btn_coin_click()
    Http.report_event("purchase_click_client",{itemposclient = 0 ,itempos = "shopView", viplevel = ModelList.PlayerInfoModel:GetVIP()})
    Facade.SendNotification(NotifyName.ShopView.PopupShop, PopupViewType.show, nil, BingoBangEntry.mainShopToggleType.Chips)
end



--function TopCurrencyView:on_btn_vip_click()
--    Facade.SendNotification(NotifyName.ShowUI, ViewList.VipdescriptionView,nil)
--end
--
--function TopCurrencyView:on_btn_buy_click()
--    Facade.SendNotification(NotifyName.ShopView.OpenShopView,PopupViewType.show)
--end

function TopCurrencyView:buy()
    local parenView = nil
    if self._parentView then
        parenView = ViewList[self._parentView]
        if parenView == nil then
            parenView = SceneViewManager.GetCurMachineDialogView()
        end
    end
    Facade.SendNotification(NotifyName.ShopView.PopupShop,PopupViewType.show,parenView,nil,function()
        if parenView then
            parenView:CloseView()
        end
    end)
end

local click_interval = 0

function TopCurrencyView:on_btn_goback_click()
    self:GOBack()
end

function TopCurrencyView:GOBack()
    local cityId = ModelList.CityModel:GetCity()
    local playId = ModelList.CityModel.GetPlayIdByCity()
    log.log("城市进入 " , cityId)
    if playId and playId > 0 then
        Facade.SendNotification(NotifyName.ShowUI, ViewList.TopMenuView,nil,nil ,BingoBangEntry.topMenuShowType.MachineLobby)
    else
        Facade.SendNotification(NotifyName.ShowUI, ViewList.TopMenuView,nil,nil ,BingoBangEntry.topMenuShowType.Home)
    end
end


function TopCurrencyView:OnVipExpSliderChange()
    local oldVipPts,oldVipLv = ModelList.PlayerInfoModel:GetOldVipPts()
    local currVipLv = ModelList.PlayerInfoModel:GetVIP()
    log.log("vip等级检查 " ,oldVipLv  , "  " , currVipLv)
    if currVipLv > oldVipLv then
        Facade.SendNotification(NotifyName.ShowUI,ViewList.VipLevelUpView)
    end
    --if ModelList.PlayerInfoModel.trigger_vip_pop and not ViewList.TopVipSliderView.go then
    --    ModelList.PlayerInfoModel:ShowVipChange()
    --    Cache.load_prefabs(AssetList["TopVipSliderView"],"TopVipSliderView",function(obj)
    --        local go = fun.get_instance(obj)
    --        if not fun.is_null(go) and not fun.is_null(GetTopCurrencyInstance()) and  not fun.is_null(GetTopCurrencyInstance().btn_vip) then
    --            fun.set_parent(go,GetTopCurrencyInstance().btn_vip,true)
    --            Facade.SendNotification(NotifyName.SkipLoadShowUI,ViewList.TopVipSliderView,go)
    --            ViewList.TopVipSliderView:ShowTopVip()
    --        end
    --    end)
    --end
end

function TopCurrencyView:OnVipLevelChange(vipLevel)
    local vip = Csv.GetData("new_vip",vipLevel,nil)
    Cache.SetImageSprite("VipAtlas", vip.icon, self.btn_vip)
end

function TopCurrencyView:OnFbLoginUpdateIcon()
    log.log("Fb切换成功")
    if self._showHead then
        self._showHead:UpdateShowHead()
    end
end

function TopCurrencyView:OnFbLogoutUpdateIcon()
    log.log("Fb取消成功")
    if self._showHead then
        self._showHead:UpdateShowHead()
    end
end


function TopCurrencyView:OnRocketUpdateIcon(isMusic)
    if fun.is_not_null(self.rocket) then
        if isMusic then
            self.rocket.sprite = AtlasManager:GetSpriteByName("ItemAtlas","iconWinzoneYf01")
            local musicalnote = ModelList.ItemModel.get_musicalnoteCount()
            self.text_rocket_value:SetValue(musicalnote)
        elseif self.rocket.sprite.name ~= "icon_rockets" then
            self.rocket.sprite = AtlasManager:GetSpriteByName("CommonAtlas","icon_rockets")
            local rocket = ModelList.ItemModel.get_rocketCount()
            self.text_rocket_value:SetValue(rocket)
        end
    end

end

function TopCurrencyView:UpDateMailRed()
    if self and self.settingRed then
        local checkMailExist = ModelList.MailModel.CheckMailExist()
        fun.set_active(self.settingRed, checkMailExist)        
    end
end
