---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/9 14:54
---

--- 卡牌输入模块

---@class   CardInput
local  CardInput = Clazz(ClazzBase,"CardInput")
local this = CardInput
this.moduleName = "CardInput"
this.is_open_collider = true
this.card_collider_state = {}

local Input = UnityEngine.Input
local KeyCode = UnityEngine.KeyCode
local Physics = UnityEngine.Physics


function CardInput:SetCardView(cardView)
    self.cardView = cardView
    self.model =  ModelList.BattleModel:GetCurrModel()
    self.is_open_collider = true
    self:InitCamera()

    Event.AddListener(Notes.CARD_COLLIDER_OPEN, self.SetColliderState, self)
    Event.AddListener(Notes.CARD_COLLIDER_OPEN_BY_ID, self.SetColliderStateByID, self)
end

function CardInput:New(name)
    local o = {name = name,moduleName = "CardInput"}
    setmetatable(o, { __index = CardInput });
    return o
end

--获取照相机
function CardInput:InitCamera()
    local cameraGo = fun.find_gameObject_with_tag("MainCamera")
    if cameraGo then
        self._ScemeCamera = fun.get_component(cameraGo, "Camera")
    end
end

function CardInput:SetColliderState(isopen)
    self.is_open_collider = isopen
end

function CardInput:SetColliderStateByID(cardID, isopen)
    self.card_collider_state[cardID] = isopen
    self.cardView:EnableCardCollider(cardID, isopen)
end

function CardInput:GetColliderStateByID(cardID)
    local state = self.card_collider_state and self.card_collider_state[cardID]
    if state == nil then
        return true
    end

    return state
end

function CardInput:CheckInputClick()
    if not self.model then return end
    if self.model:IsGameing() and self.is_open_collider and Input.GetKeyUp(KeyCode.Mouse0) then
        local pos = Input.mousePosition;
        local ray = self._ScemeCamera:ScreenPointToRay(pos);
        local raycastHits = Physics.RaycastAll(ray, 100, LayerMask.GetMask("Card"));
        local len = raycastHits.Length;
        
        if len > 0 then
            local targetCell
            for i = 1, len do
                local trf = raycastHits[i - 1].collider.transform;  --B1 ...O5
                local mapTrf = trf.transform.parent  --
                local spilName = string.gsub(mapTrf.name, "CellColliderRoot", "")
                local cardIndex = tonumber(spilName)
                if cardIndex then
                    if self.cardView and self.cardView.loadData and self.cardView.loadData.cardsInfo then
                        local clickCardId = self.cardView.loadData.cardsInfo[cardIndex].cardId
                        local index = self:GetCardIndex(trf.name)
                        if self:GetColliderStateByID(cardIndex) then
                            local clickNumber = self.cardView.loadData.cardsInfo[cardIndex].numbers[index]
                            local double_num = self.model:GetRoundData(clickCardId, index).double_num
                            if self.model:IsCalledNumber(clickNumber) or self.model:IsCalledNumber(double_num) then
                                targetCell = trf
                            end
                        end
                    end
                end
            end
            
            targetCell = targetCell or raycastHits[0].collider.transform;
            local mapTrf = targetCell.transform.parent
            local spilName = string.gsub(mapTrf.name, "CellColliderRoot", "")
            local cardIndex = tonumber(spilName)
            if cardIndex then
                if self.cardView and self.cardView.loadData and self.cardView.loadData.cardsInfo then
                    local clickCardId = self.cardView.loadData.cardsInfo[cardIndex].cardId
                    local index = self:GetCardIndex(targetCell.name)
                    if self:GetColliderStateByID(cardIndex) then
                        local clickNumber = self.cardView.loadData.cardsInfo[cardIndex].numbers[index]
                        local double_num = self.model:GetRoundData(clickCardId, index).double_num
                        self.cardView:OnClickCard(clickCardId, clickNumber, targetCell, double_num, index)
                    end
                end
            end
        end
    end
end

function CardInput:GetCardIndex(currName)
    local firstName = string.sub(currName, 1, 1)
    local secName = string.sub(currName, 2)
    local total = 0
    if firstName == "B" then
        total = 0
    elseif firstName == "I" then
        total = 5
    elseif firstName == "N" then
        total = 10
    elseif firstName == "G" then
        total = 15
    elseif firstName == "O" then
        total = 20
    end
    local temp = tonumber(secName)
    total = total + temp
    return total
end

function CardInput:OnDisable()
    self.is_open_collider = true
    self.card_collider_state = {}
    self:stop_x_update()
    Event.RemoveListener(Notes.CARD_COLLIDER_OPEN,self.SetColliderState,self)
    Event.RemoveListener(Notes.CARD_COLLIDER_OPEN_BY_ID,self.SetColliderStateByID,self)
end

function CardInput:EnableUpdate()
    self:start_x_update()
end

function CardInput:on_x_update()
    self:CheckInputClick()
end

function CardInput:stop_x_update()
    if self.update_x_handler then
        UpdateBeat:RemoveListener(self.update_x_handler)
        self.update_x_handler = nil
    end
end

function CardInput:start_x_update()
    self:stop_x_update()
    self.invoke_x_list = {}
    self.start_time = fun.get_real_time_since_startup()
    self.update = xp_call(function()
        self:on_x_update()
    end)

    self.update_x_handler = UpdateBeat:CreateListener(self.update)
    UpdateBeat:AddListener(self.update_x_handler)
end


return this