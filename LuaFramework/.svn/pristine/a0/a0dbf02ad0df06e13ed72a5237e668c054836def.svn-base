---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/13 12:10
---

---  夏威夷玩法 格子盖章效果
local BaseSignEffect =  require("View.Bingo.EffectModule.Card.SignEffect.BaseSignEffect")
local LeetoleManSignEffect = BaseSignEffect:New("LeetoleManSignEffect")
setmetatable(LeetoleManSignEffect,BaseSignEffect)
local this = LeetoleManSignEffect


function LeetoleManSignEffect:RegisterEvent()
    Event.AddListener(EventName.Event_Sign_Cell_Background,self.CellBgEffect,self)
end


function LeetoleManSignEffect:UnRegisterEvent()
    Event.RemoveListener(EventName.Event_Sign_Cell_Background,self.CellBgEffect,self)
end


function LeetoleManSignEffect:TriggerSingleBingo(cardId,cellIndex)
    --ModelList.BattleModel:GetCurrModel():GetRoundData(cardId)
    Event.Brocast(EventName.Event_Show_Skill_Bingo,cardId,cellIndex)
end

--格子盖章效果
function LeetoleManSignEffect:SignCardEffect(cardId,index, cardCell, signType, delay, self_bingo, giftLen)
    signType = signType or 0
    if self:CannotSignCell(cardId,index,signType ) then return end
    self:SaveCellSignEffect(cardId,index)
    delay = delay or 0
    for i = 1, fun.get_child_count(cardCell) do
        fun.set_active(fun.get_child(cardCell,i-1),false)
    end
    local ref_temp = fun.get_component(cardCell, fun.REFER)
    self:HideCellChild(ref_temp, cardId)
    
    Event.Brocast(EventName.Magnifier_Close_Single_Cell,cardCell,false)
    
    if  self_bingo then
        self:TriggerSingleBingo(cardId,index)
    end
    Event.Brocast(EventName.Event_Collect_Item_By_Sign,cardId,index)
end

-- 盖章后地板效果
local function GetDiEffectName(treasureType,part)
    if 1 == part then
        return "treasure01"
    elseif 2 == part then
        return "treasure02"
    elseif treasureType == 2 then
        return "treasure03"
    elseif treasureType == 3  then
        return "treasure04"
    elseif treasureType == 4  then
        return "treasure05"
    else
        return "treasure03"
    end
end

local function GetDieffectCell(view,cardId,cellIndex,part,step)
    if 1 == part then
        -- 横放
        if step then
            return view:GetCardCell(tonumber(cardId), step)
        else
            return view:GetCardCell(tonumber(cardId), cellIndex)
        end
    elseif 2 == part then
         -- 竖放
         if step then
            return view:GetCardCell(tonumber(cardId), step)
         else
            return view:GetCardCell(tonumber(cardId), cellIndex)
         end
    else
        return view:GetCardCell(tonumber(cardId), cellIndex)
    end
end

--- 格子底部印章效果
function LeetoleManSignEffect:CellBgEffect(treasureType,cardId,cellIndex,part,step)
    local diEffect = BattleEffectPool:Get(GetDiEffectName(treasureType,part))
    local parentObj = self:GetCardView():GetCard(cardId).storehouse
    local parentPos = GetDieffectCell(self:GetCardView(),cardId,cellIndex,part,step).transform.position

    fun.set_parent(diEffect,parentObj,false)
    fun.set_gameobject_pos(diEffect,parentPos.x,parentPos.y,parentPos.z,false)
    fun.set_gameobject_scale(diEffect,1,1,1)
    if self.cardView then
        self.cardView:StorageCellBgEffect(tonumber(cardId) ,cellIndex,diEffect)
    end
end

return this