---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/8/21 17:11
---
---
--- 卡包入场效果
---
local BaseEnterGameEffect  =  require("View/Bingo/EffectModule/BattleOpen/BaseEnterGameEffect")

local CardPackageEnterGameEffect = BaseEnterGameEffect:New()
local this = CardPackageEnterGameEffect
this.useType = 10    --- 卡包
local prefabPre_playCard = nil

local isPlayEffect =false

function CardPackageEnterGameEffect:New()
    local o = { isLoaded = false, changeSceneClear = true}
    self.__index = self
    setmetatable(o, self)
    return o
end

function CardPackageEnterGameEffect:Check(cb)
    local cardIds = ModelList.BattleModel:CardIdsContainCardPack()
    if not cardIds or #cardIds == 0 then
        ModelList.BattleModel:GetCurrBattleView():SetReadyForPreUseItem(this.useType)
        fun.SafeCall(cb)
    else
        self:Play(cb)
    end
end


--- 播放卡包入场效果
function CardPackageEnterGameEffect:Play(cb)
    isPlayEffect = false
    if fun.is_not_null(prefabPre_playCard) then
        fun.set_parent(prefabPre_playCard,ModelList.BattleModel:GetCurrBattleView().go,true)
        self.go = prefabPre_playCard
        self.goAnimatro = fun.get_component(self.go,fun.ANIMATOR)

        --设置卡包icon
        local iconName = ModelList.BattleModel:GetBattleCardRewardIcon()
        if iconName then
            local ref = fun.get_component(self.go,fun.REFER)
            local image = fun.get_component(ref:Get("foodBagNode"), fun.IMAGE)
            if fun.is_not_null(image) then
                Cache.SetImageSprite("SeasonCardOpenPackage", iconName, image)
            end
        end
        UISound.play("gourmetbag_goin")
        fun.set_active(prefabPre_playCard,true)
        self:Fly(cb)
    else
        Cache.load_prefabs(AssetList["PalyCard"],"PalyCard",function (prefab)
            if prefab then
                local obj = fun.get_instance(prefab)
                if obj then
                    fun.set_parent(obj,ModelList.BattleModel:GetCurrBattleView().go,true)
                    self.go = obj
                    self.goAnimatro = fun.get_component(self.go,fun.ANIMATOR)

                    --设置卡包icon
                    local iconName = ModelList.BattleModel:GetBattleCardRewardIcon()
                    if iconName then
                        local ref = fun.get_component(self.go,fun.REFER)
                        local image = fun.get_component(ref:Get("foodBagNode"), fun.IMAGE)
                        if fun.is_not_null(image) then
                            Cache.SetImageSprite("SeasonCardOpenPackage", iconName, image)
                        end
                    end
                    UISound.play("gourmetbag_goin")
                    fun.set_active(obj,true)
                    self:Fly(cb)
                end
            end
        end)
    end
end

function CardPackageEnterGameEffect:start_x_update()
    if not self.update_x_enabled then return end
    self:stop_x_update()
    self.invoke_x_list = {}
    self.start_time = fun.get_real_time_since_startup()
    self.update = xp_call(function()
        self:on_x_update()
    end)

    self.update_x_handler = UpdateBeat:CreateListener(self.update)
    UpdateBeat:AddListener(self.update_x_handler)
end

function CardPackageEnterGameEffect:Fly(cb)
    if self.go then
        self.flyEndCb = cb
        self.update_x_enabled = true
        self:start_x_update()
    else
        fun.SafeCall(cb)
    end
end

function CardPackageEnterGameEffect:on_x_update()
    if not isPlayEffect then
        if self.goAnimatro:GetCurrentAnimatorStateInfo(0) .normalizedTime >0.95 and   self.goAnimatro:GetCurrentAnimatorStateInfo(0) :IsName("show") then
            isPlayEffect = true
            self:stop_x_update()
            self:CoroutinePlayEffect()
        end
    end
end

function CardPackageEnterGameEffect:CoroutinePlayEffect()
    coroutine.start(function()
        local cardIds = ModelList.BattleModel:CardIdsContainCardPack()
        Event.Brocast(Notes.START_PLAY_CARD_REWARD)
        local delay = 0
        local cardCount = #cardIds
        if not self.go then
            Event.Brocast(EventName.Enter_Play_First_Joker_Card)
            log.r("no  self go ")
            fun.SafeCall(self.flyEndCb)
            self.flyEndCb = nil
            return
        end
        local goRef = fun.get_component(self.go,fun.REFER)
        local foodBagNode = goRef:Get("foodBagNode")
        if not foodBagNode then
            fun.SafeCall(self.flyEndCb)
            self.flyEndCb = nil
            return 
        end
        local foodBagContainer = ModelList.BattleModel:GetCurrBattleView().effectObjContainer.FoodBagContainer
        if fun.is_null(foodBagContainer) then
            Event.Brocast(EventName.Enter_Play_First_Joker_Card)
            log.r("no  self foodBagContainer ")
            fun.SafeCall(self.flyEndCb)
            self.flyEndCb = nil
            return
        end
        for i = 1, #cardIds do
            local parentObj = ModelList.BattleModel:GetCurrBattleView():GetCardView():GetCardMap(cardIds[i])
            if not parentObj then
                fun.SafeCall(self.flyEndCb)
                self.flyEndCb = nil
                return 
            end
            local tempRef = fun.get_component(parentObj,fun.REFER)
            if not tempRef then
                fun.SafeCall(self.flyEndCb)
                self.flyEndCb = nil
                return 
            end
            local tarObj = tempRef:Get("icon")
            local obj = fun.get_instance(foodBagNode,foodBagContainer)
            if not obj then
                fun.SafeCall(self.flyEndCb)
                self.flyEndCb = nil
                return 
            end
            obj.name = tostring(i)
            fun.set_same_position_with(obj,foodBagNode)
            fun.set_gameobject_scale(obj,0.39,0.39,1)
            local go = GameObject.New()
            fun.set_parent(go,foodBagContainer)
            fun.set_same_position_with(go,tarObj)
            local currScale = obj.transform.localScale
            Anim.scale_to_xy(obj.gameObject,currScale.x*0.5,currScale.y*0.5,0.5,nil)
            WaitForEndOfFrame()
            local path = {}
            local start_position = fun.get_gameobject_pos(obj, false)
            local end_pos = fun.get_gameobject_pos(go,false)
            path[1] = fun.calc_new_position_between(start_position, end_pos, 0.65, 1, 0)
            path[2] = end_pos
            if i == 1 then
                UISound.play("gourmetbagfly")
                WaitForEndOfFrame()
            end
            Anim.bezier_move(obj,path,MCT.FoodBagFlyToCardTime,delay,1,2,function()
                fun.set_active(obj,false)
                ModelList.BattleModel:GetCurrBattleView():SetReadyForPreUseItem(6)
                if not self.complete_pre_use_powerup and tonumber(obj.name)== cardCount then
                    self.complete_pre_use_powerup = true
                    --this.view:GetParentView():SetReadyForPreUseItem(6)
                    self:Over()
                end
                if i == 1 then
                    UISound.play("gourmetbag_reach")
                end
                Destroy(obj)
                Event.Brocast(EventName.CardEffect_Food_Bag_Drop_Effect,cardIds[i])
            end)
            delay = delay + 0.2
            WaitForEndOfFrame()
        end
        if fun.is_not_null(foodBagNode) then
            fun.set_active(foodBagNode.transform.parent,false)
        end
        WaitForFixedUpdate()

        if self.flyEndCb then
            fun.SafeCall(self.flyEndCb)
            self.flyEndCb = nil
        else
            Event.Brocast(EventName.Enter_Play_First_Joker_Card)
        end
    end)
end


function CardPackageEnterGameEffect:stop_x_update()
    if not self.update_x_enabled then return end
    if self.update_x_handler then
        UpdateBeat:RemoveListener(self.update_x_handler)
        self.update_x_handler = nil
    end
end

---继承基类
function CardPackageEnterGameEffect:Over()
    ModelList.BattleModel:SetReadyForPreUseItem(self.useType)
    --Done LwangZg 资源卸载
    -- resMgr:UnloadAssetBundle(AssetList["PalyCard"],false)
    ResourcesManager:UnloadAsset(AssetList["PalyCard"],false)
    if not fun.is_null(self.go) then
        Destroy(self.go)
        prefabPre_playCard = nil
    end
end


function CardPackageEnterGameEffect:PreloadPackageResource()
    Cache.load_prefabs(AssetList["PalyCard"],"PalyCard",function (prefab)
        if prefab then
            prefabPre_playCard = fun.get_instance(prefab)
            --BattleEffectPool:Recycle("PalyCard",prefabPre_playCard)
            fun.set_active(prefabPre_playCard, false)
            fun.SetNotDestroyParent(prefabPre_playCard)
        end
        AssetManager.CheckLoadBattleOverCallBack()
    end)
end

return this
