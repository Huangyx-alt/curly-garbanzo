---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/12 15:53
---
local  GameCardView = require("View.Bingo.UIView.CardView.GameCardView")

---@class HawaiiGameCardView : GameCardView
local HawaiiGameCardView = GameCardView:New("HawaiiGameCardView")
local this = HawaiiGameCardView

local bowlCount={}
--- 记录新bingo的类型
local newBingoType = {}
local MaxWaterCount = 4

--- 重载激活
function HawaiiGameCardView:OnEnable(bingoView, bingosiRef, is_open_search)
    self:BaseEnable(bingoView,bingosiRef,is_open_search)
    --self:LoadRequire()
    --self:SetParentView(bingoView)
    --self:GetControlModel()
    --self:InitCardMapObj()
    --self:InitParams()
    ----self:GetLoadingData()
    --self:InitCity()
    --self:InitCallNumber(bingosiRef)
    --self:InitNumberCall()
    --Event.Brocast(EventName.Magnifier_Default_Attribute, is_open_search)
    --self.cardLoad:LoadNormalCardData(self.parent.Bg)
    self:InitCardBowls()
    self:InitCardData()
end

function HawaiiGameCardView:InitCardBowls()
    local cardCount = self.model:GetCardCount()
    for i = 1, cardCount do
        bowlCount[i] = {0,0,0,0}
        newBingoType[i] = {}
    end
end

function HawaiiGameCardView:InitCardData()
    self.cellBgEffectList = {}
end

function HawaiiGameCardView:GetWineBowlPos(cardId,bowlType)
    if bowlType == 1 then
        return self:GetCard(cardId).RedFlyPoint.transform.position
    elseif bowlType == 2 then
        return self:GetCard(cardId).GreenFlyPoint.transform.position
    elseif bowlType == 3 then
        return self:GetCard(cardId).YellowFlyPoint.transform.position
    elseif bowlType == 4 then
        return self:GetCard(cardId).PurpleFlyPoint.transform.position
    elseif bowlType == 5 then
        return self:GetCard(cardId).RedFlyPoint.transform.position
    end
end

--- 增加具体酒水
function HawaiiGameCardView:AddBowlWater(cardId,bowlType,isMax)
    cardId = tonumber(cardId)
    if not isMax then isMax = false end
    local addCount = 1
    if isMax then addCount = MaxWaterCount - bowlCount[cardId][bowlType] end
    if bowlCount[cardId][bowlType] <MaxWaterCount and  bowlCount[cardId][bowlType] +addCount >= MaxWaterCount then
        table.insert(newBingoType[cardId],bowlType)
    end
    self:GetCard(cardId):AddBowlDrink(bowlCount,cardId,bowlType, addCount)
end


function HawaiiGameCardView:GetBingoType(cardId,bingoCount)
    cardId = tonumber(cardId)
    local bingoType = {}
    for i = 1, #bowlCount[cardId] do
        if bowlCount[cardId][i] >= MaxWaterCount  then
            table.insert(bingoType,i)
            if #bingoType >= bingoCount then
                break
            end
        end
    end
    local tType = 1
    if #newBingoType[cardId] > 0 then
        tType = newBingoType[cardId][1]
        table.remove(newBingoType[cardId],1)
    else
        tType =  bingoType[1]
    end
    return bingoType,tType
end

--- bingo格子，直接倒满酒杯
function HawaiiGameCardView:IsDrinkMax(cardId,drinkType)
    cardId = tonumber(cardId)
    return bowlCount[cardId][drinkType] >= MaxWaterCount
end

--- 把两张有jackpot的卡移动到后面
function HawaiiGameCardView:JackpotCardMoveBackground(currCardId,moveCardId,currIndex,moveIndex)
    local card1 = self:GetCardMap(currCardId)
    local card2 = self:GetCardMap(moveCardId)
    if card2 then
        local switchPos = self:GetParentView():GetSwitchView():GetSmallCardObj(moveIndex)
        local oriPos = card2.transform.localScale
        fun.set_same_position_with(card2,switchPos)
        fun.set_gameobject_scale(card2,0.2,0.2,1)
        Anim.scale_to_xy(card2,oriPos.x,oriPos.y,1)
        local cardPos = card1.transform.position
        BattleLogic.GetLogicModule(LogicName.SwitchLogic):EnterDoubleJackpotChangeCard()
        Anim.move(card2,cardPos.x,cardPos.y,cardPos.z,1,false,true,function()
            BattleLogic.GetLogicModule(LogicName.SwitchLogic):ExitDoubleJackpotChangeCard()
        end)
    end
    if card1 then
        local currPos = card1.transform.localPosition
        Anim.move(card1,currPos.x -2000,currPos.y,currPos.z,1,true,true)
    end
end

function HawaiiGameCardView:RegisterExtraEvent()
    Event.AddListener(EventName.Event_View_Collect_Item,self.AddBowlWater,self)
    Event.AddListener(EventName.Event_Move_Jackpot_Card_Background,self.JackpotCardMoveBackground,self)
end


function HawaiiGameCardView:UnRegisterExtraEvent()
    Event.RemoveListener(EventName.Event_View_Collect_Item,self.AddBowlWater,self)
    Event.RemoveListener(EventName.Event_Move_Jackpot_Card_Background,self.JackpotCardMoveBackground,self)
end



function HawaiiGameCardView:StorageCellBgEffect(cardId,cellIndex,effect)
    local isContain =false
    if not self.cellBgEffectList[cardId] then self.cellBgEffectList[cardId] = {}
    end
    for i = 1, #self.cellBgEffectList[cardId] do
        if self.cellBgEffectList[cardId][i].cellIndex == cellIndex then
            table.insert(self.cellBgEffectList[cardId][i].effectList,effect)
            isContain = true
            break
        end
    end
    if not isContain then
        table.insert(self.cellBgEffectList[cardId],{cellIndex = cellIndex,effectList = {effect}})
    end
end

function HawaiiGameCardView:GetCellBgEffect(cardId,cellIndex)
    if not self.cellBgEffectList[cardId] then return nil end
    for i = 1, #self.cellBgEffectList[cardId] do
        if self.cellBgEffectList[cardId][i].cellIndex == cellIndex then
            return self.cellBgEffectList[cardId][i].effectList
        end
    end
    return nil
end


return this