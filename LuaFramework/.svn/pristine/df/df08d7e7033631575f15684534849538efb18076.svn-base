---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/18 11:27
---
local BaseBingoEffect = require("View.Bingo.EffectModule.Card.BingoEffect.BaseBingoEffect")

local ChristmasBingoEffect = BaseBingoEffect:New("ChristmasBingoEffect")
local this = ChristmasBingoEffect
setmetatable(ChristmasBingoEffect,BaseBingoEffect)


function ChristmasBingoEffect:ShowBingoOrJackpot(bingoData)
    for k, v in pairs(bingoData) do
        local mIndex = k
        if v.jackpot == 0 then
            --LuaTimer:SetDelayFunction(1.5,function()
            --
            --end)
            local anima_name = self:GetBingoAnimaName(v.bingo)
            Event.Brocast(EventName.Box_Bingo_Coins, v.bingo)
            this:BingoEffect(mIndex, anima_name, v.first_num, mIndex)
        else
            --LuaTimer:SetDelayFunction(1.5,function()
            --
            --end)
            Event.Brocast(EventName.Box_Bingo_Coins, 0)
            this:JackpotEffect(mIndex, "jackpot", v.first_num, mIndex)
        end
    end
end

local function GetBingoEffectName(bingoCount)
    return "ChristmasBingo"..bingoCount
end

local function GetBingoCount(cardId)
    return this:GetCardView():GetBingoType(cardId)
end

local function SetBingoShow(bowlType,obj)
    local refCom = fun.get_component(obj,fun.REFER)
    if refCom then
        for i = 1, 4 do
            local o = refCom:Get("SDBingo0"..i)
            fun.set_active(o,(i == bowlType and true or false))
        end
    end
end

---@see  显示Bingo 特效
function ChristmasBingoEffect:BingoEffect(mapindex,anima_name,cellIndex, cardid)
    --if not this:GetCardView():GetParentView():IsCardShowing(tonumber(cardid) ) then return end
    local par = this.cardView:GetCardMap(mapindex)
    local pos = par.transform.position
    local  bingoType,currType = GetBingoCount(mapindex)
    if #bingoType == 0 or #bingoType == 4 then
        return
    end
    self:PlayChristmasBingoAudio(#bingoType)
    --BattleEffectCache:GetPrefabFromCache(GetBingoEffectName(#bingoType), par, function(eff1)
    --    if eff1 then
    --        eff1.gameObject:SetActive(false)
    --        --UISound.play("bingo_firework")
    --        fun.set_gameobject_pos(eff1, pos.x, pos.y, pos.z, false)
    --        eff1.gameObject:SetActive(true)
    --        SetBingoShow(currType, eff1)
    --        self:ChangeSignCellColor(mapindex,currType)
    --        local anima = fun.get_component(eff1, fun.ANIMATOR)
    --        anima:Play(anima_name)
    --        local cell_obj_pos = this.cardView:GetCardCell(mapindex, 13)
    --        LuaTimer:SetDelayFunction(1, function()
    --            if cell_obj_pos then
    --                if ModelList.TournamentModel:CheckOpenTournament() then
    --                    this:GetCardView():GetParentView():ShowIconFlyEffect(mapindex, cell_obj_pos.transform.position)
    --                else
    --                    this:GetCardView():GetParentView():ShowCoinFlyEffect(mapindex, cell_obj_pos.transform.position)
    --                end
    --            end
    --        end)
    --        Destroy(eff1, 4)
    --    else
    --        log.r("hangup_bingo  null")
    --    end
    --    Event.Brocast(EventName.Event_Christmas_JackpotView_Bingo)
    --    self:ShowEffectOnSmallCard(eff1,mapindex,0)
    --end,cardid)


    BattleEffectCache:GetPrefabFromPoolOrCache(GetBingoEffectName(#bingoType), par, function(eff1)
        if eff1 then
            eff1.gameObject:SetActive(false)
            --UISound.play("bingo_firework")
            fun.set_gameobject_pos(eff1, pos.x, pos.y, pos.z, false)
            eff1.gameObject:SetActive(true)
            SetBingoShow(currType, eff1)
            self:ChangeSignCellColor(mapindex,currType)
            local anima = fun.get_component(eff1, fun.ANIMATOR)
            if anima then    anima:Play(anima_name) end
            local cell_obj_pos = this.cardView:GetCardCell(mapindex, 13)
            LuaTimer:SetDelayFunction(1, function()
                if cell_obj_pos then
                    if ModelList.TournamentModel:CheckOpenTournament() then
                        this:GetCardView():GetParentView():ShowIconFlyEffect(mapindex, cell_obj_pos.transform.position)
                    else
                        this:GetCardView():GetParentView():ShowCoinFlyEffect(mapindex, cell_obj_pos.transform.position)
                    end
                end
            end)
            BattleEffectPool:DelayRecycle(GetBingoEffectName(#bingoType), eff1, 4)
            --Destroy(eff1, 4)
        else
            log.r("hangup_bingo  null")
        end
        Event.Brocast(EventName.Event_Christmas_JackpotView_Bingo)
        self:ShowEffectOnSmallCard(eff1,mapindex,0)
    end,cardid)
end

---@see  显示Jackpot 特效
function ChristmasBingoEffect:JackpotEffect(mapindex,anima_name,cellIndex, cardid)
    ModelList.BattleModel:GetCurrBattleView():GetCardView():GetCard(cardid):ForbidCollider()
    --if not this:GetCardView():GetParentView():IsCardShowing(tonumber(cardid) ) then return end
    local par = this.cardView:GetCardMap(mapindex)
    local pos = par.transform.position
    local  bingoType,currType = GetBingoCount(mapindex)
    if #bingoType == 0 then return end
    self:PlayChristmasBingoAudio(#bingoType)
    BattleEffectCache:GetPrefabFromCache("ChristmasJackpot", par, function(eff1)
        if eff1 then
            eff1.gameObject.name = "ChristmasJackpot"
            eff1.gameObject:SetActive(false)
            --UISound.play("bingo_firework")
            fun.set_gameobject_pos(eff1, pos.x, pos.y, pos.z, false)
            fun.set_parent(eff1, par, true)
            ----- 再小火箭界面，jackpot特效要缩小
            --if ModelList.BattleModel:IsRocket() then
            --    fun.set_gameobject_scale(eff1,0.59,0.59,1)
            --end
            eff1.gameObject:SetActive(true)
            SetBingoShow(bingoType,eff1)
            self:ChangeSignCellColor(mapindex,currType)
            local anima = fun.get_component(eff1,fun.ANIMATOR)
            anima:Play(anima_name)

            local cell_obj_pos = this.cardView:GetCardCell(mapindex,13)
            if cell_obj_pos then
                if ModelList.TournamentModel:CheckOpenTournament() then
                    this:GetCardView():GetParentView():ShowIconFlyEffect(mapindex, cell_obj_pos.transform.position)
                else
                    this:GetCardView():GetParentView():ShowCoinFlyEffect(mapindex, cell_obj_pos.transform.position)
                end
            end
            --Destroy(eff1,4)
        else
            log.r("hangup_bingo  null")
        end
        self:ShowEffectOnSmallCard(eff1,mapindex,1)
        Event.Brocast(EventName.Event_Christmas_JackpotView_Jackpot)
    end,cardid,2)
end

--- 在卡牌缩略图上显示bingo  jackpot效果
function ChristmasBingoEffect:ShowEffectOnSmallCard(clone,cardId,effectType)
    if ModelList.BattleModel:IsRocket() then return end
    local isShowing = BattleLogic.GetLogicModule(LogicName.SwitchLogic):IsShowing(cardId)
    local obj =  self.cardView:GetParentView():GetSwitchView():GetSmallCardObj(cardId)
    local newEffect = fun.get_instance(clone, obj)
    fun.set_parent(newEffect, obj, true)
    fun.set_gameobject_scale(newEffect, 0.2, 0.2, 1)
    if isShowing then
        fun.set_active(newEffect, false)
    end
    if effectType == 0 then
        Event.Brocast(EventName.Event_Show_SwitchView_Small_Card_Bingo,cardId,newEffect)
        --self.cardView:GetParentView():GetSwitchView():StorageSwitchEffect(0, newEffect, cardId)
    else
        Event.Brocast(EventName.Event_Show_SwitchView_Small_Card_Jackpot,cardId,newEffect)
        --self.cardView:GetParentView():GetSwitchView():StorageSwitchEffect(1, newEffect, cardId)
    end
end

function ChristmasBingoEffect:PlayChristmasBingoAudio(bingoCount)
    if bingoCount == 1 then
        UISound.play("christmas_bingo")
    elseif bingoCount == 2 then
        UISound.play("christmas_doubleBingo")
    elseif bingoCount == 3 then
        UISound.play("christmas_tripleBingo")
    elseif bingoCount == 4 then
        UISound.play("christmas_jackpot")
    end
end

--- 同道具的格子要变色
function ChristmasBingoEffect:ChangeSignCellColor(cardId,bowlType)
    local cells = BattleLogic.GetLogicModule(LogicName.Card_logic):GetCellsByMaterialType(cardId,bowlType)
    for i = 1, #cells do
       local effectList =  self.cardView:GetCellBgEffect(cardId,cells[i])
        if effectList then
            for m = 1, #effectList do
                local an = fun.get_component(effectList[m],fun.ANIMATOR)
                if an then
                        an:Play("change")
                end
            end
        end
    end
end

return this