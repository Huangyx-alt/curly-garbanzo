---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/12/14 15:31
---

--- 角色导流窗口相关数据

local DeepLinkPart = {}
local this = DeepLinkPart
local SaveTag = {
    DownloadPromoteDataStateStr = "AppSelfPromote.DownloadPromoteDataStateStr",
    DownloadPromotePNGPathStr = "AppSelfPromote.DownloadPromotePNGPathStr",
    LocalPngMd5Str = "AppSelfPromote.LocalPngMd5Str",
    ClickStr = "AppSelfPromote.ClickStr",
    DownloadUrl = "AppSelfPromote.DownloadUrl",
    DownloadMd5 = "AppSelfPromote.DownloadMd5",
    RedirectUrl = "AppSelfPromote.RedirectUrl",
    TaskId = "AppSelfPromote.TaskId",
    ImageId =  "AppSelfPromote.ImageId",
    EndTime = "AppSelfPromote.EndTime",
}

--设置奖励
function DeepLinkPart.SetDeeplinkRewardInfo(data)
    if not this.deepLinkRewardInfo then
        this.deepLinkRewardInfo = {}
    end
    if data ~= nil and type(data) == "table" then
        for _,v in pairs(data) do
            if not this.deepLinkRewardInfo[v.codeId] or not this.deepLinkRewardInfo[v.codeId].isShown then
                this.deepLinkRewardInfo[v.codeId] = v
            end

        end
    end

end

--设置键值 的位无效
function DeepLinkPart.SetDeeplinkRewardDisabled(key)
    if this.deepLinkRewardInfo and this.deepLinkRewardInfo[key] then
        this.deepLinkRewardInfo[key].isShown = true
    end
end


--获取奖励信息
function DeepLinkPart.GetDeeplinkRewardInfo()
    local data = nil
    if this.deepLinkRewardInfo ~= nil then
        for k,v in pairs(this.deepLinkRewardInfo) do
            if v ~= nil and not v.isShown then
                data = deep_copy(v);
                break;
            end
        end
    end
    return data
end

function DeepLinkPart.GetDeeplinkBIInfo(occasion)
    if this.DeepLinkBIData and this.DeepLinkBIData.data  then
        if occasion == 1 then  -- 获取没有已点击标记的任务
            local deepInfo = nil
            for k,v in pairs(this.DeepLinkBIData.data) do
                if  v.clicked == 0 then
                    table.insert(deepInfo,v)
                end
            end
            return deepInfo
        else -- 获取没有已展示标记的任务
            local deepInfo = nil
            for k,v in pairs(this.DeepLinkBIData.data) do
                if  v.clicked == 1 then
                    table.insert(deepInfo,v)
                end
            end
            return deepInfo
        end
    end
    return nil
end


function DeepLinkPart.GetDeepLinkUrl()
    local url = fun.read_value(SaveTag.RedirectUrl,"")
    return url
end

function DeepLinkPart.GetDeepLinkJumpUrl()
    if this.ShowingDeepLinkBIData then
        return this.ShowingDeepLinkBIData.data.redirect
    end
    return nil
end


function DeepLinkPart.HaveDeepLinkShow()
    if this.DeepLinkBIData then
        return this.DeepLinkBIData and not this.DeepLinkBIData.isShown
    end
    return nil
end

function DeepLinkPart:CreateDeepLinkData()
    this.DeepLinkBIData = {time =  os.date("%Y%m%d", os.time()),data = {} }
end

 

function DeepLinkPart:CheckDataCurrDay(data)
    if data and data.time  and data.data and #data.data>0 then
        local time = os.date("%Y%m%d", os.time())
        if data.time == time then
            this.DeepLinkBIData.data= data
            return
        end
    end
    fun.save_value("DeepLinkBIData", nil)
end


---检查缓存数据重复
function DeepLinkPart:AddDeepLinkDataMul(data)
    if this.DeepLinkBIData then
        local isContain = false
        for k, v in pairs(this.DeepLinkBIData.data) do
            if v.data and v.data.taskId == data.taskId then
                v.data = data.data
                isContain = true
                break
            end
        end
        if not isContain then
            data.isShown =false
            data.getTime = os.time()
            table.insert(this.DeepLinkBIData.data, data)
        end
    else
        this:CreateDeepLinkData()
        data.isShown = false
        data.getTime = os.time()
        table.insert(this.DeepLinkBIData.data, data)
    end
    table.sort(this.DeepLinkBIData.data,function(a,b)
        return a.getTime < b.getTime
    end)
    fun.save_value("DeepLinkBIData",TableToJson(this.DeepLinkBIData))
end

 


-- function DeepLinkPart:SavePopInfo(data)
--     if data then
--         this.savePopDeepData = data
--     end
-- end

-- function DeepLinkPart:GetPopInfo(occasion)
--     if this.savePopDeepData then
--         return this.savePopDeepData
--     end
--     return this:GetDeeplinkBIInfo(occasion)
-- end


-- function DeepLinkPart:RefrshShownTime(data)
--     if this.DeepLinkBIData and data then
--         for k,v in pairs(this.DeepLinkBIData.data) do
--             if v.data and v.data.taskId == data.taskId then
--                 table.remove(this.DeepLinkBIData.data,k)
--                 break
--             end
--         end
--         fun.save_value("DeepLinkBIData",TableToJson(this.DeepLinkBIData))
--     end
-- end






local DownloadState = {
    empty = 0,
    downloading = 1,
    finish = 2
}

--[[
    @desc: 是否有可显示的
    author:{author}
    time:2024-01-26 12:26:50
    @return:
]]

function DeepLinkPart:HasCacheAppSelfPromoteData( )
   local ret = false 
   local state =  fun.get_int(SaveTag.DownloadPromoteDataStateStr,DownloadState.empty)
   if(state==DownloadState.finish)then 
        ret = true 
   end 

   if(ret)then 
        local path = this:GetPromoteShowImgLocalPath()
        if(Util.IsFileExist(path))then 
            ret = true 
        else
            CleanDeepLinkData()
            return false --覆盖安装时，本地文件不存在，则直接重新下载
        end
   end

   if(this:IsPromoteDataExpired())then 
        ret = false    
   end
    return  ret
end



function DeepLinkPart:GetAppSelfPromoteDataReqUrl(lastTaskId)
    local apikey = ""
    if(AppConst.DevMode)then  

        if(fun.is_android_platform())then 
            apikey = "7afb00b1f6a64edd7a6afae74077c083"
        else
            apikey = "95f4c2a4cbe2e6eb3ea429b55d76e66d"   --ios只使用一个key ,原因是apoconst.IsDevMode未开放，热更修改。
            -- apikey = "ce068a0103c5e4f659d9a564023fde97"
        end
    else
        if(fun.is_android_platform())then 
            apikey = "f37987a567bdf6636ca1106b1e7ec81f"
        else
            apikey = "95f4c2a4cbe2e6eb3ea429b55d76e66d"
        end
    end

    local url = "http://bi.triwingames.com/api/getAppSelfPromote?apiKey="..apikey.."&uid="..ModelList.PlayerInfoModel:GetUid()
    local taskId = tonumber(lastTaskId)
    if(taskId)then 
        url = url .. "&lastTaskId="..lastTaskId
    end
    return url
end

function DeepLinkPart:GetAppSelfPromoteData(lastTaskId)
    
    Http.get_http_data(this:GetAppSelfPromoteDataReqUrl(lastTaskId),function(code,data) 
        if(code == -1)then 
            log.r("网络异常") 
        elseif(code == RET.RET_SUCCESS)then  
            
            if(data and data.code and data.code==RET.RET_SUCCESS)then 
                log.r("lxq GetAppSelfPromoteData",data)
                this:SendBiRequestEvent(data) 
                local isEnd = ( data.endTime - os.time() )<0 
                if(isEnd)then 
                    log.r(" deeplink 過期")  
                    return 
                end
                this:SavePromoteData(data) 
            end 
        end 
    end)    
end

function DeepLinkPart:SavePromoteData(data)
    

    if(data.code == 10)then 
        return false 
    end

    local localResMd5 = fun.read_value(SaveTag.LocalPngMd5Str,"")

    local md5Str = data.imageMd5

    -- if(StringUtil.is_empty(md5Str))then 
    --     log.r(" lxq promote md5 is nil")
    --     return false 
    -- end  --debug

    if(md5Str == localResMd5)then 
        --同样的弹窗 
        return true 
    end

    local endTime = data.endTime or 0
     local isClick = data.clicked or 0
    
    this:CleanPromoteData() 
    fun.save_value(SaveTag.DownloadUrl,data.imageSrc)
    fun.save_value(SaveTag.DownloadMd5,data.imageMd5)
    fun.save_value(SaveTag.TaskId,data.taskId) 
    fun.save_value(SaveTag.ImageId,data.imageId) 
    
    fun.save_value(SaveTag.RedirectUrl,data.redirect) 

    fun.save_int(SaveTag.EndTime,endTime) 
    fun.save_int(SaveTag.ClickStr,isClick)
    this:DownloadPromoteData(data.imageSrc,md5Str)
    return true 
end




function CleanDeepLinkData()  --c#全局调用
    log.r("lxq DeepLinkPart:CleanPromoteData")
    local savePath = fun.read_value(SaveTag.DownloadPromotePNGPathStr,"")
    if(StringUtil.is_empty(savePath)==false)then 
        Util.DeleteFile(savePath)
    end 
    fun.save_value(SaveTag.DownloadPromotePNGPathStr,"")  
    fun.save_value(SaveTag.DownloadUrl,"")
    fun.save_value(SaveTag.DownloadMd5,"")
    fun.save_value(SaveTag.TaskId,"")
    fun.save_value(SaveTag.ImageId,"")
    fun.save_int(SaveTag.ClickStr,0)
    fun.save_int(SaveTag.DownloadPromoteDataStateStr,0)
end



function PrintDeepLinkInfo()  --c#全局调用
    log.r("lxq DeepLinkPart:PrintDeepLinkInfo",
    fun.read_value(SaveTag.DownloadPromotePNGPathStr,""),
    fun.read_value(SaveTag.DownloadUrl,""),
    fun.read_value(SaveTag.DownloadMd5,""),
    fun.read_value(SaveTag.TaskId,""),
    fun.read_value(SaveTag.ImageId,"")
    )
   
end

 
--[[
    @desc: 删除 弹窗cd
    author:{author}
    time:2024-02-19 18:16:05
    @return:
]]
function DeleteDeeplinkPopCoolDown()
    log.r("删除 弹窗cd")
    local popKey = "PopupBravoHelpGuidePosterOrder"
    fun.save_value(popKey,0)
    fun.save_value(popKey.."_popcount",0);
end

--[[
    @desc: 清理当前数据
    author:{author}
    time:2024-01-26 12:31:23
    @return:
]]
function DeepLinkPart:CleanPromoteData( )
    CleanDeepLinkData()
end


function DeepLinkPart:ResetPromoteData()  
     local taskId = this:GetTaskId()
     self:CleanPromoteData()
     self:GetAppSelfPromoteData(taskId)
end


function DeepLinkPart:SetClickPromoteView()  
    fun.save_int(SaveTag.ClickStr,1)
    this:SendBiClickEvent()
end

function DeepLinkPart:IsClickPromoteView()  
    local clickState = fun.get_int(SaveTag.ClickStr,0)
    return clickState == 1
end

function DeepLinkPart:IsPromoteDataExpired()
    local expireTime = 0
    expireTime = fun.get_int(SaveTag.EndTime,expireTime) 
    local ret =  expireTime - os.time() 
    return ret <= 0
end
 


--[[
    @desc: 下载互导数据
    author:{author}
    time:2024-01-26 12:31:23
    @return:
]]
function DeepLinkPart:DownloadPromoteData(url,server_md5)
    if(this.downloader==nil)then 
        this.downloader = SuperDownloader.create("", url, 0, server_md5) 
    end
   
    this.downloader:add_event_listener(SuperDownloader.DownloadSuccess, function(downloder,arg) 
        this:SetDownloadPromoteDataSuccess(arg.LocalPath)
    end)
    this.downloader:add_event_listener(SuperDownloader.DownloadFail, function(downloder,arg) 
        --待一下次处理
        this:SetDownloadPromoteDataFaild() 
    end)

    this.downloader:run()

    this:SetDownloadPromoteDataDownloading()
end


function DeepLinkPart:SetDownloadPromoteDataDownloading()
    fun.save_int(SaveTag.DownloadPromoteDataStateStr,DownloadState.downloading)
end

function DeepLinkPart:IsDownloadPromoteDataDownloading()
    local ret =  fun.get_int(SaveTag.DownloadPromoteDataStateStr,DownloadState.empty)
     if(ret == DownloadState.downloading and this.downloader~=nil)then 
        return true 
     end
     return false 
end


function DeepLinkPart:SetDownloadPromoteDataSuccess(savePath)
    log.r("lxq download promotedata success")
    fun.save_value(SaveTag.DownloadPromotePNGPathStr,savePath)
    fun.save_int(SaveTag.DownloadPromoteDataStateStr,DownloadState.finish)
end



function DeepLinkPart:GetPromoteShowImgLocalPath()
    
  
    local pngPath = fun.read_value(SaveTag.DownloadPromotePNGPathStr,"")
    log.r("lxq GetPromoteShowImgLocalPath",pngPath)
    return pngPath
end

function DeepLinkPart:GetTaskId()
    local imageId = fun.read_value(SaveTag.TaskId,"") 
    return imageId
end



function DeepLinkPart:SetDownloadPromoteDataFaild() 
    log.r("lxq download promotedata faild")
    fun.save_int(SaveTag.DownloadPromoteDataStateStr,DownloadState.empty)
end

function DeepLinkPart:SendBiImpressionEvent() 
    SDK.BI_Event_Tracker("self_promote_impression",{uid= ModelList.PlayerInfoModel.GetUid(),
        afid = SDK.af_tracker:GetAppFlyerId() ,
        time = os.time(),
        taskId= fun.read_value(SaveTag.TaskId,""),
        imageId = fun.read_value(SaveTag.ImageId,"") }
    )
end


function DeepLinkPart:SendBiClickEvent() 
    SDK.BI_Event_Tracker("self_promote_click",{uid= ModelList.PlayerInfoModel.GetUid(),
        afid = SDK.af_tracker:GetAppFlyerId() ,
        time = os.time(),
        taskId= fun.read_value(SaveTag.TaskId,""),
        imageId = fun.read_value(SaveTag.ImageId,"") }
    )
end






function DeepLinkPart:SendBiRequestEvent(data) 
    SDK.BI_Event_Tracker("self_promote_request",{uid= ModelList.PlayerInfoModel.GetUid(),
        afid = SDK.af_tracker:GetAppFlyerId() ,
        time = os.time(),
        tasknum= data.taskId or 0,
        Scenes = Scenes }
    )
 
end



return this
