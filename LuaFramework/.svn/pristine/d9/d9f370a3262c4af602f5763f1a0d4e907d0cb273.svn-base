---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/12/1 20:58
---


---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/8/23 18:30
---

local GiftPackEnterView = BaseView:New("GiftPackEnterView")
local this = GiftPackEnterView
this.viewType = CanvasSortingOrderManager.LayerType.None



this.auto_bind_ui_items = {
    "btn_gift_clone",
    "GiftPack",
}

function GiftPackEnterView:New()
    local o = {}
    self.__index = self
    setmetatable(o,self)
    return o
end

function GiftPackEnterView:Awake()
    self:on_init()
end

function GiftPackEnterView:OnEnable()
    self:RegisterEvent()
    self:ShowGift()
end

function GiftPackEnterView:ShowGift()
   -- LuaTimer:SetDelayFunction(0.1,function()
    -- self:SetGift()   --暂废弃
    --self:SetGiftV1()  --endy 重构显示 
   -- self:SetGiftTwo()
    --self:SetGiftThree()
    --end)
    LuaTimer:SetDelayFunction(0.2,function()
        Facade.SendNotification(NotifyName.GiftPack.CheckLimitPackState)
    end)
end

function GiftPackEnterView:SetGiftV1()
    self.txtTable = {}
    local showData = ModelList.GiftPackModel:GetPackEnterViewDisplayData()
    for k, v in pairs(showData) do
        local obj = fun.get_instance(self.btn_gift_clone, self.GiftPack)
        obj.name = v.name
        local img = fun.get_component(obj, fun.IMAGE)
        self.luabehaviour:AddClick(obj.gameObject, function()
            UISound.play("kick")
            Facade.SendNotification(NotifyName.HallCity.Function_icon_click, nil, true, obj.name)
            SDK.click_giftpack(fun.is_not_null(obj) and obj.name or "null")
        end)
        local iconSprite = AtlasManager:GetSpriteByName("GiftPackIconAtlas", v.icon)
        if fun.is_not_null(iconSprite) then
            img.sprite = iconSprite
        else
            --- time: 2021.10.13 14:58 礼包icon不再依赖 giftPackIconAtlas,模块包的礼包,加载单张图片
            Cache.load_texture(AssetList[v.icon], v.icon, function(objs)
                if objs then
                    local sprite = Util.Texture2Sprite(objs)
                    if fun.is_not_null(img) and fun.is_not_null(sprite) then
                        img.sprite = sprite
                    end
                end
            end)
        end
        local txtObj = fun.find_child(obj, "txt")
        local txt = fun.get_component(txtObj, "Text")
        local endTime = v.expireTime
        local pack = { text = txt, time = endTime, ob = obj, name = v.name, data = deep_copy(v) }
        table.insert(self.txtTable, pack)
        fun.set_active(obj, v.isDisplay)
    end

    self.loopTime = self:register_loop_timer(0, 1, -1, function()
        local curr = ModelList.PlayerInfoModel.get_cur_server_time()
        for _, v in ipairs(self.txtTable) do
            v.text.text = fun.SecondToStrFormat(v.time - curr)
            local leftTime = v.time - curr
            if leftTime < 0 and v.ob and not Util.IsNull(v.ob) then
                fun.set_active(v.ob, false)
            end
        end
    end, nil, nil, LuaTimer.TimerType.UI)

end


function GiftPackEnterView:GetShowIcons() 
    return  self.txtTable 
end



--[[
    @desc: 重构代码，废弃
    author:{author}
    time:2024-01-17 12:52:26
    @return:
]]
function GiftPackEnterView:SetGift()
    local gift_info = ModelList.GiftPackModel:GetOpenedGift()
    local start_time = ModelList.PlayerInfoModel.get_cur_server_time()
    self.txtTable = {}
    local limitCount =  Csv.GetData("control", 158, "content")[1][1] or 2
    local limitIndex = nil -- 如果后面需求有修改，确定
    local tmp_limitPack = {} --被遗弃 的礼包不用显示出来 
    local tmp_limitPack2 = {} -- 放破冰礼包的
    if gift_info then 
        local tempWeight = 0
        for _,v in ipairs(gift_info) do
            local xls = Csv.GetData("pop_up",v.giftInfo[1].id)

            if xls and xls.type_id[1] == 2 and xls.type_id[2] == 2 then 
                tmp_limitPack[v.pId] = xls.gift_weight
            end 

            if xls and xls.type_id[1] == 1 and xls.type_id[2] == 1  then --破冰礼包只能有一个
                if  xls.gift_weight[1] > tempWeight then 
                    tempWeight = xls.gift_weight[1]
                    limitIndex = v.pId
                end 
                tmp_limitPack2[v.pId] = true
            end  
        end 
    end 

    if limitIndex ~= nil then 
        tmp_limitPack2[limitIndex] = nil
    end 

    for i= 1 ,limitCount do 
        local tmpNum = 0 
        local tmpkey =0
        for k,v in pairs(tmp_limitPack) do 
            if v ~= nil and  v[1]> tmpNum then 
                tmpkey =k;
                tmpNum = v[1];
            end 
        end 
        if tmpkey >0 then 
            tmp_limitPack[tmpkey] = nil;
        end 
    end 

    
    if gift_info then
        for _,v in ipairs(gift_info) do
            local xls = Csv.GetData("pop_up",v.giftInfo[1].id)
            
            if xls and xls.display == 1 and not tmp_limitPack[v.pId] and not tmp_limitPack2[v.pId] then
                local  obj = fun.get_instance(self.btn_gift_clone,self.GiftPack)
                obj.name = tostring(v.pId)
                --local imgObj = fun.find_child(obj,"Image")
                local img = fun.get_component(obj,fun.IMAGE)
                self.luabehaviour:AddClick(obj.gameObject,function()
                    UISound.play("kick")
                    --ModelList.GiftPackModel:ShowGiftById(obj.name)
                    Facade.SendNotification(NotifyName.HallCity.Function_icon_click,nil,true,obj.name)
                    SDK.click_giftpack( fun.is_not_null(obj)  and obj.name or "null")
                end)

                img.sprite = AtlasManager:GetSpriteByName("GiftPackIconAtlas",xls.icon)
                local txtObj = fun.find_child(obj,"txt")
                local txt = fun.get_component(txtObj,"Text")
                local endTime = v.giftInfo[1].expireTime
                local pack = {text = txt, time =endTime , ob = obj}
                table.insert(self.txtTable,pack)
                local canBuyCount = false
                for i = 1, #v.giftInfo do
                    if v.giftInfo[i].canBuyCount >0 or v.giftInfo[i].canBuyCount  == -1  then
                        canBuyCount = true
                        break
                    end
                end
                if v.giftInfo[1].expireTime > start_time and  canBuyCount then
                    fun.set_active(obj,true)
                end
            end
        end
    end

    self.loopTime = LuaTimer:SetDelayLoopFunction(0, 1, -1, function()
        local curr = ModelList.PlayerInfoModel.get_cur_server_time()
        for _,v in ipairs(self.txtTable) do
            v.text.text = fun.SecondToStrFormat( v.time - curr)
            local leftTime = v.time -curr
            if leftTime <0  and v.ob and not Util.IsNull(v.ob) then
                fun.set_active(v.ob,false)
            end
        end
    end,nil,nil,LuaTimer.TimerType.UI)
end

function GiftPackEnterView:RegisterEvent()
    Facade.RegisterCommand(NotifyName.GiftPack.CheckLimitPackState,CmdCommonList.CmdCheckLimitPackData,self)
    Event.AddListener(EventName.Event_Gift_Update,self.OnGiftChange,self)
end

function GiftPackEnterView:RemoveEvent()
    Facade.RemoveCommand(NotifyName.GiftPack.CheckLimitPackState,CmdCommonList.CmdCheckLimitPackData,self)
    Event.RemoveListener(EventName.Event_Gift_Update,self.OnGiftChange,self)
end

function GiftPackEnterView:on_btn_gift_one_click()
end
function GiftPackEnterView:on_btn_gift_two_click()
end
function GiftPackEnterView:on_btn_gift_three_click()
end

function GiftPackEnterView:OnDestroy()
    self:Close()
end

function GiftPackEnterView:OnDisable()
    self:DestroyEnter()
    self:RemoveEvent()
    Facade.SendNotification(NotifyName.CloseUI, ViewList.GiftPackBubbleTipView)
end

function GiftPackEnterView:DestroyEnter()
    if self.loopTime then
        LuaTimer:Remove(self.loopTime,LuaTimer.TimerType.UI)
    end
    if self.txtTable then
        for _,v in pairs(self.txtTable) do
            if (v.ob and v.ob.gameObject and  v.ob.gameObject ~= nil )then
                UnityEngine.Object.Destroy(v.ob.gameObject)
            end
        end
    end
    self.txtTable = nil
end

function GiftPackEnterView:OnGiftChange()
    self:RefreshGift()
end

function GiftPackEnterView:RefreshGift()
    --local gift_info = ModelList.GiftPackModel:GetOpenedGift()
    self:DestroyEnter()
    self:ShowGift()
end

return this