---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/1/11 15:15
---
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/1/11 15:24
---
require("View/Bingo/SettleModule/RocketState/BaseRocketState")

RocketEndFly2State = Clazz(BaseRocketState,"RocketEndFly2State")
local receiveData = false
local this = RocketEndFly2State
function RocketEndFly2State:New()
    local o = {}
    setmetatable(o,{__index = RocketEndFly2State})
    return o
end


function RocketEndFly2State:OnEnter(fsm,prvious,...)
    receiveData = false
    receiveData = ModelList.GameModel:RocketShowBingoInfo()
    if not receiveData then
        RocketEndFly2State:start_x_update()
        self.reCostTime = UnityEngine.Time.time
    else
        local cardPos = this:GetRocketSign()
        fsm:GetOwner():PlayRocketEndFly()
    end
    self._fsm = fsm
    this._fsm = fsm
end

local ConvertServerPos = function(serverPos)
    local c = math.modf(serverPos / 10)
    local d = math.fmod(serverPos, 10)
    return c * 5 - d + 1
end
--涂抹卡牌
function RocketEndFly2State:GetRocketSign()
    local info = {}
    this.model =  ModelList.BattleModel:GetCurrModel()
    this.cardView = ModelList.BattleModel:GetCurrBattleView():GetCardView()
    local roundData = this.model:GetRoundData()
    local settleData  = this.model:GetSettleData().cardRocket2

    for k, v in pairs(roundData) do
        local empty_cell = {}
        local extra_nums_table = {}
        for i = 1, #settleData do
            if tostring(settleData[i].cardId) == k then
                for m = 1, #settleData[i].pos  do
                    local index = ConvertServerPos(settleData[i].pos[m])
                    table.insert(empty_cell, { num = 0 , index = index,extraPos = settleData[i].extraPos[m] })
                end
            end
        end
        
        --排序，格子盖章顺序为：1、普通格子 2、技能格子 3、格子Bingo
        table.sort(empty_cell, function(a, b) 
            local cellA, cellB = this.model:GetRoundData(k, a.index), this.model:GetRoundData(k, b.index)
            --格子Bingo
            if cellA.self_bingo and not cellB.self_bingo then return false end
            if not cellA.self_bingo and cellB.self_bingo then return true end
            --技能
            local puA, puB = cellA:GetPowerupId(1), cellB:GetPowerupId(1)
            if puA and not puB then return false end
            if not puA and puB then return true end
            return false
        end)
        
        for i = 1, #empty_cell do
            this.cardView:OnClickCardIgnoreJudgeByIndex(k, empty_cell[i].index,9,empty_cell[i].extraPos)
        end
        local extra_info = { cardId = k, nums = extra_nums_table }
        table.insert(info, extra_info)
    end
    return info
end



function RocketEndFly2State:on_x_update()
    if not receiveData then
        receiveData = ModelList.GameModel:RocketShowBingoInfo()
    end
    if receiveData then
        RocketEndFly2State:stop_x_update()
        local cardPos = this:GetRocketSign()
        if self._fsm then     
            self._fsm:GetOwner():PlayRocketEndFly()
        elseif this._fsm then
            this._fsm:GetOwner():PlayRocketEndFly()
        end
    else 
        -- 五秒发送一次
        if  self.reCostTime and  UnityEngine.Time.time -  self.reCostTime  > 3 then 
            self.reCostTime = nil--UnityEngine.Time.time

            UIUtil.show_common_popup(8022,false,function()
                this._fsm:GetOwner():ReCastRocket()
                self.reCostTime = UnityEngine.Time.time

             end,function()
                 UIUtil.return_to_scenehome()
             end)
            
        end 
    end
end

function RocketEndFly2State:OnLeave()
    RocketEndFly2State:stop_x_update()
    self._fsm = nil
    this._fsm = nil
    
end

function RocketEndFly2State:FinishOperate(fsm)
    if fsm then
        RocketEndFly2State:stop_x_update()
        self:ChangeState(fsm,"RocketWaitDataState")
    end
end




