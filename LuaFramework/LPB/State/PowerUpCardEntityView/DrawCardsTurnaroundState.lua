---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/9/1 14:17
---
require "State/PowerUpCardEntityView/DrawCardsBaseState"

DrawCardsTurnaroundState = Clazz(DrawCardsBaseState,"DrawCardsTurnaroundState")

function DrawCardsTurnaroundState:OnLeave(fsm)
    if self.timer then
        self.timer:Stop()
    end
    self.index = nil
    self.lenth = nil
    self._fsm = nil
    Event.RemoveListener(EventName.Event_DrawCardTurnRound,self.OnDrawCardTurnRound,self)
end

function DrawCardsTurnaroundState:Dispose()
    self:OnLeave(nil)
end

function DrawCardsTurnaroundState:OnEnter(fsm,lastName,index,lenth)
    Event.AddListener(EventName.Event_DrawCardTurnRound,self.OnDrawCardTurnRound,self)
    self.index = index
    self.lenth = lenth
    self._fsm = fsm
    if index == lenth then
        Event.Brocast(EventName.Event_DrawCardTurnRound,1)
    end
end

function DrawCardsTurnaroundState:OnDrawCardTurnRound(index)
    if index == self.index then
        self._fsm:GetOwner():DrawCardTurnRound(self.index,self.lenth)
        self.timer = Invoke(function()
           log.g("DrawCardTurnRound"..index)
            if index == self.lenth then
                Facade.SendNotification(NotifyName.PowerUps.DrawCardComplete)
                self._fsm:GetOwner():DrawCardTurnRoundIndecator(self.index,self.lenth)
            else
                self._fsm:GetOwner():DrawCardTurnRoundIndecator(self.index,self.lenth)
                Event.Brocast(EventName.Event_DrawCardTurnRound,self.index + 1)
            end

            UISound.play("powerup_tearup")
            if index == 1 then
                UISound.play("powerup_accumulation")
            elseif index == self.lenth then
                UISound.stop("powerup_accumulation")
            end
            self:Change2Available(self._fsm,true)
        end,POWERUP_SHUFFLE_SPEED - 0.01 * (index - 1))
    end
end
