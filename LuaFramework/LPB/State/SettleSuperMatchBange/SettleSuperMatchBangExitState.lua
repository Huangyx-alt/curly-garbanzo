---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/7/18 18:56
---

local SettleSuperMatchBangExitState = Clazz(BaseFsmState,"SettleSuperMatchBangExitState")
local this = SettleSuperMatchBangExitState

function SettleSuperMatchBangExitState:OnEnter(fsm,previous,...)
    this._fsm = fsm
    this.PlayExit = false
    if ModelList.BattleModel:GetGameType() ~= PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
        LuaTimer:SetDelayFunction(MCT.settle_transition_view_duration - 1, function()
            if this._fsm:GetOwner() then
                if this._fsm:GetOwner():CanTransitionNext() then
                    this.PlayExit = true
                    Event.Brocast(EventName.CardEffect_Exit_Effect)
                end
            end
        end)
    else
        Facade.SendNotification(NotifyName.Bingo.ForcedExitBingoLeft)    
    end

    this.timerId1 = LuaTimer:SetDelayFunction(MCT.settle_transition_view_duration, function()
        if not this._fsm:GetOwner() then return end
        if this._fsm:GetOwner():CanTransitionNext() then
            this.PlayExitAnim()
        else
            this.loop_time =    LuaTimer:SetDelayLoopFunction(0.5,0.5,1200,function()
                if  this._fsm:GetOwner() then
                    if this._fsm:GetOwner():CanTransitionNext() then
                        this:PlayExitAnim()
                        LuaTimer:Remove(this.loop_time)
                        this.loop_time = nil
                    end
                else
                    LuaTimer:Remove(this.loop_time)
                end
            end,nil, nil,LuaTimer.TimerType.BattleUI)
        end
    end,false)
end

function SettleSuperMatchBangExitState:PlayExitAnim()
    if this.PlayExit then
        this._fsm:GetOwner():PlayRound1Exit()
    else
        this.PlayExit = true
        Event.Brocast(EventName.CardEffect_Exit_Effect)
        LuaTimer:SetDelayFunction(1,function()
            if this._fsm:GetOwner() then
                this._fsm:GetOwner():PlayRound1Exit()
            end
        end)
    end
end

function SettleSuperMatchBangExitState:OnLeave(fsm)

end

return SettleSuperMatchBangExitState
