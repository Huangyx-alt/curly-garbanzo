---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/3/21 11:02
---
--- 记录战斗数据 （准备废弃）

RecorderMachine = BaseMachine:New("RecorderMachine")

local this = RecorderMachine
this.key = ""
this.out_content = ""
this.startTime = 0
this.isWrite = false
this.isOpen = true
this.battleData ={}
this.powerIndex = 0
local MaxDataFileCount = 100

local BATTLEFIELD_TYPES = {
    ["EnterData"]          = 5001,
    ["StartBattle"]         = 5002,
    ["RefreshCell"]        = 5003,
    ["UsePower"]          = 5004,
    ["OnClickCardIgnoreJudge"]           = 5005,
    ["SetRoundGiftData"]           = 5006,
    ["SetDoubleData"]           = 5007,
}


local Writefile = function()
    if this.battleData and #this.battleData == 0 then return end
    local platform = UnityEngine.Application.platform
    local getTime = os.date("%Y_%m_%d_%H_%M")
    local path =string.gsub(UnityEngine.Application.dataPath,"/Assets","").."/tool/recorder/"
    if platform == UnityEngine.RuntimePlatform.Android then
        path = UnityEngine.Application.persistentDataPath .."/replay";
    end
    local files =  Util.GetAllFiles(path)
    if files~=nil then
        local currCount = files.Length
        if currCount > MaxDataFileCount then
            for i = 0, currCount - MaxDataFileCount-1 do
                os.remove(files[i])
            end
        end
    end
    if this.isWrite then log.r("当前正在写入战斗数据") end
    this.isWrite = true

    path =string.gsub(UnityEngine.Application.dataPath,"/Assets","").."/tool/recorder/"..getTime
    if platform == UnityEngine.RuntimePlatform.Android then
        path = UnityEngine.Application.persistentDataPath .."/replay/".. getTime;
    end
    local file = io.open(path, "w+b")
    if file then
        local jsonData = TableToJson(this.battleData)
        if file:write(jsonData) == nil then
            return false
        end
        io.close(file)
        this.isWrite = false
        log.r("战斗数据已写入到  "..path.." 数据长度 "..#jsonData)
        return true
    else
        local jsonData = TableToJson(this.battleData)
        Util.WriteFileText(path,jsonData)
        this.isWrite = false
        --io.close(file)
        return false
    end
end


local CollectInfo = function(type, content)
    local currTime = UnityEngine.Time.time - this.startTime
    if type == BATTLEFIELD_TYPES['EnterData']  then currTime = 0 end
    if type == BATTLEFIELD_TYPES['StartBattle']  then
        this.startTime = UnityEngine.Time.time
        this.currTime = 0
    end
    local info = {type = type, data = content,time = currTime}
    table.insert(this.battleData,info)
end


function RecorderMachine:Start(data)
    --if BingoBangEntry.IsReplayBattle then this.isOpen = false end
    --if not this.isOpen then return end
    --this.out_content = ""
    --this.key = ""
    --this.powerIndex = 0
    --this.startTime = UnityEngine.Time.time
    --this.battleData ={}
    --local value =  fun.get_int("RecorderMachine",0) +1
    --CollectInfo(5001,ModelList.BattleModel:GetCurrModel():LoadGameData())
end

function RecorderMachine:Stop()
    --if not this.isOpen then return end
    --if not this.battleData then return end
    --Writefile()
    --this.battleData = nil
end

function RecorderMachine:RealStop()

end
function RecorderMachine:Pause(isPause)

end

function RecorderMachine:RecordInfo(code,...)
    if not this.isOpen then return end
    local args={...}
    --log.r("RecordInfo "..code)
    if code == BATTLEFIELD_TYPES.RefreshCell then
        CollectInfo(code,args[1])
    else
        CollectInfo(code,args[1])
    end
end

function RecorderMachine:SetMachineOpen(isOpen)
    this.isOpen = isOpen
end

function RecorderMachine.Register()
    --Event.AddListener(EventName.Recorder_Data,this.RecordInfo)
    --Event.AddListener(EventName.Recorder_Data_Open,this.SetMachineOpen)
end

function RecorderMachine.UnRegister()
    --Event.RemoveListener(EventName.Recorder_Data,this.RecordInfo)
    --Event.RemoveListener(EventName.Recorder_Data_Open,this.SetMachineOpen)
end


return this