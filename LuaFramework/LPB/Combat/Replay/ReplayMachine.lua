---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/3/21 17:46
---

--- 回放前端战斗数据
require("Combat.Machine.BattleMachineList")
ReplayMachine = BaseMachine:New("ReplayMachine")

local this = ReplayMachine
this.gamePlayingTime = 0
this.index = 1

local BATTLEFIELD_TYPES = {
    ["EnterData"]          = 5001,
    ["StartBattle"]         = 5002,
    ["RefreshCell"]        = 5003,
    ["UsePower"]           = 5004,
    ["OnClickCardIgnoreJudge"]           = 5005,
    ["SetRoundGiftData"]           = 5006,
    ["SetDoubleData"]           = 5007,
    ["SettleData"]           = 5008,
    ["Rocket"]           = 5009,
}

this.gameData = {}

local readAll = function(file)
    local f = assert(io.open(file, "rb"))
    local content = f:read("*all")
    f:close()
    return content
end

local LoadData = function(path)
    local content = readAll(path)
    this.gameData =  JsonToTable(content)
end


local AddIndex = function()
    log.r("下一个指令序号" ..this.index.."     "..this.gameData[this.index].type)
    this.index = this.index + 1
end

local EnterGame = function()
    local data = this.gameData[1].data
    local gameType = ModelList.CityModel:GetEnterGameMode()
    ModelList.BattleModel:SetGameType(gameType)
    
    if gameType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
        LoadScene("SceneLoadingGame",ViewList.WinZoneLoadingGameView)
    else
        Cache.Load_Atlas(AssetList["SceneLoadingGameAtlas"],"SceneLoadingGameAtlas",function()
            LoadScene("SceneLoadingGame",ViewList.SceneLoadingGameView)
        end)
    end
    
    local text = data
    AddIndex()
    Message.DispatchMessage(MSG_ID.MSG_GAME_LOAD_CHRISTMAS, 0, text)
    Facade.SendNotification(NotifyName.CloseUI, ViewList.BattleDataTestView)
end



function ReplayMachine:Start(path)
    BingoBangEntry.IsReplayBattle = true
    LoadData(path)
    this.index = 1
    Event.Brocast(EventName.Recorder_Data_Open,false)
    local type = this.gameData[this.index].type
    if type == BATTLEFIELD_TYPES.EnterData then
        EnterGame()
    end
    self.update_x_enabled = true
    this:start_x_update()
    this.view = ModelList.BattleModel:GetCurrBattleView()
    this.model = ModelList.BattleModel:GetCurrModel()
end

local StartPlay = function()
    this.gamePlayingTime = 0
    AddIndex()
end


local PlayRefreshCell =function(data)
    ModelList.BattleModel:GetCurrModel():RefreshRoundDataByIndex(data.cardId,
            data.cellIndex, data.signType, data.need_fly_item, data.mark)
end

local PlayUsePower = function(data)
    local info = Csv.GetData("new_powerup", data.powerupId)
    local effectid = info["effectid"]
    local extra_info ={}
    log.b("UsePowerUpCard  "..data.powerupId.."   index "..data.index)
    UISound.play("powerup_use")
    this.view.powerView:HideUsedPowerCard(data.index)
    this.view.powerView:ResetCharge()
    --this.view.powerView:EnterCommonCD(data.powerupId)
    --this.view.powerView:RefreshSlider()
    Event.Brocast(EventName.PowerUpEffect_Power_Card_Exit,data.index)
end

local PlayClickCardIgnoreJudge = function(data)
    this.view:GetCardView():OnClickCardIgnoreJudgeByIndex(data.cardId,data.cellIndex,data.mark)
end

local PlaySetGiftData = function(data)
    this.model:SetRoundGiftData(data.cardId, data.cellIndex, data.newGift,
            data.number,data.skillId,data.selfBingo,data.powerId)
    local add_gift_cell = this.view.cardView:GetCardCell(tonumber(data.cardId) ,data.cellIndex)
    local detail = Csv.GetData("item", data.newGift)
    local upObj = ModelList.BattleModel:GetCurrBattleView().powerView:GetPowerObj(data.powerIndex)
    local iconChild = fun.get_child(upObj, 0)
    local iconObj = fun.get_instance(iconChild,iconChild.transform.parent)
    Event.Brocast(EventName.CardItem_Cell_Add_Item, add_gift_cell, detail["icon"], iconObj.gameObject, detail["item_type"], data.cardId)
    Event.Brocast(EventName.Cell_Become_BingoCell, cardId, index, 1)
    --function CardItem:CellAddGiftNew(obj, icon, ItemObj, item_type, cardId,callBack)
end

local PlayDoubleData = function(data)
    local obj = this.view:GetCardView():GetCardCell(data.cardId,data.index)
    Event.Brocast(EventName.PowerUpEffect_DoubleNum,obj, data.num,data.cardId,data.index)
    this.model:SetRoundDoubleData(tostring(data.cardId) , data.index, data.num)
end

local PlaySettle = function(data)
    Message.DispatchMessage(data.code, 0, data.data)
end

local PlayRocket = function(data)
    ViewList.SettleRocketView:CastRocket(data.useType,false)
end

local HandleMsg = function(code, data)
    if code == BATTLEFIELD_TYPES.RefreshCell then
        PlayRefreshCell(data)
    elseif code == BATTLEFIELD_TYPES.UsePower then
        PlayUsePower(data)
    elseif code == BATTLEFIELD_TYPES.OnClickCardIgnoreJudge then
        PlayClickCardIgnoreJudge(data)
    elseif code == BATTLEFIELD_TYPES.SetRoundGiftData then
        PlaySetGiftData(data)
    elseif code == BATTLEFIELD_TYPES.SetDoubleData then
        PlayDoubleData(data)
    elseif code == BATTLEFIELD_TYPES.SettleData then
        PlaySettle(data)
    elseif code == BATTLEFIELD_TYPES.Rocket then
        PlayRocket(data)
        LuaTimer:SetDelayFunction(5, function()
            ViewList.SettleRocketView:JumpNextView()
        end)
    end
end


function ReplayMachine:on_x_update()
    if #this.gameData < this.index then
        this:Stop()
        return
    end
    if this.index == 2 and not BattleMachineList.MachineEnabled then return end
    local type = this.gameData[1].type
    if type == BATTLEFIELD_TYPES.StartBattle then
        StartPlay()
    end
    this.gamePlayingTime = this.gamePlayingTime + UnityEngine.Time.deltaTime
    for i = this.index, #this.gameData   do
        if this.gameData[this.index].time <= this.gamePlayingTime then
            HandleMsg(this.gameData[this.index].type,this.gameData[this.index].data)
            AddIndex()
        end
    end
end


function ReplayMachine:Stop()
    log.r("ReplayMachine:Stop")
    --BingoBangEntry.IsReplayBattle = false
    --Event.Brocast(EventName.Recorder_Data_Open,true)
end


function ReplayMachine.Register()
    --Event.AddListener(EventName.Recorder_Data,this.RecordInfo)
end

function ReplayMachine.UnRegister()
    --Event.RemoveListener(EventName.Recorder_Data,this.RecordInfo)
end


return this