---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/11/14 11:37
---
local BaseLogicCard = require("Combat.BattleLogic.Base.BaseLogicCard")
local SingleWolfLogicCard = BaseLogicCard:New("SingleWolfLogicCard")
local this = SingleWolfLogicCard
this.moduleName = "SingleWolfLogicCard"
--- 卡牌狼人监狱层数
local wolfBreakPrisons={}
--- 禁止点击卡牌
local forbidClickTable={}
local MaxPrisonCount = 4
local WolfPosList = {7, 9, 17, 19}
local private = {}

function SingleWolfLogicCard:InitLogic()
    self.model =  ModelList.BattleModel:GetCurrModel()
    self:InitCardLogicData()
    forbidClickTable = {0,0,0,0}
    self.wolfFlagForSkill = {}
end

function SingleWolfLogicCard:InitCardLogicData()
    local cardCount = self.model:GetCardCount()
    for i = 1, cardCount do
        wolfBreakPrisons[i] = {}
        table.each(WolfPosList, function(wolfPos)
            wolfBreakPrisons[i][wolfPos] = 0
        end)
    end
end

function SingleWolfLogicCard:Register()

end

function SingleWolfLogicCard:UnRegister()

end

--- 减少狼人监狱层数
function SingleWolfLogicCard:ReduceLogicPrison(cardId, cellIndex)
    local affectCellList = {}
    cardId = tonumber(cardId)
    local tempX = math.modf((cellIndex - 1) / 5)
    local tempY = math.modf((cellIndex - 1) % 5)
    for i = -1, 1 do
        for k = -1, 1 do
            local new_x = tempX + i
            local new_y = tempY - k
            if new_x >= 0 and new_x <= 4 and new_y >= 0 and new_y <= 4 then
                local new_index = new_x * 5 + new_y + 1
                if new_index == 7 or new_index == 9 or new_index == 17 or new_index == 19  then
                    wolfBreakPrisons[cardId][new_index] = wolfBreakPrisons[cardId][new_index] +1
                    if wolfBreakPrisons[cardId][new_index] >= 0 then
                        table.insert(affectCellList, new_index)
                    end
                end
            end
        end
    end
    if not ModelList.BattleModel:GetCurrModel():GetRoundData(cardId):GetForbid() and
            wolfBreakPrisons[cardId][7] >= MaxPrisonCount and wolfBreakPrisons[cardId][9] >= MaxPrisonCount and
            wolfBreakPrisons[cardId][17] >= MaxPrisonCount and wolfBreakPrisons[cardId][19] >= MaxPrisonCount then
        ModelList.BattleModel:GetCurrModel():GetRoundData(cardId):SetForbid()
        ModelList.BattleModel:GetCurrModel():GetRoundData(cardId):BeJackpot()
        self:StatisticsRocketBingo()
        this:CheckDoubleJackpotHandle(cardId)
        this:CheckAllCardBeBingoHandle(cardId)
    end
    return affectCellList
end

function SingleWolfLogicCard:IsOtherSideHaveOneJackpot(currCardId)
    local otherJackpotId = 0
    if self.model:GetCardCount() == 4 then
        local forbidCount = 0
        for i = 1, 4 do
            if self.model:GetRoundData(i):GetForbid() then
                forbidCount = forbidCount + 1
                if i ~= currCardId then
                    otherJackpotId = i
                end
            end
        end
        if forbidCount == 2 and not (currCardId<= 2 and otherJackpotId<=2) 
                and not (currCardId>= 3 and otherJackpotId >=3)  then
            return otherJackpotId
        else return 0
        end
    else
        return 0
    end
end

function SingleWolfLogicCard:IsAllJackpot()
    local cardCount = self.model:GetCardCount()
    for i = 1, cardCount do
        if not self.model:GetRoundData(i):GetForbid() then
            return false
        end
    end
    return true
end

function SingleWolfLogicCard:CheckAllCardBeBingoHandle(currCardId)
    --- 这里补充，假如第一次小火箭触发了全部jackpot，就忽略下一次小火箭
    if ModelList.BattleModel:IsRocket() then return end
    if self:IsAllJackpot() then
        if ModelList.BattleModel:IsGameing() then
            ModelList.BattleModel:GetCurrModel():SetReadyState(2)
            self:WaitUploadSettleData()
        end
    end
end

--- 4卡游戏时，若有两张卡达成jackpot，则移动2张达成jackpot的卡片，到3、4卡的位置
function SingleWolfLogicCard:CheckDoubleJackpotHandle(currCardId)
    if ModelList.BattleModel:IsRocket() then return end
    local otherJackpotId =self:IsOtherSideHaveOneJackpot(currCardId)
    if otherJackpotId ~= 0 then
        BattleLogic.GetLogicModule(LogicName.SwitchLogic):StartHideJackpotCardBackground(currCardId,otherJackpotId)
    end
end

--- 取消两个Jackpot的卡牌后移
function SingleWolfLogicCard:StopCardBackMove()
    if this.loopMoveCard then
        LuaTimer:Remove(this.loopMoveCard)
    end
end

--- 获取狼打破的监狱层数
function SingleWolfLogicCard:GetWolfCount(cardId)
    cardId = tonumber(cardId)
    return wolfBreakPrisons[cardId]
end

--- 获取卡牌bingo数量
function SingleWolfLogicCard:GetBingoCount(cardId)
    cardId = tonumber(cardId)
    local breakCount = 0
    if wolfBreakPrisons and wolfBreakPrisons[cardId] then
        table.each(WolfPosList, function(wolfPos)
            if wolfBreakPrisons[cardId][wolfPos]>= MaxPrisonCount then
                breakCount = breakCount + 1
            end
        end)
    end
    return breakCount
end

---指定位置的狼人是否已经Bingo
function SingleWolfLogicCard:IsWolfBreadPrison(cardId, wolfPos)
    if not cardId or not wolfPos or not fun.is_include(wolfPos, WolfPosList) then
        return
    end
    
    cardId = tonumber(cardId)
    local curCount = wolfBreakPrisons[cardId][wolfPos]
    return curCount and curCount >= MaxPrisonCount
end

---取解锁进度最慢的狼
function SingleWolfLogicCard:GetLockedWolf(cardId, excludeWolfPos)
    if not cardId then
        return
    end

    cardId = tonumber(cardId)
    local remainPrisons, tempCount, ret = 0

    table.each(wolfBreakPrisons[cardId], function(prisonsCount, wolfPos)
        if prisonsCount < MaxPrisonCount then
            if not excludeWolfPos or not fun.is_include(wolfPos, excludeWolfPos) then
                if (not tempCount or tempCount > prisonsCount) then
                    tempCount = prisonsCount
                    ret = wolfPos
                    remainPrisons = MaxPrisonCount - prisonsCount
                end
            end
        end
    end)

    return ret, remainPrisons
end

---取未解锁的狼，用于前端技能预计算
function SingleWolfLogicCard:GetLockedWolfForPreCal(cardId, needCount, excludeWolfPos, isMoonSkill)
    --保存被其他技能使用的狼，防止两个技能取到同一个狼
    self.wolfFlagForSkill = self.wolfFlagForSkill or {}
    self.wolfFlagForSkill[cardId] = self.wolfFlagForSkill[cardId] or {}

    excludeWolfPos = excludeWolfPos or {}
    local temp, ret = self.wolfFlagForSkill[cardId], {}
    table.each(temp, function(v, k)
        if v >= MaxPrisonCount then
            table.insert(excludeWolfPos, k)
        end
    end)
    
    if needCount > 0 then
        for i = 1, needCount do
            local wolfPos, remainPrisons = self:GetLockedWolf(cardId, excludeWolfPos)
            if wolfPos then
                if not temp[wolfPos] or temp[wolfPos] < MaxPrisonCount then
                    if isMoonSkill then
                        --圆月技能直接释放狼人
                        temp[wolfPos] = MaxPrisonCount
                    else
                        --狼爪技能仅破坏一层
                        temp[wolfPos] = temp[wolfPos] or remainPrisons
                        temp[wolfPos] = temp[wolfPos] + 1
                    end
                    table.insert(ret, wolfPos)
                end
            end
        end
    end

    if #ret == 0 then
        table.insert(ret, 7)
    end
    
    return ret
end 

--- 减少狼人的所有监狱层数
function SingleWolfLogicCard:ReduceAllLogicPrison(cardId, wolfPos)
    cardId = tonumber(cardId)
    wolfBreakPrisons[cardId][wolfPos] = MaxPrisonCount
    
    if not ModelList.BattleModel:GetCurrModel():GetRoundData(cardId):GetForbid() and
            wolfBreakPrisons[cardId][7] >= MaxPrisonCount and wolfBreakPrisons[cardId][9] >= MaxPrisonCount and
            wolfBreakPrisons[cardId][17] >= MaxPrisonCount and wolfBreakPrisons[cardId][19] >= MaxPrisonCount then
        ModelList.BattleModel:GetCurrModel():GetRoundData(cardId):SetForbid()
        ModelList.BattleModel:GetCurrModel():GetRoundData(cardId):BeJackpot()
        self:StatisticsRocketBingo()
        this:CheckDoubleJackpotHandle(cardId)
        this:CheckAllCardBeBingoHandle(cardId)
    end
end

function SingleWolfLogicCard:IsJackpot(cardID)
    cardID = tonumber(cardID)

    if self.model:GetRoundData(cardID):GetForbid() then
        return true
    end
    
    local data, ret = wolfBreakPrisons[cardID]
    table.each(data, function(v)
        ret = ret and v >= MaxPrisonCount
    end)
    return ret
end

return this