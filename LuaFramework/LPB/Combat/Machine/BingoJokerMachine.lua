---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/6/25 19:40
---


---  战斗小丑

require("Combat/BaseMachine")

local BingoJokerMachine = BaseMachine:New("BingoJokerMachine")

local this = BingoJokerMachine


function BingoJokerMachine:Start()
    this.triggerDoubleCoin = false
    this.model = ModelList.BattleModel:GetCurrModel()
    this.playedJokerSpa = false
end

function BingoJokerMachine:Pause(isPause)

end

function BingoJokerMachine:on_x_update()

end

function BingoJokerMachine:Stop()

end

function BingoJokerMachine:CheckJoker(jokerData,mark)
    if jokerData and #jokerData >0 then
        for i = 1, #jokerData do
            if jokerData[i].state == 4 then
                if not self.triggerDoubleCoin then
                    this.triggerDoubleCoin = true
                    Event.Brocast(EventName.Event_Get_Joker_Double_Coin)
                    Event.Brocast(EventName.Event_Hide_Other_Joker_Double_Coin)
                end
            elseif  jokerData[i].state  == 2 then --小丑区域
                local isAllSign = true
                for k = 1, #jokerData[i].params do
                    local clientPos = ConvertServerPos(jokerData[i].params[k])
                    if clientPos and clientPos ~= jokerData[i].cellIndex  then
                        if this.model:GetRoundData(jokerData[i].cardId, clientPos):IsNotSign() then
                            isAllSign = false
                            break
                        end
                    end
                end
                if isAllSign then
                    Event.Brocast(EventName.Event_Get_Joker_Bonuses, jokerData[i].cardId, jokerData[i].cellIndex)
                    for k = 1, #jokerData[i].params do
                        local clientPos = ConvertServerPos(jokerData[i].params[k])

                        Event.Brocast(EventName.Event_Get_Joker_Bonuses1, jokerData[i].cardId, clientPos)
                    end
                end
                Event.Brocast(EventName.Event_Joker_Bonuses_Click_Effect, jokerData[i].cardId, jokerData[i].cellIndex)
            elseif  jokerData[i].state  == 3 then --吹吹卷
                local isOtherSign = false
                for k = 1, #jokerData[i].params do
                    local clientPos = ConvertServerPos(jokerData[i].params[k])
                    if clientPos and clientPos ~= jokerData[i].cellIndex  then
                        if not this.model:GetRoundData(jokerData[i].cardId, clientPos):IsNotSign() then
                            isOtherSign = true
                            break
                        end
                    end
                end
                if not isOtherSign then
                    --- 数据上刷新几个棋子的盖章状态
                    for k = 1, #jokerData[i].params do
                        local clientPos = ConvertServerPos(jokerData[i].params[k])
                        if clientPos and clientPos ~= jokerData[i].cellIndex  then
                            this.model:OnlyRefreshRoundDataByIndex(jokerData[i].cardId, clientPos,-1)
                        elseif clientPos then
                            this.model:OnlyRefreshRoundDataByIndex(jokerData[i].cardId, clientPos,mark)
                        end
                    end
                    --- 播放吹吹卷特效
                    Event.Brocast(EventName.Event_Get_Joker_Blow_Roll, jokerData[i].cardId, jokerData[i].cellIndex, jokerData[i])
                    Event.Brocast(EventName.Event_Joker_Hide_BallSprayerIcon, jokerData[i].cardId,  jokerData[i])
                    return true
                end
            elseif jokerData[i].state == 1 then
                --- 小丑投放的资源格子
                if jokerData[i].params then
                    Event.Brocast(EventName.Event_Joker_Fly_Item_To_Box,jokerData[i].cardId, jokerData[i].cellIndex, jokerData[i].params)
                end
            elseif jokerData[i].state == 5 then
                --- 遥控炸弹
                if jokerData[i].params then
                    Event.Brocast(EventName.Event_Joker_Detonate_Bomb, jokerData[i].cardId, jokerData[i].cellIndex, jokerData[i])
                end
            elseif jokerData[i].state == 6 then
                --- 资源锤子
                if jokerData[i].params then
                    Event.Brocast(EventName.Event_Joker_Resource_Hammer, jokerData[i].cardId, jokerData[i].cellIndex, jokerData[i])
                end
            end
        end
    end
    return false
end

local function GetCallNumbers()
    local ballData = ModelList.BattleModel:GetCurrModel():GetJokerCardData()
    if ballData then
        for i = 1, #ballData do
            if ballData[i].callNumbers and #ballData[i].callNumbers > 0 then
                return ballData[i].callNumbers
            end
        end
    end
end

--- 检查是否有叫号器触发
function BingoJokerMachine:CheckJokerBallSprayer(callBack)
    local numbers = GetCallNumbers()
    if numbers and  #numbers > 0 and not     this.playedJokerSpa  then
        this.playedJokerSpa = true
        Event.Brocast(EventName.Event_Play_Joker_BallSprayer,callBack)
    else
        if callBack then
            callBack()
        end
    end
end

--- 检查是否有叫号器触发
function BingoJokerMachine:CheckJokerBallSprayerNumSign()
    local numbers = GetCallNumbers()
    local signCellData = {}
    if numbers and  #numbers > 0 then
        local model = ModelList.BattleModel:GetCurrModel()
        local cardCount =   model:GetCardCount()
        local data, checkFlag = nil, {}  --checkFlag 检查是否会重复叫号
        for i = 1, #numbers do
            local tempData = { number = numbers[i],flyData = {}}
            local hasHitCard = false
            for k = 1, cardCount do
                checkFlag[k] = checkFlag[k] or {}
                data = model:GetRoundDataByNum(k,numbers[i])
                if data and data:IsNotSign() then
                    if not checkFlag[k][data.index] then
                        checkFlag[k][data.index] = true
                        table.insert(tempData.flyData, {cardId = k, cellIndex = data.index})
                        hasHitCard = true
                    end
                end
            end
            if hasHitCard then table.insert(signCellData,tempData) end
        end
        if #signCellData > 0 then
            Event.Brocast(EventName.Event_Play_Joker_BallSprayer_Fly,signCellData)
        else
            Event.Brocast(EventName.Event_Play_Joker_BallSprayer_Over)
        end
    else
        Event.Brocast(EventName.Event_Play_Joker_BallSprayer_Over)
    end
end


function BingoJokerMachine.Register()
    --Event.AddListener(EventName.Event_Get_Joker_Double_Coin,self.AddLogicBowlDrink,self)
end

function BingoJokerMachine.UnRegister()
    --Event.RemoveListener(EventName.Event_Get_Joker_Double_Coin,self.AddLogicBowlDrink,self)
end


return this