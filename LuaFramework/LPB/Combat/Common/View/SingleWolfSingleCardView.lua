---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/2/7 15:20
---


local  BaseSingleCard = require("Combat.Common.View.BaseSingleCardView")

--- 夏威夷单张卡牌
local SingleWolfSingleCardView = BaseSingleCard:New();
local this = SingleWolfSingleCardView;
setmetatable(this,BaseSingleCard)
local private = {}

this.auto_bind_ui_items = {
    "B1",
    "B2",
    "B3",
    "B4",
    "B5",
    "I1",
    "I2",
    "I3",
    "I4",
    "I5",
    "N1",
    "N2",
    "N3",
    "N4",
    "N5",
    "G1",
    "G2",
    "G3",
    "G4",
    "G5",
    "O1",
    "O2",
    "O3",
    "O4",
    "O5",
    "b_letter",
    "reward1",
    "reward2",
    "reward_icon1",
    "rewardPar",
    "PerfectDaub",
    "letter_b",
    "letter_i",
    "letter_n",
    "letter_g",
    "letter_o",
    "icon",
    "ChipsContainer",
    "fooddz",
    "forbidCollide",
    "autoFlag",
    "sign",

    "ef_Bingo_click",
    "gift_clone",
    "flash_clone",
    "CanvasGroup",
}

function SingleWolfSingleCardView:Clone(name)
    local o ={name = name}
    setmetatable(o,{__index = SingleWolfSingleCardView})
    return o
end

local MaxPrisonCount = 4

function SingleWolfSingleCardView:CheckBreakPrison(lastCount,prisonCount,cardId,wolfPos)
    CalculateBingoMachine.OnDataChange(cardId,wolfPos,prisonCount)
    if prisonCount >= MaxPrisonCount then
        CalculateBingoMachine.CalcuateBingo(cardId, wolfPos)
    end
    if CalculateBingoMachine.GetTotalBingoCount(cardId) == 4 then
        this:PlayAllWolfRoar(cardId,wolfPos)
    end
end

--- 本卡的破坏锁链表现
function SingleWolfSingleCardView:ReducePrison(cardId,cellIndex,prisonCount,cell,isMax,ref,wolfPrisons)
    if prisonCount > MaxPrisonCount then
        return
    end
    
    local refTemp = fun.get_component(cell,fun.REFER)
    local lastCount = self.prisonCount
    self.prisonCount = prisonCount

    if refTemp then
        --锁链动画
        refTemp:Get("Tielian"):Play("act")
        refTemp:Get("SkeletonGraphic1"):SetAnimation("act",nil,false,0)
        refTemp:Get("SkeletonGraphic1"):AddAnimation("idle",nil,true,0)
        --锁链破坏特效
        fun.set_active(refTemp:Get("bao"..prisonCount),true)

        ---狼撞击动画后。。0.6秒屏蔽铁链
        if prisonCount <= MaxPrisonCount then
            LuaTimer:SetDelayFunction(0.6,function()
                if refTemp then
                    fun.set_active(refTemp:Get("lian"..prisonCount),false)
                    UISound.play("werewolf_chain")
                end
            end)
        end
        if isMax then
            fun.set_active(refTemp:Get("bao"..1),true)
            fun.set_active(refTemp:Get("bao"..2),true)
            fun.set_active(refTemp:Get("bao"..3),true)
            fun.set_active(refTemp:Get("bao"..4),true)
            
            fun.set_active(refTemp:Get("Wolf2"),true)
            self:PlayWolfWarnning(cardId,cellIndex)
            fun.set_active(refTemp:Get("Wolf"),false)
            UISound.play("werewolf_escape")
            
            --- act后,狼人出笼盖章
            local DelayPlaySign = function()
                self:CheckBreakPrison(lastCount,prisonCount,cardId,cellIndex)
            end
            if BattleLogic.GetLogicModule(LogicName.Card_logic):GetBingoCount(cardId) == 4 then
                refTemp:Get("SkeletonGraphic2"):SetAnimation("enter2",DelayPlaySign,false,0)
                refTemp:Get("SkeletonGraphic2"):AddAnimation("hong2",nil,false,0)
            else
                refTemp:Get("SkeletonGraphic2"):SetAnimation("enter",DelayPlaySign,false,0)
            end
            refTemp:Get("SkeletonGraphic2"):AddAnimation("idle",nil,true,0)
        end
    end
end

---最后的狼人解锁。。1.5秒后剩下的狼播放吼叫动画（这样4头狼就会一起吼）
function SingleWolfSingleCardView:PlayAllWolfRoar(cardId,cellIndex)
    if cardId and cellIndex then
        local indexList = {7,9,17,19}
        for i = 1, #indexList do
            if cellIndex ~= indexList[i] then
                local cell = ModelList.BattleModel:GetCurrBattleView():GetCardView():GetCardCell(cardId,indexList[i])
                if cell then
                    local refTemp = fun.get_component(cell,fun.REFER)
                    local SkeletonGraphic2 = refTemp:Get("SkeletonGraphic2")
                    if SkeletonGraphic2 then
                        --if  SkeletonGraphic2.curAnimationName =="idle" or  SkeletonGraphic2.curAnimationName =="" then
                            refTemp:Get("SkeletonGraphic2"):SetAnimation("hong",nil,false,0)
                            refTemp:Get("SkeletonGraphic2"):AddAnimation("idle",nil,true,0)
                        --end
                    end
                end
            end
        end
    end
end

---狼出监狱，在盖章位置播放预警效果
function SingleWolfSingleCardView:PlayWolfWarnning(cardId,cellIndex)
    local cardView = ModelList.BattleModel:GetCurrBattleView():GetCardView()

    local data = nil
    if ModelList.BattleModel:IsRocket() then
        data  = ModelList.SingleWolfGameModel:GetRocketExtraPosData(cardId,cellIndex)
        data = BattleTool.GetExtraPos(data)
        if data and #data > 0 then
            for i = 1, #data do
                local obj =  BattleEffectPool:GetAndBind("SingleWolfgetyujing",self:GetCell(ConvertServerPos(data[i])),cardId,3)
            end
        end
    else
        data = cardView:GetExtInfo(cardId,cellIndex,"wolfData")
        if data and #data > 0 then
            for i = 1, #data do
                local obj =  BattleEffectPool:GetAndBind("SingleWolfgetyujing",self:GetCell(ConvertServerPos(data[i])),cardId,3)
            end
        end
    end
end

function SingleWolfSingleCardView:ForbidCollider()
    if self.forbidCollide then
        fun.set_active(self.forbidCollide,true)
    end
end

---直接释放狼人
function SingleWolfSingleCardView:ReduceAllPrison(cardId, cellIndex, cell)
    local refTemp = fun.get_component(cell,fun.REFER)
    local curPrisonCount = self.prisonCount
    self.prisonCount = MaxPrisonCount

    if refTemp then
        --锁链动画
        refTemp:Get("Tielian"):Play("act")
        refTemp:Get("SkeletonGraphic1"):SetAnimation("act",nil,false,0)
        refTemp:Get("SkeletonGraphic1"):AddAnimation("idle",nil,true,0)

        ---狼撞击动画后。延迟屏蔽铁链
        for i = 1, MaxPrisonCount do
            LuaTimer:SetDelayFunction(0.1 * i,function()
                if refTemp then
                    fun.set_active(refTemp:Get("bao"..i),true)
                    if fun.get_active_self(refTemp:Get("lian"..i)) then
                        fun.set_active(refTemp:Get("lian"..i),false)
                        UISound.play("werewolf_chain")
                    end
                end
            end)
        end

        fun.set_active(refTemp:Get("Wolf2"),true)
        self:PlayWolfWarnning(cardId,cellIndex)
        fun.set_active(refTemp:Get("Wolf"),false)
        UISound.play("werewolf_escape")

        --- act后,狼人出笼盖章
        local DelayPlaySign = function()
            self:CheckBreakPrison(curPrisonCount,MaxPrisonCount,cardId,cellIndex)
        end
        if BattleLogic.GetLogicModule(LogicName.Card_logic):GetBingoCount(cardId) == 4 then
            refTemp:Get("SkeletonGraphic2"):SetAnimation("enter2",DelayPlaySign,false,0)
            refTemp:Get("SkeletonGraphic2"):AddAnimation("hong2",nil,false,0)
        else
            refTemp:Get("SkeletonGraphic2"):SetAnimation("enter",DelayPlaySign,false,0)
        end
        refTemp:Get("SkeletonGraphic2"):AddAnimation("idle",nil,true,0)
    end
end

--- 狼族印记sign触发表现
function SingleWolfSingleCardView:ShowWolfSignEffect(cardId, signedCellID)
    local cardView = ModelList.BattleModel:GetCurrBattleView():GetCardView()
    local cardData = ModelList.BattleModel:GetCurrModel():GetRoundData(cardId)
    local cellObjOrigin = cardView:GetCardCell(cardId, signedCellID)
    
    --有狼族印记的格子、 印记连线路径
    local signCells, signLinePath = {}, {}
    table.each(cardData.cards, function(cellData)
        if cellData.haveWolfSign and cellData:IsNotSign() and cellData.index ~= signedCellID then
            cellData.haveWolfSign = false
            table.insert(signCells, cellData.index)
        end
    end)
    --印记格子排序
    table.sort(signCells, function(a, b) 
        local x, y = a / 5, b /5
        if x == y then return a > b end
        return x > y
    end)
    --排序后的路径
    table.each(signCells, function(cellID)
        local cellObj = cardView:GetCardCell(cardId, cellID)
        if fun.is_not_null(cellObj) then
            table.insert(signLinePath, cellObj.transform)
        end
    end)
    
    local skillObjs = {}
    local yinjiAliveTime = 2
    --盖章格子 印记出现特效
    BattleEffectCache:GetSkillPrefabFromCache("SingleWolfskillyinji", cellObjOrigin, function(obj)
        UISound.play("werewolf_imprint")
        --飞金币
        ModelList.BattleModel:GetCurrBattleView():ShowCoinFlyEffect(cardId, fun.get_gameobject_pos(cellObjOrigin,false))
        table.insert(skillObjs, obj)
    end, yinjiAliveTime, cardId)
    
    if #signCells == 0 then
        private.HideCellWolfSign(self, cardId, signedCellID)
        return
    end

    local lineMoveTime, lineMoveInterval = 0.8, 0.8
    --创建印记连线特效
    LuaTimer:SetDelayFunction(0.5, function()
        BattleEffectCache:GetSkillPrefabFromCache("SingleWolfskillyinjixian", cellObjOrigin, function(lineObj)
            table.insert(skillObjs, lineObj)
            --连线向每个印记移动
            local timerID
            timerID = LuaTimer:SetDelayLoopFunction(0, lineMoveTime + lineMoveInterval, -1, function()
                local next = table.remove(signLinePath, 1)
                if next then
                    --线移动
                    UISound.play("werewolf_line")
                    local pos = next.position
                    Anim.move(lineObj, pos.x, pos.y, pos.z, lineMoveTime, false, true,  function ()
                        --狼族印记动效
                        BattleEffectCache:GetSkillPrefabFromCache("SingleWolfskillyinji", next, function(obj)
                            UISound.play("werewolf_imprint")
                            --飞金币
                            ModelList.BattleModel:GetCurrBattleView():ShowCoinFlyEffect(cardId, pos)
                            table.insert(skillObjs, obj)
                        end, yinjiAliveTime,  cardId)
                    end)
                else
                    --Destroy(lineObj)
                    BattleEffectPool:Recycle("SingleWolfskillyinjixian", lineObj)
                    LuaTimer:Remove(timerID)

                    private.HideCellWolfSign(self, cardId, signedCellID)
                    table.each(signCells, function(cellID)
                        private.HideCellWolfSign(self, cardId, cellID)
                    end)
                end
            end,nil, nil,LuaTimer.TimerType.Battle)
        end, 0, cardId)
    end)
    
    --强制销毁
    --LuaTimer:SetDelayFunction(yinjiAliveTime + 2, function()
    --    table.each(skillObjs, function(obj)
    --        Destroy(obj)
    --    end)
    --end)
end

-----------------私有方法----------------------------------------------

--隐藏格子上的狼人印记
function private.HideCellWolfSign(self, cardId, cellID)
    local cardView = ModelList.BattleModel:GetCurrBattleView():GetCardView()

    --狼人印记
    local card_ref = fun.get_component(cardView:GetCardMap(cardId), fun.REFER)
    local cellObj = cardView:GetCardCell(cardId, cellID)
    local root = card_ref:Get("sign")
    local signObj = fun.find_child(root, cellObj.name.."/brand")
    fun.set_active(signObj, false)
end

return this