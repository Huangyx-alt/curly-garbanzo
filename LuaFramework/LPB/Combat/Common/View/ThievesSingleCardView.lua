---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/2/7 15:20
---


local BaseSingleCard = require("Combat.Common.View.BaseSingleCardView")

--- 夏威夷单张卡牌
local ThievesSingleCardView = BaseSingleCard:New();
local this = ThievesSingleCardView;
setmetatable(this, BaseSingleCard)
local private = {}

this.auto_bind_ui_items = {
    "B1",
    "B2",
    "B3",
    "B4",
    "B5",
    "I1",
    "I2",
    "I3",
    "I4",
    "I5",
    "N1",
    "N2",
    "N3",
    "N4",
    "N5",
    "G1",
    "G2",
    "G3",
    "G4",
    "G5",
    "O1",
    "O2",
    "O3",
    "O4",
    "O5",
    "b_letter",
    "reward1",
    "reward2",
    "reward_icon1",
    "rewardPar",
    "PerfectDaub",
    "letter_b",
    "letter_i",
    "letter_n",
    "letter_g",
    "letter_o",
    "icon",
    "ChipsContainer",
    "fooddz",
    "forbidCollide",
    "autoFlag",
    "sign",
    "flash_clone",
    "gift_clone",
    "ef_Bingo_click",
    "CanvasGroup",
    "Collectitem1",
    "Collectitem2",
    "Collectitem3",
    "Collectitem4",
    "flyItemRoot",
}

function ThievesSingleCardView:Clone(name)
    local o = { name = name }
    setmetatable(o, { __index = ThievesSingleCardView })
    o.nextKey = 0
    return o
end

local MaxTiers = 4

function ThievesSingleCardView:CheckUnlockTiers(cardId, ThievesPos)
    log.log(string.format("[ThievesLog] CardID:%s，保险箱位置:%s，已解锁", cardId, ThievesPos))
    Event.Brocast(EventName.Event_Collect_Item_By_Sign, cardId, ThievesPos)
end

function ThievesSingleCardView:ReduceLockTiers(cardId, cellIndex, unlockCount, cell, isMax, ref, ThievesPrisons)
    if unlockCount > MaxTiers then
        return
    end
    
    local refTemp = fun.get_component(cell, fun.REFER)
    if refTemp then
        --解锁动画
        refTemp:Get("Tielian"):Play("act")
        --解锁特效
        fun.set_active(refTemp:Get("bao"..unlockCount),true)
        
        if unlockCount <= MaxTiers then
            if refTemp then
                fun.set_active(refTemp:Get("lian"..unlockCount),false)
                UISound.play("thievesbreak")
            end
        end
        
        if isMax then
            fun.set_active(refTemp:Get("bao"..1),true)
            fun.set_active(refTemp:Get("bao"..2),true)
            fun.set_active(refTemp:Get("bao"..3),true)
            fun.set_active(refTemp:Get("bao"..4),true)
            
            UISound.play("thievesimprint")
            self:CheckUnlockTiers(cardId, cellIndex)
            fun.set_active(refTemp:Get("unlock"),true)
        end
    end
end

function ThievesSingleCardView:ForbidCollider()
    if self.forbidCollide then
        fun.set_active(self.forbidCollide, true)
    end
end

function ThievesSingleCardView:ReduceAllLockTiers(cardId, cellIndex, cell)
    local refTemp = fun.get_component(cell, fun.REFER)
    if refTemp then
        --锁链动画
        refTemp:Get("Tielian"):Play("act")
        
        for i = 1, MaxTiers do
            LuaTimer:SetDelayFunction(0.1 * i,function()
                if refTemp then
                    fun.set_active(refTemp:Get("bao"..i),true)
                    if fun.get_active_self(refTemp:Get("lian"..i)) then
                        fun.set_active(refTemp:Get("lian"..i),false)
                        UISound.play("thievesbreak")
                    end
                    
                    if i == MaxTiers then
                        UISound.play("thievesimprint")
                        self:CheckUnlockTiers(cardId, cellIndex)
                        fun.set_active(refTemp:Get("unlock"),true)
                    end
                end
            end)
        end
    end
end

function ThievesSingleCardView:CollectItem(cardId, thievesPos, key)
    if not key then
        self.nextKey = self.nextKey or 0
        self.nextKey = self.nextKey + 1
        key = self.nextKey
    end
    
    local key = "Collectitem" .. key
    local anima = self[key]
    if fun.is_not_null(anima) then
        log.log(string.format("[ThievesLog] 收集到道具，CalculateBingo"))
        CalculateBingoMachine.OnDataChange(cardId, thievesPos, MaxTiers)
        CalculateBingoMachine.CalcuateBingo(cardId)
        anima:Play("over")
    end
end

return this