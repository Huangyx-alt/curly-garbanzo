---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2024/6/17 14:43
---

--- SuperMacth活动单张卡牌界面

local BaseSingleCard = require("Combat.Common.View.BaseSingleCardView")

local SuperMatchSingleCardView = BaseSingleCard:New();
local this = SuperMatchSingleCardView

this.auto_bind_ui_items = {
    "1",
    "2",
    "3",
    "4",
    "5",
    "6",
    "7",
    "8",
    "9",
    "10",
    "11",
    "12",
    "13",
    "14",
    "15",
    "16",
    "17",
    "18",
    "19",
    "20",
    "21",
    "22",
    "23",
    "24",
    "25",
}

function SuperMatchSingleCardView:New(name)
    local o ={name = name}
    setmetatable(o,self)
    self.__index = self
    return o
end

function SuperMatchSingleCardView:Clone(name)
    local o = { name = name }
    setmetatable(o, self)
    self.__index = self
    return o
end

function SuperMatchSingleCardView:BindObj(obj,parentView)
    self:on_init(obj,parentView)
end


function SuperMatchSingleCardView:GetCardObj()
    return self.go
end

function SuperMatchSingleCardView:CreateBingoInfo()

end

function SuperMatchSingleCardView:ActiveCard(isActive, cardID)
    self:NormalActiveCard(isActive, cardID)
    self:InitBingoKeyArray()
end

---正常卡牌激活
function SuperMatchSingleCardView:NormalActiveCard(isActive, cardID)
    if self.go and cardID then
        fun.set_active(self.go, isActive)
    end
end

---优化卡牌激活
function SuperMatchSingleCardView:ActiveCardOptimize(isActive, cardID)
    --log.r("ActiveCardOptimize    "..cardID)
    local  timeInterval = 0.3
    if ModelList.BattleModel:IsHangUp() then timeInterval = 0.1 end
    coroutine.start(function()
        coroutine.wait(timeInterval * cardID)
        if self and fun.is_not_null(self.go) then
            self:NormalActiveCard(isActive, cardID)
        end
    end)
end

function SuperMatchSingleCardView:GetCell(cellIndex)
    return self[tostring(cellIndex)]
end



function SuperMatchSingleCardView:AddCommonEffect(effectType,parent,cellReference)
    if effectType == 1 then -- 添加ef_Bingo_click效果
        if fun.is_not_null(self.ef_Bingo_click) then
            local ef_Bingo_click = fun.get_instance(self.ef_Bingo_click)
            if ef_Bingo_click then
                ef_Bingo_click.name = "ef_Bingo_click"
                fun.set_parent(ef_Bingo_click, parent,true)
                cellReference:Set(ef_Bingo_click, "ef_Bingo_click")
            end
        end
    end
end

function SuperMatchSingleCardView:SignCell(cellIndex, isPlayer)
    if isPlayer then
        local img = fun.get_component(self[tostring(cellIndex)], fun.IMAGE)
        if img then
            img.enabled = false
        end
        local imgReap = self:GetParentView():GetImgReapClone(self[tostring(cellIndex)])
        fun.set_rect_local_pos(imgReap, 0, 0, 0)
        fun.set_active(self[tostring(cellIndex)], true)
        local aini = fun.get_component(imgReap, fun.ANIMATOR)
        if aini then
            AnimatorPlayHelper.Play(aini, {"in","img_reap"}, false, -1, function ()
                if img then
                    img.enabled = true
                end
                Destroy(imgReap)
            end,function()
                if img then
                    img.enabled = true
                end
                Destroy(imgReap)
            end)
        end
    else
        fun.set_active(self[tostring(cellIndex)], true)
    end
    --log.r(" sign cell  "..cellIndex)
    self:RefreshCellData(cellIndex)
    self:CalculateBingoCell(cellIndex)

    local bundle = {}
    --bundle.cardId = cardId
    bundle.index = cellIndex
    bundle.isMateSign = true
    Event.Brocast(EventName.CardCellFirstSignEffect, bundle)
end

--- 玩家对机器人盖章,触发合作手掌效果
function SuperMatchSingleCardView:PlayHandleEffect(cardId , signCells)
    BattleEffectCache:GetPrefabFromPoolOrCache("SuperMatchShouGet", self.go, function(go)
        UISound.play("supermatchdaub")
        fun.set_gameobject_scale(go, 0.5, 0.5, 1)
        LuaTimer:SetDelayFunction(1,function()
            --盖章
            for i = 1, #signCells do
                self:SignCell(ConvertServerPos(signCells[i]),true)
            end
            BattleEffectPool:DelayRecycle("SuperMatchShouGet", go, 2)
        end )
    end, 2)



   --local handEffect = self:GetParentView():CloneHandleEffect()
   -- fun.set_same_position_with(handEffect,self[tostring(cardId)])
   -- if handEffect then
   --
   --
   --     --LuaTimer:SetDelayFunction(1,function()
   --     --    for i = 1, #signCells do
   --     --        self:SignCell(ConvertServerPos(signCells[i]))
   --     --    end
   --     --end)
   -- end
end


function SuperMatchSingleCardView:CellChangeBingo(cellIndex,isLast)
    local sprite = fun.get_component(self[tostring(cellIndex)],fun.IMAGE)
    if sprite then
        sprite.sprite = AtlasManager:GetSpriteByName("BingoAtlas","b_bingo01_small")
    end
    fun.set_active(self[tostring(cellIndex)],true)
    log.r("CellChangeBingo  "..cellIndex)
    self:RefreshCellData(cellIndex,true,isLast)

end

function SuperMatchSingleCardView:RefreshCellData(cellIndex,isbingo,isLast)
    if not self.Cells then
        self.Cells = {}
    end
    if not self.Cells[cellIndex] then
        self.Cells[cellIndex] = 1
    elseif isbingo then
        self.Cells[cellIndex] = self.Cells[cellIndex] +1
    end
    if not self.bingouCount then
        self.bingouCount = 0
    end
    if isbingo and isLast then
        self.bingouCount = self.bingouCount + 1
    end
end


-- 获取每个格子key能形成bingo的所有排列规则
function SuperMatchSingleCardView:InitBingoKeyArray()
    self.cellBingoKeyArray = {}
    self.bingoRule = Csv.GetData("client_bingo_rule", 1, "content")
    for i = 1, 25 do
        local temp = {}
        for m = 1, #self.bingoRule do
            local temp2 = {}
            if fun.is_include(i, self.bingoRule[m]) then
                for n = 1, #self.bingoRule[m] do
                    table.insert(temp2, self.bingoRule[m][n])
                end
            end
            if #temp2 > 0 then
                table.insert(temp, temp2)
            end
        end
        if #temp > 0 then
            self.cellBingoKeyArray[i] = temp
        end
    end
end

--获取卡牌内可形成bingo列表的格子ID
function SuperMatchSingleCardView:CalculateBingoCell(cellIndex)
    if self.cellBingoKeyArray then
        --检查普通bingo
        for i = 1, #self.cellBingoKeyArray[cellIndex] do
            local keyArrayTemp = self.cellBingoKeyArray[cellIndex][i]
            local otherHasSign = true
            for n = 1, #keyArrayTemp do
                local cell_index = keyArrayTemp[n]
                if not self.Cells[cell_index]  then
                    otherHasSign = false
                end
            end
            if otherHasSign then
                for m = 1, #keyArrayTemp do
                    if self.Cells[keyArrayTemp[m]] == 1 then -- 盖章变成Bingo
                        self:CellChangeBingo(keyArrayTemp[m],#keyArrayTemp == m)
                    end
                end
                self:ShowBingoOrJackpot(false)
            end
        end
    end
end



function SuperMatchSingleCardView:GetBingoAnimaName(bingoCount)
    local cityID = ModelList.BattleModel:GetGameCityPlayID()
    local cfg = table.find(Csv["bingo_reward"], function(k, v)
        if v.city_play_id ~= cityID then
            return
        end
        return bingoCount == v.bingo
    end)
    bingoCount = cfg and cfg.effects or bingoCount

    local anima_name = "bingo"
    if bingoCount == 2 then
        anima_name = "doublebingo"
    elseif bingoCount == 3 then
        anima_name = "triplebingo"
    elseif bingoCount == 4 then
        anima_name = "quadrabingo"
    elseif bingoCount == 5 then
        anima_name = "pentabingo"
    elseif bingoCount > 5 then
        anima_name = "bingorampage"
    end
    return anima_name
end


function SuperMatchSingleCardView:ShowBingoOrJackpot(isJackpot)
    if not isJackpot then
        local anima_name = self:GetBingoAnimaName(self.bingouCount)
        self:BingoEffect( anima_name)
    else
        self:JackpotEffect("jackpot")
    end
end

function SuperMatchSingleCardView:GetBingoPrefabName()
    --if ModelList.BattleModel.GetIsJokerMachine() then
    --    return "efBingobingoClown"
    --end
    return "bingoxiao"
end

---@see  显示Bingo 特效
function SuperMatchSingleCardView:BingoEffect(anima_name)
    local par = self:GetCardObj()
    local pos = par.transform.position

    BattleEffectCache:GetPrefabFromPoolOrCache(self:GetBingoPrefabName(),par,function(eff1)
        if eff1 then
            eff1.gameObject:SetActive(false)
            fun.set_gameobject_pos(eff1,pos.x,pos.y,pos.z,false)
            --fun.set_gameobject_scale(eff1,0.2,0.2,0.2)
            eff1.gameObject:SetActive(true)
            --local anima = fun.get_component(eff1,fun.ANIMATOR)
            --if anima then
            --    anima:Play(anima_name)
            --end
            local prefabName = self:GetBingoPrefabName()
            BattleEffectPool:DelayRecycle(prefabName,eff1,3)
            UISound.play("supermatchbotbingo")
        else
            log.r("hangup_bingo  null")
        end
    end)
end

--显示Jackpot 特效
function SuperMatchSingleCardView:JackpotEffect(mapindex,anima_name,cellIndex, cardid)
    if not self.cardView:IsCardShowing(tonumber(cardid) ) then return end
    local par = self.cardView:GetCardMap(mapindex)
    local pos = par.transform.position
    --if not  BattleEffectPool:GetAndBind(self:GetBingoPrefabName(),par,3) then
    --    BattleEffectCache:GetPrefabFromCache(self:GetBingoPrefabName(),par,function(eff1)
    --    if eff1 then
    --        eff1.gameObject:SetActive(false)
    --        fun.set_gameobject_pos(eff1,pos.x,pos.y,pos.z,false)
    --        eff1.gameObject:SetActive(true)
    --        UISound.play("jackpot_firework")
    --        local anima = fun.get_component(eff1,fun.ANIMATOR)
    --        anima:Play(anima_name)
    --        self:ShowCoinFlyEffect(mapindex, par.transform.position)
    --        Destroy(eff1, 3)
    --    else
    --        log.r("hangup_bingo  null")
    --    end
    --end,cardid)
    --end
    BattleEffectCache:GetPrefabFromPoolOrCache(self:GetBingoPrefabName(),par,function(eff1)
        if eff1 then
            eff1.gameObject:SetActive(false)
            fun.set_gameobject_pos(eff1,pos.x,pos.y,pos.z,false)
            eff1.gameObject:SetActive(true)
            UISound.play("jackpot_firework")
            local anima = fun.get_component(eff1,fun.ANIMATOR)
            if anima then
                anima:Play(anima_name)
            end
            self:ShowCoinFlyEffect(mapindex, par.transform.position)
            BattleEffectPool:DelayRecycle(self:GetBingoPrefabName(),eff1,3)
            --Destroy(eff1, 3)
        else
            log.r("hangup_bingo  null")
        end
    end,cardid)


end


return this
