---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/7/3 17:16
---

Fsm = Clazz()

function Fsm:New()
    local o = {}
    setmetatable(o,{__index = Fsm})
    return o
end

function Fsm.CreateFsm(name,owner, fsmStateList)
    if name == nil then
        log.r("状态机名字不能为nil")
        return
    end
    if owner == nil then
        log.r("状态机拥有者不能为空")
        return
    end
    if fsmStateList == nil or #fsmStateList < 2 then
        log.r("状态机的状态列表不能为空或状态数不能少于2")
        return
    end
    local fsm = Fsm:New()
    fsm.name = name
    fsm._Owner = owner
    fsm._Destroyed = false
    fsm._States = {}
    for k,v in pairs(fsmStateList) do
        fsm._States[v.name] = v;
        v:InitState(fsm)
    end
    return fsm
end

function Fsm:InitFsm()

end

function Fsm:StartFsm(stateName)
    if self._States[stateName] == nil then
        log.r("找不到状态：" .. stateName)
        return
    end
    if self._CurrentState then
        log.r("重复启动状态机")
        return
    end
    self._CurrentState = self._States[stateName]
    --log.log("Fsm:StartFsm enter state ", self._CurrentState.name)
    self._States[stateName]:EnterState(self)
end

function Fsm:ChangeState(stateName,...)
    if self._States == nil then
        return
    end
    if self._States[stateName] == nil then
        log.r("找不到状态：" .. stateName)
        return
    end
    if self._CurrentState == nil then
        log.r("状态机还没启动")
        return
    end
    if self._CurrentState.name == stateName then
        --log.r("已在当前状态中")
        self._CurrentState:RepeatedEnter(self,...)
        return
    end
    if self._Destroyed == nil then
        log.r("状态机已销毁，无法切换状态")
        return
    end
    if self._CurrentState:FsmState() == FsmState.Enter_end then
        self._CurrentState:LeaveState(self)
        local previous = self._CurrentState
        self._CurrentState = self._States[stateName]
        --log.log("Fsm:ChangeState 1 " .. previous.name .. " -> ",self._CurrentState.name)
        self._States[stateName]:EnterState(self,previous.name,...)
    elseif self._CurrentState:FsmState() == FsmState.Enter_start then
        local params = ({...})
        self._CurrentState:WaitActionComplete(function()
            if self and self._CurrentState then
                self._CurrentState:LeaveState(self)
                local previous = self._CurrentState
                self._CurrentState = self._States[stateName]
                --log.log("Fsm:ChangeState 2 " .. previous.name .. " -> ",self._CurrentState.name)
                self._States[stateName]:EnterState(self,previous.name,unpack(params))
            end
        end )
    elseif self._CurrentState:FsmState() == FsmState.Init then
        log.r("错误，当前状态还未初始化！") 
    else
        log.r("错误，当前状态已离线！")
    end
end

function Fsm:IsFsmRunning()
    if self._CurrentState then
        return true
    end
    return false
end

function Fsm:HasState(stateName)
    if self._States and self._States[stateName] then
        return true
    end
    return false
end

function Fsm:GetState(stateName)
    if self:HasState(stateName) then
        return self._States[stateName]
    end
    return nil
end

function Fsm:GetCurState()
    return self._CurrentState
end

function Fsm:GetCurName()
    log.r("LwangZg 当前状态 self._CurrentState.name "..self._CurrentState.name)
    return self._CurrentState.name
end

function Fsm:GetOwner()
    return self._Owner
end

function Fsm:IsDispose()
    return self._Destroyed == nil
end

function Fsm:Dispose()
    if self._States then
        for k,v in pairs(self._States) do
            if v then
                v:Dispose()
            end
        end
        self.name = nil
        self._Owner = nil
        self._States = nil
        self._CurrentState = nil
        self._Destroyed = nil
        self._alias = nil
    end
end

function Fsm:SetAlias(alias)
    self._alias = alias
end

function Fsm:GetAlias(action)
    if self._alias then
        return self._alias[action] or action
    end
    return action
end

function Fsm:DoAction(action,gostate,callback,params)
    self:GetCurState()[self:GetAlias(action)](self:GetCurState(),self,gostate,callback,params)
end