---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/7/1 20:30
---

require 'Model/ModelPart/BaseGameModel'
require("Combat/Machine/CalculateBingoMachine")

--- 挂机Model
---@class HangUpModel : BaseGameModel
local HangUpModel = BaseGameModel.New()
local this = HangUpModel
this.reqSpeedChange = false

function HangUpModel:InitData()
    this:SetSelfGameType(PLAY_TYPE.PLAY_TYPE_AUTO_TICKET)
end

function HangUpModel:GetQuestItemScale()
    return 0.6
end

function HangUpModel:GetQuestItemOffsetPos(itemId)
    local itemType = Csv.GetItemOrResource(itemId, "item_type")
    if itemType == 33 then
        --火山活动道具
        return 15.5, -22
    end
    
    return 13.5, -15
end

function HangUpModel:GetWinZoneItemScale()
    return 0.45
end

function HangUpModel:GetWinZoneItemOffsetPos()
    return -18, 10
end

--请求进入自动挂机   ratio_str = “2,3” :卡片数量,倍率
function HangUpModel:ReqEnterGame()
    this:Clear()
    ModelList.BattleModel:DirectSetGameType(PLAY_TYPE.PLAY_TYPE_AUTO_TICKET,4)
    this:SetReadyState(0)
    Cache.Load_Atlas(AssetList["SceneLoadingGameAtlas"],"SceneLoadingGameAtlas",function()
        Facade.SendNotification(NotifyName.ShowUI, ViewList.SceneLoadingGameView,nil,nil,ProcedureHangUp:New())
    end)
    local cardNum = ModelList.CityModel:GetCardNumber()
    local betRate = ModelList.CityModel:GetBetRate()
    local powerupGear,powerupId = ModelList.CityModel:GetPowerupGear()
    local city = ModelList.CityModel:GetCity()
    local coupon = ModelList.CouponModel.get_currentCouponIdByCardNum(cardNum)
    local useId = ModelList.CouponModel.get_currentCouponUseIdByCardNum(cardNum)
    ModelList.CityModel:SavePreviousPlayInfo()
    this:ResetSettleCode()
    this.SendMessage(MSG_ID.MSG_GAME_LOAD_AUTO, {cardNum = cardNum,rate = betRate,powerUpId = powerupId,
                                                 cityId = city,couponId = coupon,useCouponId = useId,playId = 4});
    --this:InitBattleMessageQueue()
end

-- 批量请求卡片签章
function HangUpModel:ReqSignCard(info)
    --local curr_index = 0
    --local rewards ={}
    --info.index = curr_index
    for i = 1, #info.total do
        local isSuccessClick =  this:RefreshRoundDataByIndex(info.total[i].cardId, info.total[i].index, 1)
        if isSuccessClick then
            this:CalcuateBingo(info.total[i].cardId, info.total[i].index)
        end
        --local   giftLen = this:GetRoundData(info.total[i].cardId,info.total[i].index).gift
        --if #giftLen > 0 then
        --    if #giftLen >1 then log.r("多余1个的 道具 ") end
        --    table.insert(rewards,{number = info.total[i].number , rewards = {value =  1, id = giftLen[1]} })
        --end
    end
    --this.SendMessage(MSG_ID.MSG_HANGUP_SIGN, info, true);
    --Event.Brocast(EventName.Event_hangup_sign_reward,rewards)
end

--powerup 卡片签章
--function HangUpModel:SignCardWithPowerUp(tCardId,cardNum,need_fly_item,index)
--    this:CalcuateBingo(tCardId, index)
--    this:RefreshRoundData(tCardId,cardNum,1)
--end


--收到进入游戏返回，允许进入Game场景
function HangUpModel.ResEnterGame(code,data)
    --code = RET.RET_FAILED
    if(code == RET.RET_SUCCESS)then
        this:SaveGameLoadData(data)
        this:SetReadyState(1)
        this:InitRoundData()
        this:InitExtraData(data.ext)
        ModelList.BattleModel.SetIsJokerMachine( ( ( data.jokerData and #data.jokerData>0  ) or ModelList.CityModel:IsMaxBetRate()   ) and true or false)
        ModelList.BattleModel:BackupLoadData(data)
        this:SetGameState(GameState.Ready)
        Event.Brocast(EventName.Recorder_Data,5101,data)
    else
        log.r("5101返回 进入游戏失败"..code)
        --UIUtil.return_to_scenehome()
        UIUtil.show_common_global_popup(8004,true,function()
            Event.Brocast(EventName.Event_Cancel_Loading_Game)
            UIUtil.return_to_scenehome()
        end)
    end
end

--收到进入游戏返回，允许进入Game场景
function HangUpModel.ResEnterGameSure(code,data,seq)
    if(code == RET.RET_SUCCESS)then
        this:SetGameState(GameState.Ready)
    else
        log.r("5102 返回进入游戏失败"..code)
        UIUtil.show_common_error_popup(8004,true,function()
            this:Clear()
            LoadScene("SceneHome",ViewList.SceneLoadingHomeView,true)
        end)
    end
end



--请求使用power up
function HangUpModel.ReqUsePowerUp(index,extra_info)
    local curr_index =  0 --this:BattleMessageQueuePop()
    --local    gaid = this:LoadGameData().gameId
    --this.SendMessage(MSG_ID.MSG_HANGUP_POWERUP, {gameId = gaid,id = index,extra = extra_info ,index = curr_index});
end


--确认bingo场景加载完成，通知后端开始叫号
function HangUpModel:ReqGameReady()
    --local    gaid = this:LoadGameData().gameId
    local curr_speed = fun.read_value(MCT.HangUpSpeedConfig,1)
    fun.save_value(MCT.HangUpSpeedConfig,curr_speed)
    --this.SendMessage(MSG_ID.MSG_GAME_SPEED_UP, {gameId =gaid, speed = curr_speed },true);
    --this.SendMessage(MSG_ID.MSG_HANGUP_SURE, {gameId =gaid },true);
    this.StartBattleMachine()
    BattleModuleList.EnableUpdate()
    Event.Brocast(EventName.Recorder_Data,5102,nil)
end

--后端同步叫号
function HangUpModel.ResSyncNumber(code,data)
    if(code == RET.RET_SUCCESS)then
        this:SetNewCallNumber(data)
        this:AddCalledNumber( data.currNumber)
        --this:PlayCallNumberAduio(data.currNumber,data.bingo)
        Event.Brocast(Notes.SYNC_NUMBER,data)
        --Event.Brocast(EventName.SoundMachine_Call_Number_Audio,data.currNumber,data.bingo)
        --Event.Brocast(Notes.SYNC_NUMBER_ChARGE)
    else
        log.r("同步号码错误")
    end
end

--后端Bingo同步
function HangUpModel:ResBingoInfo(code,data)
    if(code == RET.RET_SUCCESS)then
        this:SaveBingoLeftInfo(data)
        this:RefreshBingoInfo()
        --this:BattleMessageQueuePushBingo(data.bingoId)
        --Event.Brocast(Notes.SYNC_BINGOSI)
        Facade.SendNotification(NotifyName.Bingo.Sync_Bingos)
        if data.bingoLeft <= 20 then
            UISound.set_bgm_volume(0.7)
        end
        if data.bingoLeft <= 0 then
            this:SetReadyState(2)
            LuaTimer:SetDelayFunction(MCT.delay_to_show_settle,function()
                --this:ShowSettle()
                this.loop_delay_settle = LuaTimer:SetDelayLoopFunction(0.1,0.1,100,function()
                    --if this:IsGameSettling() then
                        this:ShowSettle()
                        LuaTimer:Remove(this.loop_delay_settle)
                end,nil, nil,LuaTimer.TimerType.Battle)
            end)
        end
    else
        log.w("同步Bingo错误")
    end
end

--后端Bingo结算
function HangUpModel.ResBingoSettle(code,data)
    if(code == RET.RET_SUCCESS)then
        this:SaveSettleData(data,MSG_ID.MSG_HANGUP_SETTLE)
        this:SetReadyState(3)
        this:StopBattleMachine()
    else
        log.w("同步Bingo错误")
    end
end


--后端power返回
function HangUpModel.ResPowerUp(code,data)
    if(code == RET.RET_SUCCESS)then
        ViewList.HangUpView.powerView:StopSliderAniam()
        --this:BattleMessageQueuePushBingos(data.index,data.bingoIds)
    else
        log.w("同步Bingo错误")
    end
end


--后端power返回
function HangUpModel.ResSign(code,data)
    if(code == RET.RET_SUCCESS)then
        --Event.Brocast(EventName.Event_hangup_sign_reward,data.rewards)
        --this:BattleMessageQueuePushBingos(data.index,data.bingoIds)
--        log.w("ResPowerUp")
    else
        log.w("同步Bingo错误")
    end
end

function HangUpModel:IsSettleRankBeforeThree()
    return false
end


function HangUpModel:Clear()
    this.__index:Clear()
    ViewList.HangUpView = nil
    ViewList.HangUpView = require "View/HangUp/HangUpView"
    this.reqSpeedChange = false
end

--后端加速返回
function HangUpModel:CanReqSpeedup()
    return not this.reqSpeedChange
end

--后端加速返回
function HangUpModel:ReqSpeedup(new_speed)
    --local gaid = this:LoadGameData().gameId
    --if gaid then
    --    this.SendMessage(MSG_ID.MSG_GAME_SPEED_UP, { gameId = gaid, speed = new_speed },true);
    --end
end


--后端加速返回
function HangUpModel.ResSpeedup(code, data)
    this.reqSpeedChange = false
    if (code == RET.RET_SUCCESS) then
        log.w("ResSpeedup")
    else
        log.w("同步Bingo错误")
    end
end

--是否开启放大镜
function HangUpModel:IsOpenMirror()
    return false
end

function HangUpModel:OnReceiveSettle()

end


this.MsgIdList =
{

    {msgid = MSG_ID.MSG_GAME_LOAD_AUTO, func = this.ResEnterGame},
    {msgid = MSG_ID.MSG_HANGUP_SURE, func = this.ResEnterGameSure},
    {msgid = MSG_ID.MSG_HANGUP_SYNC_NUMBER, func = this.ResSyncNumber},
    --{msgid = MSG_ID.MSG_HANGUP_BINGO_LEFT, func = this.ResBingoInfo},
    {msgid = MSG_ID.MSG_HANGUP_SETTLE, func = this.ResBingoSettle},
    {msgid = MSG_ID.MSG_HANGUP_POWERUP, func = this.ResPowerUp},
    {msgid = MSG_ID.MSG_HANGUP_SIGN, func = this.ResSign},
    --{msgid = MSG_ID.MSG_GAME_SPEED_UP, func = this.ResSign},
}

return this
