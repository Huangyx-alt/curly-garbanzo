---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/4/22 19:12
---

ViewTool = {}
local this = ViewTool
local seasonCardSpriteCache = {}
local recommendGameSpriteCache = {}

---@see  加载战斗外食物图片_战斗内和战斗外两套食物图片
function ViewTool:LoadFoodSprite(assetBundle, iconName, img, callBack)
    Cache.load_sprite(AssetList[assetBundle], iconName, function(sp)
        if img and not fun.is_null(img) and not fun.is_null(sp) then
            img.sprite = sp
            if callBack then
                callBack(sp)
            end
        end
    end)
end

---@see  加载战斗食物图片_战斗内和战斗外两套食物图片
function ViewTool:LoadBattleFoodSprite(assetBundle, iconName, img, callBack)
    Cache.Load_Atlas(AssetList["BattleIngredientAtlas"], "BattleIngredientAtlas", function()
        if img and not Util.IsNull(img) then
            img.sprite = AtlasManager:GetSpriteByName("BattleIngredientAtlas", "Battle" .. iconName)
        end
        if callBack then
            callBack()
        end
    end)
    --Cache.load_sprite(AssetList["Battle"..assetBundle],"Battle"..iconName,function(sp)
    --    if img and not Util.IsNull(img) and sp then
    --        img.sprite = sp
    --        if callBack then
    --            callBack(sp)
    --        end
    --    end
    --end)
end

local GetAtlasByItemType = function(item_type)
    if item_type == 0 then
        --默认item
        return "GameItemAtlas"
    elseif item_type == 2 then
        --贴纸
        return "battlebook"
    elseif item_type == nil then
        return "ItemAtlas"
    else
        --限时任务
        return "GameItemAtlas"
    end
end

function ViewTool:LoadBattleGiftSprite(item_type, img, iconName)
    if not item_type or not img or not iconName then
        return
    end 
    
    if item_type == 1 then
        this:LoadBattleFoodSprite(iconName, iconName, img)
    else
        img.sprite = AtlasManager:GetSpriteByName(GetAtlasByItemType(item_type), iconName)
    end
end

function ViewTool:SetDescription(text, descriptId)
    text.text = Csv.GetData("description", descriptId, "description")
end

function ViewTool:IsFoodByItem(itemId)
    if Csv.GetData("item", itemId, "item_type") == 1 then
        return true
    end
    return false
end

function ViewTool:IsPuzzleByItem(itemId)
    if Csv.GetData("item", itemId, "item_type") == 5 then
        return true
    end
    return false
end

function ViewTool:IsCookieByItem(itemId)
    if Csv.GetData("item", itemId, "item_type") == 3 then
        return true
    end
    return false
end

function ViewTool:LoadSpriteFromLocalOrWeb(relativePath, url, callback)
    log.r("获取web上的资源 地址: " .. relativePath)
    callback = callback or function(sprite) end
    -- TODO 接口替换 by LwangZg
    CS.AssetsManager:GetFileFromLocalOrWeb(url, relativePath, function(succ, data, useLocal)
        if succ then
            local absolutePath = data
            local loader = WWWSpriteLoader.create()
            loader:run(absolutePath, function(sprite)
                callback(sprite)
                if fun.is_null(sprite) then
                    log.r("图片加载失败，relativePath, absolutePath, url：" .. relativePath, absolutePath, url)
                end
            end)
        else
            local msg = data
            if callback then
                callback(nil)
            end
            log.r("获得图片路径失败，relativePath, url， msg：" .. relativePath, url, msg)
        end
    end)
end

function ViewTool:LoadSeasonCardSprite(seasonId, iconName, img, callback)
    local baseUrl = ModelList.SeasonCardModel:GetSourceUrl(seasonId)
    local relativePath = "SeasonCard/" .. seasonId .. "/" .. iconName .. ".png"
    local url = baseUrl .. seasonId .. "/" .. iconName .. ".png"

    local cacheSprite = self:GetSeasonCardSpriteFromCache(seasonId, iconName)
    if cacheSprite then
        img.sprite = cacheSprite
        if callback then
            callback(cacheSprite)
        end
    else
        self:LoadSpriteFromLocalOrWeb(relativePath, url, function(sprite)
            if fun.is_not_null(img) and fun.is_not_null(sprite) then
                img.sprite = sprite
                self:CacheSeasonCardSprite(seasonId, iconName, sprite)
            end
            if callback then
                callback(sprite)
            end
        end)
    end
end

function ViewTool:GetSeasonCardSpriteFromCache(seasonId, iconName)
    if seasonCardSpriteCache[seasonId] and fun.is_not_null(seasonCardSpriteCache[seasonId][iconName]) then
        return seasonCardSpriteCache[seasonId][iconName]
    end
end

function ViewTool:CacheSeasonCardSprite(seasonId, iconName, sprite)
    if not seasonCardSpriteCache[seasonId] then
        seasonCardSpriteCache[seasonId] = {}
    end
    seasonCardSpriteCache[seasonId][iconName] = sprite
end

function ViewTool:ClearAllSeasonCardSprite()
    for seasonId, spriteList in pairs(seasonCardSpriteCache) do
        for spriteName, sprite in pairs(spriteList) do
            UnityEngine.Object.Destroy(sprite.texture)
            UnityEngine.Object.Destroy(sprite)
        end
    end
    seasonCardSpriteCache = {}
end

function ViewTool:ClearSeasonCardSpriteBySeasonId(id, reverse)
    for seasonId, spriteList in pairs(seasonCardSpriteCache) do
        if (seasonId == id and not reverse) or (seasonId ~= id and reverse) then
            for spriteName, sprite in pairs(spriteList) do
                UnityEngine.Object.Destroy(sprite.texture)
                UnityEngine.Object.Destroy(sprite)
            end
            seasonCardSpriteCache[seasonId] = {}
        end
    end
end

function ViewTool:GetRecommendGameSpriteFromCache(cityPlayId)
    if recommendGameSpriteCache[cityPlayId] and fun.is_not_null(recommendGameSpriteCache[cityPlayId]) then
        return recommendGameSpriteCache[cityPlayId]
    end
end

function ViewTool:CacheRecommendGameSprite(cityPlayId, sprite)
    if not recommendGameSpriteCache then
        recommendGameSpriteCache = {}
    end
    recommendGameSpriteCache[cityPlayId] = sprite
end

--- 加载推荐游戏图片
function ViewTool:LoadRecommendGameSprite(img, callback)
    local recommendId = ModelList.CityModel:GetRecommendid()
    local recommdData = Csv.GetData("feature_enter", recommendId)
    local cityPlayId = nil
    if recommdData ~= nil and recommdData.city_play then
        cityPlayId = recommdData.city_play
    end
    if cityPlayId then
        local relativePath = "RecommendGame/" .. cityPlayId .. ".png"
        local url = ModelList.CityModel:GetRecommendUrl()
        local cacheSprite = self:GetRecommendGameSpriteFromCache(cityPlayId)
        if cacheSprite then
            img.sprite = cacheSprite
            if callback then
                callback(cacheSprite)
            end
        else
            self:LoadSpriteFromLocalOrWeb(relativePath, url, function(sprite)
                if fun.is_not_null(img) and fun.is_not_null(sprite) then
                    img.sprite = sprite
                    self:CacheRecommendGameSprite(cityPlayId, sprite)
                end
                if callback then
                    callback(sprite)
                end
            end)
        end
    end
end
