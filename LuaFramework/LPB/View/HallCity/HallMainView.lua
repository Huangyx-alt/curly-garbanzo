---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/6/24 14:32
---
--require "View/CommonView/TopCurrencyTicketsView"
--require "View/CommonView/ShowHeadView"

local BaseHallView = require "View/HallCity/BaseHallView"
require "View/HallCity/HallFunctionContainer"

--require "View/CommonView/MsgScrollView"

local HallMainView = BaseHallView:New('HallMainView')
local this = HallMainView
this.viewType = CanvasSortingOrderManager.LayerType.Machine_Dialog

this._hallFunction = HallFunctionContainer:New()

this.auto_bind_ui_items = {
    --"btn_goback",
    --"TopCurrency",
    --"ShowHead",
    "TopQuickTask",
    "Play1cardView",
    "Play2cardView",
    "Play4cardView",
    "Animator",
    --"Img_hallbg",
    "betRateOperator",
    --"msg_ScrollView",
    --"img_coverage",
    "top_right_content",
    "top_left_content",
    --"TopQuickTask_popup"
    "countdown_function",
    "jackpot_console",
    "lobbyAdvertise",
    "text_lock",
    "cards_anima",
    "GiftPack",
    "center_left_content",
    "TopCompetitionCookieView",
    "CompetitionRoot",
    "ultra_jackpot_console",
    "SuperMatchJackpotEnable",
    "RightIconArea",
    "LeftIconArea",
    "btn_play",
    "btn_puzzle",
    "puzzle_reward_tip",
    "MagnifierRemainTime",
    "MagnifierRoot",
    "minigameParent",
}

function HallMainView:OnEnable()
    BaseHallView.OnEnable(self)
    self:UpdateMagnifierRemainTime()

    Event.AddListener(EventName.Event_hintTime_change, self.OnHintTimeChange, self)
end

function HallMainView:OnDisable()
    BaseHallView.OnDisable(self)
    
    Event.RemoveListener(EventName.Event_hintTime_change, self.OnHintTimeChange, self)
    
    self.magnifierRemainTime = 0
    if self.magnifierTimer then
        LuaTimer:Remove(self.magnifierTimer)
        self.magnifierTimer = nil
    end
end

function HallMainView:OpenView(callback,active)
    Facade.SendNotification(NotifyName.HallCity.ShowHallMainView,self,function()
        if callback then
            callback()
        end
    end,active)
    if fun.IsEditor() then
        ModelList.GMModel:OpenAutoBattle("HallMainView")
    end
    --- 打开界面的时候提前预加载pu图集
    Cache.Load_Atlas(AssetList["PowerUpAtlas"],"PowerUpAtlas")
    ModelList.BattleModel.UpdateBattleSuperMatchToggle(true)
end

function HallMainView:CloseView(callback)
    Facade.SendNotification(NotifyName.HideUI,self)
end

function HallMainView:OnPreviousFinish()
    BaseHallView.OnPreviousFinish(self)
    ModelList.GuideModel:OpenUI("HallMainView")
end

function HallMainView:UpdateMagnifierRemainTime()
    local count = ModelList.ItemModel.get_hintTime() or 0
    if count <= 0 then
        fun.set_active(self.MagnifierRoot, false)
        return
    end

    self.magnifierRemainTime = count

    if self.magnifierTimer then
        LuaTimer:Remove(self.magnifierTimer)
        self.magnifierTimer = nil
    end
    
    self.magnifierTimer = LuaTimer:SetDelayLoopFunction(0, 1, -1, function ()
        self.magnifierRemainTime = self.magnifierRemainTime - 1
        if self.magnifierRemainTime >= 0 then
            self.MagnifierRemainTime.text = fun.format_time(self.magnifierRemainTime)
        else
            if self.magnifierTimer then
                LuaTimer:Remove(self.magnifierTimer)
                self.magnifierTimer = nil
            end
            fun.set_active(self.MagnifierRoot, false)
        end
    end, nil)
end

function HallMainView:OnHintTimeChange()
    self:UpdateMagnifierRemainTime()
end

return this






























