
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/8/31 10:42
---
require "View/HallCity/PowerUpCardEntityView"
require "View/HallCity/PowerUpGearView"

local PowerUpPrimitiveState = require "State/PowerUpView/PowerUpPrimitiveState"
local PowerUpEnterState = require "State/PowerUpView/PowerUpEnterState"
local PowerUpDrawCardState = require "State/PowerUpView/PowerUpDrawCardState"
local PowerUpClickState = require "State/PowerUpView/PowerUpClickState"
local PowerUpShowHandState = require "State/PowerUpView/PowerUpShowHandState"

PowerUpViewMaster = BaseView:New("PowerUpViewMaster","PowerUpAtlas")
local this = PowerUpViewMaster
this.viewType = CanvasSortingOrderManager.LayerType.Machine_Dialog

local card_entity_cache = nil

local buy_powerupcard_type = 1

local enterFinishCallback = nil
local selfPuLevel  = 4  -- 当前是哪个pu 台
local power1gear = PowerUpGearView:New(BuyPowerCardGenre.onegear,selfPuLevel)
local power2gear = PowerUpGearView:New(BuyPowerCardGenre.twogear,selfPuLevel)
local power3gear = PowerUpGearView:New(BuyPowerCardGenre.threegear,selfPuLevel)

local isShowHint = nil

POWERUP_SHUFFLE_SPEED = 0.25

this.PowerUpCardNum = {
    [1] ="PPowerupsF1Card",
    [2] ="PPowerupsF2Card",
    [3] ="PPowerupsF2Card",
    [4] ="PPowerupsF4Card",
    [5] ="PPowerupsF4Card",
    [6] ="PPowerupsF6Card",
    [7] ="PPowerupsF6Card",
    [8] ="PPowerupsF8Card",
}

this.auto_bind_ui_items = {
    "btn_help",
    "btn_close",
    "btn_right",
    "btn_left",
    "btn_play",
    "slider_power",
    "img_star",
    "img_quality",
    "text_page",
    "card1",
    "card2",
    "card3",
    "card4",
    "card5",
    "card6",
    "card7",
    "card8",
    "card9",
    "powerupcard_entity",
    "anima",
    "Image_page",
    "ef_maxFill",
    "anima_showHand",
    "anima_handStar",
    "ef_play",
    "anim_title_shine",
    "anima_cards",
    "power1gear",
    "power2gear",
    "power3gear",
    "MagnifyingAd", --放大镜广告
    "jokeAmi",
    "BoxAmi",
    "lightAnim",
    "BoxCount",
    "CardNumImg", -- 现在是几卡的 图像

    "Img_drawCards",
    "PuBuffPanel",
    "btn_buy_buff",
    "img_point",
    "text_buff",
    "img_icon",
    "img_add",
    "Effect_out",
    "effect_out1",
    "effect_enter1",
    "effect_out2",
    "effect_enter2",
    "effect_out3",
    "effect_enter3",
    "Img_play1",
    "Img_play2",
    "Img_cooperation",
    "text_ticket",
    "Img_play3",
    "Img_extraRewardIcon",
    "Img_extraRewardIcon",
    "Img_smallGameIcon",
}
this.puad_instance =nil

function GetPowerupGearPos4(gear)
    if gear == BuyPowerCardGenre.onegear then
        return power1gear:GetGearCardPos()
    elseif gear == BuyPowerCardGenre.twogear then
        return power1gear:GetGearCardPos()
    elseif gear == BuyPowerCardGenre.threegear then
        return power2gear:GetGearCardPos()
    elseif gear == BuyPowerCardGenre.threegearplus then
        return power3gear:GetGearCardPos()
    else
        return Vector3.New(0,0,0)    
    end
end

function GetPowerupGearGo4(gear)
    if gear == BuyPowerCardGenre.onegear then
        return power1gear:GetGearCardGo()
    elseif gear == BuyPowerCardGenre.twogear then
        return  power1gear:GetGearCardGo()
    elseif gear == BuyPowerCardGenre.threegear then
        return power2gear:GetGearCardGo()
    else
        return nil
    end
end


function PowerUpViewMaster:New(viewName,atlasName)
    local o = {viewName = viewName,atlasName = atlasName,isShow = false,isLoaded = false,changeSceneClear = true}
    self.__index = self
    setmetatable(o,self)
    return o
end

function PowerUpViewMaster:SetEnterCallback(callback)
    enterFinishCallback = callback
end

function PowerUpViewMaster:OpenView(callback,active)
    Facade.SendNotification(NotifyName.HallCity.ShowPowerUpView,self,function()
        if callback then
            callback()
        end
    end,active)
end

function PowerUpViewMaster:CloseView(callback)
    Facade.SendNotification(NotifyName.CloseUI,self)
end

function PowerUpViewMaster:Awake(obj)
    self:on_init()
end

function PowerUpViewMaster:OnEnable(params)
    ---[[不要在OnEnable里处理其他功能了，请在入场动画播完的回调里处理，要不在低端机会卡入场动画显示不出来完整ui
    Facade.RegisterView(this)
    --引导powerUpView 
    --ModelList.GuideModel:OpenUI("PowerUpView")
    power1gear:SkipLoadShow(self.power1gear,true,nil,params)
    power2gear:SkipLoadShow(self.power2gear,true,nil,params)
    power3gear:SkipLoadShow(self.power3gear,true,nil,params)
    fun.set_active(self.btn_play,false)
    fun.set_active(self.MagnifyingAd,false)
    fun.set_active(self.jokeAmi,false)
    fun.set_active(self.PuBuffPanel, false)
    fun.set_active(self.Img_play2, false)
    fun.set_active(self.Img_play3, false)

    self:BuildFsm()
  --  self._fsm:GetCurState():EnterPowerUp(self._fsm)
 
    self:InitPowerUpEntity()
    self:SetCostInfo()
    self:RequestServer()
    self:CheckJokeHelpView()

    Event.Brocast(EventName.Event_topbar_change,false,TopBarChange.goback)
    ---]]不要在OnEnable里处理其他功能了，请在入场动画播完的回调里处理，要不在低端机会卡入场动画显示不出来完整ui
end

function PowerUpViewMaster:CheckJokeHelpView()
    if ViewList.SeasonPowerUpPosterView.isShow then
        return
    end
    
    local playerInfo =  ModelList.PlayerInfoModel:GetUserInfo()
    local value = fun.read_value("PowerupjokeHelperview".."uid"..playerInfo.uid,nil)
    if not value or value == 0 then
        if not value then fun.save_value("PowerupjokeHelperview".."uid"..playerInfo.uid,1) end
        Facade.SendNotification(NotifyName.ShowUI,ViewList.PowerupjokeHelperview)
    end
end

function PowerUpViewMaster:BuildFsm()
    self:DisposeFsm()
    self._fsm = Fsm.CreateFsm("PowerUpViewMaster",self,{
        PowerUpPrimitiveState:New(),
        PowerUpEnterState:New(),
        PowerUpDrawCardState:New(),
        PowerUpClickState:New(),
        PowerUpShowHandState:New()
    })
    self._fsm:StartFsm("PowerUpPrimitiveState")
end

function PowerUpViewMaster:DisposeFsm()
    if self._fsm then
        self._fsm:Dispose()
        self._fsm = nil
    end
end

function PowerUpViewMaster:OnEnterPowerUp()
    AnimatorPlayHelper.Play(self.anima,"PowerUpView_in",true,1.3,function()
        power1gear:PlayCardFlip()
        power2gear:PlayCardFlip()
        power3gear:PlayCardFlip()
        UISound.play("powerup_appear")
        fun.set_active(self.btn_play,true)
        self:InitPuadData()
    end,function()
        if self._fsm and self._fsm:GetCurState().EnterFinish then 
            self._fsm:GetCurState():EnterFinish(self._fsm)
        end 
        
        self:Play_PlayEffect()
        ModelList.GuideModel:OpenUI("PowerUpView")
        if enterFinishCallback then
            enterFinishCallback(4)
            enterFinishCallback = nil
        end
        self:PlayJokeAmi()
       
        
        --检测是否多个优惠得 有多个优惠得情况下不能购买
        self:register_timer(1, function()
            self:CheckDiscountAutoBuy(true)
        end,nil,LuaTimer.TimerType.UI)
    end)
end


function PowerUpViewMaster:CheckDiscountAutoBuy(flag)

    if ModelList.CityModel:GetMaxPage() == 0 and
    ModelList.CouponModel.get_couponCountPowerupFree() == 1  then
        if power1gear:IsDiscountFree() then
            power1gear:PlayFreeTip()
        elseif power2gear:IsDiscountFree() then
            power2gear:PlayFreeTip()
        elseif power3gear:IsDiscountFree() then
            power3gear:PlayFreeTip()    
        else
            log.r("not IsDiscountFree ")
            if (flag == true) then
                self:register_timer(1, function()
                    self:CheckDiscountAutoBuy(false)
                end,nil,LuaTimer.TimerType.UI)
            end 
        end
    else
        self:TryPopupPuBuffPackView()
    end
end

function PowerUpViewMaster:Play_PlayEffect()
    local cards = ModelList.CityModel:GetCardsCurrentPage(selfPuLevel)
    if #cards > 1 then
        local duration = Util.PlayParticle(self.ef_play)
        if duration > 0 then
            if self.efPlayTimer == nil then
                self.efPlayTimer = Invoke(function()
                    self.efPlayTimer = nil
                    fun.set_active(self.ef_play,false)
                end,duration)
            end
        end
    end

     --如果有小丑卡的情况下，播放别的动画
    
    local jokeCards = ModelList.CityModel:GetJokeCardsCurrentPage(selfPuLevel)
    if #jokeCards >0 then 
        self.BoxAmi:Play("no")  --有小丑卡的情况
        self:ShowBoxCount(jokeCards)
    else
        self.BoxAmi:Play("yes")  --有小丑卡的情况
    end 
end

function PowerUpViewMaster:InitPowerUpEntity()
    if card_entity_cache == nil then
        card_entity_cache = {}
        local cards = {this.card1,this.card2,this.card3,this.card4,this.card5,this.card6,this.card7,this.card8,this.card9}
        for i = 1, #cards do
            local go = self:GetPowerUpEntity(cards[i]) --fun.get_instance(this.powerupcard_entity,cards[i])
            local cardEntity = PowerUpCardEntityView:New(i,math.floor((i - 0.5) / 3) + 1)
            table.insert(card_entity_cache,cardEntity)
            cardEntity:SkipLoadShow(go)
        end
    else
        local cards = {this.card1,this.card2,this.card3,this.card4,this.card5,this.card6,this.card7,this.card8,this.card9}
        for i = 1, #cards do
            if fun.is_null(card_entity_cache[i].go) then
                local go = self:GetPowerUpEntity(cards[i])
                card_entity_cache[i]:SkipLoadShow(go)
            end
        end   
    end
end

function PowerUpViewMaster:GetPowerUpEntity(parent)
    local chatItem = fun.get_child(parent,0)
    if chatItem == nil then
        chatItem = fun.get_instance(self.powerupcard_entity,parent)
    else
        chatItem = chatItem.gameObject
    end
    return chatItem
end

function PowerUpViewMaster:SetCostInfo()
	local cost1 = 0;
	local cost2 = 0;
	local cost3 = 0;
	
	local playId = ModelList.CityModel.GetPlayIdByCity()
    local playType = ModelList.CityModel.GetCurPlayType()
    local data = ModelList.CityModel:GetPowerUpRange()
    local betrate = ModelList.CityModel:GetBetRate() or 1
	local cost =data[playId][selfPuLevel].range_pay_cutting;
    local cardNum = ModelList.CityModel:GetCardNumber()
    local flag = ModelList.PlayerInfoModel:CheckAbTest("powerup_range")  -- ab测试
    Cache.SetImageSprite("PowerUpAtlas",this.PowerUpCardNum[tonumber(cardNum)], self.CardNumImg)
    
    if ModelList.UltraBetModel:IsActivityValidForCurPlay() then
		local UltraLevel = ModelList.UltraBetModel:GetActivityLevel()
		cost = Csv.GetCityUtlaCost(playId,UltraLevel,cardNum)
		cost1 = not flag and cost[1] or cost[1] ; --1档
		cost2 = not flag and cost[2] or cost[2] ;  --2档
		cost3 = not flag and cost[3] or cost[3] ;  --3档
	else

        local cardCost = cost[1]
        for i = 1, #cost do
            if fun.starts(cost[i][1],tostring(cardNum)) then
                cardCost = cost[i]
                break
            end
        end

        cost1 =  tonumber(string.sub( cardCost[1],3) ); --1档
        cost2 = tonumber(cardCost[2]) ;  --2档
        cost3 = tonumber(cardCost[3]) ;  --3档

    end 

	ModelList.CityModel:SetPowerupCost(BuyPowerCardGenre.onegear,cost1)
	ModelList.CityModel:SetPowerupCost(BuyPowerCardGenre.twogear,cost2)
	ModelList.CityModel:SetPowerupCost(BuyPowerCardGenre.threegear,cost3)
	power1gear:SetPowerCost()
	power2gear:SetPowerCost()
	power3gear:SetPowerCost()
end

function PowerUpViewMaster:RequestServer()
    ModelList.CityModel.C2S_FetchPowerUp(0,selfPuLevel)
end

function PowerUpViewMaster:InitPuadData() 
    local level = ModelList.PlayerInfoModel:GetLevel()
    local taLevel = Csv.GetData("grocery",1,"level")
    local value =  ModelList.ItemModel.get_hintTime()
    
    local powerGearFal = power1gear:GetPuAdState() -- todo 后面还要加其他的pu
    local mode = ModelList.CityModel:GetEnterGameMode()
  
    if taLevel and  level>=taLevel and value <=0 and powerGearFal == false and mode ~= PLAY_TYPE.PLAY_TYPE_AUTO_TICKET  then 
        local view = require "View/Popup/MagnifyingAdView"

        if not this.puad_instance then 
            this.puad_instance = view:New()
       
            this.puad_instance:SkipLoadShow(self.MagnifyingAd)
        end 
        fun.set_active(self.MagnifyingAd,true )
    else 
        fun.set_active(self.MagnifyingAd,false)
    end 
end

function PowerUpViewMaster.OnFetchPowerUp_Result()
    this:SetCurrentPageCards(false)
    this:UpdatePuBuffState()
    this:UpdateSmallGameState()
    this:UpdateExtraRewardState()
end

function PowerUpViewMaster:SetCurrentPageCards(firstInit)
    local cards = {}
    if not firstInit then
        ModelList.CityModel:ResetPage(selfPuLevel)
        cards = ModelList.CityModel:GetCardsCurrentPage(selfPuLevel)
        --[[undo wait delete for test
        cards[1] = 801
        --]]
    end
    for i = 1, #card_entity_cache do
        card_entity_cache[i]:SetActive(true)
        --card_entity_cache[i]:SetPosition(0,0,0)
        card_entity_cache[i]:SetFaceLock(cards[i])
        card_entity_cache[i]:SetPowerCardData(cards[i])
    end
    self:DoTweenPowerIndecator(cards)
    self.text_page.text = string.format("%s/%s",ModelList.CityModel:GetPage(selfPuLevel),ModelList.CityModel:GetMaxPage())
    self:ShowPage()

    if self._fsm then 
        self._fsm:GetCurState():EnterPowerUp(self._fsm)
    end 

end

function PowerUpViewMaster:SetPreviousPageCards()
    self._fsm:GetCurState():TurnPage(self._fsm,1,3)
end

function PowerUpViewMaster:ShowPage()
    if ModelList.CityModel:IsPowerCardEmpty(selfPuLevel) then
        fun.set_active(self.Image_page,false)
    else
        fun.set_active(self.Image_page,true)
    end
    self:SetPageBtn()
end

function PowerUpViewMaster:SetPageBtn()
    fun.set_active(self.btn_left.transform,ModelList.CityModel:GetPage(selfPuLevel) > 1)
    fun.set_active(self.btn_right.transform,ModelList.CityModel:GetPage(selfPuLevel) < ModelList.CityModel:GetMaxPage())
end

function PowerUpViewMaster:OnTurnPage(dir)
    if dir == 1 then
        if ModelList.CityModel:GetPage(selfPuLevel) > 1 then
            local cards = ModelList.CityModel:GetCardsPreviousPage(selfPuLevel)
            for i = 1, #card_entity_cache do
                card_entity_cache[i]:TurnPage(cards[i],1)
            end
            self:DoTweenPowerIndecator(cards)
            self.text_page.text = string.format("%s/%s",ModelList.CityModel:GetPage(selfPuLevel),ModelList.CityModel:GetMaxPage())
        end
    elseif dir == 2 then
        if ModelList.CityModel:GetPage(selfPuLevel) < ModelList.CityModel:GetMaxPage() then
            local cards = ModelList.CityModel:GetCardsNextPage(selfPuLevel)
            for i = 1, #card_entity_cache do
                card_entity_cache[i]:TurnPage(cards[i],2)
            end
            self:DoTweenPowerIndecator(cards)
            self.text_page.text = string.format("%s/%s",ModelList.CityModel:GetPage(selfPuLevel),ModelList.CityModel:GetMaxPage())
        end
    end
    self:SetPageBtn()
    UISound.play("powerup_flip")
end

function PowerUpViewMaster:SetNextPageCards()
    self._fsm:GetCurState():TurnPage(self._fsm,2,3)
end

function PowerUpViewMaster:OnDrawCard()
    if self._drawCard then
        self._drawCard()
        self._drawCard = nil
        self.text_page.text = string.format("%s/%s",ModelList.CityModel:GetPage(selfPuLevel),ModelList.CityModel:GetMaxPage())
        self:ShowPage()
    end
end

function PowerUpViewMaster:DrawCardDisableBtn(disable)
    Util.SetImageColorGray(self.btn_play, disable)
    Util.SetImageColorGray(self.btn_close, disable)
    
    if disable == true then 
        power1gear:DrawCardDisableBtn(disable)
        power2gear:DrawCardDisableBtn(disable)
        power3gear:DrawCardDisableBtn(disable)
      
    else 
        self:register_timer(1.3, function()
            power1gear:DrawCardDisableBtn(disable)
            power2gear:DrawCardDisableBtn(disable)
            power3gear:DrawCardDisableBtn(disable)
        end) 
    end 

end

function PowerUpViewMaster:ResetPowerIndecator()
    self.slider_power.value = 0
    --fun.set_active(self.img_star,false)
    this.anima_showHand:Play("powerup_showhand_hide",0,0)
    this.anima_handStar:Play("powerup_handstar_hide",0,0)
end

function PowerUpViewMaster:DoTweenPowerIndecator(cards)
    if cards then
        this.OnDoTweenPowerIndecator(cards,nil,nil,true)
    end
end

function PowerUpViewMaster.OnDoTweenPowerIndecator(powerupcard,index,lenth,onTurn)
    
    local groupId = ModelList.CityModel:GetCardsGroupId(nil,selfPuLevel)
    if groupId then
        if index and index == 1 then
            --this.anim_title_shine:Play("powerup_title_shine01",0,1)
            AnimatorPlayHelper.Play(this.anim_title_shine,"powerup_title_shine01",true,nil)
        elseif index and groupId then
            return --电力值给了总值，不需要分开计算了    
        end
        if this._power == nil then
            this._power = Csv.GetControlByName("powerup_score")
        end
        if powerupcard then
            local card = nil
            local sourceValue = this.slider_power.value * this._power[4][1]
            local targetValue = 0
            local showStar = false
            local turnPage = index == nil
            local isCardList = false
            if type(powerupcard) == "table" then
                local power = 0
                isCardList = true
                for i, v in pairs(powerupcard) do
                    if v then
                        local pcard = Csv.powerup_card[v]
                        if pcard then
                            power = power + pcard.power
                        end
                    end
                end
                targetValue =  power
                showStar = true
                lenth = 1
            else
                card = Csv.powerup_card[powerupcard]
                if card then
                    targetValue = sourceValue + card.power
                else
                    log.r("Error:card is nil. id: " .. powerupcard)    
                end
                if index and index == lenth then
                    showStar = true
                end
            end
            if this._tweenIndecator then
                this._tweenIndecator:Complete()
            end
            if groupId then
                targetValue = ModelList.CityModel:GetCardsPower(nil,selfPuLevel) or Csv.GetData("powerup_group",groupId,"power")
            end
            targetValue = targetValue or 1 
            this._tweenIndecator = Anim.do_smooth_float_update(sourceValue,targetValue,POWERUP_SHUFFLE_SPEED * lenth,
            function(num)
                this.slider_power.value = num / this._power[4][1]
            end,
            function(num)
                if groupId or showStar then
                    local callback = function()
                        log.g("this._tweenIndecator FinishShowHand")
                        --在某些机型上动画是可能提前去完成了 提前转换状态
                        local statename =this._fsm:GetCurState().name
                        if statename ~= "PowerUpShowHandState" and statename ~= "PowerUpClickState" then 
                            this._fsm:ChangeState("PowerUpShowHandState")
                        end 
                        this._fsm:GetCurState():FinishShowHand(this._fsm)
                        if not turnPage then
                            this:Play_PlayEffect()
                            --_currency:SetDisable(true)
                        end
                    end
                    local quality = ModelList.CityModel:GetCardsLevel(nil,4) or Csv.GetData("powerup_group",groupId,"level")
                    if turnPage then
                        if quality == 4 then
                            this.anima_handStar:Play("powerup_handstar_jackpot",0,1)
                        elseif quality == 3 then
                            this.anima_handStar:Play("powerup_handstar_epic",0,1)
                        elseif quality == 2 then
                            this.anima_handStar:Play("powerup_handstar_great",0,1)
                        elseif quality == 1 then
                            this.anima_handStar:Play("powerup_handstar_good",0,1)
                        else
                            this.anima_handStar:Play("powerup_handstar_hide",0,1)
                        end
                        callback()
                    else
                        if quality == 4 then
                            this.anima_handStar:Play("powerup_handstar_jackpot",0,0)
                            this.anima_showHand:Play("powerup_showhand_jackpot",0,0)
                          --  AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_jackpot",false,nil)
                        elseif quality == 3 then
                            this.anima_handStar:Play("powerup_handstar_epic",0,0)
                            this.anima_showHand:Play("powerup_showhand_epic",0,0)
                          --  AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_epic",false,nil)
                        elseif quality == 2 then
                            this.anima_handStar:Play("powerup_handstar_great",0,0)
                            this.anima_showHand:Play("powerup_showhand_great",0,0)
                          --  AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_great",false,nil)
                        elseif quality == 1 then
                            this.anima_handStar:Play("powerup_handstar_good",0,0)
                            this.anima_showHand:Play("powerup_showhand_good",0,0)
                            --AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_good",false,nil)
                        end
                        callback()
                    end
                    if not isCardList then
                        if buy_powerupcard_type == BuyPowerCardGenre.onegear then
                            UISound.play("powerup_energy_1")
                        elseif buy_powerupcard_type == BuyPowerCardGenre.twogear then
                            UISound.play("powerup_energy_2")    
                        elseif buy_powerupcard_type == BuyPowerCardGenre.threegear then
                            UISound.play("powerup_energy_3")    
                        elseif buy_powerupcard_type == BuyPowerCardGenre.threegearplus then 
                            UISound.play("powerup_energy_3")    

                        end
                    else
                        local cardNum = #powerupcard
                        if cardNum == 3 then
                            UISound.play("powerup_energy_1")
                        elseif cardNum == 6 then
                            UISound.play("powerup_energy_2")   
                        elseif cardNum == 9 then
                            UISound.play("powerup_energy_3")       
                        end
                    end
                end
            end)
            this._tweenIndecator:SetEase(DG.Tweening.Ease.OutSine)
        end 
    else
        if index and index == 1 then
            --this.anim_title_shine:Play("powerup_title_shine01",0,1)
            AnimatorPlayHelper.Play(this.anim_title_shine,"powerup_title_shine01",true,nil)
        end
        if this._power == nil then
            this._power = Csv.GetControlByName("powerup_score")
        end
        if powerupcard then
            local card = nil
            local sourceValue = this.slider_power.value * this._power[4][1]
            local targetValue = 0
            local showStar = false
            local turnPage = index == nil
            local isCardList = false
            if type(powerupcard) == "table" then
                local power = 0
                isCardList = true
                for i, v in pairs(powerupcard) do
                    if v then
                        local pcard = Csv.powerup_card[v]
                        if pcard then
                            power = power + pcard.power
                        end
                    end
                end
                targetValue =  power
                showStar = true
            else
                card = Csv.powerup_card[powerupcard]
                if card then
                    targetValue = sourceValue + card.power
                else
                    log.r("Error:card is nil. id: " .. powerupcard)    
                end
                if index and index == lenth then
                    showStar = true
                end
            end
            if this._tweenIndecator then
                this._tweenIndecator:Complete()
            end
            this._tweenIndecator = Anim.do_smooth_float_update(sourceValue,targetValue,POWERUP_SHUFFLE_SPEED,
            function(num)
                this.slider_power.value = num / this._power[4][1]
            end,
            function(num)
                if showStar then
                    local callback = function()
                        this._fsm:GetCurState():FinishShowHand(this._fsm)
                        if not turnPage then
                            this:Play_PlayEffect()
                            --_currency:SetDisable(true)
                        end
                    end
                    if turnPage then
                        if num >= this._power[3][1] then
                            --this.anima_showHand:Play("powerup_showhand_epic",0,1)
                            this.anima_handStar:Play("powerup_handstar_epic",0,1)
                        elseif num >= this._power[2][1] then
                            --this.anima_showHand:Play("powerup_showhand_great",0,1)
                            this.anima_handStar:Play("powerup_handstar_great",0,1)
                        elseif num >= this._power[1][1] then
                            --this.anima_showHand:Play("powerup_showhand_good",0,1)
                            this.anima_handStar:Play("powerup_handstar_good",0,1)
                        else
                            --this.anima_showHand:Play("powerup_showhand_hide",0,1)
                            this.anima_handStar:Play("powerup_handstar_hide",0,1)
                        end
                        callback()
                    else
                        if num >= this._power[3][1] then
                            this.anima_handStar:Play("powerup_handstar_epic",0,0)
                           -- AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_epic",false,nil)
                            this.anima_showHand:Play("powerup_showhand_epic",0,0)
                        elseif num >= this._power[2][1] then
                            this.anima_handStar:Play("powerup_handstar_great",0,0)
                            this.anima_showHand:Play("powerup_showhand_great",0,0)
                           -- AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_great",false,nil)
                        elseif num >= this._power[1][1] then
                            this.anima_handStar:Play("powerup_handstar_good",0,0)
                            this.anima_showHand:Play("powerup_showhand_good",0,0)
                          --  AnimatorPlayHelper.Play(this.anima_showHand,"powerup_showhand_good",false,nil)
                        --else
                            --callback()
                        end
                        callback()
                    end
                    if not isCardList then
                        if buy_powerupcard_type == BuyPowerCardGenre.onegear then
                            UISound.play("powerup_energy_1")
                        elseif buy_powerupcard_type == BuyPowerCardGenre.twogear then
                            UISound.play("powerup_energy_2")    
                        elseif buy_powerupcard_type == BuyPowerCardGenre.threegear then
                            UISound.play("powerup_energy_3")   
                        elseif buy_powerupcard_type == BuyPowerCardGenre.threegearplus then
                            UISound.play("powerup_energy_3")   
                        end
                    else
                        local cardNum = #powerupcard
                        if cardNum == 3 then
                            UISound.play("powerup_energy_1")
                        elseif cardNum == 6 then
                            UISound.play("powerup_energy_2")   
                        elseif cardNum == 9 then
                            UISound.play("powerup_energy_3")       
                        end
                    end
                end
            end)
        end
    end

    --适用左右切换的情况
    if onTurn then 
        local jokeCards = ModelList.CityModel:GetJokeCardsCurrentPage(4)
        if #jokeCards >0 then 
            this.BoxAmi:Play("no")  --有小丑卡的情况
            this:ShowBoxCount(jokeCards)
        else 
            this.BoxAmi:Play("yes")  --没有小丑卡的情况
        end 
    end 
  
end

function PowerUpViewMaster:ShowHandPlayClick()
    self.anima_showHand.speed = 2 --加速播放showhand动画
end

function PowerUpViewMaster:DrawCardPlayClick()
    
end

function PowerUpViewMaster:OnClickDrawCard(gear)
    buy_powerupcard_type = gear
    local cardNum = ModelList.CityModel:GetCardNumber(); 
    -- if gear == BuyPowerCardGenre.onegear then
    --     local discount_id = power1gear:GetDiscountId()
    --     local discount_useId = power1gear:GetDiscountUseId()
    --     local powerup_cost = power1gear:GetPowerupCost()
    --     self:CheckGemCost(powerup_cost,function()
    --         ModelList.CityModel.C2S_BuyPowerUpCards(gear,discount_id,discount_useId,4) 
    --     end)
    -- elseif gear == BuyPowerCardGenre.twogear then
    if gear == BuyPowerCardGenre.onegear then
        local discount_id = power1gear:GetDiscountId()
        local discount_useId = power1gear:GetDiscountUseId()
        local powerup_cost = power1gear:GetPowerupCost()
        self:CheckGemCost(powerup_cost,function()
            ModelList.CityModel.C2S_BuyPowerUpCards(gear,discount_id,discount_useId,4,cardNum)
        end)
    elseif gear == BuyPowerCardGenre.twogear then
        local discount_id = power2gear:GetDiscountId()
        local discount_useId = power2gear:GetDiscountUseId()
        local powerup_cost = power2gear:GetPowerupCost()
        self:CheckGemCost(powerup_cost,function()
           ModelList.CityModel.C2S_BuyPowerUpCards(gear,discount_id,discount_useId,4,cardNum)
        end)
    elseif gear == BuyPowerCardGenre.threegear then
        local discount_id = power3gear:GetDiscountId()
        local discount_useId = power3gear:GetDiscountUseId()
        local powerup_cost = power3gear:GetPowerupCost()
        self:CheckGemCost(powerup_cost,function()
           ModelList.CityModel.C2S_BuyPowerUpCards(gear,discount_id,discount_useId,4,cardNum)
        end)

    end
end

function PowerUpViewMaster:OnDisable()
    Facade.RemoveView(this)
   
    self:DisposeFsm()
    if self.efPlayTimer then
        self.efPlayTimer:Stop()
        self.efPlayTimer = nil
    end
    Event.Brocast(EventName.Event_topbar_change,true,TopBarChange.goback)
    enterFinishCallback = nil
    self:ResetGear()

    self:ClearBuffCountDown()
    self:ClearFromAdventureFlag()
    self:ClearBuffSeasonCountDown()
    self:ClearSmallGameCountDown()
    self.buffRemainTime = 0
    self.buffReaminTimeSnapshoot = nil
    self.smallGameRemainTime = 0
    self.isExtraRewardTipInit = nil
end

function PowerUpViewMaster:ResetGear()
    if power1gear then
        power1gear:ResetOnDisable()
    end
    if power2gear then
        power2gear:ResetOnDisable()
    end
    if power3gear then
        power3gear:ResetOnDisable()
    end
end

function PowerUpViewMaster:on_close()

end

function PowerUpViewMaster:OnDestroy()
     if this.puad_instance then 
        this.puad_instance:Close()
        this.puad_instance = nil 
    end 
    self:Close()
    self:DisposeFsm()
end

function PowerUpViewMaster:on_btn_help_click()
    self._fsm:GetCurState():ShowPowerupHelper(self._fsm)
end

function PowerUpViewMaster:OnShowPowerupHelper()
    Facade.SendNotification(NotifyName.ShowUI,ViewList.PowerupHelperView)
end

function PowerUpViewMaster:on_btn_close_click()
    self._fsm:GetCurState():CloseView(self._fsm,1)
end

function PowerUpViewMaster:OnCloseView()
    AnimatorPlayHelper.Play(self.anima,"PowerUpView_out",true,function()
        self._fsm:GetCurState():FinishClick(self._fsm)
        Facade.SendNotification(NotifyName.CloseUI,this)
    end)
end

function PowerUpViewMaster:OnClosePu()
    Facade.SendNotification(NotifyName.CloseUI,this)
end

function PowerUpViewMaster:on_btn_right_click()
    self:SetNextPageCards()
end
function PowerUpViewMaster:on_btn_left_click()
    self:SetPreviousPageCards()
end

---flag 是否发消息
function PowerUpViewMaster.OnPowerUpGearClick(gear)
   

    this._fsm:GetCurState():ClickDrawCard(this._fsm,gear,4)
end

function PowerUpViewMaster:CheckGemCost(cost,callback)
    Facade.SendNotification(NotifyName.ShopView.CheckCurrencyAvailable,8018,Resource.diamon,cost,function()
        if callback then
            callback()
        end
    end,function()
        self._fsm:GetCurState():FinishClick(self._fsm)
    end,nil,SHOP_TYPE.SHOP_TYPE_DIAMONDS,self)
end

function PowerUpViewMaster:on_btn_play_click()
    local falg,cost = ModelList.CityModel:CheckHaveNoEnoughCoin()
    if falg then
        Facade.SendNotification(NotifyName.ShopView.CheckCurrencyAvailable,8008,Resource.coin,cost,function()

        end,function()
            self._fsm:GetCurState():FinishClick(self._fsm)
         end,nil,SHOP_TYPE.SHOP_TYPE_CHIPS,nil)
        return 
    end 
    self._fsm:GetCurState():Play(self._fsm,2)
end

function PowerUpViewMaster:SendMsg2Server2EnterGame()
    local mode = ModelList.CityModel:GetEnterGameMode()
    if mode == PLAY_TYPE.PLAY_TYPE_NORMAL then
        local CmdEnterBattle = require "Logic.Command.Battle.Enter.CmdEnterBattle"
        local cmd = CmdEnterBattle.New()
        cmd:Execute()
    else
        ModelList.BattleModel:ReqEnterGame()
    end
end

function PowerUpViewMaster:OnPlay()
    local callBack = function()
        self:SendMsg2Server2EnterGame()
        Facade.SendNotification(NotifyName.CloseUI,self)
    end
    local cards = ModelList.CityModel:GetCardsCurrentPage(4)
    cards = #cards
    local jokeCards = ModelList.CityModel:GetJokeCardsCurrentPage(4)
    local animName = nil
    for i = 1, cards do
        card_entity_cache[i]:SetSortingOrder(100)
    end
    if 0 == cards and not isShowHint then
        --callBack()
        isShowHint = true
        Facade.SendNotification(NotifyName.ShowUI,ViewList.PowerUpHintView,nil)
        return
    elseif 3 == cards then
        animName = "powerup_cards_gather3"
    elseif 6 == cards then
        animName = "powerup_cards_gather6"
    elseif 9 == cards then
        animName = "powerup_cards_gather9"
        
    end

    if #jokeCards > 0 then 
        this.BoxAmi:Play("out")
        UISound.play("joker_boxout")
    end 

    if animName then
        AnimatorPlayHelper.Play(self.anima_cards,animName,false,function()
            -- AnimatorPlayHelper.Play(self.BoxAmi,"act",false,nil) 
           
            callBack()
        end)
    else
        callBack()
    end
end

function PowerUpViewMaster.BuyPowerUpCards_result()
    --_currency:SetDisable(false)
    this:ResetPowerIndecator()
    local cards = ModelList.CityModel:GetCardsMaxPage(4)
    local jokeCards = ModelList.CityModel:GetJokeCardsCurrentPage(4)
    local card_num = #cards
    local card_gear = nil
    -- if card_num == BuyPowerCardGenre.onegear * 3 then
    --     this._drawCard = function()
    --         local time = 0
    --         for i = 1, #card_entity_cache do
    --             card_entity_cache[i]:SetPowerCardData(cards[i])
    --             card_entity_cache[i]:DoDrawCardsAction(time,power1gear:GetGearCardPos(),PowerUpCardEntityView.PowerUpQuality.good,i,card_num)
    --             time = time + POWERUP_SHUFFLE_SPEED - 0.01 * (i - 1)
    --         end
    --     end
    --     this._fsm:GetCurState():DrawCard(this._fsm,3)
    --     power1gear:SetVisible(false)
    --     card_gear = BuyPowerCardGenre.onegear
    -- elseif card_num == BuyPowerCardGenre.twogear * 3 then
    --[[undo wait delete for test
    cards[1] = 801
    --]]
    if card_num == BuyPowerCardGenre.twogear * 3 then
        this._drawCard = function()
            local time = 0
            for i = 1, #card_entity_cache do
                card_entity_cache[i]:SetPowerCardData(cards[i])
                card_entity_cache[i]:DoDrawCardsAction(time,power1gear:GetGearCardPos(),PowerUpCardEntityView.PowerUpQuality.great,i,card_num)
                time = time + POWERUP_SHUFFLE_SPEED - 0.01 * (i - 1)
            end
        end
        this._fsm:GetCurState():DrawCard(this._fsm,6)
        power1gear:SetVisible(false)
        card_gear = BuyPowerCardGenre.onegear
        this.BoxAmi:Play("yes")
    elseif (card_num == BuyPowerCardGenre.threegear * 3 and #jokeCards ==0) then
        this._drawCard = function()
            local time = 0
            for i = 1, #card_entity_cache do
                card_entity_cache[i]:SetPowerCardData(cards[i])
                card_entity_cache[i]:DoDrawCardsAction(time,power2gear:GetGearCardPos(),PowerUpCardEntityView.PowerUpQuality.epic,i,card_num)
                time = time + POWERUP_SHUFFLE_SPEED - 0.01 * (i - 1)
            end
        end
        this._fsm:GetCurState():DrawCard(this._fsm,9)
        power2gear:SetVisible(false)
        card_gear = BuyPowerCardGenre.twogear
        this.BoxAmi:Play("yes")
    elseif  (card_num == BuyPowerCardGenre.threegear * 3 and  #jokeCards >0)  then
        this._drawCard = function()
            local time = 0
            for i = 1, #card_entity_cache do
                card_entity_cache[i]:SetPowerCardData(cards[i])
                card_entity_cache[i]:DoDrawCardsAction(time,power3gear:GetGearCardPos(),PowerUpCardEntityView.PowerUpQuality.joker,i,card_num)
                time = time + POWERUP_SHUFFLE_SPEED - 0.01 * (i - 1)
            end
            UISound.play("joker_boxin")
            
            local jokerCardShowKey = this:GetJokerCardShowKey(jokeCards)
            local animaName = string.format("act%s", jokerCardShowKey)
            this.BoxAmi:Play(animaName)
            this:ShowBoxCount(jokeCards, jokerCardShowKey)
        end
        this._fsm:GetCurState():DrawCard(this._fsm,9)
        power3gear:SetVisible(false)
        card_gear = BuyPowerCardGenre.threegear
    end

    --this.anim_title_shine:Play("powerup_title_shine02",0,1)
    AnimatorPlayHelper.Play(this.anim_title_shine,"powerup_title_shine02",true,nil)
    this.lightAnim:Play("act")
    power1gear:PlayCouponIdle()
    power2gear:PlayCouponIdle()
    power3gear:PlayCouponIdle()

    if buy_powerupcard_type ~= card_gear then
        log.r(string.format("=============================>>出错：powerup卡数和购买的档位不匹配,购买%s档获得%s档卡数！",buy_powerupcard_type,card_gear))
    end
end

function PowerUpViewMaster.OnDrawCardComplete()
    if this._fsm then
        this._fsm:GetCurState():OnDrawCardFinish(this._fsm)
    end
    -- if buy_powerupcard_type == BuyPowerCardGenre.onegear then
    --     power1gear:SetVisible(true)
  --  elseif buy_powerupcard_type == BuyPowerCardGenre.twogear then
    if buy_powerupcard_type == BuyPowerCardGenre.onegear then
        power1gear:SetVisible(true)
    elseif buy_powerupcard_type == BuyPowerCardGenre.twogear then
        power2gear:SetVisible(true)
       -- power3gear:SetVisible(true)
    elseif  buy_powerupcard_type == BuyPowerCardGenre.threegear then
        power3gear:SetVisible(true)
    end
end

function PowerUpViewMaster:PlayEpicShake()
    --self.btn_epic_anim:Play("show",0,0)
    power3gear:PlayShake()
end

function PowerUpViewMaster.OnHintGoback(flag)
    this._fsm:GetCurState():GoBackPowerUp(this._fsm)

    if flag then 
       local PuAdflag =  power1gear:GetPuAdState()
       if PuAdflag then 
        power1gear:on_btn_PuAd_click()
       end 
    end 
end

function PowerUpViewMaster.OnNoThansk()
    this._fsm:GetCurState():SendMsg2Server2EnterGame(this._fsm)
end

function PowerUpViewMaster.OnSuccessBuy(id)
    if this.puad_instance then 
        this.puad_instance:OnSuccessBuy(id)
    end 
end

function PowerUpViewMaster.OnRefreshCouponInfo(coupon)
    power1gear:CheckCoupon(true)
    power2gear:CheckCoupon(true)
    power3gear:CheckCoupon(true)
end

function PowerUpViewMaster.OnGroupPrefixRefresh()
    this:SetCostInfo()
end 

function PowerUpViewMaster:PlayJokeAmi()
    local citypalyid =  ModelList.CityModel.GetPlayIdByCity()
    local data =  ModelList.CityModel:GetPowerUpRange() 
    local count = data[citypalyid][4].joker_quantity == 0 and 3 or data[citypalyid][4].joker_quantity
    fun.set_active(self.jokeAmi,true)

    if count >4 then 
       self.jokeAmi:Play("PowerUp4_joke2")
    else 
       self.jokeAmi:Play("PowerUp4_joke")
    end 
end

---根据小丑卡数量播动画
---先读配置做表现，如果没有配置则按照后端返回的数据做表现
function PowerUpViewMaster:ShowJokerAnimation(jokeCards)
    local animaName
    local highLevelJokerCount, totalCount = Csv.GetPlayJokerCardsInfo()
    if highLevelJokerCount then
        --正常流程应该走到这里
        local normalJokerCardCount = totalCount - highLevelJokerCount
        animaName = string.format("act%s%s", normalJokerCardCount, highLevelJokerCount)
    else
        --异常情况做以下处理
        local jokerCardCount, str = GetTableLength(jokeCards)
        if jokerCardCount < 7 then
            str = 30
            if jokerCardCount == 4 then str = 40
            elseif jokerCardCount == 5 then str = 41
            elseif jokerCardCount == 6 then str = 42 end
            animaName = string.format("act%s", str)
        else
            str = 43
            local playType = ModelList.CityModel.GetCurPlayType()
            if playType ~= PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
                if jokerCardCount >= 7 then
                    local curCityId = ModelList.CityModel.GetHomeCity()
                    if curCityId == 6 then str = 34
                    elseif curCityId == 7 then str = 24 
                    elseif curCityId == 8 then str = 16 --新城市在这里添加小丑卡动画
                    end
                end
            end
            animaName = string.format("act%s", str)
        end
    end
    this.BoxAmi:Play(animaName)
end

---计算应该要展示的JokerCard动画和卡片的Key
function PowerUpViewMaster:GetJokerCardShowKey(jokeCards)
    local showKey
    
    local highLevelJokerCount, totalCount = Csv.GetPlayJokerCardsInfo()
    if highLevelJokerCount then
        --正常流程应该走到这里
        local normalJokerCardCount = totalCount - highLevelJokerCount
        showKey = string.format("%s%s", normalJokerCardCount, highLevelJokerCount)
    else
        --异常情况做以下处理
        local jokerCardCount = GetTableLength(jokeCards)
        if jokerCardCount < 7 then
            showKey = 30
            if jokerCardCount == 4 then showKey = 40
            elseif jokerCardCount == 5 then showKey = 41
            elseif jokerCardCount == 6 then showKey = 42 end
        else
            showKey = 43
            local playType = ModelList.CityModel.GetCurPlayType()
            if playType ~= PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
                if jokerCardCount >= 7 then
                    local curCityId = ModelList.CityModel.GetHomeCity()
                    if curCityId == 6 then showKey = 34
                    elseif curCityId == 7 then showKey = 25 
                    elseif curCityId == 8 then showKey = 16 --新城市在这里添加小丑卡动画
                    end
                end
            end
        end
        showKey = tostring(showKey)
    end
    return showKey
end

function PowerUpViewMaster:ShowBoxCount(jokeCards, jokerCardShowKey)
    jokerCardShowKey = jokerCardShowKey or self:GetJokerCardShowKey(jokeCards)
    local node = fun.find_child(self.BoxCount, jokerCardShowKey)
    if node then
        fun.set_active(node,true)
    end
end 

function PowerUpViewMaster:on_btn_buy_buff_click()
    log.log("PowerUpViewMaster:on_btn_buy_buff_click")
    if ModelList.CityModel:IsPuBuffSeasonValid() then
        log.log("PowerUpViewMaster:on_btn_buy_buff_click ShowPUPack")
        ModelList.GiftPackModel:ShowPUPack()
        self:RecordBuffReaminTimeSnapshoot()
    end
end

function PowerUpViewMaster:UpdatePuBuffState()
    if ModelList.CityModel:CanCurPlayUsePuBuff() and (ModelList.CityModel:IsPuBuffSeasonValid() or ModelList.CityModel:GetPuBuffRemainTime() > 0) then
        fun.set_active(self.PuBuffPanel, true)
        fun.set_active(self.Img_drawCards, false)
        if ModelList.CityModel:GetPuBuffRemainTime() > 0 then
            power1gear:ShowCardSpriteByIndex(1)
            power2gear:ShowCardSpriteByIndex(1)
            power3gear:ShowCardSpriteByIndex(1)
            self:SetBuffLeftTime(ModelList.CityModel:GetPuBuffRemainTime())
        else
            power1gear:ShowCardSpriteByIndex(0)
            power2gear:ShowCardSpriteByIndex(0)
            power3gear:ShowCardSpriteByIndex(0)
            self:ClearBuffLeftTime()
        end

        if ModelList.CityModel:IsPuBuffSeasonValid() then
            --fun.set_color_grey(self.img_add, false)
            Util.SetUIImageGray(self.img_add.gameObject, false)
            if ModelList.CityModel:GetPuBuffRemainTime() <= 0 then
                --undo 动画突出+号
            end
        else
            --fun.set_color_grey(self.img_add, true)
            Util.SetUIImageGray(self.img_add.gameObject, true)
        end

        self:SetBuffSeasonLeftTime(ModelList.CityModel:GetPuBuffSeasonRemainTime())
        self:UpdatePuBuffCardIcon()
    else
        fun.set_active(self.PuBuffPanel, false)
        fun.set_active(self.Img_drawCards, true)
        power1gear:ShowCardSpriteByIndex(0)
        power2gear:ShowCardSpriteByIndex(0)
        power3gear:ShowCardSpriteByIndex(0)
        self:ClearBuffLeftTime()
    end

    fun.set_active(self.img_point, ModelList.GiftPackModel:CheckPUHaveFreePack())
end

function PowerUpViewMaster:ClearBuffLeftTime()
    self.buffRemainTime = 0
    self.text_buff.text = "00:00"
    self:PlayAddBtnAnim()
end

function PowerUpViewMaster:SetBuffLeftTime(remainTime)
    self.buffRemainTime = remainTime
    if self.buffRemainTime > 0 then
        if not self.buffRemainTimeCountDown then
            self.buffRemainTimeCountDown = RemainTimeCountDown:New()
        end
        self.buffRemainTimeCountDown:StartCountDown(CountDownType.cdt2, self.buffRemainTime, self.text_buff, 
        function()
            --时间到
            self:OnBuffTimeOver()
        end,
        function()
            self.buffRemainTime = self.buffRemainTime - 1
        end)
        self:StopAddBtnAnim()
    end
end

function PowerUpViewMaster:ClearBuffCountDown()
    if self.buffRemainTimeCountDown then
        self.buffRemainTimeCountDown:StopCountDown()
        self.buffRemainTimeCountDown = nil
    end
end

function PowerUpViewMaster:OnBuffTimeOver()
    self:UpdatePuBuffState()
    self:PlayGearDownAnima()
end

function PowerUpViewMaster:OnBuffTimeAdd()
    self:UpdatePuBuffState()
    if self.buffReaminTimeSnapshoot and self.buffReaminTimeSnapshoot <= 0 then
        if self.buffRemainTime and self.buffRemainTime > 0 then
            self:PlayGearUpAnima()
        else
        end
    end
end

function PowerUpViewMaster:SetBuffSeasonLeftTime(remainTime)
    self.buffSeasonRemainTime = remainTime
    if self.buffSeasonRemainTime > 0 then
        self:ClearBuffSeasonCountDown()
        self.buffSeasonRemainTimeCountDown = LuaTimer:SetDelayLoopFunction(0, 1, -1, function()
            self.buffSeasonRemainTime = self.buffSeasonRemainTime - 1
            if self.buffSeasonRemainTime <= 0 then
                self:OnBuffSeasonTimeOver()
            end
        end, nil, nil, LuaTimer.TimerType.UI)
    end
end

function PowerUpViewMaster:ClearBuffSeasonCountDown()
    if self.buffSeasonRemainTimeCountDown then
        LuaTimer:Remove(self.buffSeasonRemainTimeCountDown)
        self.buffSeasonRemainTimeCountDown = nil
    end
end

function PowerUpViewMaster:OnBuffSeasonTimeOver()
    self:ClearBuffSeasonCountDown()
    self:UpdatePuBuffState()
end

function PowerUpViewMaster:PlayGearDownAnima()
    fun.set_active(self.effect_out1, false)
    fun.set_active(self.effect_out2, false)
    fun.set_active(self.effect_out3, false)
    fun.set_active(self.effect_out1, true)
    fun.set_active(self.effect_out2, true)
    fun.set_active(self.effect_out3, true)
    fun.set_active(self.Effect_out, false)
    fun.set_active(self.Effect_out, true)
end

function PowerUpViewMaster:PlayGearUpAnima()
    fun.set_active(self.effect_enter1, false)
    fun.set_active(self.effect_enter2, false)
    fun.set_active(self.effect_enter3, false)
    fun.set_active(self.effect_enter1, true)
    fun.set_active(self.effect_enter2, true)
    fun.set_active(self.effect_enter3, true)
end

function PowerUpViewMaster:PlayAddBtnAnim()
    fun.play_animator(self.img_add, "act", true)
end

function PowerUpViewMaster:StopAddBtnAnim()
    fun.play_animator(self.img_add, "idle", true)
end

function PowerUpViewMaster.OnPowerUpBuffGifttPackClose(params)
    log.log("PowerUpViewMaster.OnPowerUpBuffGifttPackClose(params)", params)
    if params and params.isBuySucc then
        this:UpdatePuBuffState()
    end
    this.buffReaminTimeSnapshoot = nil
end

function PowerUpViewMaster:RecordBuffReaminTimeSnapshoot()
    log.log("PowerUpViewMaster:RecordBuffReaminTimeSnapshoot", self.buffRemainTime)
    self.buffReaminTimeSnapshoot = self.buffRemainTime
end

function PowerUpViewMaster:SetFromAdventureFlag()
    self.fromAdventureFlag = true
end

function PowerUpViewMaster:ClearFromAdventureFlag()
    self.fromAdventureFlag = nil
end

function PowerUpViewMaster:TryPopupPuBuffPackView()
    if not ModelList.CityModel:CanCurPlayUsePuBuff() then
        log.log("PowerUpViewMaster:TryPopupPuBuffPackView fail (此玩法不可使用此buff)")
        return false
    end

    if not ModelList.CityModel:IsPuBuffSeasonValid() then
        log.log("PowerUpViewMaster:TryPopupPuBuffPackView fail (赛季不可用)")
        return false
    end

    if self.fromAdventureFlag then
        log.log("PowerUpViewMaster:TryPopupPuBuffPackView fail (from adventrue)")
        return false
    end

    if ModelList.CityModel:GetPuBuffRemainTime() <= 0 then
        ModelList.CityModel:SetPuBuffStateRecord(false)
        if ModelList.CityModel:GetIsNeepPopupBuffPurchaseTipState() then
            log.log("PowerUpViewMaster:TryPopupPuBuffPackView succ 打开提示")
            Facade.SendNotification(NotifyName.ShowUI, ViewList.SeasonPowerUpChargeTipView)
            self:RecordBuffReaminTimeSnapshoot()
            ModelList.CityModel:RecordIsNeepPopupBuffPurchaseTipState(false)
            return true
        else
            log.log("PowerUpViewMaster:TryPopupPuBuffPackView 已经弹过Tip, 尝试直接打开礼包")
            ModelList.GiftPackModel:IsUnPopUpPuPack(false, false, false)
            self:RecordBuffReaminTimeSnapshoot()
            return true
        end
    else
        log.log("PowerUpViewMaster:TryPopupPuBuffPackView succ 直接打开")
        ModelList.GiftPackModel:IsUnPopUpPuPack(false, false, false)
        self:RecordBuffReaminTimeSnapshoot()
        return true
    end
end

function PowerUpViewMaster:UpdatePuBuffCardIcon()
    local cardId = ModelList.CityModel:GetPuBuffCardId()
    local powerCard = Csv.GetData("powerup_card", cardId)
    log.log("PowerUpViewMaster:UpdatePuBuffCardIcon cardId ", cardId)
    if powerCard and fun.is_not_null(self.img_icon)then
        self.img_icon.sprite = AtlasManager:GetSpriteByName("ItemAtlas", powerCard.icon)
    end
end

function PowerUpViewMaster:UpdateSmallGameState()
    if ModelList.SmallGameModel:CanOpenGameForBet() then
        fun.set_active(self.Img_play1, false)
        fun.set_active(self.Img_play2, true)
        self:UpdateSmallGameIcon(self.Img_smallGameIcon)
        self:StartSmallGameCountDown()
        local anima = fun.get_component(self.Img_play2, fun.ANIMATOR)
        if fun.is_not_null(anima) then
            AnimatorPlayHelper.Play(anima, {"Img_play2", "Img_play2"}, false, function()
                ModelList.GuideModel:TriggerSuperMatchPuGuide()
                UISound.play("supermatchpuactivate")
            end)
        end
    else
        fun.set_active(self.Img_play1, true)
        fun.set_active(self.Img_play2, false)
    end
end


function PowerUpViewMaster:UpdateExtraRewardState()
    local playId = ModelList.CityModel.GetPlayIdByCity()
    local curModel = ModelList.BattleModel.GetModelByPlayID(playId)
    if curModel.IsTriggerExtraReward then
        if curModel:IsTriggerExtraReward() then
            fun.set_active(self.Img_play1, false)
            fun.set_active(self.Img_play3, true)
            self:UpdateSmallGameIcon(self.Img_extraRewardIcon)
        else
            fun.set_active(self.Img_play1, true)
            fun.set_active(self.Img_play3, false)
        end
        if not self.isExtraRewardTipInit then
            self.Img_extraRewardIcon.sprite = curModel:GetExtraRewardTipIconSprite()
            self.isExtraRewardTipInit = true
        end
    else
        --fun.set_active(self.Img_play1, true)
        fun.set_active(self.Img_play3, false)
    end
end

function PowerUpViewMaster:StartSmallGameCountDown()
    self.smallGameRemainTime = ModelList.SmallGameModel:GetActivityRemainTime()
    if self.smallGameRemainTime > 0 then
        self:ClearSmallGameCountDown()
        self.smallGameRemainTimeCountDown = LuaTimer:SetDelayLoopFunction(0, 1, -1, function()
            self.smallGameRemainTime = self.smallGameRemainTime - 1
            if self.smallGameRemainTime <= 0 then
                self:OnSuperMatchTimeOver()
            end
        end, nil, nil, LuaTimer.TimerType.UI)
    end
end

function PowerUpViewMaster:OnSuperMatchTimeOver()
    self:ClearSmallGameCountDown()
    self:UpdateSmallGameState()
end

function PowerUpViewMaster:ClearSmallGameCountDown()
    if self.smallGameRemainTimeCountDown then
        LuaTimer:Remove(self.smallGameRemainTimeCountDown)
        self.smallGameRemainTimeCountDown = nil
    end
end

---根据当前小游戏类型更新icon
function PowerUpViewMaster:UpdateSmallGameIcon(img)
    local iconInfo = ModelList.SmallGameModel.GetCurrentGameIconInfo()
    if img and img.sprite then
        if not fun.starts(img.sprite.name ,iconInfo) then
            Cache.load_texture_to_sprite(iconInfo, img)
        end
    end
end

this.NotifyList = {
    {notifyName = NotifyName.Grocery.GroceryBuySuccess,func = this.OnSuccessBuy},
    {notifyName = NotifyName.PowerUps.PowerUpGearClick,func = this.OnPowerUpGearClick},
    {notifyName = NotifyName.PowerUps.FetchPowerUp_Result,func = this.OnFetchPowerUp_Result},
    {notifyName = NotifyName.PowerUps.Buy_PowerUp_Result,func = this.BuyPowerUpCards_result},
    {notifyName = NotifyName.PowerUps.DoTweenPowerIndecator,func = this.OnDoTweenPowerIndecator},
    {notifyName = NotifyName.PowerUps.DrawCardComplete, func = this.OnDrawCardComplete},
    {notifyName = NotifyName.PowerUps.Powerup_hint_goback, func = this.OnHintGoback},
    {notifyName = NotifyName.PowerUps.Powerup_hint_nothansk, func = this.OnNoThansk},
    {notifyName = NotifyName.HallMainView.RefreshCouponInfo, func = this.OnRefreshCouponInfo},
    {notifyName = NotifyName.PlayerInfo.RefreshGroupPrefix, func = this.OnGroupPrefixRefresh},
    {notifyName = NotifyName.PowerUps.Powerup_close, func = this.OnClosePu},
    {notifyName = NotifyName.PowerUps.PowerUpBuffGifttPackClose, func = this.OnPowerUpBuffGifttPackClose},
}

return this
