---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/7/14 10:50
---
---@class BaseChildView
BaseChildView = Clazz()
local this = BaseChildView;
--this.__index = this
--this.isInit = false
--self.parentView = nil
--BaseChildView.__index = BaseChildView
this.luabehaviour = nil --LuaBehaviour c#代码，详细查看其

function BaseChildView:New()
    local o = {}
    setmetatable(o, self)
    self.__index = self
    o._dispose = false
    return o
end

function BaseChildView:GetGameObject()

end

function BaseChildView:Dispose()
    self._dispose = nil
    if self.OnDispose then
        self:OnDispose()
    end
end

function BaseChildView:OnDispose()

end


function BaseChildView:Awake(g)
    --子类重载
end

function BaseChildView:Start()
    --子类重载
end

function BaseChildView:OnEnable(params)
    --子类重载
end

function BaseChildView:OnDisable()
    --子类重载
end

function BaseChildView:OnClick()
    --子类重载
end

function BaseChildView:OnDestroy()
    --子类重载
    self:Close()
end


function BaseChildView:OnEnable_before()
    --子类重载
end

function BaseChildView:OnEnable_late()
    --子类重载
end

function BaseChildView:OnDisable_late()
    --子类重载
end

function BaseChildView:OnDestroy_late()

end

function BaseChildView:IsDispose()
    return self._dispose == nil
end

function BaseChildView:on_init(obj, parentView)
    self.parentView = parentView
    if(self.isInit ~= nil and self.isInit ) then return false end
    self.isInit = true
    self.go = obj.gameObject
    self.luabehaviour = nil
    --self.luabehaviour = fun.get_component(self.go, fun.LUABEHAVIOUR)
    --if self.luabehaviour == nil then
    --    self.luabehaviour = fun.add_component(self.go, fun.LUABEHAVIOUR)
    --end
    self.luabehaviour = Util.AddLuaBehaviour(self.go,function (t,g)
        self:OnLuaBehaviour(t,g)
    end)
    self:auto_find_ui_item()
    --self:on_init_dev_ui()
    --self:start_x_update()
    if self.on_after_bind_ref then
        self:on_after_bind_ref(self.args)
    end
    --CanvasSortingOrderManager.SetLayerOrder(self.viewType,self.go)
    --self:LoadCallback()
    return true
    --else
    --return false
    --end
end


function BaseChildView:OnLuaBehaviour(t,g)
    if t == 0 then
        self:Awake(g)
    elseif t == 1 then
        self:Start()
    elseif t == 2 then
        self:OnEnable_before()
        self:OnEnable(self._enableParams)
        self:OnEnable_late()
        self._enableParams = nil
    elseif t == 3 then
        self:OnDisable()
        self:OnDisable_late()
    elseif t == 4 then
        self:OnClick(g)
    elseif t == 5 then
        self:OnDestroy()
        self:OnDestroy_late()
    end
end

function BaseChildView:auto_find_ui_item()
    if self.auto_bind_ui_items then
        self:auto_bind_child_by_ref(self.go, self.auto_bind_ui_items)
    else
        log.r("跳过绑定", self.panel_name)
    end
end

function BaseChildView:auto_bind_child_by_ref(go, auto_bind_ui_items)
    local ref = fun.get_component(go.transform, fun.REFER)
    if ref then
        for i, v in ipairs(auto_bind_ui_items) do
            self[v] = ref:Get(v)
            if self[v] == nil then
                --log.log("[auto_bind 提示]", go.name, "下未找到节点", v)
            else
                if StringUtil.start_with(v, "btn_") then
                    --print("================================>> " .. v)
                    self:bind_click(v, "on_" .. v .. "_click")
                end
            end
        end
    else 
        log.r(go.name .. " 未绑定控件")
    end
end

function BaseChildView:bind_click(button_name, callback_name)
    log.y("button_name: ", button_name, self.viewName)
    self.btn_click_bind_map = self.btn_click_bind_map or {}
    if type(callback_name) == "function" then
        if self.btn_click_bind_map[button_name] then
            log.r({
                err = "按钮事件重复绑定",
                button_name = button_name,
                panel_name = self.panel_name,
            })
        end
        self.btn_click_bind_map[button_name] = callback_name

        self.luabehaviour:AddClick(self[button_name].gameObject, function()
            --UISound.play("button_click")
            callback_name(self)
        end)
    else
        if self.btn_click_bind_map[button_name] then
            log.r({
                err = "按钮事件重复绑定",
                button_name = button_name,
                panel_name = self.viewName,
                callback_name = callback_name,
            })
        end
        self.btn_click_bind_map[button_name] = callback_name

        if (self[button_name]) then
            self.luabehaviour:AddClick(self[button_name].gameObject, function()
                if self[callback_name] then
                    if UISound then
                        --UISound.play("button_click")
                    end
                    log.r("btnaaaaaa", button_name)
                    self[callback_name](self)
                else
                    log.r({
                        err = "按钮回调方法不存在",
                        button_name = button_name,
                        panel_name = self.viewName,
                        callback_name = callback_name,
                    })
                end
            end)
        else
            log.r("没有找到btn" .. button_name)
        end
    end
end

function BaseChildView:GetParentView()
    return self.parentView
end


--销毁View对象
function BaseChildView:Close()
    if not self.isInit then
        return
    end
    self.isInit = false
    self.isShow = false;

    if(self.on_close)then
        self:on_close()
    end


    CanvasSortingOrderManager.RecycleLayerOrder(self.viewType,self.go)
    --self:_close()
    self.isLoaded = false;

end

--释放View对象
function BaseChildView:Destroy()
    if self.auto_bind_ui_items then
        self:auto_unbind_child_by_ref(self.auto_bind_ui_items)
    end
    self.go = nil
    self.isInit = nil
end

function BaseChildView:auto_unbind_child_by_ref(auto_bind_ui_items)
    for i,v in ipairs(auto_bind_ui_items) do
        if self[v] ~= nil then
            if StringUtil.start_with(v,"btn_") and fun.is_not_null(self[v]) then
                self.luabehaviour:RemoveClick(self[v].gameObject)
            end
        end
        self[v] = nil
        if(self.btn_click_bind_map)then
            self.btn_click_bind_map[v] = nil
        end
    end
end



function BaseChildView:SkipLoadShow(obj,activeGo,parentView,callback,params)
    if callback ~= nil then
        self._showViewCallback = callback;
    end
     self._enableParams = params
    local isActive = true
    if activeGo == false then
        isActive = false
    end
    --- View/AWrap/UI/BaseView:356: attempt to index field 'go' (a nil value)  收集的报错
    if fun.is_null(obj) then
        log.r("SkipLoadShow obj is null")
        return
    end
    if(self.go == nil or self.go ~= obj)then
        --log.r("SkipLoadShow self.go == nil or self.go ~= obj")
        self.go = obj
        self.transform = self.go.transform
        self.luabehaviour = Util.AddLuaBehaviour(self.go,function (t,g)
            self:OnLuaBehaviour(t,g)
        end)
        self:on_init(obj,parentView)
    else
        --log.r("SkipLoadShow self.go ~= obj")
        if self.on_after_bind_ref then
            self:on_after_bind_ref(self._showViewCallback)
        end
        self:LoadCallback()
    end
    self.isLoaded = true;
    self.isShow = isActive;
    fun.set_active(self.go,isActive)
end
