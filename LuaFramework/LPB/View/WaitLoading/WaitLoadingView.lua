---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by ruangs.
--- DateTime: 2020/8/4 14:17
---
---
WaitLoadingView = BaseDialogView:New('WaitLoadingView')
local this = WaitLoadingView
this.viewType = CanvasSortingOrderManager.LayerType.Tips
this.is_show_loading = false
this.showTime = 0
this.auto_bind_ui_items = {
    "circle",
    "actionPart",
    "bg",
    "ani"
}

this.wait_list = {}

function WaitLoadingView:Awake(obj)
    Facade.RegisterView(this)   --需要Notifi调用时候，才加上
    this:on_init()
    this:SaveToCache()
end

function WaitLoadingView.SetWaitLoadingState(req_name, need_show_circle)
    log.log("调整目标bz",req_name)
    log.log("调整目标cz",need_show_circle)
    -- this:AddTarget(req_name,need_show_circle)
end

function WaitLoadingView.SetWaitLoadingStateShow(req_name, need_show_circle)
    log.log("调整目标b",req_name)
    log.log("调整目标c",need_show_circle)
    this:AddTarget(req_name,need_show_circle)
end


function WaitLoadingView.SetWaitLoadingStateClose(req_name)
    log.log("调整目标cc",req_name)
    this:RemoveTarget(req_name) 
end

function WaitLoadingView:on_close()
    this:CleanHideTime()
    this:DestoryData()
    this.is_show_loading = false
end

function WaitLoadingView:OnDestroy()
    this:Close();
end

function WaitLoadingView:DestoryData()
    this.wait_list = {}
end

--初始化视图
function WaitLoadingView:InitView()
   
end

function WaitLoadingView:AddTarget(req_name,need_show_circle)
    log.log("调整目标X", req_name)
    this.wait_list = this.wait_list or {}
    this.wait_list[req_name] = {show_circle = need_show_circle} 
    local state = this:IsShowCircle()
    this:ToCircle(state)
end

function WaitLoadingView:RemoveTarget(req_name)
    log.log("lxq_loading_消息控制删除前A", req_name,this.wait_list)
    if not this.wait_list[req_name] then
        log.log("lxq_loading_没有等待列表")
        return
    end
    
    this.wait_list[req_name] = nil
    local state, count = this:IsShowCircle() 
    log.log("lxq_loading_消息控制删除BX",state,count, this.wait_list)
    if count <= 0 then
        this:CloseSelf()
    else
        this:ToCircle(state)
    end

end

function WaitLoadingView:IsShowCircle()
    local count = 0
    local result = false
    for k , v in pairs(this.wait_list) do
        count = count + 1
        if not result then
            if v.show_circle then
                result = true
            end
        else
            break
        end
    end
    return result, count
end

function WaitLoadingView:Hide()
    fun.print_timestamp("lxq_wait_hide")
    log.r("lxq_wait_WaitLoadingView:Hide()")
    if( this.ani)then
        this.ani:Play("hide")
    end
    this.is_show_loading = false
    this.showTime = 0
    this.delayHide = nil
end

function WaitLoadingView:CleanHideTime()
    if(this.delayHide)then
        -- LuaTimer:Remove(this.delayHide)
        this.delayHide:Stop()
        this.delayHide = nil
    end 
end

function WaitLoadingView:SaveToCache()
    local cacheObj = UnityEngine.GameObject.Find("UICache")
    this.go.transform:SetParent(cacheObj.transform)
    this.go.transform.localScale = Vector3.New(1,1,1)
    this.go.transform.localPosition = Vector3.New(0,0,0)
    SceneViewManager.AddToCache(this.go)
end


function WaitLoadingView:CloseSelf(hide_callback,param)
 
    Invoke(function() 
        if(this.is_show_loading)then
            this.is_show_loading = false
            this.showTime = 0
            this.delayHide = nil
            if(this.go)then
                this:Hide()
                this:SaveToCache()
            end 
        end
    end,0.1)


    -- Facade.SendNotification(NotifyName.CloseUI, this) 
end

function WaitLoadingView:ToCircle(state,param,hide_callback)
    
    log.log("lxq_loading_消息控制转圈", this.is_show_loading, state)
    local func_hide = function()
        this:CloseSelf(hide_callback,param)
    end

    if this.is_show_loading then
        if not state then
            func_hide()
        end
    else
        if state then 
            log.r("lxq_wait_show")
            fun.print_timestamp("lxq_wait_show")
            this.is_show_loading  = true
            if(this.showTime == 0)then
                this.showTime = Util.NowMillisecond()
            end 

            if  SceneViewManager.page_layer == nil then
                SceneViewManager.page_layer = UnityEngine.GameObject.FindWithTag("NormalUiRoot")
            end
            local parent =  SceneViewManager.page_layer
            if(parent and parent.transform)then
                this.go.transform:SetParent(parent.transform)
            end

            this.go.transform.localScale = Vector3.New(1,1,1)
            this.go.transform.localPosition = Vector3.New(0,0,0)
            local rect = fun.get_component(this.go,fun.RECT)
            if rect then
                rect.offsetMin = Vector2.New(0, 0)
                rect.offsetMax = Vector2.New(0, 0)
            end
            this.ani:Play("show")
        else
            func_hide()
        end
    end
end


this.NotifyList =
{
    {notifyName = NotifyName.SetWaitLoadingState, func = this.SetWaitLoadingState},
    {notifyName = NotifyName.SetWaitLoadingStateClose, func = this.SetWaitLoadingStateClose},
    {notifyName = NotifyName.SetWaitLoadingStateShow, func = this.SetWaitLoadingStateShow},
    
}


return this
