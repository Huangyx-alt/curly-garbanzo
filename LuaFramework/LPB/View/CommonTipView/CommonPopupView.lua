---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/10/19 17:36
---

local CommonPopupView = BaseDialogView:New('CommonPopupView',"BingoBangPopupAtlas")
local this = CommonPopupView
this.viewType = CanvasSortingOrderManager.LayerType.Popup_Dialog

this.auto_bind_ui_items = {
    "btn_sure",
    "btn_cancle",
    "content",
    "title",
    "btn_close"
}

--直接设置文本
function CommonPopupView:SetInfoWithOptions(go, options)
    self.options = options or {}
    self.options.isShowText = true
    
    self._go = go
    self.sure_cb = options.sureCb
    self.cancel_cb = options.cancelCb

    local titleSprite = "TYTips"
    if self.options.tipType then
        if self.options.tipType == "2" then titleSprite = "TYAYS"
        elseif self.options.tipType == "3" then titleSprite = "TYERROR" end
    end
    self.title.sprite = AtlasManager:GetSpriteByName("BingoBangPopupAtlas", titleSprite)
    self.title:SetNativeSize()
    
    self.content.text = options.contentText
    
    self:SetBtnType(options.okType)
    self:SetPopupType(options.okType)
end

--params @oktype  0:普通双按钮  1: 普通单按钮    2: 错误双按钮  3: 错误单按钮
function CommonPopupView:SetInfo(go, content, oktype, sure_cb, cancel_cb, params)
    if content == nil or oktype == nil then
        return
    end
    self._go = go
    self._content = content
    self._oktype = oktype
    self.sure_cb = sure_cb
    self.cancel_cb = cancel_cb
    self._params = params
    local tip_type = Csv.GetData("description", content, "params") or "1"
    local content = Csv.GetData("description", content, "description")
    if tip_type == "2" then self.title.sprite = AtlasManager:GetSpriteByName("BingoBangPopupAtlas", "TYAYS")
    elseif tip_type == "3" then self.title.sprite = AtlasManager:GetSpriteByName("BingoBangPopupAtlas", "TYERROR")
    else self.title.sprite = AtlasManager:GetSpriteByName("BingoBangPopupAtlas", "TYTips")  end
    self.title:SetNativeSize()
    if params and #params > 0 and string.find(content,"%%s") then
        content = string.format(content, unpack(params))
    end
    self.content.text = content
    self:SetBtnType(oktype)
    self:SetPopupType(oktype)
    --
    --if not self._isinit then
    --    self._go = go
    --    self._content = content
    --    self._oktype = oktype
    --    self.sure_cb = sure_cb
    --    self.cancel_cb = cancel_cb
    --    self._params = params
    --else
    --    local tip_type = Csv.GetData("description", content, "params") or "1"
    --    local content = Csv.GetData("description", content, "description")
    --    if tip_type == "2" then self.title.sprite = AtlasManager:GetSpriteByName("BingoBangPopupAtlas", "TYAYS")
    --    elseif tip_type == "3" then self.title.sprite = AtlasManager:GetSpriteByName("BingoBangPopupAtlas", "TYERROR")
    --    else self.title.sprite = AtlasManager:GetSpriteByName("BingoBangPopupAtlas", "TYTips")  end
    --    self.title:SetNativeSize()
    --    if params and #params > 0 then  content = string.format(content, unpack(params))   end
    --    self.content.text = content
    --    self:SetBtnType(oktype)
    --    self:SetPopupType(oktype)
    --    self.sure_cb = sure_cb
    --    self.cancel_cb = cancel_cb
    --end
end

function CommonPopupView:SetBtnType(oktype)
    if oktype == 1  or oktype == 3   or  oktype == 5 then
        fun.set_active(self.btn_cancle, false)
        local pos = fun.get_gameobject_pos(self.btn_sure, true)
        fun.set_gameobject_pos(self.btn_sure, 0, pos.y, pos.z, true)
    end
end

function CommonPopupView:SetPopupType(oktype)
    if oktype == 2  or oktype == 3  then
       self:SetErrorPopup()
    elseif oktype == 4  or oktype == 5  then
        self:SetGlobalPopup()
    end
end

function CommonPopupView:SetErrorPopup()
    CanvasSortingOrderManager.SetLayerOrder(CanvasSortingOrderManager.LayerType.ErrorDialog,self.go)
end

function CommonPopupView:SetGlobalPopup()
    if  SceneViewManager.gobal_layer == nil then
        SceneViewManager.gobal_layer = UnityEngine.GameObject.FindWithTag("GlobalUiRoot")
    end
    local parent =   SceneViewManager.gobal_layer
    self.go.transform:SetParent(parent.transform)
    self.go.transform.localScale = Vector3.New(1,1,1)
    self.go.transform.localPosition = Vector3.New(0,0,0)
    local rect = fun.get_component(go,fun.RECT)
    if rect then
        rect.offsetMin = Vector2.New(0, 0)
        rect.offsetMax = Vector2.New(0, 0)
    end
end


function CommonPopupView:Awake(obj)
    self:on_init()
end

function CommonPopupView:OnEnable()
    --Facade.RegisterView(this)

    --this.update_x_enabled = true
    --this:start_x_update()
    --fun.set_child_layer(this.title.transform.parent.parent,"FakeUI")

    self._isinit = true
    if self.options and self.options.isShowText then
        self:SetInfoWithOptions(self._go, self.options)
    else
        self:SetInfo(self._go, self._content, self._oktype, self.sure_cb, self.cancel_cb, self._params)
    end

    Event.Brocast(Notes.CARD_COLLIDER_OPEN,false)
end

function CommonPopupView:on_x_update()
    --this:CheckInputClick()
end


function CommonPopupView:OnDisable()
    --Facade.RemoveView(this)
    --this:stop_x_update()
    ModelList.PopupModel:RemovePopupView(self)
    self._isinit = nil
    self._go = nil
    self._content = nil
    self._oktype = nil
    self.sure_cb = nil
    self.cancel_cb = nil
    self._params = nil

    Event.Brocast(Notes.CARD_COLLIDER_OPEN,true)

end


function CommonPopupView:OnDestroy()
    self:Destroy()
    AssetManager.unload_ab({AssetList.CommonPopupView})
end

function CommonPopupView:on_close()
    self:stop_x_update()
    Event.Brocast(Notes.CARD_COLLIDER_OPEN,true)
end

function CommonPopupView:CloseFunc()
    --this.main_effect:Play("end")
    Facade.SendNotification(NotifyName.HideDialog, self)

end


function CommonPopupView:ShowTip(tipName)

end

function CommonPopupView:InitTip()

end

function CommonPopupView:CutDonwTarget()
    self:CloseFunc()
    self.main_effect:Play("end")
end

local last_click_time = 0
function CommonPopupView:on_btn_sure_click()
    --if UnityEngine.Time.time - last_click_time >0.5 then
    if self.go then log.r(self.go.name) end
    --print(self)
        if self.sure_cb then
            self.sure_cb()
        end
        Facade.SendNotification(NotifyName.HideDialog, self)
        last_click_time = UnityEngine.Time.time
    --end
end

function CommonPopupView:on_btn_cancle_click()

    --if UnityEngine.Time.time - last_click_time >0.5 then
        if self.cancel_cb then    self.cancel_cb()  end
        Facade.SendNotification(NotifyName.HideDialog, self)
    --GameObject.Destroy(self.go)
        last_click_time = UnityEngine.Time.time
    --end
end


function CommonPopupView:on_btn_close_click()
    if self.cancel_cb then    self.cancel_cb()  end
    Facade.SendNotification(NotifyName.HideDialog, self)
end

function CommonPopupView:NewPop(view_type)
    --如果o为false或者o为nil，则让o为{}
    local o = {viewName ="CommonPopupView",atlasName = "BingoBangPopupAtlas", viewType = view_type}
    setmetatable(o,self)
    self.__index = self
    return o
end

function CommonPopupView:New()
    local o = {viewName ="CommonPopupView",atlasName = "BingoBangPopupAtlas",isShow = false, isLoaded = false}
    setmetatable(o, self);
    self.__index = self
    return o
end

return this





