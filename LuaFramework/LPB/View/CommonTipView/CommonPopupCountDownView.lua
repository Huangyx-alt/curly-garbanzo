---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/10/19 17:36
---

local CommonPopupCountDownView = BaseDialogView:New('CommonPopupCountDownView',"BingoBangPopupAtlas")
local this = CommonPopupCountDownView
this.viewType = CanvasSortingOrderManager.LayerType.Popup_Dialog

local this = CommonPopupCountDownView;
this.auto_bind_ui_items = {
    "btn_sure",
    "btn_cancle",
    "content",
    "title",
    "btn_close"
}

--params @oktype  0:普通双按钮  1: 普通单按钮    2: 错误双按钮  3: 错误单按钮
function CommonPopupCountDownView:SetInfo(go, content, oktype, sure_cb, cancel_cb, _remainTime , params)
    if content == nil or oktype == nil then
        return
    end
    self._go = go
    self._content = content
    self._oktype = oktype
    self.sure_cb = sure_cb
    self.cancel_cb = cancel_cb
    self._params = params
    self._remainTime = _remainTime or 0
    local tip_type = Csv.GetData("description", content, "params") or "1"
    self.contentString = Csv.GetData("description", content, "description")

    if tip_type == "2" then self.title.sprite = AtlasManager:GetSpriteByName("BingoBangPopupAtlas", "TYAYS")
    elseif tip_type == "3" then self.title.sprite = AtlasManager:GetSpriteByName("BingoBangPopupAtlas", "TYERROR")
    else self.title.sprite = AtlasManager:GetSpriteByName("BingoBangPopupAtlas", "TYTips")  end
    self.title:SetNativeSize()
    if params and #params > 0 and string.find(content,"%%s") then
        content = string.format(content, unpack(params))
    end
    self:OnTimerCall_Cdt2(false)
    self:SetBtnType(oktype)
    self:SetPopupType(oktype)
    self.sure_cb = sure_cb
    self:StartCountDown()
end

function CommonPopupCountDownView:StopTimer()
    if self._timer then
        self._timer:Stop()
        self._timer = nil
    end
end

function CommonPopupCountDownView:StartCountDown()
    self:StopTimer()
    self._timer = Timer.New(function()
        self.OnTimerCall_Cdt2(self,true)
    end,1,-1) 
    self._timer:Start()
end

function CommonPopupCountDownView:OnTimerCall_Cdt2(sub)
    if self._remainTime and self._remainTime > 0 and self.contentString then
        local timeString = self:GetRemainTimeFormat2(sub)
        self.content.text = string.format(self.contentString,timeString)
    else
        self:StopTimerAndCheckCallBack()
    end
end


function CommonPopupCountDownView:GetRemainTimeFormat2(sub)
    if self._remainTime and self._remainTime > 0 then
        if sub then
            self._remainTime = math.max(0,self._remainTime - 1)
        end

        local t = math.floor(self._remainTime/60/60/24/30)
        if t > 0 then
            return string.format("%smonth",t)
        else
            t = self._remainTime/60/60/24
            if t > 1 then
                local t2 = math.floor(self._remainTime/60/60%24)
                return string.format("%sd:%sh",math.floor(t),t2)
            else
                t = math.floor(self._remainTime/60/60)
                if t > 0 then
                    local t2 = math.floor(self._remainTime/60%60)
                    return string.format("%sh:%sm",t,t2)
                else
                    return string.format("%02d:%02d",math.floor(self._remainTime/60),math.floor(self._remainTime%60))
                end   
            end
        end
    else
        self:StopTimerAndCheckCallBack()
    end
end

function CommonPopupCountDownView:StopTimerAndCheckCallBack()
    self:StopTimer()
    self:on_btn_close_click()
end

function CommonPopupCountDownView:SetBtnType(oktype)
    if oktype == 1  or oktype == 3   or  oktype == 5 then
        fun.set_active(self.btn_cancle, false)
        local pos = fun.get_gameobject_pos(self.btn_sure, true)
        fun.set_gameobject_pos(self.btn_sure, 0, pos.y, pos.z, true)
    end
end

function CommonPopupCountDownView:SetPopupType(oktype)
    if oktype == 2  or oktype == 3  then
       self:SetErrorPopup()
    elseif oktype == 4  or oktype == 5  then
        self:SetGlobalPopup()
    end
end

function CommonPopupCountDownView:SetErrorPopup()
    CanvasSortingOrderManager.SetLayerOrder(CanvasSortingOrderManager.LayerType.ErrorDialog,self.go)
end

function CommonPopupCountDownView:SetGlobalPopup()
    if  SceneViewManager.gobal_layer == nil then
        SceneViewManager.gobal_layer = UnityEngine.GameObject.FindWithTag("GlobalUiRoot")
    end
    local parent =   SceneViewManager.gobal_layer
    self.go.transform:SetParent(parent.transform)
    self.go.transform.localScale = Vector3.New(1,1,1)
    self.go.transform.localPosition = Vector3.New(0,0,0)
    local rect = fun.get_component(go,fun.RECT)
    if rect then
        rect.offsetMin = Vector2.New(0, 0)
        rect.offsetMax = Vector2.New(0, 0)
    end
end


function CommonPopupCountDownView:Awake(obj)
    self:on_init()
end

function CommonPopupCountDownView:OnEnable()
    self._isinit = true
    self:SetInfo(self._go, self._content, self._oktype, self.sure_cb, self.cancel_cb,self._remainTime, self._params)

    Event.Brocast(Notes.CARD_COLLIDER_OPEN,false)
end


function CommonPopupCountDownView:OnDisable()
    ModelList.PopupModel:RemovePopupView(self)
    self._remainTime = nil
    self._isinit = nil
    self._go = nil
    self._content = nil
    self._oktype = nil
    self.sure_cb = nil
    self.cancel_cb = nil
    self._params = nil
    self:StopTimer()
    Event.Brocast(Notes.CARD_COLLIDER_OPEN,true)

end


function CommonPopupCountDownView:OnDestroy()
    self:Destroy()
    AssetManager.unload_ab({AssetList.CommonPopupCountDownView})
end

function CommonPopupCountDownView:on_close()
    self:stop_x_update()
    Event.Brocast(Notes.CARD_COLLIDER_OPEN,true)
end

function CommonPopupCountDownView:CloseFunc()
    --this.main_effect:Play("end")
    Facade.SendNotification(NotifyName.HideDialog, self)

end


function CommonPopupCountDownView:ShowTip(tipName)

end

function CommonPopupCountDownView:InitTip()

end

function CommonPopupCountDownView:CutDonwTarget()
    self:CloseFunc()
    self.main_effect:Play("end")
end

local last_click_time = 0
function CommonPopupCountDownView:on_btn_sure_click()
    --if UnityEngine.Time.time - last_click_time >0.5 then
    if self.go then log.r(self.go.name) end
    --print(self)
        if self.sure_cb then
            self.sure_cb()
        end
        Facade.SendNotification(NotifyName.HideDialog, self)
        last_click_time = UnityEngine.Time.time
    --end
end

function CommonPopupCountDownView:on_btn_cancle_click()

    --if UnityEngine.Time.time - last_click_time >0.5 then
        if self.cancel_cb then    self.cancel_cb()  end
        Facade.SendNotification(NotifyName.HideDialog, self)
    --GameObject.Destroy(self.go)
        last_click_time = UnityEngine.Time.time
    --end
end


function CommonPopupCountDownView:on_btn_close_click()
    if self.cancel_cb then    self.cancel_cb()  end
    Facade.SendNotification(NotifyName.HideDialog, self)
end

function CommonPopupCountDownView:NewPop(view_type)
    --如果o为false或者o为nil，则让o为{}
    local o = {viewName ="CommonPopupCountDownView",atlasName = "BingoBangPopupAtlas", viewType = view_type}
    setmetatable(o,self)
    self.__index = self
    return o
end

function CommonPopupCountDownView:New()
    local o = {viewName ="CommonPopupCountDownView",atlasName = "BingoBangPopupAtlas",isShow = false, isLoaded = false}
    setmetatable(o, self);
    self.__index = self
    return o
end

return this





