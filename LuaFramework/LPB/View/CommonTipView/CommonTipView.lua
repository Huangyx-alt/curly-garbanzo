---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by ruangs.
--- DateTime: 2020/8/4 14:17
---
CommonTipView = BaseDialogView:New('CommonTipView')
local this = CommonTipView
this.viewType = CanvasSortingOrderManager.LayerType.ErrorDialog

this.auto_bind_ui_items = {
    "actionPart",
    "btn_close",
    "text_tip",
    "main_effect",
    "main_canvas_group"
}

function CommonTipView:Awake(obj)
    this.update_x_enabled = true
    Facade.RegisterView(this)   --需要Notifi调用时候，才加上
    this:on_init()
    --this:InitAreaPos()
end

function CommonTipView:InitAreaPos()
--[[    local pos = self.actionPart.transform.position
    local area = fun.GetSafeArea()
    local movePosY = 0
    if area then
        movePosY = -area.TopY
    end
    self.actionPart.transform.position = Vector2.New(pos.x, movePosY)--]]
    -- self.actionPart.transform:DOLocalMoveY(movePosY, 0.01):SetEase(DG.Tweening.Ease.OutQuad)
end

function CommonTipView:OnDestroy()
    this:Close()
    AssetManager.unload_ab({AssetList.CommonTipView})
end

function CommonTipView:on_close()
    log.r("CommonTipView destory")
    LuaTimer:Remove(this.delay_close)
    this.has_show_init = false
    this.showing = false
    this.cut_delay = false
    this.continue = false
    ModelList.PlayerInfoModel:SetTipState(false)
    LuaTimer:ClearTaskList(this.delay_action)
end

function CommonTipView:on_btn_close_click()
    -- this.cut_delay = false
    --事件打点_UI交互_点击关闭界面
    --SDK.click_view_exit(self.viewName,SceneViewManager.GetCurrentSceneName())
    this:CutDonwTarget()
    
end

function CommonTipView:CloseFunc()
    this.main_effect:Play("end")
    this.delay_action[#this.delay_action + 1] = this:register_invoke( function()
        Facade.SendNotification(NotifyName.CloseUI, ViewList.CommonTipView)
    end,0.15)
   
end

function CommonTipView.ShowTip(tipName)
    this.delay_action = this.delay_action or {}
    this.show_list = this.show_list or {}
    local str = tipName --MLM:GetTextByName(tipName) or ""

    if(type(str)=="table")then 
        str = TableToJson(str)
    end

    if this:IsLastSame(tipName) == true then
        return
    end

    this.show_list[ #this.show_list +1] = {
        str = str, 
        time = 2,
        tipName = tipName,
        state = false,
    }
    ModelList.PlayerInfoModel:SetTipState(true)
    if not this.has_show_init  then
        this.continue = true
        this.has_show_init = true
    end
end

function CommonTipView:IsLastSame(tipName)
    local num = #this.show_list

    if not this.show_list or num <= 0 then
        return false
    end
    if this.show_list[num].tipName == tipName then
        return true
    end
    return false    
end

function CommonTipView:on_x_update()
    if not this.continue and #this.show_list <= 0 then
        return
    end

    if this.show_list and #this.show_list > 0  then
        local info = this.show_list[1]
        if info.state == false or this:GetCurrentTextNull() == true then
            info.state = true
            this:InitTip()
        end
        if info.time > 0 then
            info.time = info.time - Time.deltaTime
        else
            if #this.show_list > 0 then
                this:CutDonwTarget()
            end
        end
    else
    end
end

function CommonTipView:GetCurrentTextNull()
    return this.text_tip.text == ""
end

function CommonTipView:InitTip()
    this.continue = false
    this.main_effect:Play("start")
    log.r(this.show_list[1].str)
    if this.show_list and this.show_list[1] and this.show_list[1].str then
        this.text_tip.text = this.show_list[1].str
        this.delay_action[#this.delay_action + 1] = this:register_invoke( function()
            this.continue = true
        end,0.1)
    end
end

function CommonTipView:CutDonwTarget()
    table.remove(this.show_list, 1)
    if #this.show_list == 0 then
        this:CloseFunc()
    else
        this.continue = false
        this.main_effect:Play("end")

        this.delay_action[#this.delay_action + 1] = this:register_invoke( function()
            this.continue = true
        end,0.1)
    end
end



this.NotifyList =
{
    -- { notifyName = NotifyName.System.NewGuideView.GuideFBConnect, func = this.NewGuideSetFB },
    {notifyName = NotifyName.System.CommonTipView.ShowTip, func = this.ShowTip},
    
}


return this
