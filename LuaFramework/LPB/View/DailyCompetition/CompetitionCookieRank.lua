---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/4/4 10:13
---

require "State/Common/CommonState"
require "View/CommonView/RemainTimeCountDown"

local CompetitionCookieRank = BaseView:New("DailyCompetitionCookieRankView","CompetitionCookieAtlas")
local this = CompetitionCookieRank
this.viewType = CanvasSortingOrderManager.LayerType.TopConsole

local CompetitionRankItem = require "View.DailyCompetition.CompetitionRankItem"
local CompetitionMyRankItem = require "View.DailyCompetition.CompetitionMyRankItem"
local remainTimeCountDown = RemainTimeCountDown:New()

local rankItemList = nil
local isHistory = false

this.auto_bind_ui_items = {
    "btn_close",
    "btn_help",
    "Content",
    "Slider_rewards",
    "text_countdown",
    "Text_awards",
    "DailyCompetitionCookieRankView",
    "ZBjsJd02",
    "ZBjsJd03",
    "rank_item",
    "self_rank",
    "btn_add_cookie",
    "btn_add_gift",
    "btn_buy_cookie",
    "btn_buy_gift",
    "over",
    "Clock",
    "anima",
    "Content",
    "add_cookie_time_txt",
    "add_gift_time_txt",
    "SafeArea",
    "SafeArea2",
    "btn_help2",
    "btn_close2",
    "Content2",
    "rank_item2",
    "self_rank2",
    "btn_continue",
    "popup",
    "popupGrid",
    "Items",
    "popup2",
    "popupGrid2",
    "Items2",
    "btn_bg",
    "scrollRect1",
    "scrollRect2",
}


function CompetitionCookieRank:Awake(obj)
    self:on_init()
    isHistory =false
    self.scrollRect1.onValueChanged:AddListener(function (v2)
        this:on_btn_bg_click()
    end)
    self.scrollRect2.onValueChanged:AddListener(function (v2)
        this:on_btn_bg_click()
    end)
end

function CompetitionCookieRank:OnEnable(params)
    if params then isHistory = true end

    CommonState.BuildFsm(self,"CompetitionCookieRank")
    if isHistory then
        fun.set_active(self.SafeArea,false)
        fun.set_active(self.SafeArea2,true)
        self:OnResphoneRankInfo(true)
    else
        self:OnResphoneRankInfo(false)
        self:SetClock()
    end
    self:RegisterEvent()
    UISound.play("competition_list")
    Facade.RegisterView(self)
end

function CompetitionCookieRank:OnDisable()
    CommonState.DisposeFsm(self)
    rankItemList = nil
    remainTimeCountDown:StopCountDown()
    if self._timer then
        self._timer:Stop()
    end
    self:UnRegisterEvent()
    Facade.RemoveView(self)
    this.anniversaryObj = nil
end


function CompetitionCookieRank:on_btn_bg_click()
    fun.set_active(self.popup,false)
    fun.set_active(self.popup2,false)
end

function CompetitionCookieRank:on_btn_close_click()
    Facade.SendNotification(NotifyName.CloseUI,this)
    --self._fsm:GetCurState():DoOriginalAction(self._fsm,"CommonState1State",function()
    --    AnimatorPlayHelper.Play(self.anima,{"out","TournamentRewardViewexit"},false,function()
    --        Facade.SendNotification(NotifyName.CloseUI,this)
    --    end)
    --end)
    if isHistory then
        if ModelList.CompetitionModel.HasRankReward() then
            Facade.SendNotification(NotifyName.ShowUI,ViewList.CompetitionRankRewardView,nil,false,true)
        else
            ModelList.CompetitionModel.SaveLastCompetition()
            ModelList.CompetitionModel.ReqGetCompetitionRankReward()
            Event.Brocast(EventName.Event_popup_competition_finish)
        end

    end
end


function CompetitionCookieRank:on_btn_help_click()
    self._fsm:GetCurState():DoOriginalAction(self._fsm,"CommonState1State",function()
        Facade.SendNotification(NotifyName.ShowUI,ViewList.CompetitionHelperView)
        self._fsm:GetCurState():DoCommonState1Action(self._fsm,"CommonOriginalState")
    end)
end


function CompetitionCookieRank:on_btn_close2_click()
    Facade.SendNotification(NotifyName.CloseUI,this)
    if ModelList.CompetitionModel.HasRankReward() then
        Facade.SendNotification(NotifyName.ShowUI,ViewList.CompetitionRankRewardView,nil,false,true)
    else
        ModelList.CompetitionModel.SaveLastCompetition()
        ModelList.CompetitionModel.ReqGetCompetitionRankReward()
        Event.Brocast(EventName.Event_popup_competition_finish)
    end
end

function CompetitionCookieRank:on_btn_continue_click()
    Facade.SendNotification(NotifyName.CloseUI,this)
    if ModelList.CompetitionModel.HasRankReward() then
        Facade.SendNotification(NotifyName.ShowUI,ViewList.CompetitionRankRewardView,nil,false,true)
    else
        ModelList.CompetitionModel.SaveLastCompetition()
        ModelList.CompetitionModel.ReqGetCompetitionRankReward()
        Event.Brocast(EventName.Event_popup_competition_finish)
    end
end


function CompetitionCookieRank:on_btn_help2_click()
    self._fsm:GetCurState():DoOriginalAction(self._fsm,"CommonState1State",function()
        Facade.SendNotification(NotifyName.ShowUI,ViewList.CompetitionHelperView)
        self._fsm:GetCurState():DoCommonState1Action(self._fsm,"CommonOriginalState")
    end)
end

function CompetitionCookieRank:on_btn_buy_cookie_click()
    ModelList.GiftPackModel:ShowCompetitionPack()
end

function CompetitionCookieRank:on_btn_buy_gift_click()
    ModelList.GiftPackModel:ShowCompetitionPack()
end

function CompetitionCookieRank:on_btn_add_cookie_click()
    self._fsm:GetCurState():DoOriginalAction(self._fsm,"CommonState1State",function()
        ModelList.GiftPackModel:ShowCompetitionPack()
        self._fsm:GetCurState():DoCommonState1Action(self._fsm,"CommonOriginalState")
    end)
end

function CompetitionCookieRank:on_btn_add_gift_click()
    self._fsm:GetCurState():DoOriginalAction(self._fsm,"CommonState1State",function()
        ModelList.GiftPackModel:ShowCompetitionPack()
        self._fsm:GetCurState():DoCommonState1Action(self._fsm,"CommonOriginalState")
    end)
end
local selfRankInfo = nil
function CompetitionCookieRank:OnResphoneRankInfo(isHistory)
    if rankItemList == nil then
        rankItemList = {}
    end
    local rankInfoList = ModelList.CompetitionModel:GetRankInfoPlayerList()
    local myUid = ModelList.PlayerInfoModel:GetUid()
    local layerIndex = 0
    if rankInfoList and #rankInfoList >0 then
        for i = 1, #rankInfoList  do
            if myUid == rankInfoList[i].uid then
                selfRankInfo = rankInfoList[i]
                local view = CompetitionMyRankItem:New(false)
                if isHistory then this.self_rank = this.self_rank2 end
                fun.set_active(this.self_rank,true)
                view:SkipLoadShow(this.self_rank.gameObject)
                table.insert(rankItemList,view)
            else
                local view = CompetitionRankItem:New(false)
                local go  = nil
                if isHistory then go = fun.get_instance(this.rank_item2,this.Content2)
                else  go = fun.get_instance(this.rank_item,this.Content)    end
                view:SkipLoadShow(go.gameObject)
                fun.set_active(go,true)
                table.insert(rankItemList,view)
            end
            rankItemList[i]:SetRankData(rankInfoList[i],self)
            rankItemList[i]:SetLayerIndex(layerIndex)
            layerIndex = layerIndex + 1
        end
    end
    self:ScrollCenterMySelf(isHistory)
    if not isHistory then
        self:SetBuyInfo()
        self:SetEndInfo()
        self:SetTimer()
        self:OnTimerCall()
    end
end

function CompetitionCookieRank:ScrollCenterMySelf(isHistory)
    if selfRankInfo then
        local scrollRect = nil
        if fun.is_not_null( self.Content) and fun.is_not_null( self.Content.transform.parent) then
            scrollRect = self.Content.transform.parent.parent
        end
        if isHistory then
            if fun.is_not_null( self.Content2) and fun.is_not_null( self.Content2.transform.parent) then
                scrollRect = self.Content2.transform.parent.parent
            end
        end
        local scroll = fun.get_component(scrollRect,fun.SCROLL_RECT)
        if scroll then
            if selfRankInfo.order  <= 3 then
                scroll.normalizedPosition = Vector2.New(0,1)
            elseif selfRankInfo.order  >= #ModelList.CompetitionModel:GetRankInfoPlayerList() -3 then
                scroll.normalizedPosition = Vector2.New(0,0)
            else
                scroll.normalizedPosition = Vector2.New(0, 1- (selfRankInfo.order/#ModelList.CompetitionModel:GetRankInfoPlayerList()));
            end
        end
    end
end


function CompetitionCookieRank:SetEndInfo()
    if isHistory then
        fun.set_active(self.Clock,false)
        fun.set_active(self.btn_add_cookie,false)
        fun.set_active(self.btn_buy_cookie,false)
        fun.set_active(self.btn_add_gift,false)
        fun.set_active(self.btn_buy_gift,false)
        fun.set_active(self.over,true)
    end
end

function CompetitionCookieRank:SetBuyInfo(data)
    --local data = ModelList.CompetitionModel:GetQuickTaskActive()
    local doubleRewardTime = ModelList.CompetitionModel:GetDoubleRewardBuffTime()
    local doubleCollectExpireTime = ModelList.CompetitionModel:GetDoubleCollectBuffTime()
    local isAddCollect = doubleCollectExpireTime  and doubleCollectExpireTime > 0 or false
    fun.set_active(self.btn_add_cookie, isAddCollect)
    fun.set_active(self.btn_buy_cookie,not isAddCollect )

    local isAddReward= doubleRewardTime  and doubleRewardTime > 0 or false
    fun.set_active(self.btn_add_gift, isAddReward)
    fun.set_active(self.btn_buy_gift,not isAddReward)
    self:SetAnniversaryFlag()
end

--- 设置是否显示周年庆标志
function CompetitionCookieRank:SetAnniversaryFlag()
    if ModelList.FixedActivityModel:IsAnniversary() then
        if not this.anniversaryObj then
            local anniversary = require("View.Anniversary.AnniversaryBuff")
            this.anniversaryObj = anniversary:CheckAnniversaryBuff(self.btn_add_cookie.transform.parent.parent,
                    Vector2.New(-68.8,302.3),3)
        end
    end
end

local cookieTime = 0
local giftTime = 0
function CompetitionCookieRank:SetTimer()
    cookieTime = ModelList.CompetitionModel:GetDoubleCollectBuffTime()
    giftTime = ModelList.CompetitionModel:GetDoubleRewardBuffTime()
    if cookieTime > 0 or giftTime > 0 then
        self:InitTimer()
    end
end

function CompetitionCookieRank:InitTimer()
    if self._timer then
        self._timer:Stop()
    end
    self._timer = Timer.New(function()
        self:OnTimerCall()
    end,1,-1,true)
    self._timer:Start()
end

function CompetitionCookieRank:OnTimerCall()
    if cookieTime and cookieTime > 0 then
        cookieTime = math.max(0,cookieTime - 1)
        if self.add_cookie_time_txt then
            self.add_cookie_time_txt.text = fun.SecondToStrFormat2( cookieTime)
        end
        if cookieTime <= 0 then
            fun.set_active(self.btn_add_cookie, false)
            fun.set_active(self.btn_buy_cookie, true )
        end
    end
    if giftTime and giftTime > 0 then
        giftTime = math.max(0,giftTime - 1)
        if self.add_gift_time_txt then
            self.add_gift_time_txt.text = fun.SecondToStrFormat2( giftTime)
        end
        if giftTime <= 0 then
            fun.set_active(self.btn_add_gift, false)
            fun.set_active(self.btn_buy_gift,true)
        end
    end
    self:SetClock()
end

function CompetitionCookieRank:SetClock()
    if isHistory or ModelList.CompetitionModel:GetRemainTime() <= 0 then
        fun.set_active(self.Clock,false)
    else
        fun.set_active(self.Clock,true)
        remainTimeCountDown:StartCountDown(CountDownType.cdt1,
                ModelList.CompetitionModel:GetRemainTime(),
                self.text_countdown,
                function()
                end)
    end
end

--- 杯赛排行榜，展示气泡提示奖励内容
function CompetitionCookieRank:ShowPopup(order,RewardType)
    local items = nil
    local popup = nil
    local popupGrid = nil
    if isHistory then
        items = self.Items2
        popup = self.popup2
        popupGrid = self.popupGrid2
    else
        items = self.Items
        popup = self.popup
        popupGrid = self.popupGrid
    end
    local reward = Csv.GetData("competition",ModelList.CompetitionModel:GetCompetitionGroupId(),"reward")
    local rewardList = Split(reward,"-")
    for i = 1, 4 do
        local child = fun.find_child(items,"item"..i)
        fun.set_active(child,false)
    end
    for i = 1, #rewardList do
        local reward1 = Split(rewardList[i],":")
        if tonumber(reward1[1])  == order then
            local reward2 = Split(reward1[2],";")
            for m = 1, #reward2 do
                local child = fun.find_child(items,"item"..m)
                if child then
                    local item = fun.get_component(child,fun.IMAGE)
                    if item then
                        local reward3 = split(reward2[m],",")
                        local iconName = Csv.GetItemOrResource(tonumber(reward3[1]),"icon")
                        --local iconName = Csv.GetData("resources",tonumber(reward3[1]) ,"icon")
                        --log.r("iconName   "..iconName)
                        item.sprite = AtlasManager:GetSpriteByName("ItemAtlas", iconName)
                        local textObj = fun.find_child(child,"Text")
                        local text = fun.get_component(textObj,fun.OLDTEXT)
                        if text then
                            text.text = fun.formatNum( reward3[2])
                        end
                    end
                    popupGrid.constraintCount = m
                    fun.set_active(child,true)
                end
            end
            break
        end
    end
    fun.set_active(popup,true)
    fun.set_same_position_with(popup,RewardType)
end

function CompetitionCookieRank:BuffChange()
    if selfRankInfo then
        ModelList.CompetitionModel:ResetSelfInfo()
        for i = 1, #rankItemList do
            if rankItemList[i]:GetUid() == selfRankInfo.uid then
                rankItemList[i]:SetRankData(ModelList.CompetitionModel.GetSelfRank(),self)
                break
            end
        end
    end
    self:SetBuyInfo()
    self:SetTimer()
end

function CompetitionCookieRank:RegisterEvent()
    Event.AddListener(EventName.Event_double_competition_reward_change,self.BuffChange,self)
    Event.AddListener(EventName.Event_double_competition_change,self.BuffChange,self)
end

function CompetitionCookieRank:UnRegisterEvent()
    Event.RemoveListener(EventName.Event_double_competition_reward_change,self.BuffChange,self)
    Event.RemoveListener(EventName.Event_double_competition_change,self.BuffChange,self)
end

function CompetitionCookieRank.OnResphonePlayerInfo()
    --if ModelList.TournamentModel:GetPlayerInfo() then
    --    Facade.SendNotification(NotifyName.ShowUI,ViewList.TournamentTrophyView)
    --end
end

function CompetitionCookieRank.OnResNotify()
    if not isHistory and ModelList.CompetitionModel:GetRemainTime() <= 0 then
        isHistory = true
    end
end

this.NotifyList = {
    --{notifyName = NotifyName.Competition.ResphoneRankInfo,func = this.OnResphoneRankInfo},
    {notifyName = NotifyName.Competition.ResphoneNotify,func = this.OnResNotify},
    --{notifyName = NotifyName.Competition.ResphonePlayerInfo,func = this.OnResphonePlayerInfo}
}

return this