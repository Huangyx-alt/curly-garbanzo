---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/4/13 15:30
---


local CompetitionRewardItem = BaseView:New("CompetitionRewardItem")
local this = CompetitionRewardItem
this.viewType = CanvasSortingOrderManager.LayerType.None

this.auto_bind_ui_items =
{
    "rewarditem",
    "text_num",
}

function CompetitionRewardItem:New()
    local o = {}
    self.__index = self
    setmetatable(o,self)
    return o
end

function CompetitionRewardItem:Awake()
    self:on_init()
end

function CompetitionRewardItem:OnEnable()
    self._init = true
    if self.cacheData then
        self:SetReward(self.cacheData,self.hasDoubleReward)
    end
end

function CompetitionRewardItem:OnDisable()
    self._init = nil
    self.cacheData = nil
end

function CompetitionRewardItem:GetIcon(id)
    local isDoubleCollectItem = ModelList.CompetitionModel:GetDoubleRewardBuffTime() > 0
    local searchString = "spritename"
    if isDoubleCollectItem then
        searchString = "doublespritename"
    end
    for k ,v in pairs(Csv.cookierewardspritename) do
        if v.itemid  == id then
            return v[searchString]
        end
    end
    return nil
end

function CompetitionRewardItem:SetReward(data,hasDoubleReward)
    self.cacheData = data
    self.hasDoubleReward = hasDoubleReward
    if self._init then
        local icon = self:GetIcon(data.id or data[1])
        Cache.load_sprite(AssetList[icon],icon,function(tex)
            if tex then
                self.rewarditem.texture = tex.texture
            end
        end)

        if (data.id and data.id  == BingoBangEntry.itemType.MagnifyingGlass ) or  (data.id and data.id == BingoBangEntry.itemType.CookieDoubleTime) then
            ---放大镜数量转化成时间
            local ti = data.value or data[2]
            local hrs = math.floor(ti / 3600)
            --if hasDoubleReward then hrs = hrs * 2 end
            if hrs > 0 then
                self.text_num.text = fun.NumInsertComma(hrs) .. " HRS" --tostring(data.value)
            else
                local min = math.floor(ti / 60)
                self.text_num.text = fun.NumInsertComma(min) .. " Min" --tostring(data.value)
            end
        --elseif (data.id and data.id  == Resource.dailycoins_bonus ) or  (data[1] and data[1] == Resource.dailycoins_bonus) then
        --    self:SetDailyCoinsBonus()
        --    --self.text_num.text = fun.FormatText(data)
        --    self:SetOriReward(data)
        else
            local realData = data.value or data[2]
            --if hasDoubleReward then realData = realData * 2 end
            --self.text_num.text = fun.format_number(realData) --tostring(data.value)
            self:SetOriReward(realData)
        end
       
    end
end


function CompetitionRewardItem:SetOriReward(target)
    if self.text_num then
        --self.text_num.text = tostring(target)
        self.text_num:SetValue(target)
        self.oriNum = target
    end
end

function CompetitionRewardItem:SetRewardRoll(target)
    if self.text_num then
        self.text_num:RollByTime(target, 0.8, function()  end)
    end
end

function CompetitionRewardItem:GetRewardItemId()
    if self.cacheData then
        return self.cacheData.id and self.cacheData.id or self.cacheData[1]
    end
    return nil
end

function CompetitionRewardItem:GetPosition()
    if self.go then
        return self.go.transform.position
    end
    return nil
end

function CompetitionRewardItem:GetIconItem()
    if self.icon_item then
        return self.icon_item
    end
    return nil
end


function CompetitionRewardItem:SetDailyCoinsBonus()
    if self.text_title then
        fun.set_active(self.text_title, true)
        self.text_title.text =  Csv.GetDescription(529)
    end
end

function CompetitionRewardItem:SetBigger()
    fun.set_gameobject_scale(self.go,1.2,1.2,1.2)
end

function CompetitionRewardItem:ChangeDouble()
    if self.go then
        local anima = fun.get_component(self.go,fun.ANIMATOR)
        anima:Play("in")
        LuaTimer:SetDelayFunction(0.5,function()
            if self and  not fun.is_null(self.text_num) then
                self:ShowDoubleReward()

            end
        end)
    end
end

function CompetitionRewardItem:PlayDouble()
    if self.go then
        local anima = fun.get_component(self.go,fun.ANIMATOR)
        anima:Play("in")
    end
end


function CompetitionRewardItem:ShowDoubleReward()
    local data = self.cacheData
    if (data.id and data.id  == BingoBangEntry.itemType.MagnifyingGlass ) or  (data.id and data.id == BingoBangEntry.itemType.CookieDoubleTime) then
        ---放大镜数量转化成时间
        local ti = (data.value or data[2] ) * 2
        local hrs = math.floor(ti / 3600)
        --if hasDoubleReward then hrs = hrs * 2 end
        if hrs > 0 then
            self.text_num.text = fun.NumInsertComma(hrs) .. " HRS" --tostring(data.value)
        else
            local min = math.floor(ti / 60)
            self.text_num.text = fun.NumInsertComma(min) .. " Min" --tostring(data.value)
        end
    else
        local realData = (data.value or data[2] )*2
        --if hasDoubleReward then realData = realData * 2 end
        --self.text_num.text = fun.format_number(realData) --tostring(data.value)
        self:SetOriReward(realData)
    end
    
    
end

return this