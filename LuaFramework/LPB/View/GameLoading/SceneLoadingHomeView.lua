---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/7/2 11:26
---

require("View/GameLoading/BaseSceneLoadingView")
local SceneLoadingHomeView = BaseSceneLoadingView:New("SceneLoadingHomeView")
local this = SceneLoadingHomeView
this.process_move_speed = ArtConfig.EnterGameLoading_Process_Move_Speed

this.auto_bind_ui_items = {
    "txt_tips",
    "slider_progress",
    "txt_progress",
    "Canvas",
    "Canvas_Progress",
    "loading"
}

function SceneLoadingHomeView:Awake(obj)
    
end

function SceneLoadingHomeView:OnEnable()
    Facade.RegisterView(this)
    this.update_x_enabled = true
    this:on_init()
    this.on_init_ui()
    this.FadeIn()
    --UISound.play("pop")
end

function SceneLoadingHomeView.on_init_ui()
    this.percent = 0
    this.curProcess = 0
    this.isLoad = false

    this.operation  = nil
    this.can_next_step  = false
end

function SceneLoadingHomeView.FadeIn()
    --UISound.load_lobby_res()
    Anim.canvas_group_do_fade_loop(this["Canvas"],0, 1, 0.5,1,0, function()
        this:LoadSceneGame()
    end)
end

function SceneLoadingHomeView.FadeOut()
    Anim.canvas_group_do_fade_loop(this["Canvas"],1, 0, 0.5,1,0, function()
        this:Close();
    end)
end

function SceneLoadingHomeView.OnLoadSceneComplete()
    this.FadeOut()
end

function SceneLoadingHomeView:getNextSceneName()
    return "SceneHome"
end

function SceneLoadingHomeView:update_process()
    if this.curProcess< this:getTargetProcess() then
        if(this.curProcess>0.95)then
            this.process_move_speed = this.process_move_speed/3
        else
            this.process_move_speed = this.process_move_speed*1.5
        end
        this.curProcess = this.curProcess +  0.01 * this.process_move_speed
        if(this.curProcess>this:getTargetProcess())then
            this.curProcess = this:getTargetProcess()
        end
    end

    this:setProcess(this.curProcess)
end

function SceneLoadingHomeView:getTargetProcess()
    return 1
end

function SceneLoadingHomeView:load_scene()
    if(this.isLoad==nil)then this.isLoad = false end
    if(not this.isLoad)then
        this.isLoad = true
        -- this.operation.allowSceneActivation = true
        if this.operation ~= nil then
            this.operation:UnSuspend()
        end
        this.FadeOut()
    end
end

function SceneLoadingHomeView:setProcess(value)
    this.slider_progress.value = value
    this.txt_progress.text =  tostring(math.floor(value*100)).."%"
end

function SceneLoadingHomeView:on_x_update()
    if this.operation == nil then
        return
    end
    this:update_process()
    local absProcess =  math.abs(1-this.curProcess)
    if absProcess<=0.01 and this.can_next_step == true then
        this:load_scene()
        this:stop_x_update()
    end
end

function SceneLoadingHomeView:LoadSceneGame()
    LoadSceneAsync(this:getNextSceneName(),ProcedureCityHome:New(),function(operation)
        this.operation  = operation
        -- this.operation.allowSceneActivation = false
        AssetManager.load_common_res(function() --加载通用ab资源
            AssetManager.load_lobby_res(function () --加载大厅资源和音效
                this.percent = 1
                this.can_next_step = true
            end)
        end)
    end)
end

function SceneLoadingHomeView:OnDisable()
    Facade.RemoveView(this)
    this:Close()
end

function SceneLoadingHomeView:on_close()

end

function SceneLoadingHomeView:OnDestroy()
    
end

--this.NotifyList = {
--    --{notifyName = NotifyName.LoadScene.LoadSceneComplete,func = this.OnLoadSceneComplete},
--}

return this


