---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/7/26 12:11
---

local CardSwitchItem = BaseChildView:New() --Clazz(BaseChildView,"CardSwitchItem")
local this = CardSwitchItem
this.cardPage = {}     --switch 分页1

function CardSwitchItem:New(go)
    self = {}
    setmetatable(self,{__index = CardSwitchItem})
    --self._data = cellData
    return self
end

---初始化switch 分页卡牌
function CardSwitchItem:InitMap(go,type)
    local ref = fun.get_component(go.gameObject,fun.REFER)
    if ref then
        self.content = ref:Get("content")
        self.img_reap = ref:Get("img_reap")
        SetJokerSkin(fun.get_component(self.img_reap,fun.IMAGE),"JokerBattleAtlas","bClickClownSmall" )
    end

    local page = {}
    local xSpace, ySpace = this.GetCellSpace()
    for i = 1, 25 do
        local go = fun.get_instance(self.img_reap,self.content)
        fun.set_active(go,false,0)
        local img = go:GetComponent(fun.IMAGE)
        local cell = {obj = go,image = img}
        table.insert(page,cell)
        local x = math.modf((i-1)/5)
        local y = math.modf((i-1)%5)
        fun.set_gameobject_pos(go,xSpace*x,ySpace*y,0,true)
        if i == 13 then
            fun.set_active(go,true)
        end
    end
    table.insert(this.cardPage,page)
end

--- 在结算界面，显示小卡牌
function CardSwitchItem:ShowAll(go,orderIndex)

end

local function IsAutoClick(currCardId,currIndex,cardId,signInfo)
    if not signInfo then return false end
    if currCardId == cardId then
        for i = 1, #signInfo do
            if signInfo[i].index == currIndex and signInfo[i].cardId == cardId then
                return true
            end
        end
    end
    return false
end

local function IsNotNull(obj)
    return obj and not Util.IsNull(obj)
end

function CardSwitchItem:Refresh(pageIndex, newCard,cardId,signInfo,cardObj)
    local items =  this.cardPage[pageIndex]
    if items then
        local isshowing = false
        for i = 1, #items do
            isshowing = false
            for k,v in pairs(newCard) do
                if  i == v.index then
                    isshowing = true
                    if IsNotNull(items[i].obj) then
                        items[i].obj.gameObject:SetActive(true)
                        if IsAutoClick(v.cardId, v.index, cardId, signInfo) then
                            local anim = fun.get_component(items[i].obj, fun.ANIMATOR)
                            if anim then
                                anim:Play("in")
                            end
                        end
                        local sprite_name, atlas_name = this.GetNormalSmallCellName()
                        if v.sign > 1 then
                            if v.self_bingo then
                                sprite_name,atlas_name = this.GetSelfBingoSmallCellName(v.sign)
                                --sprite_name = v.sign == 3 and "b_jackpot02_small" or "b_bingo02_small"
                            else
                                sprite_name,atlas_name = this.GetSmallCellName(v.sign)
                                --sprite_name = v.sign == 3 and "b_jackpot_small" or "b_bingo01_small"
                            end
                        end
                        if fun.is_null(items[i].image ) then
                            items[i].image = fun.get_component(items[i].obj,fun.IMAGE)
                        end
                        if  not items[i].image.sprite  or  not string.find(items[i].image.sprite.name, sprite_name) then
                            items[i].image.sprite = AtlasManager:GetSpriteByName(atlas_name, sprite_name)
                        end
                    end
                    break
                end
            end
            if not isshowing and IsNotNull(items[i].obj) then
                items[i].obj.gameObject:SetActive(false)
            end
        end
    end
end

---小丑卡棋子换皮
function CardSwitchItem.GetSmallCellName(sign)
    if ModelList.BattleModel.GetIsJokerMachine() then
        if sign == 3 then
            local playType = ModelList.BattleModel:GetGameType()
            if playType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
                return "WinzoneBvictoryX", "WinZoneBattleAtlas"
            else
                return "bJackpotClownSmall", "JokerBattleAtlas"
            end
        else
            return "bBingopClownSmall", "JokerBattleAtlas"
        end
    else
        local playType = ModelList.BattleModel:GetGameType()
        if playType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
            return sign == 3 and "WinzoneBvictoryX" or "WinzoneBbingoX", "WinZoneBattleAtlas"
        else
            return sign == 3 and "b_jackpot_small" or "b_bingo01_small", "BingoAtlas"
        end
    end
end

---selfBingo棋子换皮
function CardSwitchItem.GetSelfBingoSmallCellName(sign)
    local playType = ModelList.BattleModel:GetGameType()
    if playType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
        --WinZone
        return sign == 3 and "WinzoneBvictoryX" or "WinzoneBbingopcardX", "WinZoneBattleAtlas"
    else
        return sign == 3 and "b_jackpot02_small" or "b_bingo02_small", "BingoAtlas"
    end
end

---普通盖章棋子
function CardSwitchItem.GetNormalSmallCellName()
    local playType = ModelList.BattleModel:GetGameType()
    if playType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
        --WinZone
        return "WinzoneBclickX", "WinZoneBattleAtlas"
    else
        return "b_click_small", "BingoAtlas"
    end
end

---小卡格子间隔
function CardSwitchItem.GetCellSpace()
    local playType = ModelList.BattleModel:GetGameType()
    if playType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
        --WinZone
        return 25, -24
    else
        return 25, -20.5
    end
end

function CardSwitchItem.OnDispose()
    this.cardPage = {}
    this:Close()
end

return CardSwitchItem