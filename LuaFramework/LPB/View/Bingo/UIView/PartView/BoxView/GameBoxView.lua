---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/1/5 19:12
---
local GameBoxView = BaseView:New();
local this = GameBoxView;
this.viewType = CanvasSortingOrderManager.LayerType.None
this.hideIndex = { 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10 }
this.effectListObj = {}


this.auto_bind_ui_items = {
    "efBingobox3",
    "efBingobox4",
    "efBingobox5",
    "box",
    "bottle",
    "meishidaizi",
    "pot",
}



function GameBoxView:Awake()
    self:on_init()
end

function GameBoxView:OnEnable()
    this:RegisterEvent()
    this.moduleList = require("View.Bingo.BattleModuleList")
    this.effContainer = this.moduleList.GetModule("EffectEntry")  --效果模块，较为常用，单独设置一个直接引用
    if not this.bottle then
        local obj = fun.find_child(this.go.transform.parent,"bottle")
        this.bottle = fun.get_component(obj,fun.ANIMATOR)
    end
    this.effectListObj = {}
    table.insert(this.effectListObj ,this.efBingobox3)
    table.insert(this.effectListObj ,this.efBingobox4)
    table.insert(this.effectListObj ,this.efBingobox5)
    table.insert(this.effectListObj ,this.meishidaizi)
end

local IsEffectAllHide = function()
    for i = 1, #this.effectListObj do
        if not Util.IsNull(this.effectListObj[i]) and fun.get_active_self(this.effectListObj[i])  then
            return false
        end
    end
    return true
end
local IsEffectAllHideButFoodBag = function()
    for i = 1, #this.effectListObj do
        if  fun.get_active_self(this.effectListObj[i])  and not Util.IsNull(this.effectListObj[i]) and this.effectListObj[i].gameObject.name ~="meishidaizi"   then
            return false
        end
    end
    return true
end

local boxEffectFlyTime = 4
local meishidaiziTime = 3
--flag 标记为跟美食袋子相同的逻辑
local GetBoxEffect = function(obj, hideTime, flag)
    --展示跟美食袋子一样的动画
    if flag and fun.is_not_null(this.meishidaizi) and obj ~= this.meishidaizi then
        obj = fun.get_instance(obj, this.meishidaizi.transform.parent)
        table.insert(this.effectListObj, obj)
        --位置
        obj.transform.position = fun.get_rect_worldPos(this.meishidaizi)
        --设置跟美食袋子一样的动画
        local animator = fun.get_component(this.meishidaizi, fun.ANIMATOR)
        local newAnimator = fun.add_component(obj, UnityEngine.Animator)
        newAnimator.runtimeAnimatorController = animator.runtimeAnimatorController
        fun.set_active(obj, false)
    end
    
    if fun.get_active_self(obj) then
        local newObj = fun.get_instance(obj,obj.transform.parent)
        table.insert(this.effectListObj,newObj)
        fun.set_active(newObj,true)
        LuaTimer:SetDelayFunction(hideTime,function()
            fun.set_active(newObj,false)
            Event.Brocast(EventName.FlyItem_FoodBag_Fly_End,"b_bingo_xz")
            this:HideBoxFun("b_bingo_xz")
        end)
    else
        fun.set_active(obj,false)
        fun.set_active(obj,true)
        LuaTimer:SetDelayFunction(hideTime,function()
            if flag or obj == this.meishidaizi then
                Event.Brocast(EventName.FlyItem_FoodBag_Fly_End,"b_bingo_xz")
                --BattleEffectCache:GetPrefabFromCache("DaojubaodianGet",obj,function(ob)
                --    Destroy(ob,2)
                --end)
            end
            fun.set_active(obj,false)
            this:HideBoxFun("b_bingo_xz")
        end)
    end
end

function GameBoxView:PlayExtraCoins(data, obj)
    if data == 0 then
        UISound.stop_loop("chips")
        UISound.play_loop("chips")
        GetBoxEffect(this.efBingobox5,boxEffectFlyTime)
    elseif data == 3 then
        UISound.stop_loop("chips")
        UISound.play_loop("chips")
        GetBoxEffect(this.efBingobox3,boxEffectFlyTime)
    elseif data == 4 then
        UISound.stop_loop("chips")
        UISound.play_loop("chips")
        GetBoxEffect(this.efBingobox4,boxEffectFlyTime)
    elseif data == 5 then
        --GetBoxEffect(obj or this.meishidaizi, meishidaiziTime, true)
        --目前仅展示卡包奖励
        if fun.is_not_null(obj) then
            GetBoxEffect(obj, meishidaiziTime, true)
        end
    end
end


local HideXZ = function(has_coin)
    this:PlayBoxHit()
   -- log.r("this.hideIndex[1]    "..this.hideIndex[1].."           2    "..this.hideIndex[2].."       IsFlyOver   ".. tostring(this.moduleList.GetModule("CardFlyItemContainer"):IsFlyOver("b_bingo_xz")).."       has_coin    "..tostring(has_coin).."       IsEffectAllHide  "..tostring(IsEffectAllHide()))
    if this.hideIndex[1] == 10 and this.hideIndex[2] == 10 and this.moduleList.GetModule("CardFlyItemContainer"):IsFlyOver("b_bingo_xz")  and not has_coin and IsEffectAllHide() then
        this:PlayBoxExit()
    end
    if not has_coin and IsEffectAllHideButFoodBag() then
        UISound.stop_loop("chips")
    end
end

local HidePZ = function()
    this:PlayBottleHit()
    if this.moduleList["CardFlyItemContainer"]:IsFlyOver("b_bingo_pz") then
        this:PlayBottleExit()
    end
end

local HidePot = function()
    this:PlayPotHit()
    if this.moduleList.GetModule("CardFlyItemContainer"):IsFlyOver("pot")   then
        this:PlayPotExit()
    end
end

function GameBoxView:HideBoxFun(box_type)
    local has_coin = this.effContainer:HasFlyCoinCount()
    if box_type == nil or box_type == "b_bingo_xz" then
        HideXZ(has_coin)
    elseif box_type == "b_bingo_pz" then
        HidePZ()
    elseif  box_type == "pot" then
        HidePot()
    else
        if has_coin then return nil end
        this:PlayBoxExit()
    end
end

function GameBoxView:PlayBoxExit()
    if this.box and not Util.IsNull(this.box) then
        UISound.stop_loop("chips")
        this.box:Play("exit")
        UISound.play("reward_flyin_case")
    end
end

function GameBoxView:PlayBottleExit()
    if this.bottle and not Util.IsNull(this.bottle) then
        this.bottle:Play("bingo_bottleout")
        UISound.play("reward_flyin_jar")
    end
end

function GameBoxView:PlayPotExit()
    if this.pot and not Util.IsNull(this.pot) then
        this.pot:Play("exit")
    end
end

---@see 箱子受击效果
function GameBoxView:PlayBoxHit()
    if this.box and not Util.IsNull(this.box) and  not this.box:GetCurrentAnimatorStateInfo(0) :IsName("exit") then
        this.box:Play("action")
    end
end

---@see 锅受击效果
function GameBoxView:PlayPotHit()
    if this.pot and not Util.IsNull(this.pot)  and not this.pot:GetCurrentAnimatorStateInfo(0) :IsName("exit")  then
        this.pot:Play("action", -1, 0)
    end
end

---@see 瓶子受击效果
function GameBoxView:PlayBottleHit()
    if this.bottle and not Util.IsNull(this.bottle)  and not this.bottle:GetCurrentAnimatorStateInfo(0) :IsName("bingo_bottleout")  then
        this.bottle:Play("bingo_bottleact")
    end
end

function GameBoxView:RegisterEvent()
    Event.AddListener(EventName.Box_Bingo_Coins,this.PlayExtraCoins)
    Event.AddListener(EventName.Box_Fly_FoodBag,this.PlayExtraCoins)
    Event.AddListener(EventName.FlyItem_HideBoxFun, this.HideBoxFun)
    Event.AddListener(EventName.Box_Trigger_Hit, this.PlayBoxHit)
    Event.AddListener(EventName.Pot_Trigger_Hit, this.PlayPotHit)
end

function GameBoxView:UnRegisterEvent()
    Event.RemoveListener(EventName.Box_Bingo_Coins,this.PlayExtraCoins)
    Event.RemoveListener(EventName.Box_Fly_FoodBag,this.PlayExtraCoins)
    Event.RemoveListener(EventName.FlyItem_HideBoxFun, this.HideBoxFun)
    Event.RemoveListener(EventName.Box_Trigger_Hit, this.PlayBoxHit)
    Event.RemoveListener(EventName.Pot_Trigger_Hit, this.PlayPotHit)
end

function GameBoxView:OnDisable()

end

function GameBoxView:OnDestroy()
    this:UnRegisterEvent()
    this.hideIndex = { 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10 }
    self:Destroy()
end





return this
