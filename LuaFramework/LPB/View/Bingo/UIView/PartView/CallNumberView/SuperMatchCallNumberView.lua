---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2024/6/17 16:43
---


local CallNumberReadyState = require "View/Bingo/CallNumberState/CallNumberReadyState"
local CallNumberIdleState = require "View/Bingo/CallNumberState/CallNumberIdleState"
local CallNumberDropState = require "View/Bingo/CallNumberState/CallNumberDropState"
local CallNumberSortState = require "View/Bingo/CallNumberState/CallNumberSortState"
local CallNumberCompleteState = require "View/Bingo/CallNumberState/CallNumberCompleteState"

local SuperMatchCallNumberView = BaseView:New()
local this = SuperMatchCallNumberView

local Bingo_Num_Txt = {"B","I","N","G","O"}

this.auto_bind_ui_items = {
    "ball",
    "number1",
    "number2",
    "ballType",
    "rollBall",
    "ImgSpriteContainer",
    "numSpriteContainer",
    "BallContainer",
}

function SuperMatchCallNumberView:New()
    local o = {}
    setmetatable(o, { __index = SuperMatchCallNumberView });
    return o
end

this.number_img_num = 10 --数字的图片数量
this.number_sprite_list = {}  --数字sprite列表
this.reward_sprite_list = {}  --卡牌基础奖励sprite列表
this.ball_sprite_list = {}  --号球sprite列表
this.ball_img_num = 5 --号球图片数量
this.parent = {}
this.lastNumbers = {}
this.loadData = {}

this.rollBallParent = nil        --号球根节点
this.ballList = nil                    --所有号球列表
this.rollList = {}                     -- 横向滚动球的列表
this.dropBallIndex = 1
this.model = nil
this.dropBallTemp = nil


function SuperMatchCallNumberView:Init(bingoView, go, dropBallCallback)
    self.go = go
    self:on_init()
    self:SetCurrParent(bingoView)
    self:InitCallNumber(self.rollBall)
    self:SetDrop_ball_cb(function(currNumber)
        dropBallCallback(currNumber)
    end)
    self:RegisterEvent()
    self:SetNumberSpriteList()
    self:InitParams()
    self:CollectNumberDropEffect()
    self:BuildFsm()
    --this:CoroutineLoad()

end

function SuperMatchCallNumberView:InitParams()
    this.model = ModelList.BattleModel:GetCurrModel()
    this.loadData = this.model:LoadGameData()
end

function SuperMatchCallNumberView:SetCurrParent(my_parent)
    this.parent = my_parent
end

function SuperMatchCallNumberView:InitCallNumber(rollBallRef)
    this.rollBallParent = rollBallRef
    this:SetBallSpriteList()
    this:SetBallLetterSpriteList()
end


--储存数字sprite container
function SuperMatchCallNumberView:SetNumberSpriteList()
    this.number_sprite_list = {}
    if self.numSpriteContainer then
        local isc = self.numSpriteContainer
        if isc and isc.sprites and isc.sprites.Length > 0 and not Util.IsNull(isc:GetAsIndex(0))  then
            for i = 1, this.number_img_num do
                local sp = isc:GetAsIndex(i - 1)
                this.number_sprite_list[i] = sp
            end
        end
    end
    if #this.number_sprite_list == 0 then
        local sp_container = self.numSpriteContainer
        for i = 1, this.number_img_num do
            local sp = sp_container:GetAsIndex(i - 1)
            this.number_sprite_list[i] = sp
        end
    end
end

--储存叫号的号球外框的sprite container
function SuperMatchCallNumberView:SetBallSpriteList()
    local sp_container = fun.get_component(self.rollBallParent, fun.IMAGESPRITESCONTAINER)
    for i = 1, this.ball_img_num do
        local sp = sp_container:GetAsIndex(i - 1)
        this.ball_sprite_list[i] = sp
    end
end

--储存叫号的 "B"  "I"  "N"  "G"  "O" 字母图片的sprite container
function SuperMatchCallNumberView:SetBallLetterSpriteList()
    local letterContainer = fun.find_child(self.rollBallParent.transform,"ImgSpriteContainer")
    local sp_container = fun.get_component(letterContainer, fun.IMAGESPRITESCONTAINER)
    this.ball_letter_container = {}
    if sp_container == nil then
        return
    end
    for i = 1, 5 do
        local sp = sp_container:GetAsIndex(i - 1)
        this.ball_letter_container[i] = sp
    end
end

function SuperMatchCallNumberView:GetBallLetter(index)
    if this.ball_letter_container  then
        return this.ball_letter_container[index]
    end
end


--- normal 和 兴奋叫号特效
function SuperMatchCallNumberView:CollectNumberDropEffect()
    this.rollBallParent.gameObject:SetActive(true)
    local ball = fun.find_child(this.rollBallParent, "BallEffect")
    if ball then
        this.BallEffect = fun.get_component(ball,fun.ANIMATOR)
    end
end

--- 单独播放normal 和 兴奋叫号特效
function SuperMatchCallNumberView:PlayNumberDropEffect(effectType)
    if this.BallEffect then
        if effectType == 0 then
            fun.set_active(this.BallEffect,false)
        elseif effectType == 1 then
            fun.set_active(this.BallEffect,true)
            this.BallEffect:Play("normal")
        elseif effectType == 2 then
            fun.set_active(this.BallEffect,false)
            this.BallEffect:Play("exciting")
        end
    end
end

function SuperMatchCallNumberView:RegisterEvent()
    --Event.AddListener(Notes.SYNC_NUMBER, this.DropBallEffect)
    Event.AddListener(EventName.Event_Trigger_Super_Match_Robot_Call_Number, self.ActiveView,self)
end

function SuperMatchCallNumberView:UnRegisterEvent()
    --Event.RemoveListener(Notes.SYNC_NUMBER, this.DropBallEffect)
    Event.RemoveListener(EventName.Event_Trigger_Super_Match_Robot_Call_Number, self.ActiveView,self)
end

--显示新叫号效果
--阶段1：横向滚动
function SuperMatchCallNumberView:DropBallEffect(data)
    this._fsm:ChangeState("CallNumberDropState", this.rollList, this.dropBallIndex,data)
end

function SuperMatchCallNumberView:ActiveView(number)
    if this and this.go then
        fun.set_active(this.go,false)
        self:SetBallNumber(number)
        fun.set_active(this.go,true)
        self:register_invoke(function() 
            self:CheckPlayerNumSign(number)
        end, 0.8)
    end
end

function SuperMatchCallNumberView:SetBallNumber(ballNumber)
    local first_num = math.modf(ballNumber / 10)
    local second_num = math.modf(ballNumber % 10)
    if second_num == 0 then
        second_num = 10
    end
    if ballNumber >= 61 then
        self.ballType.sprite =self:GetBallLetter(5)
        self.number1.sprite = self.number_sprite_list[first_num]
        self.number2.sprite = self.number_sprite_list[second_num]
        self.ball.sprite = this.ball_sprite_list[5]
    elseif ballNumber >= 46 then
        self.ballType.sprite =self:GetBallLetter(4)
        self.number1.sprite = self.number_sprite_list[first_num]
        self.number2.sprite = self.number_sprite_list[second_num]
        self.ball.sprite = this.ball_sprite_list[4]
    elseif ballNumber >= 31 then
        self.ballType.sprite =self:GetBallLetter(3)
        self.number1.sprite = self.number_sprite_list[first_num]
        self.number2.sprite = self.number_sprite_list[second_num]
        self.ball.sprite = this.ball_sprite_list[3]
    elseif ballNumber >= 16 then
        self.ballType.sprite =self:GetBallLetter(2)
        self.number1.sprite = self.number_sprite_list[first_num]
        self.number2.sprite = self.number_sprite_list[second_num]
        self.ball.sprite = this.ball_sprite_list[2]
    else
        self.ballType.sprite =self:GetBallLetter(1)
        self.number1.sprite = self.number_sprite_list[first_num]
        self.number2.sprite = self.number_sprite_list[second_num]
        self.ball.sprite = this.ball_sprite_list[1]

    end
    if ballNumber< 10 then
        fun.set_rect_local_pos_x(self.number2, 0)
        fun.set_active(self.number1,false)
        fun.set_active(self.number2,true)
    else
        fun.set_rect_local_pos_x(self.number1, -18)
        fun.set_rect_local_pos_x(self.number2, 18)
        fun.set_active(self.number1,true)
        fun.set_active(self.number2,true)
    end
end


function SuperMatchCallNumberView.CompleteDropBall()
    this._fsm:ChangeState("CallNumberCompleteState")
end

function SuperMatchCallNumberView:SetDrop_ball_cb(cb)
    this.drop_ball_callback = cb
end

function SuperMatchCallNumberView:CallDropBallcb(num)
    this.drop_ball_callback(num)
end

function SuperMatchCallNumberView:SetDropBallIndex()
    this.dropBallIndex = this.dropBallIndex + 1
    if this.dropBallIndex > 5 then
        this.dropBallIndex = 1
    end
end

-- 播放星光到powerup
function SuperMatchCallNumberView:CallNumberStarTrailsToPowerup(ball)
    if this.parent.cardView and this.parent.powerView:CanRechargePowerUp() then
        this.parent.cardView.effContainer:CallNumberStarTrailsToPowerup(ball)
    end
end

-- 遍历数组
function SuperMatchCallNumberView:IsInTable(value, tbl)
    for k, v in pairs(tbl) do
        if v == value then
            return true;
        end
    end
    return false;
end

function SuperMatchCallNumberView:on_x_update()
end

function SuperMatchCallNumberView.OnDestroy()
    this:UnRegisterEvent()
    this:DisableAction()
    this:Close()
end

function SuperMatchCallNumberView:DisableAction()
    this.number_img_num = 10 --数字的图片数量
    this.number_sprite_list = {}  --数字sprite列表
    this.reward_sprite_list = {}  --卡牌基础奖励sprite列表
    this.ball_sprite_list = {}  --号球sprite列表
    this.ball_img_num = 5 --号球图片数量
    this.parent = {}
    this.lastNumbers = {}
    this.loadData = {}
    this.rollBallParent = nil        --号球根节点
    this.ballList = nil                    --所有号球列表
    this.rollList = {}                     -- 横向滚动球的列表
    this.dropBallIndex = 1
    this.model = nil
    this.dropBallTemp = nil
end

function SuperMatchCallNumberView:BuildFsm()
    this:DisposeFsm()
    this._fsm = Fsm.CreateFsm("SuperMatchCallNumberView", this, {
        CallNumberReadyState:New(),
        CallNumberIdleState:New(),
        CallNumberDropState:New(),
        CallNumberSortState:New(),
        CallNumberCompleteState:New()
    })
    this._fsm:StartFsm("CallNumberReadyState")
end

function SuperMatchCallNumberView:DisposeFsm()
    if this._fsm then
        this._fsm:Dispose()
        this._fsm = nil
    end
end

function SuperMatchCallNumberView:GetDropBall()
    this.dropBallIndex = this.dropBallIndex + 1
    return this.ballList[this.dropBallIndex]
end

function SuperMatchCallNumberView:GetJokerParent()
    return self.Joker
end

function SuperMatchCallNumberView:CheckPlayerNumSign(number)
    local numbers = {number}
    local signCellData = {}
    if numbers and  #numbers > 0 then
        local model = ModelList.BattleModel:GetCurrModel()
        local cardCount =   model:GetCardCount()
        local data, checkFlag = nil, {}  --checkFlag 检查是否会重复叫号
        for i = 1, #numbers do
            for k = 1, cardCount do
                checkFlag[k] = checkFlag[k] or {}
                data = model:GetRoundDataByNum(k,numbers[i])
                if data and data:IsNotSign() then
                    ---卡面上播放合作特效
                    if BattleLogic.GetLogicModule(LogicName.SwitchLogic):IsShowing(k) then
                        Event.Brocast(EventName.Event_Card_Super_Match,k,data.index, self.go, number)
                    else  -- switch 小卡上播放合作特效
                        Event.Brocast(EventName.Event_Super_Match_Switch_Card_Effect,k,data.index, self.go, number)
                    end
                end
            end
        end
    end
end

return this
