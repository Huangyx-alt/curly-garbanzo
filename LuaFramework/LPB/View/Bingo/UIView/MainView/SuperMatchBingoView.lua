---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2024/6/17 11:59
---

local SuperMatchBingoView = BaseView:New('SuperMatchBingoView');
local this = SuperMatchBingoView;

local packageRequire = require("View/Bingo/UIView/SuperMatch/SuperMatchBattlePackage")

this.auto_bind_ui_items = {
    "1",
    "2",
    "3",
    "4",
    "cell1",
    "cell2",
    "cell3",
    "cell4",
    "headMask",
    "Head",
    "Name",
    "Ball",
    "HandEffect",
    "award",
    "imgBox",
    "progressBar",
    "progressValue",
    "imgIcon1",
    "Node",
    "FlyPoint",
    "img_reap",
    "imgIcon2",
    "imgIcon3",
    "imgIcon4",
    "imgIcon5",
    "imgIcon6",
    "imgIcon7",
    "imgIcon8",
}

this.data = {}

this.cardView =nil  --卡牌功能界面
this.switchView =nil  --卡牌切换功能界面
this.jackpotView =nil  --jackpot功能界面
this.bingoEffect = nil   --其他人bingo提示
this.callNumView = nil --叫号界面

this.fireTime={}
this.fireTime2={}
this.eff_table = {}
this.bingo_time = {}
this.jackpot_time = {}
this.coin_time = {}
this.fire_time = {}
this.ready_for_pre_item =  {0,0,0,0,0,0,0,0,0,0}
local last_click_time = 0   -- 退出按钮点击间隔时间

this.ViewName = "SuperMatchBingoView"


function SuperMatchBingoView:Awake()
    packageRequire:Init()
    self:BaseAwake()
end

function SuperMatchBingoView:BaseAwake()
    self:ResetInitData()
    self:on_init()
    self:RegisterEvent()
    self.model = ModelList.BattleModel:GetCurrModel()
    self.data  =  ModelList.BattleModel:GetCurrModel():LoadGameData()
    local targetData = {}
    local serverData = ModelList.BattleModel:GetCurrModel():GetSuperMatchData()
    self:FitMatchData(targetData, serverData)

    --[[undo test data
    local data = {
        cardCount = #self.data.cardsInfo,
        robotId = math.random(1,40000),
        --headFrame = math.random(1,4),
        --callNuberOrder ={{2,{22}} , {5,{33}} , {7,{55} }  },

        ---正式数据格式
        beginMarkedPos ={
            {cardId = 1, pos = {33}},
            {cardId = 2, pos = {33}},
            --{cardId = 3, pos = {33}},
            --{cardId = 4, pos = {33}},
        },
        markTick = {
            {tick = 18000,markPos = { {cardId = 1, pos = {11}}, {cardId = 2, pos = {11}}, } },
            {tick = 28000,markPos = { {cardId = 1, pos = {22}},{cardId = 2, pos = {22}}, } },
            {tick = 38000,markPos = { {cardId = 1, pos = {44}},{cardId = 2, pos = {44}}, } },
            {tick = 48000,markPos = { {cardId = 1, pos = {55}},{cardId = 2, pos = {55}}, } },
            {tick = 58000,markPos = { {cardId = 1, pos = {15}},{cardId = 2, pos = {15}}, } },
            {tick = 68000,markPos = { {cardId = 1, pos = {24}},{cardId = 2, pos = {24}}, } },
            {tick = 78000,markPos = { {cardId = 1, pos = {42}},{cardId = 2, pos = {42}}, } },
            {tick = 88000,markPos = { {cardId = 1, pos = {51}},{cardId = 2, pos = {51}}, } },
        },
        userMarkPos = {
            {callOrder = 2, markPos = { {cardId = 1, pos = {11}} ,{cardId = 2, pos = {11}} }} ,
            {callOrder = 4, markPos = { {cardId = 1, pos = {22}} ,{cardId = 2, pos = {22}} }} ,
            {callOrder = 6, markPos = { {cardId = 1, pos = {44}} ,{cardId = 2, pos = {44}} }},
            {callOrder = 8, markPos = { {cardId = 1, pos = {55}} ,{cardId = 2, pos = {55}} }},
            {callOrder = 10, markPos = { {cardId = 1, pos = {15}} ,{cardId = 2, pos = {15}} }},
            {callOrder = 12, markPos = { {cardId = 1, pos = {24}} ,{cardId = 2, pos = {24}} }},
            {callOrder = 14, markPos = { {cardId = 1, pos = {42}} ,{cardId = 2, pos = {42}} }},
            {callOrder = 16, markPos = { {cardId = 1, pos = {12}} ,{cardId = 2, pos = {12}} }},
            {callOrder = 18, markPos = { {cardId = 1, pos = {13}} ,{cardId = 2, pos = {13}} }},
            {callOrder = 20, markPos = { {cardId = 1, pos = {14}} ,{cardId = 2, pos = {14}} }},
        },
        callNum = {
            {callOrder = 5 ,number = 15},
            {callOrder = 8 ,number = 25},
            {callOrder = 11 ,number = 35},
            {callOrder = 14 ,number = 45},
            {callOrder = 17 ,number = 55},
        }
    }

    targetData = data
    --]]
    ModelList.BattleModel:GetCurrModel():LoadGameData().matchData = targetData
    for i = 1, 4 do
        fun.set_active(self[tostring(i)], false)
        fun.set_active(self["cell"..i], false)
    end

    fun.set_active(self.Ball, false)
    fun.set_active(self.HandEffect, false)

    
    self:OpenCard(targetData)
    self:SetHead(targetData)
    self:InitProgressAward(targetData)
end

function SuperMatchBingoView:InitProgressAward(targetData)
    self.currProgress = 0
    self.chargeLevel = 1
    self.finishChargeLevel = 0
    self.cardCount = ModelList.BattleModel:GetCurrModel():GetCardCount()
    self.mateCardCount = targetData.cardCount
    self.rewardList = targetData.markAccReward
    fun.set_active(self.imgIcon, false)

    local chargeRatioCfg = Csv.GetControlByName("supermatch_charge_ratio")
    local chargeRatio1, chargeRatio2
    if chargeRatioCfg then
        for i, v in ipairs(chargeRatioCfg) do
            if v[1] == self.cardCount then
                chargeRatio1 = v[2]
            end

            if v[1] == self.mateCardCount then
                chargeRatio2 = v[2]
            end
        end
    else
        log.log("SuperMatchBingoView:InitProgressAward 找不到supermatch_charge_ratio配置")
    end
    self.chargeRatio = chargeRatio1 or 3
    self.mateChargeRatio = chargeRatio2 or 3
    self:SetChargeProgress(self.currProgress)
end

function SuperMatchBingoView:ShowAll()
    fun.set_active(self.Node, true)
end

function SuperMatchBingoView:HideAll()
    fun.set_active(self.Node, false)
end

function SuperMatchBingoView:FitMatchData(targetData, serverData)
    if not targetData or not serverData then
        return
    end
    targetData.cardCount= #serverData.beginMarkedPos
    targetData.robotId = serverData.matchId
    targetData.beginMarkedPos = serverData.beginMarkedPos
    targetData.markTick = serverData.markTick
    targetData.userMarkPos = serverData.userMarkPos
    targetData.callNum = serverData.callNum
    targetData.markAccReward = serverData.markAccReward
end

function SuperMatchBingoView:OnEnable()
    self:BaseEnable()
end

function SuperMatchBingoView:BaseEnable()
    self.data  =  ModelList.BattleModel:GetCurrModel():LoadGameData()
    last_click_time = 0
    self:LoadBingoViewRequire(false)
    --self.update_x_enabled = true
    --self:start_x_update()
    for i = 1, #self.data.cardsInfo do
        self.eff_table[i] = {fire= {  },bingo ={},coin ={}}
    end
end

function SuperMatchBingoView:LoadBingoViewRequire()
    local gameType = ModelList.BattleModel:GetGameCityPlayID()
    local data = Csv.GetData("new_game_bingo_view",gameType)
    self.cardView = require("View.Bingo.UIView.CardView.SuperMatchRobotCardView"):New("SuperMatchRobotCardView")
    self.cardView:OnEnable(self)
    --bingo 效果以及自己计算头像icon
    --if data["jump_bingo_view"] ~= "0" then
    --    self.bingoEffect = require("View.Bingo.UIView.PartView.JumpBingoView."..data["jump_bingo_view"])
    --    self.bingoEffect:Init(self.Bingo,self)
    --end
    self.callNumView = require("View.Bingo.UIView.PartView.CallNumberView.SuperMatchCallNumberView")
    self.callNumView:Init(self, self.Ball, self.OnDropBall)
    fun.set_active(self.Ball, false)
    --LuaTimer:SetDelayFunction(20,function()
    --    self.cardView:GetCardMap()[1]:ShowBingoOrJackpot(false)
    --end)
end


function SuperMatchBingoView.OnDropBall(currNumber)
    --Event.Brocast(EventName.Test_Normal_Auto_Click, currNumber)
    --Event.Brocast(EventName.Normal_Auto_Background_Click, currNumber)
end

-- bingosleft 显示
function SuperMatchBingoView:LoadBingoleftView()
    if self.bingosleftView then
        self.bingosleftView:Show()
    end
end


function SuperMatchBingoView:on_x_update()
    if self.cardView then
        self.cardView:on_x_update()
    end

    --if self.bingoEffect then
    --    self.bingoEffect:on_x_update()
    --end
    --self:CheckReadyState()
end

function SuperMatchBingoView:OnDisable()
    --Facade.RemoveView(this)
    self:BaseDisable()
end

function SuperMatchBingoView:BaseDisable()
    if self.cardView then self.cardView:OnDisable() end
    if self.powerView then self.powerView:OnDisable() end
    if self.jackpotView then self.jackpotView:OnDisable() end
    if self.switchView then self.switchView:OnDisable() end
    if self.bingoEffect then self.bingoEffect:OnDisable() end
    if self.callNumView then self.callNumView:OnDisable() end
    if self.superMatchBingoView then self.superMatchBingoView:OnDisable() end


    self:UnRegisterEvent()
    self:ResetInitData()
end

function SuperMatchBingoView:ResetInitData()

end

function SuperMatchBingoView:OnDestroy()
    self:BaseOnDestroy()
    packageRequire:Release()
end

function SuperMatchBingoView:BaseOnDestroy()
    if self.cardView then
        self.cardView:OnDestroy()
    end
    if self.switchView then
        self.switchView:OnDestroy()
    end
    if self.jackpotView then
        self.jackpotView:OnDestroy()
    end
    if self.bingoEffect then
        self.bingoEffect.OnDestroy()
    end
    if self.callNumView then
        self.callNumView.OnDestroy()
    end
    if self.superMatchBingoView then
        self.superMatchBingoView.OnDestroy()
    end
    self.cardView = nil
    self.switchView = nil
    self.jackpotView = nil
    self.bingoEffect = nil
    self.effectObjContainer = nil
    self.superMatchBingoView = nil
    self:Destroy()
end

--获取所有的卡牌Object
function SuperMatchBingoView:GetCardMapsObject()
    if not self or not self:GetCardView() then return nil,nil,nil,nil end
    local cardView = self:GetCardView()
    if fun.is_not_null(cardView) then
        return cardView:GetAllCardMapObj()
    end

    return self.BingoMap1, self.BingoMap2, self.BingoMap3, self.BingoMap4
end

function SuperMatchBingoView:IsCardShowing(cardid)
    if not self.switchView then
        return true
    end
    cardid = tonumber(cardid)
    return BattleLogic.GetLogicModule(LogicName.SwitchLogic):IsShowing(cardid)
end
function SuperMatchBingoView:RegisterEvent()
    --Event.AddListener( EventName.Event_stop_bingo_game,self.StopBingoHandle,self)
    --Event.AddListener( Notes.BINGO_TIME_COUNT_OVER,self.TimeCountOver,self)
    --Event.AddListener( Notes.CLEAR_DELAY_TIMMER,self.RemoveDelayTime,self)
    --Event.AddListener( EventName.ShowBingoleftView,self.LoadBingoleftView,self)
    --Event.AddListener( EventName.Revert_Cards_Canvas_Alpha,self.RevertCardsCanvasAlpha,self)

    Event.AddListener(EventName.CardCellFirstSignEffect, self.OnCardCellFirstSignEffect, self)
end

function SuperMatchBingoView:UnRegisterEvent()
    --Event.RemoveListener( EventName.Event_stop_bingo_game,self.StopBingoHandle,self)
    --Event.RemoveListener( Notes.BINGO_TIME_COUNT_OVER,self.TimeCountOver,self)
    --Event.RemoveListener( Notes.CLEAR_DELAY_TIMMER,self.RemoveDelayTime,self)
    --Event.RemoveListener( EventName.ShowBingoleftView,self.LoadBingoleftView,self)

    Event.RemoveListener(EventName.CardCellFirstSignEffect, self.OnCardCellFirstSignEffect, self)
end

function SuperMatchBingoView:OnCardCellFirstSignEffect(params)
    log.log("SuperMatchBingoView:OnCardCellFirstSignEffect params is ", params)
    if not params then
        return
    end

    if self:IsInitSign(params) then --初始盖
        return
    end

    if params.isMateSign then
        self.currProgress = self.currProgress + self.mateChargeRatio
    else
        self.currProgress = self.currProgress + self.chargeRatio
    end

    self:SetChargeProgress(self.currProgress)
    self:CheckChargeReward()
end

function SuperMatchBingoView:IsInitSign(params)
    if params and params.index == 13 then
        return true
    end

    return false
end

function SuperMatchBingoView:CheckChargeReward()
    if self.currProgress < 100 then
        return
    end

    self.chargeLevel = self.chargeLevel + 1
    self.finishChargeLevel = self.finishChargeLevel + 1
    self.currProgress = self.currProgress - 100

    self:SetChargeProgress(self.currProgress)
    self:CollectChargeReward()

    if self.currProgress >= 100 then
        self:register_invoke(function()
            self:CheckChargeReward()
        end, 1)
    end
end

function SuperMatchBingoView:CollectChargeReward()
    local idx = self.finishChargeLevel
    if not self.rewardList or fun.is_table_empty(self.rewardList) then
        return
    end

    if idx > #self.rewardList then
        idx = #self.rewardList
        log.log("SuperMatchBingoView:CollectChargeReward 所给奖励不够")
    end

    local currRewardId = self.rewardList[idx].id
    local itemInfo = Csv.GetData("item", currRewardId)
    if itemInfo.item_type == 37 then
        UISound.play("supermatchreward")
        for i = 1, 8 do
            local imgIcon = self["imgIcon" .. i]
            if fun.is_not_null(imgIcon) then
                imgIcon.sprite = AtlasManager:GetSpriteByName("ItemAtlas", itemInfo.icon)
            end
        end
    else
        log.log("SuperMatchBingoView:CollectChargeReward 奖励类型有误", idx, itemInfo, self.rewardList)
        return
    end
    self.model:CollectMatchChargeReward(currRewardId)

    ---[[undo可能要播动画
    fun.set_active(self.imgIcon, true)
    AnimatorPlayHelper.Play(self.imgBox, {"act", "imgIBoxacy"}, false, function() 
        --fun.set_active(self.imgIcon, false)
    end)
    --]]
end

function SuperMatchBingoView:SetChargeProgress(ratio)
    if not ratio then
        return
    end

    if ratio < 0 then
        ratio = 0
    end

    if ratio > 100 then
        ratio = 100
    end
    if fun.is_not_null(self.progressValue) then
        self.progressValue.text = ratio .."%"
        self.progressBar.fillAmount = ratio / 100
    end
end

function SuperMatchBingoView:New(viewName,atlasName)
    local o = {viewName = viewName, atlasName = atlasName, isShow = false, isLoaded = false, changeSceneClear = true}
    self.__index = self
    setmetatable(o, self)
    return o
end

function SuperMatchBingoView:OpenCard(data)
    for i = 1, data.cardCount do
        fun.set_active(self["cell"..i],true)
    end
end

function SuperMatchBingoView:SetHead(data)
    local icon = Csv.GetData("robot_name", data.robotId, "icon")
    local name = Csv.GetData("robot_name",data.robotId,"name")
    local sysModel = ModelList.PlayerInfoSysModel
    sysModel:LoadTargetHeadSprite(icon, self.Head)
    self.Name.text = name
    sysModel:LoadRobotTargetFrameSprite(data.robotId, self.headMask)
end

function SuperMatchBingoView:CloneHandleEffect()
    local obj = fun.get_instance(self.HandEffect,self.HandEffect.transform.parent)
    fun.set_active(obj,true)
    return obj
end

function SuperMatchBingoView:GetView()
    return self.cardView
end

function SuperMatchBingoView:GetFlyPoint()
    if self.FlyPoint then
        return self.FlyPoint
    end
    return self.go
end

function SuperMatchBingoView:GetImgReapClone(parent)
    local obj = fun.get_instance(self.img_reap,parent.transform)
    fun.set_active(obj,true)
    return obj
end

return this
