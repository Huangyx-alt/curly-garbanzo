---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/12 15:53
---
local  GameCardView = require("View.Bingo.UIView.CardView.GameCardView")

---@class SingleWolfGameCardView : GameCardView
local SingleWolfGameCardView = GameCardView:New("SingleWolfGameCardView")
local this = SingleWolfGameCardView
setmetatable(SingleWolfGameCardView, {__index = GameCardView})

--- 表现层的狼人监狱层数，跟逻辑上会不一致
local wolfPrisons={}
--- 记录新bingo的类型
local newBingoType = {}
local MaxPrisonCount = 4

--- 重载激活
function SingleWolfGameCardView:OnEnable(bingoView, bingosiRef, is_open_search)
    self:BaseEnable(bingoView,bingosiRef,is_open_search)
    self:InitCardLogicData()
    self:SetDefaultOpenCell()
end

function SingleWolfGameCardView:InitCardLogicData()
    local cardCount = self.model:GetCardCount()
    for i = 1, cardCount do
        wolfPrisons[i] = {}
        wolfPrisons[i][7] = 0
        wolfPrisons[i][9] = 0
        wolfPrisons[i][17] = 0
        wolfPrisons[i][19] = 0
    end
end


function SingleWolfGameCardView:SetDefaultOpenCell()
    local cardCount = self.model:GetCardCount()
    for i = 1, cardCount do
        self.model:OnlyRefreshRoundDataByIndex(i, 7, -1)
        local cell = self:GetCardCell(i,9)
        local refTemp1 = fun.get_component(cell,fun.REFER)
        fun.set_active(refTemp1:Get("SkeletonGraphic1"),false)
        LuaTimer:SetDelayFunction(1,function()
            fun.set_active(refTemp1:Get("SkeletonGraphic1"),false)
            fun.set_active(refTemp1:Get("SkeletonGraphic1"),true)
        end,nil,LuaTimer.TimerType.Battle)
        self.model:OnlyRefreshRoundDataByIndex(i, 9, -1)
        local cell = self:GetCardCell(i,17)
        local refTemp2 = fun.get_component(cell,fun.REFER)
        fun.set_active(refTemp2:Get("SkeletonGraphic1"),false)
        LuaTimer:SetDelayFunction(2,function()
            fun.set_active(refTemp2:Get("SkeletonGraphic1"),true)
        end,nil,LuaTimer.TimerType.Battle)
        self.model:OnlyRefreshRoundDataByIndex(i, 17, -1)
        local cell = self:GetCardCell(i,19)
        local refTemp3 = fun.get_component(cell,fun.REFER)
        fun.set_active(refTemp3:Get("SkeletonGraphic1"),false)
        LuaTimer:SetDelayFunction(3,function()
            fun.set_active(refTemp3:Get("SkeletonGraphic1"),true)
        end,nil,LuaTimer.TimerType.Battle)
        self.model:OnlyRefreshRoundDataByIndex(i, 19, -1)
        newBingoType[i] = {}
    end
end

--- 影响周边格子的监狱层数
function SingleWolfGameCardView:AffectRoundCellPrison(cardId, cellIndexList, extraPos)
    cardId = tonumber(cardId)
    if cellIndexList then
        for i = 1, #cellIndexList do
            local cellIndex = cellIndexList[i]
            local cell = self:GetCardCell(cardId,cellIndex)
            local prisonCount = wolfPrisons[cardId][cellIndex] + 1
            wolfPrisons[cardId][cellIndex] = prisonCount
            self:GetCard(cardId):ReducePrison(cardId,cellIndex,prisonCount,cell,prisonCount == MaxPrisonCount,self,wolfPrisons[cardId])
        end
    end
end

--- 减少狼人监狱层数(表现上)
function SingleWolfGameCardView:ReducePrison(cardId,cellIndex)
    cardId = tonumber(cardId)
    
    local cell = self:GetCardCell(cardId,cellIndex)
    local prisonCount = wolfPrisons[cardId][cellIndex] + 1
    wolfPrisons[cardId][cellIndex] = prisonCount

    self:GetCard(cardId):ReducePrison(cardId,cellIndex,prisonCount,cell,prisonCount == MaxPrisonCount,self,wolfPrisons[cardId])
end

function SingleWolfGameCardView:GetBingoType(cardId,bingoCount)
    cardId = tonumber(cardId)
    local bingoType = {}
    table.each(wolfPrisons[cardId], function(v, k)
        if v >= MaxPrisonCount and #bingoType < bingoCount then
            table.insert(bingoType, k)
        end
    end)
    return bingoType
end

--- 把两张有jackpot的卡移动到后面
function SingleWolfGameCardView:JackpotCardMoveBackground(currCardId,moveCardId,currIndex,moveIndex)
    local card1 = self:GetCardMap(currCardId)
    local card2 = self:GetCardMap(moveCardId)
    if card2 then
        local switchPos = self:GetParentView():GetSwitchView():GetSmallCardObj(moveIndex)
        local oriPos = card2.transform.localScale
        fun.set_same_position_with(card2,switchPos)
        fun.set_gameobject_scale(card2,0.2,0.2,1)
        Anim.scale_to_xy(card2,oriPos.x,oriPos.y,1)
        local cardPos = card1.transform.position
        BattleLogic.GetLogicModule(LogicName.SwitchLogic):EnterDoubleJackpotChangeCard()
        Anim.move(card2,cardPos.x,cardPos.y,cardPos.z,1,false,true,function()
            BattleLogic.GetLogicModule(LogicName.SwitchLogic):ExitDoubleJackpotChangeCard()
        end)
    end
    if card1 then
        local currPos = card1.transform.localPosition
        Anim.move(card1,currPos.x -2000,currPos.y,currPos.z,1,true,true)
    end
end

function SingleWolfGameCardView:RegisterExtraEvent()
    Event.AddListener(EventName.Event_Move_Jackpot_Card_Background,self.JackpotCardMoveBackground,self)
end

function SingleWolfGameCardView:UnRegisterExtraEvent()
    Event.RemoveListener(EventName.Event_Move_Jackpot_Card_Background,self.JackpotCardMoveBackground,self)
end

--- 减少狼人的所有监狱层数(表现上)
function SingleWolfGameCardView:ReduceAllPrison(cardId, wolfPos)
    cardId = tonumber(cardId)

    if wolfPrisons[cardId][wolfPos] >= MaxPrisonCount then
        return
    end
    
    local cell = self:GetCardCell(cardId,wolfPos)
    wolfPrisons[cardId][wolfPos] = MaxPrisonCount

    self:GetCard(cardId):ReduceAllPrison(cardId, wolfPos, cell)
end

--- 狼族印记sign表现
function SingleWolfGameCardView:ShowWolfSignEffect(cardId, cellIndex)
    self:GetCard(cardId):ShowWolfSignEffect(cardId, cellIndex)
end

function SingleWolfGameCardView:OnShowJackpot()
    table.each(self:GetCardCell(), function(card, cardid)
        local card_ref = fun.get_component(self:GetCardMap(cardid), fun.REFER)
        local root = card_ref:Get("sign")
        table.each(card, function(cellObj)
            local signObj = fun.find_child(root, cellObj.name.."/brand")
            fun.set_active(signObj, false)
        end)
    end)
end

return this