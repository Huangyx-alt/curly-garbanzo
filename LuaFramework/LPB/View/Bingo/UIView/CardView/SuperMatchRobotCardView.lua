---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2024/6/17 14:23
---

require("Combat.GlobalMachine.DelayFuncMachine")

---@class SuperMatchRobotCardView : BaseChildView
local SuperMatchRobotCardView = BaseChildView:New();
local this = SuperMatchRobotCardView;

function SuperMatchRobotCardView:New(name)
    local o = {
        name = name
    ,cardMap = {}   --卡牌组包括所有格子
    ,cardObjMap = {}   --卡牌obj
    ,pageFrontCards ={}  --前页卡牌
    ,pageBackCards ={}  --前页卡牌
    ,clickCellMap = {} --每个卡牌棋子上的 筹码
    ,number_sprite_list = {}  --数字sprite列表
    ,reward_sprite_list = {}  --卡牌基础奖励sprite列表
    ,ball_sprite_list = {}  --号球sprite列表
    ,ball_img_num = 5 --号球图片数量
    ,parent = {}
    ,idToMap = {}
    ,waitRollOver = false  --等待达成bingo的棋子先跳起来旋转一圈,
    ,lastRollCell = {}         --达成bingo的棋子,最后一个播放特效的
    ,lastCardId = 0
    ,lastNumbers = {}
    ,loadData = {}
    ,ballList = nil                    --所有号球列表
    ,rollList = {}                     -- 横向滚动球的列表
    ,coinsPool = {}
    ,number_offset = 20
    ,hide_coin_cb = nil
    ,hide_box_cb = nil
    ,leftTxt = nil
    ,hide_card_reward_list = {}
    ,model = nil
    ,GuideAction = nil
    ,kick_call_name = nil
    ,extTable = nil
    }
    setmetatable(o, self);
    self.__index = self
    return o
end


function SuperMatchRobotCardView:LoadRequire()
    self.cardLoad = require("View.Bingo.CardModule.SuperMatchCardLoad")                       -- 卡牌加载
    self.parent = self.parent
end

function SuperMatchRobotCardView:OnEnable(bingoView, bingosiRef, is_open_search)
    self:BaseEnable(bingoView, bingosiRef, is_open_search)
end

function SuperMatchRobotCardView:BaseEnable(bingoView)
    self:LoadRequire()
    self:SetParentView(bingoView)
    self:GetControlModel()
    self:InitCardMapObj()
    self:InitParams()
    self:RegisterEvent()
    --self:InitCallNumber(bingosiRef)
    --self:InitNumberCall()
    --Event.Brocast(EventName.Magnifier_Default_Attribute, is_open_search)
end

function SuperMatchRobotCardView:InitParams()
    self.lastRollCell = {}

    self.cardLoad:SetCardView(self)
    local gameType = ModelList.BattleModel:GetGameCityPlayID()
    local cardLoadType = Csv.GetData("new_game_card",gameType,"card_load_type")
    self.cardLoad:LoadNormalCardData(self.parent.Bg)

    if self.loadData.ext then
        self.extTable = JsonToTable(self.loadData.extra)
    else
        self.extTable = {}
    end
end

function SuperMatchRobotCardView:InitCardMapObj()
    self:GetLoadingData()
    local cardCount = self.loadData.matchData.cardCount
    for i = 1, cardCount do
        if self.parent[ tostring(i)] then
            self:SetCardMapObj(i, self.parent[tostring(i)])
        else
            break
        end
    end
end



function SuperMatchRobotCardView:SetParentView(my_parent)
    self.parent = my_parent
end

function SuperMatchRobotCardView:GetParentView()
    return self.parent
end

function SuperMatchRobotCardView:GetLoadingData()
    self.loadData = self.model:LoadGameData()
end



--- 设置默认打开的格子
function SuperMatchRobotCardView:SetDefaultOpenCell()
    local beginMarkedPos = ModelList.BattleModel:GetCurrModel():LoadGameData().matchData.beginMarkedPos
    if beginMarkedPos then
        for i = 1, #beginMarkedPos do
            for m = 1, #beginMarkedPos[i].pos do
                self:SignCell(beginMarkedPos[i].cardId, ConvertServerPos(beginMarkedPos[i].pos[m]))
            end
        end
    end
end



function SuperMatchRobotCardView:GetIdToMap(cardId)
    return self.idToMap[tostring(cardId)]
end

function SuperMatchRobotCardView:GetControlModel()
    self.model = ModelList.BattleModel:GetCurrModel()
end


---获取单张卡牌的指定单元格
function SuperMatchRobotCardView:GetCardCell(cardid, index)
    cardid = tonumber(cardid)
    if index then
        if self.cardMap[cardid] then
            return self.cardMap[cardid][index]
        end
    elseif cardid then
        return self.cardMap[cardid]
    else
        return self.cardMap
    end
end

--- 只储存所有格子，这是一个快捷列表，直接设置所有格
function SuperMatchRobotCardView:SetCardCell(cardid,obj)
    cardid = tonumber(cardid)
    self.cardMap[cardid] = obj
end

function SuperMatchRobotCardView:SetSkill_cell_handler(cb)
    self.skill_cell_handler = cb
end


--初始化叫号
function SuperMatchRobotCardView:InitNumberCall ()
    self:SetSkill_cell_handler(function(owner, data)
        self:ResPowerSkill(data)
    end)

    self:RegisterEvent()
end

function SuperMatchRobotCardView:RegisterEvent()
    Event.AddListener(EventName.Event_Active_Super_Match_Card, self.ActiveMaps,self)
    Event.AddListener(EventName.Event_Sign_Super_Match_Card, self.SignCell,self)
    Event.AddListener(EventName.Event_Trigger_Super_Match, self.TriggerSuperMatch,self)
    Event.AddListener(EventName.Event_Super_Match_Tick_Sign_Card, self.TickSuperMatchSign,self)
end

function SuperMatchRobotCardView:RegisterExtraEvent()

end

function SuperMatchRobotCardView:UnRegisterEvent()
    Event.RemoveListener(EventName.Event_Active_Super_Match_Card, self.ActiveMaps,self)
    Event.RemoveListener(EventName.Event_Sign_Super_Match_Card, self.SignCell,self)
    Event.RemoveListener(EventName.Event_Trigger_Super_Match, self.TriggerSuperMatch,self)
    Event.RemoveListener(EventName.Event_Super_Match_Tick_Sign_Card, self.TickSuperMatchSign,self)
end

function SuperMatchRobotCardView:UnRegisterExtraEvent()
end



function SuperMatchRobotCardView:CoinsFlyEffect(mapIndex, pos)
    --self.effContainer:InitFlyCoins(mapIndex, pos, self:GetParentView().box)
end

function SuperMatchRobotCardView:IconFlyEffect(mapIndex, pos)
    --self.effContainer:InitFlyIcons(mapIndex, pos, self:GetParentView().box)
end



function SuperMatchRobotCardView:GetAtlasBySpriteName(sprite_name)
    if self.moduleList then
        return self.moduleList["CardItem"]:GetAtlasBySpriteName(sprite_name)
    end
end



function SuperMatchRobotCardView:OnDisable()
    self:BaseDisable()
end

function SuperMatchRobotCardView:BaseDisable()
    self:UnRegisterEvent()
    self:DisableAction()
    --self.effContainer:OnDisable()
    if self.moduleList then
        self.moduleList.UnLoadCardModule()
    end
    self:Close()
end



function SuperMatchRobotCardView:DisableAction()
    self.cardMap = {}   --卡牌组

    self.number_img_num = 10 --数字的图片数量
    self.number_sprite_list = {}  --数字sprite列表
    self.reward_sprite_list = {}  --卡牌基础奖励sprite列表
    self.ball_sprite_list = {}  --号球sprite列表
    self.ball_img_num = 5 --号球图片数量
    self.parent = {}
    self.idToMap = {}

    self.waitRollOver = false  --等待达成bingo的棋子先跳起来旋转一圈,
    self.lastRollCell = {}         --达成bingo的棋子,最后一个播放特效的
    self.lastCardId = 0
    self.lastNumbers = {}

    self.loadData = {}

    self.ballList = nil                    --所有号球列表
    self.rollList = {}                     -- 横向滚动球的列表

    self.parent = nil
    self.cardObjMap = {}
    self.pageFrontCards ={}  --前页卡牌
    self.pageBackCards ={}  --前页卡牌
    self.coinsPool = {}
    --self.number_offset = 20
    self.cardMap = {}
    --self.effContainer.OnDisable()
    self.hide_card_reward_list = {}
    self.cardLoad:OnDisable()
    --if self.GuideAction then
    --    self.GuideAction = nil
    --    ModelList.GuideModel:RestoreFirstBattle()
    --end
end


--刷新格子盖章显示
function SuperMatchRobotCardView:RefreshCardSign( card_id, card_index, sign_type, self_bingo, giftLen)
    local obj = self.cardMap[tonumber(card_id)][card_index]
    self:SignCardEffect(card_id, card_index, obj, sign_type, 0, self_bingo, giftLen)
end

---------------------------------------------------

--卡牌perfect效果
function SuperMatchRobotCardView:ShowPerfectEffect(cardId)
    self.effContainer:ShowPerfectEffect(cardId)
end



function SuperMatchRobotCardView:GetPowerupView()
    return self:GetParentView().powerView
end

---单屏最大卡牌数量
function SuperMatchRobotCardView:GetMaxCardCount()
    if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
        return 8
    else
        return 2
    end
end

function SuperMatchRobotCardView:ActiveMaps()
    self:SetDefaultOpenCell()

    for i = 1, #self.cardObjMap do
        self.cardObjMap[i]:ActiveCard(true, i)
    end
end
--- 单个盖章
function SuperMatchRobotCardView:SignCell(cardId, cellIndex)
    if  self.cardObjMap[cardId] then
        self.cardObjMap[cardId]:SignCell(cellIndex)
        log.r("sign cell "..cardId.."   "..cellIndex)
    end
end

--- 触发super match,盖章
function SuperMatchRobotCardView:TriggerSuperMatch(signInfo)
    --- 缓存数据,等效果结束的时候播放
    self.tempSignInfo = signInfo
    --for k, v in pairs(signInfo) do
    --    if self.cardObjMap[k] then
    --        self.cardObjMap[k]:PlayHandleEffect(k,v)
    --    end
    --end
end
--- 触发super match,真实盖章
function SuperMatchRobotCardView:RealTriggerSuperMatch()
    if self.tempSignInfo then
        for k, v in pairs(self.tempSignInfo) do
            if self.cardObjMap[k] then
                self.cardObjMap[k]:PlayHandleEffect(k,v)
            end
        end
        self.tempSignInfo = nil
    end
end

--- 获取super match真实盖章
function SuperMatchRobotCardView:GetSignCard()
    if self.tempSignInfo then
        local objs = {}
        for k, v in pairs(self.tempSignInfo) do
            if self.cardObjMap[k] then
                table.insert(objs, self.cardObjMap[k].go)
            end
        end
        return objs
    end
    return nil
end

--- 机器人盖章Tick,盖章
function SuperMatchRobotCardView:TickSuperMatchSign(signInfo)
    if signInfo and #signInfo>0 then
        for k,v in pairs(signInfo) do
            for i = 1, #v.pos do
                self:SignCell(v.cardId, ConvertServerPos(v.pos[i]))
            end
        end
    end
end




function SuperMatchRobotCardView:SetCardMapObj(cardId, obj)
    cardId = tonumber(cardId)
    local singleCardViewName = Csv.GetData("new_game_mode",ModelList.BattleModel:GetGameCityPlayID(),"singlecardview")
    local cardView = require("Combat.Common.View.SuperMatchSingleCardView")
    local newCard =  cardView:Clone(singleCardViewName)
    newCard:BindObj(obj,self, cardId)
    self.cardObjMap[cardId] = newCard
end

--- 获取card GameObject方法
---@return "GameObject"
function SuperMatchRobotCardView:GetCardMap(mapIndex)
    mapIndex = tonumber(mapIndex)
    if mapIndex then
        if self.cardObjMap[mapIndex] then
            return self.cardObjMap[mapIndex]:GetCardObj()
        else
            return nil
        end
    else
        return self.cardObjMap
    end
end

--- 获取card GameObject方法
---@return "GameObject"
function SuperMatchRobotCardView:GetAllCardMapObj()
    local objList = {}
    for i = 1, #self.cardObjMap do
        table.insert(objList,self.cardObjMap[i]:GetCardObj())
    end
    return objList
end


---  obsolete_获取card方法,建议使用GetCardMap 获取card GameObject
function SuperMatchRobotCardView:GetCard(mapIndex)
    mapIndex = tonumber(mapIndex)
    if mapIndex then
        return self.cardObjMap[mapIndex]
    else
        return self.cardObjMap
    end
end

function SuperMatchRobotCardView:GetCardMapList(startIndex, endIndex)
    local mapList = {}
    local mapIndex = 0
    for i = startIndex, endIndex do
        mapIndex = tonumber(i)
        table.insert(mapList, self.cardObjMap[mapIndex])
    end
    return mapList
end

--- 保存普通卡牌数字，方便调取
function SuperMatchRobotCardView:StorageNormalNumberSprites(obj)
    local sp_container = fun.get_component(obj, fun.IMAGESPRITESCONTAINER)
    if sp_container then
        for i = 1, 10 do
            local sp = sp_container:GetAsIndex(i - 1)
            self.number_sprite_list[i] =sp
        end
    end
end

--- 返回普通卡牌数字，方便调取
function SuperMatchRobotCardView:GetNormalNumberSprites(order)
    if not self.number_sprite_list or #self.number_sprite_list == 0 then
        self.number_sprite_list ={}
        if self:GetParentView().ItemContainer then
            self:StorageNormalNumberSprites(self:GetParentView().ItemContainer )
        end
        if #self.number_sprite_list == 0 and self:GetParentView().Bg then
            self:StorageNormalNumberSprites(self:GetParentView().Bg)
        end
    end
    if order == 0 then
        return self.number_sprite_list[10]
    end
    return self.number_sprite_list[order]
end

--- 设置黄色卡牌数字
function SuperMatchRobotCardView:SetYellowNumberSprites(img, order)
    Cache.GetSpriteByName("BingoAtlas", "nubYellow" .. order, function(sprite)
        img.sprite = sprite
    end)
end

--- 恢复默认卡牌数字
function SuperMatchRobotCardView:RestoreDefaultNumberSprites(img, order)
    img.sprite = self:GetNormalNumberSprites(order)
end

--- 每种卡牌 从ext拿的数据都不同，需要分开解析
---有miniGame
---wolfData
function SuperMatchRobotCardView:GetExtInfo(cardId,cellIndex,dataName)
    cardId = tonumber(cardId)

    local serverPos = ConvertCellIndexToServerPos(cellIndex)
    if not self.extTable then
        self.extTable = JsonToTable(self.loadData.extra)
    end

    if self.extTable and self.extTable[dataName] then
        for i = 1, #self.extTable[dataName] do
            if self.extTable[dataName][i].cardId == cardId and self.extTable[dataName][i].pos == serverPos then
                return self.extTable[dataName][i].freeMarkPos
            end
        end
    end

    return nil
end

--- 卡牌数据初始化完成状态
function SuperMatchRobotCardView:InitCardOver(state)
    self._isInitCardOver = state
    if state then
        self:OnCardLoadOver()
    end
end

--- 卡牌数据是否完成初始化
function SuperMatchRobotCardView:IsCardOver()
    return self._isInitCardOver
end

--- 卡牌数据初始化完成之后
function SuperMatchRobotCardView:OnCardLoadOver()

end

function SuperMatchRobotCardView:GetImgReapClone(parent)
    return self:GetParentView():GetImgReapClone(parent)
end




return this

