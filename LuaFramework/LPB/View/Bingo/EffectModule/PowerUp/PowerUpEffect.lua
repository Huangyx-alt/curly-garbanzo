---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/11 10:07
---
local  PowerUpEffect = Clazz(ClazzBase,"PowerUpEffect")
local this = PowerUpEffect

function PowerUpEffect:SetView(powerUpView)
    ---@field GamePowerUpView
    this.view = powerUpView
    this.model =  ModelList.BattleModel:GetCurrModel()
    this:InitStar()
    this.cardView = powerUpView:GetParentView():GetCardView()
end


--充能完成，呼吸效果
function PowerUpEffect:BreathEffect(is_open)
    if this.view.animator == nil then return    end

    if is_open then
        this.view.animator.enabled = true
        if this.view:IsAuto() then
            if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
                this.view.animator:Play("ready_start")
            else
                this.view.animator:Play("ready_start")
            end
        else
            this.view.animator:Play("ready_start")
        end
    else
        --this.view.animator.enabled = false
        Anim.kill_all_tween_on_object(this.view.go.gameObject)
        Anim.scale(this.view.go.gameObject,1,1,1,0.2,true)
    end
end

-- 使用卡牌 ，卡牌飞出场效果
function PowerUpEffect:PlayUsePowerEffect(index)
    if this.view.animator then
        this.view.animator:Play("idle")
        this.view.collect:Play("skill"..index)
    end
end


-- 充能星光到达，炸裂开
function PowerUpEffect:PlayStarBoom(index)
    if not this.view:IsEnoughCharge()  and not this.view:IsNoCard() then
        if this.view.animator then
            this.view.animator:Play("unll")
        end
    end
    if index  == MCT.RechargeStarCount then
        Event.Brocast(EventName.Sign_LastStar_Trigger_AutoUse)
    end
    BattleEffectPool:ShowWithAutoRecycle("ReadystartefUnll",this.view.animator.gameObject,2)
    --BattleEffectCache:GetFreePrefabFromCache2("ReadystartefUnll","PowerUpContainer",2,this.view.animator.gameObject)
end

function PowerUpEffect:GetBingoView()
    --return this.cardView:GetParentView()
    return this.view:GetParentView()
end

function PowerUpEffect:InitStar()
    this.StarTrailsList = {}
    Cache.load_prefabs(AssetList["StarTrails"], "StarTrails", function(obj)
        GoPool.CreatePool("StarTrails", 1, 15, obj, this:GetBingoView():GetEffectObjContainerGO())
    end)
end

-- powerup 星光飞到卡牌上
function PowerUpEffect:StarToCards(cell)
    return nil
    --local powerTrans = this.view:GetParentView().powerup
    --local start_position = powerTrans.transform.position
    --local end_pos = fun.get_gameobject_pos(cell, false)
    --local star_count = 5
    --local delay = 0
    --local offset = 0
    --this.firstStar = true
    --for i = 1, star_count do
    --    local obj = this:GetStarTrailsObj()
    --    fun.set_same_position_with(obj, powerTrans)
    --    local path = {}
    --    path[1] = fun.calc_new_position_between(start_position, end_pos, 0.45 + offset, 1, 0)
    --    offset = offset + 0.1
    --    path[2] = end_pos
    --    Anim.bezier_move(obj, path, MCT.powerup_star_to_card, delay, 1, 2, function()
    --        this:RecycleStarTrailsObj()
    --    end)
    --    delay = delay + 0.1
    --end
end

--- 当双数字背景框空白的时候，设置一次背景图片，否则保持默认
local SetDoubleCellBgSkin = function(doubleBg)
    local img = fun.get_component(doubleBg, fun.IMAGE)
    if not img.sprite or Util.IsNull(img.sprite) then
        local playId = ModelList.CityModel.GetPlayIdByCity()
        --local cardResourceId = Csv.GetData("new_city_play",playId,"card_resources")
        local cell_theme = Csv.GetData("new_city_play",playId,"card_resources")
        if cell_theme and #cell_theme > 0 then
            --img.sprite =  AtlasManager:GetSpriteByName(cell_theme[2],cell_theme[4])
            --Cache.load_sprite(AssetList[cell_theme[1]],resource,function(sprite)
            --    if sprite then
            --        local img = fun.get_component(doubleBg, fun.IMAGE)
            --        img.sprite = sprite
            --    end
            --end)
        end
        --
        --local resource = "bcard0"..cardResourceId.."s"
        --Cache.load_sprite(AssetList[resource],resource,function(sprite)
        --    if sprite then
        --        local img = fun.get_component(doubleBg, fun.IMAGE)
        --        img.sprite = sprite
        --    end
        --end)
    end
end

function PowerUpEffect:SetDoubleNumberWithTMP(obj, new_num,cardId,cellIndex)
    local temp_ref = fun.get_component(obj, fun.REFER)
    local Number1 = temp_ref:Get("Number1")
    local Number2 = temp_ref:Get("Number2")
    
    fun.set_active(Number1, true)
    fun.set_active(Number2, true)
    
    fun.set_rect_local_pos(Number1, -23, 32)
    fun.set_gameobject_scale(Number1.gameObject, 0.85, 0.85, 1)    
    fun.set_rect_local_pos(Number2, 23, -32)
    fun.set_gameobject_scale(Number2.gameObject, 0.85, 0.85, 1)
    
    local doublebg = temp_ref:Get("doublebg")
    --SetDoubleCellBgSkin(doublebg)
    fun.set_active(doublebg, true)
    
    --设置号码
    Number2.text = new_num
    
    --取消放大镜动画
    local anim = temp_ref:Get("gift")
    fun.play_animator(anim, "idle", true)
end

function PowerUpEffect:SetDoubleNumber(obj, new_num,cardId,cellIndex)
    local temp_ref = fun.get_component(obj, fun.REFER)
    local number1 = temp_ref:Get("number1")
    local number2 = temp_ref:Get("number2")
    local number3 = temp_ref:Get("number3")
    local number4 = temp_ref:Get("number4")
    local gameType = ModelList.BattleModel:GetGameCityPlayID()
    local doub_num_pos = Csv.GetData("new_game_cell",gameType,"double_num_pos")
    local doub_num_scale = Csv.GetData("new_game_cell",gameType,"double_num_scale")
    fun.set_rect_local_pos(number1, doub_num_pos[1][1], doub_num_pos[1][2])
    fun.set_rect_local_pos(number2, doub_num_pos[2][1], doub_num_pos[2][2])
    fun.set_rect_local_pos(number3, doub_num_pos[3][1], doub_num_pos[3][2])
    fun.set_rect_local_pos(number4, doub_num_pos[4][1], doub_num_pos[4][2])
    if doub_num_scale[1][1] > 0 then
        fun.set_gameobject_scale(number1.gameObject, doub_num_scale[1][1], doub_num_scale[1][2], 1)
    end
    if doub_num_scale[2][1] > 0 then
        fun.set_gameobject_scale(number2.gameObject, doub_num_scale[2][1], doub_num_scale[2][2], 1)
    end
    if doub_num_scale[3][1] > 0 then
        fun.set_gameobject_scale(number3.gameObject, doub_num_scale[3][1], doub_num_scale[3][2], 1)
    end
    if doub_num_scale[4][1] > 0 then
        fun.set_gameobject_scale(number4.gameObject, doub_num_scale[4][1], doub_num_scale[4][2], 1)
    end
    
    fun.set_active(number1, true)
    fun.set_active(number2, true)
    
    local doublebg = temp_ref:Get("doublebg")
    --SetDoubleCellBgSkin(doublebg)
    fun.set_active(doublebg, true)
    --设置号码
    if new_num > 9 then
        local first_num = math.modf(new_num / 10)
        local second_num = math.modf(new_num % 10)
        if second_num == 0 then
            second_num = 10
        end
        number3.gameObject:SetActive(true)
        number3.sprite = this.cardView:GetNormalNumberSprites(first_num)
        number4.gameObject:SetActive(true)
        number4.sprite = this.cardView:GetNormalNumberSprites(second_num)
    else
        local first_num = math.modf(new_num % 10)
        number4.gameObject:SetActive(true)
        number4.sprite = this.cardView:GetNormalNumberSprites(first_num)
        number3.gameObject:SetActive(false)
    end
    --if this.model:IsWishState(cardId,cellIndex) then
    --    log.r("GetCellBasketReward")
    --    Event.Brocast(EventName.CardBingoEffect_DoubleNumWish,temp_ref)
    --end

    --取消放大镜动画
    local anim = temp_ref:Get("gift")
    fun.play_animator(anim, "idle", true)
end


function PowerUpEffect:Register()
    Event.AddListener(EventName.PowerUpEffect_Sign_To_Card,this.StarToCards)
    Event.AddListener(EventName.PowerUpEffect_Breath,this.BreathEffect)
    Event.AddListener(EventName.PowerUpEffect_Power_Card_Exit,this.PlayUsePowerEffect)
    Event.AddListener(EventName.PowerUpEffect_Star_Reach_Power,this.PlayStarBoom)
    --Event.AddListener(EventName.PowerUpEffect_DoubleNum,this.SetDoubleNumber)
    Event.AddListener(EventName.PowerUpEffect_DoubleNum,this.SetDoubleNumberWithTMP)
end

function PowerUpEffect:UnRegister()
    Event.RemoveListener(EventName.PowerUpEffect_Sign_To_Card,this.StarToCards)
    Event.RemoveListener(EventName.PowerUpEffect_Breath,this.BreathEffect)
    Event.RemoveListener(EventName.PowerUpEffect_Power_Card_Exit,this.PlayUsePowerEffect)
    Event.RemoveListener(EventName.PowerUpEffect_Star_Reach_Power,this.PlayStarBoom)
    --Event.RemoveListener(EventName.PowerUpEffect_DoubleNum,this.SetDoubleNumber)
    Event.RemoveListener(EventName.PowerUpEffect_DoubleNum,this.SetDoubleNumberWithTMP)
end

return this