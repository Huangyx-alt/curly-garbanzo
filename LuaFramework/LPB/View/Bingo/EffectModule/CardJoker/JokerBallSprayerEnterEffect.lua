---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/6/15 18:36
---

---- 小丑卡喷球器入场效果

local BaseCardJokerEffect  =  require("View.Bingo.EffectModule.CardJoker.BaseCardJokerEffect")

local JokerBallSprayerEnterEffect = BaseCardJokerEffect:New()
local this = JokerBallSprayerEnterEffect

function JokerBallSprayerEnterEffect:New()
    local o = { isLoaded = false, changeSceneClear = true}
    self.__index = self
    setmetatable(o, self)
    return o
end

---基类继承
function JokerBallSprayerEnterEffect:SetInfo(info,parentObj,parentRef)
    ModelList.BattleModel.SetHasJokerBallSprayer(true)
    local obj = parentRef:GetPreloadPrefab("clowndaoju_paotai")
    self.clowndaoju_getxiao = parentRef:GetPreloadPrefab("clowndaoju_getxiao")
    if obj then
        fun.set_parent(obj,parentObj,true)
        self.go = obj
    else
        Cache.load_prefabs(AssetList["clowndaoju_paotai"],"clowndaoju_paotai",function (prefab)
            if prefab then
                local obj = fun.get_instance(prefab)
                if obj then
                    fun.set_parent(obj,parentObj,true)
                    self.go = obj
                end
            end
        end)
    end
end

--- 播放喷球器入场效果
--- 飞往叫号球区域
function JokerBallSprayerEnterEffect:Play()
    fun.set_active(self.go,true)
    LuaTimer:SetDelayFunction(1,function()
        self:Fly()
    end)

end

function JokerBallSprayerEnterEffect:Fly()
        if self.go then
            local jokerParent = ModelList.BattleModel:GetCurrBattleView():GetCallNumberView():GetJokerParent()
            if jokerParent then
                fun.set_parent(self.go,jokerParent.transform)
                self.go.transform.localScale = Vector3.one
                Anim.move(self.go,0,0,1,0.3,true,false,function ()
                    self:PlayOver()
                    self:PlayEffect(jokerParent)
                end)
            end
    end
end


function JokerBallSprayerEnterEffect:PlayEffect(targetCell)
    if self and fun.is_not_null(self.clowndaoju_getxiao) then
        if self.clowndaoju_getxiao and targetCell then
            fun.set_parent(self.clowndaoju_getxiao,targetCell.transform,true)
            fun.set_active(self.clowndaoju_getxiao,true)
            Destroy(self.clowndaoju_getxiao,2)
        end
    else
        Cache.load_prefabs(AssetList["clowndaoju_getxiao"],"clowndaoju_getxiao",function (prefab)
            if prefab then
                local obj = fun.get_instance(prefab)
                if obj and targetCell then
                    fun.set_parent(obj,targetCell.transform,true)
                    fun.set_active(obj,true)
                    Destroy(obj,2)
                end
            end
        end)
    end
end

function JokerBallSprayerEnterEffect:PlayOver()
    log.r("JokerBallSprayerEnterEffect:PlayOver")
end

---预加载依赖的资源
function JokerBallSprayerEnterEffect:PreloadDependResource(callBack,callback2,index)
    --Cache.load_prefabs(AssetList["clowndaoju_paotai"], "clowndaoju_paotai", function(prefab)
    --    Cache.load_prefabs(AssetList["clowndaoju_getxiao"], "clowndaoju_getxiao", function(prefab)
    --        if callBack then
    --            callBack()
    --        end
    --    end)
    --end)

    this:CoroutineLoadResource(function()
        --coroutine.wait(index)
        Cache.load_prefabs(AssetList["clowndaoju_paotai"], "clowndaoju_paotai", function(prefab)
            if prefab then
                local instance = fun.get_instance(prefab)
                log.r("instance clowndaoju_paotai")
                if callback2 then
                    callback2(instance,"clowndaoju_paotai")
                end
            end
        end)
        --coroutine.wait(0.5)
        --WaitForFixedUpdate()
        Cache.load_prefabs(AssetList["clowndaoju_getxiao"], "clowndaoju_getxiao", function(prefab)
            if prefab then
                local instance = fun.get_instance(prefab)
                log.r("instance clowndaoju_getxiao")
                if callback2 then
                    callback2(instance,"clowndaoju_getxiao")
                end
            end
        end)
        if callBack then
            callBack()
        end
    end)

end

return this