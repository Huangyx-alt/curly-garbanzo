---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/9 9:50
---
local  CardDelayAnima = Clazz(ClazzBase,"CardDelayAnima")
local this = CardDelayAnima



this.delay_anima_list = {}

function CardDelayAnima:SetCardView(cardView)
    this.cardView = cardView
    this.delay_anima_list = {}
    this:LoadAnimator()
    this.model =  ModelList.BattleModel:GetCurrModel()
end

function CardDelayAnima:LoadAnimator()
    AnimatorPlayer.Creat(this)
end

function CardDelayAnima:on_x_update()
    this:CheckDelayAnimaPlay()
end

function CardDelayAnima:AddDelayAnima(ani, play_name, delay, duration, signType, cardid, pos)
    --检查是否有相同的，有的话覆盖成最新的动画设置
    signType = signType or 0
    cardid = cardid or 0
    pos = pos or -1
    local can_add = true
    --log.r( "AddDelayAnima    "..ani.transform.parent.parent.parent.transform.parent.parent.name .."       "..ani.transform.parent.parent.name.."     "..signType.."    x  "..duration)

    --不覆盖，可以播放多次盖章效果
    --for i = #this.delay_anima_list, 1, -1 do
    --    if (this.delay_anima_list[i].anima == ani) then
    --        if this.delay_anima_list[i].sign > signType then
    --            can_add = false
    --        else
    --            cardid = this.delay_anima_list[i].cardId
    --            pos = this.delay_anima_list[i].index
    --            table.remove(this.delay_anima_list, i)
    --            --log.r( "remove    "..ani.transform.parent.parent.parent.transform.parent.parent.name .."       "..ani.transform.parent.parent.name.."    1  "..this.delay_anima_list[i].playName)
    --        end
    --    end
    --end
    
    if can_add then
        local add_anima = { anima = ani, playName = play_name, endTime = delay + UnityEngine.Time.time, durationTime = duration, startTime = UnityEngine.Time.time, sign = signType,
                            cardId = cardid, index = pos }
        table.insert(this.delay_anima_list, add_anima)
        if signType > 0 then
            --log.r(ani.transform.parent.parent.parent.transform.parent.parent.name .."       "..ani.transform.parent.parent.name.."    1  "..play_name)
        end
    end
end


function CardDelayAnima:GetBingoEffectName(sign,self_bingo)
    local play_name =""
    if self_bingo then
        if sign == 2 then
            play_name = "ef_Bingopcard_click_bingo_show"
        elseif sign == 3 then
            play_name = "ef_Bingopcard_click_jackpot_show_blue"
        end
    else
        if sign == 1 then
            play_name = "bingo_show_red"
        elseif sign == 2 then
            play_name = "bingo_show"
        elseif sign == 3 then
            play_name = "jackpot_show"
        end
    end
    return play_name
end


function CardDelayAnima:CheckDelayAnimaPlay()
    for i = #this.delay_anima_list, 1, -1 do
        if (this.delay_anima_list[i].endTime <= UnityEngine.Time.time) then
            local ani = this.delay_anima_list[i].anima
            if fun.is_not_null(ani) then
                local play_name = this.delay_anima_list[i].playName
                --local state_info = ani:GetCurrentAnimatorStateInfo(0)
                if this.delay_anima_list[i].index >= 0 then
                    local cardid = this.delay_anima_list[i].cardId
                    local index = this.delay_anima_list[i].index
                    local data = this.model:GetRoundData(cardid, index)
                    if data.sign - 1 > this.delay_anima_list[i].sign then
                        play_name = this:GetBingoEffectName(data.sign,data.self_bingo)
                    end
                end
                fun.set_active(ani.transform.gameObject,true)
                if fun.is_not_null(this.animatorPlayer) then
                    this.animatorPlayer:Play(ani, play_name, this.delay_anima_list[i].durationTime, nil, false)
                end
                table.remove(this.delay_anima_list, i)
            end
        end
    end
end

function CardDelayAnima:OnDisable()
    AnimatorPlayer.Release(this)
end


return this