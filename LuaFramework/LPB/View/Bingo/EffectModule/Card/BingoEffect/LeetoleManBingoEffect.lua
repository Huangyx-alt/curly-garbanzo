---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/18 11:27
---
local BaseBingoEffect = require("View.Bingo.EffectModule.Card.BingoEffect.BaseBingoEffect")

local LeetoleManBingoEffect = BaseBingoEffect:New("LeetoleManBingoEffect")
local this = LeetoleManBingoEffect
setmetatable(LeetoleManBingoEffect, BaseBingoEffect)
local private = {}

function LeetoleManBingoEffect:ShowBingoOrJackpot(bingoData)
    for k, v in pairs(bingoData) do
        local mIndex = k
        local bingoType, currType = private.GetBingoCount(self, mIndex, v.bingo)
        if v.jackpot == 0 then
            local anima_name = self:GetBingoAnimaName(v.bingo)
            Event.Brocast(EventName.Box_Bingo_Coins, v.bingo)
            self:BingoEffect(mIndex, anima_name, v.first_num, mIndex, bingoType, currType)
        else
            Event.Brocast(EventName.Box_Bingo_Coins,0)
            BattleLogic.GetLogicModule(LogicName.Card_logic):ReduceRocketBingo()
            self:JackpotEffect(mIndex, "jackpot", v.first_num, mIndex)
        end
    end
end

---@see  显示Bingo 特效
function LeetoleManBingoEffect:BingoEffect(mapindex, anima_name, cellIndex, cardid, bingoType, currType)
    local par = self.cardView:GetCardMap(mapindex)
    ModelList.BattleModel:GetCurrBattleView():PlayBackgroundAction("change")
    self.cardView:GetCard(cardid):PlayLeeToleManBingoAction()

    local bingoCount = #bingoType
    --BattleEffectCache:GetPrefabFromCache("LeetoleManBingo"..bingoCount, nil, function(eff1)
    --    if eff1 then
    --        private.PlayBingoAudio(bingoCount)
    --        fun.set_parent(eff1, par,false)
    --        fun.set_rect_anchored_position(eff1, 0, 0)
    --        self:SetBingoShow(currType, eff1)
    --        self:ChangeSignCellColor(mapindex, currType)
    --
    --        if ModelList.BattleModel:IsRocket() then
    --            fun.set_gameobject_scale(eff1,1,1,1)
    --        end
    --        local anima = fun.get_component(eff1,fun.ANIMATOR)
    --        anima:Play("start",0,0)
    --
    --        local cell_obj_pos = self.cardView:GetCardCell(mapindex,13)
    --        if cell_obj_pos then
    --            if ModelList.TournamentModel:CheckOpenTournament() then
    --                self:GetCardView():GetParentView():ShowIconFlyEffect(mapindex, cell_obj_pos.transform.position)
    --            else
    --                self:GetCardView():GetParentView():ShowCoinFlyEffect(mapindex, cell_obj_pos.transform.position)
    --            end
    --        end
    --
    --        private.CacheEffect(self, cardid, bingoCount, eff1)
    --        LuaTimer:SetDelayFunction(3, function()
    --            private.DestroyEffect(self, cardid, bingoCount)
    --        end)
    --        --Destroy(eff1,3)
    --    else
    --        log.r("hangup_bingo  null")
    --    end
    --    Event.Brocast(EventName.Event_SwitchCard_BingoEffect,mapindex)
    --    self:ShowEffectOnSmallCard(eff1,mapindex,0)
    --end,cardid)

    BattleEffectCache:GetPrefabFromPoolOrCache("LeetoleManBingo"..bingoCount, nil, function(eff1)
        if eff1 then
            private.PlayBingoAudio(bingoCount)
            fun.set_parent(eff1, par,false)
            fun.set_rect_anchored_position(eff1, 0, 0)
            self:SetBingoShow(currType, eff1)
            self:ChangeSignCellColor(mapindex, currType)

            if ModelList.BattleModel:IsRocket() then
                fun.set_gameobject_scale(eff1,1,1,1)
            end
            local anima = fun.get_component(eff1,fun.ANIMATOR)
            anima:Play("start",0,0)

            local cell_obj_pos = self.cardView:GetCardCell(mapindex,13)
            if cell_obj_pos then
                if ModelList.TournamentModel:CheckOpenTournament() then
                    self:GetCardView():GetParentView():ShowIconFlyEffect(mapindex, cell_obj_pos.transform.position)
                else
                    self:GetCardView():GetParentView():ShowCoinFlyEffect(mapindex, cell_obj_pos.transform.position)
                end
            end

            private.CacheEffect(self, cardid, bingoCount, eff1)
            LuaTimer:SetDelayFunction(3, function()
                private.DestroyEffect(self, cardid, bingoCount)
            end)
            --Destroy(eff1,3)
        else
            log.r("hangup_bingo  null")
        end
        Event.Brocast(EventName.Event_SwitchCard_BingoEffect,mapindex)
        self:ShowEffectOnSmallCard(eff1,mapindex,0)
    end,cardid)
end

---@see  显示Jackpot 特效
function LeetoleManBingoEffect:JackpotEffect(mapindex,anima_name,cellIndex, cardid)
    ModelList.BattleModel:GetCurrBattleView():GetCardView():GetCard(cardid):ForbidCollider()
    --if not self:GetCardView():GetParentView():IsCardShowing(tonumber(cardid) ) then return end
    local par = self.cardView:GetCardMap(mapindex)
    local pos = par.transform.position
    local bingoType,currType = private.GetBingoCount(self, mapindex,4)
    if #bingoType == 0 then return end
    BattleEffectCache:GetPrefabFromCache("LeetoleManJakcpot",par,function(eff1)
        if eff1 then
            private.PlayBingoAudio(4)
            eff1.gameObject.name = "LeetoleManJakcpot"
            eff1.gameObject:SetActive(false)
            fun.set_parent(eff1, par,true)
            fun.set_rect_anchored_position(eff1,0,0)
            eff1.gameObject:SetActive(true)
            
            self:ChangeSignCellColor(mapindex, currType)
            --local anima = fun.get_component(eff1, fun.ANIMATOR)
            --anima:Play("Jakcpot",0,0)

            --Spine 动画
            local ref = fun.get_component(eff1, fun.REFER)
            local spine = ref:Get("spine")
            spine:SetAnimation("start", nil, false, 0)
            spine:AddAnimation("idle", nil, true, 0)
            
            local cell_obj_pos = self.cardView:GetCardCell(mapindex,13)
            if cell_obj_pos then
                if ModelList.TournamentModel:CheckOpenTournament() then
                    self:GetCardView():GetParentView():ShowIconFlyEffect(mapindex, cell_obj_pos.transform.position)
                else
                    self:GetCardView():GetParentView():ShowCoinFlyEffect(mapindex, cell_obj_pos.transform.position)
                end
            end
        else
            log.r("hangup_bingo  null")
        end
        Event.Brocast(EventName.Event_SwitchCard_JackpotEffect,mapindex)
        self:ShowEffectOnSmallCard(eff1, mapindex, 2)
    end, cardid, 2)
end

--- 在卡牌缩略图上显示bingo  jackpot效果
function LeetoleManBingoEffect:ShowEffectOnSmallCard(clone,cardId,effectType)
    if ModelList.BattleModel:IsRocket() then return end
    local isShowing = BattleLogic.GetLogicModule(LogicName.SwitchLogic):IsShowing(cardId)
    local obj =  self.cardView:GetParentView():GetSwitchView():GetSmallCardObj(cardId)
    local newEffect = fun.get_instance(clone,obj)
    fun.set_parent(newEffect,obj,true)
    fun.set_gameobject_scale(newEffect,0.2,0.2,1)
    fun.set_active(newEffect,not isShowing)
    Util.SetRaycastTarget(newEffect,false)
    if effectType == 0 then
        Event.Brocast(EventName.Event_Show_SwitchView_Small_Card_Bingo,cardId,newEffect)
        --self.cardView:GetParentView():GetSwitchView():StorageSwitchEffect(0,newEffect,cardId)
    else
        Event.Brocast(EventName.Event_Show_SwitchView_Small_Card_Jackpot,cardId,newEffect)

        --self.cardView:GetParentView():GetSwitchView():StorageSwitchEffect(1,newEffect,cardId)
    end
end

--- 同道具的格子要变色
function LeetoleManBingoEffect:ChangeSignCellColor(cardId,bowlType)
    local cells = BattleLogic.GetLogicModule(LogicName.Card_logic):GetCellsByMaterialType(cardId,bowlType)
    for i = 1, #cells do
        local effectList =  self.cardView:GetCellBgEffect(cardId,cells[i].index)
        if effectList then
            for m = 1, #effectList do
                local an = fun.get_component(effectList[m],fun.ANIMATOR)
                if an then
                    an:Play("change")
                end
            end
        end
    end
end

function LeetoleManBingoEffect:SetBingoShow(bingoType, obj)
    local refCom = fun.get_component(obj, fun.REFER)
    if refCom then
        local o = refCom:Get(string.format("SDBingo0%s", bingoType))
        fun.set_active(o, true)
    end
end

-----------------私有方法----------------------------------------------

function private.GetBingoCount(self, cardId, bingoCount)
    return self:GetCardView():GetBingoType(cardId, bingoCount)
end

function private.PlayBingoAudio(bingoCount)
    if bingoCount == 1 then
        UISound.play("stpatrick_bingo2")
        LuaTimer:SetDelayFunction(0.5, function()
            UISound.play("Bingo")
        end)
    elseif bingoCount == 2 then
        UISound.play("stpatrick_doubleBingo")
        LuaTimer:SetDelayFunction(1, function()
            UISound.play("DoubleBingo")
        end)
    elseif bingoCount == 3 then
        UISound.play("stpatrick_tripleBingo")
        LuaTimer:SetDelayFunction(1, function()
            UISound.play("TripleBingo")
        end)
    elseif bingoCount == 4 then
        UISound.play("stpatrick_jackpot2")
        LuaTimer:SetDelayFunction(0.65, function()
            UISound.play("JACKPOT")
        end)
    end
end

--缓存播放中的effect，当短时间内出现多个效果时，只保留最后显示的效果
function private.CacheEffect(self, cardId, bingoCount, effectObj)
    self.effect_cache = self.effect_cache or {}
    self.effect_cache[cardId] = self.effect_cache[cardId] or {}
    local temp = self.effect_cache[cardId]
    
    --销毁其他特效
    table.each(temp, function(obj, count)
        if count < bingoCount then
            private.DestroyEffect(self, cardId, count)
            temp[count] = nil
        end
    end)
    
    temp[bingoCount] = effectObj
end

--销毁特效，处理缓存数据
function private.DestroyEffect(self, cardId, bingoCount)
    if not self.effect_cache or not self.effect_cache[cardId] then
        return
    end
    
    local effObj = self.effect_cache[cardId][bingoCount]
    if not fun.is_null(effObj) then
        --Destroy(effObj)
        BattleEffectPool:Recycle("LeetoleManBingo"..bingoCount, effObj)
        self.effect_cache[cardId][bingoCount] = nil
    end
end

return this