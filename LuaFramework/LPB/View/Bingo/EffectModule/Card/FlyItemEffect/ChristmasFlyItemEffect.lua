---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/17 12:38
---

---  圣诞节玩法 格子盖章效果
local BaseFlyItemEffect =  require("View.Bingo.EffectModule.Card.FlyItemEffect.BaseFlyItemEffect")
local ChristmasFlyItemEffect = BaseFlyItemEffect:New("ChristmasFlyItemEffect")
setmetatable(ChristmasFlyItemEffect,BaseFlyItemEffect)
local this = ChristmasFlyItemEffect

local DrinkType = {WaiZi = 1,LingDang = 2,GuaiZhang = 3,XueQiu = 4}

function ChristmasFlyItemEffect:Remove()
    Event.RemoveListener(EventName.Event_Collect_Item_By_Sign,self.FlyItemToBowl,self)
    Event.RemoveListener(EventName.Event_Christmas_GingerbreadMan_Effect,self.GingerbreadManEffect,self)
end


function ChristmasFlyItemEffect:Register()
    Event.AddListener(EventName.Event_Collect_Item_By_Sign,self.FlyItemToBowl,self)
    Event.AddListener(EventName.Event_Christmas_GingerbreadMan_Effect,self.GingerbreadManEffect,self)
end

function ChristmasFlyItemEffect:FlyItemToBowl(cardId, cellIndex)
    this:CreateDrinks(cardId,cellIndex)
end

--- 再格子底部创建 酒水道具
function ChristmasFlyItemEffect:CreateDrinks(cardId, cellIndex)
    local drinkItem = self.model:GetRoundData(cardId,cellIndex):GetDrinks()
    local totalCount = 0
    for i = 1, #drinkItem do
        if Csv.GetData("item",drinkItem[i].id,"result")[1] == 14 then
            totalCount = totalCount + 1
        end
    end
    local order = 0
    for i = 1, #drinkItem do
        local data = Csv.GetData("item",drinkItem[i].id)
        if  data.result[1] == 14  then
            order = order + 1
            if  not self:GetCardView():IsDrinkMax(cardId,data.result[2]) then
                this:CreateDrink(cardId, cellIndex,data.result[2],false ,totalCount,order)
            else
                this:CreateDrink(cardId, cellIndex,data.result[2] ,true,totalCount,order)
            end
        end
    end
end

function  ChristmasFlyItemEffect:GetDrinkFlyTime(cardId,drinkType,fly)
    local targetPos = self:GetCardView():GetWineBowlPos(cardId,drinkType)
    local dis = Vector3.Distance(targetPos,fly.transform.position)
    return dis / 4 * 1.1, targetPos
end

local function GetGiftAnimaName(totalCount,order)
    if totalCount == 1 or (totalCount == 3 and order == 3) then
        return "in1"
    elseif totalCount == 2 then
        return "in2"..order
    elseif totalCount == 3 and order <= 2 then
        return "in2"..order
    else
        return "in1"
    end
end

function ChristmasFlyItemEffect:CreateDrink( cardId, cellIndex,drinkType,isOver,totalCount,order)
    local effectName = ""
    if drinkType == 1 then  -- 红色酒杯
        effectName ="Christmasclickwazi"
    elseif drinkType== 2 then
        effectName ="Christmasclicklingdang"
    elseif drinkType == 3 then
        effectName ="Christmasclickguaizhang"
    elseif drinkType == 4 then
        effectName ="Christmasclickxueqiu"
    end
    local obj = self.model:GetRoundData(cardId, cellIndex):GetCellObj()
    local flyObj =  BattleEffectPool:GetAndBind(effectName,obj,cardId,5,true)
    --BattleEffectPool:DelayRecycle(effectName,flyObj,8)
    local flyAnim = fun.get_component(flyObj,fun.ANIMATOR)
    if isOver then
        flyAnim:Play("over")
    else
        Event.Brocast(EventName.Event_Logic_Collect_Item, cardId, cellIndex, drinkType, 1)
        Event.Brocast(EventName.Event_Christmas_Sign_Cell_Background, drinkType,cardId,cellIndex)
         flyAnim:Play(GetGiftAnimaName(totalCount,order))
        UISound.play("christmas_flyin")
        LuaTimer:SetDelayFunction(1, function()
            if not self:GetCardView() then return end
            fun.set_same_position_with(flyObj.transform.parent.gameObject, self:GetCardView():GetCardCell(tonumber(cardId), cellIndex))
            local moveTime ,targetPos = self:GetDrinkFlyTime(cardId,drinkType,flyObj)
            local coverObj = UnityEngine.GameObject.New()
            fun.set_parent(coverObj, flyObj.transform.parent, true)
            coverObj.transform.position = targetPos
            local localTargetPos = fun.get_gameobject_pos(coverObj, true)
            --log.r("  ori  localTargetPos   "..localTargetPos.x.."         "..localTargetPos.y)
            --log.r("  ori  targetPos   "..targetPos.x.."         "..targetPos.y)
            local cellPos = self:GetCardView():GetCardCell(tonumber(cardId), cellIndex).transform.position
            --log.r("  ori  cellPos   "..cellPos.x.."         "..cellPos.y)
            localTargetPos = localTargetPos - fun.get_child(flyObj.transform, 0).localPosition
            Destroy(coverObj)
            Anim.move(flyObj,localTargetPos.x,localTargetPos.y,localTargetPos.z,moveTime,true,true,function()
                flyAnim:Play("out")
                Event.Brocast(EventName.Event_View_Collect_Item, cardId, drinkType)
            end)

        end)
    end
end

function ChristmasFlyItemEffect:GingerbreadManEffect(cardId,cellIndex)
    --local target = self.model:GetRoundData(cardId, cellIndex):GetCellObj()
    local target = self.cardView:GetCardMap(cardId)
    local drinkType = BattleLogic.GetLogicModule(LogicName.Card_logic):GetSingleBingoBowl(cardId)
    Event.Brocast(EventName.Event_Logic_Collect_Item,cardId,cellIndex,drinkType,1,true)
    BattleEffectCache:GetSkillPrefabFromCache("JnChristmasjiangbren", target, function(Ob)
        local flyAnim = fun.get_component(Ob,fun.ANIMATOR)
        if drinkType == 1 then flyAnim:Play("wazi")
            elseif drinkType == 2 then flyAnim:Play("ldang")
            elseif drinkType == 3 then flyAnim:Play("mofab")
            elseif drinkType == 4 then flyAnim:Play("qiu") end
        UISound.play("christmas_Gingersnap")
        self:SameScaleWithCard(Ob, cardId)
        LuaTimer:SetDelayFunction(1.8, function()
            --local moveTime, targetPos = self:GetDrinkFlyTime(cardId, drinkType, Ob)
            --Anim.move(Ob,targetPos.x,targetPos.y,targetPos.z,moveTime,false,true,function()
            --    Event.Brocast(EventName.Event_View_Collect_Item,cardId,drinkType,true)
            --end)
            Event.Brocast(EventName.Event_View_Collect_Item, cardId, drinkType, true)
        end)
    end,5,cardId)
end

return this



