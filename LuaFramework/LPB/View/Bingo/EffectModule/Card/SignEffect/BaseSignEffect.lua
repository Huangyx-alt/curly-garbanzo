---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/13 12:12
---
--- 格子盖章效果

local BaseSignEffect = {}
local this = BaseSignEffect
BaseSignEffect.__index = BaseSignEffect
require("View/Bingo/EffectPool/GoPool")
this.StarTrailsList = {}
local rewardXp =0
local rewardCoin =0
--- 是否需要隐藏格子背景bg_tip
local isNeedHideBg = 0
---杯赛单格子奖励数值
local competitionReward = -1

function BaseSignEffect:SetCardView(cardView, effect)
    this.cardView = cardView
    this.effectEntry = effect
    this.model = ModelList.BattleModel:GetCurrModel()
    Cache.load_prefabs(AssetList["StarTrails"], "StarTrails", function(obj)
        if obj and this:GetBingoView() and this:GetBingoView():GetEffectObjContainerGO() then
            GoPool.CreatePool("StarTrails", 2, 30, obj, this:GetBingoView():GetEffectObjContainerGO())
        end
    end)
    this.StarTrailsList = {}
    local city_id = ModelList.CityModel.GetPlayIdByCity()
    --local curr_city = Csv.GetData("new_city_play", city_id, "callreward")
    local curr_bet = ModelList.CityModel:GetBetRate()
    local gameType = ModelList.BattleModel:GetGameCityPlayID()
    isNeedHideBg =  Csv.GetData("new_game_cell", gameType, "hide_bg") == 1 and true or false
    --rewardXp = curr_city[curr_bet][2]
    --rewardCoin = curr_city[curr_bet][3]
    this.supplement = require("View.Bingo.EffectModule.Card.CardEffectSupplement.CardSignSupplement")
    this.supplement:Init()
    self:RegisterEvent()
    competitionReward = -1
end

function BaseSignEffect:Remove()
    self:UnRegisterEvent()
end


function BaseSignEffect:RegisterEvent()
end


function BaseSignEffect:UnRegisterEvent()
end

function BaseSignEffect:GetCardView()
    return self.cardView
end

function BaseSignEffect:GetBingoView()
    return self.cardView:GetParentView()
end

function BaseSignEffect:GetPowerUpView()
    return self.cardView:GetParentView().powerup
end

function BaseSignEffect:GetCellSignType(cardId,cellIndex)
    return self.cardView:GetParentView():GetModel():GetRoundData(cardId,cellIndex):GetSignType()
end

function BaseSignEffect:SaveCellSignEffect(cardId,cellIndex)
    return self.cardView:GetParentView():GetModel():GetRoundData(cardId,cellIndex):SaveSignEffect()
end

function BaseSignEffect:GetSignEffectObj(cardId, index, cardCell)
    if IsNull(cardCell) then
        cardCell = this.cardView:GetCardCell(cardId, index)
    end
    local ref_temp = fun.get_component(cardCell, fun.REFER)
    local effectObj = ref_temp:Get("ef_Bingo_click")
    return effectObj
end

function BaseSignEffect:CannotSignCell(cardId,cellIndex,signType)
    local cellSignType = self:GetCellSignType(cardId,cellIndex)
    log.r(string.format("[BaseSignEffect] CannotSignCell, curCellSignType:%s, targetSignType:%s", cellSignType, signType))
    
    --local cellData = self.cardView:GetParentView():GetModel():GetRoundData(cardId,cellIndex)
    --if cellData:IsPlayedSignEffect() then 
    --    return true 
    --end
    
    return cellSignType == 0 or signType > cellSignType  or false
end

--格子盖章效果
function BaseSignEffect:SignCardEffect(cardId,index, cardCell, signType, delay, self_bingo, giftLen)
    signType = signType or 1
    --if self:CannotSignCell(cardId,index,signType ) then 
    --    return 
    --end
    
    --关闭放大镜效果
    Event.Brocast(EventName.Magnifier_Close_Single_Cell,cardCell,false)

    --盖章后隐藏部分对象
    local ref_temp = fun.get_component(cardCell, fun.REFER)
    self:HideCellChild(ref_temp, cardId, index)
    
    local effect =this.effectEntry:GetCellChip(cardId,index,cardCell)
    local play_name = this:GetBingoEffectName(signType, self_bingo)
    log.r(string.format("[SignCardEffect] cardId:%s, cellIndex:%s, signType:%s, play_name:%s", cardId,index, signType, play_name))

    local defaultCellAnimOrder = this.cardView:GetDefaultCellAnimOrder(cardId, index)
    if defaultCellAnimOrder then
        --如果是默认就盖章的格子，需要特殊处理
        if defaultCellAnimOrder > 1 and signType == 1 then
            --普通盖章不能覆盖已有动画
            return
        end
    end
    
    delay = delay or 0
    if signType == 1 then
        this.effectEntry:AddDelayAnima(effect, play_name, delay, 0.5, 2)
    elseif signType == 2 then
        this.effectEntry:AddDelayAnima(effect, play_name, delay, 0.5, 3)
    else
        effect:Play(play_name)
    end
end

---隐藏格子多余显示
function BaseSignEffect:HideCellChild(ref_temp, cardID, cellIndex)
    local number1 = ref_temp:Get("number1")
    fun.set_active(number1, false)
    local number2 = ref_temp:Get("number2")
    fun.set_active(number2, false)
    local number3 = ref_temp:Get("number3")
    fun.set_active(number3, false)
    local number4 = ref_temp:Get("number4")
    fun.set_active(number4, false)
    local doublebg = ref_temp:Get("doublebg")
    fun.set_active(doublebg, false)    
    
    local collider = ref_temp:Get("collider")
    fun.set_active(collider, false)
    
    local giftObjParent = ref_temp:Get("gift_parent")
    fun.set_active(giftObjParent, false)
    
    local Number1 = ref_temp:Get("Number1")
    fun.set_active(Number1, false)
    local Number2 = ref_temp:Get("Number2")
    fun.set_active(Number2, false)
    
    if isNeedHideBg then
        local bg_tip = ref_temp:Get("bg_tip")
        fun.set_active(bg_tip, false)
    end

    local tip = ref_temp:Get("Wish")
    fun.set_active(tip, false)
    
    --self:SetJokerBgOnSign(ref_temp, cardID, cellIndex)
    --self:HideJoker(ref_temp, cardID, cellIndex)
end

--设置新的JokerBg
function BaseSignEffect:SetJokerBgOnSign(ref_temp, cardId)
    local jokerBg = ref_temp:Get("JokerBg")
    if not fun.is_null(jokerBg) then
        local parentObj = self:GetCardView():GetCard(cardId).signcellJBroot
        if not fun.is_null(parentObj) then
            fun.set_parent(jokerBg.transform.parent, parentObj)
        end

        local playId = ModelList.BattleModel:GetGameCityPlayID()
        local cfg = Csv.GetData("new_game_cell", playId)
        if cfg.joker_bg_signed ~= "0" then
            jokerBg.sprite = AtlasManager:GetSpriteByName(cfg.atlas_name, cfg.joker_bg_signed)
            local offset = cfg.joker_bg_offet_signed
            local x, y, z = offset[1], offset[2], offset[3]
            fun.set_rect_offset_local_pos(jokerBg, x, y, z)
        end
    end
end

---隐藏小丑卡炸弹
function BaseSignEffect:HideJoker(ref_temp, cardId, cellIndex)
    local Joker = ref_temp:Get("Joker")
    if not fun.is_null(Joker) then
        --local boomObj = fun.find_child(Joker, "JokerBoom")
        --if fun.get_active_self(boomObj) then
        --    fun.set_active(boomObj, false)
        --end
        fun.set_active(Joker, false)
    end
end

function BaseSignEffect:GetBingoEffectName(signType, self_bingo)
    local play_name = "free_idle"

    if signType == 1 then
        --普通盖章后
        play_name = "show"
    elseif signType == 2 then
        --达成bingo后
        play_name = "bingo_show"    
    elseif signType == 3 then
        play_name = "bingo_show"
    end
    
    if self_bingo then
        play_name = "bingopu"
    end
    
    return play_name
end

function BaseSignEffect:GetStarTrailsObj()
    local obj = BattleEffectPool:Get("StarTrails")
    table.insert(this.StarTrailsList, obj)
    return obj
end
function BaseSignEffect:RecycleStarTrailsObj()
    if this.StarTrailsList  and #this.StarTrailsList>0 then
        if this.StarCount >0  and this.StarCount%MCT.RechargeStarCount == 0 then
            Event.Brocast(EventName.Sign_Star_End_To_PowerUp)
        end
        this.StarCount =  this.StarCount - 1
        local o = this.StarTrailsList[1]
        BattleEffectPool:Recycle("StarTrails", o)
        table.remove(this.StarTrailsList, 1)
    end
end

--- 显示格子点击提示
function BaseSignEffect:ShowNormalCellTip(cell, cardid, cellIndex, poolName)
    --poolName = poolName or "ClickGet"
    BattleEffectCache:GetCachedPrefab_BingoBang(cardid, "ClickGet", {
        targetObj = cell,
        recycleTime = 2,
        parentContainerType = BingoBangEntry.BattleContainerType.CellEffectContainer,
        cb = function(obj)
            if not IsNull(obj) then
                --fun.set_active(obj,false)
                --fun.set_active(obj,true)
                this.supplement:SetEffectScale(obj)
                --local xx = fun.find_child(obj,"xx")
                --local txt = fun.get_component(xx,fun.OLDTEXT)
                --if txt then
                --    txt.text = rewardXp
                --end
            end
        end
    })
end

---显示格子快速点击提示
function BaseSignEffect:ShowFastCellTip(num,doubleNum,cell)
    local isFastClick = BattleMachineList.GetMchine("CallNumberMachine"):IsFastClick(num,doubleNum)
    if isFastClick then
        local obj = BattleEffectPool:Get("CellGetFast",cell)
        if obj then
            fun.set_active(obj,false)
            fun.set_active(obj,true)
            BattleEffectPool:DelayRecycle("CellGetFast",obj,2)
        end
        return true
    end
    
    return false
end

---显示格子杯赛点击提示
function BaseSignEffect:ShowCompetitionCellTip(cell)
    if  competitionReward  == -1 then  competitionReward = ModelList.BattleModel:GetCurrModel():GetBattleCompetitionGameInfo("mark") end
    if ModelList.BattleModel:GetBattleCompetition() and competitionReward >0   then
        BattleEffectCache:GetFreePrefabFromCache3("CompetitionCookieGet","CellChipContainer",2,cell,function(obj)
            if obj then
                local xx = fun.find_child(obj,"xx")
                if xx then
                    local xxText = fun.get_component(xx,fun.OLDTEXT)
                    if xxText then
                        xxText.text = competitionReward
                    end
                end
            end
        end)
    end
end

function BaseSignEffect:ShowClickCellTip(cell, kick_error,num,doubleNum, cardid, cellIndex)
    if kick_error then
        --local obj = BattleEffectPool:Get("ClickNoCall",cell)
        --BattleEffectPool:DelayRecycle("ClickNoCall",obj,2)
        local ref_temp = fun.get_component(cell, fun.REFER)
        if ref_temp then
            local anim = ref_temp:Get("gift")
            fun.play_animator(anim, "miss", true)

            local missObj = ref_temp:Get("Miss")  --   fun.find_child(cardCell,"jackpot")
            fun.set_active(missObj, false)
            fun.set_active(missObj, true)
        end
    else
        num = num or 0
        doubleNum = doubleNum or 0
        --if not self:ShowFastCellTip(num, doubleNum, cell) then
            self:ShowNormalCellTip(cell, cardid, cellIndex)
        --end
        --self:ShowCompetitionCellTip(cell)
    end
    --if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
    --    Event.Brocast(EventName.HangUpCell_RefreshWinningsXpAndCoinWithClick,rewardCoin, rewardXp)
    --end
end

function BaseSignEffect:New(name)
    local o = {name = name}
    setmetatable(o,{__index = BaseSignEffect})
    return o
end

return this