---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/7 10:36
---
---
require "View/Bingo/SettleModule/RocketState/RocketEnterState"
require "View/Bingo/SettleModule/RocketState/RocketIdleState"
require "View/Bingo/SettleModule/RocketState/RocketStartFlyState"
require "View/Bingo/SettleModule/RocketState/RocketEndFlyState"
require "View/Bingo/SettleModule/RocketState/RocketWaitDataState"
require "View/Bingo/SettleModule/RocketState/RocketEndFly2State"
require "View/Bingo/SettleModule/RocketState/RocketStartFly2State"
local smallGameState =  require "View.Bingo.SettleModule.RocketState.SmallGameState"

local SettleRocketView = BaseView:New('SettleRocketView', 'SettleAtlas');

local this = SettleRocketView;

function SettleRocketView:New(view)
    local o = {};
    setmetatable(o, { __index = this })
    o.view = view
    return o
end

this.auto_bind_ui_items = {
    "background",
    "Bottom",
    "btn_skip",
    "btn_free",
    "btn_rocket",
    "round2_num",
    "round2_get_daubs",
    "round2_rocket_icon",
    "round2_rocket_num",
    "round2_bg1",
    "round2_bg2",
    "Bottom2",    --火箭2
    "round3_num", --火箭2 --图片
    "Bottom1",    --火箭1
    "saleTip",
    "superMatchRoot",
    "text_rocket_value",
}
this.is_isclick = false
this.settleData = nil
this.model = nil
this.index = 1 ---火箭次数
Rocket_State = { None = 0, Rocket = 1, Diamond = 2, Ad = 3, Skip = 4, Ad_Complete = 5 }
this.rocket_state = Rocket_State.None
local exitTime = 0
local cardView = nil
local windowView = nil
local card_list = {}

function SettleRocketView.Awake(obj, obj2)
    this:on_init()
    this.go = obj2
    this:SetControlModel()
    this:RegisterEvent()
    this:OpenRound2()
    this.update_x_enabled = true
    this:start_x_update()
    cardView = ModelList.BattleModel:GetCurrBattleView():GetCardView()
    exitTime = 0
end

function SettleRocketView.OnEnable()
    --测试方法，自动点击，继续战斗
    --LuaTimer:SetDelayFunction(3, function()
    --    Event.Brocast(EventName.Test_SettleRocket)
    --end)
    this.index = 1
    ModelList.BattleModel:GetCurrModel():SetGameState(GameState.RocketIdle)
    ModelList.BattleModel:GetCurrBattleView():SetContainerForRocketView(this.go)
    Cache.load_prefabs(AssetList["xiaohuojian"], "xiaohuojian", function (ret)
        this.xiaohuojianPrefab = ret
        fun.set_active(ret, false)
    end)
    exitTime = 0
    this:PlaySound()
end

function SettleRocketView.OnDisable()
    this.update_x_enabled = false
    this:stop_x_update()
    this.is_isclick = false
    this:UnRegisterEvent()
    this:DisposeFsm()
    this.StopCountdown2()
    if windowView then
        Facade.SendNotification(NotifyName.HideDialog, windowView)
    end
    card_list = nil
    this:ClearRocketRetCb()
end

function SettleRocketView.OnDestroy()
    this:Destroy()
    if ViewList.SuperMatchBangRocket then
        Facade.SendNotification(NotifyName.CloseUI,ViewList.SuperMatchBangRocket)
        ViewList.SuperMatchBangRocketr = nil
    end
end

function SettleRocketView:PlaySound()
    UISound.play("rocket_ready")
    local playType = ModelList.BattleModel:GetGameType()
    if playType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
        UISound.play("winzoneRocket")
    end
    UISound.stop_loop("chips")
end

function SettleRocketView:SetControlModel()
    this.model = ModelList.BattleModel:GetCurrModel()
    this.Get()
    if this.model == nil then
        log.r("no  game battle model")
    end
end

function SettleRocketView:OnHideShopView()
    this:PauseCountdown(false)
end

function SettleRocketView:OnRocketChange()
    local num = tonumber(this.round2_rocket_num.text)
    local rocket = ModelList.ItemModel.get_rocketCount()
    if fun.is_not_null(self.text_rocket_value) then
        self.text_rocket_value.text = "("..rocket..")"
        if rocket >= tonumber(num) then
            self.text_rocket_value.color = Color(1, 223/255, 1, 1)
        else
            self.text_rocket_value.color = Color(242/255, 21/255, 83/255, 1)
        end
    end
end

function SettleRocketView:OnUseRocketRet()
    if self.useRocketRetCb then
        self.useRocketRetCb()
    end
    self:ClearRocketRetCb()
end

function SettleRocketView:SetRocketRetCb(cb)
    self.useRocketRetCb = cb
end

function SettleRocketView:ClearRocketRetCb()
    self.useRocketRetCb = nil
end

function SettleRocketView:RegisterEvent()
    Event.AddListener(Notes.RECEIVE_ROCKET_SETTLE, self.GetRocketSettle)
    Event.AddListener(Notes.RECEIVE_MAX_REWARD, self.ReceiveAdReward)
    Event.AddListener(Notes.RECEIVE_MAX_REVENUE_PAID_REWARD, self.AdRevenuePaid)
    Event.AddListener(EventName.Event_Open_Shop_View, self.PauseCountdown)
    Event.AddListener(Notes.RECEIVE_MAX_REWARD_ADMISS, self.AdCallBack)
    Event.AddListener(EventName.Event_rocket_change,self.OnRocketChange,self)
    Event.AddListener(EventName.MSG_GAME_USE_ROCKET_RET, self.OnUseRocketRet, self)
end

function SettleRocketView:UnRegisterEvent()
    Event.RemoveListener(Notes.RECEIVE_ROCKET_SETTLE, self.GetRocketSettle)
    Event.RemoveListener(Notes.RECEIVE_MAX_REWARD, self.ReceiveAdReward)
    Event.RemoveListener(Notes.RECEIVE_MAX_REVENUE_PAID_REWARD, self.AdRevenuePaid)
    Event.RemoveListener(EventName.Event_Open_Shop_View, self.PauseCountdown)
    Event.RemoveListener(Notes.RECEIVE_MAX_REWARD_ADMISS, self.AdCallBack)
    Event.RemoveListener(EventName.Event_rocket_change,self.OnRocketChange,self)
    Event.RemoveListener(EventName.MSG_GAME_USE_ROCKET_RET, self.OnUseRocketRet, self)
end

--- ---------------------------round2------------------------------------------

local function SetNoAds()
    local img = fun.get_component(this.btn_free, fun.IMAGE)
    fun.set_img_color(img, Color.New(0.47, 0.47, 0.47, 1))
    local img2 = fun.find_child(this.btn_free, "Image")
    if img2 then
        fun.set_active(img2, false)
    end
    local img3 = fun.find_child(this.btn_free, "Noads")
    if img3 then
        fun.set_active(img3, true)
    end
    this.noad = true
end

--- 2022/09/26 在原来可以看广告的基础上，增加一个判断, 满足条件的有广告按钮，不满足条件的不出现广告按钮
function SettleRocketView:CheckAdBtnActive()
    local playid = ModelList.CityModel.GetPlayIdByCity()
    local bet_num = ModelList.CityModel:GetBetRate()
    local count = this.model:GetCardCount()
    local data = Csv.rocket
    local rocketInfo = nil

    --ab分组 策划没有配置会导致没有配置表
    if data then
        for k, v in pairs(data) do
            if v.cityid[1] == playid and v.cityid[2] == count and v.cityid[3] == bet_num then
                rocketInfo = v
                break
            end
        end
    else
        log.r("CheckAdBtnActive Csv.rocket ab 分组小火箭没有配置")
    end

    if rocketInfo then
        if rocketInfo.advertise == 0 then
            fun.set_active(this.btn_free, false)
        else
            SDK.ADShow(AD_EVENTS.AD_EVENTS_PRE_SETTLE)
        end
    end
end

--- 第二场战斗，不显示广告按钮，小火箭显示为0
function SettleRocketView:CheckSecondBattle()
    local settleData = ModelList.BattleModel:GetCurrModel():GetSettleData()
    if settleData and settleData.rocketCanUse and #settleData.rocketCanUse == 1 and settleData.rocketCanUse[1] == 6 then
        fun.set_active(this.btn_free, false)
        --local freeFlag = fun.get_instance(this.round2_rocket_icon, this.btn_rocket)
        --local img = fun.get_component(freeFlag,fun.IMAGE)
        --Cache.SetImageSprite("CommonAtlas","cEntLuckyCupFree",img)
        --fun.set_rect_local_pos(freeFlag,111,36,0)
        --img:SetNativeSize()
        this.round2_rocket_num.text = "FREE"
        fun.set_active(this.text_rocket_value,false)
        this.secondBattle = true
    else
        this.secondBattle = false
    end
end

--- 根据可用时间戳，判断广告是否过了CD期
function SettleRocketView:IsRocketAdCanUse()
    --log.r(ModelList.PlayerInfoModel.get_cur_server_time())
    --log.r(this.settleData.rocketAdCanUseUnix)
    if this.settleData.rocketAdCanUseUnix then
        return ModelList.PlayerInfoModel.get_cur_server_time() >= this.settleData.rocketAdCanUseUnix
    end
    return false
end

--结算面板阶段2  Round2动画
function SettleRocketView:OpenRound2()
    this.rocket_state = Rocket_State.None
    local ad_num = ModelList.AdModel.GetAdCount(AD_EVENTS.AD_EVENTS_PRE_SETTLE)
    local ad_ready = SDK.IsRewardedAdReady()
    local isRocketAdCanUse = this:IsRocketAdCanUse()
    if ad_num <= 0 or not ad_ready or not isRocketAdCanUse then
        SetNoAds()
    else
        this.noad = false
    end
    this:CheckAdBtnActive()
    --补充大R不显示相关付费广告按钮 22.09.15
    local isBigR = ModelList.regularlyAwardModel:CheckUserTypes() --判断是否是大R用户

    if isBigR then                                                --是大r用户的情况进行隐藏
        fun.set_active(self.btn_free.transform, false, false)
    end

    this.HandleRound2()
    this:CheckSecondBattle()
    this:StartCountdown2()
    self:DisposeFsm()
    self._fsm = Fsm.CreateFsm("SettleRocketView", self, {
        RocketEnterState:New(),
        RocketIdleState:New(),
        RocketStartFlyState:New(),
        RocketEndFlyState:New(),
        RocketWaitDataState:New(),
        RocketEndFly2State:New(),
        RocketStartFly2State:New(),
        smallGameState:New(),
    })
    self._fsm:StartFsm("RocketIdleState")
end

function SettleRocketView:DisposeFsm()
    if self._fsm then
        self._fsm:Dispose()
        self._fsm = nil
    end
end

--结算面板 阶段2处理
function SettleRocketView:HandleRound2()
    --节省性能，把bingo界面的卡牌拿过来直接使用
    local bingoView = ModelList.BattleModel:GetCurrBattleView()

    bingoView:HandleForSettle(this.go)
    ModelList.BattleModel:GetCurrModel():SetGameState(GameState.Rocket)
    local count = this.model:GetCardCount()
    local par = fun.find_child(this.go, "Node" .. count)

    card_list = bingoView:GetCardMapsObject()
    fun.set_active(card_list[1], true)
    local gameType = ModelList.BattleModel:GetGameCityPlayID()
    local rocket_card_size = Csv.GetData("new_game_settle", gameType, "rocket_card_size")
    local rocket_card_fly_time = Csv.GetData("new_game_settle", gameType, "rocket_card_fly_time") or 0.5
    for i = 1, count do
        if i <= count then
            local child = fun.find_child(par, "Map" .. i)
            fun.set_parent(card_list[i], child, false)
            Anim.move_to_xy_local_ease(card_list[i], 0, 0, rocket_card_fly_time, nil)
            Anim.scale_to_xy_ease(card_list[i], rocket_card_size[1], rocket_card_size[2], rocket_card_fly_time,
                DG.Tweening.Ease.InOutBack)
        end
    end

    local playid = ModelList.CityModel.GetPlayIdByCity()
    local bet_num = ModelList.CityModel:GetBetRate()
    local data = Csv.rocket
    local self_dubas = nil
    for k, v in pairs(data) do
        if v.cityid[1] == playid and v.cityid[2] == count and v.cityid[3] == bet_num then
            self_dubas = v
            break
        end
    end
    if this.settleData.totalBingoCount < self_dubas.daub[1] then
        this.allow_sign_count = self_dubas.daub[2]
    else
        this.allow_sign_count = self_dubas.daub[3]
    end
    this.round2_get_daubs.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "hjnum" .. this.allow_sign_count)
    this:SetRocketCost(1)

    this:ShowSuperMatchBangRocketView()
end

---切换卡牌的父物体，过度到另一个界面使用，期间卡牌不能被隐藏，
function SettleRocketView:FirstReadyForClimbRankView()
    local count = this.model:GetCardCount()
    if not card_list and ModelList.BattleModel:GetCurrBattleView() then
        card_list = ModelList.BattleModel:GetCurrBattleView():GetCardMapsObject()
    end
    if card_list then
        for i = 1, #card_list do
            if not Util.IsNull(card_list[i]) and i <= count then
                fun.set_parent(card_list[i], this.go.transform.parent, false)
                --SetCardLetterOffset(card_list[i])

                --if not card_list[i].gameObject.activeInHierarchy then log.r("card_list gameObject  active false ") end
                BattleEffectCache.CardHideAllBindEffect()
                BattleEffectPool.CardHideAllBindEffect()
            end
        end
    end
end

function SettleRocketView:ReadyForNextView(NodeList)
    this.model = ModelList.BattleModel:GetCurrModel()
    if not card_list then
        card_list = ModelList.BattleModel:GetCurrBattleView():GetCardMapsObject()
    end
    local count = this.model:GetCardCount()
    local normalMap = require("View.Bingo.Base.NormalMap")
    local gameMode = ModelList.CityModel:GetEnterGameMode()
    local gameType = ModelList.BattleModel:GetGameCityPlayID()
    local climb_rank_card_size = Csv.GetData("new_game_settle", gameType, "climb_rank_card_size")

    if card_list then
        local lp, ps = self:CalculateCardPosAndSize(gameMode, climb_rank_card_size)
        for i = 1, #card_list do
            if not Util.IsNull(card_list[i]) and i <= count then
                fun.set_parent(card_list[i], NodeList[i], false)
                card_list[i].transform.localPosition = lp
                card_list[i].transform.localScale = ps
            end
            normalMap:HideNum(card_list[i])
        end
    end
end

function SettleRocketView:CalculateCardPosAndSize(playType, size)
    size = size or {1, 1, 1}
    local lp, ls
    if playType == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
        lp, ls = Vector3.New(0, 0, 0), Vector3.New(1.4, 1.4, 1)
    elseif playType == PLAY_TYPE.PLAY_TYPE_SCRATCH_WINNER then
        lp, ls = Vector3.New(0, -60, 0), Vector3.New(size[1], size[2], 1)
    elseif playType == PLAY_TYPE.PLAY_TYPE_GOLD_TRAIN then
        lp, ls = Vector3.New(-20, -50, 0), Vector3.New(size[1], size[2], 1)
    elseif playType == PLAY_TYPE.PLAY_TYPE_LET_THEM_ROLL then
        lp, ls = Vector3.New(-16, -16, 0), Vector3.New(size[1], size[2], 1)
    else
        lp, ls = Vector3.New(0, 0, 0), Vector3.New(size[1], size[2], 1)
    end
    return lp, ls
end

--阶段2计时
function SettleRocketView:StartCountdown2(resumeFromSuspend)
    if not resumeFromSuspend or not this.count_time2 then
        this.count_time2 = Csv.GetControlByName("rocket_countdown")[1][1]
    end
    --this:StartAutoSkipRound2(this.count_time2)
    this.round2_loop = LuaTimer:SetDelayLoopFunction(0, 1, this.count_time2, function ()
        this.round2_num.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "js_nub_0" .. (this.count_time2 - 1))
        this.count_time2 = this.count_time2 - 1
        if this.count_time2 == 0 then
            if this.rocket_state == Rocket_State.None then
                this:CastRocket(4, false)
            end
        end
    end, nil, nil, LuaTimer.TimerType.BattleUI)
end

--有小火箭第二个
function SettleRocketView:StartCountdown3(resumeFromSuspend)
    if not resumeFromSuspend or not this.count_time3 then
        this.count_time3 = Csv.GetControlByName("rocket_countdown")[1][1]
    end

    this.round2_loop2 = LuaTimer:SetDelayLoopFunction(0, 1, this.count_time3, function ()
        this.round3_num.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "js_nub_0" .. (this.count_time3 - 1))
        this.count_time3 = this.count_time3 - 1
        if this.count_time3 == 0 and this.rocket_state == Rocket_State.None then
            this:CastRocket(4, false)
        end
    end, nil, nil, LuaTimer.TimerType.BattleUI)
end

--有跳转其他界面，暂停计时
function SettleRocketView:PauseCountdown(isPause)
    if isPause then
        this.StopCountdown2()
    else
        if this.index == 1 then
            this:StartCountdown2(true)
        elseif this.index == 2 then
            this:StartCountdown3(true)
        end
    end
end

--阶段2停止计时
function SettleRocketView.StopCountdown2()
    if this.timerId2 then
        LuaTimer:Remove(this.timerId2)
        this.timerId2 = nil
    end
    if this.round2_loop then
        LuaTimer:Remove(this.round2_loop)
        this.round2_loop = nil
    end
    if this.round2_loop2 then
        LuaTimer:Remove(this.round2_loop2)
        this.round2_loop2 = nil
    end
end

local ConvertServerPos = function (serverPos)
    local c = math.modf(serverPos / 10)
    local d = math.fmod(serverPos, 10)
    return c * 5 - d + 1
end

local ConvertToServerPos = function (clientPos)
    local a = clientPos - 1
    local c = math.modf(a / 5)
    local d = math.fmod(a, 5)
    return (c + 1) * 10 + 5 - d
end

--- 先播放一个格子上炸开的动画
local PlayCellExplosionEffect = function (cardid, pos)
    if this.xiaohuojianPrefab then
        local cell = ModelList.BattleModel:GetCurrBattleView():GetCardView():GetCardCell(cardid, pos)
        if cell then
            local effect = fun.get_instance(this.xiaohuojianPrefab, cell)
            if not fun.is_null(effect) then
                fun.set_active(effect, true)
                fun.set_transform_pos(effect.transform, 0, 0, 0, true)
                local gameMode = ModelList.CityModel:GetEnterGameMode()
                if gameMode == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
                    fun.set_gameobject_scale(effect.gameObject, 0.5, 0.5, 1)
                else
                    fun.set_gameobject_scale(effect.gameObject, 1, 1, 1)
                end
            end
        end
    end
end

local GetAllSignCell = function ()
    local info = {}
    this.model = ModelList.BattleModel:GetCurrModel()
    this.cardView = ModelList.BattleModel:GetCurrBattleView():GetCardView()
    local roundData = this.model:GetRoundData()
    local settleData = this.index == 1 and this.model:GetSettleData().cardRocket or
        this.model:GetSettleData().cardRocket2
    local cardPos = {}
    for k, v in pairs(roundData) do
        local cardMarkedPos = {}
        local cardReward = {}
        for i = 1, #settleData do
            if tostring(settleData[i].cardId) == k then
                for m = 1, #settleData[i].pos do
                    local index = ConvertServerPos(settleData[i].pos[m])
                    local itemReward = {}
                    for p = 1, #v.cards[index].gift do
                        table.insert(itemReward, { id = v.cards[index].gift[p], value = 1 })
                    end
                    local pos = ConvertToServerPos(index)
                    table.insert(cardMarkedPos, { pos = pos, mark = 9, itemReward = itemReward })
                    PlayCellExplosionEffect(settleData[i].cardId, index)
                end
            end
        end
        local FinalCardInfo = { cardId = tonumber(k), cardMarkedPos = cardMarkedPos, cardReward = cardReward }
        table.insert(cardPos, FinalCardInfo)
    end
    return info
end

--重新发送
function SettleRocketView:ReCastRocket()
    if not self.go then
        return;
    end

    local cardPos = GetAllSignCell() -- 有可能数据为2
    ModelList.GameModel:ReqUseRocket(1, cardPos, this.index)
end

--阶段2 小火箭
--@params use_type  类型 1火箭2钻石3广告4跳过 5广告结束 6无消耗火箭
function SettleRocketView:CastRocket(use_type, need_sign)
    this.rocket_state = use_type
    if use_type == 4 then
        this.is_isclick = true
    end
    ModelList.BattleModel:GetCurrModel():SetReadyState(4)
    local cardPos = {}
    if use_type == 1 or use_type == 2 or use_type == 5 or use_type == 6 then
        cardPos = GetAllSignCell() -- 有可能数据为2
    end
    if not BingoBangEntry.IsReplayBattle then
        ModelList.GameModel:ReqUseRocket(use_type, cardPos, this.index)
    end

    if use_type == 1 or use_type == 2 or use_type == 5 or use_type == 6 then
        self._fsm:GetCurState():FinishOperate(self._fsm)
    elseif use_type == 3 then

    elseif use_type == 4 then
        this.StopCountdown2()
        this.Bottom:Play("exit")
        local callback = function() 
            LuaTimer:SetDelayFunction(MCT.rocket_exit_time, function ()
                this:JumpNextView()
            end)
        end
        if this.index == 2 then
            local gameType = ModelList.BattleModel:GetGameType()
            if gameType == PLAY_TYPE.PLAY_TYPE_GOLD_TRAIN then
                self:SetRocketRetCb(callback)
            elseif gameType == PLAY_TYPE.PLAY_TYPE_CHRISTMAS_SYNTHESIS then
                self:SetRocketRetCb(callback)
            else
                callback()
            end
        else
            callback()
        end
    end

    Event.Brocast(EventName.Recorder_Data, 5009, { useType = use_type })
end

function SettleRocketView:PlayRocketFly()
    local refTemp = fun.get_component(this.go, fun.REFER)
    this.rocket_anima = refTemp:Get("Bottom")
    this.rocket_anima:Play("emission")
    LuaTimer:Remove(this.rocket_play)
    this.rocket_play = nil
    UISound.play("rocket_fly")
    --log.r("startfly")
    exitTime = UnityEngine.Time.time


    LuaTimer:SetDelayFunction(MCT.rocket_emission_time, function ()
        if self._fsm then
            if this.round2_loop then
                LuaTimer:Remove(this.round2_loop)
                this.round2_loop = nil
            end
            ModelList.BattleModel:GetCurrModel():SetGameState(GameState.RocketBlast1)
            self._fsm:GetCurState():FinishOperate(self._fsm)
        end
    end)
end

function SettleRocketView:PlayRocketFly2()
    local refTemp = fun.get_component(this.go, fun.REFER)
    this.rocket_anima = refTemp:Get("Bottom")
    fun.set_active(this.rocket_anima, true)
    this.rocket_anima:Play("emission2")
    LuaTimer:Remove(this.rocket_play)
    this.rocket_play = nil
    UISound.play("rocket_fly")
    --log.r("startfly2")
    exitTime = UnityEngine.Time.time

    LuaTimer:SetDelayFunction(MCT.rocket_emission_time, function ()
        if self._fsm then
            if this.round2_loop2 then
                LuaTimer:Remove(this.round2_loop2)
                this.round2_loop2 = nil
            end
            ModelList.BattleModel:GetCurrModel():SetGameState(GameState.RocketBlast2)
            self._fsm:GetCurState():FinishOperate(self._fsm)
        end
    end)
end

function SettleRocketView:PlayRocketEnter2()
    fun.set_active(self.btn_free, false) -- 免费按钮隐藏
    fun.set_active(self.Bottom1, false)
    self:initCalData()
    this.rocket_state = Rocket_State.None

    this:StartCountdown3()
    local refTemp = fun.get_component(this.go, fun.REFER)
    this.rocket_anima = refTemp:Get("Bottom")
    this.rocket_anima:Play("enter2")
    fun.set_active(self.Bottom2, true)
end

--火箭2
function SettleRocketView:initCalData()
    local cityid = ModelList.CityModel.GetPlayIdByCity()
    local bet_num = ModelList.CityModel:GetBetRate()
    local count = this.model:GetCardCount()
    local data = Csv.rocket
    local self_dubas = nil
    for k, v in pairs(data) do
        if v.cityid[1] == cityid and v.cityid[2] == count and v.cityid[3] == bet_num then
            self_dubas = v
            break
        end
    end
    if this.settleData.totalBingoCount < self_dubas.daub[1] then
        this.allow_sign_count = self_dubas.daub[2]
    else
        this.allow_sign_count = self_dubas.daub[3]
    end
    --- 修复bug 2023/12/8 View/Bingo/SettleModule/UIView/SettleRocketView:584: attempt to index field 'round2_get_daubs' (a nil value)
    if fun.is_not_null(this.round2_get_daubs) then
        this.round2_get_daubs.sprite = AtlasManager:GetSpriteByName("SettleAtlas", "hjnum" .. this.allow_sign_count)
    end
    this:SetRocketCost(2)
end

---设置小火箭开销
function SettleRocketView:SetRocketCost(rocketOrder)
    local rocketUseMethod = nil
    local rockeDisCountInfo = nil
    if rocketOrder == 1 then
        rocketUseMethod = ModelList.BattleModel:GetCurrModel():GetSettleData().rocketUseMethod
    else
        rocketUseMethod = ModelList.BattleModel:GetCurrModel():GetSettleData().rocketUseMethod2
    end

    rockeDisCountInfo = ModelList.BattleModel:GetCurrModel():GetSettleData().rocketDiscount
    if not rocketUseMethod then return end

    if #rocketUseMethod == 0 then return end
    this.need_sign_consume = rocketUseMethod[1].value

    if false then --存在折扣信息
        fun.set_active(this.saleTip, true)
        local rocket_count = ModelList.ItemModel.get_rocketCount()
        local result = Csv.GetData("item", rockeDisCountInfo[1].id, "result")
        local disCount = result[2]
        local Add = this.saleTip:Get("Add")
        local freeText = this.saleTip:Get("freeText") --优惠力度
        local rocket_last_num = this.saleTip:Get("rocket_last_num")
        local rocket_icon = this.saleTip:Get("rocket_icon")
        local rocket_num2 = this.saleTip:Get("rocket_num2")
        local need_sign_consume = math.floor((100 - disCount) / 100 * this.need_sign_consume) --折扣后得
        freeText.text = disCount
        if need_sign_consume <= rocket_count then
            this.lack_sign_price = 0
            self:SetRocketText((need_sign_consume == 0 and 1 or need_sign_consume))
            rocket_last_num.text = this.need_sign_consume --原价
            self.round2_rocket_num.gameObject.transform.localPosition = Vector3.New(0,
                self.round2_rocket_num.gameObject.transform.localPosition.y, 0)
            rocket_last_num.gameObject.transform.localPosition = Vector3.New(0,
                rocket_last_num.gameObject.transform.localPosition.y, 0)
            --隐藏后面部分
            fun.set_active(Add, false)
            fun.set_active(rocket_icon, false)
            fun.set_active(rocket_num2, false)
        elseif rocket_count == 0 then
            this.lack_sign_price = rocketUseMethod[1].value
            local num = math.floor((100 - disCount) / 100 * rocketUseMethod[1].value)
            local overflow = this.saleTip:Get("rocket_last_num").horizontalOverflow
            if rocketUseMethod[1].value > 9999 then
                self:SetRocketText(fun.format_number(num == 0 and 1 or num))
            else
                this.round2_rocket_num.horizontalOverflow = overflow
                self:SetRocketText(num)
            end
            this.round2_rocket_icon.sprite = AtlasManager:GetSpriteByName("ItemAtlas", "icon_gold")
            this.round2_rocket_icon:SetNativeSize()
            self.round2_rocket_num.gameObject.transform.localPosition = Vector3.New(0,
                self.round2_rocket_num.gameObject.transform.localPosition.y, 0)
            rocket_last_num.transform.localPosition = Vector3.New(0, rocket_last_num.gameObject.transform.localPosition
                .y, 0)
            rocket_last_num.text = rocketUseMethod[1].value --原价钻石
            fun.set_active(Add, false)
            fun.set_active(rocket_icon, false)
            fun.set_active(rocket_num2, false)
        else
            self.round2_rocket_num.gameObject.transform.localPosition = Vector3.New(-32,
                self.round2_rocket_num.gameObject.transform.localPosition.y, 0)
            rocket_last_num.transform.localPosition = Vector3.New(-51,
                rocket_last_num.gameObject.transform.localPosition.y, 0)

            local rocket_sign_price = math.floor(rocketUseMethod[1].value / rocketUseMethod[2].value)

            this.lack_sign_price = (this.need_sign_consume - rocket_count) * rocket_sign_price
            local num = (need_sign_consume - rocket_count) * rocket_sign_price

            this:SetRocketText(fun.format_number(num == 0 and 1 or num))
            this.saleTip:Get("rocket_last_num").text = fun.format_number(this.lack_sign_price) --原价打折

            this.saleTip:Get("rocket_num2").text = rocket_count
            this.round2_rocket_icon.sprite = AtlasManager:GetSpriteByName("ItemAtlas", "icon_gold")
            this.round2_rocket_icon:SetNativeSize()
            fun.set_active(Add, true)
            fun.set_active(rocket_icon, true)
            fun.set_active(rocket_num2, true)
        end
    else --不存在按原来得
        fun.set_active(this.saleTip, false)
        local rocket_count = ModelList.ItemModel.get_rocketCount()
        if this.need_sign_consume < rocket_count then
            self.round2_rocket_num.gameObject.transform.localPosition = Vector3.New(0,
                self.round2_rocket_num.gameObject.transform.localPosition.y, 0)
            this.lack_sign_price = 0
            this:SetRocketText(this.need_sign_consume)
        elseif this.need_sign_consume >= rocket_count then
            self.round2_rocket_num.gameObject.transform.localPosition = Vector3.New(0,
                self.round2_rocket_num.gameObject.transform.localPosition.y, 0)
            this.lack_sign_price = rocketUseMethod[1].value - rocket_count
            local overflow = this.saleTip:Get("rocket_last_num").horizontalOverflow
            if rocketUseMethod[1].value > 9999 then
                this:SetRocketText(fun.format_number(rocketUseMethod[1].value))
            else
                this.round2_rocket_num.horizontalOverflow = overflow
                this:SetRocketText(rocketUseMethod[1].value)
            end

            --this.round2_rocket_icon.sprite = AtlasManager:GetSpriteByName("ItemAtlas", "icon_gold")
            --this.round2_rocket_icon:SetNativeSize()
        else
            fun.set_active(this.saleTip, true)
            self.round2_rocket_num.gameObject.transform.localPosition = Vector3.New(-32,
                self.round2_rocket_num.gameObject.transform.localPosition.y, 0)
            local rocket_count = ModelList.ItemModel.get_rocketCount()
            local saletip = this.saleTip:Get("saletip")
            local rocket_last_num = this.saleTip:Get("rocket_last_num")

            local rocket_sign_price = math.floor(rocketUseMethod[1].value / rocketUseMethod[2].value)
            this.lack_sign_price = (this.need_sign_consume - rocket_count) * rocket_sign_price
            this:SetRocketText(this.lack_sign_price)
            this.round2_rocket_icon.sprite = AtlasManager:GetSpriteByName("ItemAtlas", "icon_gold")
            this.round2_rocket_icon:SetNativeSize()
            fun.set_active(saletip, false)
            fun.set_active(rocket_last_num, false)

            this.saleTip:Get("rocket_num2").text = rocket_count
        end
    end
end

function SettleRocketView:PlayRocketEndFly()
    this.index = this.index + 1 --记录小飞机飞得次数
    LuaTimer:SetDelayFunction(MCT.rocket_sign_time, function ()
        if self._fsm then
            self._fsm:GetCurState():FinishOperate(self._fsm)
        end
    end)
end

function SettleRocketView:RocketWaitSettleData()
    local checkNewSettleRes = function ()
        if this:CanRound2ToRound3() then
            local flag = false
            local cardTb = {}

            if ModelList.BattleModel:GetCurrModel():GetSettleData() ~= nil and ModelList.BattleModel:GetCurrModel():GetSettleData().cardRocket2 ~= nil then
                cardTb = deep_copy(ModelList.BattleModel:GetCurrModel():GetSettleData().cardRocket2)
            end

            if this.index == 2 and #cardTb == 0 and ( ModelList.BattleModel:GetCurrModel():IsGetNewSettleData() == true or this:IsSmallGameHaveData() )then    -- 第一局且不存在第二局时
                flag = true
            elseif this.index == 3 and #cardTb > 0 and ModelList.BattleModel:GetCurrModel():IsGetNewSettleData() == true then --第二次小火箭得时候
                flag = true
            end

            if flag then
                this.settleData = this.model:GetSettleData()
                this.rocket_anima:Play("exit")
                LuaTimer:SetDelayFunction(MCT.rocket_exit_time, function ()
                    this:JumpNextView()
                end)
                LuaTimer:Remove(this.rocket_play)
            else
                if #cardTb > 0 and this.index == 2 then --只有第二次
                    this:PlayRocketEnter2()
                    self._fsm:GetCurState():ChangeState(self._fsm, "RocketIdleState")
                    LuaTimer:Remove(this.rocket_play)
                end
            end
        end
    end
    this.rocket_play = LuaTimer:SetDelayLoopFunction(MCT.rocket_play_time, 1, 2000, checkNewSettleRes, nil, nil,
        LuaTimer.TimerType.BattleUI)
end

function SettleRocketView:ShowAllMiss()
    local roundData = ModelList.BattleModel:GetCurrModel():GetRoundData()
    local totalNumber = ModelList.BattleModel:GetCurrModel():GetCalledNumber()
    local HasMiss = false
    local HasPerfect = false
    for k, v in pairs(roundData) do
        local pefect = true
        for i = 1, #v.cards do
            if v.cards[i].sign == 0 then
                if this:IsValueIn(totalNumber, v.cards[i].num) then
                    ModelList.BattleModel:GetCurrBattleView():GetCardView():ShowMisseffect(tonumber(k), i)
                    pefect = false
                elseif v.cards[i].double_num > 0 and this:IsValueIn(totalNumber, v.cards[i].double_num) then
                    ModelList.BattleModel:GetCurrBattleView():GetCardView():ShowMisseffect(tonumber(k), i)
                    pefect = false
                end
            end
        end
        if pefect then
            ModelList.BattleModel:GetCurrBattleView():GetCardView():ShowPerfectEffect(k)
            HasPerfect = true
        else
            HasMiss = true
        end
        ModelList.BattleModel:GetCurrModel():SavePerfectInfo(tonumber(k), pefect)
    end

    if HasMiss then UISound.play("rocket_miss") end
    if HasPerfect then UISound.play("rocket_perfectdaub") end
end

-- 查看某值是否为表tbl中的key值
function SettleRocketView:IsValueIn(tbl, key)
    if tbl == nil then
        return false
    end
    for _, v in pairs(tbl) do
        if v == key then
            return true
        end
    end
    return false
end

function SettleRocketView.GetRocketSettle()
    this.settleData = this.model:GetSettleData()
end

function SettleRocketView.Get()
    this.settleData = this.model:GetSettleData()
end

function SettleRocketView.ReceiveAdReward(code, data)
    if this.rocket_state ~= Rocket_State.Ad then return end
    if data ~= nil then
        local ad_id = data.AdUnitIdentifier
        local ad_sp = data.CreativeIdentifier
        ModelList.AdModel:C2S_WathchAdResult(ad_id, ad_sp, ad_id, AD_EVENTS.AD_EVENTS_PRE_SETTLE)
        LuaTimer:SetDelayFunction(0.5, function ()
            this:CastRocket(5, true)
        end)
    end
end

function SettleRocketView.AdRevenuePaid(code, data)

end

function SettleRocketView:CanRound2ToRound3()
    ---卡面上还有bingo未展示
    if not ModelList.BattleModel:GetCurrModel():IsBingoShowComplete() then return false end
    if not BattleTool.CheckEffectPlayOver2() then return false end

    ---玩法的小游戏是否完成
    return this:IsSmallGameHaveData()
end

function SettleRocketView:IsSmallGameHaveData()
    if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_SCRATCH_WINNER then
        return ModelList.ScratchWinnerModel:GetSmallGameData() ~= nil and true or false
    end
    return true
end


function SettleRocketView:getIsFirstRocket()
    return this.index == 1
end

function SettleRocketView:on_x_update()
    --this:AutoSkipView()
    if cardView then
        cardView:CheckDelayAnimaPlay()
        cardView:HideRewardWhenIdle()
    end
end

function SettleRocketView:JumpNextView()
    --跳到下个界面要把所有得计时器
    if this.round2_loop then
        LuaTimer:Remove(this.round2_loop)
        this.round2_loop = nil
    end
    if this.round2_loop2 then
        LuaTimer:Remove(this.round2_loop2)
        this.round2_loop2 = nil
    end

    if this.rocket_play then
        LuaTimer:Remove(this.rocket_play)
        this.rocket_play = nil
    end

    -- 如果之前已经执行过一次，就不再执行第二次
    if this.go and this.go.gameObject.activeSelf == false then
        return
    end
    this:SelectNextJumpView()
end

---检查当前玩法是否有小游戏
function SettleRocketView:CheckContainSmallGame()
    local gameType = ModelList.BattleModel:GetGameType()
    if gameType == PLAY_TYPE.PLAY_TYPE_SCRATCH_WINNER or
        gameType == PLAY_TYPE.PLAY_TYPE_GOLD_TRAIN then
        return true
    end
    return false
end

---检查当前玩法是否有特殊环节
function SettleRocketView:CheckContainCustomizedStage()
    local gameType = ModelList.BattleModel:GetGameType()
    if gameType == PLAY_TYPE.PLAY_TYPE_SOLITAIRE then
        return true
    end

    return false
end

---刮刮卡玩法增加一个摇奖流程
function SettleRocketView:SelectNextJumpView()
    if this:CheckContainSmallGame() then
        this:ProtectCardsObjActive()
        if ModelList.BattleModel:GetCurrModel():GetSmallGameData() ~= nil then
            ViewList.GameSettleView:JumpNextView()
            Facade.SendNotification(NotifyName.HideUI, ViewList.SettleRocketView)
        else
            log.e("PLAY_TYPE_SCRATCH_WINNER  no smallGameData jump!")
            this:FirstReadyForClimbRankView(this)
            ViewList.GameSettleView:JumpNextView()
            Facade.SendNotification(NotifyName.HideUI, ViewList.SettleRocketView)
        end
    elseif this:CheckContainCustomizedStage() then
        local callback = function() 
            this:FirstReadyForClimbRankView(this)
            ViewList.GameSettleView:JumpNextView()
            Facade.SendNotification(NotifyName.HideUI, ViewList.SettleRocketView)
        end

        Event.Brocast(EventName.Show_Customized_State_After_Rocket, callback)
    else
        this:FirstReadyForClimbRankView(this)
        ViewList.GameSettleView:JumpNextView()
        Facade.SendNotification(NotifyName.HideUI, ViewList.SettleRocketView)
    end
end

function SettleRocketView:on_btn_skip_click()
    if this._fsm and this._fsm:GetCurState().name ~= "RocketIdleState" then
        return
    end
    this:CastRocket(4, false)
end

function SettleRocketView:on_btn_rocket_click()
    -- if this.is_isclick and  this.index<=2 then
    --     return
    -- end

    if Network.isConnect == false then
        UIUtil.show_common_popup(8022, false, function ()
            this:on_btn_rocket_click()
        end, function ()
            UIUtil.return_to_scenehome()
        end)
        log.r("网络连接失败")
        return
    end

    if this._fsm:GetCurState().name ~= "RocketIdleState" then
        log.r("当前状态不是RocketIdleState  " .. this._fsm:GetCurState().name)
        -- UIUtil.show_common_popup(8022,true,function()
        --             end)
        return
    end

    if this.round2_loop2 and this.count_time3 and this.count_time3 <= 0 then
        log.r("round2_loop2")
        --  UIUtil.show_common_popup(8022,true,function()
        --     end)
        return
    end

    if this.round2_loop and this.count_time2 and this.count_time2 <= 0 then
        log.r("round2_loop ")
        -- UIUtil.show_common_popup(8022,true,function()
        -- end)
        return
    end

    if this.rocket_state and this.rocket_state == Rocket_State.Skip then
        log.r("rocket_state skip")
        -- UIUtil.show_common_popup(8022,true,function()
        -- end)
        return
    end

    this._fsm:GetCurState():ClickRocket()
end

function SettleRocketView:UseRocketItem()
    this:PauseCountdown(true) --- 如果使用了，把定时器都暂停了
    if this.secondBattle then
        -- 直接使用小火箭

        this:CastRocket(6, true)
        this.is_isclick = true
        return
    end
    local self_rocket_count = ModelList.ItemModel.get_rocketCount()
    if this.lack_sign_price and this.lack_sign_price > 0 then
        --  this:PauseCountdown(true)
        Facade.SendNotification(NotifyName.ShopView.CheckCurrencyAvailable, 85008, Resource.rocket,
            this.need_sign_consume,
            function ()
                --请求钻石盖章
                this:PauseCountdown(false)
                this:CastRocket(1, true)
                this.is_isclick = true
            end, function ()
                this:PauseCountdown(false)
            end, function ()
            end, SHOP_TYPE.SHOP_TYPE_PRIZES, nil)
        --  elseif this.allow_sign_count <= self_rocket_count then --历史遗留问题，修改成大于1
    elseif 1 <= self_rocket_count then
        -- 直接使用小火箭
        this:CastRocket(1, true)
        this.is_isclick = true
    else
        log.r("no handle")
        --如果这里有问题，就直接踢出去
        this:CastRocket(4, false)
    end
end

function SettleRocketView:on_btn_free_click()
    SDK.ADClick(AD_EVENTS.AD_EVENTS_PRE_SETTLE)
    if this.is_isclick or this.noad then
        return
    end
    this._fsm:GetCurState():ClickFree()
end

function SettleRocketView:PlayFree()
    this.is_isclick = true
    if UnityEngine.Application.isEditor then
        SDK.ShowRewardedAd("bingoend_rocket", AD_EVENTS.AD_EVENTS_PRE_SETTLE)
        this:CastRocket(3, nil)
    else
        if MaxAdHelper.I:IsRewardedAdReady() then
            SDK.ShowRewardedAd("bingoend_rocket", AD_EVENTS.AD_EVENTS_PRE_SETTLE)
            this:CastRocket(3, nil)
        else
            Util.SetUIImageGray(this.btn_free, true)
            this.is_isclick = false
        end
    end
end

function SettleRocketView:AdCallBack(adInfo)
    this:CastRocket(4, false)
end

------------------region supermatch 锤力器--------------------

-- 展示supermatchbangrocket界面
function SettleRocketView:ShowSuperMatchBangRocketView()
    local rewards = ModelList.BattleModel:GetCurrModel():GetSettleExtraInfo("SuperMatchSmash")
    if not rewards then
        return
    end
    Cache.load_prefabs(AssetList["SuperMatchBangRocketView"], "SuperMatchBangRocketView", function (prefab)
        local obj = fun.get_instance(prefab, this.superMatchRoot)
        if not ViewList.SuperMatchBangRocket then
            ViewList.SuperMatchBangRocket = require("View.Bingo.SettleModule.UIView.SuperMatchBangRocketView")
        end
        Facade.SendNotification(NotifyName.SkipLoadShowUI, ViewList.SuperMatchBangRocket, obj)
    end)
end

function SettleRocketView:SetRocketText(num)
    this.round2_rocket_num.text = num
    local rocket = ModelList.ItemModel.get_rocketCount()
    self.text_rocket_value.text = "("..rocket..")"
    if rocket >= tonumber(num) then
        self.text_rocket_value.color = Color(1, 223/255, 1, 1)
    else
        self.text_rocket_value.color = Color(242/255, 21/255, 83/255, 1)
    end
    local count = #tostring(num)
    if count == 1 then
        fun.set_rect_local_pos(this.text_rocket_value,70.53,-1,0)
    elseif count == 2 then
        fun.set_rect_local_pos(this.text_rocket_value,89,-1,0)
    elseif count == 3 then
        fun.set_rect_local_pos(this.text_rocket_value,105.8,-1,0)
    else
        fun.set_rect_local_pos(this.text_rocket_value,120.9,-1,0)
    end
end


------------------endregion ---------------------------------



-------------------region 刮刮卡-------------------------------


---暂时切换卡牌的父物体，方便保持激活状态,直到被另一个界面使用，期间卡牌不能被隐藏，
function SettleRocketView:ProtectCardsObjActive()
    local count = ModelList.BattleModel:GetCurrModel():GetCardCount()
    if ModelList.BattleModel:GetCurrBattleView() then
        card_list = ModelList.BattleModel:GetCurrBattleView():GetCardMapsObject()
    end
    if card_list then
        for i = 1, #card_list do
            if not Util.IsNull(card_list[i]) and i <= count then
                fun.set_parent(card_list[i], ViewList.GameSettleView.go, false)
                fun.set_rect_local_pos(card_list[i],5000,5000,0)
                --log.r("SettleRocketView:ProtectCardsObjActive")
            end
        end
    end
end


-------------------endregion  刮刮卡----------------------------






return this
