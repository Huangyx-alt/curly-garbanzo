---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/7 10:22
---

local SettleSuperMatchBangEnterState = require("State/SettleSuperMatchBange/SettleSuperMatchBangEnterState")
local SettleSuperMatchBangEffectState = require("State.SettleSuperMatchBange.SettleSuperMatchBangEffectState")
local SettleSuperMatchBangExitState = require("State.SettleSuperMatchBange.SettleSuperMatchBangExitState")

local SuperMatchBangRocketView = BaseView:New('SuperMatchBangRocket', 'SuperMatchBangRocketAtlas');
local this = SuperMatchBangRocketView;
this.viewType = CanvasSortingOrderManager.LayerType.TopConsole


this.auto_bind_ui_items = {
    "sliderText1",
    "completeFlag2",
    "sliderText2",
    "completeFlag3",
    "sliderText3",
    "totalBingo",
    "completeFlag1",
    "progressIcon1",
    "progressIcon2",
    "progressIcon3",
    "Anima"
}



function SuperMatchBangRocketView.Awake(obj)
    this:on_init()
end

function SuperMatchBangRocketView:OnEnable(params)
    this.rewards = ModelList.BattleModel:GetCurrModel():GetSettleExtraInfo("SuperMatchSmash")
    this.totalBingoCount = this.rewards.totalBingoNum
    this:SetData()
    this:RegisterEvent()
end

function SuperMatchBangRocketView:OnDisable()
    FsmCreator:DisposeFsm(this)
    this:UnRegisterEvent()
end

function SuperMatchBangRocketView.OnDestroy()
    this:Destroy()
end

function SuperMatchBangRocketView:ReduceBingoleftTick(bingoData)
    this.totalBingoCount = this.totalBingoCount + #bingoData
    this.totalBingo.text = this.totalBingoCount
    this.targetBingoCount = this.totalBingoCount
    log.r("this.totalBingoCount  "..this.totalBingoCount.."  this.nextBingoCount  "..tostring(this.nextBingoCount))
    if this.targetBingoCount >= this.nextBingoCount then
        this:SelectSliderAnima()
    end
end

---
function SuperMatchBangRocketView:RegisterEvent()
    Event.AddListener(EventName.Player_Bingo_Count_Be_Change, self.ReduceBingoleftTick, self)
end

---
function SuperMatchBangRocketView:UnRegisterEvent()
    Event.RemoveListener(EventName.Player_Bingo_Count_Be_Change, self.ReduceBingoleftTick, self)
end

--- 设置锤力器数据
function SuperMatchBangRocketView:SetData()
    this.totalBingo.text = this.totalBingoCount
    this.sliderText1.text = this.rewards.progress[1]
    this.sliderText2.text = this.rewards.progress[2]
    this.sliderText3.text = this.rewards.progress[3]
    this.MaxSliderValue = this.rewards.progress[3]
    this.openStatu = { 0, 0, 0 }
    this.currentBingoCount = 0
    this.bingoInterval = 1 / this.MaxSliderValue
    this:StartSliderValue()
    --this:RsetProgressIconPos()
end

--重新设置progressIcon的位置
function SuperMatchBangRocketView:RsetProgressIconPos()
    local height = 312.9
    local bottom = -140.9
    local heightInterval = height / this.MaxSliderValue
    for i = 1, 3 do
        fun.set_rect_local_pos(this["progressIcon" .. i], -54.8, bottom + heightInterval * this.rewards.progress[i], 0)
    end
end

--- 设置进度条完成度
function SuperMatchBangRocketView:StartSliderValue()
    if not this.oldSlider then this.oldSlider = 0 end
    this.currentBingoCount = 0
    this.targetBingoCount = this.totalBingoCount
    this.targetSlider = 0
    this.oldSlider = 0
    this.sliderRolling = false
    this.update_x_enabled = true
    this:start_x_update()
    --this:SelectSliderAnimaOnEnable()
    this:SelectSliderAnima(true)
end


--- 按照进度选择动画来播放
function SuperMatchBangRocketView:SelectSliderAnimaOnEnable()
    local enableSlider = 0
    this.nextBingoCount = this.rewards.progress[1]
    for i = 1, 3 do
        if this.targetBingoCount >= this.rewards.progress[i] then
            enableSlider = i
            if i < 3 then
                this.nextBingoCount = this.rewards.progress[i + 1]
            end
        end
    end
    this.Anima:Play(enableSlider .. "_idle")
end


--- 按照进度选择动画来播放
function SuperMatchBangRocketView:SelectSliderAnima(isEnter)
    --- 正在播放涨进度,不能重复播放
    local stateInfo = this.Anima:GetCurrentAnimatorStateInfo(0)
    if not isEnter and  not ( stateInfo:IsName("idle") )then
        log.r("return SelectSliderAnima ")
        return
    end
    if isEnter then this.nextBingoCount = this.rewards.progress[1] end
    log.r("SelectSliderAnima "..this.targetBingoCount)
    for i = 1, 3 do
        if this.targetBingoCount >= this.rewards.progress[i] and this.targetSlider < i then
            this.targetSlider = i
            if i < 3 then
                this.nextBingoCount = this.rewards.progress[i + 1]
            end
        end
    end

    if this.targetSlider > this.oldSlider then
        this.Anima:Play("enter" .. this.oldSlider .. "_" .. this.targetSlider)
        this.oldSlider = this.targetSlider
    end
end

--- 设置进度条完成度
function SuperMatchBangRocketView:SetSliderValue(value)
    if not this.oldSlider then this.oldSlider = 0 end
    --this.sliderRolling = true
    this.currentBingoCount = value
    this:OnSliderValueChange(value)
    if this.currentBingoCount >= this.targetBingoCount then
        this.sliderRolling = false
    end
end

function SuperMatchBangRocketView:on_x_update()
    if this.nextBingoCount and this.targetBingoCount >= this.nextBingoCount and this.Anima:GetCurrentAnimatorStateInfo(0):IsName("idle") then
        this:SelectSliderAnima()
    end
end

--- 设置进度条完成度
function SuperMatchBangRocketView:OnSliderValueChange(value)
    for i = 1, 3 do
        if this.openStatu[i] == 0 and value >= this.rewards.progress[i] and this.oldSlider < this.rewards.progress[i] then
            fun.set_active(this["completeFlag" .. i], true)
            this["progressIcon" .. i].sprite = AtlasManager:GetSpriteByName("SuperMatchBangRocketAtlas", "ClqXhj03Gou1")
            this.openStatu[i] = 1
        end
    end
end

function SuperMatchBangRocketView:ResetStateIdle()
    self._fsm:ChangeState("SettleSuperMatchBangEnterState")
end

function SuperMatchBangRocketView:on_btn_Anniu_click()
    self._fsm:ChangeState("SettleSuperMatchBangEffectState")

    --ModelList.SuperMatchModel.ReqSmashReward()
end

function SuperMatchBangRocketView:PlayBangStart()
    self._fsm:ChangeState("SettleSuperMatchBangEffectState")
end

return this
