---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/7 10:22
---

local SettleTransitionEnterState = require("State.SettleTransitonView.SettleTransitionEnterState")
local SettleTransitionHideEffectState = require("State.SettleTransitonView.SettleTransitionHideEffectState")
local SettleTransitionUploadDataState = require("State.SettleTransitonView.SettleTransitionUploadDataState")
local SettleTransitionExitState = require("State.SettleTransitonView.SettleTransitionExitState")

local SettleTransitionView = BaseView:New('SettleTransitionView','SettleAtlas');
local this = SettleTransitionView;
this.viewType = CanvasSortingOrderManager.LayerType.None

local TimeInterval1 = 5
local TimeInterval2 = 15

this.auto_bind_ui_items = {
    "root",
    "Img_getReady",
    "light1",
    "light2",
    "full_screen1",
    "light3",
    "light4",
    "full_screen2",
    "light5",
    "light6",
    "full_screen3",
}
local isShowingPop = false
local windowView = nil
this.settleData = nil
this.can_round1_exit = false
this.ReqDelayLoop = nil
this.enter_time = nil    --界面打开时间


function SettleTransitionView.Awake(obj)
    this:on_init()
    AtlasManager:LoadImageAsync("SettleAtlas",nil,nil)
    -- resMgr:LoadAtlas(AssetList["SettleAtlas"],"SettleAtlas")
    if ViewList.GameQuitView  and ViewList.GameQuitView.go  and  fun.get_active_self(ViewList.GameQuitView.go) then
        Facade.SendNotification(NotifyName.HideUI, ViewList.GameQuitView)
    end
    this:SetControlModel()
    --this:OpenRound1()
    this.HadUploadSettleData = false
    this.upload_time = 0
    TimeInterval1 = 5
    TimeInterval2 = 15
    this.enter_time = nil
    local sound_ab_list ={"luaprefab_sound_bingo_common_settlementbgm"}
    UISound.load_res(sound_ab_list, nil)
end

function SettleTransitionView:OnEnable()
    log.r("SettleTransitionView:OnEnable")
    this:initSpeedUp()
    this:RegisterEvent()
    TimeInterval1 = 5
    TimeInterval2 = 15
    Event.Brocast(EventName.Magnifier_Hide_All_Showed_Cell)
    this:ReplaceJokerSkin()
    FsmCreator:Create("SettleTransitionView", this, {
        SettleTransitionEnterState:New(),
        SettleTransitionHideEffectState:New(),
        SettleTransitionUploadDataState:New(),
        SettleTransitionExitState:New(), }
    )
    this._fsm:StartFsm("SettleTransitionHideEffectState")
end

function SettleTransitionView:initSpeedUp()
    UnityEngine.Time.timeScale = 1
end

function SettleTransitionView:OnDisable()
    this:stop_x_update()
    FsmCreator:DisposeFsm(this)
    this:UnRegisterEvent()
    this.enter_time = os.time()
    if windowView then
        Facade.SendNotification(NotifyName.HideDialog, windowView)
    end
end


function SettleTransitionView.OnDestroy()
    TimeInterval1 = 5
    TimeInterval2 = 15
    this.enter_time = os.time()
    this.HadUploadSettleData = false
    this.HadSettleData = false
    this.upload_time = 0
    this.getSettle_time = nil
    this:Destroy()
end


--结算面板 阶段1  显示Round1动画
function SettleTransitionView:OpenRound1()
    this.can_round1_exit = false
    this.root.gameObject:SetActive(true)
    Event.Brocast(EventName.Revert_Cards_Canvas_Alpha)
    local ro = fun.find_child(this.root.gameObject,"root")
    fun.set_active(ro,false)   --先关了，再打开
    fun.set_active(ro, true)
    log.r("SettleTransitionView:OpenRound1")
    if ModelList.BattleModel:GetCurrModel():IsGameOver() then
        this:HasUploadSettleData()
    end
    this.enter_time = os.time()
    this.update_x_enabled = true
    this:start_x_update()
  --  this.root:Play("time_start")
    --播放音乐
    UISound.play_loop("settlement_bgm")
    self:PlayRound1Sound()
    
    --UISound.play("over_1")
    --this:HandleRound1()
    --1秒后切换到2
    --this.StartCountdown1()
end

function SettleTransitionView:PlayRound1Sound()
    local playType = ModelList.BattleModel:GetGameType()
    if playType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
        UISound.play("winzoneRoundover")
    end
end

-- function SettleTransitionView:PlayTimeStart()
--     this.root:Play("time_start")
-- end

function SettleTransitionView:SetControlModel()
    this.model = ModelList.BattleModel:GetCurrModel()
    if this.model == nil then
        log.r("no  game battle model")
    end
end

function SettleTransitionView:HasSettleData()
    return this.model:IsGameSettling()
end

function SettleTransitionView:CanTransitionNext()
    if not this:HasSettleData() then
        return false
    end
    return BattleTool.CheckEffectPlayOver3()
end


function SettleTransitionView:PlayRound1Exit()
    local ani = this.root
    ani:Play("time_end")
    this.played_round1_exit = true
    if this.loop_time then
        LuaTimer:Remove(this.loop_time)
    end
    this:CoroutinePreloadRes()
    LuaTimer:SetDelayFunction(1,function()
        this:Round1ChangeNext()
    end,nil,LuaTimer.TimerType.BattleUI)
end

--- 过渡界面提前预加载爬排名界面资源
function SettleTransitionView:CoroutinePreloadRes()
    this.settleData = this.model:GetSettleData()
    if this.settleData then
        if (this.settleData.settleType == 0 or this.settleData.settleType == 2) and not  ModelList.GuideModel:IsFirstBattle() then
            coroutine.start(function()
                Cache.Load_Atlas(AssetList["ClimbRankAtlas"],"ClimbRankAtlas",function()
                end,true)
                WaitForFixedUpdate()
                if ModelList.BattleModel:GetCurrBattleView():IsAuto() then
                    Cache.load_prefabs(AssetList["SettleClimbRankedAutoView"], "SettleClimbRankedAutoView",nil,true)
                else
                    Cache.load_prefabs(AssetList["SettleClimbRankedView"], "SettleClimbRankedView",nil,true)
                end
            end)
        end
    end
end

function SettleTransitionView:Round1ChangeNext()
    this.settleData = this.model:GetSettleData()
    if not this.settleData then
        log.r("no settle data")
        return
    end
    if (this.settleData.settleType == 0 or this.settleData.settleType == 2) then
        --if this.settleData.cardRocket and  #this.settleData.cardRocket > 0 then
        --    ViewList.GameSettleView:ExitTransitionView("SettleRocketView")
        --    Facade.SendNotification(NotifyName.HideUI,ViewList.SettleTransitionView)
        --elseif ModelList.GuideModel:IsFirstBattle() then
        --    ViewList.GameSettleView:ExitTransitionView("SettleRankView")
        --    Facade.SendNotification(NotifyName.HideUI, ViewList.SettleTransitionView)
        --else
        --    ViewList.GameSettleView:ExitTransitionView("SettleClimbRankedView")
        --    Facade.SendNotification(NotifyName.HideUI,ViewList.SettleTransitionView)
        --end
        ViewList.GameSettleView:ExitTransitionView("SettleDetailView")
        Facade.SendNotification(NotifyName.HideUI,ViewList.SettleTransitionView)
    else
        Event.Brocast(EventName.Event_HangUp_Ready_Settle)
        ViewList.GameSettleView:ExitTransitionView("SettleDetailView")
        Facade.SendNotification(NotifyName.HideUI,ViewList.SettleTransitionView)
    end
    this.StopCountdown1()
    if this.loop_time then
        LuaTimer:Remove(this.loop_time)
    end
end


function SettleTransitionView.StopCountdown1()
    if this.timerId1 then
        LuaTimer:Remove(this.timerId1)
        this.timerId1 = nil
    end
end

--- 检查是否等待数据时间过长
function SettleTransitionView:HasUploadSettleData()
    this.HadUploadSettleData = true
    if this.upload_time == 0 then
        this.upload_time = os.time()
    end
    --this:ResetInterval()
end

--- 检查是否等待数据时间过长
function SettleTransitionView:ResetInterval()
    TimeInterval1  = 5
end

--- 检查是否等待数据时间过长
function SettleTransitionView:GetSettleData()
    this.HadSettleData = true
    if not this.getSettle_time then
        this.getSettle_time = os.time()
    end
end


---
function SettleTransitionView:RegisterEvent()
    Event.AddListener(EventName.Event_Upload_Game_Settle_Data,this.HasUploadSettleData)
    Event.AddListener(EventName.Event_Receive_Game_Settle_Data,this.GetSettleData)
end

---
function SettleTransitionView:UnRegisterEvent()
    Event.RemoveListener(EventName.Event_Upload_Game_Settle_Data,this.HasUploadSettleData)
    Event.RemoveListener(EventName.Event_Receive_Game_Settle_Data,this.GetSettleData)
end

local TimeInterval = 20
function SettleTransitionView:on_x_update()
--    log.r("on_x_update   "..this.enter_time)
    if not  this.HadUploadSettleData and this.enter_time and os.time() - this.enter_time > TimeInterval then
  --      log.r("enter_time1    "..this.enter_time)
        TimeInterval = TimeInterval + 10
        SDK.upload_settle_data("no_upload_settle_data_to_server_in"..TimeInterval)
    end
    if this.HadUploadSettleData and this.enter_time and not this.HadSettleData and os.time() - this.enter_time > TimeInterval  then
    --    log.r("enter_time2    "..this.enter_time)
        TimeInterval = TimeInterval + 10
        SDK.upload_settle_data("no_receive_settle_data_from_server_in"..TimeInterval)
    end
    this:CheckWaitingError()
end

--- 小丑机台换主题
function SettleTransitionView:ReplaceJokerSkin()
    --特色玩法要使用本身的主题
    local checkType =  ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_NORMAL or ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET
    if checkType and ModelList.BattleModel.GetIsJokerMachine() then
        SetJokerSkin(self.light1,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light2,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light3,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light4,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light5,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light6,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.full_screen1,"JokerBattleAtlas","Pfullscreen")
        SetJokerSkin(self.full_screen2,"JokerBattleAtlas","Pfullscreen")
        SetJokerSkin(self.full_screen3,"JokerBattleAtlas","Pfullscreen")
        SetJokerSkin(self.Img_getReady,"JokerBattleAtlas","PfullscreenOver")
    end
end

--- 检查是否等待数据时间过长
function SettleTransitionView:CheckWaitingError()
    --上传了数据，10s内没有收到结算数据
    if this.HadUploadSettleData and not this.HadSettleData and this.upload_time and os.time() - this.upload_time > TimeInterval1  then
        TimeInterval1 = TimeInterval1 +5
        if  Network.isConnect then
            --网络是连接的，但是没有结算数据
            SDK.upload_settle_data("no_settle_data_from_server_in10")
            if not windowView then
                log.r("no_settle_data_from_server_in10")
                windowView =  UIUtil.show_common_popup(8022,false,function()
                    ModelList.BattleModel:GetCurrModel():ReqFetchSettle()
                    --isShowingPop = false
                    windowView = nil
                end,function()
                    ModelList.CityModel.C2S_FetchPowerUp()
                    --isShowingPop = false
                    windowView = nil
                    UIUtil.return_to_scenehome()
                end)
            end
        else
            --网络是断开的，但是没有结算数据
            if not windowView or fun.is_null(windowView. transform)  then
                --isShowingPop = true
                windowView =  UIUtil.show_common_error_popup(8037,true,function()
                    TimeInterval1 = TimeInterval1 +5
                    windowView = nil
                    --isShowingPop = false
                end,function()
                    ModelList.CityModel.C2S_FetchPowerUp()
                    windowView = nil
                    --isShowingPop = false
                    UIUtil.return_to_scenehome()
                end)
            end
        end
    end
    --收到了结算数据，10s后没有退出面板
    if this.HadUploadSettleData and this.HadSettleData and this.getSettle_time and os.time() - this.getSettle_time  > TimeInterval2 then
        SDK.upload_settle_data("no_exit_settle_trainsition_in"..TimeInterval2)
        TimeInterval2 = TimeInterval2 +5
        if   TimeInterval2 >=15 and  this:HasSettleData()  and not this:CanTransitionNext()  then
            log.r("过渡时间时间超长，直接关闭所有特效")
            if BattleLogic.GetLogicModule(LogicName.Card_logic) then
                BattleLogic.GetLogicModule(LogicName.Card_logic):ResetWaitBingoCount()
            end
            BattleEffectCache:CardHideAllBindEffect()
            BattleEffectPool:CardHideAllBindEffect()
        end
    end
end

return this

