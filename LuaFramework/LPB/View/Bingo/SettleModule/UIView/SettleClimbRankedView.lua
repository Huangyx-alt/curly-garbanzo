---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/4/9 15:06
---

require("View.Bingo.SettleModule.State.ClimbRank.ClimbRankJackpotState")
require("View.Bingo.SettleModule.State.ClimbRank.ClimbRankPowerState")
require("View.Bingo.SettleModule.ChildView.ClimbRankItem")


local SettleClimbRankedView = BaseView:New('SettleClimbRankedView', 'ClimbRankAtlas');

local this = SettleClimbRankedView;
this.auto_bind_ui_items = {
    "ClimbRankItem",
    "Content",
    "Node1",
    "Node2",
    "Node3",
    "Node4",
    "ScrollView",
    "number",
    "Coins",
    "pick_ef",
    "coinNum",
    "multipleNum1",
    "daub1",
    "Tex1",
    "Tex2",
    "multipleNum2",
    "daub2",
    "Tex3",
    "multipleNum3",
    "daub3",
    "Tex4",
    "multipleNum4",
    "daub4",
    "Num",
    "cardsAnima",
    "root_effectAnima",
    "Jackpot",
    "JackpotNum",
    "smallcoinNum",
    "SmallcoinNode",
    "Mask1",
    "Mask2",
    "Mask3",
    "Mask4",
    "view",
--"bigwinNum",
  --  "winNum",
    "winCoins",
    "bigwinCoins",
    "btn_speedUp",
    "card_bg1",
    "card_bg2",
    "card_bg3",
    "card_bg4",
    "Rankedwin", ---最后的rankwin 
    "RankedwinAim",  ---最后爬排名动画
    "RankedwinNum",  -- 最后爬排名的数字
    "btn_climbRank",
    "jackpot_img",
    "timeText",
    "SuperMatch",
}
this.data = nil
this.ranksObj = {}
this.IsFromRocketView = false
this.delayList = { 0, 0, 0, 0, 0 ,0}
this.detalFinalCallback = nil
this.detalFinalTime =nil
local currRank = 20
local targetRank = 0
local singleOffset = 129
local singleMoveTime = 0.3
local otherMoveTime = 0.35

local CardsList = {}
local totalCoinCount = 0
local currCoinCOunt = 0
local IsFirstNum = true
local finnalRank = 0
local winEffect = 0   -- 1 bigWin   2 normalWin  3 notWin
local autoRewardCount = 0

function SettleClimbRankedView:Awake()
    self:on_init()
    self:InitRanks()
    self:GetWinEffectState()
    self:ReplaceBigWinForJoker()
end

function SettleClimbRankedView:OnEnable()
    totalCoinCount = 0
    currCoinCOunt = 0
    autoRewardCount = 0
    if self.Content.enabled then
        local size = fun.get_rect_delta_size(self.Content.gameObject)
        local fitter = fun.get_component(self.Content.gameObject, "ContentSizeFitter")
        fitter.enabled = false
        self.Content.enabled = false
        fun.set_recttransform_native_size(self.Content, size.x, size.y)
    end

    fun.set_active(self.Rankedwin,false)

    self:CardBgOffset()
    self:initSpeedUp()

    fun.set_active(self.SuperMatch, false)
end

function SettleClimbRankedView:CardBgOffset()
    local gameType = ModelList.BattleModel:GetGameCityPlayID()
    local climb_card_bg_offset = Csv.GetData("new_game_settle", gameType, "climb_card_bg_offset")
    if climb_card_bg_offset then
        for i = 1, 4 do
            if this["card_bg"..i] then
                local pos1  = fun.get_gameobject_pos(this["card_bg"..i],true)
                if pos1 then
                    fun.set_rect_local_pos(this["card_bg"..i],pos1.x+climb_card_bg_offset[1],pos1.y+climb_card_bg_offset[2],pos1.z)
                end
            end
        end
    end
end


function SettleClimbRankedView:GetCards()
    return ModelList.BattleModel:GetCurrModel():GetCards()
end

function SettleClimbRankedView:GetFinnalRank()
    return ModelList.BattleModel:GetCurrModel():GetCards()
end

function SettleClimbRankedView:GetCardsList(reset)
    if reset then
        CardsList = {}
    end
    return CardsList
end

function SettleClimbRankedView:CollectCard()
    CardsList = {}
    if fun.get_child_count(self.Node1) > 0 then
        table.insert(CardsList, fun.get_child(self.Node1, 0).gameObject)
        fun.set_active(self["Mask"..1],true)
    end
    if fun.get_child_count(self.Node2) > 0 then
        table.insert(CardsList, fun.get_child(self.Node2, 0).gameObject)
        fun.set_active(self["Mask"..2],true)
    end
    if fun.get_child_count(self.Node3) > 0 then
        table.insert(CardsList, fun.get_child(self.Node3, 0).gameObject)
        fun.set_active(self["Mask" .. 3], true)
    end
    if fun.get_child_count(self.Node4) > 0 then
        table.insert(CardsList, fun.get_child(self.Node4, 0).gameObject)
        fun.set_active(self["Mask" .. 4], true)
    end
end

local GetSelfRankObj = function(self)
    return self.ranksObj[#self.ranksObj].go
end

local ShowSelfSpriteBg = function(self)
    local tiaoBg = fun.find_child(GetSelfRankObj(self), "img_background")
    local tiaoImg = fun.get_component(tiaoBg, fun.IMAGE)
    tiaoImg.sprite = AtlasManager:GetSpriteByName("ClimbRankAtlas", "JsTiao02")
end

function SettleClimbRankedView:ShowEnter(isFromRocket)
    self.IsFromRocketView = isFromRocket
    IsFirstNum = true
    self:CollectCard()
    self:BuildFsm()
    ShowSelfSpriteBg(self)
end

function SettleClimbRankedView:InitRanks()
    self.ranksObj = {}
    self.data = ModelList.GameModel:GetSettleData().ranks
    local selfData = nil
    local preRank = nil
    for i = 1, #self.data do
        if self.data[i].nickName == "0" then
            selfData = self.data[i]
            preRank = 1
            finnalRank = i
        else
            local item = ClimbRankItem:New()
            local obj = fun.get_instance(self.ClimbRankItem, self.Content)
            fun.set_active(obj, true)
            item.SetDefaultData(item, self.data[i], obj, self,preRank)
            table.insert(self.ranksObj, item)
        end
    end
    local item = ClimbRankItem:New()
    local obj = fun.get_instance(self.ClimbRankItem, self.Content)
    -- local tiaoBg = fun.find_child(obj, "img_background")
    fun.set_active(obj, true)
    item.SetDefaultData(item, selfData, obj, self, #self.data)
    table.insert(self.ranksObj, item)
    currRank = #self.ranksObj
    self.ScrollView.verticalNormalizedPosition = 0
end

function SettleClimbRankedView:GetMaxRateOpen()
    local currRate = ModelList.CityModel:GetMaxRateOpen()
    return currRate <= ModelList.CityModel:GetBetRate()
end



--- 获取BigWin 效果的排名
function SettleClimbRankedView:GetWinEffectState()
    local buyCardCost = ModelList.BattleModel:GetCurrModel():GetBattleExtraInfo("gamePlaySpend")
    if not buyCardCost then
        buyCardCost = ModelList.BattleModel:GetLastBuyCardCost()
    end
    local settleCoin = ModelList.BattleModel:GetCurrModel():GetSettleData().chips
    local settle_stratify = Csv.GetControlByName("settle_stratify")
    local getRate =( settleCoin/ buyCardCost ) *100
    winEffect = 3
    if settle_stratify ~= nil then
        if getRate > settle_stratify[1][1] and getRate < settle_stratify[2][1] and settleCoin>  settle_stratify[1][2]  then
            winEffect = 2
        elseif getRate >= settle_stratify[2][1]  and settleCoin<  settle_stratify[2][2]   then
            winEffect = 2
        elseif getRate >= settle_stratify[2][1]  and settleCoin>=  settle_stratify[2][2]   then
            winEffect = 1
        else
            winEffect = 3
        end
    end
    --winEffect = 1
    --log.y("finnalRank  "..finnalRank.."     winEffect   "..winEffect.."   settleCoin   "..settleCoin.."     buyCardCost "..buyCardCost.."   getRate "..getRate)
end

function SettleClimbRankedView:ShowTopThreeEffect()
    if winEffect == 1 then
        UISound.play("bigwin_open")
        UISound.play("bigwin_bgm") --big 背景音乐
       -- fun.set_active(self.bigwinCoins, true)
    elseif winEffect == 2 then
        UISound.play("win_open")
        UISound.play("win_bgm") --big 背景音乐
      --  fun.set_active(self.winCoins, true)
    end
end

function SettleClimbRankedView:StopTopThreeEffect()
    if winEffect == 1 then
        UISound.stop("bigwin_bgm") --big 背景音乐
       -- fun.set_active(self.bigwinCoins, true)
    elseif winEffect == 2 then
        UISound.stop("win_bgm") --big 背景音乐
      --  fun.set_active(self.winCoins, true)
    end
end

function SettleClimbRankedView:IsBigWin()
    return winEffect == 1
end

function SettleClimbRankedView:IsNormalWin()
    return winEffect == 2
end

function SettleClimbRankedView:IsNotWin()
    return winEffect == 3
end


---@return ClimbRankItem
local GetSelfItem = function(self)
    return self.ranksObj[#self.ranksObj]
end

function SettleClimbRankedView:BuildFsm()
    FsmCreator:Create("SettleClimbRankedView", self, {
        require("View.Bingo.SettleModule.State.ClimbRank.ClimbRankEnterState"),
        require("View.Bingo.SettleModule.State.ClimbRank.ClimbRankDaubState"),
        require("View.Bingo.SettleModule.State.ClimbRank.ClimbRankBingoState"),
        require("View.Bingo.SettleModule.State.ClimbRank.ClimbRankJackpotState"),
        require("View.Bingo.SettleModule.State.ClimbRank.ClimbRankPowerState"),
        require("View.Bingo.SettleModule.State.ClimbRank.ClimbRankEndState"),
        require("View.Bingo.SettleModule.State.ClimbRank.ClimbRankTeammateAwardState"),
    })
    self.state = {
        ClimbRankEnterState = "ClimbRankEnterState",
        ClimbRankBingoState = "ClimbRankBingoState",
        ClimbRankDaubState = "ClimbRankDaubState",
        ClimbRankJackpotState = "ClimbRankJackpotState",
        ClimbRankPowerState = "ClimbRankPowerState",
        ClimbRankEndState = "ClimbRankEndState",
        ClimbRankTeammateAwardState = "ClimbRankTeammateAwardState",
    }
    self._fsm:StartFsm(self.state.ClimbRankEnterState)
end

function SettleClimbRankedView:OnDisable()
    --log.r("SettleClimbRankedView:on_close")
    --Destroy(self.Node1,0.1)
    --Destroy(self.Node2,0.2)
    --Destroy(self.Node3,0.3)
    --Destroy(self.Node4,0.4)
    for i = 1, #self.delayList do
        if self.delayList[i] > 0 then
            LuaTimer:Remove(self.delayList[i])
        end
    end
    self.delayList = { 0, 0, 0, 0, 0,0 }
end

function SettleClimbRankedView:OnDestroy()
    self:Destroy()
end

function SettleClimbRankedView:GetNodeList()
    return { self.Node1, self.Node2, self.Node3, self.Node4 }
end


local function GetCurrNum(self)
    -- if self:IsBigWin() then
    --     return self.bigwinNum
    -- elseif self:IsNormalWin() then
    --     return self.winNum
    -- else
        return self.Num
   -- end
end

local function GetCurrCoinText(self)
    -- if self:IsBigWin() then
    --     local  coinNum = fun.find_child(self.bigwinNum,"number/coinNum")
    --     return  fun.get_component(coinNum,"RollingSpriteNumber")
    -- elseif self:IsNormalWin()  then
    --     local  coinNum = fun.find_child(self.winNum,"number/coinNum")
    --     return  fun.get_component(coinNum,"RollingSpriteNumber")
    -- else
       
    -- end

    local  coinNum = fun.find_child(self.Num,"number/coinNum")
    return  fun.get_component(coinNum,"RollingSpriteNumber")
end

local function GetCurrCoinSpriteAsset(self)
    -- if self:IsBigWin() then
    --     local  coinNum = fun.find_child(self.bigwinNum,"number/coinNum")
    --     return  fun.get_component(coinNum,fun.SPRITETXTPRO)
    -- elseif self:IsNormalWin()  then
    --     local  coinNum = fun.find_child(self.winNum,"number/coinNum")
    --     return  fun.get_component(coinNum,fun.SPRITETXTPRO)
    -- else
      
    -- end

    local  coinNum = fun.find_child(self.Num,"number/coinNum")
    return  fun.get_component(coinNum,fun.SPRITETXTPRO)
end


local lastAddCount = 0
---@see 设置累加数字
function SettleClimbRankedView:SetAddCountTxt(count)
    totalCoinCount = totalCoinCount + count
    lastAddCount = count
end

---@see 设置爬排名卡牌奖励项目
local SetRewardIcon = function(img, type)
    local spriteName = "dt0016"
    local atlasName = "ClimbRankAtlas"
    if type == 1 then
        spriteName = "dt0016"
    elseif type == 2 then
        spriteName = "QuickDaubFont"
    elseif type == 3 then
        spriteName = "PerfectDaubingFont"
    elseif type == 4 then
        spriteName = "bingoFont"
    elseif type == 5 then
        spriteName = "doublebingoFont"
    elseif type == 6 then
        spriteName = "triplebingoFont"
    elseif type == 7 then
        spriteName = "bingorampageFont"
    elseif type == 8 then
        spriteName = "powerup_icon_002"
        atlasName = "ItemAtlas"
    end
    img.sprite = AtlasManager:GetSpriteByName(atlasName, spriteName)
    img:SetNativeSize()
end

local SetRewardText = function(self,text, type, count)
    text.text = "X" ..fun.formatNum(count)
    text.spriteAsset = GetCurrCoinSpriteAsset(self).spriteAsset
    if type == 1 or type == 2 or type == 8 then
        fun.set_active(text.gameObject, true)
    else
        fun.set_active(text.gameObject, false)
    end
end

---@see 设置各卡的新增奖励
function SettleClimbRankedView:SetAddReward(cardId, type, count)
    if count > 0 then
        if type ~= 9 then
            local text = self["multipleNum" .. cardId]
            local img = self["daub" .. cardId]
            SetRewardIcon(img, type)
            SetRewardText(self,text, type, count)
            fun.set_active(self["Tex" .. cardId], true)
        else
            SetRewardText(self,self.JackpotNum, type, count)
            fun.set_active(self.Jackpot, true)
            fun.set_active(self["Tex" .. cardId], false)

            local playType = ModelList.BattleModel:GetGameType()
            if playType == PLAY_TYPE.PLAY_TYPE_VICTORY_BEATS then
                if self.jackpot_img then
                    self.jackpot_img.sprite = AtlasManager:GetSpriteByName("WinZoneBattleAtlas", "VictoryFont")
                end
            end
        end
    else
        fun.set_active(self["Tex" .. cardId], false)
    end
end

---@see  大数字退场动画
local PlayBigNumExit = function(self)
    if GetCurrNum(self) then
        GetCurrNum(self):Play("out")
    end
end

local RefreshSelfData = function(self)
    if GetSelfItem(self) then
        GetSelfItem(self).RefreshSelfData(GetSelfItem(self), currRank , totalCoinCount)
    end
end

local jumpTime = 0.5

---@see 播放奖励跳跃动画
function SettleClimbRankedView:PlayRewardJump(callBack)
    if not IsFirstNum then
        self.smallcoinNum.text = "+" .. fun.formatNum(lastAddCount)
        self.smallcoinNum.spriteAsset = GetCurrCoinSpriteAsset(self).spriteAsset

        fun.set_active(self.SmallcoinNode, true)
    end
    UISound.play("rank_single_reward")
    if ModelList.BattleModel:GetCurrBattleView():IsAuto() then
        self.cardsAnima:Play("efcards8", 0, 0)
    else
        self.cardsAnima:Play("efcards", 0, 0)
    end

    fun.set_active(GetCurrNum(self).gameObject, true)
    
    if self:IsBigWin() then 
        GetCurrNum(self):Play("inbigwin", 0, 0)
    elseif self:IsNormalWin() then 
        GetCurrNum(self):Play("inwin", 0, 0)
    else
        GetCurrNum(self):Play("in", 0, 0)
    end

   
    local delayFunc1 = LuaTimer:SetDelayFunction(1.3, function()
        GetCurrCoinText(self):RollByTime(totalCoinCount, jumpTime, nil)
        
        GetCurrNum(self):Play("act", 0, 0)

        if self:IsBigWin() then 
            UISound.play("bigwin_single_reward")  --bigwin 卡点音乐
        end 

        if not IsFirstNum then
            local delayFunc3 = LuaTimer:SetDelayFunction(jumpTime + 0.1, function()
                RefreshSelfData(self)
                if callBack then
                    callBack()
                end
                LuaTimer:Remove(self.delayList[3])
                self.delayList[3] = 0
            end)
            self.delayList[3] = delayFunc3
        else
            IsFirstNum = false
            local delayFunc2 = LuaTimer:SetDelayFunction(jumpTime + 0.1, function()
                RefreshSelfData(self)
                if callBack then
                    callBack()
                end
                LuaTimer:Remove(self.delayList[2])
                self.delayList[2] = 0
            end)
            self.delayList[2] = delayFunc2
        end
        LuaTimer:Remove(self.delayList[1])
        self.delayList[1] = 0
    end)
    self.delayList[1] = delayFunc1
end

--最后展现最后一次效果
function SettleClimbRankedView:PlayRewardFinal(callBack)
    local detalTime = 2
    fun.set_active(GetCurrNum(self).gameObject, false)
    fun.set_active(self.Rankedwin,true)
    UnityEngine.Time.timeScale = 1

    if self:IsBigWin() then
        self.RankedwinAim:Play("bigwin",0,0)
        self.RankedwinNum:RollByTime(totalCoinCount, 3, nil)
        detalTime = 10
        self.update_x_enabled = true
        self:start_x_update()
    else
        self.RankedwinAim:Play("win",0,0)
        self.RankedwinNum:RollByTime(totalCoinCount, 2, nil)
        detalTime = 4
    end
    self:ShowTopThreeEffect()

    this.detalFinalCallback = callBack
    this.detalFinalTime = LuaTimer:SetDelayFunction(detalTime, function()
        self:initSpeedUp()
        fun.set_active(self.Rankedwin,false)
        self:StopTopThreeEffect()
        this.detalFinalTime = nil
        RefreshSelfData(self)
        if callBack then
            callBack()
            this.detalFinalCallback = nil
        end
    end)
end

function SettleClimbRankedView:CheckAnima()
    if fun.is_not_null(self.RankedwinAim) then
        if self.RankedwinAim:GetCurrentAnimatorStateInfo(0):IsName("bigwinidle") then
            self:ChangeToBigWinIdleLoop()
            self:stop_x_update()
        end
    else
        self:stop_x_update()
    end
end

function SettleClimbRankedView:on_x_update()
    self:CheckAnima()
end

---@see 自身rank获得金币效果
local PlaySelfRankItemStarEffect = function(self)
    BattleEffectCache:GetFreePrefabFromCache("efClimbRankItemStar", GetSelfRankObj(self), 0)
end

function SettleClimbRankedView:CoinExitEffect()
    PlayBigNumExit(self)
end

---@see 播放金币向上飞效果
function SettleClimbRankedView:PlayCoinFly(callBack)
    if not self or fun.is_null(self.go) then return end
    local settleData = ModelList.BattleModel:GetCurrModel():GetSettleData()
    local selfRank = 0
    for i = 1, #settleData.ranks do
        if settleData.ranks[i].nickName == "0" then
            selfRank = i
            break
        end
    end
    fun.set_active(GetCurrNum(self), false)
    PlaySelfRankItemStarEffect(self)
    UISound.play("rank_total_reward")
    if self and self.go then
        self:RankRollEffect(selfRank)
    end
end

--打开爬排名面板处理
function SettleClimbRankedView:Open()

end

-- 退出爬排名
function SettleClimbRankedView:Exit()
    ViewList.GameSettleView:OpenRound4()
end

this.efClimbRankItemTail = nil

local function GetTailPrefabName(self)
    if self:IsBigWin() then
        return "efClimbRankItemTailbigwin"
    elseif self:IsNormalWin() then
        return "efClimbRankItemTailwin"
    else
        return "efClimbRankItemTail"
    end
end

---@see 爬排名效果
function SettleClimbRankedView:RankRollEffect(targetIndex)
    targetRank = targetIndex

    BattleEffectCache:GetFreePrefabFromCache(GetTailPrefabName(self), GetSelfRankObj(self), 0, function(obj)
        self.efClimbRankItemTail = obj
    end)
    LuaTimer:SetDelayFunction(0.8, function()
        self:LoopItem(true)
    end)
end


function SettleClimbRankedView:LoopItem(isStart)
    if not self or fun.is_null( self.go) then return end
    isStart = isStart and true or false
    if currRank > 1 then
        if currRank <= 4 then
            self:LoopSelfNextItem()
            UISound.play("rank_rise")
        elseif currRank <= #self.ranksObj - 2 then
            self:LoopOtherItem()
            UISound.play("rank_rise")
        else
            self:LoopSelfNextItem()
            UISound.play("rank_rise")
        end
    end
    if not isStart then
        self:RefreshData()
    end
end

function SettleClimbRankedView:RefreshData()
    for i = currRank - 1, #self.ranksObj - 1 do
        self.ranksObj[i].RefreshOtherData(self.ranksObj[i], i+1 )
    end
    GetSelfItem(self).RefreshSelfData(GetSelfItem(self), currRank - 1, totalCoinCount)
end

function SettleClimbRankedView:LoopSelfNextItem()
    local pos = GetSelfRankObj(self).transform.localPosition
    if currRank > targetRank then
        Anim.move_to_xy_local(GetSelfRankObj(self), pos.x, pos.y + singleOffset, singleMoveTime, function()
            currRank = currRank - 1
            local oriPos = fun.get_gameobject_pos(self.ranksObj[currRank].go, true)
            fun.set_rect_anchored_position(self.ranksObj[currRank].go, oriPos.x, oriPos.y - singleOffset)
            if currRank > targetRank then
                self:LoopItem()
            else
                self:EndView()
            end
        end)
    else
        self:EndView()
    end
end

function SettleClimbRankedView:LoopOtherItem()
    local totalCount = #self.ranksObj
    for i = 1, #self.ranksObj-1 do
        local pos = self.ranksObj[i].go.transform.localPosition
        local interval = 1
        if i == currRank - 1 then
            interval = 2
        end
        if i == totalCount then
            break
        end
        Anim.move_to_xy_local(self.ranksObj[i].go, pos.x, pos.y - singleOffset * interval, otherMoveTime, function()
            if i == totalCount - 1 then
                currRank = currRank - 1
                if currRank > targetRank then
                    self:LoopItem()
                else
                    self:EndView()
                end
            end
        end)

    end
    otherMoveTime = otherMoveTime - 0.05
    if otherMoveTime <= 0.1 then
        otherMoveTime = 0.1
    end
end

function SettleClimbRankedView:EndView()
    if self.efClimbRankItemTail and not Util.IsNull(self.efClimbRankItemTail) then
        Destroy(self.efClimbRankItemTail)
    end
    BattleEffectCache:GetFreePrefabFromCache("efClimbRankItemShow", GetSelfRankObj(self), 0)
    UISound.play("rank_determine")
    local delayFunc5 = LuaTimer:SetDelayFunction(1, function()
        ViewList.GameSettleView:ExitTransitionView("SettleRankView")
        Facade.SendNotification(NotifyName.CloseUI, self)
    end)
    self.delayList[5] = delayFunc5
end


---给字体设置 normal  win  bigwin字体
function SettleClimbRankedView:SetTextFont()

end

function SettleClimbRankedView:initSpeedUp()

    if ModelList.GuideModel.IsFirstBattle() then 
        fun.set_active(self.btn_speedUp,false)
        return 
    end 

    local flag = ViewList.GameSettleView:GetSpeedUp()
    local on = fun.find_child(self.btn_speedUp,"on")
    local off =  fun.find_child(self.btn_speedUp,"off")
    if flag == false then --加速状态
        fun.set_active(on,true)
        fun.set_active(off,false)
        ViewList.GameSettleView:SetSpeedUp(2)
    end 
end

--

function SettleClimbRankedView:on_btn_speedUp_click()
    local flag =  ViewList.GameSettleView:SpeedUp(2)
    local on = fun.find_child(self.btn_speedUp,"on")
    local off =  fun.find_child(self.btn_speedUp,"off")
    if flag then 
        fun.set_active(on,false)
        fun.set_active(off,true)
    else 
        fun.set_active(on,true)
        fun.set_active(off,false)
    end 
end

function SettleClimbRankedView:on_btn_climbRank_click()
    if this.detalFinalTime ~= nil then
        if self.RankedwinAim:GetCurrentAnimatorStateInfo(0) :IsName("bigwin") then
            self:stop_x_update()
            self:ChangeToBigWinIdleLoop()
        elseif self.RankedwinAim:GetCurrentAnimatorStateInfo(0) :IsName("bigwinidle") then
            self:stop_x_update()
            self.RankedwinAim:Play("bigwinend",0,0)
            if self.loopTimeDelay then
                LuaTimer:Remove(self.loopTimeDelay)
                self.loopTimeDelay = nil
            end
            self:StopTopThreeEffect()
            this.detalFinalTime = nil
            RefreshSelfData(self)
            if this.detalFinalCallback then
                this.detalFinalCallback()
                this.detalFinalCallback = nil
            end
        end
    end
end

function SettleClimbRankedView:ChangeToBigWinIdleLoop()
    if self.loopTimeDelay then return end
    self.RankedwinAim:Play("bigwinidle")
    self.RankedwinNum:StopToEnd()
    --- 刷新倒计时文本
    self.leftTime = 5
    self.loopTimeDelay = LuaTimer:SetDelayLoopFunction(1,1,5,function()
        if fun.is_not_null( self.timeText) then
            self.leftTime = self.leftTime - 1
            self.timeText.text = self.leftTime
            if self.leftTime <= 0 then
                self:StopBigWinEffect()
                LuaTimer:Remove(self.loopTimeDelay)
                self.loopTimeDelay = nil
            end
        end
    end)
end


function SettleClimbRankedView:StopBigWinEffect()
    if this.detalFinalTime ~= nil then
        LuaTimer:Remove(this.detalFinalTime)
    end
    self:stop_x_update()
    self.RankedwinAim:Play("bigwinend",0,0)
    --fun.set_active(self.Rankedwin,false) --隐藏效果
    self:StopTopThreeEffect()  -- 停止音乐
    this.detalFinalTime = nil
    self:initSpeedUp()
    if this.detalFinalCallback then
        this.detalFinalCallback()
    end
end

--- 从战斗中获取卡牌，不经过小火箭界面
function SettleClimbRankedView:SetCardsIgnoreRocket(NodeList)
    this.model = ModelList.BattleModel:GetCurrModel()
    local card_list  = ModelList.BattleModel:GetCurrBattleView():GetCardMapsObject()
    local count = this.model:GetCardCount()
    local normalMap = require("View.Bingo.Base.NormalMap")
    local gameMode = ModelList.CityModel:GetEnterGameMode()
    local gameType = ModelList.BattleModel:GetGameCityPlayID()
    local climb_rank_card_size = Csv.GetData("new_game_settle", gameType, "climb_rank_card_size")
    for i = 1, #card_list do
        if not Util.IsNull(card_list[i]) and i<= count  then
            fun.set_parent(card_list[i],NodeList[i],false)
            if gameMode == PLAY_TYPE.PLAY_TYPE_SCRATCH_WINNER then
                card_list[i].transform.localPosition = Vector3.New(0, -60, 0)
            elseif gameMode == PLAY_TYPE.PLAY_TYPE_GOLD_TRAIN then
                card_list[i].transform.localPosition = Vector3.New(-20, -50, 0)
            elseif gameMode == PLAY_TYPE.PLAY_TYPE_LET_THEM_ROLL then
                card_list[i].transform.localPosition = Vector3.New(-16, -16, 0)
            else
                card_list[i].transform.localPosition = Vector3.New(0, 0, 0)
            end
            card_list[i].transform.localScale = Vector3.New(climb_rank_card_size[1], climb_rank_card_size[2], 1)
        end
        normalMap:HideNum(card_list[i])
    end

    ---界面已经准备完成，可以卸载掉摇奖界面
    this:ClearSmallGameView()
end

--- 小丑机台，替换成小丑BigWin效果
function    SettleClimbRankedView:ReplaceBigWinForJoker()
    if ModelList.BattleModel:GetIsJokerMachine() then

        Cache.load_prefabs(AssetList["Num_clown"],"Num_clown",function (prefab)
            if Util.IsNull(prefab) then
                return
            end
            local go = GameObject.Instantiate(prefab)
            fun.set_active(self.Num,false)
            fun.set_parent(go,self.Num.transform.parent,true)
            self.Num = fun.get_component(go,fun.ANIMATOR )
            local root = fun.find_child(go,"number")
            if root then
                self.number = fun.get_component(root,fun.REFER )
            end
            local coinNum = fun.find_child(go,"number/coinNum")
            if coinNum then
                self.coinNum = fun.get_component(coinNum,"RollingSpriteNumber" )
            end
        end)

        --- 有win 和  bigWin效果才替换小丑效果
        if winEffect < 3 then
            Cache.load_prefabs(AssetList["SettleClimbRankedwin_clown"],"SettleClimbRankedwin_clown",function (prefab)
                if Util.IsNull(prefab) then
                    return
                end
                local go = GameObject.Instantiate(prefab)
                fun.set_active(self.Rankedwin,false)
                fun.set_parent(go,self.Rankedwin.transform.parent,true)
                self.Rankedwin = go
                local root = fun.find_child(go,"GameOverRound4/root")
                if root then
                    self.RankedwinAim = fun.get_component(root,fun.ANIMATOR )
                end
                local RankedwinNum = fun.find_child(go,"GameOverRound4/root/number (1)/coinNum")
                if RankedwinNum then
                    self.RankedwinNum = fun.get_component(RankedwinNum,"RollingSpriteNumber" )
                end
                local timeText = fun.find_child(go,"GameOverRound4/root/text")
                if timeText then
                    self.timeText = fun.get_component(timeText,fun.OLDTEXT )
                end
            end)
        end
    end
end

function SettleClimbRankedView:ShowSuperMatchRewards(rewards, finishCb)
    fun.set_active(self.SuperMatch, true)
    local ref = fun.get_component(self.SuperMatch, fun.REFER)
    if not ref then
        if finishCb then
            finishCb()
        end
        return
    end

    local effect = ref:Get("effectRoot")
    local imgHead = ref:Get("imgHead")
    local imageFrame = ref:Get("imageFrame")
    local imgBingo = ref:Get("imgBingo")
    local txtScore = ref:Get("txtScore")
    local txtTotalScore = ref:Get("txtTotalScore")

    local mateId = ModelList.SuperMatchModel:GetMateIdForSettle()
    --[[测试数据
    mateId = 33175
    --]]

    fun.set_active(txtTotalScore, false)
    local sysModel = ModelList.PlayerInfoSysModel
    ModelList.PlayerInfoSysModel:LoadRobotTargetHeadSprite(mateId, imgHead)
    ModelList.PlayerInfoSysModel:LoadRobotTargetFrameSprite(mateId, imageFrame)

    if not rewards or fun.is_table_empty(rewards) then
        if finishCb then
            finishCb()
        end
    else
        fun.set_active(self.SmallcoinNode, false)
        --self:ShowSuperMatchRewardAnimV1(finishCb, rewards, imgBingo, txtScore, txtTotalScore, 1, 0)
        self:ShowSuperMatchRewardAnimV2(finishCb, rewards, imgBingo, txtScore, txtTotalScore)
    end
end

--one by one
function SettleClimbRankedView:ShowSuperMatchRewardAnimV1(finishCb, rewards, imgBingo, txtScore, txtTotalScore, idx, stageAddCount)
    idx = idx or 1
    if idx > #rewards then
        self:SetAddCountTxt(stageAddCount)
        self:PlaySuperMatchRewardJump(finishCb)
        return
    end

    SetRewardIcon(imgBingo, rewards[idx].bingoNum + 3)
    txtScore.text = "+" .. fun.formatNum(rewards[idx].content)
    txtScore.spriteAsset = GetCurrCoinSpriteAsset(self).spriteAsset

    fun.set_active(imgBingo.gameObject, true)
    fun.set_active(txtScore.gameObject, true)
    self:register_invoke(function()
        -- fun.set_active(imgBingo.gameObject, false)
        -- fun.set_active(txtScore.gameObject, false)
        stageAddCount = stageAddCount + rewards[idx].content
        fun.set_active(txtTotalScore, true)
        txtTotalScore.text = fun.formatNum(stageAddCount)
        txtTotalScore.spriteAsset = GetCurrCoinSpriteAsset(self).spriteAsset
        self:ShowSuperMatchRewardAnim(finishCb, rewards, imgBingo, txtScore, txtTotalScore, idx + 1, stageAddCount)
    end, 1)
end

--简化版
function SettleClimbRankedView:ShowSuperMatchRewardAnimV2(finishCb, rewards, imgBingo, txtScore, txtTotalScore)
    local totalScore = 0
    for i, v in ipairs(rewards) do
        totalScore = totalScore + rewards[i].content
    end
    txtTotalScore.text = "+" .. fun.formatNum(totalScore)
    txtTotalScore.spriteAsset = GetCurrCoinSpriteAsset(self).spriteAsset
    fun.set_active(self.SuperMatch, false)
    fun.set_active(self.SuperMatch, true)
    fun.set_active(txtScore, false)
    fun.set_active(txtTotalScore, true)
    
    self:register_invoke(function()
        self:SetAddCountTxt(totalScore)
        self:PlaySuperMatchRewardJump(finishCb)
    end, 1.3)
end

---@see 播放奖励跳跃动画
function SettleClimbRankedView:PlaySuperMatchRewardJump(callBack)
    UISound.play("rank_single_reward")
    --[[
    if ModelList.BattleModel:GetCurrBattleView():IsAuto() then
        self.cardsAnima:Play("efcards8", 0, 0)
    else
        self.cardsAnima:Play("efcards", 0, 0)
    end
    --]]

    fun.set_active(GetCurrNum(self).gameObject, true)
    if self:IsBigWin() then 
        GetCurrNum(self):Play("inbigwin", 0, 0)
    elseif self:IsNormalWin() then 
        GetCurrNum(self):Play("inwin", 0, 0)
    else
        GetCurrNum(self):Play("in", 0, 0)
    end

    local delayFunc1 = LuaTimer:SetDelayFunction(1.3, function()
        GetCurrCoinText(self):RollByTime(totalCoinCount, jumpTime, nil)
        GetCurrNum(self):Play("act", 0, 0)
        if self:IsBigWin() then 
            UISound.play("bigwin_single_reward")  --bigwin 卡点音乐
        end

        LuaTimer:Remove(self.delayList[1])
        self.delayList[1] = 0

        local delayFunc2 = LuaTimer:SetDelayFunction(jumpTime + 0.1, function()
            RefreshSelfData(self)
            fun.set_active(self.SuperMatch, false)
            if callBack then
                callBack()
            end
            LuaTimer:Remove(self.delayList[2])
            self.delayList[2] = 0
        end)
        self.delayList[2] = delayFunc2
    end)

    self.delayList[1] = delayFunc1
end

---清理小游戏界面
function SettleClimbRankedView:ClearSmallGameView()
    if ViewList.ScratchWinnerExtraBallView then
        ---可以卸载掉摇奖界面
        Facade.SendNotification(NotifyName.CloseUI, ViewList.ScratchWinnerExtraBallView)
        ViewList.ScratchWinnerExtraBallView = nil
    end
    if ViewList.SettleGoldenTrainPerformanceView then
        ---可以卸载掉金币火车表演
        Facade.SendNotification(NotifyName.CloseUI, ViewList.SettleGoldenTrainPerformanceView)
        ViewList.SettleGoldenTrainPerformanceView = nil
    end
    if ViewList.ChristmasSynthesisExtraBallView then
        ---可以卸载掉摇奖界面
        Facade.SendNotification(NotifyName.CloseUI, ViewList.ChristmasSynthesisExtraBallView)
        ViewList.ChristmasSynthesisExtraBallView = nil
    end
    if ViewList.GotYouSmallGameView then
        ---可以卸载掉摇奖界面
        Facade.SendNotification(NotifyName.CloseUI, ViewList.GotYouSmallGameView)
        ViewList.GotYouSmallGameView = nil
    end
    if ViewList.SGExtraBallMainView then
        ---可以卸载掉摇奖界面
        Facade.SendNotification(NotifyName.CloseUI, ViewList.SGExtraBallMainView)
        ViewList.SGExtraBallMainView = nil
    end
end


return this
