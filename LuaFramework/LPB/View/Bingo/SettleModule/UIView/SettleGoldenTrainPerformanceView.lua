---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 25/10/2024 ���� 2:25
---


local SettleGoldenTrainPerformanceView = BaseView:New('SettleGoldenTrainPerformanceView', 'GoldenTrainPerformanceAtlas');

local this = SettleGoldenTrainPerformanceView
this.viewType = CanvasSortingOrderManager.LayerType.Machine_Dialog
this.auto_bind_ui_items = {
    "CardNode1",
    "CardNode2",
    "CardNode3",
    "CardNode4",
    "btn_continue",
    "RootAnima",
    "TrainAnima",
    "WinEffect",
    "WinEffectText",
    "Text1"
}

local card_list = {}

function SettleGoldenTrainPerformanceView:Awake()
    self:on_init()

    --- 清理金币飞行池,避免战斗金币回收问题,导致一直播放金币chips声音
    this.moduleList = require("View.Bingo.BattleModuleList")
    if this.moduleList then
        this.effContainer = this.moduleList.GetModule("EffectEntry") --效果模块，较为常用，单独设置一个直接引用
        if this.effContainer then
            this.effContainer:ClearCoinPool()
        end
        this.effContainer = nil
    end
    this.moduleList = nil
end

function SettleGoldenTrainPerformanceView:OnEnable()
    this.info = ModelList.GoldenTrainModel:GetSmallGameData()
    ---todo:开发中,测试屏蔽
    --this:ReadyForCurrentView()

    this:RegisterEvent()
    ModelList.BattleModel:GetCurrBattleView():SetContainerForOtherView(self.go)
    UISound.stop_loop("chips")
    UISound.stop_loop("settlement_bgm")
    UISound.play_loop("goldentrainwinbgm")

    this:BuildFsm()
    --UnityEngine.EditorApplication.isPaused = true
end

function SettleGoldenTrainPerformanceView:GetCards()
    return ModelList.BattleModel:GetCurrModel():GetCards()
end

function SettleGoldenTrainPerformanceView:BuildFsm()
    FsmCreator:Create("SettleGoldenTrainPerformanceView", self, {
        require("View.Bingo.SettleModule.State.GoldenTrain.IdleState"),
        require("View.Bingo.SettleModule.State.GoldenTrain.CoinsTurnState"),
        require("View.Bingo.SettleModule.State.GoldenTrain.BingoOrderState"),
        require("View.Bingo.SettleModule.State.GoldenTrain.GrowTrainState"),
        require("View.Bingo.SettleModule.State.GoldenTrain.SwitchNextCardState"),
        require("View.Bingo.SettleModule.State.GoldenTrain.CompleteState"),
        require("View.Bingo.SettleModule.State.GoldenTrain.ExitState"),
        require("View.Bingo.SettleModule.State.GoldenTrain.ExtraRewardState"),
        require("View.Bingo.SettleModule.State.GoldenTrain.CardWinState"),
    })
    self.state = {
        IdleState = "IdleState",
        CoinsTurnState = "CoinsTurnState",
        BingoOrderState = "BingoOrderState",
        GrowTrainState = "GrowTrainState",
        SwitchNextCardState = "SwitchNextCardState",
        CompleteState = "CompleteState",
        ExitState = "ExitState",
        ExtraRewardState = "ExtraRewardState",
        CardWinState = "CardWinState",
    }
    self._fsm:StartFsm(self.state.IdleState)
end

function SettleGoldenTrainPerformanceView:OnDisable()
    ModelList.BattleModel:GetCurrBattleView():SetContainerForOtherView(ViewList.SettleRocketView.go)
    card_list = nil
    this:UnRegisterEvent()
    self:ClearData()
    UISound.stop_loop("goldentrainwinbgm")
    UISound.stop_loop("goldentrainrun")
    UISound.play_loop("settlement_bgm")
end

function SettleGoldenTrainPerformanceView:OnDestroy()
    ModelList.BattleModel:GetCurrBattleView():SetContainerForOtherView(ViewList.SettleRocketView.go)
    self:Destroy()
    self:ClearData()
end

function SettleGoldenTrainPerformanceView:GetNodeList()
    return { self.Node1, self.Node2, self.Node3, self.Node4 }
end

---切换卡牌的父物体，过度到另一个界面使用，期间卡牌不能被隐藏，
function SettleGoldenTrainPerformanceView:ReadyForCurrentView()
    if not this.BingoOrder then this:CollectData() end
    local count = ModelList.GoldenTrainModel:GetCardCount()
    if ModelList.BattleModel:GetCurrBattleView() then
        card_list = ModelList.BattleModel:GetCurrBattleView():GetCardMapsObject()
    end
    this.isFirstMapMove = true
    if card_list then
        local firstMap = true
        for i = 1, #card_list do
            local data = this.BingoOrder[tostring(i)]
            if data and #data > 0 and not Util.IsNull(card_list[i]) and i <= count then
                fun.set_parent(card_list[i], this["CardNode" .. (firstMap and 1 or i)], true)
                firstMap = false
            end
        end
        BattleEffectCache.CardHideAllBindEffect()
        BattleEffectPool.CardHideAllBindEffect()
    end
end

function SettleGoldenTrainPerformanceView:GetNode1()
    return this.CardNode1
end

function SettleGoldenTrainPerformanceView:on_x_update()
    self:CheckAnima()
end

function SettleGoldenTrainPerformanceView:Exit()
    ViewList.GameSettleView:OpenRound4()
end

--- 检查是否等待数据时间过长
function SettleGoldenTrainPerformanceView:GetSettleData()
    this.HadSettle = true
end

---游戏不存在的处理
function SettleGoldenTrainPerformanceView:GameNotExist()
    if this.HadSettle then
        ViewList.GameSettleView:JumpNextView()
        Facade.SendNotification(NotifyName.HideUI, ViewList.SettleGoldenTrainPerformanceView)
        --ViewList.SettleGoldenTrainPerformanceView = nil
    else
        Facade.SendNotification(NotifyName.HideUI, ViewList.SettleGoldenTrainPerformanceView)
        Event.Brocast(Notes.QUIT_BATTLE)

        local loadingView = ViewList.SceneLoadingGameView
        LoadScene("SceneHome", loadingView, true)
        --UnityEngine.Resources.UnloadUnusedAssets()
    end
end

function SettleGoldenTrainPerformanceView:RegisterEvent()
    --Event.AddListener(EventName.Event_Receive_Game_Settle_Data, this.GetSettleData)
    --Event.AddListener(EventName.Player_Bingo_Reduce_Bingoleft, this.ReduceBingoleftTick)
    --Event.AddListener(EventName.Game_Not_Exist_Msg, this.GameNotExist)
end

---
function SettleGoldenTrainPerformanceView:UnRegisterEvent()
    --Event.RemoveListener(EventName.Event_Receive_Game_Settle_Data, this.GetSettleData)
    --Event.RemoveListener(EventName.Player_Bingo_Reduce_Bingoleft, this.ReduceBingoleftTick)
    --Event.RemoveListener(EventName.Game_Not_Exist_Msg, this.GameNotExist)
end

function SettleGoldenTrainPerformanceView:on_btn_continue_click()
    if this:IsWaitSign() then return end
    if not this:IsPlayingBingoEffect() then return end
    ViewList.GameSettleView:JumpNextView()
    Facade.SendNotification(NotifyName.HideUI, ViewList.SettleGoldenTrainPerformanceView)
    --ViewList.SettleGoldenTrainPerformanceView = nil
end

--- 收集界面需要的数据
function SettleGoldenTrainPerformanceView:CollectData()
    if not this.BingoOrder then
        --- bingo顺序的数据
        this.BingoOrder, this.SettleInfo = ModelList.GoldenTrainModel:GetBingoOrder()
        this.cardCount = ModelList.BattleModel:GetCurrModel():GetCardCount()
        this.WaitPerformanceIds = {}
        this.PlayingCardId = nil
        this.PlayingBingoOrderIndex = nil
        this.ExtraRewardPosInfo = {}
        for i = 1, this.cardCount do
            local data = this.BingoOrder[tostring(i)]
            if data and #data > 0 then
                if not this.PlayingBingoOrderIndex then this.PlayingBingoOrderIndex = 1 end
                if not this.PlayingCardId then
                    this.PlayingCardId = i
                else
                    table.insert(this.WaitPerformanceIds, i)
                end
            end

            local data2 = this.SettleInfo[tostring(i)]
            if data2 and data2.markedPos then
                for k = 1, #data2.markedPos do
                    if data2.markedPos[k].extRewardValue > 0 then
                        ---收集奖励事件数据
                        if not this.ExtraRewardPosInfo[i] then
                            this.ExtraRewardPosInfo[i] = {}
                        end
                        table.insert(this.ExtraRewardPosInfo[i],
                            {
                                pos = data2.markedPos[k].pos,
                                extRewardValue = data2.markedPos[k].extRewardValue,
                                cardId = data2.cardId
                            })
                    end
                end
            end
        end
    end
end

---返回当前正在等待播放动画的id
function SettleGoldenTrainPerformanceView:GetCardBingoCellsInfo()
    return this.PlayingCardId, this.BingoOrder[tostring(this.PlayingCardId)]
end

---返回当前正在等待播放动画的Bingo格子
function SettleGoldenTrainPerformanceView:GetCurrBingoCellsInfo()
    return this.PlayingCardId, this.BingoOrder[tostring(this.PlayingCardId)][this.PlayingBingoOrderIndex]
end

---返回当前正在等待播放动画的Bingo格子
function SettleGoldenTrainPerformanceView:GetCurrBingoPathReward()
    local bingoPath = this.BingoOrder[tostring(this.PlayingCardId)][this.PlayingBingoOrderIndex]
    local pathReward = this.SettleInfo[tostring(this.PlayingCardId)].pathReward
    for i = 1, #pathReward do
        if pathReward[i].bingoPath == bingoPath then
            return pathReward[i]
        end
    end
end


function SettleGoldenTrainPerformanceView:GetCurrCardFinalRewardCoin()
    local allRewardCoin = this.SettleInfo[tostring(this.PlayingCardId)].allRewardCoin
    return allRewardCoin
end

---完成一个Bingo回合的表现
function SettleGoldenTrainPerformanceView:CompleteBingoRound()
    this.PlayingBingoOrderIndex = this.PlayingBingoOrderIndex + 1
    if this.PlayingBingoOrderIndex > #this.BingoOrder[tostring(this.PlayingCardId)] then
        if not this.WaitPerformanceIds or # this.WaitPerformanceIds == 0 then
            --播放完所有bingo，退场
            self._fsm:ChangeState("ExitState")
        else
            ---播放下张卡的Bingo回合
            local previoursCardId = this.PlayingCardId
            this.PlayingCardId = table.remove(this.WaitPerformanceIds, 1)
            this.PlayingBingoOrderIndex = 1
            self._fsm:ChangeState("SwitchNextCardState", this.PlayingCardId, previoursCardId)
        end
    else
        self._fsm:ChangeState("BingoOrderState")
    end
end

---返回当前正在等待播放动画的id
function SettleGoldenTrainPerformanceView:GetWaitPerformanceId()
    if #this.WaitPerformanceIds > 0 then
        this.waitingId = this.WaitPerformanceIds[1]
        return table.remove(this.WaitPerformanceIds, 1)
    end
end

---播放划线动效
---@param centerPos : 居中格子的坐标
---@param direction : 方向:1横向2竖3斜左4斜右5四角
function SettleGoldenTrainPerformanceView:PlayLineEffect(cardId, centerCellIndex, direction)
    local cell = ViewList.GoldenTrainBingoView:GetCardView():GetCardCell(cardId, centerCellIndex)
    BattleEffectCache:GetPrefabFromPoolOrCache("GoldenTrainhuaxian", cell, function (go)
        if fun.is_not_null(go) then
            local anima = fun.get_component(go, fun.ANIMATOR)
            anima:Play("huaxian" .. direction)
        end

        LuaTimer:SetDelayFunction(2, function ()
            BattleEffectPool:Recycle("GoldenTrainhuaxian", go)
            this._fsm:GetCurState():PlayFlyCoinsEffect()
        end)
    end, 2)
end

--- 保存已经飞行过的格子数据
function SettleGoldenTrainPerformanceView:SaveFlyCoinsData(cardId, cellIndex)
    if not this.FlyCoinsData then
        this.FlyCoinsData = {}
    end
    if not this.FlyCoinsData[cardId] then
        this.FlyCoinsData[cardId] = {}
    end
    table.insert(this.FlyCoinsData[cardId], cellIndex)
end

--- 检查格子是否已经飞行过
function SettleGoldenTrainPerformanceView:HadFlyCoins(cardId, cellIndex)
    if this.FlyCoinsData and this.FlyCoinsData[cardId] then
        return fun.is_include(cellIndex, this.FlyCoinsData[cardId])
    end
end

---离开的时候清理数据
function SettleGoldenTrainPerformanceView:ClearData()
    this.FlyCoinsData = nil
    this.BingoOrder = nil
    this.HadSettle = false
    this.WaitPerformanceIds = nil
    this.FlyCoinsData = nil
    this.cardGrowNum = nil
end

---设置当前卡牌的数值进度
function SettleGoldenTrainPerformanceView:SetCardProgress(isInit, addValue)
    if isInit then
        self.cardGrowNum = this.baseRewardRange[this.PlayingCardId]
        self.sourNum = self.cardGrowNum
    else
        if not self.cardGrowNum then self.cardGrowNum = 0 end
        self.cardGrowNum = self.cardGrowNum + addValue
    end
end

---获取当前bingo后的新进度
function SettleGoldenTrainPerformanceView:GetCardProgress()
    ---直接用后端给的总数
    local pathReward = self:GetCurrBingoPathReward()
    if pathReward then
        return self.sourNum or 100, pathReward.allRewardValue
    end
    return self.sourNum or 100, self.cardGrowNum or 100 --自己累加的方式
end

---获取当前bingo后的新进度
function SettleGoldenTrainPerformanceView:RefreshCardProgress()
    if self.sourNum and self.cardGrowNum then
        self.sourNum = self.cardGrowNum
    end
end

--- 播放卡牌上阵和退出动画
function SettleGoldenTrainPerformanceView:PlayCardFocusAnimation(cardId)
    if self["CardNode" .. cardId] then
        self["CardNode" .. cardId]:Play("enter")
    end
end

--- 播放卡牌上阵和退出动画
function SettleGoldenTrainPerformanceView:PlayCardExitAnimation(cardId)
    if this.isFirstMapMove then cardId = 1 end
    this.isFirstMapMove = false
    if self["CardNode" .. cardId] then
        self["CardNode" .. cardId]:Play("end")
    end
end

--- 播放界面入场动画
function SettleGoldenTrainPerformanceView:PlayEnterAnimation(isHigBet)
    self.RootAnima:Play(isHigBet and "enter2" or "enter1")
    self:register_invoke(function() 
        UISound.play_loop("goldentrainrun")
    end, 4)
end

---获取当前卡的ExtraRewardInfo
function SettleGoldenTrainPerformanceView:GetCurrExtraRewardInfo()
    return this.ExtraRewardPosInfo[this.PlayingCardId]
end

--- 播放火车额外奖励动画
function SettleGoldenTrainPerformanceView:PlayTrainExtraRewardAnima()
    self.TrainAnima:Play("act")
    AnimatorPlayHelper.Play(self.TrainAnima, { "act", "CoinTrainhuocheact" }, false, function () end)
    local trainAnimaTime = 3
    LuaTimer:SetDelayFunction(trainAnimaTime - 0.75, function()
        self:PlayCellExtraRewardAnima()
    end, false, LuaTimer.TimerType.Battle)
    UISound.play("goldentrainevent")
end

--- 播放卡牌格子额外奖励动画
function SettleGoldenTrainPerformanceView:PlayCellExtraRewardAnima()
    if this.ExtraRewardPosInfo then
        for i, v in pairs(this.ExtraRewardPosInfo) do
            if i == this.PlayingCardId then
                this.TempExtraRewardPosInfo = v
                for k = 1, #v do
                    local cell = ViewList.GoldenTrainBingoView:GetCardView():GetCardCell(this.PlayingCardId, v[k].pos)
                    BattleEffectCache:GetPrefabFromPoolOrCache("SettleGoldenTrainPerformanceVieweffect", cell,
                        function (go)
                            LuaTimer:SetDelayFunction(0.5, function()
                                self:PlayShake()
                                local curModel = ModelList.BattleModel:GetCurrModel()
                                fun.DelayPlaySound(curModel.Const.soundDelayTime4, "goldentrainnumadd")
                            end, false, LuaTimer.TimerType.Battle)
                            LuaTimer:SetDelayFunction(1, function()
                                this:OnCellExtraRewardAnimaOver()
                            end, false, LuaTimer.TimerType.Battle)
                            LuaTimer:SetDelayFunction(2, function()
                                BattleEffectPool:Recycle("SettleGoldenTrainPerformanceVieweffect", go)
                            end, false, LuaTimer.TimerType.Battle)
                        end
                    )
                end
            end
        end
    end
end

function SettleGoldenTrainPerformanceView:OnCellExtraRewardAnimaOver()
    if this.TempExtraRewardPosInfo then
        for k = 1, #this.TempExtraRewardPosInfo do
            local cell = ViewList.GoldenTrainBingoView:GetCardView():GetCellBgEffect(
                this.TempExtraRewardPosInfo[k].cardId,
                this.TempExtraRewardPosInfo[k].pos)
            if cell then
                local refer = fun.get_component(cell, fun.REFER)
                if refer then
                    local text = refer:Get("text_reward")
                    local sourNum = tonumber(text.text)
                    local targetNum = sourNum +  this.TempExtraRewardPosInfo[k].extRewardValue
                    Anim.do_smooth_int2(text, sourNum, targetNum, 1, DG.Tweening.Ease.Linear, nil, function ()
                        text.text = targetNum
                    end)
                    local anima = refer:Get("anima")
                    anima:Play("act")
                    LuaTimer:SetDelayFunction(1.3,function()
                        this:PlayShake()
                    end, nil, LuaTimer.TimerType.Battle)
                end
            end
        end

        this.TempExtraRewardPosInfo = nil        
        LuaTimer:SetDelayFunction(2, function()
            this:OnExtraRewardEnd()
        end, false, LuaTimer.TimerType.Battle)
    end
end

--- 奖励事件结束
function SettleGoldenTrainPerformanceView:OnExtraRewardEnd()
    self._fsm:ChangeState("BingoOrderState")
end

--- 检查格子类型1普通金币2mini格子3 2x格子
function SettleGoldenTrainPerformanceView:CheckCellType(cardId, pos)
    local markedPos = this.SettleInfo[tostring(cardId)].markedPos
    if markedPos then
        for i, v in pairs(markedPos) do
            if v.pos == pos then
                if v.hasDouble then
                    return 3
                elseif v.hasMini then
                    return 2
                else
                    return 1
                end
            end
        end
    end
    return 1
end

--- 初始化bingo格子上初始数值
function SettleGoldenTrainPerformanceView:InitCellsValue()
    this.baseRewardRange = {}
    for i = 1, this.cardCount do
        local data2 = this.SettleInfo[tostring(i)]
        local cardView = ViewList.GoldenTrainBingoView:GetCardView()
        if data2 and data2.markedPos then
            for k = 1, #data2.markedPos do
                local cell = cardView:GetCellBgEffect(data2.cardId, data2.markedPos[k].pos)
                if cell then
                    local refer = fun.get_component(cell, fun.REFER)
                    if refer then
                        local text = refer:Get("text_reward")
                        if text then
                            text.text = data2.markedPos[k].rewardValue
                        end
                    end
                end
            end

            --设置居中的13号格子初始数值
            this.baseRewardRange[data2.cardId] = data2.baseRewardRange
            local defaultItem = ViewList.GoldenTrainBingoView:GetCardView():GetCard(data2.cardId):GetDefaultItem()
            if defaultItem then
                local refer = fun.get_component(defaultItem, fun.REFER)
                if refer then
                    local text = refer:Get("text_reward")
                    if text then
                        text.text = data2.baseRewardRange
                    end
                end
            end
        end
    end
end

--- 单张卡牌win效果
function SettleGoldenTrainPerformanceView:PlayCardWinEffect(isActive)
    if isActive then
        local sourNum, allRewardValue = self:GetCardProgress()
        self.WinEffectText.text = allRewardValue
        local targetNum = self:GetCurrCardFinalRewardCoin()
        if targetNum then
            Anim.do_smooth_int2(self.Text1, allRewardValue, targetNum, 1.5, DG.Tweening.Ease.Linear, function(v) 
                self.WinEffectText.text = fun.format_money(v)
            end,
            function ()
                self.WinEffectText.text = fun.format_money(targetNum)
            end)
        end
    end
    fun.set_active(self.WinEffect, isActive)
end

--- 单张卡是否展示到了最后一个bingo
function SettleGoldenTrainPerformanceView:CheckIsLastBingo()
    if this.PlayingBingoOrderIndex >= #this.BingoOrder[tostring(this.PlayingCardId)] then
        return true
    end
    return false
end

function SettleGoldenTrainPerformanceView:PlayShake()
    ViewList.GoldenTrainBingoView:GetCardView():ShowShakeAnima(this.PlayingCardId)
end

function SettleGoldenTrainPerformanceView:DelayPlayShake(delay)
    delay = delay or 0.5
    LuaTimer:SetDelayFunction(delay, function()
        self:PlayShake()
    end, nil, LuaTimer.TimerType.Battle)
end

return this
