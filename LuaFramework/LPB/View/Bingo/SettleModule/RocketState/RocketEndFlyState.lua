---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/1/11 15:15
---
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/1/11 15:24
---
require("View/Bingo/SettleModule/RocketState/BaseRocketState")

RocketEndFlyState = Clazz(BaseRocketState,"RocketEndFlyState")
local receiveData = false
local this = RocketEndFlyState
function RocketEndFlyState:New()
    local o = {}
    setmetatable(o,{__index = RocketEndFlyState})
    return o
end


function RocketEndFlyState:OnEnter(fsm,prvious,...)
    receiveData = false
    receiveData = ModelList.GameModel:RocketShowBingoInfo()
    if not receiveData then
        RocketEndFlyState:start_x_update()
    else
        local cardPos = this:GetRocketSign()
        fsm:GetOwner():PlayRocketEndFly()
    end
    self._fsm = fsm
    this._fsm = fsm
end

local ConvertServerPos = function(serverPos)
    local c = math.modf(serverPos / 10)
    local d = math.fmod(serverPos, 10)
    return c * 5 - d + 1
end
--涂抹卡牌
function RocketEndFlyState:GetRocketSign()
    local info = {}
    this.model =  ModelList.BattleModel:GetCurrModel()
    this.cardView = ModelList.BattleModel:GetCurrBattleView():GetCardView()
    local roundData = this.model:GetRoundData()
    local settleData  = this.model:GetSettleData().cardRocket

    for k, v in pairs(roundData) do
        local empty_cell = {}
        local extra_nums_table = {}
        for i = 1, #settleData do
            if tostring(settleData[i].cardId) == k then
                for m = 1, #settleData[i].pos  do
                    local index = ConvertServerPos(settleData[i].pos[m])
                    table.insert(empty_cell, { num = 0 , index = index,extraPos = settleData[i].extraPos[m] })
                end
            end
        end

        --排序，格子盖章顺序为：1、普通格子 2、技能格子 3、格子Bingo
        table.sort(empty_cell, function(a, b)
            local cellA, cellB = this.model:GetRoundData(k, a.index), this.model:GetRoundData(k, b.index)
            --格子Bingo
            if cellA.self_bingo and not cellB.self_bingo then return false end
            if not cellA.self_bingo and cellB.self_bingo then return true end
            --技能
            local puA, puB = cellA:GetPowerupId(1), cellB:GetPowerupId(1)
            if puA and not puB then return false end
            if not puA and puB then return true end
            --材料
            local haveItemA, haveItemB = cellA:HasHiddenItem(), cellB:HasHiddenItem()
            if haveItemA and not haveItemB then return false end
            if not haveItemA and haveItemB then return true end
            return false
        end)
        
        for i = 1, #empty_cell do
            this.cardView:OnClickCardIgnoreJudgeByIndex(k, empty_cell[i].index,9,empty_cell[i].extraPos)
        end
        local extra_info = { cardId = k, nums = extra_nums_table }
        table.insert(info, extra_info)
    end
    return info
end



function RocketEndFlyState:on_x_update()
    if not receiveData then
        receiveData = ModelList.GameModel:RocketShowBingoInfo()
    end
    if receiveData then
        RocketEndFlyState:stop_x_update()
        local cardPos = this:GetRocketSign()
        if self._fsm then
            self._fsm:GetOwner():PlayRocketEndFly()
        elseif this._fsm then
            this._fsm:GetOwner():PlayRocketEndFly()
        end
    end
end

function RocketEndFlyState:OnLeave()
    self._fsm = nil
    this._fsm = nil
end

function RocketEndFlyState:FinishOperate(fsm)
    if fsm then
        self:ChangeState(fsm,"RocketWaitDataState")
    end
end




