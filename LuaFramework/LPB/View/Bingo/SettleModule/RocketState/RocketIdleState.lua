---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/1/11 15:24
---
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/1/11 15:24
---
require("View/Bingo/SettleModule/RocketState/BaseRocketState")

RocketIdleState = Clazz(BaseRocketState,"RocketIdleState")
local this = RocketIdleState
function RocketIdleState:New()
    local o = {}
    setmetatable(o,{__index = RocketIdleState})
    return o
end

local timer = nil
local isInit= false
function RocketIdleState:OnEnter(fsm,prvious,...)
    --ModelList.GameModel:ShowAllMiss()
    this.model = ModelList.BattleModel:GetCurrModel()
    if not isInit then
        this:Register()
        isInit = true
    end
    timer =  LuaTimer:SetDelayFunction(0.1,function()
        fsm:GetOwner():ShowAllMiss()
        if timer then
            LuaTimer:Remove(timer,LuaTimer.TimerType.BattleUI)
        end
    end,nil,LuaTimer.TimerType.BattleUI)
    this.fsm = fsm
end

function RocketIdleState:OnLeave(fsm)
    --this:UnRegister()
end

function RocketIdleState:FinishOperate(fsm)
    if timer then
        LuaTimer:Remove(timer,LuaTimer.TimerType.BattleUI)
    end
    if fsm then
        if   fsm:GetOwner():getIsFirstRocket() then 
            self:ChangeState(fsm,"RocketStartFlyState")
        else 
            self:ChangeState(fsm,"RocketStartFly2State")
        end
    end
end

function RocketIdleState:Register()
    Event.AddListener(EventName.Player_Bingo_Reduce_Bingoleft, this.ReduceBingoleftTick)
end

function RocketIdleState:UnRegister()
    Event.RemoveListener(EventName.Player_Bingo_Reduce_Bingoleft, this.ReduceBingoleftTick)
end

function RocketIdleState:Dispose()
    isInit =false
    this:UnRegister()
end

function RocketIdleState:ReduceBingoleftTick(bingoData)
    local next = 0
    local bingoleftData = { gameId = 0, bingoLeft = 0, bingoChange = 0, cardId = 0, next = 0, bingoId = 0, robots = {}, bingo = bingoData }
    local count = #bingoData
    bingoleftData.bingoLeft = count
    bingoleftData.bingoChange = count
    bingoleftData.next = next
    this.model:SaveBingoLeftInfo(bingoleftData)
    this.model:RefreshBingoInfo()
    Facade.SendNotification(NotifyName.Bingo.Sync_Bingos)
end


function RocketIdleState:ClickRocket()
    this.fsm:GetOwner():UseRocketItem()

    -- if this.fsm:GetOwner().Bottom:GetCurrentAnimatorStateInfo(0):IsName("idle") then
    --     this.fsm:GetOwner():UseRocketItem()
    -- end
end

function RocketIdleState:ClickFree()
    this.fsm:GetOwner():PlayFree()

    -- if this.fsm:GetOwner().Bottom:GetCurrentAnimatorStateInfo(0) :IsName("idle") then
    --     this.fsm:GetOwner():PlayFree()
    -- end
end