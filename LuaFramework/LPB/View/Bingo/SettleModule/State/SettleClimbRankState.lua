---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/12 17:50
---



require("View/Bingo/SettleModule/State/BaseSettleState")
SettleClimbRankState = Clazz(BaseSettleState,"SettleClimbRankState")
local this = SettleClimbRankState
function SettleClimbRankState:New()
    local o = {}
    setmetatable(o,{__index = SettleClimbRankState})
    return o
end


function SettleClimbRankState:OnEnter(fsm,prvious,...)
    local CardLoad = function(nodeList)
        if ModelList.BattleModel:GetCurrBattleView():IsAuto() then
            local isFromRocket = (prvious == "SettleRocketState") or false
            this:CheckPerfect()
            ViewList.SettleClimbRankedAutoView:ShowEnter(isFromRocket)
            ViewList.SettleRocketView:ReadyForNextView(nodeList)
        else
            local isFromRocket = (prvious == "SettleRocketState") or false
            this:CheckPerfect()
            if isFromRocket then
                ViewList.SettleClimbRankedView:ShowEnter(isFromRocket)
                ViewList.SettleRocketView:ReadyForNextView(nodeList)
            else
                ViewList.SettleClimbRankedView:ShowEnter(isFromRocket)
                ViewList.SettleClimbRankedView:SetCardsIgnoreRocket(nodeList)
            end
        end
    end
    this:OpenClimbRankView(fsm,CardLoad)
end

function SettleClimbRankState:CheckPerfect()
    local roundData = ModelList.GameModel:GetRoundData()
    local totalNumber = ModelList.GameModel:GetCalledNumber()
    for k, v in pairs(roundData) do
        local pefect = true
        for i = 1, #v.cards do
            if v.cards[i].sign == 0 then
                if fun.is_include(v.cards[i].num, totalNumber) then
                    pefect = false
                    break
                elseif v.cards[i].double_num > 0 and fun.is_include(v.cards[i].double_num, totalNumber) then
                    pefect = false
                    break
                end
            end
        end
        ModelList.BattleModel:GetCurrModel():SavePerfectInfo(tonumber(k),pefect)
    end
end

function SettleClimbRankState:OpenClimbRankView(fsm, callBack)
    Cache.Load_Atlas(AssetList["ClimbRankAtlas"],"ClimbRankAtlas",function()
        if ModelList.BattleModel:GetCurrBattleView():IsAuto() then
            Cache.load_prefabs(AssetList["SettleClimbRankedAutoView"], "SettleClimbRankedAutoView", function(obj)
                local go = fun.get_instance(obj, fsm:GetOwner().go)
                ViewList.SettleClimbRankedAutoView:SkipLoadShow(go)
                callBack(ViewList.SettleClimbRankedAutoView:GetNodeList())
            end)
        else
            Cache.load_prefabs(AssetList["SettleClimbRankedView"], "SettleClimbRankedView", function(obj)
                local go = fun.get_instance(obj, fsm:GetOwner().go)
                ViewList.SettleClimbRankedView:SkipLoadShow(go)
                callBack(ViewList.SettleClimbRankedView:GetNodeList())
            end)
        end
    end)
end
--
--function SettleClimbRankState:DirectToView()
--    Cache.load_prefabs(AssetList["SettleClimbRankedView"],"SettleClimbRankedView",function(obj)
--        local go = fun.get_instance(obj,fsm:GetOwner().go)
--        ViewList.SettleClimbRankedView:SkipLoadShow(go)
--        callBack(ViewList.SettleClimbRankedView:GetNodeList())
--    end)
--end


--function SettleClimbRankState:on_x_update()
--
--end


function SettleClimbRankState:OnLeave(fsm)

end

function SettleClimbRankState:FinishOperate(fsm)
    if fsm then

    end
end