---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2024/12/18 16:34
---


local ShowSpinState = Clazz(BaseFsmState, "ShowSpinState")
local this = ShowSpinState

function ShowSpinState:New()
    local o = {}
    setmetatable(o, { __index = ShowSpinState })
    return o
end

function ShowSpinState:ShowSpinState()
end

function ShowSpinState:OnEnter(fsm, previous)
    self._fsm = fsm
    self._owner = fsm:GetOwner()
    self:PlayCellsSpin()
    self._owner:CheckSpinBtnGray(true)
end

---全部灯亮亮遍
function ShowSpinState:PlayCellsSpin()
    self._owner:AllCellUpEffect()
    LuaTimer:SetDelayFunction(0.3, function ()
        if self and self._owner then
            self._owner:AllCellUpEffect()
        end
    end)
    LuaTimer:SetDelayFunction(0.6, function ()
        if self and self._owner then
            self:GenerateCellOrder()
        end
    end)
    --LuaTimer:SetDelayFunction(0.9, function ()
    --    if self and self._owner then
    --        self:GenerateCellOrder()
    --    end
    --end)
end

function ShowSpinState:GenerateCellOrder()
    local targetIndex = ModelList.GameModel:GetExtraSmallGameData().position
    --local targetIndex = 23-- math.random(1, 21)
    local orderList = {}
    table.each(Csv["moneymansion_show"], function (v, k)
        if fun.is_include(targetIndex, v.win_range) then
            table.insert(orderList, k)
        end
    end)
    local randomIndex = math.random(1, #orderList)
    self._owner:SaveTotalWinNumByIndex(targetIndex)
    self:PlaySpinEffect(orderList[randomIndex], targetIndex)
end

function ShowSpinState:PlaySpinEffect(orderIndex, targetIndex)
    local playOrderData = Csv.GetData("moneymansion_show", orderIndex)
    self.coroutine = coroutine.start(function ()
        local progress1 = playOrderData.progress_1_list
        local progress1Data = playOrderData.progress_1
        for i = 1, #progress1 do
            for j = 1, #progress1[i] do
                if self._owner then
                    self._owner:PlayCellActEffect(progress1[i][j], true)
                end
            end
            UISound.play("moneymansionspin")
            coroutine.wait(progress1Data[i] * 0.001)
        end
        --阶段二的表现
        local progress2 = playOrderData.progress_2_list
        local progress2Data = playOrderData.progress_2
        for i = 1, #progress2 do
            for j = 1, #progress2[i] do
                if self._owner then
                    self._owner:PlayCellActEffect(progress2[i][j], true)
                end
            end
            UISound.play("moneymansionspin")
            coroutine.wait(progress2Data[i] * 0.001)
        end

        --阶段三的表现
        local progress3 = playOrderData.progress_3_list
        local progress3Data = playOrderData.progress_3
        for i = 1, #progress3 do
            for j = 1, #progress3[i] do
                if self._owner then
                    self._owner:PlayCellActSlowEffect(progress3[i][j], true)
                end
            end
            UISound.play("moneymansionspin")
            coroutine.wait(progress3Data[i] * 0.001)
        end

        self._owner:PlayCellActSlowEffect(targetIndex, true)
        coroutine.wait(progress3Data[#progress3Data] * 0.001)

        --阶段四的表现 中格子
        if self._owner then
            self._owner:PlayCellHitEffect(targetIndex)
        end
        if self._fsm then
            self._fsm:ChangeState("ShowSpinRewardState")
        end
    end)
end

function ShowSpinState:ShowSpinReward()

end

function ShowSpinState:OnSpin()

end

function ShowSpinState:OnReceiveSpin()
end

function ShowSpinState:OnChangeBet(changeType)

end

function ShowSpinState:OnStopIdle()

end

function ShowSpinState:OnResumeIdle()

end

function ShowSpinState:OnLeave(fsm)
    if self.coroutine then
        coroutine.stop(self.coroutine)
        self.coroutine = nil
    end

    self._fsm = nil
    self._owner = nil
end

function ShowSpinState:Dispose()
    self:OnLeave(nil)
end

return this
