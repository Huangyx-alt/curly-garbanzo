---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 15610.
--- DateTime: 2022/3/6 22:05
---

BattleModuleList = {}

local this = BattleModuleList

function prequire(...)
    local status, lib = pcall(require, ...)
    if(status) then return lib end
    return nil
end

function BattleModuleList.LoadRequire(gameTypeName,moduleName)
    this[moduleName] = nil
    local path = "View.Bingo.CardModule.BaseModules." .. moduleName
    RemoveRequiredByName(path)
    --log.EditorLog ("require  "..path)
    this[moduleName] = require(path)
end

function BattleModuleList.ModulListInitCard ()
    local gameTypeName  = ModelList.BattleModel:GetGameTypeName()
    local gameType  = ModelList.BattleModel:GetGameCityPlayID()
    this["EffectEntry"] = require("View.Bingo.EffectModule.EffectEntry") --   卡牌效果入口
    local cardModules = Csv.GetData("new_game_battle_module",gameType,"card_modules")
    for i = 1, #cardModules do
        this.LoadRequire(gameTypeName,cardModules[i])
    end
end

require("View.Bingo.BattleModuleConfig")
function BattleModuleList.New()
    local o = {}
    setmetatable(o, { __index = BattleModuleList });
    return o
end

function BattleModuleList.GetModuleOpenState(gameType, moduleName , typeName)
    return 1
    --local gameType =  ModelList.BattleModel:GetGameType()
    --local modeData = Csv.GetData("new_game_mode",gameType)
    --typeName = string.lower(typeName)
    --if fun.is_include(typeName,modeData[moduleName])  then
    --    if modeData[typeName] and modeData[typeName] >0 then return modeData[typeName]  end
    --end
    --return 0
end

function BattleModuleList.LoadCardModule(cardView)
    this.ModulListInitCard()
    local gameType =  ModelList.BattleModel:GetGameType()
    for k, v in pairs(BattleModuleList) do
        if type(v) ~= "function" then
            local state =  this.GetModuleOpenState(gameType,"card",v.name)
            if  state >0 then
                v:SetCardView(cardView,state)
                if v.Register then
                    v:Register()
                end
                --log.log(v.name .. " 卡牌功能打开 ")
            end
        end
    end

    this.LoadCardEffect(cardView)
end

function BattleModuleList.LoadCardEffect(cardView)
    local CardEffectPath = "View/Bingo/EffectModule/Card/CardEffect"
    local requireName = Csv.GetData("new_game_mode", ModelList.BattleModel:GetGameCityPlayID(), "card_effect_require")
    if requireName and #requireName > 0 and requireName ~= "0" then
        CardEffectPath = "View/Bingo/EffectModule/Card/CardEffect/" .. requireName
    end
    this["CardEffect"] = require(CardEffectPath) -- 整卡的效果
    BattleModuleList["CardEffect"]:SetCardView(cardView)
    BattleModuleList["CardEffect"]:Register()
end

function BattleModuleList.EnableUpdate()
    local gameType =  ModelList.BattleModel:GetGameType()
    for k, v in pairs(BattleModuleList) do
        if type(v) ~= "function" then
            local state =  this.GetModuleOpenState(gameType,"card",v.name)
            if  state >0 then
                if v.EnableUpdate then
                    v:EnableUpdate()
                end
            end
        end
    end
end

--卸载游戏卡牌功能模块
function BattleModuleList.UnLoadCardModule()
    local gameType =  ModelList.BattleModel:GetGameType()
    for k, v in pairs(BattleModuleList) do
        if type(v) ~= "function" then
            local state =  this.GetModuleOpenState(gameType,"card",v.name)
            if state >0 then
                if v.OnDisable then
                    v:OnDisable()
                end
                if v.UnRegister then
                    v:UnRegister()
                end
                log.log(v.name .. " 卡牌功能卸载 ")
                v = nil
            end
        end
    end
    if BattleModuleList.EffectEntry then
        BattleModuleList["EffectEntry"]:OnDisable()
        BattleModuleList["EffectEntry"]:UnRegister()
    end
    if BattleModuleList.CardEffect then
        BattleModuleList["CardEffect"]:OnDisable()
        BattleModuleList["CardEffect"]:UnRegister()
        BattleModuleList.CardEffect = nil
    end
end

--卸载游戏卡牌功能模块
function BattleModuleList.UnLoadOneCardModule(modelName)
    local gameType =  ModelList.BattleModel:GetGameType()
    for k, v in pairs(BattleModuleList) do
        if v and type(v) ~= "function" and v.moduleName == modelName then
                if v.OnDisable then
                    v:OnDisable()
                end
                if v.UnRegister then
                    v:UnRegister()
                end
                log.log(v.name .. " 卡牌功能卸载 ")
                v = nil
        end
    end
end

function BattleModuleList.LoadPowerModule(powerView)
    this["PowerUpEffect"] = require("View/Bingo/EffectModule/PowerUp/PowerUpEffect") --
    this["PowerUpEffect"]:SetView(powerView)
    this["PowerUpEffect"]:Register()
end

--卸载powerup卡牌功能模块
function BattleModuleList.UnLoadPowerModule()
    if this["PowerUpEffect"] then
        if this["PowerUpEffect"].OnDisable then
            this["PowerUpEffect"]:OnDisable()
        end
        if this["PowerUpEffect"].UnRegister then
            this["PowerUpEffect"]:UnRegister()
        end
        this["PowerUpEffect"] = nil
    end
end

function BattleModuleList.GetModule(moduleName)
    return this[moduleName]
end

function BattleModuleList.Register()
    for k, v in pairs(BattleModuleList) do
        if type(v) ~= "function" then
            if v.Register then
                v.Register()
            end
        end
    end
end

function BattleModuleList.UnRegister()
    for k, v in pairs(BattleModuleList) do
        if type(v) ~= "function" then
            if v.UnRegister then
                v.UnRegister()
            end
        end
    end
end

return this