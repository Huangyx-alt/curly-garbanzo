---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/9 11:03
---
local  CardLoad = Clazz(ClazzBase,"CardLoad")
local this = CardLoad
this.number_img_num = 10 --数字的图片数量

--- 初始卡牌上掉落的所有道具Obj
this.total_cell_gift = {}
--- 初始卡牌上的道具
this.all_flash_gift = {}

this.isPlayingDropItem = false

function CardLoad:SetCardView(cardView)
    this.cardView = cardView
end

--普通战斗卡牌加载
function CardLoad:LoadNormalCardData()
    this.Register()
    local count = #this.cardView.loadData.cardsInfo
    for i = 1, count do
        local obj = this.cardView:GetCardMap(i)
        this:InitCardChild(obj, this.cardView.loadData.cardsInfo[i].cardId)
        this.cardView.idToMap[tostring(this.cardView.loadData.cardsInfo[i].cardId)] = obj
    end
    for i = count+1, 4 do
        local obj = this.cardView:GetCardMap(i)
        if obj then
            fun.set_active(obj,false)
        end
    end
    this:InitCardChildData()
end

--挂机卡牌加载
function CardLoad:LoadHangUpCardData(bg,cloneRoot,cloneObj)
    this.Register()
    local count = #this.cardView.loadData.cardsInfo
    local trans_parent = fun.find_child(cloneRoot, "card" .. count)
    --this:SetNumberSpriteList(bg)
    local clone = cloneObj
    for i = 1, count do
        local my_parent = fun.find_child(trans_parent, tostring(i))
        local obj = fun.get_instance(clone, my_parent)
        this.cardView:SetCardMapObj(i,obj)
    end
    for i = 1, count do
        local cardId = this.cardView.loadData.cardsInfo[i].cardId
        local obj = this.cardView:GetCardMap(i)
        this:InitCardChild(obj, cardId)
        this.cardView.idToMap[tostring(cardId)] = obj
        fun.set_active(obj, false)
        fun.set_rect_local_pos(obj, 0, 0, 0)
    end
    this:InitCardChildData()
    UnityEngine.Object.Destroy(clone)
end


--初始化卡牌棋局子部分
function CardLoad:InitCardChildData ()
    this.total_cell_gift = {}
    this.all_flash_gift = {}
    this.model = ModelList.BattleModel:GetCurrModel()
    --- 生成卡牌棋局格子数据,不做表现
    this:SetLogicRoundData()
    --- 设置卡牌初始形态
    if this.cardView then
        this.cardView:InitCardOver(false)        
    end
    this.isPlayingDropItem = false
    coroutine.start(function()
        for k, v in pairs(this.cardView.loadData.cardsInfo) do
            table.walk(v.numbers, function(number, cellIndex)
                --local effectData = v.beginEffectData[cellIndex]
                local effectData = table.find(v.cardNumberReward, function(_, d)
                    return d.number == number
                end)
                this:LoadCardData(v.cardId, cellIndex, number, effectData and effectData.items)
                --- 再挂机玩法，卡牌太多导致资源数太多，来不及完全坠落，
                --if not this.isPlayingDropItem then
                --    WaitForEndOfFrame()
                --end
            end)
            this:LoadCardReward(v.cardId, v.cardReward)
        end
        if this.cardView then
            this.cardView:InitCardOver(true)
        end
    end)
end

--- 仅初始化卡牌棋局格子数据
function CardLoad:SetLogicRoundData()
    for k, v in pairs(this.cardView.loadData.cardsInfo) do
        table.walk(v.numbers, function(number, cellIndex)
            --local effectData = v.beginEffectData[cellIndex]
            local effectData = table.find(v.cardNumberReward, function(_, d)
                return d.number == number
            end)
            this:OnlyLoadCardData(v.cardId, cellIndex, number, effectData and effectData.items)
        end)
    end
end

local GetItemInfo = function(itemId)
    --if itemId < 1000 then
    --    return Csv.GetData("resources", itemId),false
    --elseif 4 == math.floor(itemId/10000000) then
    if 4 == math.floor(itemId/10000000) then
        local item_id = Csv.GetData("new_item_synthetic",itemId,"itemid")
        return Csv.GetData("new_item",item_id),true
    else
        return Csv.GetData("new_item", itemId),true
    end
end

--- 每个道具的信息
local function CreateGiftInfo(obj,anim,itemId,count,mapIndex,cellIndex)
    table.insert(this.total_cell_gift, {obj = obj,anim = anim, itemId = itemId,num = count,mapIndex = mapIndex,cellIndex = cellIndex})
end
--- 赛季令牌经验
local function CreateFlashGiftInfo(obj,anim,itemId,count)
    table.insert(this.all_flash_gift, {obj = obj,anim = anim, itemId = itemId,num = count})
end

--- 赛季令牌经验
local function CreateFlashClone(card_reference,cell_reference)
    local flashParent = nil
    local obj = nil
    if cell_reference and cell_reference:Get("flash_clone")  then
        flashParent = cell_reference:Get("flash_clone")
        obj = fun.get_instance(cell_reference:Get("flash_clone"), flashParent)
    else
        flashParent = fun.find_child(cell_reference:Get("gift").transform,"flash_parent")
        obj = fun.get_instance(card_reference:Get("flash_clone"), flashParent)
    end
    obj.gameObject.name = "flash_clone"
    if ModelList.BattleModel:IsHangUp() then
        fun.set_gameobject_scale(obj, 0.6, 0.6, 1)
        fun.set_gameobject_pos(obj, 0,0,0,true)
    else
        fun.set_gameobject_pos(obj, -53.6,-35.1,0,true)
    end
    return obj
end

-- 杯赛道具(与赛季令牌使用相同动画，所以这里直接使用令牌的obj)
local function CreateCompetitionItemInfo(card_reference,anim,itemId,count,cell_reference)
    local flashParent = cell_reference:Get("gift")
    local obj = fun.get_instance(card_reference:Get("flash_clone"), flashParent,true)
    obj.gameObject.name = string.format("competition_clone-%s", itemId)
    --obj = fun.get_instance(obj, obj.transform.parent, true)
    
    --右下角
    local curModel = ModelList.BattleModel:GetCurrModel()
    local offsetX, offsetY = curModel:GetQuestItemOffsetPos(itemId)
    fun.set_rect_local_pos(obj, offsetX, offsetY, 0)
    local scale = curModel:GetQuestItemScale()
    fun.set_gameobject_scale(obj, scale, scale, 1)
    
    local image = fun.get_component_in_child(obj, UnityEngine.UI.Image)
    if fun.is_not_null(image) then
        local spriteName = Csv.GetItemOrResource(itemId, "icon")
        if not fun.is_empty_str(spriteName) then
            Cache.GetSpriteByName("GameItemAtlas", spriteName, function(sprite)
                if not fun.is_null(sprite) then
                    image.sprite = sprite
                    image:SetNativeSize()
                    fun.set_gameobject_scale(image.gameObject, 0.3, 0.3, 1)
                end
            end)
        end
    end
    
    table.insert(this.all_flash_gift, {obj = obj,anim = anim, itemId = itemId,num = count})
end

-- WinZone道具
local function CreateWinZoneItem(card_reference, anim, itemId, count, cell_reference)
    local flashParent = cell_reference:Get("gift")
    local obj = fun.get_instance(card_reference:Get("flash_clone"), flashParent, true)
    obj.gameObject.name = "winzone_clone"
    
    --左上角
    local curModel = ModelList.BattleModel:GetCurrModel()
    local offsetX, offsetY = curModel:GetWinZoneItemOffsetPos()
    local scale = curModel:GetWinZoneItemScale()
    fun.set_rect_local_pos(obj, offsetX, offsetY, 0)
    fun.set_gameobject_scale(obj, scale, scale, 1)
    
    local image = fun.get_component_in_child(obj, UnityEngine.UI.Image)
    if fun.is_not_null(image) then
        local spriteName = Csv.GetItemOrResource(itemId, "icon")
        if not fun.is_empty_str(spriteName) then
            Cache.GetSpriteByName("GameItemAtlas", spriteName, function(sprite)
                if not fun.is_null(sprite) then
                    image.sprite = sprite
                    image:SetNativeSize()
                    fun.set_gameobject_scale(image.gameObject, 0.5, 0.5, 1)
                    --fun.set_recttransform_native_size(obj, 80, 80)
                end
            end)
        end
    end
    
    table.insert(this.all_flash_gift, { obj = obj, anim = anim, itemId = itemId, num = count })
end

--- 仅设置单个卡牌数，不做表现层修改
---@param item_info_list table  卡牌奖励
function CardLoad:OnlyLoadCardData (mapIndex, cellIndex, number, item_info_list)
    table.walk(item_info_list, function(v)
        local item_info,isItem = GetItemInfo(v.id)
        if item_info ~= nil then
            local itemPutType = 0
            if isItem then
                itemPutType  = item_info.put_type --Csv.GetData("item",(v.id),"put_type")
            end
            if itemPutType == 3 then
                this.model:SetRoundHideGiftData(mapIndex, cellIndex, v)
            elseif itemPutType == 4 then
                this.model:SetRoundGiftData(mapIndex, cellIndex, v.id, number)
            elseif itemPutType == 5 then
                this.model:SetRoundGiftData(mapIndex, cellIndex, v.id, number)
            elseif itemPutType == 6 then
                this.model:SetRoundGiftData(mapIndex, cellIndex, v.id, number)
            else
                --for j = 1, v.value do
                local skillId = nil
                local powerId = nil
                --    if v.itemId >= 1000 and item_info["result"][1] == 1 then
                --        skillId = item_info["result"][2]
                --        powerId = 0
                --    end
                this.model:SetRoundGiftData(mapIndex, cellIndex, v.id, number,skillId,nil,powerId)
                --end
            end
        else
            log.r("=========================>>找不到item " .. v.id)
        end
    end)
end



--加载所有卡牌数据
---@param item_info_list table  卡牌奖励
function CardLoad:LoadCardData(mapIndex, cellIndex, number, item_info_list)
    local obj = this.cardView:GetCardCell(mapIndex,cellIndex)
    local cardObj = this.cardView:GetCardMap(mapIndex)
    local ref_temp = obj:GetComponent(fun.REFER)
    local ref_temp_card = cardObj:GetComponent(fun.REFER)
    local gift_obj = ref_temp:Get("gift_clone")
    fun.set_active(gift_obj,false)

    local giftObjParent = ref_temp:Get("gift_parent")
    table.walk(item_info_list, function(v)
        local item_info,isItem = GetItemInfo(v.id)
        if item_info ~= nil then
            local itemPutType = 0
            if isItem then itemPutType = item_info.put_type end
            if itemPutType == 3 then
                --this.model:SetRoundHideGiftData(mapIndex, cellIndex, v)
            elseif itemPutType == 4 then
                local gift_clone = CreateFlashClone(ref_temp_card,ref_temp)
                --CreateFlashGiftInfo(ref_temp:Get("flash_clone"),nil,v.id,1)
                CreateFlashGiftInfo(gift_clone,nil,v.id,1)
                ref_temp:Set(gift_clone,"flash_clone")
                --this.model:SetRoundGiftData(mapIndex, cellIndex, v.id, number)
            elseif itemPutType == 5 then
                CreateCompetitionItemInfo(ref_temp_card ,nil,v.id,1,ref_temp)
                --this.model:SetRoundGiftData(mapIndex, cellIndex, v.id, number) 
            elseif itemPutType == 6 then
                CreateWinZoneItem(ref_temp_card, nil, v.id, 1, ref_temp)
            else
                --for j = 1, v.value do
                local gift_clone = fun.get_instance(gift_obj, giftObjParent)
                fun.set_gameobject_pos(gift_clone, 0, 0, 0, true)
                gift_clone.name = string.format("gift_%s", item_info.name)
                local anim = fun.get_component(gift_clone, fun.ANIMATOR)
                CreateGiftInfo(gift_clone.gameObject, anim, v.id, 1, mapIndex, cellIndex)

                --设置道具图片
                local gift_ref_temp = fun.get_component(gift_clone, fun.REFER)
                local touying = gift_ref_temp:Get("touying")
                local gift_icon = gift_ref_temp:Get("gift_icon")
                --local item_type = item_info["item_type"]
                gift_icon.sprite = AtlasManager:GetSpriteByName("BingoBangBattleAtlas", item_info["icon"])
                touying.sprite = AtlasManager:GetSpriteByName("BingoBangBattleAtlas", item_info["icon"])

                if item_info.result[1] == 68 then
                    --设置战斗箱子ID
                    ModelList.BattleModel:SetBattleBoxID(item_info.item_id)
                end
                
                --gift.sprite = AtlasManager:GetSpriteByName("BingoBangBattleAtlas", icon)
                --ViewTool:LoadBattleGiftSprite(0, gift, icon)
                --end
            end
        else
            log.r("=========================>>找不到item " .. v.id)
        end
    end)

    this:LoadCellNumberWithTMP(number,ref_temp)
    --this:LoadCellNumber(number,ref_temp)

    --this:AddCellRewardBind(gift_obj, item_info_list)
end

--- 加载格子的数字(使用TMP字体)
function CardLoad:LoadCellNumberWithTMP(number,ref_temp)
    --- 后端给空格子数字99，遇到这种就忽略
    if number == 99 then return end
    --设置号码
    local Number1 = ref_temp:Get("Number1")
    Number1.text = number
end

--- 加载格子的数字
function CardLoad:LoadCellNumber(number,ref_temp)
    --- 后端给空格子数字99，遇到这种就忽略
    if number == 99 then return end
    --设置号码
    if number > 9 then
        local first_num = math.modf(number / 10)
        local second_num = math.modf(number % 10)
        if second_num == 0 then
            second_num = 10
        end
        local number1 = ref_temp:Get("number1")
        fun.set_active(number1,true)
        number1.sprite = this.cardView:GetNormalNumberSprites(first_num)
        local offsetX = this:CalculateNumOffsetX(number1, first_num, second_num)
        fun.set_rect_local_pos_x(number1, -offsetX)
        local number2 = ref_temp:Get("number2")
        fun.set_active(number2,true)
        number2.sprite = this.cardView:GetNormalNumberSprites(second_num)
        fun.set_rect_local_pos_x(number2, offsetX)
    else
        local first_num = math.modf(number % 10)
        local number1 = ref_temp:Get("number1")
        fun.set_active(number1,true)
        number1.sprite = this.cardView:GetNormalNumberSprites(first_num)
        fun.set_rect_local_pos_x(number1, 0)
        local number2 = ref_temp:Get("number2")
        fun.set_active(number2,false)
    end
end

function CardLoad:CalculateNumOffsetX(go, num1, num2)
    --local scale = fun.get_gameobject_scale(go, true)
    --local offsetX = 0
    --if scale.x > 0.9 then
    --    if num1 ~= 1 and num2 ~= 1 then
    --        offsetX = 3
    --    end
    --end

    --return this.cardView.number_offset + offsetX
    return this.cardView.number_offset
end

---加载卡牌奖励
---2023/8/21 去掉美食袋子，换成卡包
function CardLoad:LoadCardReward (cardid, cardReward)
    local map = this.cardView.idToMap[tostring(cardid)]
    if map == nil then
        log.r(" delayPlayCardEffect  map   nil ")
    end
    if #cardReward > 0 then
        --local ref_temp = fun.get_component(map, fun.REFER)
        --local anima = ref_temp:Get("rewardPar")
        --if anima == nil then
        --    log.r(" delayPlayCardEffect    nil ")
        --end
        --local game_type = this.model:GetGameType()
        --local game_type_name = ""
        --for k, v in pairs(GameType) do
        --    if v == game_type then
        --        game_type_name = k
        --        break
        --    end
        --end
        --log.e ("Reward   "..#cardReward)
        --Event.Brocast(EventName.CardEffect_Add_Card_Effect, cardid, {
        --    anima = anima,
        --    game_type_name = game_type_name,
        --    rewardLen = #cardReward
        --})
        --this.cardView.cardEffect:AddCardEffect(cardid, anima, game_type_name, #cardReward)
        --for i = 1, #cardReward do
        --    local data = Csv.GetData("item", cardReward[i].id, "icon")
        --    local obj = ref_temp:Get("reward_icon" .. i)
        --    local icon = fun.find_child(obj, "icon")
        --    local img = fun.get_component(icon, fun.IMAGE)
        --    local itemType = Csv.GetData("item", cardReward[i].id, "item_type")
        --    --this:GetSprite(itemType,img,data)
        --    ViewTool:LoadBattleGiftSprite(itemType,img,data)
        --    --local atlas_name = this:GetAtlasByItemType()
        --    --img.sprite = AtlasManager:GetSpriteByName(atlas_name, data)
        --end
        
        local temp = {cardId = tonumber(cardid) , hide_state  = 1}
        table.insert(this.cardView.hide_card_reward_list,temp)
    end
end

--获取卡牌棋局子部分
function CardLoad:InitCardChild (cardPar, tCardId)
    local ref_temp = cardPar:GetComponent(fun.REFER)
    this.model = ModelList.BattleModel:GetCurrModel()
    local cellmap = {}
    for i = 1, 25, 1 do
        local cardCell = ref_temp:GetByIndex(i)
        table.insert(cellmap, cardCell)
        this.model:GetRoundData(tCardId,i):BindObj(cardCell)
    end
    this.cardView:SetCardCell(tCardId,cellmap)
end

function CardLoad:FoodBagFlyToCard(clone)

end

local function IsCookie(itemId)
    return Csv.GetData("item",itemId,"item_type") == 3
end

function CardLoad:StartDropCellItemEffect(cb)
    local maxDropTime = 0
    this.isPlayingDropItem = false
    this.total_cell_gift_count = #this.total_cell_gift
    Cache.unload_ab("luaprefab.material.ef_hall_Coincookie")
    if this.total_cell_gift_count > 0 then
        for i = 1, #this.total_cell_gift do
            --local randTime = math.random(0,8)*0.1
            --if randTime >maxDropTime then  maxDropTime = randTime end
            --LuaTimer:SetDelayFunction(randTime,function()
                fun.set_active(this.total_cell_gift[i].obj, true)
                --if ModelList.BattleModel.GetBattleCookeDouble() and IsCookie(this.total_cell_gift[i].itemId) then
                --    local  anim = fun.get_component(this.total_cell_gift[i].obj,fun.ANIMATOR)
                --    anim:SetBool("double",true)
                --end

                --- 最后一个时候杯赛
                --this.isPlayingDropItem = true
                ----log.e("randTime  i =="..i.."      "..#this.total_cell_gift)
                --if i == (this.total_cell_gift_count or #this.total_cell_gift ) then
                --    if cb then
                --        fun.SafeCall(cb)
                --    else
                --        Event.Brocast(EventName.Competition_battle_start_effect)
                --    end
                --end

                ---[[
                --if 2036 == this.total_cell_gift[i].itemId then
                --    local  anim = fun.get_component(this.total_cell_gift[i].obj, fun.ANIMATOR)
                --    anim:Play("drop3")
                --end
                --]]
            --end,nil,LuaTimer.TimerType.Battle)
        end
        
        --动画播完
        LuaTimer:SetDelayFunction(1, function()
            fun.SafeCall(cb)
        end)
    else
        fun.SafeCall(cb)
    end

    --- 统一播放扫光
    --LuaTimer:SetDelayFunction(maxDropTime+0.1,function()
    --    if ModelList.BattleModel:GetCurrBattleView():IsAuto() then
    --        local gifEffectCache = {}
    --        for i = 1, #this.total_cell_gift do
    --            local obj = this.cardView:GetCardCell(this.total_cell_gift[i].mapIndex,this.total_cell_gift[i].cellIndex)
    --            local gifEffect = BattleEffectPool:Get("gif_effect",obj)
    --            if gifEffect then
    --                fun.set_parent(gifEffect, obj, false)
    --                fun.set_gameobject_pos(gifEffect,0,0,0,true)
    --                fun.play_animator(gifEffect, "show", true)
    --                table.insert(gifEffectCache,gifEffect)
    --            end
    --        end
    --        LuaTimer:SetDelayFunction(12, function()
    --            if gifEffectCache then
    --                for key, value in pairs(gifEffectCache) do
    --                    BattleEffectPool:Recycle("gif_effect",value)
    --                end
    --            end
    --        end,nil,LuaTimer.TimerType.Battle)
    --    else
    --        for i = 1, #this.total_cell_gift do
    --            local obj = this.total_cell_gift[i].obj.transform.parent
    --            local gift_animator = this.total_cell_gift[i].anim --obj:GetComponent(fun.ANIMATOR)
    --            if not gift_animator or Util.IsNull(gift_animator) then
    --                obj = this.total_cell_gift[i].obj.transform.parent.parent
    --                gift_animator = obj:GetComponent(fun.ANIMATOR)
    --            end
    --            fun.play_animator(gift_animator, "show", true)
    --        end
    --    end
    --end,nil,LuaTimer.TimerType.Battle)
    --LuaTimer:SetDelayFunction(maxDropTime + 2, function()
    --    if this.all_flash_gift and #this.all_flash_gift > 0 then
    --        for i = 1, #this.all_flash_gift do
    --            if this.all_flash_gift[i].obj and not Util.IsNull(this.all_flash_gift[i].obj) then
    --                fun.set_active(this.all_flash_gift[i].obj, true)
    --                fun.SetAsLastSibling(this.all_flash_gift[i].obj.gameObject)
    --            end
    --        end
    --    end
    --    --Event.Brocast(EventName.Competition_battle_start_effect)
    --end,nil,LuaTimer.TimerType.Battle)
end

--检查放大镜，决定是否播放放大镜出场动效
function CardLoad.CheckMirror()
    if ModelList.BattleModel:GetCurrModel():IsOpenMirror() then
        local magnifier = this.cardView:GetParentView():GetMagnifier()
        fun.set_gameobject_scale(magnifier,1.2,1.2,1)
        fun.set_active(magnifier,true)
        Anim.scale_to_xy(magnifier,1,1,0.5)
    end
end

function CardLoad.Register()
    Event.AddListener(EventName.PowerUpEffect_FoodBagFlyToCard,this.FoodBagFlyToCard)
    Event.AddListener(EventName.CardEffect_Drop_All_Cell_Item,this.StartDropCellItemEffect)
    Event.AddListener( Notes.START_MIRROR_CHECK,this.CheckMirror)
end

function CardLoad.UnRegister()
    Event.RemoveListener(EventName.CardEffect_Drop_All_Cell_Item,this.StartDropCellItemEffect)
    Event.RemoveListener(EventName.PowerUpEffect_FoodBagFlyToCard,this.FoodBagFlyToCard)
    Event.RemoveListener( Notes.START_MIRROR_CHECK,this.CheckMirror)
end

function CardLoad:OnDisable()
    this.UnRegister()
end


--- 优化项：把卡牌Bingo字母的高亮特效单独放置
function CardLoad:RepositionCardLetterEffect(mapList,effectNode)
    for i = 1, #mapList do
        if mapList[i]["letter_b"]  then
            fun.set_parent()
        end
    end
end

return this
