---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/31 15:30
---


local BaseSkill =  require("View.Bingo.CardModule.Skill.BaseSkill")

local DoubleNumSkill = BaseSkill:New("DoubleNumSkill")
setmetatable(DoubleNumSkill,BaseSkill)
local this = DoubleNumSkill

function DoubleNumSkill:DoubleNumToCards(cardEffects, index, icon, powerupId)
    if self:GetCardPower():GetFindMissPosState() then
        return this:DoubleNumToCardsWithMissingPos(cardEffects, powerupId, index, icon)
    end
    
    local extra_info = {}
    local cardView = self:GetCardPower():GetCardView()
    local model = self:GetModel()
    
    coroutine.start(function()
        table.walk(cardEffects, function(v, k)
            local cardId, effectData, temp = v.cardId, v.effectData, {}
            if not model:GetRoundData(cardId):GetForbid() then
                coroutine.wait((k - 1) * GlobalArtConfig.PowerUpUseIntervalPerCard)
                local posList = BattleTool.GetFromServerPos(effectData.posList)
                local extraData = JsonToTable(effectData.extra or "")
                for i = 1, #posList do
                    local pos = posList[i]
                    local cellData = model:GetRoundData(tostring(cardId), posList[i])
                    local find = table.find(extraData.numbers, function(k1, d)
                        local _pos = ConvertServerPos(d.pos)
                        return _pos == pos
                    end)
                    local doubleNum = find and find.number or 0
                    
                    if not cellData or not cellData:IsNotSign() then
                        --位置被盖章，重新找位置
                        pos, doubleNum = self:DoubleNumNewPos(cardId, pos, doubleNum)
                    end

                    if pos > 0 then
                        local obj = cardView:GetCardCell(cardId,pos)
                        local oriNum = model:GetRoundData(cardId, pos).num
                        model:SetRoundDoubleData(tostring(cardId), pos, doubleNum)

                        this:PlayEffect(cardId, pos, function()
                            if model:CanSignByIndex(cardId, pos) then
                                Event.Brocast(EventName.PowerUpEffect_DoubleNum, obj, doubleNum, cardId, pos)
                                if this:IsCalledInDoubleNum(oriNum, doubleNum) and model:CanSignByIndex(cardId, pos)
                                        and not ModelList.BattleModel:GetCurrModel():GetRoundData(cardId):GetForbid() then
                                    Event.Brocast(EventName.Magnifier_Show_Single_Cell, obj, oriNum, true, cardId, pos, powerupId)
                                end
                                --if model:IsWishState(cardId, pos) then
                                --    Event.Brocast(EventName.CardBingoEffect_DoubleNumWish, fun.get_component(obj, fun.REFER))
                                --end
                            end
                        end)

                        --Event.Brocast(EventName.CardItem_Cell_Add_Item, obj, icon, clone, nil, cardId, DoubleNumEffect)
                        Event.Brocast(EventName.Recorder_Data, 5007, { cardId = k, index = pos, num = doubleNum })
                        table.insert(temp, pos)
                    end
                end
            end
            extra_info[cardId] = temp
        end)
    end)

    return extra_info
end

function DoubleNumSkill:DoubleNumToCardsWithMissingPos(cardEffects, powerupId, index, icon)
    local extra_info = {}
    local model = self:GetModel()
    local cardView = self:GetCardPower():GetCardView()
    
    coroutine.start(function()
        table.walk(cardEffects, function(v, k)
            local cardId, effectData, temp = v.cardId, v.effectData, {}
            if not model:GetRoundData(cardId):GetForbid() then
                coroutine.wait((k - 1) * GlobalArtConfig.PowerUpUseIntervalPerCard)
                local posList = BattleTool.GetFromServerPos(effectData.posList)
                local extraData = JsonToTable(effectData.extra or "")
                for i = 1, #posList do
                    local pos = 1
                    if model:GetRoundData(tostring(cardId), posList[i]).sign == 0 then
                        pos = posList[i]
                    else
                        local cardPower = self:GetCardPower()
                        local otherPos = cardPower:GetNoHitPos(cardId, 1, self.CellState.DoubleNum)
                        if #otherPos > 0 then
                            pos = otherPos[1]
                        end
                    end

                    local find = table.find(extraData.numbers, function(k2, d)
                        local _pos = ConvertServerPos(d.pos)
                        return _pos == pos
                    end)
                    local doubleNum = find and find.number or 0
                    local obj = cardView:GetCardCell(cardId,pos)
                    local oriNum = model:GetRoundData(cardId, pos).num
                    model:SetRoundDoubleData(tostring(cardId), pos, doubleNum)

                    this:PlayEffect(cardId, pos, function()
                        if model:CanSignByIndex(cardId, pos) then
                            Event.Brocast(EventName.PowerUpEffect_DoubleNum, obj, doubleNum, cardId, pos)
                            if this:IsCalledInDoubleNum(oriNum, doubleNum) and model:CanSignByIndex(cardId, pos) then
                                Event.Brocast(EventName.Magnifier_Show_Single_Cell, obj, oriNum, true, cardId, pos, powerupId)
                            end
                            --if model:IsWishState(cardId, pos) then
                            --    Event.Brocast(EventName.CardBingoEffect_DoubleNumWish, fun.get_component(obj, fun.REFER))
                            --end
                        end
                    end)

                    --Event.Brocast(EventName.CardItem_Cell_Add_Item, obj, icon, clone, nil, cardId, DoubleNumEffect)
                    Event.Brocast(EventName.Recorder_Data, 5007, { cardId = k, index = pos, num = doubleNum })
                    table.insert(temp, pos)
                end
            end
            extra_info[cardId] = temp
        end)
    end)
    
    return extra_info
end

function DoubleNumSkill:PlayEffect(cardId, pos, cb)
    local cardView = self:GetCardPower():GetCardView()
    local cellObj = cardView:GetCardCell(tonumber(cardId), pos)
    --local root = cardView:GetEffectPlayRoot(cardId, BingoBangEntry.BattleContainerType.PuEffectContainer)
    BattleEffectCache:GetCachedPrefab_BingoBang(cardId, "ExtraNumber", {
        targetObj = cellObj,
        recycleTime = 2,
        parentContainerType = BingoBangEntry.BattleContainerType.PuEffectContainer,
        cb = function(obj)
            if not IsNull(obj) then
                LuaTimer:SetDelayFunction(1, function()
                    fun.SafeCall(cb)
                end)
            else
                fun.SafeCall(cb)
            end
        end
    })
end

function DoubleNumSkill:DoubleNumNewPos(cardId, pos, doubleNum)
    local cardPower = self:GetCardPower()
    local colum = math.floor((pos - 1) / 5)

    --逻辑1：尝试投放在同一列[会盖章位置]上，投放在同列时，[额外数字]就不需要做调整
    local hitPos = cardPower:GetHitPosInColumn(cardId, colum, 1, true, this.CellState.DoubleNum)
    if GetTableLength(hitPos) > 0 then
        log.r(string.format("[DoubleNumNewPos], find Same Colum hit pos:%s, doubleNum:%s", hitPos[1], doubleNum))
        return hitPos[1], doubleNum
    end

    local cardInfo = self:GetModel():GetRoundData(tostring(cardId))
    --逻辑2：若同列没有[会盖章位置]，则随机选择其他列[会盖章位置]，并将[额外数字]调整为该列[会叫到的号码]。
    hitPos = cardPower:GetHitPosInColumn(cardId, colum, 1, false, this.CellState.DoubleNum)
    if GetTableLength(hitPos) > 0 then
        local had_num_table = self:GetCurrRowNum(hitPos[1], cardInfo)
        local rand_num = cardPower:RandomUnRepeatedNumber(hitPos[1], had_num_table, true, 0)
        if rand_num > 0 then
            log.r(string.format("[DoubleNumNewPos], find hit pos:%s, hit doubleNum:%s", hitPos[1], rand_num))
            return hitPos[1], rand_num
        end

        --若无合适数字，则取不会叫中的号码。（例如B列时，从1~15里取，需避免与原有数字重复）。
        rand_num = cardPower:RandomUnRepeatedNumber(hitPos[1], had_num_table, false, 0)
        if rand_num > 0 then
            log.r(string.format("[DoubleNumNewPos], find hit pos:%s, not hit doubleNum:%s", hitPos[1], rand_num))
            return hitPos[1], rand_num
        end
    end

    --逻辑3：上述两步无法得到结果时，随机取一个不会盖章的位置。
    hitPos = cardPower:GetNoHitPos(cardId, 1, this.CellState.DoubleNum)
    if hitPos then
        local had_num_table = self:GetCurrRowNum(hitPos[1], cardInfo)
        local rand_num = cardPower:RandomUnRepeatedNumber(hitPos[1], had_num_table, false, 0)
        if rand_num > 0 then
            log.r(string.format("[DoubleNumNewPos], find not hit pos:%s, not hit doubleNum:%s", hitPos[1], rand_num))
            return hitPos[1], rand_num
        end
    end
    
    log.r("[DoubleNumNewPos], not find any pos!")
    return 0, 0
end

--获取当前列的所有数字
function DoubleNumSkill:GetCurrRowNum(curr_index, card_info)
    local temp_table = {}
    local start_index = 1 + math.floor((curr_index - 1) / 5) * 5
    for i = start_index, start_index + 4 do
        table.insert(temp_table, card_info.cards[i].num)
        if card_info.cards[i].double_num > 0 then
            table.insert(temp_table, card_info.cards[i].double_num)
        end
    end
    return temp_table
end

function DoubleNumSkill:IsCalledInDoubleNum(num1, num2)
    if self:GetModel():IsCalledNumber(num1) or self:GetModel():IsCalledNumber(num2) then
        return true
    end
    return false
end

return this