---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 29/11/2024 ���� 5:24
---

local BaseSkill = require "View/Bingo/CardModule/Skill/BaseSkill"
local ChristmasSynthesisPuSkill = BaseSkill:New("ChristmasSynthesisPuSkill")
local this = ChristmasSynthesisPuSkill
local private = {}

function ChristmasSynthesisPuSkill:ShowSkill(cardId, cellIndex, powerId, skillId, serverExtraPos)
    if skillId == 139 then
        self:ShowSkill01(cardId, cellIndex, powerId, skillId)
    else
        self:ShowSkill02(cardId, cellIndex, powerId, skillId, serverExtraPos)
    end
end

-----------------------------------------------------------skill 1 ��ɫը�����ܣ��ƻ��������������Ϸ�2*2��Χ  -----------------------------------------------------------Begin
function ChristmasSynthesisPuSkill:ShowSkill01(cardId, cellIndex, powerId, skillId)
    log.log("ChristmasSynthesisPuSkill:ShowSkill01(cardId, cellIndex, , )", cardId, cellIndex)
    local target = self:GetCardPower().cardView:GetCardCell(tonumber(cardId), cellIndex)
    BattleEffectCache:GetSkillPrefabFromCache("cityget", target, nil, 2)

    BattleEffectCache:GetSkillPrefabFromCache("ChristmasSynthesiskill1red", target, function (obj)
        UISound.play("santablessingball")
        local cellIndexs = self:GetSkill01Cells(cellIndex, 139)
        local signDelays = { 1.5, 1.5, 1.5 }
        table.each(cellIndexs, function (index, key)
            if private.IsValidIndex(index, cellIndex) then
                LuaTimer:SetDelayFunction(signDelays[key], function ()
                    private.TrySignCell(self, cardId, index, powerId)
                end, false, LuaTimer.TimerType.BattleUI)
            end
        end)
    end, 2, cardId, nil, nil, true)
end

function ChristmasSynthesisPuSkill:GetSkill01Cells(startCellIndex, skillId)
    local data = Csv.GetData("skill", skillId, "skill_xyz")
    local ori_x = math.modf((startCellIndex - 1) / 5)
    local ori_y = math.modf((startCellIndex - 1) % 5)
    local ret = {}
    table.each(data, function (offset, index)
        local new_x = ori_x + offset[1]
        local new_y = ori_y - offset[2]
        if new_x >= 0 and new_x <= 4 and new_y >= 0 and new_y <= 4 then
            local new_index = new_x * 5 + new_y + 1
            table.insert(ret, new_index)
        end
    end)
    return ret
end

-----------------------------------------------------------skill 1-----------------------------------------------------------End

-----------------------------------------------------------skill 2-----------------------------------------------------------Begin
function ChristmasSynthesisPuSkill:GetSkill02Cells(startCellIndex)
    local ret = {}
    for i = 1, 4 do
        local tmpIdx = startCellIndex - i
        if tmpIdx % 5 > 0 then
            table.insert(ret, tmpIdx)
        else
            break
        end
    end

    return ret
end

function ChristmasSynthesisPuSkill:ShowSkill02(cardId, cellIndex, powerId, skillId)
    log.log("ChristmasSynthesisPuSkill:ShowSkill01(cardId, cellIndex, , )", cardId, cellIndex)
    local target = self:GetCardPower().cardView:GetCardCell(tonumber(cardId), cellIndex)
    BattleEffectCache:GetSkillPrefabFromCache("cityget", target, nil, 2)
    BattleEffectCache:GetSkillPrefabFromCache("ChristmasSynthesiskill2blue", target, function (obj)
        UISound.play("santablessingball")
        local cellIndexs = self:GetSkill01Cells(cellIndex, 140)
        local signDelays = { 1.5, 1.5, 1.5 }
        table.each(cellIndexs, function (index, key)
            if private.IsValidIndex(index, cellIndex) then
                LuaTimer:SetDelayFunction(signDelays[key], function ()
                    private.TrySignCell(self, cardId, index, powerId)
                end, false, LuaTimer.TimerType.BattleUI)
            end
        end)
    end, 2, cardId, nil, nil, true)
end

-----------------------------------------------------------skill 2-----------------------------------------------------------End

function private.IsValidIndex(index)
    return index >= 1 and index <= 25
end

function private.TrySignCell(self, cardId, index, powerId)
    local cellData = ModelList.BattleModel:GetCurrModel():GetRoundData(cardId, index)
    if cellData:IsNotSign() then
        --cellData.isSignByGemPuSkill = true
        self:GetCardPower().cardView:OnClickCardIgnoreJudgeByIndex(cardId, index, powerId)
    end
    self:GetCardPower():ChangeCellState(cardId, index, self.CellState.Signed)
end

return this
