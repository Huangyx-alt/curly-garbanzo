---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/10/28 14:46
---

local BaseSkill = require("View.Bingo.CardModule.Skill.BaseSkill")

local ThrowItemSkill = BaseSkill:New("ThrowItemSkill")
setmetatable(ThrowItemSkill, BaseSkill)
local this = ThrowItemSkill
local private = {}
this.cardView = nil
this.model = nil

--- 在不会命中的格子上丢道具
function ThrowItemSkill:CreateItemsToCardsWithMissingPos(itemid, powerUpData, index, cardPower)
    local detail = Csv.GetData("new_item", itemid)
    local extra_info = {}
    local powerId = powerUpData.powerUpId

    coroutine.start(function()
        table.walk(powerUpData.cardEffect, function(v, k)
            local cardId, effectData, temp = v.cardId, v.effectData, {}
            if not this.model:GetRoundData(cardId):GetForbid() then
                coroutine.wait((k - 1) * GlobalArtConfig.PowerUpUseIntervalPerCard)
                local posList = BattleTool.GetFromServerPos(effectData.posList)
                for i = 1, #posList do
                    local pos = 1
                    if cardPower:GetSign(cardId, posList[i]) == 0 then
                        pos = posList[i]
                    else
                        local otherPos = cardPower:GetNoHitPos(cardId, 1, this.CellState.AddItem)
                        if #otherPos > 0 then
                            pos = otherPos[1]
                        end
                    end

                    --数据设置
                    local add_gift_cell = this.cardView:GetCardCell(cardId, pos)
                    local itemType, selfBingo, skillID = detail["result"][1], 0, nil
                    if itemType == 1 then
                        --技能
                        skillID = detail["result"][2]
                    elseif itemType == 9 then
                        --立即bingo
                        selfBingo = 1
                        Event.Brocast(EventName.Cell_Become_BingoCell, cardId, pos, 1)
                        --else
                    end

                    this.model:SetRoundGiftData(cardId, pos, itemid, 0, skillID, selfBingo, powerId, effectData.extraPos)

                    --图标表现
                    --Event.Brocast(EventName.CardItem_Cell_Add_Item, add_gift_cell, detail["icon"], clone, detail["item_type"], cardId)
                    Event.Brocast(EventName.CardItem_Cell_Add_Item_ByPowerUp, add_gift_cell, detail, cardId, function()
                        if selfBingo == 1 then
                            --播放格子Wigh效果
                            Event.Brocast(EventName.CardBingoEffect_ShowWish, cardId, posList[i])
                        end
                        CalculateBingoMachine.CalculateWishByCard(cardId)
                    end)
                    table.insert(temp, pos)
                end
            end
            extra_info[cardId] = temp
        end)
    end)
    return extra_info
end

--卡牌上创建道具-
function ThrowItemSkill:CreateItemsToCards(itemid, powerUpData, index, cardPower)
    local detail = Csv.GetData("new_item", itemid)
    if detail.result and detail.result[1] == 4 then
        --箱子Pu
        local boxID = ModelList.BattleModel:GetBattleBoxID()
        if boxID then
            itemid = boxID
            detail = Csv.GetData("new_item", boxID)
        end
    end
    
    this.cardView = cardPower:GetCardView()
    this.model = cardPower:GetModel()
    local extra_info = {}
    if cardPower:GetFindMissPosState() then
        extra_info = this:CreateItemsToCardsWithMissingPos(itemid, powerUpData, index, cardPower)
        return extra_info
    end
    
    if detail.result and detail.result[1] == 3 then
        --双倍奖励类，结算时加成
        this:CreateItemsForDoubleReward(itemid, powerUpData, index, cardPower)
        return
    end

    coroutine.start(function()
        local powerId = powerUpData.powerUpId
        table.walk(powerUpData.cardEffect, function(v, k)
            local cardId, effectData, temp = v.cardId, v.effectData, {}
            if not this.model:GetRoundData(cardId):GetForbid() then
                coroutine.wait((k - 1) * GlobalArtConfig.PowerUpUseIntervalPerCard)
                local posList = BattleTool.GetFromServerPos(effectData.posList)
                for i = 1, #posList do
                    local pos = posList[i]
                    local checkIndexValid = pos >= 1 and pos <= 25
                    if checkIndexValid then
                        --设置格子上的技能数据
                        posList[i] = this:CheckCellSigned(cardId, pos, cardPower, itemid)
                        if posList[i] > 0 then
                            local add_gift_cell = this.cardView:GetCardCell(cardId, posList[i])
                            local itemType, selfBingo, skillID = detail["result"][1], 0, nil
                            if itemType == 1 then
                                --技能
                                skillID = detail["result"][2]
                            elseif itemType == 9 then
                                --立即bingo
                                selfBingo = 1
                                Event.Brocast(EventName.Cell_Become_BingoCell, cardId, posList[i], 1)
                                --else
                            end

                            this.model:SetRoundGiftData(cardId, posList[i], itemid, 0, skillID, selfBingo, powerId, effectData.extraPos)

                            Event.Brocast(EventName.CardItem_Cell_Add_Item_ByPowerUp, add_gift_cell, detail, cardId, function()
                                if selfBingo == 1 then
                                    --播放格子Wigh效果
                                    Event.Brocast(EventName.CardBingoEffect_ShowWish, cardId, posList[i], true)
                                end
                                CalculateBingoMachine.CalculateWishByCard(cardId)
                            end)
                        end
                        table.insert(temp, posList[i])
                    end
                end
                extra_info[cardId] = temp
            end
        end)
    end)

    return extra_info
end

function ThrowItemSkill:CreateItemsForDoubleReward(itemid, powerUpData, index, cardPower)
    local detail = Csv.GetData("new_item", itemid)
    local powerId = powerUpData.powerUpId
    local isAllCardPosSigned, allCardPos = true, {}

    ---若部分投放位置会被盖章（例如4卡战斗中，卡1和卡2的PU均可能被盖章，但卡1的位置已被盖章）：
    --将卡1的双倍经验投至[不会盖章位置]（因卡2仍会被点中，不影响整体PU的点中结果）
    table.walk(powerUpData.cardEffect, function(v, k)
        local cardId, effectData, temp = v.cardId, v.effectData, {}
        if not this.model:GetRoundData(cardId):GetForbid() then
            coroutine.wait((k - 1) * GlobalArtConfig.PowerUpUseIntervalPerCard)
            local posList = BattleTool.GetFromServerPos(effectData.posList)
            local pos = posList[1]
            if cardPower:GetSign(cardId, pos) == 0 then
                isAllCardPosSigned = false
                table.insert(allCardPos, {
                    cardId = cardId,
                    pos = pos,
                    effectData = effectData,
                })
            else
                table.insert(allCardPos, {
                    cardId = cardId,
                    pos = private.GetValidCellsForDoubleReward(self, cardPower, cardId, false),
                    effectData = effectData,
                })
            end
        end
    end)

    --若所有投放位置均被盖章：随机选择一张卡上的PU，投放至[会盖章位置]其余的投放在[不会盖章位置]。
    --（确保最终PU的点中结果符合预期）
    if isAllCardPosSigned and #allCardPos > 0 then
        for i = 1, #allCardPos do
            local pos = private.GetValidCellsForDoubleReward(self, cardPower, allCardPos[i].cardId, true)
            if pos > 0 then
                allCardPos[i].pos = pos
                break
            end
        end
    end

    coroutine.start(function()
        table.walk(allCardPos, function(v, k)
            coroutine.wait((k - 1) * GlobalArtConfig.PowerUpUseIntervalPerCard)

            local cardId, pos, effectData = v.cardId, v.pos, v.effectData
            if pos > 0 then
                local add_gift_cell = this.cardView:GetCardCell(cardId, pos)
                local itemType, selfBingo, skillID = detail["result"][1], 0, nil
                if itemType == 1 then
                    --技能
                    skillID = detail["result"][2]
                elseif itemType == 9 then
                    --立即bingo
                    selfBingo = 1
                    Event.Brocast(EventName.Cell_Become_BingoCell, cardId, pos, 1)
                    --else
                end

                this.model:SetRoundGiftData(cardId, pos, itemid, 0, skillID, selfBingo, powerId, effectData.extraPos)

                Event.Brocast(EventName.CardItem_Cell_Add_Item_ByPowerUp, add_gift_cell, detail, cardId, function()
                    if selfBingo == 1 then
                        --播放格子Wigh效果
                        Event.Brocast(EventName.CardBingoEffect_ShowWish, cardId, pos, true)
                    end
                    CalculateBingoMachine.CalculateWishByCard(cardId)
                end)
            end
        end)
    end)
end

function ThrowItemSkill:CheckCellSigned(cardId, cellIndex, cardPower, itemId)
    local pos = 0
    if cardPower:GetSign(cardId, cellIndex) == 0 then
        pos = cellIndex
    else
        pos = private.GetValidCells(self, cardPower, cardId, itemId)
        if pos > 0 then
            return pos
        end
    end
    return pos
end

--双倍经验/双倍金币等，共同点：一张卡上的道具被获取，其他卡上的消失
function private.GetValidCells(self, cardPower, cardId, itemId)
    local posList
    local itemCfg = Csv.GetData("new_item", itemId)
    local skillID = itemCfg.result and itemCfg.result[2]
    local skillCfg = skillID and Csv.GetData("new_skill", skillID)
    if skillCfg and skillCfg.skill_type == 0 then
        --固定形状盖章类
        posList = cardPower:GetNoHitPos(cardId, 1, this.CellState.AddItem)
    else
        --其他pu
        --优先尝试投至[会盖章位置]；若无合适位置才选择[不会盖章位置]
        posList = cardPower:GetHitPos(cardId, 1, this.CellState.AddItem)
        if not posList then
            posList = cardPower:GetNoHitPos(cardId, 1, this.CellState.AddItem)
        end
    end
    
    return posList and posList[1] or 0
end

function private.GetValidCellsForDoubleReward(self, cardPower, cardId, needHit)
    local posList
    if needHit then
        --所有会被命中的格子
        posList = cardPower:GetHitPos(cardId, 1, this.CellState.AddItem)
    else
        --所有不会被命中的格子
        posList = cardPower:GetNoHitPos(cardId, 1, this.CellState.AddItem)
    end
    
    return posList and posList[1] or 0 
end

return this