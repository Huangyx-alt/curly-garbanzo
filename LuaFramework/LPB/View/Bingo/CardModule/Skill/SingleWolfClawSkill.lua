---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/2/8 15:37
---

--- 狼人狼爪技能
local BaseSkill =  require("View.Bingo.CardModule.Skill.BaseSkill")
    
local SingleWolfClawSkill = BaseSkill:New("SingleWolfClawSkill")
setmetatable(SingleWolfClawSkill,BaseSkill)
local this = SingleWolfClawSkill
local private = {}

--随机挑选2个未被释放的狼人击破一层锁链，若场上仅剩下一只狼未被释放，则只对它击破一层锁链
function SingleWolfClawSkill:ShowSkill(cardId, cellIndex)
    cardId = tonumber(cardId)

    local logicModule = BattleLogic.GetLogicModule(LogicName.Card_logic)
    if logicModule:IsJackpot(cardId) then
        return
    end
    
    local curModel, wolfPosList = ModelList.BattleModel:GetCurrModel()
    if ModelList.BattleModel:IsRocket() then
        --在小火箭界面使用5036里的数据
        local data = curModel:GetSettleExtraInfo("wolfClaw")
        data = table.find(data, function(k, v) 
            local cellID = ConvertServerPos(v.pos)
            return v.cardId == cardId and cellID == cellIndex
        end)
        if data then
            wolfPosList = BattleTool.GetFromServerPos(data.wolfPos)
        end
        if not data or #wolfPosList == 0 then
            wolfPosList = curModel:GetValidWolfForClawSkill(cardId, cellIndex)
        end
    else
        wolfPosList = curModel:GetValidWolfForClawSkill(cardId, cellIndex)
    end
    table.each(wolfPosList, function(pos)
        private.ShowClawSkillEffect(self, cardId, cellIndex, pos)
    end)
    
    --添加ExtraData，结算时通知服务器
    curModel:GetRoundData(cardId):AddExtraUpLoadData("wolfClaw", {
        cardId = tonumber(cardId),
        pos = ConvertCellIndexToServerPos(cellIndex),
        wolfPos = BattleTool.ConvertedToServerPosList(wolfPosList),
    }, "pos")
end

-----------------私有方法----------------------------------------------

--狼爪技能格子表现
function private.ShowClawSkillEffect(self, cardId, cellIndex, wolfPos)
    --逻辑层更新
    BattleLogic.GetLogicModule(LogicName.Card_logic):ReduceLogicPrison(cardId, wolfPos)

    local target = self:GetCardPower().cardView:GetCardMap((cardId))
    local cellTarget = self:GetCardPower().cardView:GetCardCell((cardId), cellIndex)
    local wolfTarget = self:GetCardPower().cardView:GetCardCell((cardId), wolfPos)
    local curModel, cardView = ModelList.BattleModel:GetCurrModel(), self:GetCardPower().cardView

    LuaTimer:SetDelayFunction(0.5, function()
        BattleEffectCache:GetSkillPrefabFromCache("SingleWolfFullClaw1", cellTarget, function(obj)
            if ModelList.BattleModel:IsRocket() then
                fun.set_gameobject_scale(obj,1,1,1)
            end
        end, 2)
        LuaTimer:SetDelayFunction(0.6, function()
            UISound.play("werewolf_claw")
            BattleEffectCache:GetSkillPrefabFromCache("SingleWolfFullClaw2", target, function(obj2)
                if ModelList.BattleModel:IsRocket() then
                    fun.set_gameobject_scale(obj2,1,1,1)
                end
                ---技能效果1 格子闪动
                BattleEffectCache:GetSkillPrefabFromCache("SingleWolfFullClaw3", wolfTarget,function(obj3)
                    if ModelList.BattleModel:IsRocket() then
                        fun.set_gameobject_scale(obj3,1,1,1)
                    end
                end, 2, cardId)
            end, 2, cardId, 0)
            
            LuaTimer:SetDelayFunction(1,function()
                curModel:RefreshSignLogicDelayTime()
                cardView:ReducePrison(cardId, wolfPos)
            end,nil,LuaTimer.TimerType.Battle)
        end,nil,LuaTimer.TimerType.Battle)
    end,nil,LuaTimer.TimerType.Battle)
    
end

return this