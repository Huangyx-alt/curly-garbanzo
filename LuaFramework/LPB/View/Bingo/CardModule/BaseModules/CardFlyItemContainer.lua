---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/3/24 15:23
--- 卡牌飞行道具，盒子或瓶子等收集器管理


local  CardFlyItemContainer = Clazz(ClazzBase,"CardFlyItemContainer")
local this = CardFlyItemContainer
CardFlyItemContainer.__index = CardFlyItemContainer
this.box_type ={}
this.hide_record = {}

this.parent = nil
this.battle_type = 0


local XiangZi = "b_bingo_xz"
local PingZi = "b_bingo_pz"
local XP = "xp"
local Gold = "gold"
local Cherry = "cherry"
local Wings = "wings"
local pot = "pot"
local GetHangUpBoxTypeByBattleType = false
local boxWorldPos = nil

function CardFlyItemContainer:New(name)
    local o = {name = name}
    setmetatable(o,{__index = CardFlyItemContainer})
    return o
end

function CardFlyItemContainer:SetCardView(cardView)
    this.cardView = cardView
    this.parent = cardView
    this:GetGameType()
    this:CollectNormalItemsList()
    this.buff_record = {}
    this.buff_record[XP] = {}
    this.buff_record[Gold] = {}
    this.buff_record[Cherry] = {}
    GetHangUpBoxTypeByBattleType = ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET
    this:RecordBoxStandPos()
    --this.Supplement = require("View.Bingo.CardModule.ModuleSupplement.CardFlyItemContainerSupplement")
    --this.Supplement:Init()
end

--- 从BoxPos上获取箱子停留位置，提供给飞行道具使用
--- 因为适配问题，位置会有变动，需要动态获取
function CardFlyItemContainer:RecordBoxStandPos()
    boxWorldPos = Vector3.New(2.078125, 3.538194, 0)
    if this.cardView and this.cardView:GetParentView() then
        local right = this.cardView:GetParentView().Right
        if right then
            local boxPosObj =  fun.find_child(right,"BoxPos")
            if boxPosObj and boxPosObj.transform then
                boxWorldPos = boxPosObj.transform.position
            end
        end
    end
end

function CardFlyItemContainer.OnDisable()

end

function CardFlyItemContainer:IsInTable(key)
    for k,v in pairs(this.box_type) do
        if k == key then
            return true
        end
    end
    return false
end

function CardFlyItemContainer:Register()
    Event.AddListener(EventName.FlyItem_Show_Fly,self.FlyItemDetail,self)
    Event.AddListener(EventName.FlyItem_FoodBag_Fly,self.FlyFoodBagToBox)
    Event.AddListener(EventName.FlyItem_FoodBag_Fly_End,self.HideTarget)
end

function CardFlyItemContainer.UnRegister()
    Event.RemoveListener(EventName.FlyItem_Show_Fly,this.FlyItemDetail)
    Event.RemoveListener(EventName.FlyItem_FoodBag_Fly,this.FlyFoodBagToBox)
    Event.RemoveListener(EventName.FlyItem_FoodBag_Fly_End,this.HideTarget)
end

function CardFlyItemContainer:FlyFoodBagToBox(obj,cardId)
    local img = fun.get_component(obj,fun.IMAGE)
    local loadData  = ModelList.BattleModel:GetCurrModel():LoadGameData()
    local itemId = 0
    for i = 1, #loadData.cardsInfo do
        local id = loadData.cardsInfo[i].cardId
        if id == tonumber(cardId) then
            if loadData.cardsInfo[i].cardReward and #loadData.cardsInfo[i].cardReward > 0 then
                itemId = loadData.cardsInfo[i].cardReward[1].id
            else
                itemId = 1201
                log.r("数据有问题，找不到卡牌奖励ID  " .. cardId)
            end
            break
        end
    end
    local box_type = this:ShowTarget(img.sprite.name,itemId)
    local tarpos =  this:GetTargetPos(box_type,nil,false)
    local startPos = fun.calc_new_position_between(obj.transform.position, tarpos, -4 , 0.2, 0)
    if obj.transform.position.y> 0 then
        startPos = fun.calc_new_position_between(obj.transform.position, tarpos, -6 , -18, 0)
    end
    --BattleEffectCache:GetFixedPrefabFromCache("DaojubaodianGet",obj,function(ob)
    --    Destroy(ob,2)
    --end,cardId)
    Event.Brocast(EventName.Box_Fly_FoodBag, 5, obj)
    local pos = fun.get_gameobject_pos(obj,true)
    Anim.move_to_xy_local(obj,pos.x,pos.y-2000,1,function()
        UnityEngine.Object.Destroy(obj)
    end)
end

---挂机美食篮子
function CardFlyItemContainer:IsHangUpBasket(box_type,itemId)
    if box_type == Wings and itemId then
        local item_type = Csv.GetData("item",itemId,"item_type")
        if  item_type == 8 then
           return true
        end
    end
    return false
end

function CardFlyItemContainer:IsBasket(box_type,itemId)
    if box_type == Wings and itemId then
        local item_type = Csv.GetData("item",itemId,"item_type")
        if  item_type == 8 then
            return true
        end
    end
    return false
end

--- 获得双倍饼干效果
function CardFlyItemContainer:PlaySplitDoubleCookie(icon, delay,call_back,itemId,cardId,cellIndex,box_type,tarpos)
    for i = 1, 2 do
        local currObj = nil
        if i == 1 then currObj = icon.gameObject
        else currObj = fun.get_instance(icon.gameObject,icon.transform.parent)
        end
        fun.SetAsLastSibling(currObj.gameObject)
        local icon_anima = fun.get_component(currObj, fun.ANIMATOR)
        local emptyObj = 	GameObject.New()
        if ModelList.BattleModel:IsRocket() then
            fun.set_parent(emptyObj,this.cardView:GetCardMap(1).transform.parent.parent.parent)
        else
            fun.set_parent(emptyObj,this.cardView:GetParentView().effectObjContainer.FlyGiftContainer)
        end
        emptyObj.transform.localScale = Vector3.one
        local posObj = currObj.transform.parent
        fun.set_same_position_with(emptyObj, posObj)
        fun.set_parent(currObj.gameObject, emptyObj)
        icon_anima.enabled = true
        icon_anima:Play("getDouble"..i)
        local rotate_time = MCT.cell_fly_item_scale
        delay =0
        LuaTimer:SetDelayFunction(rotate_time,function()
            if icon_anima then
                icon_anima.enabled = false
            end
            fun.set_parent(currObj.gameObject,currObj.gameObject.transform.parent.parent,false)
            self:SetFlyItemDetailScale(currObj.gameObject)
            Anim.delay_move(currObj.gameObject, tarpos, 0.5, delay, true, function()
                this:HideTarget(box_type)
                UnityEngine.Object.Destroy(currObj.gameObject)
                Event.Brocast(EventName.FlyItem_HideBoxFun,box_type)
                if call_back  then call_back(box_type,itemId) end
            end)
        end,nil,LuaTimer.TimerType.Battle)
    end
end


--- 获得双倍饼干效果
function CardFlyItemContainer:PlaySplitDoublePuzzle(icon, delay,call_back,itemId,cardId,cellIndex,box_type,tarpos)
    for i = 1, 2 do
        local currObj = nil
        if i == 1 then currObj = icon.gameObject
        else currObj = fun.get_instance(icon.gameObject,icon.transform.parent)
        end
        fun.SetAsLastSibling(currObj.gameObject)
        local icon_anima = fun.get_component(currObj, fun.ANIMATOR)
        local emptyObj = 	GameObject.New()
        if ModelList.BattleModel:IsRocket() then
            fun.set_parent(emptyObj,this.cardView:GetCardMap(1).transform.parent.parent.parent)
        else
            fun.set_parent(emptyObj,this.cardView:GetParentView().effectObjContainer.FlyGiftContainer)
        end
        emptyObj.transform.localScale = Vector3.one
        local posObj = currObj.transform.parent
        fun.set_same_position_with(emptyObj, posObj)
        fun.set_parent(currObj.gameObject, emptyObj)
        icon_anima.enabled = true
        icon_anima:Play("getDouble"..i)
        local rotate_time = MCT.cell_fly_item_scale
        delay =0
        LuaTimer:SetDelayFunction(rotate_time,function()
            if icon_anima then
                icon_anima.enabled = false
            end
            fun.set_parent(currObj.gameObject,currObj.gameObject.transform.parent.parent,false)
            self:SetFlyItemDetailScale(currObj.gameObject)
            Anim.delay_move(currObj.gameObject, tarpos, 0.5, delay, true, function()
                this:HideTarget(box_type)
                UnityEngine.Object.Destroy(currObj.gameObject)
                Event.Brocast(EventName.FlyItem_HideBoxFun,box_type)
                if call_back  then call_back(box_type,itemId) end
            end)
        end,nil,LuaTimer.TimerType.Battle)
    end
end

--- 小丑卡投放的资源图标，以透明方式飞行
local function CheckJokerThrowItem(itemId, img,icon_anima)
    local puCfg = table.find(Csv["new_powerup"], function(k, v)
        return v.itemid == itemId
    end)
    local checkJokerResource = puCfg and puCfg.result[1] == 18
    checkJokerResource = checkJokerResource or itemId >= 7001 and itemId <= 7003
    if checkJokerResource then
        local result = Csv.GetItemOrResource(itemId, "result")
        if ModelList.SeasonCardModel:IsCardPackage(result[2]) then
            --卡包展示
            return false
        end
        
        if img then
            local c = img.color
            c.a = 0
            img.color = c
        end
        if icon_anima then
            icon_anima.enabled = false
        end
        return true
    end
    return false
end

function CardFlyItemContainer:PlayBaseFly(icon, delay,call_back,itemId,cardId,cellIndex,box_type,tarpos)

    local getAnimOverAction = function()
        fun.SetAsLastSibling(icon.gameObject)
        local icon_anima = fun.get_component(icon, fun.ANIMATOR)
        local emptyObj = 	GameObject.New()
        if ModelList.BattleModel:IsRocket() then
            fun.set_parent(emptyObj,this.cardView:GetCardMap(1).transform.parent.parent.parent)
        else
            fun.set_parent(emptyObj,this.cardView:GetParentView().effectObjContainer.FlyGiftContainer)
        end
        emptyObj.transform.localScale = Vector3.one
        local posObj = icon.transform.parent
        fun.set_same_position_with(emptyObj, posObj)
        fun.set_parent(icon.gameObject, emptyObj)
        if not CheckJokerThrowItem(itemId, icon,icon_anima) then
            icon_anima.enabled = true
            icon_anima:Play("get")
        end
        local rotate_time = MCT.cell_fly_item_scale
        delay =0
        LuaTimer:SetDelayFunction(rotate_time,function()
            if icon_anima then
                icon_anima.enabled = false
            end
            fun.set_parent(icon.gameObject,icon.gameObject.transform.parent.parent,false)
            self:SetFlyItemDetailScale(icon.gameObject)
            --Anim.scale_to_xy(icon.gameObject,0.9,0.9,0.4,nil)
            Anim.delay_move(icon.gameObject, tarpos, 0.5, delay, true, function()
                this:HideTarget(box_type)
                UnityEngine.Object.Destroy(icon.gameObject)
                Event.Brocast(EventName.FlyItem_HideBoxFun,box_type)
                if call_back  then call_back(box_type,itemId) end
            end)
        end,nil,LuaTimer.TimerType.Battle)
    end
    getAnimOverAction()
end


function CardFlyItemContainer:PlayFlashFly(icon, delay,call_back,itemId,cardId,cellIndex,box_type,tarpos)
    fun.SetAsLastSibling(icon.gameObject)
    local emptyObj = GameObject.New()
    if ModelList.BattleModel:IsRocket() then
        fun.set_parent(emptyObj, this.cardView:GetCardMap(1).transform.parent.parent.parent)
    else
        fun.set_parent(emptyObj, this.cardView:GetParentView().effectObjContainer.FlyGiftContainer)
    end
    emptyObj.transform.localScale = Vector3.one
    local posObj = icon.transform.parent
    local ainim = fun.get_component(posObj, fun.ANIMATOR)
    if ainim then
        ainim.enabled = false
        fun.set_alpha(icon, 1)
    end
    fun.set_same_position_with(emptyObj, posObj)
    fun.set_parent(icon.gameObject, emptyObj,true)
    fun.set_parent(icon.gameObject, icon.gameObject.transform.parent.parent, false)
    Anim.scale_to_xy(icon.gameObject, 7, 7, 0.3,function()
        if not fun.is_null(icon) then
            Anim.scale_to_xy(icon.gameObject, 3, 3, 0.6)
        end
    end)
    --LuaTimer:SetDelayFunction(0.3, function()
    --    if not fun.is_null(icon) then
    --        Anim.scale_to_xy(icon.gameObject, 3, 3, 0.6)
    --    end
    --end)

    ---赛季令牌的优化，平时和粒子分离，等待飞行时候，合体
    if fun.get_child_count( icon)  == 0 then
        local refTe = fun.get_component(icon,fun.REFER)
        if refTe then
            fun.set_parent(refTe,icon,true)
        end
    end


    local path = {}
    local startPos = fun.get_gameobject_pos(icon.gameObject, false)
    path[1] = fun.calc_new_position_between(startPos, tarpos, 0.2, 0.8, 0)
    path[2] = tarpos
    Anim.bezier_move(icon.gameObject, path, 0.9, 0.1, 1, 2, function()
        this:HideTarget(box_type)
        if icon then
            if fun.get_child_count(icon.gameObject) >0 then
                local flashFlyItem = fun.get_child(icon.gameObject, 0)
                if flashFlyItem then
                    BattleEffectPool:Recycle2("FlashFlyItem", flashFlyItem.gameObject,icon.transform.parent)
                end
            end
            UnityEngine.Object.Destroy(icon.gameObject)
        end
        Event.Brocast(EventName.FlyItem_HideBoxFun, box_type)
        if call_back then
            call_back(box_type, itemId)
        end
    end)
end

-- 具体道具飞行过程
function CardFlyItemContainer:FlyItemDetail(new_sprite_name, icon, delay,call_back,itemId,cardId,cellIndex,isFlash)
    local box_type,itemId = this:ShowTarget(new_sprite_name,itemId)
    local isBasket = this:IsBasket(box_type,itemId)
    local tarpos =  this:GetTargetPos(box_type,new_sprite_name,nil,isBasket,itemId)
    if box_type == pot or this:IsHangUpBasket(box_type,itemId) then
        this:FlyFoodBasket(icon,tarpos,box_type,call_back,itemId,cardId,cellIndex)
    elseif isFlash then
        tarpos =  this:GetTargetPos(box_type,new_sprite_name,false,isBasket,itemId)
        this:PlayFlashFly(icon, delay,call_back,itemId,cardId,cellIndex,box_type,tarpos)
    elseif ( box_type == PingZi  or box_type == Wings ) and ModelList.BattleModel.GetBattleCookeDouble() and
        Csv.GetData("item",itemId,"item_type") == 3   then
        this:PlaySplitDoubleCookie(icon, delay,call_back,itemId,cardId,cellIndex,box_type,tarpos)
    elseif ( box_type == XiangZi  or box_type == Wings ) and ViewTool:IsPuzzleByItem(itemId) and ModelList.BattleModel.GetBattlePuzzleDouble() then
        this:PlaySplitDoublePuzzle(icon, delay,call_back,itemId,cardId,cellIndex,box_type,tarpos)
    elseif not string.is_empty(box_type) then
        this:PlayBaseFly(icon, delay,call_back,itemId,cardId,cellIndex,box_type,tarpos)
    else
        UnityEngine.Object.Destroy(icon.gameObject)
    end
end

--- 飞行美食篮子
function CardFlyItemContainer:FlyFoodBasket(icon,tarpos,box_type,call_back,itemId,cardId,cellIndex)
       --Event.Brocast(EventName.Event_Get_Card_Basket,icon,tarpos,box_type,call_back,itemId,cardId,cellIndex)
end

local AddBoxType = function(box, icon,id)
    if  not fun.is_include(icon,this.box_type[box].icons) then
        table.insert(this.box_type[box].icons,icon)
    end
    if  not fun.is_include(id,this.box_type[box].itemIds) then
        table.insert(this.box_type[box].itemIds,id)
    end
end

function CardFlyItemContainer:CollectNormalItemsList()
    local data = Csv.item
    local start_index = 1
    for k,v in pairs(data) do
        local box = v["box_type"]
        if box and #box > 0  and box ~= "0" then
            if not this:IsInTable(box) then
                this.box_type[box] = {icons = {v["icon"]},index = start_index ,itemIds={v["id"]} }
                start_index = start_index + 1
                this.hide_record[box] = 0
            else
                AddBoxType(box,v["icon"],v["id"])
            end
        end
    end
    --this.box_type[Wings] = 0
    local data2 = Csv.resources
    local start_index = 1
    for k,v in pairs(data2) do
        local box = v["box_type"]
        if box and #box > 0  and box ~= "0" then
            if not this:IsInTable(box) then
                this.box_type[box] = {icons = {v["icon"]},index = start_index ,itemIds={v["id"]} }
                start_index = start_index + 1
                this.hide_record[box] = 0
            else
                AddBoxType(box,v["icon"],v["id"])
            end
        end
    end
end

function CardFlyItemContainer:GetGameType()
    if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_NORMAL then
        this.battle_type = 1
    elseif ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
        this.battle_type = 2
    end
end

---@see 挂机玩法，道具都往右下飞
local GetByBattleType = function(boxType)
    if GetHangUpBoxTypeByBattleType then
        if boxType == XiangZi or boxType == PingZi or boxType == pot then
            return Wings
        end
    end
    return boxType
end


local Start = "Battle"
function CardFlyItemContainer:GetIndex(sprite_name,itemId)
    if  string.sub(sprite_name,1,string.len(Start))==Start then
        sprite_name = string.gsub(sprite_name,Start,"")
    end
    for k,v in pairs(this.box_type) do
        if fun.is_include(sprite_name,v.icons)  then
            if itemId then
                if fun.is_include(itemId,v.itemIds) then
                    return GetByBattleType(k),itemId
                end
            end
        end
    end
    return ""
end

function CardFlyItemContainer:ShowTarget(sprite_name,itemId)
    local box_type ,itemid = this:GetIndex(sprite_name,itemId)
    if  not string.is_empty(box_type) then
        this:ShowTargetHandle(box_type)
        this:SaveBuffItem(box_type,itemid)
    end
    return box_type,itemid
end

function CardFlyItemContainer:ShowTargetHandle(box_type)
    if box_type ~= Wings then
        this.hide_record[box_type] = this.hide_record[box_type] + 1
        this.parent:ShowBox(box_type)
    end
end

function CardFlyItemContainer:SaveBuffItem(box_type ,itemid)
    if this.battle_type == 2 then
        if box_type == Gold then
            table.insert(this.buff_record[box_type],itemid)
        end
    else
        if box_type == XP or box_type == Gold or box_type == Cherry then
            table.insert(this.buff_record[box_type],itemid)
        end
    end
end

function CardFlyItemContainer:ShowBuffItem(box_type)
    if box_type == XP  or  box_type == Gold  or   box_type == Cherry   then
        local temp =this.buff_record[box_type][1]
        table.remove(this.buff_record,1)
        Event.Brocast(EventName.Event_Bingo_Buff , {boxType = box_type, itemId = temp})
    end
end

---@see 播放挂机Winning界面 爆点效果，区分金币和道具
local PlayHangUpWinningViewEffect = function(itemId,obj)
    local result = Csv.GetData("item",itemId,"result")
    if result and result[1] == 3 then
        BattleEffectPool:ShowWithAutoRecycle("WinningGuang1",obj,2)
    else
        BattleEffectPool:ShowWithAutoRecycle("WinningGuang2",obj,2)
    end
end

function CardFlyItemContainer:HideTarget(box_type)
    if box_type ~= Wings then
        this.hide_record[box_type] = this.hide_record[box_type] - 1
    --else
    --    PlayHangUpWinningViewEffect(itemId,obj)
    end
    if box_type == XP or box_type == Gold or box_type == Cherry then
        this:ShowBuffItem(box_type)
    end
end

function CardFlyItemContainer:IsFlyOver(box_type)
    return this.hide_record[box_type] <= 0
end

function CardFlyItemContainer:BottleExit()

end

function CardFlyItemContainer:GetTargetPos(boxType,new_sprite_name,isLocal,isBasket,itemId)
    if boxType == XiangZi then
        if isLocal~= nil  and not isLocal then
            return boxWorldPos
        end
        return  Vector3.New(394, 673, 0)
    elseif boxType == XP then
        return  Vector3.New(388 , 185, 0)
    elseif boxType == Gold then
        return  Vector3.New(333.6999, 386.4001, 0)
    elseif boxType == Cherry then
        return  Vector3.New(333.6999, 516.8, 0)
    elseif boxType == Wings then
        local foodList =  this:GetNormalItemId(new_sprite_name,isBasket,itemId)
        if type(foodList) == "number" then
            return this.parent:GetParentView().winningsView:GetBoxPos(foodList,isLocal)
        elseif foodList then
            local tarposList = {}
            for i = 1, #foodList.reward do
                table.insert(tarposList,this.parent:GetParentView().winningsView:GetBoxPos(foodList.reward[i].id))
            end
            return tarposList
        end
    elseif boxType == pot then
        return  Vector3.New(399, 673, 0)
    else
        return  Vector3.New(394, 673, 0)
    end
end

function CardFlyItemContainer:GetNormalItemId(new_sprite_name,isBasket,itemId)
    local curr_id = 2001
    if isBasket then
        return ModelList.BattleModel:GetCurrModel():GetGroupBagOpenItem(itemId,false)
    else
        local data = Csv.item
        for k, v in pairs(data) do
            if v["icon"] == new_sprite_name then
                curr_id = k
                if v["result"][1] == 3 then
                    curr_id = v["result"][2]
                end
                break
            end
        end
    end
    return curr_id
end

function CardFlyItemContainer:SetFlyItemDetailScale(obj)

end

return this