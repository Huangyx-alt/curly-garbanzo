---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/9 15:22
---

local CardMagnifier = Clazz(ClazzBase, "CardMagnifier")
local this = CardMagnifier
this.is_open_search = false  --开启放大镜
this.brieflyAllowSearch = false  --不管有咩有放大镜，短暂允许放大镜提示
this.MagnifierState = { Close = 1, NoShowTime = 2,Show = 3}
local delay_time = 0
--- 无延迟放大镜显示的卡牌ID
local NoDelayCardId = {}
local ShowedCellMirrorList ={}

---@field public cardView GameCardView
this.cardView = nil

---@param cardView : GameCardView
---@class  CardMagnifier
function CardMagnifier:SetCardView(cardView)
    self.cardView = cardView
    self.model = ModelList.BattleModel:GetCurrModel()
    self.is_open_search = false  --开启放大镜
    self.brieflyAllowSearch = false
    self.Supplement = require("View.Bingo.CardModule.ModuleSupplement.CardMagnifierSupplement")
    self.Supplement:Init(cardView)
    --if ModelList.BattleModel:GetGameType() ~= PLAY_TYPE.PLAY_TYPE_NORMAL then
    --    this:SetMirrorDelayTipTIme(true)
        --this:InitSearch(true)
    --else
        this:SetMirrorDelayTipTIme(false)
    --end
    ShowedCellMirrorList = {}
end

function CardMagnifier:GetCardView()
    return  self.cardView
end


function CardMagnifier:SetMirrorDelayTipTIme(reset)
    if reset then
        delay_time = 0
        NoDelayCardId ={}
    elseif delay_time == 0 then
        NoDelayCardId ={}
        local hint_delay = 0
        local hint_delay_default = Csv.GetData("control", 86, "content")[1][1]
        delay_time = hint_delay_default * 0.001 + hint_delay * 0.001
    end
end

function CardMagnifier:AddNoDelayCard(cardId)
    if not fun.is_include(cardId,NoDelayCardId) then
        table.insert(NoDelayCardId,cardId)
    end
end


function CardMagnifier:InitSearch(is_open_search)
    --if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
    --    self.is_open_search = true
    --else
        self.is_open_search = is_open_search
    --end
    --self.is_open_search = true
    self.brieflyAllowSearch = false
end

-- 检查这个数字的放大镜提示
function CardMagnifier:CheckCardMirrorTip(currNumber)
    local needCheckCardSwitch = ModelList.BattleModel:IsNeedCardSwitch()
    local needShowMirror = true
    if not self.is_open_search and not self.brieflyAllowSearch then
        needShowMirror = false
        if not needCheckCardSwitch then return end
    end
    local showSwitchBtnEffect = false
    if not this.model then return end
    local data = self.model:GetRoundData()
    for k, v in pairs(data) do
        if not v:GetForbid() then
            for i = 1, #v.cards do
                if (v.cards[i].num == currNumber or v.cards[i].double_num == currNumber ) and v.cards[i].sign == 0 then
                    if needShowMirror then
                        local ref = fun.get_component(self.cardView:GetCardMap(k), fun.REFER)
                        local cell = ref:GetByIndex(i)
                        this:CellMirrorTip(cell, currNumber,false, k, i)
                        --Event.Brocast(EventName.Guide_Click_Card_Cell,cell,currNumber)
                        self.model:SetMirror2(tonumber(k), i)
                    end
                    if not showSwitchBtnEffect and ModelList.BattleModel:CanSignCellInBackground(tonumber(k)) then
                        showSwitchBtnEffect = true
                    end
                    if showSwitchBtnEffect and not needShowMirror then break end
                end
            end
            if showSwitchBtnEffect and not needShowMirror then break end
        end
    end
    -- 触发切换按钮高光效果
    if showSwitchBtnEffect then
        Event.Brocast(EventName.Event_Switch_Btn_Shine_Effect)
    end
end

function CardMagnifier:SetCellOnCalled(currNumber)
    local data = self.model:GetRoundData()
    for k, v in pairs(data) do
        if not v:GetForbid() then
            for i = 1, #v.cards do
                if (v.cards[i].num == currNumber or v.cards[i].double_num == currNumber ) and v.cards[i].sign == 0 then
                    v.cards[i].calledTime = Util.NowMillisecond()
                    local cellObj = self.cardView:GetCardCell(k, i)
                    local refer = fun.get_component(cellObj, fun.REFER)
                    if refer then
                        local collider = refer:Get("collider")
                        local boxCollider = fun.get_component(collider, "BoxCollider")
                        if not IsNull(boxCollider) then
                            boxCollider.center = Vector3.New(0, 0, -1)
                            boxCollider.size = Vector3.New(boxCollider.size.x * 1.5, boxCollider.size.x * 1.5, 1)
                            fun.SetAsLastSibling(collider.gameObject)
                        end
                    end
                end
            end
        end
    end
end

function CardMagnifier:CheckCardTip(currNumber)
    local data = self.model:GetRoundData()
    for k, v in pairs(data) do
        if not v:GetForbid() then
            for i = 1, #v.cards do
                if (v.cards[i].num == currNumber or v.cards[i].double_num == currNumber ) and v.cards[i].sign == 0 then
                    self.cardView:PlayBingoTipEffect(tonumber(k), currNumber)
                    break
                end
            end
        end
    end
end

-- 检查这个数字的放大镜提示
function CardMagnifier:CheckNoDelayCard(currNumber)
    local needCheckCardSwitch = ModelList.BattleModel:IsNeedCardSwitch()
    local needShowMirror = true
    if not self.is_open_search and not self.brieflyAllowSearch then
        needShowMirror = false
        if not needCheckCardSwitch then return end
    end
    local showSwitchBtnEffect = false
    local data = self.model:GetRoundData()
    for k, v in pairs(data) do
        if not v:GetForbid() then
            for i = 1, #v.cards do
                if fun.is_include(v.index,NoDelayCardId ) then
                    if (v.cards[i].num == currNumber or v.cards[i].double_num == currNumber ) and v.cards[i].sign == 0 then
                        if needShowMirror then
                            local ref = fun.get_component(self.cardView:GetCardMap(k), fun.REFER)
                            local cell = ref:GetByIndex(i)
                            this:CellMirrorTip(cell, currNumber,false, k, o)
                            --Event.Brocast(EventName.Guide_Click_Card_Cell,cell,currNumber)
                            self.model:SetMirror2(tonumber(k), i)
                        end
                        if not showSwitchBtnEffect and ModelList.BattleModel:CanSignCellInBackground(tonumber(k)) then
                            showSwitchBtnEffect = true
                        end
                        if showSwitchBtnEffect and not needShowMirror then break end
                    end
                end
            end
            if showSwitchBtnEffect and not needShowMirror then break end
        end
    end
    -- 触发切换按钮高光效果
    if showSwitchBtnEffect then
        Event.Brocast(EventName.Event_Switch_Btn_Shine_Effect)
    end
end


--检查所有卡牌的放大镜提示
function CardMagnifier.CheckAllNumberMirrorTip()
    log.r("CardMagnifier:CheckAllNumberMirrorTip  ")
    local showSwitchBtnEffect = false
    local loadData = self.model:LoadGameData()
    for m = 1, #loadData.cardsInfo do
        local id = loadData.cardsInfo[m].cardId
        local isCardInBackground = self.cardView:GetParentView():IsCardShowing(id)
        for i = 1, #loadData.cardsInfo[m].numbers do
            local num = loadData.cardsInfo[m].numbers[i]
            local ref = fun.get_component(self.cardView:GetCardMap(m), fun.REFER)
            local cell = ref:GetByIndex(i)
            if self.cardView:CanClickCard(id, num, cell, i) and self.cardView:CanShowMirror(id, i) then
                --self.cardView:ShowMirrorEffect(cell, num)
                this:CellMirrorTip(cell, num,false, m, i)
                --Event.Brocast(EventName.Guide_Click_Card_Cell,cell,num)
                self.model:SetMirror2(id, i)
                if isCardInBackground then
                    showSwitchBtnEffect = true
                end
            end
        end
    end
    -- 触发切换按钮高光效果
    if showSwitchBtnEffect then
        Event.Brocast(EventName.Event_Switch_Btn_Shine_Effect)
    end
end


function CardMagnifier:ShowMirrorTip(cell, isShow, cardId,pos)
    if isShow and cell and ShowedCellMirrorList and not fun.is_null(ShowedCellMirrorList) and not fun.is_null(cell) then
        table.insert(ShowedCellMirrorList, {
            cardId = tonumber(cardId),
            cell = cell,
        })
    end
    local ref_temp = fun.get_component(cell,fun.REFER)
    if ref_temp then
        local anim = ref_temp:Get("gift")
        local Number1 = ref_temp:Get("Number1")
        local Number2 = ref_temp:Get("Number2")
        local Number_Wish = ref_temp:Get("Number_Wish")
        local Number_Normal = ref_temp:Get("Number_Normal")
        
        if isShow then
            local double_num = self.model:GetRoundData(cardId, pos).double_num
            log.r(string.format("[ShowMirrorTip] cardId:%s, cellPos:%s, double_num:%s", cardId,pos, double_num))
            --if not double_num or double_num == 0 then
                --没有双数字播动画
                fun.play_animator(anim, "tip", true)
            --end
            
            Number1.fontMaterial = Number_Wish.fontMaterial
            Number1.color = Number_Wish.color
            Number2.fontMaterial = Number_Wish.fontMaterial
            Number2.color = Number_Wish.color
        else
            Number1.fontMaterial = Number_Normal.fontMaterial
            Number1.color = Number_Normal.color
            Number2.fontMaterial = Number_Normal.fontMaterial
            Number2.color = Number_Normal.color
            fun.play_animator(anim, "idle", true)
        end
        
        --for i = 1, 4 do
        --    local number = ref_temp:Get("number" .. i)
        --    if number and fun.is_not_null(number.sprite) then
        --        local order = tonumber(string.sub(number.sprite.name, #number.sprite.name))
        --        if order then
        --            this.cardView:SetNumberSpritesOnMirror(number, order)
        --        end
        --    end
        --end
    end

    --local refe = fun.get_component(tip,fun.REFER)
    --if refe then
    --    fun.set_active(refe:Get("tip"),isShow)
    --end
end

function CardMagnifier:HideAllShowedMirrorTip(cardID)
    table.walk(ShowedCellMirrorList, function(v)
        if not cardID or cardID ~= v.cardId then
            if not fun.is_null(v.cell) then
                self:ShowMirrorTip(v.cell,false)
            end
        end
    end)
    ShowedCellMirrorList = {}
end

local function GetTipName(num)
    local gameType = ModelList.BattleModel:GetGameCityPlayID()
    local data = Csv.GetData("new_game_cell",gameType)
    local tipName = ""
    if data.type == 1 then
        return data.b_tip,data.atlas_name
    end
    if num <= 15 then
        tipName = data.b_tip
    elseif num > 60 then
        tipName = data.o_tip
    elseif (num <= 60 and num > 45) then
        tipName = data.g_tip
    elseif (num <= 45 and num > 30) then
        tipName = data.n_tip
    else
        tipName = data.i_tip
    end
    return tipName,data.atlas_name
end


--播放放大镜效果
function CardMagnifier:CellMirrorTip(cell, num,autoClick,cardId,pos,powerupId)
    if not this.is_open_search then
        return
    end
    
    this:ShowMirrorTip(cell,true, cardId,pos)
    
    --设置放大镜颜色，BingoBang不再使用
    --local cellRef = fun.get_component(cell, fun.REFER)
    --if cellRef then
    --    local mirror = cellRef:Get("mirror")
    --    local tipName,atlas_name = GetTipName(num)
    --    mirror.sprite = AtlasManager:GetSpriteByName(atlas_name, tipName)
    --end
    
    --针对挂机玩法自动盖章的逻辑
    if autoClick == nil then autoClick = true end
    if autoClick then self.Supplement:DoubleNumAutoSign(cardId,pos,powerupId) end
end

--追赶正常游戏进度，允许放大镜显示
function CardMagnifier.AllowMagnifier(owner, isAllow)
    owner.brieflyAllowSearch = isAllow
end

function CardMagnifier:DelayCardMirrorTip( currNumber)
    self:SetCellOnCalled(currNumber)
    self:CheckCardTip(currNumber)
    
    if NoDelayCardId and #NoDelayCardId > 0 then
        self:CheckNoDelayCard(currNumber)
    end
    LuaTimer:SetDelayFunction(delay_time, function()
        if ModelList.BattleModel:IsGameing() then
            self:CheckCardMirrorTip(currNumber)
        end
    end,nil,LuaTimer.TimerType.Battle)
end


function CardMagnifier:Register()
    Event.AddListener(EventName.Accelerate_Progress_With_Magnifier, self.AllowMagnifier,self)
    --Event.AddListener(EventName.Magnifier_Show_All_Card, self.AllowMagnifier)
    Event.AddListener(EventName.Magnifier_Default_Attribute, self.InitSearch,self)
    Event.AddListener(Notes.CHECK_CARD_MIRROR, self.DelayCardMirrorTip,self)
    Event.AddListener(EventName.Network_Check_All_Card_Magnifier, self.CheckAllNumberMirrorTip,self)
    Event.AddListener(EventName.Magnifier_Show_Single_Cell, self.CellMirrorTip,self)
    Event.AddListener(EventName.Magnifier_Close_Single_Cell, self.ShowMirrorTip,self)
    Event.AddListener(EventName.Magnifier_Hide_All_Showed_Cell, self.HideAllShowedMirrorTip,self)
end

function CardMagnifier:UnRegister()
    Event.RemoveListener(EventName.Accelerate_Progress_With_Magnifier, self.AllowMagnifier,self)
    --Event.RemoveListener(EventName.Magnifier_Show_All_Card, self.AllowMagnifier)
    Event.RemoveListener(EventName.Magnifier_Default_Attribute, self.InitSearch,self)
    Event.RemoveListener(Notes.CHECK_CARD_MIRROR, self.DelayCardMirrorTip,self)
    Event.RemoveListener(EventName.Network_Check_All_Card_Magnifier, self.CheckAllNumberMirrorTip,self)
    Event.RemoveListener(EventName.Magnifier_Show_Single_Cell, self.CellMirrorTip,self)
    Event.RemoveListener(EventName.Magnifier_Close_Single_Cell, self.ShowMirrorTip,self)
    Event.RemoveListener(EventName.Magnifier_Hide_All_Showed_Cell, self.HideAllShowedMirrorTip,self)
end

return this