---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/8/23 18:06
---
--- 美食篮子


local  CardFoodBasket =Clazz(ClazzBase,"CardFoodBasket")
local this = CardFoodBasket

function CardFoodBasket:SetCardView(cardView)
    this.cardView = cardView
    this.model =  ModelList.BattleModel:GetCurrModel()
end


function CardFoodBasket:SetBasketIcon(obj,foodList)
    local iconList = {}
    for i = 1, #foodList.reward do
        local tubiao =  fun.find_child(obj,"tubiao"..i)
        local img = fun.get_component(tubiao,fun.IMAGE)
        table.insert(iconList,img)
        local iconName = Csv.GetData("item",foodList.reward[i].id,"icon")
        ViewTool:LoadBattleFoodSprite(iconName,iconName,img,nil)
    end
    if #foodList.reward ~= 2 then
        local ani = fun.get_component(obj,fun.ANIMATOR)
        if ani then
            ani:Play("meishilan"..#foodList.reward)
        end
    end
    return iconList
end

function CardFoodBasket:GetFoodBaseKetProduct(itemId)

end


function CardFoodBasket:GetBaseKet(icon,tarpos,box_type,call_back,itemId,cardId,cellIndex)
    local emptyObj = 	GameObject.New()
    if ModelList.BattleModel:IsRocket() then
        fun.set_parent(emptyObj,this.cardView:GetCardMap(1).transform.parent.parent.parent)
    else
        fun.set_parent(emptyObj,this.cardView:GetParentView().effectObjContainer.FlyGiftContainer)
    end
    emptyObj.transform.localScale = Vector3.one
    local posObj = icon.transform.parent
    fun.set_same_position_with(emptyObj, posObj)
    fun.set_active(icon,false)
    BattleEffectCache:GetFreePrefabFromCache3("meishilan", "CellChipContainer", 2.2, icon.gameObject,function(obj)
        local foodList = ModelList.BattleModel:GetCurrModel():GetGroupBagOpenItem(itemId)
        if not foodList then return end
        foodList.itemId = itemId
         ModelList.BattleModel:GetCurrModel():SetCellBasketInfo(cardId,cellIndex,foodList,itemId)
        local iconList = this:SetBasketIcon(obj, foodList)
        LuaTimer:SetDelayFunction(1.3, function()
            fun.set_active(obj, false)
            local delay = 0
            for i = 1, #iconList do
                --fun.set_parent(iconList[i].gameObject, emptyObj.transform, false)
                fun.set_parent(iconList[i].gameObject, emptyObj.transform.parent)
                Anim.scale_to_xy(iconList[i].gameObject,1,1,0.4,nil)
                local readTargetPos = nil
                if #tarpos > 0 then
                    readTargetPos = tarpos[i]
                else
                    readTargetPos = tarpos
                end
                Anim.delay_move(iconList[i].gameObject, readTargetPos, 0.5, delay, true, function()
                    Event.Brocast(EventName.Pot_Trigger_Hit)
                    if i == #iconList then
                        BattleModuleList.GetModule("CardFlyItemContainer"):HideTarget(box_type)
                        Event.Brocast(EventName.FlyItem_HideBoxFun, box_type)
                        if call_back then
                            call_back(box_type, foodList.reward)
                        end
                    end
                    UnityEngine.Object.Destroy(iconList[i].gameObject)
                end)
                delay = delay + 0.2
            end
        end,nil,LuaTimer.TimerType.Battle)
    end)

end


function CardFoodBasket.Register()
    Event.AddListener(EventName.Event_Get_Card_Basket, this.GetBaseKet)
end

function CardFoodBasket.UnRegister()
    Event.RemoveListener(EventName.Event_Get_Card_Basket, this.GetBaseKet)
end


function CardFoodBasket.OnDisable()
end


return this