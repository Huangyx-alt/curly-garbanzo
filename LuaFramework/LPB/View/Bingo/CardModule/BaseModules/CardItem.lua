---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/2/9 12:26
--- 盒子和瓶子进出管理


local CardItem = Clazz(ClazzBase, "CardItem")
local this = CardItem
local NewGiftCommonName = "gift"

function CardItem:SetCardView(cardView)
    this.cardView = cardView
    this.model = ModelList.BattleModel:GetCurrModel()
    this.Supplement = require("View.Bingo.CardModule.ModuleSupplement.CardItemSupplement")
    this.Supplement:Init()
end

local GiftNumCheckWarnning = function(giftList, clones, cardid, cell_index)
    if giftList then
        if #clones ~= #giftList then
            log.r("记录道具有 " .. #giftList .. "    道具实体有 " .. #clones .. "   " .. cardid .. "  " .. cell_index)
            for i = 1, #giftList do
                log.r("giftList   " .. giftList[i])
            end
        end
    end
end

---@see 卡牌道具触发金币爆炸效果
local GiftTriggerCoinsFlyEffect = function(iconName, cardid, pos)
    --log.log("iconName   " .. iconName)
    if iconName == "PowerupIcon002" or iconName == "PowerupIcon003" or iconName == "PowerupIcon004" then
        ModelList.BattleModel:GetCurrBattleView():ShowCoinFlyEffect(tonumber(cardid), pos)
        BattleEffectCache:GetFreePrefabFromCache2("coinsget", "CellChipContainer", 3, pos)
    end
end

---@see 飞出卡牌可收集的道具
local BasketConvertToFood = function(itemId,cardId,ceeIndex)
    return this.model:GetCellBasketReward(cardId,ceeIndex,itemId)
end

---@see 飞出卡牌可收集的道具
local GetFinnalGift = function(itemId,cardId,ceeIndex)
    if type(itemId) =="table" then
        --local temp ={}
        --for i = 1, #itemId do
        --    local item_type = Csv.GetData("item",itemId[i].id,"item_type")
        --    if item_type == 8  then
        --        return BasketConvertToFood(itemId,cardId,ceeIndex)
        --    else
        --        table.insert(temp,{id = itemId[i].id,value = itemId[i].value})
        --    end
        --end
        return itemId
    else
        local item_type = Csv.GetData("item",itemId,"item_type")
        if item_type == 8  then
            return BasketConvertToFood(itemId,cardId,ceeIndex)
        else
            return {{id = itemId,value = 0}}
        end
    end

end

local function IsFlashItem(itemId)
    return Csv.GetData("item",itemId,"put_type") == 4
end

local function IsCompetitionItem(itemId)
    return Csv.GetData("item",itemId,"put_type") == 5
end

local function IsWinZoneItem(itemId)
    return Csv.GetData("item",itemId,"put_type") == 6
end

--- 飞出闪电道具
local PlayFlashFlyGift = function(clones,cardid,cell_index)
    local child = fun.find_child(clones,"shandian")
    local gift_icon = nil
    if fun.get_child_count( child)  == 0 then
        log.r("shandian  nill ")
        return
    else
        gift_icon = fun.get_child(child,0)
    end
    local icon = fun.get_component(gift_icon, fun.IMAGE)
    if fun.get_child_count( gift_icon)  == 0 then
        local refTe = fun.get_component(gift_icon,fun.REFER)
        local obj = Cache.load_pool_or_instance("FlashFlyItem", refTe:Get("lizi"))
        fun.set_parent(obj,gift_icon,true)
        fun.set_active(obj,true)
    else
        local trail = fun.get_child(gift_icon,0)
        fun.set_active(trail,true)
    end

    local real_name = (string.gsub(icon.sprite.name, "(Clone)", ""))
    real_name = (string.gsub(real_name, "[()]", ""))
    local callBack = function() end
    if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
        callBack = function(box_type,itemId)
            local reward = GetFinnalGift(itemId,cardid,cell_index)
            for m = 1, #reward do
                Event.Brocast(EventName.HangUpCell_Click_Get_Item,reward[m].id,reward[m].value)
            end
        end
        this.Supplement:SetFlyGiftScale(icon)
    end
    
    UnityEngine.Object.Destroy(icon.gameObject)
    --local flashId = this.model:GetRoundData(cardid,cell_index):GetFlashItem()
    --Event.Brocast(EventName.FlyItem_Show_Fly, real_name, icon, 0, callBack, flashId,cardid,cell_index,true)
end

--- 飞出杯赛活动道具
local PlayCompetitionItemFly = function(clones, cardid, cell_index, giftID)
    local ctrlName = string.format("competition_clone-%s", giftID)
    clones = fun.find_child(clones, ctrlName)
    if fun.is_null(clones) then
        return
    end
    
    local child = fun.find_child(clones,"shandian")
    local gift_icon = nil
    if fun.get_child_count( child)  == 0 then
        log.r("shandian  nill ")
        return
    else
        gift_icon = fun.get_child(child,0)
    end
    local icon = fun.get_component(gift_icon, fun.IMAGE)
    if fun.get_child_count( gift_icon)  == 0 then
        local refTe = fun.get_component(gift_icon,fun.REFER)
        fun.set_parent(refTe:Get("lizi"),gift_icon,true)
        fun.set_active(refTe:Get("lizi"),true)
    else
        local trail = fun.get_child(gift_icon,0)
        fun.set_active(trail,true)
    end
    
    --设置杯赛道具icon
    local itemType = Csv.GetItemOrResource(giftID, "item_type")
    if itemType == 33 then
        --火山活动道具
        fun.set_recttransform_native_size(icon.gameObject, 60, 60)
    else
        fun.set_recttransform_native_size(icon.gameObject, 50, 60)
    end
    
    local real_name = (string.gsub(icon.sprite.name, "(Clone)", ""))
    real_name = (string.gsub(real_name, "[()]", ""))
    local callBack = function() end
    if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
        callBack = function(box_type,itemId)
            local reward = GetFinnalGift(itemId,cardid,cell_index)
            for m = 1, #reward do
                Event.Brocast(EventName.HangUpCell_Click_Get_Item,reward[m].id,reward[m].value)
            end
        end
        this.Supplement:SetFlyGiftScale(icon)
    end

    UnityEngine.Object.Destroy(icon.gameObject)
    --Event.Brocast(EventName.FlyItem_Show_Fly, real_name, icon, 0, callBack, giftID,cardid,cell_index,true)
end

--- 飞出WinZone活动道具
local PlayWinZoneItemFly = function(clones, cardid, cell_index, giftID)
    clones = fun.find_child(clones, "winzone_clone")
    if fun.is_null(clones) then
        return
    end

    local child = fun.find_child(clones, "shandian")
    local gift_icon = nil
    if fun.get_child_count(child) == 0 then
        log.r("shandian  nill ")
        return
    else
        gift_icon = fun.get_child(child, 0)
    end
    local icon = fun.get_component(gift_icon, fun.IMAGE)
    if fun.get_child_count(gift_icon) == 0 then
        local refTe = fun.get_component(gift_icon, fun.REFER)
        fun.set_parent(refTe:Get("lizi"), gift_icon, true)
        fun.set_active(refTe:Get("lizi"), true)
    else
        local trail = fun.get_child(gift_icon, 0)
        fun.set_active(trail, true)
    end

    --设置道具icon
    fun.set_recttransform_native_size(icon.gameObject, 60, 60)

    local real_name = (string.gsub(icon.sprite.name, "(Clone)", ""))
    real_name = (string.gsub(real_name, "[()]", ""))
    local callBack = function()
    end
    if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
        callBack = function(box_type, itemId)
            local reward = GetFinnalGift(itemId, cardid, cell_index)
            for m = 1, #reward do
                Event.Brocast(EventName.HangUpCell_Click_Get_Item, reward[m].id, reward[m].value)
            end
        end
        this.Supplement:SetFlyGiftScale(icon)
    end

    UnityEngine.Object.Destroy(icon.gameObject)
    --Event.Brocast(EventName.FlyItem_Show_Fly, real_name, icon, 0, callBack, giftID, cardid, cell_index, true)
end

---@see 飞出卡牌可收集的道具
local PlayFlyGift = function(clones,giftList,delay,cardid,cell_index,ref_temp)
    local cloneIndex = 0
    --for i = #giftList, 1,-1 do
    table.each(giftList, function(gift, i)
        LuaTimer:SetDelayFunction(0.2 * (i - 1), function()
            if fun.is_null(ref_temp) then
                return
            end
            
            if IsFlashItem(giftList[i]) then
                PlayFlashFlyGift(ref_temp:Get("flash_clone"),cardid,cell_index)
            elseif IsCompetitionItem(giftList[i]) then
                PlayCompetitionItemFly(ref_temp:Get("gift"), cardid, cell_index, giftList[i]) 
            elseif IsWinZoneItem(giftList[i]) then
                PlayWinZoneItemFly(ref_temp:Get("gift"), cardid, cell_index, giftList[i])
            else
                cloneIndex = cloneIndex + 1
                local gift_icon = clones[cloneIndex]
                log.g("PlayFlyGift  " .. tostring(giftList[i]) .. "   " .. tostring(i) .. "    " .. tostring(cardid) .. "     " .. tostring(cell_index))
                if fun.is_not_null(gift_icon) then
                    --log.r("是否有正在飞行的道具")
                    local icon = fun.get_component(gift_icon, fun.IMAGE)
                    local real_name = (string.gsub(icon.sprite.name, "(Clone)", ""))
                    real_name = (string.gsub(real_name, "[()]", ""))
                    local callBack = function() end
                    if ModelList.BattleModel:GetGameType() == PLAY_TYPE.PLAY_TYPE_AUTO_TICKET then
                        callBack = function(box_type, itemId)
                            local reward = GetFinnalGift(itemId, cardid, cell_index)
                            for m = 1, #reward do
                                Event.Brocast(EventName.HangUpCell_Click_Get_Item, reward[m].id, reward[m].value)
                            end
                        end
                        this.Supplement:SetFlyGiftScale(icon)
                    end
                    --Event.Brocast(EventName.FlyItem_Show_Fly, real_name, icon, delay, callBack, giftList[i],cardid,cell_index)
                    GiftTriggerCoinsFlyEffect(real_name, cardid, icon.transform.position)
                end
            end
        end, false, LuaTimer.TimerType.Battle)
    end)
    --end
end

---@see  不需要飞出卡牌收集的道具
local PlayNoFlyGift = function(clones,giftList,delay,cardid,cell_index,ref_temp)
    if giftList then
        for i = 1, #giftList do
            if IsFlashItem(giftList[i]) then
                if ref_temp and ref_temp:Get("flash_clone") and not Util.IsNull(ref_temp:Get("flash_clone")) then
                    UnityEngine.Object.Destroy(ref_temp:Get("flash_clone").gameObject)
                end
            elseif IsCompetitionItem(giftList[i]) then
                local gfit_parent = ref_temp and ref_temp:Get("gift")
                if fun.is_not_null(gfit_parent) then
                    local ctrlName = string.format("competition_clone-%s", giftList[i])
                    local ctrl = fun.find_child(gfit_parent, ctrlName)
                    if fun.is_not_null(ctrl) then
                        UnityEngine.Object.Destroy(ctrl.gameObject)
                    end
                end            
            elseif IsWinZoneItem(giftList[i]) then
                local gfit_parent = ref_temp and ref_temp:Get("gift")
                if fun.is_not_null(gfit_parent) then
                    local ctrl = fun.find_child(gfit_parent, "winzone_clone")
                    if fun.is_not_null(ctrl) then
                        UnityEngine.Object.Destroy(ctrl.gameObject)
                    end
                end
            end
        end
    end
    for i = 1, #clones do
        if  not Util.IsNull(clones[i]) then
            UnityEngine.Object.Destroy(clones[i].gameObject)
        end
    end
end

--判断是否是小丑卡道具
local CheckIsJokerCardItem = function(itemID)
    local puCfg = table.find(Csv["new_powerup"], function(k, v)
        return v.itemid == itemID
    end)
    return puCfg ~= nil
end

--部分小丑卡道具获得效果
local PlayJokerGiftGetEffect = function(cardid, targetCell, itemId)
    local effectName = Csv.GetData("item", itemId, "effectid")
    if fun.is_not_null(effectName) and effectName ~= "0" then
        BattleEffectCache:GetPrefabFromCache(effectName, targetCell, function(effect)
            Destroy(effect, 2)
        end, cardid)
    end
end

--部分活动道具获得效果
local PlayActivityItemGetEffect = function(targetCell, itemId)
    local effectName = Csv.GetData("item", itemId, "effectid")
    if fun.is_not_null(effectName) and effectName ~= "0" then
        local effect = GoPool.pop(effectName, false)
        if effect then
            fun.set_same_position_with(effect, targetCell)
            local refer = fun.get_component(effect, fun.REFER)
            if refer then
                local icon = refer:Get("icon")
                local spriteName = Csv.GetItemOrResource(itemId, "icon")
                if not fun.is_empty_str(spriteName) then
                    Cache.GetSpriteByName("GameItemAtlas", spriteName, function(sprite)
                        fun.set_active(effect, true)
                        fun.enable_component(fun.get_animator(effect), true)
                        if not fun.is_null(sprite) then
                            icon.sprite = sprite
                        end

                        LuaTimer:SetDelayFunction(1.2, function()
                            fun.enable_component(fun.get_animator(effect), false)
                            GoPool.push(effectName, effect)
                        end, false, LuaTimer.TimerType.Battle)
                    end)
                else
                    GoPool.push(effectName, effect)
                end
            else
                GoPool.push(effectName, effect)
            end
        end
    end
end

--某些道具获得时需要播放效果
local PlayGiftGetEffect = function(cardid, targetCell, giftList)
    if fun.is_not_null(targetCell) then
        local jokerGift, otherGift = {}, {}
        table.each(giftList, function(itemId, k)
            local isJokerCardItem = CheckIsJokerCardItem(itemId)
            if isJokerCardItem then
               table.insert(jokerGift, itemId)
            else
                table.insert(otherGift, itemId)
            end
        end)
        
        --小丑卡道具
        table.each(jokerGift, function(itemId)
            PlayJokerGiftGetEffect(cardid, targetCell, itemId)
        end)
        
        --其他道具
        coroutine.start(function()
            local cookieCount = ModelList.BattleModel:GetCurrModel():GetBattleCompetitionGameInfo("mark")
            if ModelList.BattleModel:GetBattleCompetition() and cookieCount > 0 then
                --等饼干
                coroutine.wait(0.4)
            end
            table.each(otherGift, function(itemId, k)
                coroutine.wait(0.4 * (k - 1))
                PlayActivityItemGetEffect(targetCell, itemId)
            end)
        end)
    end
end

function CardItem:CellFlyItemToBox(cardid, cell_index, need_fly, giftList)
    local cell = this.cardView:GetCardCell(tonumber(cardid),cell_index)
    PlayGiftGetEffect(cardid, cell, giftList)
    
    local ref_temp = fun.get_component(cell, fun.REFER)
    local gift_par = ref_temp:Get("gift_parent")
    local len2 = fun.get_child_count(gift_par)
    --有正在掉落的道具，立即停止并设置在最终位置
    for i = 1, len2 do
        local gift_icon = fun.get_child(gift_par, i - 1)
        if string.find(gift_icon.name, "gift_clone") ~= nil then
            fun.set_parent(gift_icon, gift_par, true)
        end
    end
    local delay = MCT.item_delay_fly_to_box
    local clones = {}
    for i = 1, len2 do
        local gift_icon = fun.get_child(gift_par, i - 1)
        if gift_icon.name == NewGiftCommonName then
            table.insert(clones, gift_icon)
        end
    end
    if need_fly then
        PlayFlyGift(clones,giftList,delay,cardid,cell_index,ref_temp)
    else
        PlayNoFlyGift(clones,giftList,delay,cardid,cell_index,ref_temp)
    end
end

function CardItem:HideCellFlyItemNotToBox(cardid, cell_index, need_fly, giftList)
    local cell =  this.cardView:GetCardCell(tonumber(cardid),cell_index)
    local ref_temp = fun.get_component(cell, fun.REFER)
    local gift_par = ref_temp:Get("gift_parent")
    local len2 = fun.get_child_count(gift_par)
    --有正在掉落的道具，立即停止并设置在最终位置
    for i = 1, len2 do
        local gift_icon = fun.get_child(gift_par, i - 1)
        if string.find(gift_icon.name, "gift_clone") ~= nil then
            fun.set_parent(gift_icon, gift_par, true)
        end
    end
    local clones = {}
    for i = 1, len2 do
        local gift_icon = fun.get_child(gift_par, i - 1)
        if gift_icon.name == NewGiftCommonName then
            table.insert(clones, gift_icon)
        end
    end
    PlayNoFlyGift(clones,giftList,0,cardid,cell_index,ref_temp)
end

---@see 播放道具四散开的动画
local PlayGiftBoomEffect = function(cardId,obj)
    local anima = fun.get_component(obj,fun.ANIMATOR)
    if anima then
        anima.enabled = true
        anima:Play("image"..cardId)
    end
end

local GetParent = function(parentType,ref_temp)
    if parentType == 1 then
        return  ref_temp:Get("gift_parent").transform
    else
        return ref_temp:Get("Joker").transform
    end
end

---@see  powerup道具飞到卡牌
local PlayGiftCloneFlyToCard = function(obj, icon, ItemObj, item_type, cardId,callBack,flyTime,parentType,flyTrail)
    local img = nil
    local startPos = fun.get_gameobject_pos(ItemObj, false)
    local endPos = fun.get_gameobject_pos(obj, false)
    local path = {}
    path[1] = fun.calc_new_position_between(startPos, endPos, 0.65, 1, 0)
    path[2] = endPos
    fun.set_active(ItemObj, true)
    if not flyTime then flyTime = MCT.PowerUp_Item_To_Card end
    Anim.bezier_move(ItemObj, path, MCT.PowerUp_Item_To_Card, 0, 1, 2, function()
        if item_type ~= nil then
            local ref_temp = obj:GetComponent(fun.REFER)
            if not parentType then parentType = 1 end
            local cardObj = this.cardView:GetCardMap(tonumber(cardId))
            local ref_temp_card = fun.get_component(cardObj,fun.REFER)
            local gift_clone = ref_temp_card:Get("gift_clone")
            local gift_obj = fun.get_instance(gift_clone, GetParent(parentType,ref_temp))
            fun.set_gameobject_pos(gift_obj,0,0,0,true)
            img = fun.get_component(gift_obj, fun.IMAGE)
            fun.set_alpha(img, 0)
            gift_obj.transform.name = NewGiftCommonName
            fun.SetAsLastSibling(gift_obj.gameObject)
            fun.set_active(gift_obj,true)
            local gift_animator = fun.get_component(gift_obj, fun.ANIMATOR)
            gift_animator:Play("drop2")
            ViewTool:LoadBattleGiftSprite(item_type, img, icon)
            Event.Brocast(EventName.CardEffect_Map_PowerUp_Shake, cardId)
        end
        if callBack then
            callBack()
        end
        BattleEffectPool:ShowWithAutoRecycle("get_powerup", ItemObj, 1,function(obj)
            this.Supplement:SetEffectScale(obj)
        end)
        if flyTrail then  BattleEffectPool:Recycle2("EffPowerFlyTrails",flyTrail,ItemObj.transform.parent)  end
        DestroyImmediate(ItemObj)
    end)
end

---  丢小丑喷球器的号球到卡面上
function CardItem:JokerrBallSprayerFlyToCard(obj,  ItemObj, cardId,callBack,flyTime,parentType)
    local img = nil
    local startPos = fun.get_gameobject_pos(ItemObj, false)
    local endPos = fun.get_gameobject_pos(obj, false)
    local path = {}
    path[1] = fun.calc_new_position_between(startPos, endPos, 0.65, 1, 0)
    path[2] = endPos
    fun.set_active(ItemObj, true)
    if not flyTime then flyTime = MCT.PowerUp_Item_To_Card end
    Anim.bezier_move(ItemObj, path, MCT.PowerUp_Item_To_Card, 0, 1, 2, function()
        local gift_obj = ItemObj
        fun.set_active(gift_obj,true)
        if callBack then
            callBack()
        end

    end)
end

---使用Pu后格子上展示道具出现动画
function CardItem:CellAddGiftByPu(cellObj, itemCfg, cardId, callBack)
    local cardObj = this.cardView:GetCardMap(cardId)
    local ref_temp_card = fun.get_component(cardObj, fun.REFER)
    
    local ref_temp = fun.get_component(cellObj, fun.REFER)
    local gift_obj = ref_temp:Get("gift_clone")
    local giftObjParent = ref_temp:Get("gift_parent")
    local gift_clone = fun.get_instance(gift_obj, giftObjParent)
    fun.set_gameobject_pos(gift_clone, 0, 0, 0, true)
    gift_clone.name = string.format("gift_%s", itemCfg.name)
    local anim = fun.get_component(gift_clone, fun.ANIMATOR)

    --设置道具图片
    local gift_ref_temp = fun.get_component(gift_clone, fun.REFER)
    local touying = gift_ref_temp:Get("touying")
    local gift_icon = gift_ref_temp:Get("gift_icon")
    gift_icon.sprite = AtlasManager:GetSpriteByName("BingoBangBattleAtlas", itemCfg["icon"])
    touying.sprite = AtlasManager:GetSpriteByName("BingoBangBattleAtlas", itemCfg["icon"])
    
    
    --设置到格子的最高表现层级
    local originParent = gift_clone.transform.parent
    local TopShowRoot = ref_temp_card:Get("TopShowRoot")
    fun.set_parent(gift_clone, TopShowRoot, false)
    fun.set_active(gift_clone, true)
    LuaTimer:SetDelayFunction(0.7, function()
        fun.set_parent(gift_clone, originParent, false)
        fun.SafeCall(callBack)
    end)
end

---@see  powerup卡丢道具到卡牌上
function CardItem:CellAddGiftNew(obj, icon, ItemObj, item_type, cardId,callBack,forbidTrail,flyTime,parentType)
    if ItemObj then
        PlayGiftBoomEffect(cardId, ItemObj.gameObject)
    end
    LuaTimer:SetDelayFunction(0.4+tonumber(cardId)*0.1,function()
        local anima = fun.get_component(ItemObj,fun.ANIMATOR)
        if anima then
            anima.enabled = false
        end
        local flyTrail = nil
        if not forbidTrail then
            flyTrail = BattleEffectPool:Get("EffPowerFlyTrails")
            fun.set_parent(flyTrail, ItemObj, true)
        end
        PlayGiftCloneFlyToCard(obj, icon, ItemObj, item_type, cardId,callBack,flyTime,parentType,flyTrail)
    end,nil,LuaTimer.TimerType.Battle)
end

function CardItem:CellItemGet(cardid, cell_index, giftList, cb)
    local cell = this.cardView:GetCardCell(tonumber(cardid),cell_index)
    local ref_temp = fun.get_component(cell, fun.REFER)
    local gift_par = ref_temp:Get("gift_parent")
    local len = fun.get_child_count(gift_par)
    
    for i = 1, len do
        local giftObj = fun.get_child(gift_par, i - 1)
        fun.set_active(giftObj, false)
        --fun.play_animator(giftObj, "")
    end

    table.walk(giftList, function(itemId)
        local puCfg = table.find(Csv.new_powerup, function(k, v)
            return v.item_id == itemId
        end)
        local cfg = Csv.GetData("new_item", itemId, "result")
        local cardObj, effectName = this.cardView:GetCardMap(cardid), "CommonItemGet"
        local targetObj = itemId ~= 819 and cell or this.cardView.parent.go
        if puCfg and not fun.is_empty_str(puCfg.effect_name) and puCfg.effect_name ~= "0" then
            effectName = puCfg.effect_name
        end
        
        if not cfg or cfg[1] == 0 or (cfg[1] ~= 1 and cfg[1] ~= 9) then
            --不是技能,播放获得效果
            BattleEffectCache:GetCachedPrefab_BingoBang(cardid, effectName, {
                targetObj = targetObj,
                recycleTime = 2,
                parentContainerType = BingoBangEntry.BattleContainerType.PuEffectContainer,
                cb = function(obj)
                    if effectName == "CommonItemGet" then 
                        local iconName = Csv.GetData("new_item", itemId, "icon")
                        local refer = fun.get_component(obj, fun.REFER)
                        local icon = refer:Get("icon")
                        icon.sprite = AtlasManager:GetSpriteByName("BingoBangItemAtlas", iconName)
                    end
                    LuaTimer:SetDelayFunction(1, function() fun.SafeCall(cb) end)
                end
            })
        end
    end)
    
    Event.Brocast(NotifyName.RewardCollect.SignCollectReward, cardid, cell_index, giftList)
    Facade.SendNotification(NotifyName.RewardCollect.SignCollectReward, cardid, cell_index, giftList)
end

function CardItem:HideCellItemGet(cardid, cell_index, giftList)
    local cell = this.cardView:GetCardCell(tonumber(cardid),cell_index)
    local ref_temp = fun.get_component(cell, fun.REFER)
    local gift_par = ref_temp:Get("gift_parent")
    local len = fun.get_child_count(gift_par)

    for i = 1, len do
        local giftObj = fun.get_child(gift_par, i - 1)
        fun.set_active(giftObj, false)
        --fun.play_animator(giftObj, "")
    end

    Event.Brocast(NotifyName.RewardCollect.SignCollectReward, cardid, cell_index, giftList)
    Facade.SendNotification(NotifyName.RewardCollect.SignCollectReward, cardid, cell_index, giftList)
end

function CardItem:RemoveCellItem(cardId, cell_index, itemID)
    local itemCfg = Csv.GetData("new_item", itemID)
    
    local cardObj = this.cardView:GetCardMap(cardId)
    local cellObj = this.cardView:GetCardCell(cardId, cell_index)
    
    local ref_temp = fun.get_component(cellObj, fun.REFER)
    local giftObjParent = ref_temp:Get("gift_parent")
    local name = string.format("gift_%s", itemCfg.name)
    local giftObj = fun.find_child(giftObjParent, name)
    if not IsNull(giftObj) then
        giftObj.name = name .. "_removed"

        --local anim = fun.get_component(giftObj, fun.ANIMATOR)

        fun.set_active(giftObj, false)
    end
end

function CardItem.Register()
    Event.AddListener(EventName.CardItem_Cell_Add_Item, this.CellAddGiftNew)
    Event.AddListener(EventName.CardItem_Cell_Add_Item_ByPowerUp, this.CellAddGiftByPu)
    Event.AddListener(EventName.Cell_Item_FlyTo_Box, this.CellFlyItemToBox)
    Event.AddListener(EventName.Hide_Cell_Item_Box, this.HideCellFlyItemNotToBox)
    Event.AddListener(EventName.Cell_Item_Get, this.CellItemGet)
    Event.AddListener(EventName.Hide_Cell_Item_Get, this.HideCellItemGet)
    Event.AddListener(EventName.Remove_Cell_Item, this.RemoveCellItem)
    --Event.AddListener(EventName.Event_CardItem_Cell_Add_Joker_Item, this.CellAddJoker)
end

function CardItem.UnRegister()
    Event.RemoveListener(EventName.CardItem_Cell_Add_Item, this.CellAddGiftNew)
    Event.RemoveListener(EventName.CardItem_Cell_Add_Item_ByPowerUp, this.CellAddGiftByPu)
    Event.RemoveListener(EventName.Cell_Item_FlyTo_Box, this.CellFlyItemToBox)
    Event.RemoveListener(EventName.Hide_Cell_Item_Box, this.HideCellFlyItemNotToBox)
    Event.RemoveListener(EventName.Cell_Item_Get, this.CellItemGet)
    Event.RemoveListener(EventName.Hide_Cell_Item_Get, this.HideCellItemGet)
    Event.RemoveListener(EventName.Remove_Cell_Item, this.RemoveCellItem)
    --Event.RemoveListener(EventName.Event_CardItem_Cell_Add_Joker_Item, this.CellAddJoker)
end

return this