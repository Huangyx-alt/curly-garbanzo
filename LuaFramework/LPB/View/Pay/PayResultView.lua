---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2024/7/2 11:48
---


local PayResultView = BaseView:New("PayErrorView","NewPayAtlas")
local this = PayResultView
this.viewType = CanvasSortingOrderManager.LayerType.Tips
this.isCleanRes = true
this._cleanImmediately = true

this.auto_bind_ui_items = {
    "btn_sure",
    "btn_cancle",
    "content",
    "title",
}

function PayResultView:Awake()
    self:on_init()
    local productItem = self:GetProductName()
    SDK.TrackWebEvent("web_view_error_open",{
        balancecoin = ModelList.ItemModel.get_coin(),
        balancediamond = ModelList.ItemModel.get_diamond(),
        price = self:GetPrice(),
        itemid = productItem,
    })
end

function PayResultView:on_btn_sure_click()
    self:Report(2)
    local platform = UnityEngine.Application.platform

    if platform == UnityEngine.RuntimePlatform.WindowsEditor or platform == UnityEngine.RuntimePlatform.OSXEditor then
        fun.OpenURL("mailto:livepartybingoservice@gmail.com?subject=Good Game&body=We are very glad to help you.\nIf you meet a problem while playing our game, please describe it more clearly to help for a fast treatment.\nOur agent will answer you as soon as she/he arrive at your case. Please enter your feedback below.")
    else
        --local userinfo = ModelList.PlayerInfoModel:GetUserInfo()
        --local recharge = ModelList.PlayerInfoModel:GetUserRechargeInfo()
        AIHelpHelper.Instance:ShowConversation("E002")
    end
end

function PayResultView:on_btn_cancle_click()
    self:Report(1)
    Facade.SendNotification(NotifyName.CloseUI,self)
end

--- click_type 1:Later 2:contact us 3:关闭弹窗
function PayResultView:Report(click_type)
    local productItem = self:GetProductName()
    SDK.TrackWebEvent("web_view_error_click",{
        click_type = click_type,
        price = self:GetPrice(),
        itemid = productItem,
    })
end


function PayResultView:GetProductName()
    local type,product_name = PurchaseHelper.GetPurchasingInfo()
    local productItem
    if type == 1 then
        if ModelList.MainShopModel.cacheShopItemId then
            local productId = Csv.GetData("shop", ModelList.MainShopModel.cacheShopItemId, "product_id")
            if productId then
                productItem = Csv.GetData("appstorepurchaseconfig", productId, "product_name")
            end
        end
    elseif type == 2 then
        local productId = Csv.GetData("pop_up", PurchaseHelper.save_shopItem.id, "product_id")
        if productId then
            productItem = Csv.GetData("appstorepurchaseconfig", productId, "product_name")
        end
    else
        if product_name then
            productItem = product_name
        end
    end
    return productItem
end

function PayResultView:GetPrice()
    if PurchaseHelper.save_data then
        if PurchaseHelper.save_data.price then
            return PurchaseHelper.save_data.price
        elseif PurchaseHelper.save_data.currency then
            return PurchaseHelper.save_data.currency
        elseif PurchaseHelper.save_data.data then
            if PurchaseHelper.save_data.data.price then
                return PurchaseHelper.save_data.data.price
            elseif PurchaseHelper.save_data.data.currency then
                return PurchaseHelper.save_data.data.currency
            end
        end
    end
    return 0
end


return this

