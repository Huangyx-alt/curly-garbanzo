---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/5/19 15:21
---


local GiftPackBaseView = require("View.GiftPack.GiftPackBaseView")

---@class  GiftPackPentaView : GiftPackBaseView
local GiftPackPentaView = GiftPackBaseView:New('GiftPackPentaView', "GiftPackAtlas")
local this = GiftPackPentaView
this.viewType = CanvasSortingOrderManager.LayerType.TopConsole
this.second_atlas_name = "GiftPackAtlas"
local data = nil
local product_list = {}
local canUpClick = true
local canBLClick = true
local canBRClick = true
local click_interval = 0.5

this.auto_bind_ui_items = {
    "btn_close",
    "left_time_txt",
    "btn_up_buy",
    "up_buy_txt",
    "up_reward_icon1",
    "up_reward_txt1",
    "up_reward_icon2",
    "up_reward_txt2",
    "up_reward_icon3",
    "up_reward_txt3",
    "btn_bl_buy",
    "bl_buy_txt",
    "bl_reward_icon",
    "bl_reward_txt",
    "bl_cost_icon",
    "bl_cost_txt",
    "btn_br_buy",
    "br_buy_txt",
    "br_reward_icon",
    "br_reward_txt",
    "br_cost_icon",
    "br_cost_txt",
    "bl_BonusOrMore",
    "br_BonusOrMore",
    "GiftPackPentaView",
    "up_BonusOrMore",
    "cityExp1",
    "cityExp2",
    "cityExp3"
}

function GiftPackPentaView:Awake(obj)
    --this.update_x_enabled = true

    this:on_init()
    self._isInit = true
    --- 修复部分机型首次进入界面不显示问题
    if self._reshowAfterInit then
        self._reshowAfterInit = nil
        self:ShowDetailGift()
    end
end

function GiftPackPentaView.OnEnable()
    --Facade.RegisterView(this)
    --this.update_x_enabled = true
    --this:start_x_update()
    this:BuildFsm(this)
    this:Bi_Tracker()
end

function GiftPackPentaView:on_x_update()
    --this:CheckInputClick()
end

function GiftPackPentaView:ShowDetailGift()
    if self._isInit then
        data = ModelList.GiftPackModel:GetShowGiftPack()
        this:CollectProduct(data.pId,data.giftInfo)
        this:SetUpProduct(product_list[1])
        this:SetDownLeftProduct(product_list[2])
        this:SetDownRightProduct(product_list[3])
        this:SetLeftTime(data.giftInfo[1].expireTime)
    else
        self._reshowAfterInit = true
    end
end



function GiftPackPentaView:CollectProduct(pId,giftInfo)
    product_list = {}
    for _, v in pairs(Csv.pop_up) do
        if pId == v.gift_id then
            for i = 1, #giftInfo do
                if giftInfo[i].id == _ then
                    table.insert(product_list, v.id)
                    break
                end
            end
        end
    end
    table.sort(product_list)
end

local SetBuyBtnDescripe = function( btnObj ,des)
    if #des >0 and des ~="0" then
        local content = fun.find_child(btnObj,"Image/des")
        local txt = fun.get_component(content,"Text")
        if txt then
            txt.text = des
        end
        fun.set_active(content.transform.parent,true)
    else
        local content = fun.find_child(btnObj,"Image")
        fun.set_active(content,false)
    end
end


function GiftPackPentaView:SetUpProduct(id)
    local xls = Csv.GetData("pop_up", id)

    local item1 = xls.item_description[1][1]
    --local icon1 = Csv.GetData("resources", tonumber(item1), 'icon')
    local icon1 = Csv.GetItemOrResource( tonumber(item1),"icon")
    self.up_reward_icon1.sprite = AtlasManager:GetSpriteByName("ItemAtlas", icon1)
    this:SetContent(item1, self.up_reward_txt1, xls.item_description[1][2])
    local item2 = xls.item_description[2][1]
    --local icon2 = Csv.GetData("resources", tonumber(item2), "icon")
    local icon2 = Csv.GetItemOrResource( tonumber(item2),"icon")
    self.up_reward_icon2.sprite = AtlasManager:GetSpriteByName("ItemAtlas", icon2)
    this:SetContent(item2, self.up_reward_txt2, xls.item_description[2][2])
    local item3 = xls.item_description[3][1]
    --local icon3 = Csv.GetData("resources", tonumber(item3), "icon")
    local icon3 = Csv.GetItemOrResource( tonumber(item3),"icon")
    self.up_reward_icon3.sprite = AtlasManager:GetSpriteByName("ItemAtlas", icon3)
    this:SetContent(item3, self.up_reward_txt3, xls.item_description[3][2])

    if #xls.item_description > 3 then
        fun.set_active(this.cityExp1, true)
        local item4 = xls.item_description[4][1]
        local vipexp = fun.find_child(this.cityExp1, "vipexp")
        local text = fun.get_component(vipexp, "Text")
        this:SetContent(item4, text, xls.item_description[4][2])
    else
        fun.set_active(this.cityExp1, false)
    end

    self.up_buy_txt.text = "$" .. xls.price
    canUpClick = true
    local data = ModelList.GiftPackModel:GetGiftById(id)
    if not data or data.canBuyCount <= 0 then
        this:CloseUIShiny(self.btn_up_buy)
        Util.SetUIImageGray(self.btn_up_buy, true)
        canUpClick = false
    elseif    this:OpenUIShiny(self.btn_up_buy) then
        Util.SetUIImageGray(self.btn_up_buy, false)
    end
    this:SetBounsAndMore(self.up_BonusOrMore, xls.bonus, xls.more)
    SetBuyBtnDescripe(self.btn_up_buy,xls.limit_description)
end

function GiftPackPentaView:SetContent(id,txt,content)
    id = tonumber(id)
    if id == 3 then  --放大镜，不需要数字加逗号
        txt.text = content
    else
        txt.text = fun.formatNum(tonumber(content))
    end
end

function GiftPackPentaView:SetDownLeftProduct(id)
    local xls = Csv.GetData("pop_up", id)
    local item1 = xls.item_description[1][1]
    local icon1 = Csv.GetData("resources", item1)
    --this.bl_reward_txt.sprite = AtlasManager:GetSpriteByName("ItemAtlas", icon1.icon)
    self.bl_reward_txt.text = fun.formatNum(xls.item_description[1][2])
    this:SetContent(item1,self.bl_reward_txt,xls.item_description[1][2])
    local item2 = xls.item_description[2][1]
    --local icon2 = Csv.GetData("resources", tonumber(item2), 'icon')
    local icon2 = Csv.GetItemOrResource( tonumber(item2),"icon")
    self.bl_cost_icon.sprite = AtlasManager:GetSpriteByName("ItemAtlas", icon2)
    --this.bl_cost_txt.text = fun.formatNum(xls.item_description[2][2])
    this:SetContent(item2, self.bl_cost_txt, xls.item_description[2][2])
    self.bl_buy_txt.text = "$" .. xls.price
    this:SetBounsAndMore(self.bl_BonusOrMore, xls.bonus, xls.more)
    canBLClick = true
    local data = ModelList.GiftPackModel:GetGiftById(id)
    if not data or data.canBuyCount <= 0 then
        this:CloseUIShiny(self.btn_bl_buy)
        Util.SetUIImageGray(self.btn_bl_buy, true)
        canBLClick = false
    elseif    this:OpenUIShiny(self.btn_bl_buy) then
        Util.SetUIImageGray(self.btn_bl_buy, false)
    end
    if #xls.item_description > 2 then
        fun.set_active(this.cityExp2, true)
        local item4 = xls.item_description[3][1]
        local vipexp = fun.find_child(this.cityExp2, "vipexp")
        local text = fun.get_component(vipexp, "Text")
        this:SetContent(item4, text, xls.item_description[3][2])
    else
        fun.set_active(this.cityExp2, false)
    end
    SetBuyBtnDescripe(self.btn_bl_buy,xls.limit_description)
end

function GiftPackPentaView:SetDownRightProduct(id)
    local xls = Csv.GetData("pop_up", id)
    local item1 = xls.item_description[1][1]
    local icon1 = Csv.GetData("resources", item1)
    --this.bl_reward_txt.sprite = AtlasManager:GetSpriteByName("ItemAtlas", icon1.icon)
    --this.br_reward_txt.text = fun.formatNum(xls.item_description[1][2])
    this:SetContent(item1,self.br_reward_txt,xls.item_description[1][2])
    local item2 = xls.item_description[2][1]
    --local icon2 = Csv.GetData("resources", tonumber(item2), 'icon')
    local icon2 = Csv.GetItemOrResource( tonumber(item2),"icon")
    self.br_cost_icon.sprite = AtlasManager:GetSpriteByName("ItemAtlas", icon2)
    --this.br_cost_txt.text = fun.formatNum(xls.item_description[2][2])
    this:SetContent(item2,self.br_cost_txt,xls.item_description[2][2])
    self.br_buy_txt.text = "$" .. xls.price
    this:SetBounsAndMore(self.br_BonusOrMore,xls.bonus, xls.more)
    canBRClick = true
    local data = ModelList.GiftPackModel:GetGiftById(id)

    if not data or data.canBuyCount <= 0 then
        this:CloseUIShiny(self.btn_br_buy)
        Util.SetUIImageGray(self.btn_br_buy, true)
        canBRClick = false
    elseif   this:OpenUIShiny(self.btn_br_buy) then
        Util.SetUIImageGray(self.btn_br_buy, false)
    end

    if #xls.item_description > 2 then
        fun.set_active(this.cityExp3, true)
        local item4 = xls.item_description[3][1]
        local vipexp = fun.find_child(this.cityExp3, "vipexp")
        local text = fun.get_component(vipexp, "Text")
        this:SetContent(item4, text, xls.item_description[3][2])
    else
        fun.set_active(this.cityExp3, false)
    end
    SetBuyBtnDescripe(self.btn_br_buy,xls.limit_description)
end

function GiftPackPentaView:SetLeftTime(endTimeStamp)
    local start_time = ModelList.PlayerInfoModel.get_cur_server_time()
    this.endTime = endTimeStamp - start_time
    if this.loopTime  then
        LuaTimer:Remove(this.loopTime)
        this.loopTime = nil
    end
    this.loopTime = LuaTimer:SetDelayLoopFunction(0, 1, -1, function()
        if self.left_time_txt then
            self.left_time_txt.text = fun.SecondToStrFormat(this.endTime)
            this.endTime = this.endTime - 1
            if this.endTime  <= 0 then
                this.on_btn_close_click()
                Event.Brocast(EventName.Event_Gift_Update)
            end
        end
    end,nil,nil,LuaTimer.TimerType.UI)
end

function GiftPackPentaView:SetBounsAndMore(obj, bonus, more)
    if this.bonusAndMore == nil then
        this.bonusAndMore = require("View/GiftPack/GiftPackBonusAndMore")
    end
    ----log.r("type  22 "..type(bonus).."    "..type(more))
    this.bonusAndMore:SetData(obj, bonus, more)
end

function GiftPackPentaView.OnDisable()
    --Facade.RemoveView(this)
    this:stop_x_update()
    --Event.Brocast(Notes.CARD_COLLIDER_OPEN, true)
end

function GiftPackPentaView.OnDestroy()
    this:Destroy()
end

function GiftPackPentaView:on_close()
    this:stop_x_update()
    --Event.Brocast(Notes.CARD_COLLIDER_OPEN, true)
end

function GiftPackPentaView:CloseFunc()
    --this.main_effect:Play("end")
    Facade.SendNotification(NotifyName.HideDialog, this)

end

function GiftPackPentaView:ShowTip(tipName)

end

function GiftPackPentaView:InitTip()

end

function GiftPackPentaView:CutDonwTarget()
    this:CloseFunc()
    this.main_effect:Play("end")
end

function GiftPackPentaView:on_btn_sure_click()
    if this.sure_cb then
        this.sure_cb()
    end
    Facade.SendNotification(NotifyName.HideDialog, this)
    GameObject.Destroy(self.go)
    last_click_time = UnityEngine.Time.time
    --end
end

function GiftPackPentaView:on_btn_cancle_click()
    if this.cancel_cb then
        this.cancel_cb()
    end
    Facade.SendNotification(NotifyName.HideDialog, this)
    GameObject.Destroy(self.go)
    last_click_time = UnityEngine.Time.time
    --end
end

function GiftPackPentaView:on_btn_close_click()
    if this._fsm:GetCurName() == "GiftPackShowState" then return end
    if this.loopTime then
        LuaTimer:Remove(this.loopTime)
        this.loopTime = nil
    end
    Facade.SendNotification(NotifyName.CloseUI, ViewList.GiftPackPentaView)
    ModelList.GiftPackModel:CloseView()
end

function GiftPackPentaView:on_btn_buy_click()
end

this.last_click_time1 = 0
function GiftPackPentaView:on_btn_up_buy_click()
    if this._fsm:GetCurName() ~= "GiftPackEnterState" then return end
    if canUpClick then
        local click_time = UnityEngine.Time.time
        if click_time - this.last_click_time1 > click_interval then
            this.last_click_time1 = UnityEngine.Time.time
            ModelList.GiftPackModel:ReqEditorBuySucess(data.pId, product_list[1])
        end
    else
        log.e  ("1111")
        --Facade.SendNotification(NotifyName.Common.PopupDialog, 8020, 1);
        UIUtil.show_common_popup(8020,true)
    end
end

this.last_click_time2 = 0
function GiftPackPentaView:on_btn_bl_buy_click()
    if this._fsm:GetCurName() ~= "GiftPackEnterState" then return end
    if canBLClick then
        local click_time = UnityEngine.Time.time
        if click_time - this.last_click_time2 > click_interval then
            this.last_click_time2 = UnityEngine.Time.time
            ModelList.GiftPackModel:ReqEditorBuySucess(data.pId, product_list[2])
        end
    else
        --Facade.SendNotification(NotifyName.Common.PopupDialog, 8020, 1);
        UIUtil.show_common_popup(8020,true)
    end
end

this.last_click_time3 = 0
function GiftPackPentaView:on_btn_br_buy_click()
    if this._fsm:GetCurName() ~= "GiftPackEnterState" then return end
    if canBRClick then
        local click_time = UnityEngine.Time.time
        if click_time - this.last_click_time3 > click_interval then
            this.last_click_time3 = UnityEngine.Time.time
            ModelList.GiftPackModel:ReqEditorBuySucess(data.pId, product_list[3])
        end
    else
        UIUtil.show_common_popup(8020,true)
    end
end

function GiftPackPentaView:CloseUIShiny(obj)
    local uishiny = fun.get_component(obj,"UIShiny")
    if uishiny then
        uishiny.enabled = false
    end
end

function  GiftPackPentaView:OnBuySuccess(needClose,itemData)
    this:ChangeState(this,"GiftPackShowState",itemData)
end

function  GiftPackPentaView:GetGiftPos(id)
    if id == product_list[1] then
        local vipexp = fun.find_child(this.cityExp1, "vipexp")
        return this.up_reward_txt1.transform.position,this.up_reward_txt2.transform.position,
         this.up_reward_txt3.transform.position,vipexp.transform.position
    elseif id == product_list[2] then
        local vipexp = fun.find_child(this.cityExp2, "vipexp")
        return this.bl_reward_txt.transform.position,this.bl_cost_txt.transform.position, vipexp.transform.position,nil
    else
        local vipexp = fun.find_child(this.cityExp3, "vipexp")
        return this.br_reward_txt.transform.position,this.br_cost_txt.transform.position,
        vipexp.transform.position,nil
    end
end

return this