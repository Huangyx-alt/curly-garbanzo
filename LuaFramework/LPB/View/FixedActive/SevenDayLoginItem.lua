---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/8/11 15:15
---

local SevenDayLoginItem = BaseChildView:New('SevenDayLoginItem');


local this = SevenDayLoginItem;
this.auto_bind_ui_items = {
    "DayText1",
    "btn_go",
    "anima",
    "DayText2",
    "DayText3",
    "dateText1",
    "dateText2",
    "dateText3",
    "Single",
    "Double",
    "Triple",
    "rewardIcon",
    "singleCount",
    "doubleCount1",
    "doubleCount2",
    "TripleCount1",
    "TripleCount2",
    "TripleCount3",
    "rewardIcon1",
    "rewardIcon2",
    "rewardIcon3",
}

function SevenDayLoginItem.New()
    local o = {}
    setmetatable(o, { __index = SevenDayLoginItem })
    return o
end

function SevenDayLoginItem:Init(obj, parent_ref)
    self:on_init(obj, parent_ref)
end

function SevenDayLoginItem:SetBgIcon(info)
    local rewardCount = #info.reward
    if rewardCount == 1 then
        if self.Single then
            fun.set_active(self.Single, true)
        end
        local data = Csv.GetData("reward_signin", info.id, "reward_description")
        local itemId = tonumber(data[1][1])
        if itemId  == BingoBangEntry.itemType.MagnifyingGlass  or  itemId == BingoBangEntry.itemType.CookieDoubleTime then
            self.singleCount.text = fun.FormatTextToTime(data[1][2])
        else
            self.singleCount.text = fun.NumInsertComma(data[1][2])
        end
        if self.Double then
            fun.set_active(self.Double, false)
        end
        if self.Triple then
            fun.set_active(self.Triple, false)
        end
        local icon = Csv.GetItemOrResource(info.reward[1].id,"icon")
        local tempSprite = AtlasManager:GetSpriteByName("ItemAtlas", icon)
        --local tempSprite = AtlasManager:GetSpriteByName("ItemAtlas", info.icon)
        if fun.is_not_null(tempSprite) then
            self.rewardIcon.sprite = tempSprite
            self.rewardIcon:SetNativeSize()
            fun.set_gameobject_scale(self.rewardIcon.gameObject, 1, 1, 1)
        end
    elseif rewardCount == 2 then
        if self.Single then
            fun.set_active(self.Single, false)
        end
        if self.Double then
            fun.set_active(self.Double, true)
        end
        if self.Triple then
            fun.set_active(self.Triple, false)
        end
        local data = Csv.GetData("reward_signin", info.id, "reward_description")
        self.doubleCount1.text = fun.NumInsertComma(data[1][2])
        self.doubleCount2.text = fun.NumInsertComma(data[2][2])
        local tempSprite = AtlasManager:GetSpriteByName("ItemAtlas", info.icon)
        if fun.is_not_null(tempSprite) then
            self.rewardIcon.sprite = tempSprite
            --self.rewardIcon:SetNativeSize()
            fun.set_gameobject_scale(self.rewardIcon.gameObject, 1, 1, 1)
        end
    else
        if self.Single then
            fun.set_active(self.Single, false)
        end
        if self.Double then
            fun.set_active(self.Double, false)
        end
        if self.Triple then
            fun.set_active(self.Triple, true)
        end
        --local data = Csv.GetData("reward_signin",info.id,"reward_description")
        self.TripleCount1.text = fun.NumInsertComma(info.reward[1].value)
        self.TripleCount2.text = fun.NumInsertComma(info.reward[2].value)
        self.TripleCount3.text = fun.NumInsertComma(info.reward[3].value)
        log.log("道具图片替换 c " , info.icon)
        for i = 1 , 3 do
            local img = self["rewardIcon" .. i]
            local icon = Csv.GetItemOrResource(info.reward[i].id,"icon")
            local tempSprite = AtlasManager:GetSpriteByName("ItemAtlas", icon)
            if fun.is_not_null(tempSprite) then
                img.sprite = tempSprite
                --img:SetNativeSize()
                fun.set_gameobject_scale(self.rewardIcon.gameObject, 1, 1, 1)
            end
        end

    end
end

function SevenDayLoginItem:SetInfo(data, index,refreshDta)
    if self._dataCache and self._dataCache.status == 1 and data.status == 2 then
        if index == 7 then
            self.needFly = false
            self.needIdle = true
        else
            self.needIdle = true
            self.needFly = true
        end
    elseif data.status == 2 and index ==7 then
        self.needFly = false
        self.needIdle = true
    else
        self.needFly = false
    end
    self._dataCache = data
    self:SetDay(index)
    if refreshDta == nil then refreshDta = true end
    if refreshDta then
        self:SetBgIcon(data)
    end
    local animName =""
    if data.status == 0 then animName ="wait"
    elseif data.status == 1 then animName ="go"
    elseif data.status == 2 then animName ="yes"
    end
    if self.needIdle then animName = "gotoyes" end
    local anim = fun.get_component(self.go,fun.ANIMATOR)
    anim:Play(animName)
    return data.status == 1
end

function SevenDayLoginItem:SetDay(index)
    if self.dateText1 then self.dateText1.text = "DAY"..index end
    if self.dateText2 then self.dateText2.text = "DAY"..index end
    if self.dateText3 then self.dateText3.text = "DAY"..index end
end

function SevenDayLoginItem:SetReward(data, index, reward)
    if index == 7 then
        self.DayText1.text = "x" .. fun.NumInsertComma(data * 0.01)
        self.DayText2.text = "x" .. fun.NumInsertComma(data * 0.01)
        self.DayText3.text = "x" .. fun.NumInsertComma(data * 0.01)        
    end
end

function SevenDayLoginItem:CanFly()
    return self.needFly
end
function SevenDayLoginItem:NeedChangeIdle()
    return  self.needIdle or false
end

function SevenDayLoginItem:GetRewardTxtPos()
    return self.DayText1.transform.position
end

function SevenDayLoginItem:PlayRewardAnima()
    --self.anima:Play("gotoyes")
    fun.play_animator(self.anim , "gotoyes" , true)
end

function SevenDayLoginItem:PlayRewardAnima2()
    self.anima:Play("reward")
end

--- 第七天不需要飞行，动画要变成idle状态
function SevenDayLoginItem:ChangeIdleWithoutFly()
    self:PlayRewardAnima()
end

function SevenDayLoginItem:PlayRewardFly(index)
    self:PlayRewardAnima()
    --local flyObj = fun.get_instance(self.DayText2.gameObject, self.go.transform.parent.parent)
    --local path = {}
    --Anim.scale_to_xy(flyObj, 2, 2, MCT.SevenDayFlyTime * 0.2, function()
    --    if not fun.is_null(flyObj) then
    --        Anim.scale_to_xy(flyObj, 2, 2, MCT.SevenDayFlyTime * 0.3, function()
    --            if not fun.is_null(flyObj) then
    --                Anim.scale_to_xy(flyObj, 1, 1, MCT.SevenDayFlyTime * 0.5 - 0.05)
    --            end
    --        end)
    --    end
    --end)
    --fun.set_same_position_with(flyObj, self.DayText2)
    --local start_position = fun.get_gameobject_pos(self.DayText2, false)
    --local endPos = ViewList.SevenDayLoginView:GetEndRewardPos()
    --path[1] = fun.calc_new_position_between(start_position, endPos, 0.45, 1, 0)
    --path[2] = endPos
    --Anim.bezier_move(flyObj, path, MCT.SevenDayFlyTime * 0.5, MCT.SevenDayFlyTime * 0.5, 1, 2, function()
    --    Destroy(flyObj)
        ViewList.SevenDayLoginView:LastDayRewardEffect()
    --end)
end

function SevenDayLoginItem.Awake(obj)
    --this.update_x_enabled = true
    --this:on_init()

end

function SevenDayLoginItem.OnEnable()
    --Facade.RegisterView(this)
    this.data = ModelList.FixedActivityModel:GetSevenDayLoginData()
end


--function SevenDayLoginItem:on_x_update()
--end

function SevenDayLoginItem.OnDisable()
    --Facade.RemoveView(this)
end


function SevenDayLoginItem.OnDestroy()
    this:Destroy()
end



function SevenDayLoginItem:on_btn_go_click()
    self.parentView:click_day_item()
end


return this


