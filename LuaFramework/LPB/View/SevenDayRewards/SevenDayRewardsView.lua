---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2022/8/15 19:02
---

require "State/Common/CommonState"

local SevenDayRewardsView = BaseView:New("SevenDayRewardsView","BingoBangPopupAtlas")
local this = SevenDayRewardsView
this.viewType = CanvasSortingOrderManager.LayerType.TopConsole

this.auto_bind_ui_items = {
    "content",
    "reward_item",
    "btn_collect",
    "anima",
    "Reward_item1",
    "Reward_item2",
    "Reward_item3",
    "Reward_item4",
    "Reward_item5",
    "Reward_item6",
}

local rewards_item = nil
local click_callback = nil
local enter_animation = nil

local isInit = nil

local rewardItemsCache = nil

--local Input = UnityEngine.Input
--local KeyCode = UnityEngine.KeyCode

function SevenDayRewardsView:Awake(obj)
    self:on_init()
end

function SevenDayRewardsView:OnEnable()
    isInit = true
    self:ShowRewards()
    --self.update_x_enabled = true
    --self:start_x_update()
    CommonState.BuildFsm(self,"SevenDayRewardsView")

    self._fsm:GetCurState():DoOriginalAction(self._fsm,"CommonState1State",function()
        AnimatorPlayHelper.Play(self.anima,{"efCollectRewardsenter","SevenDayRewardsViewenter"},false,function()
            self._fsm:GetCurState():DoCommonState1Action(self._fsm,"CommonOriginalState")
        end)
    end)
    UISound.play("kick_reward")
end

function SevenDayRewardsView:OnDisable()
    self:Close()
    CommonState.DisposeFsm(self)
end

function SevenDayRewardsView:on_close()
    rewards_item = nil
    click_callback = nil
    enter_animation = nil
    isInit = nil
    rewardItemsCache = nil
    if self._timer then
        self._timer:Stop()
        self._timer = nil
    end
end

--[[
function SevenDayRewardsView:on_x_update()
    if Input and Input.GetKeyUp(KeyCode.Mouse0) then
        if click_callback then
            click_callback()
            click_callback = nil
        end
    end
end
--]]

function SevenDayRewardsView:SetRewards(rewards)
    rewards_item = rewards
    if isInit then
        self:ShowRewards()
    end
end

function SevenDayRewardsView:SetCallBack(callback)
    click_callback = callback
end

function SevenDayRewardsView:SetAnimation(anima)
    local count = #rewards_item
    this.animaType = anima
    if anima == ClaimRewardAnimation.sevenDayLogin then
        enter_animation = {"efCollectRewardsenter","efCollectRewardsenter"}
    else
        enter_animation = {"efCollectRewardsenter","efCollectRewardsenter"}
    end
end

function SevenDayRewardsView:ShowRewards()
    if rewards_item then
        if rewardItemsCache == nil then
            rewardItemsCache = {}
        end
        local view = require("View/CommonView/CollectRewardsItem")
        local count = fun.get_table_size(rewards_item)
        assert(count > 0,"奖励异常")
        count = 1
        for key, value in pairs(rewards_item) do
            local go = self["Reward_item"..count]
            count =count + 1
            local rewardItem = view:New()
            rewardItem:SetReward(value)
            rewardItem:SkipLoadShow(go,false,nil)
            fun.set_active(go, true)
            if rewardItemsCache[key] == nil then
                table.insert(rewardItemsCache,rewardItem)
            end
        end
    end
end

function SevenDayRewardsView:on_btn_collect_click()
    ViewList.SevenDayLoginView:RefreshData()
    if click_callback then
        self._fsm:GetCurState():DoOriginalAction(self._fsm,"CommonState2State",function()
            click_callback()
            self._timer = Invoke(function()
                self._fsm:GetCurState():DoCommonState2Action(self._fsm,"CommonOriginalState")
            end,3)
        end)
    end
end

function SevenDayRewardsView:GetExitAnima()
    --if this.animaType == ClaimRewardAnimation.sevenDayLogin then
    --    return {"efCollectRewardsexit","efCollectRewardsexit"}
    --else
    --    return {"efforgetRewardsexit","efforgetRewardsexit"}
    --end
    return {"efCollectRewardsexit","SevenDayRewardsViewexit"}
end

function SevenDayRewardsView:CloseView()
    local delay = 0
    local coroutine_fun = nil
    for key, value in pairs(rewardItemsCache) do
        coroutine_fun = function()
            delay = delay + 0.2
            coroutine.wait(delay)
            Facade.SendNotification(NotifyName.ShopView.FlyRewardEffcts,value:GetPosition(),value:GetRewardItemId(),function()
                Event.Brocast(EventName.Event_currency_change)
            end,value:GetIconItem(),true)
        end
        coroutine.resume(coroutine.create(coroutine_fun))
    end
    coroutine_fun = function()
        delay = delay + 0.2
        coroutine.wait(delay)
        AnimatorPlayHelper.Play(self.anima,this:GetExitAnima(),false,function()
            Facade.SendNotification(NotifyName.CloseUI,self)
        end)
    end
    coroutine.resume(coroutine.create(coroutine_fun))

    UISound.play("gift_box_open")
end

this.NotifyList =
{

}

return this
