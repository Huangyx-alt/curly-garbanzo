---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/8/20 15:23
---
ShowHeadView = {}
local this = ShowHeadView

local Stack = require "Common/Stack" 
local showhead_stack = Stack:New()

function GetShowHeadInstance()
    return showhead_stack:Current()
end

function GetShowHeadIconPos()
    local _curInstance = GetShowHeadInstance()
    if _curInstance then
        return _curInstance:GetHeadIconPos()
    end
    return Vector3.New(0,0,0)
end

function ShowHeadView:New(parent)
    local o = {}
    self.__index = self
    setmetatable(o, self)
    self._parentView = parent
    return o
end

function ShowHeadView:Awake()
    
end

function ShowHeadView:OnEnable(parent)
    self._parentView = parent
    self.stack_index = showhead_stack:push(self)
    Event.AddListener(EventName.Event_UpdateRoleInfo,self.OnUpdateRoleInfo,self)
    self:SetInfo()
end

function ShowHeadView:OnDisable()
    showhead_stack:pop(self.stack_index)
    Event.RemoveListener(EventName.Event_UpdateRoleInfo,self.OnUpdateRoleInfo,self)
end    

function ShowHeadView:GetHeadIconPos()
    if self._parentView.img_head_icon then
        return self._parentView.img_head_icon.transform.position
    end
    return Vector3.New(0,0,0)
end

function ShowHeadView:OnUpdateRoleInfo()
    self:SetInfo()
end 

function ShowHeadView:SetInfo()
    local playInfo = ModelList.PlayerInfoModel:GetUserInfo()
    self:SetHeadIcon(playInfo)
    self:SetExp(playInfo)
    self:SetLevel(playInfo)
    self:SetVip(playInfo)
end

function ShowHeadView:SetHeadIcon(info)
    if self._parentView and fun.is_not_null(self._parentView.ShowHead) then
        local avatarAndFrameViewCode = require "View/PlayerInfoSysView/PlayerInfoUpdateAvatarAndFrame"
        self.avatarAndFrameView = avatarAndFrameViewCode:New()

        self.avatarAndFrameView:SkipLoadShow(self._parentView.ShowHead.gameObject)
        self.avatarAndFrameView:SetIsOneSelf(true)
        fun.set_active(self._parentView.ShowHead, true)
    end
end

function ShowHeadView:UpdateShowHead()
    if self.avatarAndFrameView then
        self.avatarAndFrameView:SetPlayerSelf()
    end
end

function ShowHeadView:SetExp(info)
    if info and fun.is_not_null(self._parentView.slid_exp) then
        local exp = Csv.GetData("level",info.level,"exp")
        self._parentView.slid_exp.value = info.exp / exp
        self._parentView.text_exp.text = string.format("%s%s",math.floor((info.exp / exp) * 100),"%")
    end
end

function ShowHeadView:SetLevel(info)
    if info and fun.is_not_null(self._parentView.text_leaf) then
        self._parentView.text_leaf.text = tostring(info.level)
    end
end

function ShowHeadView:SetVip(info)
    if info and fun.is_not_null(self._parentView.text_level)  then
        self._parentView.text_level.text = tostring(info.vip)
    end
end

function ShowHeadView:OnDestroy()
    self._parentView = nil
    self.stack_index = nil
    self.avatarAndFrameView = nil
end

function ShowHeadView:on_btn_head_click()
    ModelList.PlayerInfoSysModel:C2S_RequestPersoPage()
end
