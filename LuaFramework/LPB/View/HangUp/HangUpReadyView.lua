---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/7/5 19:22
---
---@see 准备界面
---@class HangUpReadyView : BaseDialogView
HangUpReadyView = BaseView:New("HangUpReadyView")
local this = HangUpReadyView
this.__index = this
this.viewType = CanvasSortingOrderManager.LayerType.Shop_Dialog
this.auto_bind_ui_items = {
    "img_countdown",
    "root",

    --开局氛围
    "head1", --头像
    "item1", --头像
    "atmosphere",
    "headtiao",
    "headCount",
    "countText",
    "BingosiLeftBig",
    "myhead",--我自己 的头像

    "competition",--我自己 的头像
    "BigHead",
    "jokerPos",

    "Img_getReady",
    "light1",
    "light2",
    "full_screen1",
    "light3",
    "light4",
    "full_screen2",
    "light5",
    "light6",
    "full_screen3",
}

this.can_start_num_inscrease = false
this.can_start_power_fly = false
this.power_up_card = 0
this.maxCount = 0

local IsPlayReady = false

function HangUpReadyView.Awake()
    --Facade.RegisterView(this)
    this:on_init()
    LuaTimer:Clear(LuaTimer.TimerType.UI)
end

local InitEnableTimeContent = function()
    local countdowns = Csv.GetData("control",34,"content")
    if ModelList.GuideModel:IsFirstBattle() then
        countdowns = {{3}}
    end
    this.img_countdown.text = countdowns[1][1]
end


function HangUpReadyView.OnEnable()
    this.can_start_num_inscrease = false
    this.can_start_power_fly = false
    IsPlayReady = false
    this.update_x_enabled = true
    this:start_x_update()
    InitEnableTimeContent()

    this.gameTable = ModelList.GameModel:GetAllRobots()
    this:StartJoinFun()
    this:ReplaceJokerSkin()
end

local StartPlayReady = function()
    this.StartCountdown()
    UISound.play("city1_loading_over")
    LuaTimer:SetDelayFunction(MCT.DelayPlayWhipse,function()
        UISound.play_loop("whisper")
    end)
    Event.Brocast(Notes.CLEAR_DELAY_TIMMER)
end


function HangUpReadyView:on_x_update()
    if not IsPlayReady then
        local stateInfo = this.root:GetCurrentAnimatorStateInfo(0)
        if  ( stateInfo:IsName("time_start")  and  stateInfo.normalizedTime>0.95 )  or  (stateInfo:IsName("time_idle") ) then
            IsPlayReady = true
            StartPlayReady()
        end
    end
end


function HangUpReadyView.StartCountdown()
    local countdowns = Csv.GetData("control",34,"content")
    if ModelList.GuideModel:IsFirstBattle() then
        countdowns = {{3}}
        this.img_countdown.text = countdowns[1][1]
    end
    this.countdown = tonumber(countdowns[1][1])
    --this.countdown = 4
    local  cards = ModelList.BattleModel:GetCurrModel():GetPowerUps()
    this.power_up_card = #cards
    this.timerId = LuaTimer:SetDelayLoopFunction(0,1,-1, function()
        if this.countdown and this.countdown > 0 then
            this.img_countdown.text = this.countdown

            local ani = fun.get_component(this.img_countdown.gameObject,fun.ANIMATOR)
            ani:Play("GetReady_Count1")
            UISound.play("countdown")
            if   this.countdown == 5 then

            end
            if  this.countdown == 3 then

            end
            if this.countdown == 2 then
                --local city = ModelList.CityModel:GetCity()
                --local city_music =  Csv.GetData("city",city,"music")
                UISound.play_bgm("auto")
                UISound.set_bgm_volume(0.7)
                UISound.max_fade_in_bgm()
                UISound.tween_out_music("whisper.mp3", 2, 1, 0.7, nil)
                --UISound.play_loop("whisper")
                Event.Brocast(EventName.CardEffect_Enter_Effect)
                Facade.SendNotification(NotifyName.Bingo.StartBingosleftIncrease)
                LuaTimer:SetDelayFunction(0.7,function()
                    Event.Brocast(Notes.START_POWERUP_ENABLE)
                end)
            end
            if this.countdown == 1 then
                Event.Brocast(EventName.CardEffect_Drop_All_Cell_Item)
            end
            this.countdown = this.countdown - 1
        else
            this.StopCountdown()
            if this.countdown <= 0 then
                Event.Brocast(Notes.BINGO_TIME_COUNT_OVER)
            end
            this:Exit()
        end
    end,nil,nil,LuaTimer.TimerType.Battle)
end

function HangUpReadyView.StopCountdown()
    if this.timerId then
        LuaTimer:Remove(this.timerId)
        this.timerId = nil
    end
end


function HangUpReadyView:StartJoinFun()
    fun.set_active(self.atmosphere,true)
    self.myhead.sprite = AtlasManager:GetSpriteByName("HeadAtlas",ModelList.PlayerInfoModel:GetHeadIcon())
    
    this.maxCount = ModelList.GuideModel:IsFirstBattle() and 5 or #this.gameTable 
    this.maxCount = this.maxCount -1 
    this:StartJoinAni()
 
end 


--开始递归播放动画
function HangUpReadyView:StartJoinAni() 

    if not this.count then 
        this.count = this.maxCount
        if ModelList.GuideModel:IsFirstBattle() ==false then 
            local countN = Csv.GetControlByName("gambit_number")
            if countN then 
                local tmpCount =  math.random(countN[1][1], countN[1][2])
                this.count =  this.count - tmpCount <= 0 and 0 or this.count - tmpCount
                this.BingosiLeftnum = 4
                self.BingosiLeftBig.text = this.BingosiLeftnum 
            end 
        end 
        this.BingosiLeftnum = 0
        self.BingosiLeftBig.text =0 
    end 

    if this.count <= 0 then 
     
        return 
    end     

    local HeadItem = fun.get_instance(self.item1,self.headtiao)
    local refSmallHeadItem = fun.get_component(HeadItem, fun.REFER)
    if not refSmallHeadItem then return end
    local namtTxt =  refSmallHeadItem:Get("Name")
    local imageFrameUp =  refSmallHeadItem:Get("imageFrame")
    local headBgSp = refSmallHeadItem:Get("head")

    local data = Csv.GetData("robot_name", this.gameTable[this.count], "icon")
    local namestr =  Csv.GetData("robot_name", this.gameTable[this.count], "name")
    local animator = fun.get_component(HeadItem,fun.ANIMATOR)


    local HeadImage = fun.get_instance(self.head1,self.headCount)
    local refRightHeadImage = fun.get_component(HeadImage, fun.REFER)

    local headBgSp2 =  refRightHeadImage:Get("imgHead")
    local tmpCount = this.count
    local FirstBattle =  ModelList.GuideModel:IsFirstBattle()
    local imageFrameRight =  refRightHeadImage:Get("imageFrame")

    if not headBgSp then 
        return
    end 

    if data then 
        local sysModel = ModelList.PlayerInfoSysModel
        sysModel:LoadTargetHeadSprite(data, headBgSp)
        sysModel:LoadTargetHeadSprite(data, headBgSp2)


        sysModel:LoadRobotTargetFrameSprite(namestr, imageFrameUp)
        sysModel:LoadRobotTargetFrameSprite(namestr, imageFrameRight)
    end 

    namtTxt.text = namestr
    
    AnimatorPlayHelper.SetAnimationEvent(animator,"item1",function()
        if tmpCount <= 0 then 
            return 
        end 

        --播放另一个动画
        fun.set_active(HeadImage,true)
        tmpCount = tmpCount <= 0 and 0 or tmpCount
        self.countText.text = "x"..(this.maxCount -  tmpCount ) 
     
        local random = math.random(4, 5)
        if this.countdown ~= nil and  this.countdown <= 3 then 
            random = math.random(5, 9)

            if random == 5 then 
                this.BingosiLeftnum = this.BingosiLeftnum  +1
                self.BingosiLeftBig.text = this.BingosiLeftnum 
            end 
          
            LuaTimer:SetDelayFunction(0.1 * random, function()
                self:StartJoinAni() 
            end) 
        else 
            this.BingosiLeftnum = this.BingosiLeftnum  +1
            self.BingosiLeftBig.text = this.BingosiLeftnum 

            LuaTimer:SetDelayFunction(0.1 * random *2, function()
                self:StartJoinAni() 
            end) 

            LuaTimer:SetDelayFunction(0.1 * random *4, function()
                self:StartJoinAni() 
            end) 
        
        end 
        --log.r("tmpCount"..tmpCount)
        if tmpCount == 1 then
            LuaTimer:SetDelayFunction(0.8, function()
                if fun.is_not_null(self.atmosphere) then
                    self.atmosphere:Play("out")
                else
                    if fun.is_not_null(this.atmosphere) then
                        this.atmosphere:Play("out")
                    end
                end
                if fun.is_not_null(self.countText) then
                    self.countText.text = "x"..(this.maxCount +1)
                end
                if fun.is_not_null(self.BingosiLeftBig) then
                    self.BingosiLeftBig.text = tostring(ModelList.BattleModel:GetCurrModel():LoadGameData().bingoLeft)
                end
            end)
        end
    end)

    this.count = this.count- 1
    fun.set_active(HeadItem,true)
end

function HangUpReadyView:on_close()
    this.StopCountdown()
    this.count = nil
end

function HangUpReadyView.OnDestroy()
    this:Close()
end

function HangUpReadyView:Exit()
    this.root:Play("time_end")
    LuaTimer:SetDelayFunction(1,function()
        ModelList.BattleModel:GetCurrBattleView():SetReadyForPreUseItem(5)
        Facade.SendNotification(NotifyName.CloseUI,ViewList.HangUpReadyView)
    end)
end

--- 小丑机台换主题
function HangUpReadyView:ReplaceJokerSkin()
    if ModelList.BattleModel.GetIsJokerMachine() then
        SetJokerSkin(self.light1,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light2,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light3,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light4,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light5,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.light6,"JokerBattleAtlas","Plight")
        SetJokerSkin(self.full_screen1,"JokerBattleAtlas","Pfullscreen")
        SetJokerSkin(self.full_screen2,"JokerBattleAtlas","Pfullscreen")
        SetJokerSkin(self.full_screen3,"JokerBattleAtlas","Pfullscreen")
        SetJokerSkin(self.Img_getReady,"JokerBattleAtlas","PfullscreenReady")
    end
end


function HangUpReadyView.New()
    local o = {}
    setmetatable(o, HangUpReadyView)
    o.__index = o
    return o;
end

return this

