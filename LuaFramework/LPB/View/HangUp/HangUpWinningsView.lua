---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2021/9/29 10:21
---
---挂机物品收集展示面板

HangUpWinnings = BaseChildView:New();
local this = HangUpWinnings;

this.parent_view = nil
this.firstItemPos = {}
this.getted_items = {}
this.icon_order = 0
this.collectIds = {}        --可直接收集的item 和 resources
this.convert2Resource = {} --可转换成资源的item列表
local scrollItemHeight = 49.2
local scrollItemOffsetY = 49.2 + 4.9

this.IsDoubleFood = false
this.IsDoublePuzzle = false
this.IsDoubleCookie = false

this.auto_bind_ui_items = {
    "clone",
    "oripos",
    "Content",
    "wingning_guang1",
    "wingning_guang2",
    "bucket_anima"
}

---初始化 活动状态
local function InitActivityState(activityStatus)
    this.IsDoubleFood = false
    this.IsDoublePuzzle = false
    this.IsDoubleCookie = false
    ModelList.BattleModel.SetBattleDouble(activityStatus)
    if activityStatus then
        for i = 1, #activityStatus do
            if activityStatus[i].id == ActivityTypes.doubleFood and activityStatus[i].value == 1 then
                this.IsDoubleFood = true
            elseif activityStatus[i].id == ActivityTypes.doublePuzzle and activityStatus[i].value == 1 then
                this.IsDoublePuzzle = true
            elseif activityStatus[i].id == ActivityTypes.doubleCookies and activityStatus[i].value == 1 then
                this.IsDoubleCookie = true
            end
        end
    end
end

local InitParams = function(collectIds)
    this.icon_order = 0
    this.getted_items = {}
    this.auto_res_show = Csv.GetData("control",66,"content")
    local sortList = {}
    for i = 1, #collectIds do
        if fun.is_include(collectIds[i],this.auto_res_show[1]) then
            table.insert(sortList,collectIds[i])
            this:AddItem(collectIds[i],0)
        end
    end
    this.collectIds = sortList
    this.Content.sizeDelta = Vector2.New(this.Content.sizeDelta.x,scrollItemHeight*#this.collectIds)
    -- 遍历item表，搜索能获取资源的itemid，加进collectIds
    this.convert2Resource = {}
    for _, v in pairs(Csv.item) do
        if v.result and v.result[1] == 3 and fun.is_include(v.result[2],this.collectIds) then
            table.insert(this.convert2Resource,v.id)
        end
    end
end

function HangUpWinnings:Init(my_obj,bingoView)
    this:on_init(my_obj)
    this.parent_view = bingoView
    this.oripos.transform:SetParent(bingoView.MapType.transform,true)
   this.firstItemPos = this.oripos.transform.localPosition
    --开始时候就显示所有可能获得item
    local data = ModelList.HangUpModel:LoadGameData()
    if not data.collectIds then  data.collectIds = {} end
    InitParams(data.collectIds)
    InitActivityState(data.activityStatus)
    this:Register()
end

function HangUpWinnings:GetBoxPos(item_id,isLocal)
    if ModelList.BattleModel:IsRocket() then
        return Vector3.New(333.6999, 386.4001, 0)
    else
        if isLocal~= nil  and not isLocal then
            return this.oripos.transform.position
        end
        return this.firstItemPos
    end
end

function HangUpWinnings:AddItem(item_id,add_count)
    local itemid = tostring(item_id)
    local has_getted = false
    for k,v in pairs(this.getted_items) do
        if k == itemid then
            v.count = v.count + add_count
            has_getted = true
        end
    end
    if not has_getted then
        local obj_temp = fun.get_instance(this.clone,this.clone.transform.parent)
        local icon_obj = fun.find_child(obj_temp,"icon")
        local icon = fun.get_component(icon_obj,fun.IMAGE)
        local icon_name = ""
        if item_id < 100 then
            icon_name = Csv.GetData("resources",item_id,"icon")
            icon.sprite =  AtlasManager:GetSpriteByName("ItemAtlas",icon_name)
        else
            icon_name = Csv.GetData("item",item_id,"icon")
            if fun.starts(icon_name,"city") and icon_name~="city8_cookie" then
                ViewTool:LoadFoodSprite(icon_name,icon_name,icon)
            else
                icon.sprite = AtlasManager:GetSpriteByName("GameItemAtlas", icon_name)
            end
        end
        fun.set_active(obj_temp, true)
        local my_order = this.icon_order
        this.icon_order = this.icon_order + 1
        local temp = { obj = obj_temp, id = itemid, count = add_count, order = my_order }
        this.getted_items[itemid] = temp
        local sizeY = this.Content.sizeDelta.y
        this.Content.sizeDelta = Vector2.New(this.Content.sizeDelta.x, sizeY + scrollItemHeight)
    end
    for k,v in pairs(this.getted_items) do
       local obj = v.obj
        local tex_obj = fun.find_child(obj,"num")
        local tex = fun.get_component(tex_obj,"Text")
        tex.text =  tostring(v.count)
    end
    self.bucket_anima:Play("btn_card_bg_g1",0,0)
end

function HangUpWinnings.OnDisable()
    this.parent_view = nil
    this.getted_items = {}
    this:UnRegister()
    this:Close()
end

function HangUpWinnings.OnDestroy()
    this.parent_view = nil
    this.getted_items = {}
    this:UnRegister()
    this:Destroy()
end

function HangUpWinnings:RefreshWinningsXpAndCoinWithClick(reward_coin, reward_xp)
    if reward_coin > 0 then
        this:AddItem(RESOURCE_TYPE.RESOURCE_TYPE_COINS, reward_coin)
    end
    if reward_xp > 0 then
        this:AddItem(RESOURCE_TYPE.RESOURCE_TYPE_EXP, reward_xp)
    end
end

---检查食物是否需要加倍
function HangUpWinnings:CheckFoodDouble(itemId,oriCount)
    if this.IsDoubleFood and ViewTool:IsFoodByItem(itemId) then
        return oriCount * 2
        --elseif this.IsDoublePuzzle and ViewTool:IsPuzzleByItem(itemId) then
        --    return oriCount*2
        --elseif this.IsDoubleCookie and ViewTool:IsCookieByItem(itemId) then
        --    return oriCount*2
    end
    return oriCount
end

function HangUpWinnings:ReceiveItem(itemId,count)
    if not count  or count == 0 then count = 1 end
    count = this:CheckFoodDouble(itemId,count)
    --log.g("ReceiveItem  "..itemId.."     ")
    if fun.is_include(itemId,this.collectIds) then
        this:AddItem(itemId,count)
    elseif fun.is_include(itemId,this.convert2Resource) then
        local info = Csv.GetData("item",itemId,"result")
        this:AddItem(info[2],info[3])
    else
        this:AddItem(itemId,count)
    end
    this:PlayShineEffect(itemId)
end


local GetBoxEffect = function(obj,hideTime)
    if fun.get_active_self(obj) then
        local newObj = fun.get_instance(obj,obj.transform.parent)
        fun.set_active(newObj,true)
        LuaTimer:SetDelayFunction(hideTime,function()
            fun.set_active(newObj,false)
        end)
    else
        fun.set_active(obj,false)
        fun.set_active(obj,true)
        LuaTimer:SetDelayFunction(hideTime,function()
            fun.set_active(obj,false)
        end)
    end
end

function HangUpWinnings:PlayShineEffect(itemId)
    GetBoxEffect(this.wingning_guang1,2)
end


function HangUpWinnings:Register()
    Event.AddListener(EventName.HangUpCell_Click_Get_Item,this.ReceiveItem)
    Event.AddListener(EventName.HangUpCell_RefreshWinningsXpAndCoinWithClick,this.RefreshWinningsXpAndCoinWithClick)
end

function HangUpWinnings:UnRegister()
    Event.RemoveListener(EventName.HangUpCell_Click_Get_Item,this.ReceiveItem)
    Event.RemoveListener(EventName.HangUpCell_RefreshWinningsXpAndCoinWithClick,this.RefreshWinningsXpAndCoinWithClick)
end

return this