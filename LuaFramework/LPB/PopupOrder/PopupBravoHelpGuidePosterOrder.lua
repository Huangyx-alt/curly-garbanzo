---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by PC.
--- DateTime: 2023/4/14 12:33
---

--- bravo help 导流弹窗

local BaseOrder = require "PopupOrder/BaseOrder"
local PopupOrder = Clazz(BaseOrder,"PopupBravoHelpGuidePosterOrder")
local this = PopupOrder


local ScenePos = {
    login = 1,
    gameover = 6,
}

local debug = false 

--[[
    @desc: 
    author:{author}
    time:2024-01-26 12:28:09
    --@occasion:  1 登录   6战斗结束
	--@orderData: 
    @return:
]]
function PopupOrder.Execute(occasion, orderData)
    --ModelList.PlayerInfoModel.GetDeepLink():ReqDeepLinkData(occasion)
    local deepLinkPart = ModelList.PlayerInfoModel.GetDeepLink()
    log.r("lxq PopupBravoHelpGuidePosterOrder",occasion,this.IsAllowPop("PopupBravoHelpGuidePosterOrder",orderData),deepLinkPart.HasCacheAppSelfPromoteData(),deepLinkPart.IsClickPromoteView())
    if not this.IsAllowPop("PopupBravoHelpGuidePosterOrder",orderData) then  --判断弹窗cd
        this.Finish()
        return
    end
  
    
    if(deepLinkPart.HasCacheAppSelfPromoteData())then --是否有缓存数据 

        if(debug)then    --debug 强制显示 
            PopupOrder.ShowPopuDialog(occasion)
            return 
        end
       
        if(occasion==ScenePos.login  and deepLinkPart.IsClickPromoteView())then  
            --大厅弹出后 点击过则不显示，留给战斗后显示
            PopupOrder.Finish()
            return 
        end

        if(occasion==ScenePos.gameover  and not deepLinkPart.IsClickPromoteView())then  
            --游戏后弹出 没有点击则不显示，留给登录
            PopupOrder.Finish()
            return 
        end   

      
        PopupOrder.ShowPopuDialog(occasion)
        this.RefreshPopTime("PopupBravoHelpGuidePosterOrder",orderData,2)   --刷新cd
    else
        if(PopupOrder.IsDownloading())then 
            --下载中，跳过操作，等下一次 
        else
            PopupOrder.DownloadRes()
            
        end 
        PopupOrder.Finish()
       -- fun.save_int("AppSelfPromote.DownloadPromoteDataStateStr",0)
    end

end


function PopupOrder.IsDownloading()
    return ModelList.PlayerInfoModel.GetDeepLink():IsDownloadPromoteDataDownloading()
end


function PopupOrder.DownloadRes()
    ModelList.PlayerInfoModel.GetDeepLink():GetAppSelfPromoteData()
end



function PopupOrder.ShowPopuDialog(occasion) 
    
    Event.AddListener(EventName.Event_Bravo_Help_Guide_finish,PopupOrder.Finish)
    Facade.SendNotification(NotifyName.ShowUI,ViewList.BravoHelpGuideView,nil,nil,occasion)
end


 
function PopupOrder.Finish()
    Event.RemoveListener(EventName.Event_Bravo_Help_Guide_finish,PopupOrder.Finish)
    log.g("brocast  EventName.Event_popup_order_finish ")
    Event.Brocast(EventName.Event_popup_order_finish,true)
end


return this